---
title: "üìä RREO & RGF - Relat√≥rios Fiscais"
subtitle: "Sistema Unificado de Relat√≥rios Fiscais do Governo Federal"
author: "Governo Federal"
date: today
execute:
  warning: false
  message: false
  cache: false
  
format:
  html:
    theme: cosmo
    toc: true
    toc-depth: 3
    number-sections: true
    code-fold: true
    code-summary: "Mostrar c√≥digo"
    fig-width: 10
    fig-height: 6
    tbl-cap-location: top
    self-contained: true
---

# üìö Carregamento de Bibliotecas e Configura√ß√µes {#sec-setup}

```{r setup}
#| include: false


# Bibliotecas principais
library(dplyr)
library(tidyr)
library(stringr)
library(readxl)
library(janitor)
library(purrr)
library(forcats)
library(DT)
library(knitr)
library(kableExtra)
library(readr)
library(scales)
library(lubridate)
library(rlang)

Sys.setlocale("LC_TIME", "pt_BR.UTF-8")

# Configura√ß√µes globais
options(OutDec = ".")
options(scipen = 999)

# Configura√ß√µes DT
options(DT.options = 
  list(
    pageLength = 50,
    lengthMenu = c(5, 10, 25, 50, 100),
    language = list(url = '//cdn.datatables.net/plug-ins/1.10.11/i18n/Portuguese.json')
  )
)

# ============================================================================
# ‚ö° OTIMIZA√á√ïES DE PERFORMANCE E PARALELIZA√á√ÉO
# ============================================================================

# Carregar bibliotecas de paraleliza√ß√£o
suppressPackageStartupMessages({
  library(furrr)      # Para processamento paralelo com purrr
  library(future)     # Backend de paraleliza√ß√£o
  library(data.table) # Para opera√ß√µes ultrarr√°pidas em dados grandes
})

# Detectar recursos dispon√≠veis
cores_disponiveis <- parallel::detectCores()

# Obter mem√≥ria total (compat√≠vel com Windows)
memoria_info <- tryCatch({
  resultado <- system("wmic computersystem get totalphysicalmemory", intern = TRUE)
  as.numeric(gsub("[^0-9]", "", resultado[2])) / (1024^3)
}, error = function(e) {
  32.0  # Fallback
})

cat("\n")
cat("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n")
cat("‚ïë        ‚ö° OTIMIZA√á√ÉO DE PERFORMANCE - SISTEMA ATIVADO        ‚ïë\n")
cat("‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£\n")
cat(sprintf("‚ïë üñ•Ô∏è  CPU: %d cores dispon√≠veis%s‚ïë\n", 
    cores_disponiveis, 
    strrep(" ", 44 - nchar(as.character(cores_disponiveis)))))
cat(sprintf("‚ïë üíæ RAM: %.1f GB%s‚ïë\n", 
    memoria_info, 
    strrep(" ", 48 - nchar(sprintf("%.1f GB", memoria_info)))))

# Configurar paraleliza√ß√£o (usar at√© 10 cores, deixar 2 para o sistema)
cores_usar <- min(10, max(1, cores_disponiveis - 2))
cat(sprintf("‚ïë ‚öôÔ∏è  Cores para processamento paralelo: %d%s‚ïë\n", 
    cores_usar,
    strrep(" ", 29 - nchar(as.character(cores_usar)))))

# Configurar backend de paraleliza√ß√£o
plan(multisession, workers = cores_usar)

# Desabilitar paraleliza√ß√£o autom√°tica do data.table para evitar conflitos
setDTthreads(1)

cat("‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£\n")
cat("‚ïë ‚úÖ Paraleliza√ß√£o configurada e ativa                        ‚ïë\n")
cat("‚ïë ‚úÖ Otimiza√ß√µes de mem√≥ria ativadas                          ‚ïë\n")
cat("‚ïë ‚úÖ Backend: future::multisession                            ‚ïë\n")
cat("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n")
cat("\n")

# ============================================================================
# FUN√á√ïES OTIMIZADAS PARA IMPORTA√á√ÉO PARALELA
# ============================================================================

# ============================================================================
# üîß CORRE√á√ÉO: Fun√ß√£o importar_excel_paralelo ATUALIZADA
# ============================================================================
# SUBSTITUA a fun√ß√£o antiga no chunk {r setup} por esta vers√£o

importar_excel_paralelo <- function(arquivos, skip = 5, .progress = TRUE) {
  if (length(arquivos) == 0) {
    warning("Nenhum arquivo fornecido")
    return(data.frame())
  }
  
  cat(sprintf("üì• Importando %d arquivos em paralelo...\n", length(arquivos)))
  
  resultado <- future_map_dfr(
    arquivos, 
    function(arq) {
      df <- read_excel(arq, skip = skip, col_types = "text") %>%
        clean_names()
      
      # ============================================================================
      # ‚úÖ CONVERS√ÉO AUTOM√ÅTICA DE COLUNAS NUM√âRICAS
      # ============================================================================
      # Padr√µes de nomes de colunas que devem ser num√©ricas
      numeric_patterns <- c(
        "^saldo_r",           # saldo_r_item_informacao, saldo_r_conta_contabil
        "^movim.*_r",         # movim_liquido_r_item_informacao
        "^valor",             # valor_lancado, valor_empenhado, valor_liquidado
        "_valor$",            # qualquer_coisa_valor
        "_saldo$",            # qualquer_coisa_saldo
        "saldo.*atual",       # saldo_dotacao_atual
        "mes_lancamento"      # mes_lancamento
      )
      
      # Encontrar colunas que correspondem aos padr√µes
      cols_numericas <- names(df)[str_detect(names(df), 
                                              paste(numeric_patterns, collapse = "|"))]
      
      # Converter para num√©rico (com suppressWarnings para NAs esperados)
      if (length(cols_numericas) > 0) {
        df <- df %>%
          mutate(across(all_of(cols_numericas), ~ suppressWarnings(as.numeric(.))))
      }
      
      return(df)
    },
    .progress = .progress,
    .options = furrr_options(seed = TRUE)
  )
  
  cat(sprintf("‚úÖ Importa√ß√£o conclu√≠da: %s registros\n", 
              format(nrow(resultado), big.mark = ".", decimal.mark = ",")))
  
  # Mostrar quais colunas foram convertidas
  cols_convertidas <- names(resultado)[sapply(resultado, is.numeric)]
  if (length(cols_convertidas) > 0) {
    cat(sprintf("   üìä Colunas num√©ricas: %d\n", length(cols_convertidas)))
  }
  
  return(resultado)
}

cat("‚úÖ Fun√ß√£o importar_excel_paralelo() ATUALIZADA carregada!\n\n")



# Operadores customizados
`%notin%` <- Negate(`%in%`)
`%||%` <- function(x, y) if(is.null(x) || length(x) == 0 || is.na(x)) y else x

formatar_numero <- function(x) {
  format(x, big.mark = ".", decimal.mark = ",", scientific = FALSE, nsmall = 2)
}

print("‚úÖ Bibliotecas carregadas com sucesso!")
```

## üîß Vari√°veis Globais

```{r variaveis_globais}
# Filtro principal do m√™s
mes_filtro <- "202511"

mes_pasta <- str_c("data/",mes_filtro,"/")

print(paste("üìÖ M√™s de refer√™ncia definido:", mes_filtro))
```

# üì• Importa√ß√£o dos Dados {#sec-dados}

## üßæ Dados de Receita

```{r dados_receita}


#| echo: true
#| eval: true
#| include: false

# ============================================================================
# ‚ö° VERS√ÉO OTIMIZADA - IMPORTA√á√ÉO PARALELA
# ============================================================================

# Definir arquivos a importar
arquivos_receita <- c(
  str_c(mes_pasta, "tg_receita_liquida.xlsx"),
  str_c(mes_pasta, "tg_receita_previsao.xlsx")
)

cat("üì• Importando dados de receita em paralelo...\n")

# Importar ambos os arquivos simultaneamente
dados_receita <- importar_excel_paralelo(
  arquivos = arquivos_receita, 
  skip = 5, 
  .progress = TRUE
) %>%
  # Filtrar e transformar uma √∫nica vez
  filter(orgao_uge_orcam_fiscal_s_n == "PERTENCE") %>%
  mutate(
    # Convers√£o de data
    mes_lancamento = as.numeric(mes_lancamento),
    data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1),
    
    # Vari√°veis derivadas
    tipo_modalidade = ifelse(
      nre1_categoria_economica_codigo %in% c(7, 8), 
      "intra", 
      "exceto intra"
    ),
    
    refinanciamento = ifelse(
      natureza_receita_codigo_completo %in% c(81110201, 21110201, 21210201), 
      "sim", 
      "nao"
    )
  )

cat(sprintf("‚úÖ Dados de receita carregados: %s registros\n", 
            format(nrow(dados_receita), big.mark = ".", decimal.mark = ",")))
cat(sprintf("   ‚Ä¢ Mem√≥ria utilizada: %.1f MB\n", 
            object.size(dados_receita) / 1024^2))
```

## üí∞ Dados de Despesa

```{r dados_despesa_rreo}
#| echo: true


#| include: false

# ============================================================================
# ‚ö° VERS√ÉO OTIMIZADA - IMPORTA√á√ÉO PARALELA
# ============================================================================

# Buscar todos os arquivos de despesa
arq_despesa <- list.files(
  path = mes_pasta, 
  pattern = 'tg_despesa', 
  full.names = TRUE
)

cat(sprintf("üì• Importando %d arquivos de despesa em paralelo...\n", length(arq_despesa)))

# Importar todos os arquivos simultaneamente
dados_despesa <- importar_excel_paralelo(
  arquivos = arq_despesa, 
  skip = 5, 
  .progress = TRUE
) %>%
  # Filtrar e transformar
  filter(orgao_uge_orcam_fiscal_s_n == "PERTENCE") %>%
  mutate(
    # Converter colunas num√©ricas espec√≠ficas
    across(contains("saldo"), as.numeric),
    across(contains("valor"), as.numeric),
    mes_lancamento = as.numeric(mes_lancamento),
    
    # Convers√£o de data
    data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1),
    
    # Vari√°veis derivadas - tipo_modalidade
    tipo_modalidade = ifelse(
      modalidade_aplicacao_codigo == 91,
      "intra",
      "exceto intra"
    ),
    
    # Vari√°veis derivadas - refinanciamento
    refinanciamento = case_when(
      grupo_despesa_codigo_grupo == 6 &
        elemento_despesa_codigo %in% c(76, 77) &
        subfuncao_governo_codigo %in% c(841, 842, 843, 844, 846) &
        fonte_recursos_codigo == "443" ~ "sim",
      !(grupo_despesa_codigo_grupo == 6 &
        elemento_despesa_codigo %in% c(76, 77) &
        subfuncao_governo_codigo %in% c(841, 842, 843, 844, 846) &
        fonte_recursos_codigo == "443") ~ "nao",
      TRUE ~ "escape"
    ),
    
    # Vari√°veis derivadas - poder
    poder = case_when(
      orgao_uge_orgao_maximo_codigo %in% c(59000) ~ "MINIST√âRIO P√öBLICO DA UNI√ÉO",
      orgao_uge_orgao_maximo_codigo %in% c(29000) ~ "DEFENSORIA P√öBLICA",
      TRUE ~ orgao_uge_poder_nome
    ),
    
    # Vari√°veis derivadas - transferencia
    transferencia = ifelse(
      modalidade_aplicacao_codigo %in% c('30', '31', '32', '35', '36', '40', '41', '42', '45', '46'), 
      "_transferencia", 
      "aplicacao_direta"
    )
  )

cat(sprintf("‚úÖ Dados de despesa carregados: %s registros\n", 
            format(nrow(dados_despesa), big.mark = ".", decimal.mark = ",")))
cat(sprintf("   ‚Ä¢ Arquivos processados: %d\n", length(arq_despesa)))
cat(sprintf("   ‚Ä¢ Mem√≥ria utilizada: %.1f MB\n", 
            object.size(dados_despesa) / 1024^2))

# Estat√≠sticas r√°pidas
cat("\nüìä Resumo por tipo_modalidade:\n")
print(dados_despesa %>% count(tipo_modalidade, sort = TRUE))

cat("\nüìä Resumo por refinanciamento:\n")
print(dados_despesa %>% count(refinanciamento, sort = TRUE))
```

## üìã Dados de Restos a Pagar

```{r dados_rp}
#| echo: true


#| include: false

# ============================================================================
# ‚ö° VERS√ÉO OTIMIZADA - IMPORTA√á√ÉO PARALELA MANTENDO ESTRUTURAS SEPARADAS
# ============================================================================

# Definir lista de arquivos a importar
arquivos_rp <- list(
  anexo_07 = str_c(mes_pasta, "rreo_a07_rp.xlsx"),
  anexo_12 = str_c(mes_pasta, "rreo_a12_rp.xlsx"),
  anexo_08 = str_c(mes_pasta, "rreo_a08_rp.xlsx"),
  anexo_03_rcl = str_c(mes_pasta, "rreo_a03_rp.xlsx")
)

cat(sprintf("üì• Importando %d arquivos de RP em paralelo...\n", length(arquivos_rp)))

# Importar todos simultaneamente, cada um mant√©m sua estrutura pr√≥pria
tempo_inicio <- Sys.time()

dados_rp_lista <- future_map(
  arquivos_rp,
  function(arquivo) {
    read_excel(arquivo, skip = 5) %>%
      clean_names() %>%
      mutate(
        mes_lancamento = as.numeric(mes_lancamento),
        data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1)
      )
  },
  .progress = TRUE,
  .options = furrr_options(seed = TRUE)
)

tempo_fim <- Sys.time()

# Extrair cada arquivo para sua vari√°vel espec√≠fica
# Anexo 07 precisa de transforma√ß√µes adicionais
dados_rp_anexo_07 <- dados_rp_lista$anexo_07 %>%
  mutate(
    tipo_modalidade = ifelse(
      modalidade_aplicacao_codigo == 91, 
      "intra", 
      "exceto intra"
    ),
    poder = case_when(
      orgao_uge_orgao_maximo_codigo %in% c(59000) ~ "MINIST√âRIO P√öBLICO DA UNI√ÉO",
      orgao_uge_orgao_maximo_codigo %in% c(29000) ~ "DEFENSORIA P√öBLICA",
      TRUE ~ orgao_uge_poder_nome
    )
  )

# Outros anexos mant√™m estrutura b√°sica
dados_rp_anexo_12 <- dados_rp_lista$anexo_12
dados_rp_anexo_08 <- dados_rp_lista$anexo_08
dados_rp_anexo_03_rcl <- dados_rp_lista$anexo_03_rcl

# Relat√≥rio de importa√ß√£o
cat("\n‚úÖ Dados de Restos a Pagar carregados:\n")
cat(sprintf("   ‚Ä¢ Anexo 07: %s registros (%.1f MB)\n", 
            format(nrow(dados_rp_anexo_07), big.mark = ".", decimal.mark = ","),
            object.size(dados_rp_anexo_07) / 1024^2))
cat(sprintf("   ‚Ä¢ Anexo 12: %s registros (%.1f MB)\n", 
            format(nrow(dados_rp_anexo_12), big.mark = ".", decimal.mark = ","),
            object.size(dados_rp_anexo_12) / 1024^2))
cat(sprintf("   ‚Ä¢ Anexo 08: %s registros (%.1f MB)\n", 
            format(nrow(dados_rp_anexo_08), big.mark = ".", decimal.mark = ","),
            object.size(dados_rp_anexo_08) / 1024^2))
cat(sprintf("   ‚Ä¢ Anexo 03 RCL: %s registros (%.1f MB)\n", 
            format(nrow(dados_rp_anexo_03_rcl), big.mark = ".", decimal.mark = ","),
            object.size(dados_rp_anexo_03_rcl) / 1024^2))

# Mem√≥ria total
memoria_total <- (object.size(dados_rp_anexo_07) + 
                  object.size(dados_rp_anexo_12) + 
                  object.size(dados_rp_anexo_08) + 
                  object.size(dados_rp_anexo_03_rcl)) / 1024^2

cat(sprintf("   ‚Ä¢ Mem√≥ria total: %.1f MB\n", memoria_total))
cat(sprintf("   ‚Ä¢ Tempo de importa√ß√£o: %.1f segundos\n", 
            as.numeric(difftime(tempo_fim, tempo_inicio, units = "secs"))))
```

## üè¶ Dados RREO Anexo 06 - Resultado Prim√°rio

```{r dados_rreo_a06_resultado_primario}
#| echo: true


#| include: false

# ============================================================================
# ‚ö° VERS√ÉO OTIMIZADA - IMPORTA√á√ÉO PARALELA DE 4 ARQUIVOS
# ============================================================================

# Definir arquivos
arquivos_a06 <- list(
  ndd = str_c(mes_pasta, "rreo_a06_despesas_primarias_ndd.xlsx"),
  categoria_grupo = str_c(mes_pasta, "rreo_a06_despesas_primarias_categoria_grupo.xlsx"),
  juros = str_c(mes_pasta, "rreo_a06_juros.xlsx"),
  disponibilidades = str_c(mes_pasta, "rreo_a06_disponibilidades.xlsx"),
  ajustes = str_c(mes_pasta, "rreo_a06_ajustes.xlsx")
)

cat(sprintf("üì• Importando %d arquivos do Anexo 06 em paralelo...\n", length(arquivos_a06)))

# Importar todos simultaneamente
dados_a06_lista <- future_map(
  arquivos_a06,
  function(arquivo) {
    read_excel(arquivo, skip = 5) %>%
      clean_names() %>%
      mutate(
        mes_lancamento = as.numeric(mes_lancamento),
        data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1)
      )
  },
  .progress = TRUE,
  .options = furrr_options(seed = TRUE)
)

# Extrair para vari√°veis espec√≠ficas
dados_ndd <- dados_a06_lista$ndd
dados_categoria_grupo <- dados_a06_lista$categoria_grupo
dados_juros <- dados_a06_lista$juros
tg_RPN_juros <- dados_juros  # Alias para compatibilidade
tg_RPN_disponibilidades <- dados_a06_lista$disponibilidades
dados_ajustes <- dados_a06_lista$ajustes

cat("\n‚úÖ Dados do Anexo 06 carregados:\n")
cat(sprintf("   ‚Ä¢ NDD: %s registros\n", 
            format(nrow(dados_ndd), big.mark = ".", decimal.mark = ",")))
cat(sprintf("   ‚Ä¢ Categoria/Grupo: %s registros\n", 
            format(nrow(dados_categoria_grupo), big.mark = ".", decimal.mark = ",")))
cat(sprintf("   ‚Ä¢ Juros: %s registros\n", 
            format(nrow(dados_juros), big.mark = ".", decimal.mark = ",")))
cat(sprintf("   ‚Ä¢ Disponibilidades: %s registros\n", 
            format(nrow(tg_RPN_disponibilidades), big.mark = ".", decimal.mark = ",")))
```

## üìä Dados RCL - RREO Anexo 03

```{r importar-dados-rcl}


#| include: false

cat("üì• Importando dados RCL (RREO A03)...\n")

# ============================================================================
# IMPORTA√á√ÉO
# ============================================================================

# Despesas
cat("   ‚Ä¢ Importando RCL Despesas...\n")
rreo_a03_rcl_despesas <- read_excel(
  str_c(mes_pasta, "rreo_a03_rcl_despesas.xlsx"), 
  skip = 5
) %>%
  clean_names() %>%
  mutate(
    # Converter coluna num√©rica
    movim_liquido_r_item_informacao = as.numeric(movim_liquido_r_item_informacao),
    mes_lancamento = as.numeric(mes_lancamento),
    data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1),
    # ‚úÖ CRIAR ALIAS para compatibilidade com crit√©rios
    saldo_r_item_informacao = movim_liquido_r_item_informacao
  )

# Receitas
cat("   ‚Ä¢ Importando RCL Receitas...\n")
rreo_a03_rcl_receitas <- read_excel(
  str_c(mes_pasta, "rreo_a03_rcl_receitas.xlsx"), 
  skip = 5
) %>%
  clean_names() %>%
  mutate(
    # Converter coluna num√©rica
    movim_liquido_r_item_informacao = as.numeric(movim_liquido_r_item_informacao),
    mes_lancamento = as.numeric(mes_lancamento),
    data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1),
    # ‚úÖ CRIAR ALIAS para compatibilidade com crit√©rios
    saldo_r_item_informacao = movim_liquido_r_item_informacao
  )

cat(sprintf("\n‚úì RCL Despesas: %s registros\n", 
            format(nrow(rreo_a03_rcl_despesas), big.mark = ".", decimal.mark = ",")))
cat(sprintf("‚úì RCL Receitas: %s registros\n", 
            format(nrow(rreo_a03_rcl_receitas), big.mark = ".", decimal.mark = ",")))

# ============================================================================
# VERIFICA√á√ÉO
# ============================================================================
cat("\nüîç Verifica√ß√£o:\n")
cat(sprintf("   Colunas em despesas: %d\n", ncol(rreo_a03_rcl_despesas)))
cat(sprintf("   Colunas em receitas: %d\n", ncol(rreo_a03_rcl_receitas)))

# Verificar que alias foi criado e √© num√©rico
cat("\n‚úÖ Alias 'saldo_r_item_informacao' criado:\n")
cat(sprintf("   Despesas: %s (tipo: %s)\n", 
            "saldo_r_item_informacao" %in% names(rreo_a03_rcl_despesas),
            class(rreo_a03_rcl_despesas$saldo_r_item_informacao)[1]))
cat(sprintf("   Receitas: %s (tipo: %s)\n", 
            "saldo_r_item_informacao" %in% names(rreo_a03_rcl_receitas),
            class(rreo_a03_rcl_receitas$saldo_r_item_informacao)[1]))

# Teste de agrega√ß√£o
cat("\nüß™ Teste de agrega√ß√£o:\n")
teste_desp <- rreo_a03_rcl_despesas %>% 
  summarise(
    total_movim = sum(movim_liquido_r_item_informacao, na.rm = TRUE),
    total_saldo = sum(saldo_r_item_informacao, na.rm = TRUE)
  )
cat(sprintf("   Despesas (movim_liquido): %s\n", 
            format(teste_desp$total_movim, big.mark = ".", decimal.mark = ",")))
cat(sprintf("   Despesas (saldo_r alias): %s\n", 
            format(teste_desp$total_saldo, big.mark = ".", decimal.mark = ",")))

teste_rec <- rreo_a03_rcl_receitas %>% 
  summarise(
    total_movim = sum(movim_liquido_r_item_informacao, na.rm = TRUE),
    total_saldo = sum(saldo_r_item_informacao, na.rm = TRUE)
  )
cat(sprintf("   Receitas (movim_liquido): %s\n", 
            format(teste_rec$total_movim, big.mark = ".", decimal.mark = ",")))
cat(sprintf("   Receitas (saldo_r alias): %s\n", 
            format(teste_rec$total_saldo, big.mark = ".", decimal.mark = ",")))

cat("\n‚úÖ Importa√ß√£o RCL conclu√≠da com sucesso!\n")
```

## üë• Dados RGF Anexo 01 - Despesa com Pessoal

```{r importar-dados-rgf-a01}


#| include: false

cat("üì• Importando dados RGF A01 (Despesa Pessoal)...\n")

# ============================================================================
# ‚ö° VERS√ÉO OTIMIZADA - IMPORTA√á√ÉO PARALELA
# ============================================================================

# RGF Anexo 1
arq_rgf_a01 <- list.files(path = mes_pasta, pattern = 'rgf_a01_', full.names = TRUE)

cat(sprintf("   Encontrados %d arquivos\n", length(arq_rgf_a01)))

rgf_a01 <- importar_excel_paralelo(arq_rgf_a01, skip = 5, .progress = TRUE) %>%
  mutate(
    movim_liquido_r_item_informacao = as.numeric(movim_liquido_r_item_informacao),
    mes_lancamento = as.numeric(mes_lancamento),
    data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1)
  )

cat(sprintf("‚úì RGF A01: %s registros (%d arquivos)\n", 
            format(nrow(rgf_a01), big.mark = ".", decimal.mark = ","), 
            length(arq_rgf_a01)))
```

## üèõÔ∏è Dados RGF Anexo 02 - D√≠vida Consolidada L√≠quida (DCL)

```{r importar-dados-rgf-a02}
#| include: false

cat("üì• Importando dados RGF A02 (DCL)...\n")

# ============================================================================
# ‚ö° VERS√ÉO OTIMIZADA - IMPORTA√á√ÉO PARALELA
# ============================================================================

# Fun√ß√£o auxiliar para processar arquivo (mantida para compatibilidade)
processar_arquivo_rgf_a02 <- function(file_path, skip_rows = 5) {
  df <- read_excel(file_path, skip = skip_rows, col_types = "text") %>%
    clean_names()
  
  if ("mes_lancamento" %in% names(df)) {
    df <- df %>%
      mutate(
        mes_lancamento = as.numeric(mes_lancamento),
        data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1)
      )
  }
  
  # Converte colunas num√©ricas automaticamente
  numeric_patterns <- c("^saldo_r", "^movim_liquido_r")
  cols_to_convert <- names(df)[str_detect(names(df), paste(numeric_patterns, collapse = "|"))]
  
  for (col in cols_to_convert) {
    df <- df %>% mutate(!!sym(col) := as.numeric(!!sym(col)))
  }
  
  return(df)
}

# Lista TODOS os arquivos rgf_a02_*.xlsx
arq_rgf_a02 <- list.files(
  path = mes_pasta,
  pattern = "^rgf_a02_.*\\.xlsx$",
  full.names = TRUE
)

cat(sprintf("   Encontrados %d arquivos\n", length(arq_rgf_a02)))

# Processar em paralelo
rgf_a02_list <- future_map(
  arq_rgf_a02,
  processar_arquivo_rgf_a02,
  .progress = TRUE,
  .options = furrr_options(seed = TRUE)
)

# Nomeia os dataframes
names(rgf_a02_list) <- basename(arq_rgf_a02) %>% str_remove("\\.xlsx$")

# Coloca cada um no ambiente global
list2env(rgf_a02_list, envir = .GlobalEnv)

cat(sprintf("‚úì RGF A02: %d arquivos importados\n", length(arq_rgf_a02)))
```

## üîê Dados RGF Anexo 03 - Garantias e Contragarantias

```{r importar-dados-rgf-a03}


#| include: false

cat("üì• Importando dados RGF A03 (Garantias)...\n")

# RGF Anexo 3
rgf_a03 <- read_excel(str_c(mes_pasta, "rgf_a03.xlsx"), skip = 5) %>%
  clean_names() %>%
  mutate(
    mes_lancamento = as.numeric(mes_lancamento),
    data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1)
  )

cat(sprintf("‚úì RGF A03: %s registros\n", 
            format(nrow(rgf_a03), big.mark = ".", decimal.mark = ",")))
```

## üí≥ Dados RGF Anexo 04 - Opera√ß√µes de Cr√©dito

```{r importar-dados-rgf-a04}

#| include: false
#| column: screen

cat("üì• Importando dados RGF A04 (Opera√ß√µes Cr√©dito)...\n")

# ============================================================================
# ‚ö° VERS√ÉO OTIMIZADA - IMPORTA√á√ÉO PARALELA
# ============================================================================

arquivos_a04 <- list(
  receitas = str_c(mes_pasta, "rgf_a04_receitas.xlsx"),
  despesas = str_c(mes_pasta, "rgf_a04_despesas.xlsx")
)

# Importar em paralelo
dados_a04_lista <- future_map(
  arquivos_a04,
  function(arquivo) {
    read_excel(arquivo, skip = 5) %>%
      clean_names() %>%
      mutate(
        mes_lancamento = as.numeric(mes_lancamento),
        data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1)
      )
  },
  .progress = TRUE
)

rgf_a04_receitas <- dados_a04_lista$receitas
rgf_a04_despesas <- dados_a04_lista$despesas

cat(sprintf("‚úì RGF A04 Receitas: %s registros\n", 
            format(nrow(rgf_a04_receitas), big.mark = ".", decimal.mark = ",")))
cat(sprintf("‚úì RGF A04 Despesas: %s registros\n", 
            format(nrow(rgf_a04_despesas), big.mark = ".", decimal.mark = ",")))
```

## üí∞ Dados RGF Anexo 05 - Disponibilidades de Caixa

```{r importar-dados-rgf-a05}


#| include: false

cat("üì• Importando dados RGF A05 (Disponibilidades)...\n")

# ============================================================================
# ‚ö° VERS√ÉO OTIMIZADA - IMPORTA√á√ÉO PARALELA
# ============================================================================

# Buscar todos os arquivos rgf_a05
arq_rgf_a05 <- list.files(path = mes_pasta, pattern = 'rgf_a05', full.names = TRUE)

cat(sprintf("   Encontrados %d arquivos\n", length(arq_rgf_a05)))

rgf_a05 <- importar_excel_paralelo(arq_rgf_a05, skip = 5, .progress = TRUE) %>%
  mutate(
    saldo_r_conta_contabil = as.numeric(saldo_r_conta_contabil),
    mes_lancamento = as.numeric(mes_lancamento),
    data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1)
  )

cat(sprintf("‚úì RGF A05: %s registros (%d arquivos)\n", 
            format(nrow(rgf_a05), big.mark = ".", decimal.mark = ","), 
            length(arq_rgf_a05)))
```

# Fun√ß√µes {#sec-funcoes-aux}

## Mapear arquivo

```{r}
# ============================================================================
# FUNCAO: mapear_arquivos_tg
# ============================================================================
# Gera uma tabela de apoio mapeando arquivos xlsx e seus filtros do TG.
# Basta informar o caminho da pasta com os arquivos.
#
# Uso: Chamar uma vez para ter a visao de todos os arquivos utilizados.
#
# Parametros:
#   - pasta: caminho da pasta com os arquivos xlsx
#   - pattern: padrao para filtrar arquivos (default: todos xlsx)
#
# Retorna:
#   - DataFrame com: arquivo, filtros_tg
# ============================================================================

mapear_arquivos_tg <- function(pasta, pattern = "\\.xlsx$") {
  
  # Listar todos os arquivos xlsx na pasta
  arquivos <- list.files(
    path = pasta, 
    pattern = pattern, 
    full.names = TRUE
  )
  
  if (length(arquivos) == 0) {
    warning("Nenhum arquivo encontrado na pasta")
    return(data.frame())
  }
  
  cat(sprintf("Mapeando %d arquivos...\n", length(arquivos)))
  
  # Extrair filtros de cada arquivo (celula A4)
  resultado <- map_df(arquivos, function(arq) {
    
    filtros_tg <- tryCatch({
      celula_a4 <- read_excel(arq, range = "A4", col_names = FALSE)
      as.character(celula_a4[[1]][1])
    }, error = function(e) {
      NA_character_
    })
    
    data.frame(
      arquivo = basename(arq),
      filtros_tg = filtros_tg,
      stringsAsFactors = FALSE
    )
  })
  
  # Salvar no ambiente global
  assign("df_arquivos_tg", resultado, envir = .GlobalEnv)
  
  cat(sprintf("Tabela gerada: df_arquivos_tg (%d arquivos)\n", nrow(resultado)))
  
  return(resultado)
}


# ============================================================================
# EXEMPLO DE USO:
# ============================================================================
# df_arquivos_tg <- mapear_arquivos_tg(mes_pasta)
# 
# # Visualizar
# datatable(df_arquivos_tg)
# ============================================================================
```

## Aplicar Crit√©rios

```{r}
#| include: false

#' Aplica crit√©rios de filtro e agrupamento a um dataframe
#'
#' @param df Dataframe de entrada com dados fiscais
#' @param criterios Lista nomeada de crit√©rios (cada item com campo 'criterio')
#' @param group_vars Vetor de vari√°veis para agrupamento (opcional)
#' @param save_global Se TRUE, salva resultado no ambiente global com nome autom√°tico (padr√£o: FALSE)
#' @param validate_criteria Se TRUE, valida crit√©rios antes de executar (padr√£o: TRUE)
#'
#' @return Dataframe com resultados agregados por categoria
#'
#' @examples
#' # Uso moderno (recomendado)
#' resultado <- aplicar_criterios(dados_despesa, criterios_rgf_A01)
#' 
#' # Compatibilidade com c√≥digo antigo
#' aplicar_criterios(dados_despesa, criterios_rgf_A01, save_global = TRUE)
#'
aplicar_criterios <- function(df, 
                               criterios, 
                               group_vars = NULL,
                               save_global = TRUE,
                               validate_criteria = TRUE) {
  
  # ============================================================================
  # 1. DETEC√á√ÉO AUTOM√ÅTICA DA M√âTRICA
  # ============================================================================
  metrica <- names(df)[grepl("^(saldo|movim)", names(df), ignore.case = TRUE)][1]
  
  if (is.na(metrica) || length(metrica) == 0) {
    stop("N√£o foi poss√≠vel detectar coluna de m√©trica (saldo_* ou movim_*)")
  }
  
  # ============================================================================
  # 2. CAPTURAR METADADOS DO DATAFRAME
  # ============================================================================
  df_completo <- paste(deparse(substitute(df)), collapse = " ")
  
  # Separar nome da df de eventuais filtros
  if (grepl("%>%", df_completo)) {
    df_nome <- trimws(strsplit(df_completo, "%>%")[[1]][1])
    df_filtros <- paste(strsplit(df_completo, "%>%")[[1]][-1], collapse = " %>% ")
    df_filtros <- trimws(df_filtros)
  } else {
    df_nome <- df_completo
    df_filtros <- NA
  }
  
  # Capturar nome da vari√°vel criterios
  criterios_nome <- deparse(substitute(criterios))
  
  # ============================================================================
  # 3. DEFINIR VARI√ÅVEIS DE AGRUPAMENTO
  # ============================================================================
  if (is.null(group_vars)) {
    group_vars <- c("mes_lancamento", "data_lancamento")
  } else {
    # Garantir que mes_lancamento e data_lancamento estejam inclu√≠dos
    if (!"mes_lancamento" %in% group_vars) {
      group_vars <- c("mes_lancamento", group_vars)
    }
    if (!"data_lancamento" %in% group_vars) {
      group_vars <- c("data_lancamento", group_vars)
    }
  }
  
  # Verificar quais colunas existem na df
  group_vars <- group_vars[group_vars %in% names(df)]
  
  # ============================================================================
  # 4. EXTRAIR METADADOS DOS CRIT√âRIOS
  # ============================================================================
  partes <- strsplit(criterios_nome, "_")[[1]]
  
  if (partes[1] == "criterios") {
    partes <- partes[-1]
  }
  
  relatorio <- if (length(partes) >= 1) partes[1] else NA
  anexo_codigo <- if (length(partes) >= 2) partes[2] else NA
  anexo_nome <- if (length(partes) >= 3) partes[3] else NA
  detalhe <- if (length(partes) >= 4) paste(partes[4:length(partes)], collapse = "_") else NA
  
  # ============================================================================
  # 5. VALIDAR CRIT√âRIOS (OPCIONAL)
  # ============================================================================
  if (validate_criteria) {
    for (cat_nome in names(criterios)) {
      crit <- criterios[[cat_nome]]
      
      # Pular f√≥rmulas matem√°ticas
      if (grepl("\\{[^}]+\\}", crit$criterio)) {
        next
      }
      
      # Tentar parsear para verificar sintaxe
      tryCatch({
        rlang::parse_expr(crit$criterio)
      }, error = function(e) {
        warning(sprintf("‚ö†Ô∏è Crit√©rio inv√°lido em categoria '%s': %s\n   Express√£o: %s", 
                       cat_nome, e$message, crit$criterio))
      })
    }
  }
  
  # ============================================================================
  # 6. APLICAR CRIT√âRIOS (COM RLANG - SEGURO)
  # ============================================================================
  resultado <- map_df(names(criterios), function(categoria) {
    crit <- criterios[[categoria]]
    
    # Pular f√≥rmulas matem√°ticas - ser√£o tratadas em calcular_operacoes
    if (grepl("\\{[^}]+\\}", crit$criterio)) {
      return(data.frame())
    }
    
    # Extrair flag de print do nome da categoria
    if (grepl("_s$", categoria)) {
      print_flag <- "s"
      categoria_limpa <- str_replace(categoria, "_s$", "")
    } else if (grepl("_n$", categoria)) {
      print_flag <- "n"
      categoria_limpa <- str_replace(categoria, "_n$", "")
    } else {
      print_flag <- "s"  # default
      categoria_limpa <- categoria
    }
    
    # ========================================================================
    # üîß CORRE√á√ÉO PRINCIPAL: Usar rlang em vez de eval(parse())
    # ========================================================================
    condicao_expr <- tryCatch({
      # Parsear express√£o de forma segura
      expr <- rlang::parse_expr(crit$criterio)
      
      # Avaliar no contexto do dataframe
      rlang::eval_tidy(expr, data = df)
      
    }, error = function(e) {
      stop(sprintf(
        "‚ùå Erro ao avaliar crit√©rio em categoria '%s':\n   Express√£o: %s\n   Erro: %s", 
        categoria, crit$criterio, e$message
      ))
    })
    
    # Verificar se retornou vetor l√≥gico
    if (!is.logical(condicao_expr)) {
      stop(sprintf(
        "‚ùå Crit√©rio n√£o retornou vetor l√≥gico em categoria '%s':\n   Express√£o: %s\n   Tipo retornado: %s",
        categoria, crit$criterio, class(condicao_expr)[1]
      ))
    }
    
    # ========================================================================
    # 7. APLICAR FILTRO E AGRUPAR
    # ========================================================================
    if (length(group_vars) > 0) {
      resultado_filtrado <- df %>%
        filter(condicao_expr) %>%
        group_by(across(all_of(group_vars))) %>%
        summarise(
          valor = sum(.data[[metrica]], na.rm = TRUE),
          .groups = "drop"
        ) %>%
       mutate(
  categoria = categoria_limpa,
  metrica = metrica,
  dataframe_nome = df_nome,
  dataframe_filtros = df_filtros,
  criterios_nome_completo = criterios_nome,  # ‚Üê ADICIONAR ISTO
  relatorio = relatorio,
  anexo_codigo = anexo_codigo,
  anexo_nome = anexo_nome,
  detalhe = detalhe,
  print = print_flag,
  filtro = crit$criterio
)
    } else {
      resultado_filtrado <- df %>%
        filter(condicao_expr) %>%
        summarise(
          valor = sum(.data[[metrica]], na.rm = TRUE)
        ) %>%
        mutate(
  categoria = categoria_limpa,
  metrica = metrica,
  dataframe_nome = df_nome,
  dataframe_filtros = df_filtros,
  criterios_nome_completo = criterios_nome,  # ‚Üê ADICIONAR ISTO
  relatorio = relatorio,
  anexo_codigo = anexo_codigo,
  anexo_nome = anexo_nome,
  detalhe = detalhe,
  print = print_flag,
  filtro = crit$criterio
)
    }
    
    # ========================================================================
    # üîß CORRE√á√ÉO: Usar str_extract em vez de separate(sep = 2)
    # ========================================================================
    resultado_final <- resultado_filtrado %>%
      mutate(
        # Extrair ordem (1 ou 2 d√≠gitos no in√≠cio)
        ordem = str_extract(categoria, "^\\d{1,2}"),
        # Extrair nome (tudo ap√≥s os d√≠gitos e espa√ßos)
        nome = str_trim(str_remove(categoria, "^\\d{1,2}\\s*"))
      ) %>%
      select(any_of(c("mes_lancamento", "data_lancamento")), everything())
    
    return(resultado_final)
  })
  
  # ============================================================================
  # 8. SALVAR NO AMBIENTE GLOBAL (OPCIONAL)
  # ============================================================================
  if (save_global) {
    novo_nome <- paste0("df_", criterios_nome)
    assign(novo_nome, resultado, envir = .GlobalEnv)
    message("‚úÖ Resultado salvo em vari√°vel global: ", novo_nome)
  }
  
  # ============================================================================
  # 9. RETORNAR RESULTADO
  # ============================================================================
  return(resultado)
}

```

```{r}

consolidar_criterios <- function(save_global = FALSE) {
  
  # ============================================================================
  # 1. OBTER DATAFRAMES DO AMBIENTE GLOBAL
  # ============================================================================
  objetos <- ls(envir = .GlobalEnv)
  df_criterios <- objetos[grepl("^df_criterios", objetos)]
  
  if (length(df_criterios) == 0) {
    warning("‚ö†Ô∏è Nenhuma dataframe com prefixo 'df_criterios' foi encontrada no ambiente global")
    return(data.frame())
  }
  
  message(sprintf("üìä Encontradas %d dataframes para consolidar", length(df_criterios)))
  
  # ============================================================================
  # 2. OBTER E PADRONIZAR DATAFRAMES
  # ============================================================================
  tabelas <- map(df_criterios, ~ get(.x, envir = .GlobalEnv))
  
  # Padronizar tipos de colunas antes de combinar
  tabelas_padronizadas <- map(tabelas, function(tabela) {
    
    # Converter colunas problem√°ticas para character
    if ("dataframe_filtros" %in% names(tabela)) {
      tabela$dataframe_filtros <- as.character(tabela$dataframe_filtros)
      tabela$dataframe_filtros[is.na(tabela$dataframe_filtros)] <- ""
    }
    
    if ("item_informacao_codigo" %in% names(tabela)) {
      tabela$item_informacao_codigo <- as.character(tabela$item_informacao_codigo)
    }
    if ("item_informacao_nome" %in% names(tabela)) {
      tabela$item_informacao_nome <- as.character(tabela$item_informacao_nome)
    }
    
    if ("relatorio" %in% names(tabela)) {
      tabela$relatorio <- as.character(tabela$relatorio)
    }
    if ("anexo_codigo" %in% names(tabela)) {
      tabela$anexo_codigo <- as.character(tabela$anexo_codigo)
    }
    if ("anexo_nome" %in% names(tabela)) {
      tabela$anexo_nome <- as.character(tabela$anexo_nome)
    }
    if ("detalhe" %in% names(tabela)) {
      tabela$detalhe <- as.character(tabela$detalhe)
    }
    
    return(tabela)
  })
  
  # ============================================================================
  # 3. COMBINAR TODAS AS TABELAS (SEM AGRUPAR AINDA)
  # ============================================================================
  resultado_completo <- bind_rows(tabelas_padronizadas)
  
  message(sprintf("‚úÖ Consolidadas %d linhas de dados", nrow(resultado_completo)))
  
  # ============================================================================
  # 4. üîß CORRE√á√ÉO: IDENTIFICAR TODAS AS COLUNAS PARA AGRUPAMENTO
  # ============================================================================
  # Colunas padr√£o que sempre existem
  colunas_padrao <- c("mes_lancamento", "data_lancamento", "ordem", "nome", 
                      "metrica", "dataframe_nome", "dataframe_filtros",
                      "relatorio", "anexo_codigo", "anexo_nome", 
                      "detalhe", "print", "filtro")
  
  # üîß NOVO: Identificar colunas EXTRAS que vieram de group_vars
  todas_colunas <- names(resultado_completo)
  colunas_extras <- setdiff(
    todas_colunas, 
    c(colunas_padrao, "valor", "categoria", "chave")
  )
  
  # Colunas para agrupamento = padr√£o + extras
  colunas_agrupamento <- c(colunas_padrao, colunas_extras)
  
  # Filtrar apenas as que realmente existem
  colunas_agrupamento <- colunas_agrupamento[colunas_agrupamento %in% todas_colunas]
  
  message(sprintf("üìã Agrupando por %d colunas (incluindo vari√°veis customizadas)", 
                  length(colunas_agrupamento)))
  
  # ============================================================================
  # 5. AGRUPAR E SUMARIZAR (PRESERVANDO TODAS AS DIMENS√ïES)
  # ============================================================================
  resultado <- resultado_completo %>%
    group_by(across(all_of(colunas_agrupamento))) %>%
    summarise(valor = sum(valor, na.rm = TRUE), .groups = "drop") %>%
    arrange(mes_lancamento, relatorio, anexo_codigo, detalhe, ordem)
  
  # ============================================================================
  # 6. CRIAR COLUNAS DERIVADAS
  # ============================================================================
  resultado <- resultado %>%
    mutate(
      # Garantir que data_lancamento existe
      data_lancamento = if_else(
        is.na(data_lancamento),
        ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1),
        data_lancamento
      ),
      # Criar chave √∫nica
      chave = paste0(
        mes_lancamento, "_", 
        tolower(relatorio), "_", 
        tolower(anexo_codigo), "_", 
        tolower(detalhe), "_", 
        ordem
      )
    )
  
  # ============================================================================
  # 7. REORDENAR COLUNAS (PADR√ÉO + EXTRAS + VALOR)
  # ============================================================================
  colunas_ordem <- c(
    "chave", "mes_lancamento", "data_lancamento", 
    "dataframe_nome", "dataframe_filtros", 
    "relatorio", "anexo_codigo", "anexo_nome", 
    "detalhe", "print", "filtro", "metrica"
  )
  
  # Adicionar colunas extras na ordem
  colunas_ordem <- c(colunas_ordem, colunas_extras)
  
  # Adicionar ordem, nome, valor no final
  colunas_ordem <- c(colunas_ordem, "ordem", "nome", "valor")
  
  # Selecionar apenas colunas que existem (sem duplicatas)
  colunas_ordem <- unique(colunas_ordem[colunas_ordem %in% names(resultado)])
  
  resultado <- resultado %>% select(all_of(colunas_ordem))
  
  # ============================================================================
  # 8. SALVAR NO AMBIENTE GLOBAL (OPCIONAL)
  # ============================================================================
  if (save_global) {
    assign("df_criterios_consolidado", resultado, envir = .GlobalEnv)
    message("‚úÖ Dados consolidados salvos em: df_criterios_consolidado")
  }
  
  # ============================================================================
  # 9. RETORNAR RESULTADO
  # ============================================================================
  return(resultado)
}


```

## Formata√ß√£o de N√∫meros

```{r formatar_numero}
#| echo: true
#| include: false

#' Formatar n√∫meros para exibi√ß√£o brasileira
#' @param x Vetor num√©rico a ser formatado
#' @return String formatada com ponto como separador de milhares e v√≠rgula como decimal
formatar_numero <- function(x) {
  format(x, big.mark = ".", decimal.mark = ",", scientific = FALSE, nsmall = 2)
}

# Teste da fun√ß√£o
exemplo_numero <- 1234567.89
print(paste("N√∫mero original:", exemplo_numero))
print(paste("N√∫mero formatado:", formatar_numero(exemplo_numero)))
```

## Formata√ß√£o de Tabelas

```{r dt_formatada}
#| echo: true
#| include: false

#' Criar tabela DT formatada com totais
#' @param df Data frame a ser formatado
#' @param grupo Vetor com nomes das colunas de agrupamento (n√£o num√©ricas)
#' @return Objeto DT formatado
dt_formatada <- function(df, grupo) {
  # library(DT)
  # library(janitor)
  
  datatable(
    df %>% adorn_totals("row"), 
    rownames = FALSE,
    extensions = 'Buttons',
    options = list(
      lengthMenu = c(5, 10, 25, 50, 100),
      dom = 'Bfrtip',
      buttons = list('excel')
    )
  ) %>% 
  formatRound(
    setdiff(df %>% colnames(), grupo), 
    2, 
    mark = ".", 
    dec.mark = ","
  ) %>% 
  DT::formatStyle(
    columns = colnames(.$x$data), 
    fontSize = '75%'
  )
}

print("‚úÖ Fun√ß√£o dt_formatada definida")
```

## Tabela Pivotada

```{r tabela_pivotada}
#| echo: true
#| include: false

#' Pivotar tabela a partir dos itens de informa√ß√£o
#' @param df Data frame com dados
#' @param grupo Vetor com nomes das colunas de agrupamento
#' @return Data frame pivotado e sumarizado
tabela_pivotada <- function(df, grupo) {
  # library(dplyr)
  # library(tidyr)
  
  # Obter itens √∫nicos de informa√ß√£o
  itens <- df$item_informacao_nome %>% unique() %>% na.omit()
  
  # Verificar se a coluna principal existe
  if (!"saldo_r_item_informacao" %in% names(df)) {
    stop("Coluna 'saldo_r_item_informacao' n√£o encontrada no data frame")
  }
  
  # Pivotar e sumarizar apenas a coluna num√©rica
  df %>% 
    group_by(!!!syms(grupo)) %>% 
    pivot_wider(
      names_from = item_informacao_nome, 
      values_from = saldo_r_item_informacao,
      values_fill = 0
    ) %>% 
    # Sumarizar apenas as colunas que correspondem aos itens (num√©ricas)
    summarise(
      across(all_of(itens), ~ sum(.x, na.rm = TRUE)),
      .groups = "drop"
    )
}


```

## Calcular opera√ß√µes

```{r calcular_operacoes}
#| echo: true
#| include: false
# Fun√ß√£o para realizar opera√ß√µes matem√°ticas usando as chaves √∫nicas
calcular_operacoes <- function(dados_consolidados = NULL, ...) {
  
  # Se dados n√£o fornecidos, usar consolidar_criterios()
  if (is.null(dados_consolidados)) {
    dados_consolidados <- consolidar_criterios()
  }
  
  # Capturar as opera√ß√µes passadas como argumentos
  operacoes <- list(...)
  
  if (length(operacoes) == 0) {
    stop("Nenhuma opera√ß√£o foi especificada")
  }
  
  # Criar um lookup table para facilitar a busca
  lookup_valores <- setNames(dados_consolidados$valor, dados_consolidados$chave)
  
  # Processar cada opera√ß√£o
  resultados <- map(names(operacoes), function(nome_operacao) {
    operacao <- operacoes[[nome_operacao]]
    
    if (is.character(operacao)) {
      # Opera√ß√£o simples: apenas a f√≥rmula como string
      formula <- operacao
    } else if (is.list(operacao) && !is.null(operacao$formula)) {
      # Opera√ß√£o estruturada
      formula <- operacao$formula
    } else {
      stop(paste("Opera√ß√£o", nome_operacao, "deve ser uma string (f√≥rmula) ou list com 'formula'"))
    }
    
    formula_processada <- formula
    
    # Encontrar todas as chaves na f√≥rmula (padr√£o: YYYYMM_texto_texto_texto_NN)
    chaves <- str_extract_all(formula, "[0-9]{6}_[a-zA-Z0-9/_]+_[a-zA-Z0-9/_]+_[a-zA-Z0-9/_]+_[0-9]+")[[1]]
    
    for (chave in chaves) {
      valor <- ifelse(chave %in% names(lookup_valores), 
                      lookup_valores[[chave]], 
                      0)
      # Converter para num√©rico e usar format cient√≠fico se necess√°rio para evitar v√≠rgulas
      valor_numerico <- as.numeric(valor)
      # Usar options para garantir nota√ß√£o sem v√≠rgula
      valor_limpo <- format(valor_numerico, scientific = FALSE, big.mark = "")
      
      formula_processada <- str_replace(formula_processada, 
                                        fixed(chave), 
                                        valor_limpo)
    }
    
    # Avaliar a express√£o matem√°tica
    resultado_calculo <- eval(parse(text = formula_processada))
    
    return(list(
      operacao = nome_operacao,
      formula_original = formula,
      formula_processada = formula_processada,
      resultado = resultado_calculo
    ))
  })
  
  names(resultados) <- names(operacoes)
  return(resultados)
}
```

# RGF - Relat√≥rio de Gest√£o Fiscal


# üìã RGF Anexo 01 - Despesa com Pessoal {#sec-rgf-a01}

## Ficha T√©cnica

```{r ficha-tecnica-rgf-a01}
#| echo: false

# =============================================================================
# FICHA T√âCNICA DO ANEXO
# =============================================================================

ficha_tecnica <- tibble::tribble(
  ~Campo,                 ~Informa√ß√£o,
  "Relat√≥rio",            "RGF - Relat√≥rio de Gest√£o Fiscal",
  "Anexo",                "Anexo 01",
  "Nome",                 "Demonstrativo da Despesa com Pessoal",
  "Base Legal",           "LRF Art. 55, inciso I, al√≠nea 'a'",
  "Periodicidade",        "Quadrimestral",
  "Grau de Dificuldade",  "‚≠ê‚≠ê‚≠ê‚≠ê Dif√≠cil",
  "√öltima Atualiza√ß√£o",   format(Sys.Date(), "%d/%m/%Y")
)

knitr::kable(ficha_tecnica, col.names = c("Campo", "Informa√ß√£o"))
```

## Arquivos Necess√°rios

```{r arquivos-rgf-a01}
#| echo: false

# =============================================================================
# ARQUIVOS DO TESOURO GERENCIAL UTILIZADOS
# =============================================================================

arquivos <- tibble::tribble(
  ~Arquivo,                    ~Descri√ß√£o,                                    ~Filtros_TG,
  "rgf_a01_jan.xlsx",          "Despesa pessoal - Janeiro",                   "M√™s = 01",
  "rgf_a01_fev.xlsx",          "Despesa pessoal - Fevereiro",                 "M√™s = 02",
  "rgf_a01_mar.xlsx",          "Despesa pessoal - Mar√ßo",                     "M√™s = 03",
  "rgf_a01_abr.xlsx",          "Despesa pessoal - Abril",                     "M√™s = 04",
  "rgf_a01_mai.xlsx",          "Despesa pessoal - Maio",                      "M√™s = 05",
  "rgf_a01_jun.xlsx",          "Despesa pessoal - Junho",                     "M√™s = 06",
  "rgf_a01_jul.xlsx",          "Despesa pessoal - Julho",                     "M√™s = 07",
  "rgf_a01_ago.xlsx",          "Despesa pessoal - Agosto",                    "M√™s = 08",
  "rgf_a01_set.xlsx",          "Despesa pessoal - Setembro",                  "M√™s = 09",
  "rgf_a01_out.xlsx",          "Despesa pessoal - Outubro",                   "M√™s = 10",
  "rgf_a01_nov.xlsx",          "Despesa pessoal - Novembro (se aplic√°vel)",   "M√™s = 11",
  "rgf_a01_dez.xlsx",          "Despesa pessoal - Dezembro (se aplic√°vel)",   "M√™s = 12"
)

knitr::kable(arquivos, col.names = c("Arquivo", "Descri√ß√£o", "Filtros no TG"))
```

## Atributos Utilizados

```{r atributos-rgf-a01}
#| echo: false

# =============================================================================
# ATRIBUTOS (COLUNAS) DOS ARQUIVOS E SEUS USOS
# =============================================================================
# Legenda de Uso:
#   TG        = Campo vindo do Tesouro Gerencial
#   R         = Campo calculado em R
#   Crit√©rio  = Usado nos filtros/crit√©rios
#   Apresenta√ß√£o = Usado na exibi√ß√£o final

atributos <- tibble::tribble(
  ~Atributo,                          ~Tipo,       ~Uso,                         ~Descri√ß√£o,
  "grupo_despesa_codigo_grupo",       "character", "TG / Crit√©rio",              "C√≥digo do grupo de despesa (1=Pessoal)",
  "elemento_despesa_codigo",          "character", "TG / Crit√©rio",              "C√≥digo do elemento de despesa",
  "natureza_despesa_detalhada_codigo","character", "TG / Crit√©rio",              "C√≥digo detalhado da natureza de despesa",
  "natureza_despesa_detalhada_nome",  "character", "TG / Crit√©rio",              "Nome da natureza de despesa (para detec√ß√£o de termos)",
  "modalidade_aplicacao_codigo",      "character", "TG / Crit√©rio",              "C√≥digo da modalidade de aplica√ß√£o",
  "fonte_recursos_codigo",            "character", "TG / Crit√©rio",              "C√≥digo da fonte de recursos",
  "unidade_orcamentaria_codigo",      "character", "TG / Crit√©rio",              "C√≥digo da UO (para AP, RR, DF)",
  "plano_orcamentario_codigo_po",     "character", "TG / Crit√©rio",              "C√≥digo do Plano Or√ßament√°rio",
  "acao_governo_codigo",              "character", "TG / Crit√©rio",              "C√≥digo da a√ß√£o de governo",
  "uo_poder",                         "character", "TG / Crit√©rio",              "Identificador do Poder (0=Executivo)",
  "uo_orgao_maximo_codigo",           "character", "TG / Crit√©rio",              "C√≥digo do √≥rg√£o m√°ximo",
  "item_informacao_codigo",           "character", "TG / Crit√©rio",              "C√≥digo do item (25=Liquidado, 27=RPNP)",
  "mes_lancamento",                   "numeric",   "TG / R",                     "M√™s do lan√ßamento (YYYYMM)",
  "movim_liquido_r_item_informacao",  "numeric",   "TG / R",                     "Valor do movimento l√≠quido",
  "data_lancamento",                  "Date",      "R",                          "Data calculada do lan√ßamento",
  "categoria_pessoal",                "character", "R / Crit√©rio / Apresenta√ß√£o","Categoria: executivo, AP, RR, DF, demais"
)

knitr::kable(atributos, col.names = c("Atributo", "Tipo", "Uso", "Descri√ß√£o"))
```

## V√≠nculos com Outros Anexos

```{r vinculos-rgf-a01}
#| echo: false

# =============================================================================
# RELACIONAMENTO COM OUTROS ANEXOS
# =============================================================================

vinculos <- tibble::tribble(
  ~Anexo_Relacionado,   ~Tipo_V√≠nculo,    ~Descri√ß√£o,
  "RREO Anexo 03",      "Refer√™ncia",     "RCL utilizada para c√°lculo dos limites",
  "RGF Anexo 06",       "Consolida√ß√£o",   "Valores consolidados no demonstrativo simplificado"
)

knitr::kable(vinculos, col.names = c("Anexo Relacionado", "Tipo de V√≠nculo", "Descri√ß√£o"))
```

## Estrutura do Demonstrativo

```{r estrutura-rgf-a01}
#| echo: false

# =============================================================================
# ESTRUTURA DO DEMONSTRATIVO - GRUPOS E ITENS
# =============================================================================

estrutura <- tibble::tribble(
  ~Ordem, ~Item,                                           ~Grupo,
  "11",   "Vencimentos, Vantagens e Outras Desp. Vari√°veis", "I - Despesa Bruta",
"12",   "Obriga√ß√µes Patronais",                          "I - Despesa Bruta",
  "13",   "Aposentadorias, Reserva e Reformas",             "I - Despesa Bruta",
  "14",   "Pens√µes",                                        "I - Despesa Bruta",
  "15",   "Outras Despesas com Inativos",                   "I - Despesa Bruta",
  "16",   "Outras Despesas de Pessoal - Terceiriza√ß√£o",     "I - Despesa Bruta",
  "17",   "Despesa com Pessoal n√£o Executada Or√ßam.",       "I - Despesa Bruta",
  "21",   "Indeniza√ß√µes por Demiss√£o e Incentivos",         "II - Despesas N√£o Computadas",
  "22",   "Decorrentes de Decis√£o Judicial",                "II - Despesas N√£o Computadas",
  "23",   "Despesas de Exerc√≠cios Anteriores",              "II - Despesas N√£o Computadas",
  "24",   "Inativos e Pensionistas com Recursos Vinculados","II - Despesas N√£o Computadas"
)

knitr::kable(estrutura, col.names = c("Ordem", "Item", "Grupo"))
```

## Importa√ß√£o dos Dados

```{r importar-rgf-a01}
#| code-fold: true
#| code-summary: "Ver c√≥digo de importa√ß√£o"

# =============================================================================
# IMPORTA√á√ÉO DOS DADOS RGF ANEXO 01
# =============================================================================
# Este chunk importa todos os arquivos mensais de despesa com pessoal.
# Os arquivos seguem o padr√£o: rgf_a01_[m√™s].xlsx
# =============================================================================

cat("üì• Importando dados RGF Anexo 01 (Despesa com Pessoal)...\n")

# -----------------------------------------------------------------------------
# 1. Listar arquivos dispon√≠veis
# -----------------------------------------------------------------------------
# Busca todos os arquivos que come√ßam com "rgf_a01_" na pasta do m√™s

arq_rgf_a01 <- list.files(
  path = mes_pasta, 
  pattern = "rgf_a01_", 
  full.names = TRUE
)

cat(sprintf("   Encontrados %d arquivos\n", length(arq_rgf_a01)))

# -----------------------------------------------------------------------------
# 2. Importar arquivos em paralelo
# -----------------------------------------------------------------------------
# Usa a fun√ß√£o importar_excel_paralelo() definida no setup
# - skip = 5: pula as 5 primeiras linhas (cabe√ßalho do TG)
# - .progress = TRUE: mostra barra de progresso

rgf_a01 <- importar_excel_paralelo(arq_rgf_a01, skip = 5, .progress = TRUE)

# -----------------------------------------------------------------------------
# 3. Converter colunas e criar data_lancamento
# -----------------------------------------------------------------------------

rgf_a01 <- rgf_a01 %>%
  mutate(
    # Garantir que valores num√©ricos est√£o corretos
    movim_liquido_r_item_informacao = as.numeric(movim_liquido_r_item_informacao),
    mes_lancamento = as.numeric(mes_lancamento),
    
    # Criar data do lan√ßamento (√∫ltimo dia do m√™s)
    # Exemplo: 202501 -> 2025-01-31
    data_lancamento = ceiling_date(
      ymd(paste0(mes_lancamento, "01")), 
      "month"
    ) - days(1)
  )

cat(sprintf("‚úÖ RGF A01: %s registros importados\n", 
            format(nrow(rgf_a01), big.mark = ".", decimal.mark = ",")))
```

## Categoriza√ß√£o por Regi√£o/Poder

```{r categorizar-rgf-a01}
#| code-fold: true
#| code-summary: "Ver c√≥digo de categoriza√ß√£o"

# =============================================================================
# CATEGORIZA√á√ÉO DOS DADOS POR REGI√ÉO/PODER
# =============================================================================
# O demonstrativo √© segregado por:
#   - Poder Executivo Federal
#   - Ex-Territ√≥rios (AP, RR)
#   - Distrito Federal (DF)
# =============================================================================

rgf_a01 <- rgf_a01 %>%
  mutate(
    categoria_pessoal = case_when(
      
      # -------------------------------------------------------------------------
      # DESPESAS RESSALVADAS (aplicar primeiro - mais espec√≠fico)
      # -------------------------------------------------------------------------
      # Naturezas de despesa que s√£o ressalvadas do c√°lculo
      natureza_despesa_detalhada_codigo %in% c(
        "31900503", "31900504", "31900505", "31900506", 
        "31900507", "31900508", "31900501", "31900502"
      ) ~ "ressalvadas",
      
      # -------------------------------------------------------------------------
      # AMAP√Å (AP)
      # -------------------------------------------------------------------------
      # UO 73113 + PO 0004 + A√ß√µes espec√≠ficas
      unidade_orcamentaria_codigo == "73113" & 
        plano_orcamentario_codigo_po == "0004" &
        acao_governo_codigo %in% c("0179", "0181", "214H") ~ "AP",
      
      # -------------------------------------------------------------------------
      # RORAIMA (RR)
      # -------------------------------------------------------------------------
      # UO 73113 + PO 0003 + A√ß√µes espec√≠ficas
      unidade_orcamentaria_codigo == "73113" & 
        plano_orcamentario_codigo_po == "0003" & 
        acao_governo_codigo %in% c("0179", "0181", "214H") ~ "RR",
      
      # -------------------------------------------------------------------------
      # DISTRITO FEDERAL (DF)
      # -------------------------------------------------------------------------
      # UO 73901 = FCDF (Fundo Constitucional do DF)
      unidade_orcamentaria_codigo == "73901" ~ "DF",
      
      # -------------------------------------------------------------------------
      # PODER EXECUTIVO FEDERAL
      # -------------------------------------------------------------------------
      # uo_poder = 0 (Executivo)
      # Exceto √≥rg√£os 34000 (MPU) e 59000 (n√£o identificado)
      uo_poder == "0" &
        !uo_orgao_maximo_codigo %in% c("34000", "59000") ~ "executivo",
      
      # -------------------------------------------------------------------------
      # DEMAIS
      # -------------------------------------------------------------------------
      TRUE ~ "demais"
    )
  )

# Exibir contagem por categoria
cat("\nüìä Distribui√ß√£o por categoria:\n")
rgf_a01 %>%
  count(categoria_pessoal) %>%
  arrange(desc(n)) %>%
  print()
```

## Crit√©rios de Classifica√ß√£o

```{r criterios-rgf-a01}
#| code-fold: true
#| code-summary: "Ver crit√©rios de classifica√ß√£o"

# =============================================================================
# CRIT√âRIOS RGF ANEXO 01 - DEFINI√á√ÉO DOS FILTROS
# =============================================================================
# Numera√ß√£o compat√≠vel com a estrutura do demonstrativo:
#   - Grupo I (1x): Componentes da Despesa Bruta
#   - Grupo II (2x): Despesas N√£o Computadas
# =============================================================================

criterios_rgf_A01_pessoal_rgf <- list(
  
  # ===========================================================================
  # GRUPO I - COMPONENTES DA DESPESA BRUTA
  # ===========================================================================
  
  # ---------------------------------------------------------------------------
  # 11 - VENCIMENTOS, VANTAGENS E OUTRAS DESPESAS VARI√ÅVEIS
  # ---------------------------------------------------------------------------
  # Grupo 1 (Pessoal), excluindo:
  #   - Elementos 01, 03, 34 (aposentadoria, pens√£o, terceiriza√ß√£o)
  #   - Obriga√ß√µes patronais
  #   - Benef√≠cios previdenci√°rios
  #   - Termos de inativos
  #   - Despesas com inativos espec√≠ficas
  
  `11  Vencimentos, Vantagens e Outras Despesas Vari√°veis` = list(
    criterio = "
    grupo_despesa_codigo_grupo == '1' &
    !elemento_despesa_codigo %in% c('01', '03', '34') &
    
    # EXCLUS√ÉO: Obriga√ß√µes Patronais
    !(
      (substr(natureza_despesa_detalhada_codigo, 1, 1) == '3' &
       grupo_despesa_codigo_grupo == '1' &
       elemento_despesa_codigo == '92' &
       ((modalidade_aplicacao_codigo == '90' & 
         natureza_despesa_detalhada_codigo %in% c('31909213', '31909207')) |
        (modalidade_aplicacao_codigo == '91' & 
         natureza_despesa_detalhada_codigo == '31919213'))) |
      elemento_despesa_codigo %in% c('13', '07')
    ) &
    
    # EXCLUS√ÉO: Benef√≠cios Previdenci√°rios
    !(
      (substr(natureza_despesa_detalhada_codigo, 1, 1) == '3' &
       grupo_despesa_codigo_grupo == '1' &
       elemento_despesa_codigo == '92' &
       natureza_despesa_detalhada_codigo == '31909205' &
       modalidade_aplicacao_codigo %in% c('90', '91')) |
      str_detect(natureza_despesa_detalhada_codigo, '0599')
    ) &
    
    # EXCLUS√ÉO: Termos de Inativos (por nome)
    !str_detect(natureza_despesa_detalhada_nome, 
                '\\\\bAPOSENT|\\\\bINAT|\\\\bREFORMA|\\\\bPENS|LEI 7\\\\.963/1989') &
    
    # EXCLUS√ÉO: Despesas com Inativos espec√≠ficas
    !(
      grupo_despesa_codigo_grupo == '1' &
      elemento_despesa_codigo == '05' &
      (str_detect(natureza_despesa_detalhada_codigo, '0505') | 
       str_detect(natureza_despesa_detalhada_codigo, '0506') |
       str_detect(natureza_despesa_detalhada_codigo, '0507') |
       str_detect(natureza_despesa_detalhada_codigo, '0508')) &
      elemento_despesa_codigo %in% c('05', '08', '09', '17', '91', '92', '94')
    )
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 12 - OBRIGA√á√ïES PATRONAIS
  # ---------------------------------------------------------------------------
  # Elementos 13 (Obriga√ß√µes Patronais) e 07 (Contrib. RPPS)
  # Mais naturezas espec√≠ficas de contribui√ß√µes patronais
  
  `12  Obriga√ß√µes Patronais` = list(
    criterio = "
    grupo_despesa_codigo_grupo == '1' & 
    elemento_despesa_codigo %in% c('13', '07') | 
    natureza_despesa_detalhada_codigo %in% c('31909213', '31919213', '31909207')
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 13 - APOSENTADORIAS, RESERVA E REFORMAS
  # ---------------------------------------------------------------------------
  # Elemento 01 (Aposentadorias/Reformas/Pens√µes RPPS)
  # Mais naturezas espec√≠ficas de aposentadorias
  
  `13  Aposentadorias, Reserva e Reformas` = list(
    criterio = "
    grupo_despesa_codigo_grupo == '1' & 
    elemento_despesa_codigo == '01' | 
    natureza_despesa_detalhada_codigo %in% c(
      '31901702', '31909109', '31909112', '31909115', '31909118', 
      '31909123', '31909124', '31909128', '31909129', '31909201', 
      '31909403', '31909404', '31909413', '31909414'
    )
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 14 - PENS√ïES
  # ---------------------------------------------------------------------------
  # Elemento 03 (Pens√µes)
  # Mais naturezas espec√≠ficas de pens√µes
  
  `14  Pens√µes` = list(
    criterio = "
    grupo_despesa_codigo_grupo == '1' & 
    (elemento_despesa_codigo == '03' | 
     natureza_despesa_detalhada_codigo %in% c(
       '31909110', '31909113', '31909116', '31909119', '31909131', 
       '31909136', '31909137', '31909130', '31909203', '31909220', 
       '31909221', '31909406', '31909413'
     ))
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 15 - OUTRAS DESPESAS COM INATIVOS
  # ---------------------------------------------------------------------------
  # Elementos espec√≠ficos + detec√ß√£o de termos de inativos
  # Excluindo naturezas j√° classificadas em outras categorias
  
  `15  Outras Despesas com Inativos` = list(
    criterio = "
    grupo_despesa_codigo_grupo == '1' & 
    elemento_despesa_codigo %in% c('05', '08', '09', '17', '31', '32') & 
    str_detect(natureza_despesa_detalhada_nome, 
               'APOSENT|INAT|REFORMA|PEN|LEI 7\\\\.963/1989') & 
    !(str_detect(natureza_despesa_detalhada_codigo, '0599') & 
      natureza_despesa_detalhada_codigo %in% c('31909205', '31919205')) & 
    !(str_detect(natureza_despesa_detalhada_codigo, '0505') | 
      str_detect(natureza_despesa_detalhada_codigo, '0506') | 
      str_detect(natureza_despesa_detalhada_codigo, '0507') | 
      str_detect(natureza_despesa_detalhada_codigo, '0508'))
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 16 - OUTRAS DESPESAS DE PESSOAL - TERCEIRIZA√á√ÉO
  # ---------------------------------------------------------------------------
  # Elemento 34 (Outras Desp. Pessoal - Terceiriza√ß√£o)
  # Grupos 1 e 3
  
  `16  Outras Despesas de Pessoal - Terceiriza√ß√£o` = list(
    criterio = "
    grupo_despesa_codigo_grupo %in% c('1', '3') & 
    elemento_despesa_codigo == '34'
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 17 - DESPESA COM PESSOAL N√ÉO EXECUTADA OR√áAMENTARIAMENTE
  # ---------------------------------------------------------------------------
  # Placeholder - ajustar conforme metodologia
  
  `17  Despesa com Pessoal n√£o Executada Or√ßamentariamente` = list(
    criterio = "FALSE"
  ),
  
  # ===========================================================================
  # GRUPO II - DESPESAS N√ÉO COMPUTADAS
  # ===========================================================================
  
  # ---------------------------------------------------------------------------
  # 21 - INDENIZA√á√ïES POR DEMISS√ÉO E INCENTIVOS
  # ---------------------------------------------------------------------------
  # Elemento 94 (Indeniza√ß√µes e Restitui√ß√µes Trabalhistas)
  # Excluindo fontes vinculadas com termos de inativos
  
  `21  Indeniza√ß√µes por Demiss√£o e Incentivos` = list(
    criterio = "
    grupo_despesa_codigo_grupo == '1' &
    elemento_despesa_codigo == '94' &
    !(
      fonte_recursos_codigo %in% c('023', '024', '055', '056') &
      str_detect(natureza_despesa_detalhada_nome, 
                 'APOSENT|INAT|REFORMA|PEN|LEI 7\\\\.963/1989')
    )
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 22 - DECORRENTES DE DECIS√ÉO JUDICIAL
  # ---------------------------------------------------------------------------
  # Elemento 91 (Senten√ßas Judiciais)
  # Excluindo fontes vinculadas com termos de inativos
  
  `22  Decorrentes de Decis√£o Judicial` = list(
    criterio = "
    grupo_despesa_codigo_grupo == '1' &
    elemento_despesa_codigo == '91' &
    !(
      fonte_recursos_codigo %in% c('023', '024', '055', '056') &
      str_detect(natureza_despesa_detalhada_nome, 
                 'APOSENT|INAT|REFORMA|PEN|LEI 7\\\\.963/1989')
    )
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 23 - DESPESAS DE EXERC√çCIOS ANTERIORES
  # ---------------------------------------------------------------------------
  # Elemento 92 (Despesas de Exerc√≠cios Anteriores)
  # Excluindo fontes vinculadas com termos de inativos
  
  `23  Despesas de Exerc√≠cios Anteriores` = list(
    criterio = "
    grupo_despesa_codigo_grupo == '1' &
    elemento_despesa_codigo == '92' &
    !(
      fonte_recursos_codigo %in% c('023', '024', '055', '056') &
      str_detect(natureza_despesa_detalhada_nome, 
                 'APOSENT|INAT|REFORMA|PEN|LEI 7\\\\.963/1989')
    )
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 24 - INATIVOS E PENSIONISTAS COM RECURSOS VINCULADOS
  # ---------------------------------------------------------------------------
  # Fontes vinculadas (023, 024, 055, 056) com:
  #   - Elementos de aposentadoria/pens√£o
  #   - OU elementos diversos com termos de inativos
  
  `24  Inativos e Pensionistas com Recursos Vinculados` = list(
    criterio = "
    grupo_despesa_codigo_grupo == '1' &
    fonte_recursos_codigo %in% c('023', '024', '055', '056') &
    (
      elemento_despesa_codigo %in% c('01', '03') |
      (
        elemento_despesa_codigo %in% c('05', '08', '09', '17', '91', '92', '94') &
        str_detect(natureza_despesa_detalhada_nome, 
                   'APOSENT|INAT|REFORMA|PEN|LEI 7\\\\.963/1989')
      )
    )
    "
  )
)

cat("‚úÖ Crit√©rios RGF Anexo 01 definidos\n")
cat(sprintf("   Total de categorias: %d\n", length(criterios_rgf_A01_pessoal_rgf)))
```

## Aplica√ß√£o dos Crit√©rios

```{r aplicar-criterios-rgf-a01}
#| code-fold: true
#| code-summary: "Ver c√≥digo de aplica√ß√£o dos crit√©rios"

# =============================================================================
# APLICA√á√ÉO DOS CRIT√âRIOS DE DESPESA COM PESSOAL
# =============================================================================
# Item de Informa√ß√£o:
#   - 25 = Despesa Liquidada
#   - 27 = Restos a Pagar N√£o Processados (RPNP)
# =============================================================================

# -----------------------------------------------------------------------------
# 1. Despesa Liquidada (item 25)
# -----------------------------------------------------------------------------

pessoal <- aplicar_criterios(
  rgf_a01 %>% filter(item_informacao_codigo == "25"),
  criterios_rgf_A01_pessoal_rgf,
  group_vars = c("categoria_pessoal")
)

cat(sprintf("‚úÖ Despesa liquidada processada: %d registros\n", nrow(pessoal)))

# -----------------------------------------------------------------------------
# 2. Restos a Pagar N√£o Processados (item 27)
# -----------------------------------------------------------------------------

pessoal_rp <- aplicar_criterios(
  rgf_a01 %>% filter(item_informacao_codigo == "27"),
  criterios_rgf_A01_pessoal_rgf,
  group_vars = c("categoria_pessoal")
)

cat(sprintf("‚úÖ RPNP processado: %d registros\n", nrow(pessoal_rp)))

# -----------------------------------------------------------------------------
# 3. Categorias para exibi√ß√£o
# -----------------------------------------------------------------------------

# Categorias com despesa liquidada + RPNP
categorias <- c("AP", "DF", "RR", "executivo")

# Categorias apenas com despesa liquidada (sem RPNP)
categorias_rp <- c("DF", "executivo")
```

## Fun√ß√£o para Gera√ß√£o das Tabelas

```{r funcao-tabela-rgf-a01}
#| code-fold: true
#| code-summary: "Ver fun√ß√£o de gera√ß√£o de tabelas"

# =============================================================================
# FUN√á√ÉO: gerar_tabela_pessoal
# =============================================================================
# Gera uma tabela DT com os valores de despesa com pessoal, pivotada por m√™s,
# incluindo RPNP quando dispon√≠vel.
#
# Par√¢metros:
#   data_pessoal    - Dataframe com despesa liquidada (item 25)
#   data_pessoal_rp - Dataframe com RPNP (item 27)
#   categoria_filtro - Categoria a exibir: "executivo", "AP", "RR", "DF"
#   formato_numero  - Se TRUE, formata n√∫meros com separador de milhar
#
# Retorno:
#   Objeto datatable formatado
# =============================================================================

gerar_tabela_pessoal <- function(
  data_pessoal, 
  data_pessoal_rp, 
  categoria_filtro, 
  formato_numero = TRUE
) {
  
  # ---------------------------------------------------------------------------
  # 1. Preparar dados de pessoal (item 25 - Liquidado)
  # ---------------------------------------------------------------------------
  
  pessoal_prep <- data_pessoal %>% 
    filter(categoria_pessoal == categoria_filtro) %>% 
    mutate(
      # Formatar m√™s/ano em mai√∫sculas (ex: JAN/25)
      mes_ano = toupper(format(data_lancamento, "%b/%y")),
      tipo = "pessoal"
    )
  
  # ---------------------------------------------------------------------------
  # 2. Preparar dados de RPNP (item 27) - se existirem
  # ---------------------------------------------------------------------------
  
  rp_prep <- data_pessoal_rp %>% 
    filter(categoria_pessoal == categoria_filtro)
  
  if (nrow(rp_prep) > 0) {
    rp_prep <- rp_prep %>%
      mutate(
        mes_ano = "RPNP",  # Coluna fixa para RPNP
        tipo = "rp"
      )
  }
  
  # ---------------------------------------------------------------------------
  # 3. Combinar pessoal + RPNP
  # ---------------------------------------------------------------------------
  
  dados_combinados <- bind_rows(pessoal_prep, rp_prep)
  
  # ---------------------------------------------------------------------------
  # 4. Criar tabela pivotada
  # ---------------------------------------------------------------------------
  
  # Ordenar meses cronologicamente
  dados_combinados <- dados_combinados %>%
    arrange(data_lancamento) %>%
    mutate(mes_ano = factor(mes_ano, levels = unique(mes_ano)))
  
  # Pivotar: linhas = categoria, colunas = m√™s
  tabela <- dados_combinados %>% 
    group_by(mes_ano, categoria) %>% 
    summarise(valor = sum(valor / 1000), .groups = "drop") %>%  # Em milhares
    pivot_wider(
      names_from = mes_ano, 
      values_from = valor, 
      values_fill = 0
    )
  
  # ---------------------------------------------------------------------------
  # 5. Adicionar coluna de TOTAL (√∫ltimos 12 meses)
  # ---------------------------------------------------------------------------
  
  # Identificar colunas de meses (exceto categoria e RPNP)
  colunas_meses <- setdiff(names(tabela), c("categoria", "RPNP"))
  
  # Calcular total dos 12 meses
  tabela <- tabela %>%
    mutate(
      `TOTAL (√öLTIMOS 12 MESES)` = rowSums(
        select(., all_of(colunas_meses)), 
        na.rm = TRUE
      )
    )
  
  # Reordenar colunas: categoria, meses, total, RPNP
  if ("RPNP" %in% names(tabela)) {
    tabela <- tabela %>%
      select(categoria, all_of(colunas_meses), `TOTAL (√öLTIMOS 12 MESES)`, RPNP)
  } else {
    tabela <- tabela %>%
      select(categoria, all_of(colunas_meses), `TOTAL (√öLTIMOS 12 MESES)`)
  }
  
  # ---------------------------------------------------------------------------
  # 6. Criar DataTable
  # ---------------------------------------------------------------------------
  
  dt <- datatable(
    tabela,
    caption = paste("Despesa com Pessoal -", categoria_filtro, "(R$ milhares)"),
    rownames = FALSE,
    options = list(
      pageLength = -1,      # Mostrar todas as linhas
      scrollX = TRUE,       # Scroll horizontal
      dom = 'ft'            # Apenas filtro e tabela
    )
  )
  
  # ---------------------------------------------------------------------------
  # 7. Formatar n√∫meros
  # ---------------------------------------------------------------------------
  
  if (formato_numero) {
    colunas_numericas <- which(sapply(tabela, is.numeric))
    
    dt <- dt %>% 
      formatRound(
        columns = colunas_numericas, 
        digits = 0,           # Sem casas decimais
        mark = ".",           # Separador de milhar
        dec.mark = ","        # Separador decimal
      )
  }
  
  return(dt)
}
```

## Resultados

### Poder Executivo Federal

```{r resultado-executivo-rgf-a01}
#| code-fold: true
#| column: screen

gerar_tabela_pessoal(pessoal, pessoal_rp, "executivo")
```

### Amap√° (AP)

```{r resultado-ap-rgf-a01}
#| code-fold: true
#| column: screen

gerar_tabela_pessoal(pessoal, pessoal_rp, "AP")
```

### Roraima (RR)

```{r resultado-rr-rgf-a01}
#| code-fold: true
#| column: screen

gerar_tabela_pessoal(pessoal, pessoal_rp, "RR")
```

### Distrito Federal (DF)

```{r resultado-df-rgf-a01}
#| code-fold: true
#| column: screen

gerar_tabela_pessoal(pessoal, pessoal_rp, "DF")
```

## Notas Metodol√≥gicas

```{r notas-rgf-a01}
#| echo: false

# =============================================================================
# NOTAS METODOL√ìGICAS
# =============================================================================

notas <- tibble::tribble(
  ~Item, ~Descri√ß√£o,
  "1", "Valores em R$ milhares",
  "2", "Despesa Liquidada = Item de Informa√ß√£o 25",
  "3", "RPNP = Restos a Pagar N√£o Processados (Item 27)",
  "4", "Total 12 meses = Soma dos √∫ltimos 12 meses de despesa liquidada",
  "5", "Padr√µes de texto (APOSENT, INAT, etc.) usados para identificar despesas com inativos",
  "6", "Fontes vinculadas (023, 024, 055, 056) = Recursos previdenci√°rios"
)

knitr::kable(notas, col.names = c("Item", "Descri√ß√£o"))
```

## Observa√ß√µes Importantes

::: {.callout-warning}
### Falsos Positivos na Detec√ß√£o de Termos

O padr√£o `PEN` captura tanto **PENS√ïES** (correto) quanto termos como **COMPENSA√á√ïES** e **DEPEND√äNCIAS** (falsos positivos). Aten√ß√£o especial deve ser dada √† an√°lise de:

- REFORMA - pode capturar "REFORMA AGR√ÅRIA" (falso positivo)
- PEN - captura "COMPENSA√á√ïES" indevidamente
:::

::: {.callout-note}
### Filtros do Tesouro Gerencial

O Tesouro Gerencial usa o operador **"Cont√©m"** para detec√ß√£o de termos, que √© equivalente ao padr√£o sem word boundaries (`\\b`) em R. Isso pode gerar falsos positivos que devem ser tratados manualmente.
:::



# üìã RGF Anexo 02 - D√≠vida Consolidada L√≠quida {#sec-rgf-a02}

## Ficha T√©cnica

```{r ficha-tecnica-rgf-a02}
#| echo: false

# =============================================================================
# FICHA T√âCNICA DO ANEXO
# =============================================================================

ficha_tecnica <- tibble::tribble(
  ~Campo,                 ~Informa√ß√£o,
  "Relat√≥rio",            "RGF - Relat√≥rio de Gest√£o Fiscal",
  "Anexo",                "Anexo 02",
  "Nome",                 "Demonstrativo da D√≠vida Consolidada L√≠quida - DCL",
  "Base Legal",           "LRF Art. 55, inciso I, al√≠nea 'b'",
  "Periodicidade",        "Quadrimestral",
  "Grau de Dificuldade",  "‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Muito Dif√≠cil",
  "√öltima Atualiza√ß√£o",   format(Sys.Date(), "%d/%m/%Y")
)

knitr::kable(ficha_tecnica, col.names = c("Campo", "Informa√ß√£o"))
```

## Arquivos Necess√°rios

```{r arquivos-rgf-a02}
#| echo: false

# =============================================================================
# ARQUIVOS DO TESOURO GERENCIAL UTILIZADOS
# =============================================================================
# O Anexo 02 utiliza M√öLTIPLAS bases de dados com filtros espec√≠ficos

arquivos <- tibble::tribble(
  ~Arquivo,                                    ~Descri√ß√£o,                                    ~Filtros_TG,
  "rgf_a02_precatorios.xlsx",                  "Precat√≥rios posteriores a 05/05/2000",        "Or√ß. Fiscal, Contas espec√≠ficas",
  "rgf_a02_rp_exceto_170600.xlsx",             "RP processados (exceto UG 170600)",           "Contas espec√≠ficas, UG != 170600, A√ß√£o != 0005",
  "rgf_a02_rp_todas_ugs.xlsx",                 "RP processados (todas UGs)",                  "Contas espec√≠ficas, A√ß√£o != 0005",
  "rgf_a02_ug_170512.xlsx",                    "D√≠vida assumida e renegociada",               "Or√ß. Fiscal, UG = 170512",
  "rgf_a02_creditos_bancarios.xlsx",           "Cr√©ditos banc√°rios",                          "Or√ß. Fiscal, UG IN (170705, 170526, 170700)",
  "rgf_a02_entidade.xlsx",                     "D√≠vida mobili√°ria por entidade",              "Or√ß. Fiscal, Contas espec√≠ficas",
  "rgf_a02_aplicacao_titulos_publicos.xlsx",   "Aplica√ß√µes em t√≠tulos p√∫blicos",              "Or√ß. Fiscal, √ìrg√£o UGE != 25901, Tipo Admin IN (3,4,5,6,8)",
  "rgf_a02_balancete.xlsx",                    "Balancete geral (principal)",                 "Or√ß. Fiscal",
  "rgf_a02_balancete_fat.xlsx",                "Disponibilidades FAT",                        "Or√ß. Fiscal, UG = 380916",
  "rgf_a02_balancete_fundos.xlsx",             "Aplica√ß√µes em fundos (Tipo Admin 7)",         "Or√ß. Fiscal, √ìrg√£o != 25915,37904, Tipo Admin = 7",
  "rgf_a02_balancete_fundos_111215100.xlsx",   "Aplica√ß√µes em fundos (conta espec√≠fica)",     "Or√ß. Fiscal, √ìrg√£o != 25915,37904, Conta = 111215100",
  "rgf_a02_balancete_deducoes_depositos_a_vista.xlsx", "Dep√≥sitos √† vista (dedu√ß√µes)",        "Or√ß. Fiscal, √ìrg√£o != 25901, UG != 380916",
  "rgf_a02_dcl_passivo_atuarial.xlsx",         "Passivo atuarial (RPPS e militares)",         "Or√ß. Fiscal"
)

knitr::kable(arquivos, col.names = c("Arquivo", "Descri√ß√£o", "Filtros no TG"))
```

## Atributos Utilizados

```{r atributos-rgf-a02}
#| echo: false

# =============================================================================
# ATRIBUTOS (COLUNAS) DOS ARQUIVOS E SEUS USOS
# =============================================================================

atributos <- tibble::tribble(
  ~Atributo,                   ~Tipo,       ~Uso,                  ~Descri√ß√£o,
  "conta_contabil_numero",     "character", "TG / Crit√©rio",       "N√∫mero da conta cont√°bil (PCASP)",
  "conta_contabil_nome",       "character", "TG / Apresenta√ß√£o",   "Nome da conta cont√°bil",
  "entidade_c_cor_numero",     "character", "TG / Crit√©rio",       "C√≥digo da entidade/conta corrente",
  "entidade_c_cor_nome",       "character", "TG / Crit√©rio",       "Nome da entidade (para detec√ß√£o de padr√µes)",
  "conta_corrente",            "character", "TG / Crit√©rio",       "Conta corrente espec√≠fica",
  "acao_governo_codigo",       "character", "TG / Crit√©rio",       "C√≥digo da a√ß√£o de governo",
  "unidade_orcamentaria_codigo","character","TG / Crit√©rio",       "C√≥digo da UO",
  "ug_executora_codigo",       "character", "TG / Crit√©rio",       "C√≥digo da UG executora",
  "isf_lancamento",            "character", "TG / Crit√©rio",       "Indicador de Super√°vit Financeiro (P=Prim√°rio)",
  "c_con_subgrupo_3_nome",     "character", "TG / Crit√©rio",       "Nome do subgrupo cont√°bil",
  "mes_lancamento",            "numeric",   "TG / R",              "M√™s do lan√ßamento (YYYYMM)",
  "saldo_r_conta_contabil",    "numeric",   "TG / R",              "Saldo da conta cont√°bil",
  "data_lancamento",           "Date",      "R",                   "Data calculada do lan√ßamento"
)

knitr::kable(atributos, col.names = c("Atributo", "Tipo", "Uso", "Descri√ß√£o"))
```

## V√≠nculos com Outros Anexos

```{r vinculos-rgf-a02}
#| echo: false

# =============================================================================
# RELACIONAMENTO COM OUTROS ANEXOS
# =============================================================================

vinculos <- tibble::tribble(
  ~Anexo_Relacionado,   ~Tipo_V√≠nculo,    ~Descri√ß√£o,
  "RREO Anexo 03",      "Refer√™ncia",     "RCL utilizada para c√°lculo do limite da DCL",
  "RGF Anexo 05",       "Refer√™ncia",     "Disponibilidades para c√°lculo de liquidez",
  "RGF Anexo 06",       "Consolida√ß√£o",   "Valores consolidados no demonstrativo simplificado"
)

knitr::kable(vinculos, col.names = c("Anexo Relacionado", "Tipo de V√≠nculo", "Descri√ß√£o"))
```

## Estrutura do Demonstrativo

```{r estrutura-rgf-a02}
#| echo: false

# =============================================================================
# ESTRUTURA DO DEMONSTRATIVO - COMPONENTES DA DCL
# =============================================================================

estrutura <- tibble::tribble(
  ~Ordem, ~Item,                                           ~Sinal,
  "01",   "D√≠vida Mobili√°ria TN Interna",                   "+",
  "02",   "Aplica√ß√£o em T√≠tulos P√∫blicos (dedu√ß√£o)",        "-",
  "03",   "D√≠vida Mobili√°ria TN em BCB",                    "+",
  "04",   "D√≠vida Securitizada",                            "+",
  "05",   "D√≠vida Mobili√°ria Externa",                      "+",
  "06",   "Opera√ß√µes de Equaliza√ß√£o Cambial",               "+",
  "07",   "Demais D√≠vidas Contratuais",                     "+",
  "08",   "Precat√≥rios posteriores a 05/05/2000",           "+",
  "09",   "D√≠vida Assumida pela Uni√£o",                     "+",
  "10",   "Passivos por Insufici√™ncia de Recursos",         "+",
  "11",   "Dep√≥sitos do TN em BCB (dedu√ß√£o)",               "-",
  "12",   "Dep√≥sitos √† Vista (dedu√ß√£o)",                    "-",
  "13",   "Disponibilidades FAT (dedu√ß√£o)",                 "-",
  "14",   "Aplica√ß√µes em Fundos Diversos 1 (dedu√ß√£o)",      "-",
  "15",   "Aplica√ß√µes em Fundos Diversos 2 (dedu√ß√£o)",      "-",
  "16",   "Aplica√ß√µes em Fundos Diversos 3 (dedu√ß√£o)",      "-",
  "17",   "D√≠vidas Renegociadas (dedu√ß√£o)",                 "-",
  "18",   "Cr√©ditos Lei 8.727/93 (dedu√ß√£o)",                "-",
  "19",   "D√≠vida Externa Renegociada (dedu√ß√£o)",           "-",
  "20",   "Demais D√≠vidas Renegociadas (dedu√ß√£o)",          "-",
  "21",   "Ajustes para Perdas (positivo)",                 "+",
  "22",   "Outros Cr√©ditos Banc√°rios (dedu√ß√£o)",            "-",
  "23",   "Outros Cr√©ditos Banc√°rios - Ajustes",            "+",
  "24",   "Resultado Positivo TN/BCB (dedu√ß√£o)",            "-",
  "25",   "Restos a Pagar Processados",                     "+",
  "26",   "D√≠vida Mobili√°ria TN Interna INTRA (dedu√ß√£o)",   "-",
  "38",   "Precat√≥rios (ajuste s/ a√ß√µes 0005 e 0EC7)",      "-",
  "40",   "RPPS Civil (passivo atuarial)",                  "+",
  "41",   "Despesas Previdenci√°rias FCDF",                  "+",
  "42",   "Militares Inativos",                             "+",
  "43",   "Pens√µes Militares",                              "+"
)

knitr::kable(estrutura, col.names = c("Ordem", "Item", "Sinal"))
```

## Importa√ß√£o dos Dados

```{r importar-rgf-a02}
#| code-fold: true
#| code-summary: "Ver c√≥digo de importa√ß√£o"

# =============================================================================
# IMPORTA√á√ÉO DOS DADOS RGF ANEXO 02
# =============================================================================
# Este anexo utiliza M√öLTIPLAS bases de dados do Tesouro Gerencial.
# Cada arquivo tem filtros espec√≠ficos aplicados na extra√ß√£o.
# =============================================================================

cat("üì• Importando dados RGF Anexo 02 (DCL)...\n")

# -----------------------------------------------------------------------------
# Fun√ß√£o auxiliar para processar arquivos RGF A02
# -----------------------------------------------------------------------------

processar_arquivo_rgf_a02 <- function(file_path, skip_rows = 5) {
  
  # Ler arquivo Excel
  df <- read_excel(file_path, skip = skip_rows, col_types = "text") %>%
    clean_names()
  
  # Processar mes_lancamento se existir
  if ("mes_lancamento" %in% names(df)) {
    df <- df %>%
      mutate(
        mes_lancamento = as.numeric(mes_lancamento),
        data_lancamento = ceiling_date(
          ymd(paste0(mes_lancamento, "01")), 
          "month"
        ) - days(1)
      )
  }
  
  # Converter colunas num√©ricas automaticamente
  numeric_patterns <- c("^saldo_r", "^movim_liquido_r")
  cols_to_convert <- names(df)[str_detect(names(df), 
                                           paste(numeric_patterns, collapse = "|"))]
  
  for (col in cols_to_convert) {
    df <- df %>% mutate(!!sym(col) := as.numeric(!!sym(col)))
  }
  
  return(df)
}

# -----------------------------------------------------------------------------
# Listar e importar todos os arquivos rgf_a02_*.xlsx
# -----------------------------------------------------------------------------

arq_rgf_a02 <- list.files(
  path = mes_pasta,
  pattern = "^rgf_a02_.*\\.xlsx$",
  full.names = TRUE
)

cat(sprintf("   Encontrados %d arquivos\n", length(arq_rgf_a02)))

# Processar em paralelo
rgf_a02_list <- future_map(
  arq_rgf_a02,
  processar_arquivo_rgf_a02,
  .progress = TRUE,
  .options = furrr_options(seed = TRUE)
)

# Nomear os dataframes com base no nome do arquivo
names(rgf_a02_list) <- basename(arq_rgf_a02) %>% str_remove("\\.xlsx$")

# Colocar cada dataframe no ambiente global
list2env(rgf_a02_list, envir = .GlobalEnv)

cat(sprintf("‚úÖ RGF A02: %d arquivos importados\n", length(arq_rgf_a02)))

# Exibir resumo dos arquivos
cat("\nüìä Resumo dos arquivos importados:\n")
for (nome in names(rgf_a02_list)) {
  n_registros <- nrow(rgf_a02_list[[nome]])
  cat(sprintf("   ‚Ä¢ %s: %s registros\n", nome, 
              format(n_registros, big.mark = ".", decimal.mark = ",")))
}
```

## Crit√©rios de Classifica√ß√£o

### Base: Precat√≥rios

```{r criterios-precatorios}
#| code-fold: true
#| code-summary: "Ver crit√©rios - Precat√≥rios"

# =============================================================================
# BASE: rgf_a02_precatorios
# Filtros TG: Or√ßamento Fiscal, Contas espec√≠ficas
# =============================================================================

criterios_rgf_A02_dcl_precatorios <- list(
  
  # ---------------------------------------------------------------------------
  # 08 - PRECAT√ìRIOS POSTERIORES A 05/05/2000
  # ---------------------------------------------------------------------------
  # Inclui a√ß√µes de precat√≥rios, exceto conta 622130400
  # A√ß√£o 0Z01 apenas se UO = 71103
  
  `08 Precat√≥rios posteriores a 05/05/2000` = list(
    criterio = "
    conta_contabil_numero != c('622130400') &
    acao_governo_codigo %in% c('0005', '00U9', '00UP', '0EC8', '0EC7', '00WU') |
    (unidade_orcamentaria_codigo == '71103' & acao_governo_codigo == '0Z01')
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 38 - PRECAT√ìRIOS (AJUSTE SEM A√á√ïES 0005 e 0EC7)
  # ---------------------------------------------------------------------------
  # Conta espec√≠fica 622130400 com a√ß√µes 0005 e 0EC7
  
  `38 Precat√≥rios posteriores a 05/05/2000 sem a√ß√£o 0005 e 0EC7` = list(
    criterio = "
    conta_contabil_numero == c('622130400') & 
    acao_governo_codigo %in% c('0005', '0EC7') |
    (unidade_orcamentaria_codigo == '71103' & acao_governo_codigo == '0Z01')
    "
  )
)
```

### Base: Restos a Pagar

```{r criterios-rp}
#| code-fold: true
#| code-summary: "Ver crit√©rios - Restos a Pagar"

# =============================================================================
# BASE: rgf_a02_rp_exceto_170600
# Filtros TG: Contas espec√≠ficas, UG != 170600, A√ß√£o != 0005
# =============================================================================

criterios_rgf_A02_dcl_rp_exceto_170600 <- list(
  
  `25 Restos a pagar processados parte 1` = list(
    criterio = "TRUE"
  )
)

# =============================================================================
# BASE: rgf_a02_rp_todas_ugs
# Filtros TG: Contas espec√≠ficas, A√ß√£o != 0005
# =============================================================================

criterios_rgf_A02_dcl_rp_todas_ugs <- list(
  
  `25 Restos a pagar processados parte 2` = list(
    criterio = "TRUE"
  )
)
```

### Base: UG 170512 (STN)

```{r criterios-ug170512}
#| code-fold: true
#| code-summary: "Ver crit√©rios - UG 170512"

# =============================================================================
# BASE: rgf_a02_ug_170512
# Filtros TG: Or√ßamento Fiscal, UG = 170512 (Secretaria do Tesouro Nacional)
# =============================================================================

criterios_rgf_A02_dcl_ug_170512 <- list(
  
  # ---------------------------------------------------------------------------
  # 09 - D√çVIDA ASSUMIDA PELA UNI√ÉO
  # ---------------------------------------------------------------------------
  
  `09 D√≠vida assumida pela Uni√£o` = list(
    criterio = "
    conta_contabil_numero %in% c('218912600', '228911600', '227310401') &
    isf_lancamento == 'P' &
    conta_corrente != 'PF1705118'
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 17 - D√çVIDAS RENEGOCIADAS (DEDU√á√ÉO)
  # ---------------------------------------------------------------------------
  # Leis 9.496/97 e 2.185/2001
  
  `17 D√≠vidas renegociadas dedu√ß√£o` = list(
    criterio = "
    conta_contabil_numero %in% c(
      '121110301', '112410100', '121110318', '112410600', 
      '121140301', '121150301', '112440100', '112450100', 
      '121140318', '121150318', '112440600', '112450600', 
      '112410401', '112450401', '112440401', '121249818', 
      '113814200', '113844200', '113854200'
    ) &
    (entidade_c_cor_numero %in% c(
      'PF1705320', 'PF1705524', 'PF1705528', 'PF1705546', 
      'PF1705547', 'PF1705548', 'PF1705406', 'PF1705525', 
      'PF1705529', 'PF1705544', 'PF1705545'
    ) |
    grepl('9\\\\.496/97', entidade_c_cor_nome) |
    grepl('2\\\\.185/2001', entidade_c_cor_nome))
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 18 - CR√âDITOS LEI 8.727/93 (DEDU√á√ÉO)
  # ---------------------------------------------------------------------------
  
  `18 Cr√©ditos Lei 8.727/93 dedu√ß√£o` = list(
    criterio = "
    conta_contabil_numero %in% c(
      '121110301', '112410100', '121110318', '112410600', 
      '121140301', '121150301', '112440100', '112450100', 
      '121140318', '121150318', '112440600', '112450600', 
      '112410401', '121219818', '112450401', '112440401', 
      '121249818', '113814200', '113844200', '113854200'
    ) &
    (entidade_c_cor_numero %in% c('PF1705109', 'PF1705536', 'TN0000016', 'TN0000017') |
     grepl('8\\\\.727/93', entidade_c_cor_nome))
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 19 - D√çVIDA EXTERNA RENEGOCIADA (DEDU√á√ÉO)
  # ---------------------------------------------------------------------------
  
  `19 D√≠vida externa renegociada dedu√ß√£o` = list(
    criterio = "
    conta_contabil_numero %in% c(
      '121110301', '112410100', '121110318', '112410600', 
      '121140301', '121150301', '112440100', '112450100', 
      '121140318', '121150318', '112440600', '112450600', 
      '112410401', '121219818', '112450401', '112440401', 
      '121249818', '113844200', '113814200', '113854200', 
      '121259818'
    ) &
    (entidade_c_cor_numero %in% c(
      'PF1705104', 'PF1705114', 'PF1705117', 'PF1705521', 
      'PF1705534', 'PF1705116', 'PF1705531', 'PF1705532', 
      'PF1705113', 'PF1701536', 'PF1705520', 'PF1705533', 
      'PF1705464', 'PF1705534', 'PF1705119', 'PF1705384'
    ) |
    grepl('DMLP', entidade_c_cor_nome) |
    grepl('FRANCA|FRAN√áA', entidade_c_cor_nome) |
    grepl('EXTER', entidade_c_cor_nome) |
    grepl('MF 030', entidade_c_cor_nome) |
    grepl('BIB', entidade_c_cor_nome))
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 20 - DEMAIS D√çVIDAS RENEGOCIADAS (DEDU√á√ÉO)
  # ---------------------------------------------------------------------------
  
  `20 Demais d√≠vidas renegociadas dedu√ß√£o` = list(
    criterio = "
    conta_contabil_numero %in% c(
      '121110301', '112410100', '121110318', '112410600', 
      '121140301', '121150301', '112440100', '112450100', 
      '121140318', '121150318', '112440600', '112450600', 
      '112410401', '112450401', '112440401', '121249818', 
      '113844200', '113814200', '113854200', '121259818'
    )
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 21 - AJUSTES PARA PERDAS (POSITIVO)
  # ---------------------------------------------------------------------------
  
  `21 Ajustes para perdas (positivo)` = list(
    criterio = "
    conta_contabil_numero %in% c(
      '112940401', '112950401', '113940101', '112910401', 
      '113950101', '121119902', '121149904', '121159904', 
      '121119904', '121249903', '121259903'
    )
    "
  )
)
```

### Base: Cr√©ditos Banc√°rios

```{r criterios-creditos-bancarios}
#| code-fold: true
#| code-summary: "Ver crit√©rios - Cr√©ditos Banc√°rios"

# =============================================================================
# BASE: rgf_a02_creditos_bancarios
# Filtros TG: Or√ßamento Fiscal, UG IN (170705, 170526, 170700)
# =============================================================================

criterios_rgf_A02_dcl_creditos_bancarios <- list(
  
  # ---------------------------------------------------------------------------
  # 22 - OUTROS CR√âDITOS BANC√ÅRIOS (DEDU√á√ÉO)
  # ---------------------------------------------------------------------------
  
  `22 Outros cr√©ditos banc√°rios dedu√ß√£o` = list(
    criterio = "
    conta_contabil_numero %in% c(
      '112410301', '112410303', '112440301', '112450301', 
      '112440303', '112450303', '112410100', '121110301', 
      '121110314', '121110308', '121140301', '121150301', 
      '121140308', '121150308', '112411300', '121110316', 
      '121110320', '112410302', '112410304', '112410201', 
      '112410203', '112410403', '121110312'
    )
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 23 - OUTROS CR√âDITOS BANC√ÅRIOS - AJUSTES (POSITIVO)
  # ---------------------------------------------------------------------------
  
  `23 Outros cr√©ditos banc√°rios ajustes (positivo)` = list(
    criterio = "
    conta_contabil_numero %in% c('112910401', '121119904', '121119907', '112910403')
    "
  )
)
```

### Base: Entidade (D√≠vida Mobili√°ria)

```{r criterios-entidade}
#| code-fold: true
#| code-summary: "Ver crit√©rios - Entidade"

# =============================================================================
# BASE: rgf_a02_entidade
# Filtros TG: Or√ßamento Fiscal, Contas espec√≠ficas
# =============================================================================

criterios_rgf_A02_dcl_entidade <- list(
  
  # ---------------------------------------------------------------------------
  # 01 - D√çVIDA MOBILI√ÅRIA TN INTERNA
  # ---------------------------------------------------------------------------
  # T√≠tulos p√∫blicos federais (LTN, LFT, NTN-B, NTN-F, etc.)
  
  `01 D√≠vida mobili√°ria TN interna` = list(
    criterio = "
    conta_contabil_numero %in% c(
      '899913900', '899913901', '899913902', '899913903', 
      '899913904', '899913905', '899913906'
    ) &
    entidade_c_cor_numero %in% c(
      'DP1000001', 'DP1400001', 'DP1500001', 'DP1700001', 
      'DP1800001', 'DP2000001', 'DP2300007', 'DP2400001', 
      'DP2600001', 'DP2800001', 'DP3000001', 'DP3400001', 
      'DP5000001', 'DP5500001', 'DP5800001', 'DP6100001', 
      'DP6200001', 'DP6300001', 'DP6600001', 'DP7000001', 
      'DP8000001', 'DP9000001', 'DP9102001', 'DP1200001'
    )
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 03 - D√çVIDA MOBILI√ÅRIA TN EM BCB
  # ---------------------------------------------------------------------------
  # T√≠tulos em carteira do Banco Central
  
  `03 D√≠vida mobili√°ria do TN (em BCB)` = list(
    criterio = "
    conta_contabil_numero %in% c('899913901', '899913902', '899913907', '899913908') &
    entidade_c_cor_numero %in% c(
      'DP1500010', 'DP1700010', 'DP1800010', 'DP2300010', 
      'DP5500010', 'DP7000010', 'DP9000010', 'DP3201450'
    )
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 04 - D√çVIDA SECURITIZADA
  # ---------------------------------------------------------------------------
  # T√≠tulos de securitiza√ß√£o e TDA
  
  `04 D√≠vida securitizada` = list(
    criterio = "
    (conta_contabil_numero %in% c(
      '899913900', '899913901', '899913902', '899913903', 
      '899913904', '899913905', '899913906'
    ) &
    entidade_c_cor_numero %in% c(
      'DP3100001', 'DP3200001', 'DP3200002', 'DP3201031', 
      'DP3201032', 'DP3201059', 'DP3201077', 'DP3201078', 
      'DP3201080', 'DP3201081', 'DP3201145', 'DP3201202', 
      'DP3201222', 'DP3201228', 'DP3201233', 'DP3201250', 
      'DP3201256', 'DP3201257', 'DP3201258', 'DP3201259', 
      'DP3201260', 'DP3201262', 'DP3201271', 'DP3201272', 
      'DP3201275', 'DP3201276', 'DP3201277', 'DP3201280', 
      'DP3201281', 'DP3201296', 'DP3201299', 'DP3201362', 
      'DP3201368', 'DP3201378', 'DP3201390'
    )) |
    conta_contabil_numero %in% c('212110202', '222110102')
    "
  )
)
```

### Base: Aplica√ß√£o em T√≠tulos P√∫blicos

```{r criterios-aplicacao-titulos}
#| code-fold: true
#| code-summary: "Ver crit√©rios - Aplica√ß√£o em T√≠tulos"

# =============================================================================
# BASE: rgf_a02_aplicacao_titulos_publicos
# Filtros TG: Or√ßamento Fiscal, √ìrg√£o UGE != 25901,
#             Tipo Admin IN (3,4,5,6,8), Conta come√ßa com 1111150
# =============================================================================

criterios_rgf_A02_dcl_aplicacao_titulos_publicos <- list(
  
  # ---------------------------------------------------------------------------
  # 02 - APLICA√á√ÉO EM T√çTULOS P√öBLICOS (DEDU√á√ÉO)
  # ---------------------------------------------------------------------------
  # Exclui contas espec√≠ficas que n√£o devem ser deduzidas
  
  `02 Aplica√ß√£o em t√≠tulos p√∫blicos` = list(
    criterio = "
    !conta_contabil_numero %in% c('111115005', '111115011', '111115012')
    "
  )
)
```

### Base: Balancete (Principal)

```{r criterios-balancete}
#| code-fold: true
#| code-summary: "Ver crit√©rios - Balancete"

# =============================================================================
# BASE: rgf_a02_balancete (renomeado de rgf_a02_balancete)
# Filtros TG: Or√ßamento Fiscal
# NOTA: Esta base √© usada em diversos anexos al√©m do RGF A02
# =============================================================================

criterios_rgf_A02_dcl_balancete <- list(
  
  # ---------------------------------------------------------------------------
  # 05 - D√çVIDA MOBILI√ÅRIA EXTERNA
  # ---------------------------------------------------------------------------
  
  `05 D√≠vida mobili√°ria externa` = list(
    criterio = "
    conta_contabil_numero %in% c('899913903', '899913904')
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 06 - OPERA√á√ïES DE EQUALIZA√á√ÉO CAMBIAL
  # ---------------------------------------------------------------------------
  
  `06 Opera√ß√µes de equaliza√ß√£o cambial` = list(
    criterio = "
    conta_contabil_numero %in% c('218912902', '218942902', '218952902', '218912901')
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 07 - DEMAIS D√çVIDAS CONTRATUAIS
  # ---------------------------------------------------------------------------
  
  `07 Demais d√≠vidas contratuais` = list(
    criterio = "
    isf_lancamento == 'P' &
    conta_contabil_numero %in% c(
      '222210200', '212210300', '222110200', '212110301', '212110303', '212510103',
      '212140303', '212150303', '212540103', '212550103', '212140301', '212150301',
      '217310301', '217310602', '217350402', '227310301', '212110700', '212210601',
      '212310201', '212310202', '212410201', '222310101', '222310102', '222410101',
      '217710101', '227710101', '227310401'
    )
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 10 - PASSIVOS POR INSUFICI√äNCIA DE RECURSOS
  # ---------------------------------------------------------------------------
  
  `10 Passivos por insufici√™ncia de recursos` = list(
    criterio = "
    conta_contabil_numero %in% c(
      '213110400', '211110101', '214419800', '223110100', 
      '211210100', '213140400', '213150400', 
      '214119900', '211459800', '211419800'
    ) &
    isf_lancamento == 'P'
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 11 - DEP√ìSITOS DO TN EM BCB (DEDU√á√ÉO)
  # ---------------------------------------------------------------------------
  
  `11 Dep√≥sitos do TN (em BCB) dedu√ß√£o` = list(
    criterio = "
    startsWith(conta_contabil_numero, '1111102') |
    startsWith(conta_contabil_numero, '1111103') |
    startsWith(conta_contabil_numero, '1111104')
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 12 - DEP√ìSITOS √Ä VISTA (DEDU√á√ÉO) - PARTE 1
  # ---------------------------------------------------------------------------
  
  `12 Dep√≥sitos √† vista dedu√ß√£o` = list(
    criterio = "
    startsWith(conta_contabil_numero, '1112102') |
    startsWith(conta_contabil_numero, '1112103') |
    startsWith(conta_contabil_numero, '1112150') |
    startsWith(conta_contabil_numero, '1112152')
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 24 - RESULTADO POSITIVO TN/BCB (DEDU√á√ÉO)
  # ---------------------------------------------------------------------------
  
  `24 Resultado positivo TN/BCB dedu√ß√£o` = list(
    criterio = "
    conta_contabil_numero %in% c('113813001', '113813002')
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 26 - D√çVIDA MOBILI√ÅRIA TN INTERNA INTRA (DEDU√á√ÉO)
  # ---------------------------------------------------------------------------
  
  `26 D√≠vida mobili√°ria TN interna (intra) dedu√ß√£o` = list(
    criterio = "
    conta_contabil_numero == '222120101'
    "
  )
)
```

### Base: Balancete FAT

```{r criterios-balancete-fat}
#| code-fold: true
#| code-summary: "Ver crit√©rios - Balancete FAT"

# =============================================================================
# BASE: rgf_a02_balancete_fat
# Filtros TG: Or√ßamento Fiscal, UG = 380916
# =============================================================================

criterios_rgf_A02_dcl_balancete_fat <- list(
  
  # ---------------------------------------------------------------------------
  # 13 - DISPONIBILIDADES FAT (DEDU√á√ÉO)
  # ---------------------------------------------------------------------------
  
  `13 Disponibilidade FAT dedu√ß√£o` = list(
    criterio = "
    startsWith(conta_contabil_numero, '1111119') |
    startsWith(conta_contabil_numero, '1124103') |
    startsWith(conta_contabil_numero, '1135407') |
    startsWith(conta_contabil_numero, '1135113') |
    startsWith(conta_contabil_numero, '1135115') |
    startsWith(conta_contabil_numero, '1124101') |
    startsWith(conta_contabil_numero, '1135111') |
    startsWith(conta_contabil_numero, '1135107') |
    startsWith(conta_contabil_numero, '11121') |
    startsWith(conta_contabil_numero, '1135114') |
    startsWith(conta_contabil_numero, '1135112') |
    startsWith(conta_contabil_numero, '1135116') |
    startsWith(conta_contabil_numero, '1211503') |
    startsWith(conta_contabil_numero, '1211403') |
    startsWith(conta_contabil_numero, '1211103') |
    startsWith(conta_contabil_numero, '1135507') |
    startsWith(conta_contabil_numero, '1212105') |
    conta_contabil_numero %in% c(
      '111115009', '111115011', '111115014', 
      '111115015', '111115016', '111115006'
    )
    "
  )
)
```

### Base: Balancete Fundos

```{r criterios-balancete-fundos}
#| code-fold: true
#| code-summary: "Ver crit√©rios - Balancete Fundos"

# =============================================================================
# BASE: rgf_a02_balancete_fundos_111215100
# Filtros TG: Or√ßamento Fiscal, √ìrg√£o != 25915,37904, Conta = 111215100
# =============================================================================

criterios_rgf_A02_dcl_balancete_fundos_111215100 <- list(
  
  `14 Aplica√ß√µes em fundos diversos 1 dedu√ß√£o` = list(
    criterio = "TRUE"
  )
)

# =============================================================================
# BASE: rgf_a02_balancete_fundos
# Filtros TG: Or√ßamento Fiscal, √ìrg√£o != 25915,37904, Tipo Admin = 7
# =============================================================================

criterios_rgf_A02_dcl_balancete_fundos <- list(
  
  # ---------------------------------------------------------------------------
  # 15 - APLICA√á√ïES EM FUNDOS DIVERSOS 2 (DEDU√á√ÉO)
  # ---------------------------------------------------------------------------
  
  `15 Aplica√ß√µes em fundos diversos 2 dedu√ß√£o` = list(
    criterio = "
    startsWith(conta_contabil_numero, '23')
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 16 - APLICA√á√ïES EM FUNDOS DIVERSOS 3 (DEDU√á√ÉO)
  # ---------------------------------------------------------------------------
  
  `16 Aplica√ß√µes em fundos diversos 3 dedu√ß√£o` = list(
    criterio = "
    startsWith(conta_contabil_numero, '1111102') |
    startsWith(conta_contabil_numero, '1111103') |
    startsWith(conta_contabil_numero, '1111104') |
    startsWith(conta_contabil_numero, '1111119') |
    conta_contabil_numero %in% c('111210200', '111210300', '111215000', '111215200') |
    (startsWith(conta_contabil_numero, '1111102') & ug_executora_codigo != '380916') |
    c_con_subgrupo_3_nome %in% c('INVESTIMENTOS', 'IMOBILIZADO', 'INTANGIVEL', 'DIFERIDO')
    "
  )
)

# =============================================================================
# BASE: rgf_a02_balancete_deducoes_depositos_a_vista
# Filtros TG: Or√ßamento Fiscal, √ìrg√£o != 25901, UG != 380916
# =============================================================================

criterios_rgf_A02_dcl_balancete_deducoes_depositos_a_vista <- list(
  
  `12 Dep√≥sitos √† vista dedu√ß√£o` = list(
    criterio = "
    startsWith(conta_contabil_numero, '1111119')
    "
  )
)
```

### Base: Passivo Atuarial

```{r criterios-passivo-atuarial}
#| code-fold: true
#| code-summary: "Ver crit√©rios - Passivo Atuarial"

# =============================================================================
# BASE: rgf_a02_dcl_passivo_atuarial
# Filtros TG: Or√ßamento Fiscal
# =============================================================================

criterios_rgf_A02_dcl_passivo_atuarial <- list(
  
  # ---------------------------------------------------------------------------
  # 40 - RPPS CIVIL
  # ---------------------------------------------------------------------------
  
  `40 RPPS civil` = list(
    criterio = "
    ug_executora_codigo == '400043' &
    conta_contabil_numero %in% c(
      '217919900', '227210301', '227210303', '227210304', 
      '227210401', '227210402', '227210403', '227210404'
    )
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 41 - DESPESAS PREVIDENCI√ÅRIAS DO FCDF
  # ---------------------------------------------------------------------------
  
  `41 Despesas previdenci√°rias do FCDF` = list(
    criterio = "
    ug_executora_codigo == '170392' &
    conta_contabil_numero %in% c(
      '217919900', '227210301', '227210303', '227210304', 
      '227210401', '227210402', '227210403', '227210404'
    )
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 42 - MILITARES INATIVOS
  # ---------------------------------------------------------------------------
  
  `42 Militares inativos` = list(
    criterio = "
    ug_executora_codigo %in% c('120052', '160063', '773200') &
    conta_contabil_numero %in% c('217910700', '227910700')
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 43 - PENS√ïES MILITARES
  # ---------------------------------------------------------------------------
  
  `43 Pens√µes militares` = list(
    criterio = "
    ug_executora_codigo %in% c('120052', '160063', '773200') &
    conta_contabil_numero %in% c('217910600', '227910600')
    "
  )
)
```

## Aplica√ß√£o dos Crit√©rios

```{r aplicar-criterios-rgf-a02}
#| code-fold: true
#| code-summary: "Ver c√≥digo de aplica√ß√£o dos crit√©rios"

# =============================================================================
# PROCESSAMENTO DOS CRIT√âRIOS DCL
# =============================================================================
# Cada base de dados tem seus crit√©rios aplicados separadamente
# =============================================================================

cat("üìä Processando crit√©rios do RGF Anexo 02...\n")

# -----------------------------------------------------------------------------
# 1. Precat√≥rios
# -----------------------------------------------------------------------------

df_criterios_rgf_A02_dcl_precatorios <- aplicar_criterios(
  df = rgf_a02_precatorios,
  criterios = criterios_rgf_A02_dcl_precatorios
)

cat("‚úÖ Precat√≥rios processados\n")

# -----------------------------------------------------------------------------
# 2. Restos a Pagar (duas bases)
# -----------------------------------------------------------------------------

df_criterios_rgf_A02_dcl_rp_exceto_170600 <- aplicar_criterios(
  df = rgf_a02_rp_exceto_170600,
  criterios = criterios_rgf_A02_dcl_rp_exceto_170600
)

df_criterios_rgf_A02_dcl_rp_todas_ugs <- aplicar_criterios(
  df = rgf_a02_rp_todas_ugs,
  criterios = criterios_rgf_A02_dcl_rp_todas_ugs
)

cat("‚úÖ Restos a Pagar processados\n")

# -----------------------------------------------------------------------------
# 3. UG 170512 (STN)
# -----------------------------------------------------------------------------

df_criterios_rgf_A02_dcl_ug_170512 <- aplicar_criterios(
  df = rgf_a02_ug_170512,
  criterios = criterios_rgf_A02_dcl_ug_170512
)

cat("‚úÖ UG 170512 processada\n")

# -----------------------------------------------------------------------------
# 4. Cr√©ditos Banc√°rios
# -----------------------------------------------------------------------------

df_criterios_rgf_A02_dcl_creditos_bancarios <- aplicar_criterios(
  df = rgf_a02_creditos_bancarios,
  criterios = criterios_rgf_A02_dcl_creditos_bancarios
)

cat("‚úÖ Cr√©ditos banc√°rios processados\n")

# -----------------------------------------------------------------------------
# 5. Entidade (D√≠vida Mobili√°ria)
# -----------------------------------------------------------------------------

df_criterios_rgf_A02_dcl_entidade <- aplicar_criterios(
  df = rgf_a02_entidade,
  criterios = criterios_rgf_A02_dcl_entidade
)

cat("‚úÖ Entidade processada\n")

# -----------------------------------------------------------------------------
# 6. Balancete (Principal)
# -----------------------------------------------------------------------------

df_criterios_rgf_A02_dcl_balancete <- aplicar_criterios(
  df = rgf_a02_balancete,
  criterios = criterios_rgf_A02_dcl_balancete
)

cat("‚úÖ Balancete processado\n")

# -----------------------------------------------------------------------------
# 7. Aplica√ß√£o em T√≠tulos P√∫blicos
# -----------------------------------------------------------------------------

df_criterios_rgf_A02_dcl_aplicacao_titulos_publicos <- aplicar_criterios(
  df = rgf_a02_aplicacao_titulos_publicos,
  criterios = criterios_rgf_A02_dcl_aplicacao_titulos_publicos
)

cat("‚úÖ Aplica√ß√£o em t√≠tulos processada\n")

# -----------------------------------------------------------------------------
# 8. Balancete FAT
# -----------------------------------------------------------------------------

df_criterios_rgf_A02_dcl_balancete_fat <- aplicar_criterios(
  df = rgf_a02_balancete_fat,
  criterios = criterios_rgf_A02_dcl_balancete_fat
)

cat("‚úÖ Balancete FAT processado\n")

# -----------------------------------------------------------------------------
# 9. Balancete Fundos (duas bases)
# -----------------------------------------------------------------------------

df_criterios_rgf_A02_dcl_balancete_fundos_111215100 <- aplicar_criterios(
  df = rgf_a02_balancete_fundos_111215100,
  criterios = criterios_rgf_A02_dcl_balancete_fundos_111215100
)

df_criterios_rgf_A02_dcl_balancete_fundos <- aplicar_criterios(
  df = rgf_a02_balancete_fundos,
  criterios = criterios_rgf_A02_dcl_balancete_fundos
)

cat("‚úÖ Balancete Fundos processado\n")

# -----------------------------------------------------------------------------
# 10. Dep√≥sitos √† Vista (dedu√ß√µes)
# -----------------------------------------------------------------------------

df_criterios_rgf_A02_dcl_balancete_deducoes_depositos_a_vista <- aplicar_criterios(
  df = rgf_a02_balancete_deducoes_depositos_a_vista,
  criterios = criterios_rgf_A02_dcl_balancete_deducoes_depositos_a_vista
)

cat("‚úÖ Dep√≥sitos √† vista processados\n")

# -----------------------------------------------------------------------------
# 11. Passivo Atuarial
# -----------------------------------------------------------------------------

df_criterios_rgf_A02_dcl_passivo_atuarial <- aplicar_criterios(
  df = rgf_a02_dcl_passivo_atuarial,
  criterios = criterios_rgf_A02_dcl_passivo_atuarial
)

cat("‚úÖ Passivo atuarial processado\n")
```

## Consolida√ß√£o dos Resultados

```{r consolidar-rgf-a02}
#| code-fold: true
#| code-summary: "Ver c√≥digo de consolida√ß√£o"

# =============================================================================
# CONSOLIDA√á√ÉO DOS RESULTADOS
# =============================================================================

# -----------------------------------------------------------------------------
# 1. Consolidar Restos a Pagar (partes 1 e 2)
# -----------------------------------------------------------------------------

df_criterios_rgf_A02_dcl_rp <- bind_rows(
  df_criterios_rgf_A02_dcl_rp_exceto_170600,
  df_criterios_rgf_A02_dcl_rp_todas_ugs
) %>%
  mutate(
    nome = str_replace(nome, " parte [12]$", "")
  ) %>%
  group_by(mes_lancamento, dataframe_nome, dataframe_filtros, relatorio, 
           anexo_codigo, anexo_nome, detalhe, print, filtro, metrica, 
           ordem, nome) %>%
  summarise(valor = sum(valor, na.rm = TRUE), .groups = "drop")

# -----------------------------------------------------------------------------
# 2. Consolidar Dep√≥sitos √† Vista (partes 1 e 2)
# -----------------------------------------------------------------------------

df_criterios_rgf_A02_dcl_depositos_vista <- bind_rows(
  df_criterios_rgf_A02_dcl_balancete_deducoes_depositos_a_vista,
  df_criterios_rgf_A02_dcl_balancete %>% 
    filter(str_detect(nome, "^12 "))
) %>%
  mutate(
    nome = str_replace(nome, " parte [12]$", "")
  ) %>%
  group_by(mes_lancamento, dataframe_nome, dataframe_filtros, relatorio, 
           anexo_codigo, anexo_nome, detalhe, print, filtro, metrica, 
           ordem, nome) %>%
  summarise(valor = sum(valor, na.rm = TRUE), .groups = "drop")

# -----------------------------------------------------------------------------
# 3. Consolidar TODOS os resultados
# -----------------------------------------------------------------------------

df_rgf_A02_dcl_consolidado <- bind_rows(
  df_criterios_rgf_A02_dcl_precatorios,
  df_criterios_rgf_A02_dcl_rp,
  df_criterios_rgf_A02_dcl_ug_170512,
  df_criterios_rgf_A02_dcl_creditos_bancarios,
  df_criterios_rgf_A02_dcl_entidade,
  df_criterios_rgf_A02_dcl_balancete %>% 
    filter(!str_detect(nome, "^12 ")),
  df_criterios_rgf_A02_dcl_aplicacao_titulos_publicos,
  df_criterios_rgf_A02_dcl_balancete_fat,
  df_criterios_rgf_A02_dcl_balancete_fundos_111215100,
  df_criterios_rgf_A02_dcl_balancete_fundos,
  df_criterios_rgf_A02_dcl_depositos_vista,
  df_criterios_rgf_A02_dcl_passivo_atuarial
) %>%
  arrange(mes_lancamento, ordem)

cat(sprintf("‚úÖ Consolida√ß√£o conclu√≠da: %d linhas\n", nrow(df_rgf_A02_dcl_consolidado)))
```

## Ajuste de Sinais

```{r ajuste-sinais-rgf-a02}
#| code-fold: true
#| code-summary: "Ver c√≥digo de ajuste de sinais"

# =============================================================================
# AJUSTE DE SINAIS PARA C√ÅLCULO DA DCL
# =============================================================================
# Algumas linhas s√£o DEDU√á√ïES e devem ter sinal invertido
# =============================================================================

valores_linhas <- df_rgf_A02_dcl_consolidado %>%
  group_by(ordem, nome) %>%
  summarise(
    valor_total = sum(valor, na.rm = TRUE),
    valor_absoluto = sum(abs(valor), na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(ordem)

# Aplicar sinais (linhas de dedu√ß√£o ficam negativas)
valores_linhas <- valores_linhas %>% 
  mutate(
    valor = case_when(
      # Linhas que devem ser subtra√≠das (dedu√ß√µes)
      ordem %in% c("02", "25", "26", "38", "16") ~ -valor_total,
      # Demais linhas mant√™m sinal original
      .default = valor_total
    )
  )

# =============================================================================
# C√ÅLCULO DO VALOR DA DCL (NUM√âRICO)
# =============================================================================
# Esta vari√°vel √© utilizada em outros anexos (RREO A06, RGF A06)
# F√≥rmula: D√≠vida Consolidada Bruta - Dedu√ß√µes
# =============================================================================

valor_dcl_num <- (valores_linhas %>% 
  filter(ordem %in% c("01", "02", "03", "04", "05", "26", 
                      "06", "07", "08", "09", "10", "38")) %>% 
  summarise(valor = sum(valor, na.rm = TRUE)))$valor - 
  (valores_linhas %>% 
  filter(ordem %in% c("11", "12", "14", "15", "16", 
                      "20", "21", "22", "23", "25")) %>% 
  summarise(valor = sum(valor, na.rm = TRUE)))$valor

# Valor formatado para exibi√ß√£o
valor_dcl <- formatar_numero(valor_dcl_num)

cat(sprintf("‚úÖ DCL calculada: R$ %s\n", valor_dcl))
```

## Resultados

```{r resultado-rgf-a02}
#| code-fold: true
#| column: page

# =============================================================================
# EXIBIR RESULTADOS
# =============================================================================

datatable(
  valores_linhas,
  caption = "RGF Anexo 02 - Componentes da DCL",
  rownames = FALSE,
  options = list(
    pageLength = -1,
    scrollX = TRUE,
    lengthMenu = list(c(10, 25, 50, -1), c('10', '25', '50', 'Todas'))
  )
) %>% 
  formatRound(c("valor_total", "valor_absoluto", "valor"), 2, mark = ".", dec.mark = ",")
```

## C√°lculos da DCL

```{r calculos-dcl}
#| code-fold: true
#| code-summary: "Ver c√°lculos da DCL"

# =============================================================================
# C√ÅLCULOS AGREGADOS DA DCL
# =============================================================================

# D√≠vida Mobili√°ria = 01 + 02 + 03 + 04 + 05 + 26
divida_mobiliaria <- valores_linhas %>% 
  filter(ordem %in% c("01", "02", "03", "04", "05", "26")) %>% 
  summarise(valor = sum(valor, na.rm = TRUE)) %>%
  pull(valor)

# D√≠vida Consolidada = D√≠vida Mobili√°ria + 06 + 07 + 08 + 09 + 10 + 38
divida_consolidada <- valores_linhas %>% 
  filter(ordem %in% c("01", "02", "03", "04", "05", "26", "06", "07", "08", "09", "10", "38")) %>% 
  summarise(valor = sum(valor, na.rm = TRUE)) %>%
  pull(valor)

# Precat√≥rios (08 + 38)
precatorios <- valores_linhas %>% 
  filter(ordem %in% c("08", "38")) %>% 
  summarise(valor = sum(valor, na.rm = TRUE)) %>%
  pull(valor)

# Dedu√ß√µes TN/BCB (11 + 12)
deducoes_tn_bcb <- valores_linhas %>% 
  filter(ordem %in% c("11", "12")) %>% 
  summarise(valor = sum(valor, na.rm = TRUE)) %>%
  pull(valor)

# Exibir resumo
cat("\nüìä RESUMO DA DCL\n")
cat("================\n")
cat(sprintf("D√≠vida Mobili√°ria:   R$ %s\n", formatar_numero(divida_mobiliaria)))
cat(sprintf("D√≠vida Consolidada:  R$ %s\n", formatar_numero(divida_consolidada)))
cat(sprintf("Precat√≥rios:         R$ %s\n", formatar_numero(precatorios)))
cat(sprintf("Dedu√ß√µes TN/BCB:     R$ %s\n", formatar_numero(deducoes_tn_bcb)))
cat(sprintf("DCL (valor_dcl_num): R$ %s\n", valor_dcl))
```

## Notas Metodol√≥gicas

```{r notas-rgf-a02}
#| echo: false

# =============================================================================
# NOTAS METODOL√ìGICAS
# =============================================================================

notas <- tibble::tribble(
  ~Item, ~Descri√ß√£o,
  "1", "Valores em R$ (reais)",
  "2", "ISF = P indica item Prim√°rio (relevante para DCL)",
  "3", "Linhas de dedu√ß√£o (-) s√£o subtra√≠das da d√≠vida bruta",
  "4", "RP Processados consolida dados de duas bases (exceto 170600 + todas UGs)",
  "5", "Dep√≥sitos √† vista consolida dados do balancete geral + base espec√≠fica",
  "6", "Passivo atuarial inclui RPPS civil, FCDF e militares",
  "7", "D√≠vida mobili√°ria inclui todos os t√≠tulos p√∫blicos federais"
)

knitr::kable(notas, col.names = c("Item", "Descri√ß√£o"))
```

## Observa√ß√µes Importantes

::: {.callout-warning}
### Complexidade do Anexo

O RGF Anexo 02 √© o demonstrativo mais complexo, utilizando **13 bases de dados diferentes** do Tesouro Gerencial, cada uma com filtros espec√≠ficos. A correta extra√ß√£o dos dados no TG √© fundamental para a precis√£o dos c√°lculos.
:::

::: {.callout-note}
### Sobre o Balancete

O arquivo `rgf_a02_balancete.xlsx` (renomeado para "balancete") √© utilizado em diversos anexos al√©m do RGF A02. Por isso, foi sugerida a renomea√ß√£o para um nome mais gen√©rico que reflita seu uso compartilhado.
:::

::: {.callout-tip}
### Verifica√ß√£o dos Resultados

Para validar os valores, compare com o demonstrativo oficial publicado no SICONFI. As principais fontes de diverg√™ncia s√£o:

- Diferen√ßas de data/m√™s de refer√™ncia
- Filtros incorretos na extra√ß√£o do TG
- Contas cont√°beis atualizadas no PCASP
:::


# üìã RGF Anexo 03 - Garantias e Contragarantias {#sec-rgf-a03}

## Ficha T√©cnica

```{r ficha-tecnica-rgf-a03}
#| echo: false

# =============================================================================
# FICHA T√âCNICA DO ANEXO
# =============================================================================

ficha_tecnica <- tibble::tribble(
  ~Campo,                 ~Informa√ß√£o,
  "Relat√≥rio",            "RGF - Relat√≥rio de Gest√£o Fiscal",
  "Anexo",                "Anexo 03",
  "Nome",                 "Demonstrativo das Garantias e Contragarantias de Valores",
  "Base Legal",           "LRF Art. 55, inciso I, al√≠nea 'c' e Art. 40, ¬ß 1¬∫",
  "Periodicidade",        "Quadrimestral",
  "Grau de Dificuldade",  "‚≠ê‚≠ê F√°cil",
  "√öltima Atualiza√ß√£o",   format(Sys.Date(), "%d/%m/%Y")
)

knitr::kable(ficha_tecnica, col.names = c("Campo", "Informa√ß√£o"))
```

## Arquivos Necess√°rios

```{r arquivos-rgf-a03}
#| echo: false

# =============================================================================
# ARQUIVOS DO TESOURO GERENCIAL UTILIZADOS
# =============================================================================

arquivos <- tibble::tribble(
  ~Arquivo,              ~Descri√ß√£o,                                    ~Filtros_TG,
  "rgf_a03.xlsx",        "Garantias e contragarantias de valores",      "Or√ßamento Fiscal, Contas 81* e 89*"
)

knitr::kable(arquivos, col.names = c("Arquivo", "Descri√ß√£o", "Filtros no TG"))
```

## Atributos Utilizados

```{r atributos-rgf-a03}
#| echo: false

# =============================================================================
# ATRIBUTOS (COLUNAS) DOS ARQUIVOS E SEUS USOS
# =============================================================================

atributos <- tibble::tribble(
  ~Atributo,                   ~Tipo,       ~Uso,                  ~Descri√ß√£o,
  "conta_contabil_numero",     "character", "TG / Crit√©rio",       "N√∫mero da conta cont√°bil (PCASP)",
  "conta_contabil_nome",       "character", "TG / Apresenta√ß√£o",   "Nome da conta cont√°bil",
  "conta_corrente",            "character", "TG / Crit√©rio",       "Conta corrente (identifica benefici√°rio)",
  "mes_lancamento",            "numeric",   "TG / R",              "M√™s do lan√ßamento (YYYYMM)",
  "saldo_r_conta_contabil",    "numeric",   "TG / R",              "Saldo da conta cont√°bil",
  "data_lancamento",           "Date",      "R",                   "Data calculada do lan√ßamento"
)

knitr::kable(atributos, col.names = c("Atributo", "Tipo", "Uso", "Descri√ß√£o"))
```

## V√≠nculos com Outros Anexos

```{r vinculos-rgf-a03}
#| echo: false

# =============================================================================
# RELACIONAMENTO COM OUTROS ANEXOS
# =============================================================================

vinculos <- tibble::tribble(
  ~Anexo_Relacionado,   ~Tipo_V√≠nculo,    ~Descri√ß√£o,
  "RREO Anexo 03",      "Refer√™ncia",     "RCL utilizada para c√°lculo do limite de garantias",
  "RGF Anexo 06",       "Consolida√ß√£o",   "Valores consolidados no demonstrativo simplificado"
)

knitr::kable(vinculos, col.names = c("Anexo Relacionado", "Tipo de V√≠nculo", "Descri√ß√£o"))
```

## Estrutura do Demonstrativo

```{r estrutura-rgf-a03}
#| echo: false

# =============================================================================
# ESTRUTURA DO DEMONSTRATIVO - GARANTIAS E CONTRAGARANTIAS
# =============================================================================

estrutura <- tibble::tribble(
  ~Ordem, ~Item,                                           ~Grupo,
  "01",   "Garantias aos Estados - Total",                 "I - Garantias Concedidas",
  "02",   "Garantias aos Estados - Op. Externas",          "I - Garantias Concedidas",
  "03",   "Garantias aos Estados - Op. Internas",          "I - Garantias Concedidas",
  "04",   "Garantias aos Munic√≠pios - Total",              "I - Garantias Concedidas",
  "05",   "Garantias aos Munic√≠pios - Op. Externas",       "I - Garantias Concedidas",
  "06",   "Garantias aos Munic√≠pios - Op. Internas",       "I - Garantias Concedidas",
  "07",   "Garantias √†s Entidades Controladas - Total",    "I - Garantias Concedidas",
  "08",   "Garantias √†s Entidades - Op. Externas",         "I - Garantias Concedidas",
  "09",   "Garantias √†s Entidades - Op. Internas",         "I - Garantias Concedidas",
  "10",   "Garantias por Fundos e Programas - Total",      "I - Garantias Concedidas",
  "11",   "Garantias Fundos - Seguros-Garantia",           "I - Garantias Concedidas",
  "12",   "Garantias Fundos - ASCA",                       "I - Garantias Concedidas",
  "13",   "Garantias Fundos - Lei 8.036 (FGTS)",           "I - Garantias Concedidas",
  "14",   "TOTAL GARANTIAS CONCEDIDAS",                    "I - Garantias Concedidas",
  "15",   "Contragarantias dos Estados - Total",           "II - Contragarantias Recebidas",
  "16",   "Contragarantias dos Estados - Op. Externas",    "II - Contragarantias Recebidas",
  "17",   "Contragarantias dos Estados - Op. Internas",    "II - Contragarantias Recebidas",
  "18",   "Contragarantias dos Munic√≠pios - Total",        "II - Contragarantias Recebidas",
  "19",   "Contragarantias dos Munic√≠pios - Op. Externas", "II - Contragarantias Recebidas",
  "20",   "Contragarantias dos Munic√≠pios - Op. Internas", "II - Contragarantias Recebidas",
  "21",   "Contragarantias das Entidades - Total",         "II - Contragarantias Recebidas",
  "22",   "Contragarantias das Entidades - Op. Externas",  "II - Contragarantias Recebidas",
  "23",   "Contragarantias das Entidades - Op. Internas",  "II - Contragarantias Recebidas",
  "24",   "TOTAL CONTRAGARANTIAS RECEBIDAS",               "II - Contragarantias Recebidas"
)

knitr::kable(estrutura, col.names = c("Ordem", "Item", "Grupo"))
```

## Contas Correntes de Refer√™ncia

```{r contas-correntes-rgf-a03}
#| echo: false

# =============================================================================
# TABELA DE CONTAS CORRENTES (BENEFICI√ÅRIOS)
# =============================================================================

contas_correntes <- tibble::tribble(
  ~Conta_Corrente,  ~Benefici√°rio,                    ~Tipo_Opera√ß√£o,
  "CG0000064",      "Estados",                        "Opera√ß√µes Internas",
  "CG0000069",      "Estados",                        "Opera√ß√µes Externas",
  "CG0000065",      "Munic√≠pios",                     "Opera√ß√µes Internas",
  "CG0000070",      "Munic√≠pios",                     "Opera√ß√µes Externas",
  "CG0000067",      "Entidades Controladas",          "Opera√ß√µes Internas",
  "CG0000071",      "Entidades Controladas",          "Opera√ß√µes Externas (tipo 1)",
  "CG0000072",      "Entidades Controladas",          "Opera√ß√µes Externas (tipo 2)",
  "CGASCA001",      "Fundos - ASCA",                  "Programas",
  "CGLEI8036",      "Fundos - Lei 8.036 (FGTS)",      "Programas"
)

knitr::kable(contas_correntes, col.names = c("Conta Corrente", "Benefici√°rio", "Tipo de Opera√ß√£o"))
```

## Importa√ß√£o dos Dados

```{r importar-rgf-a03}
#| code-fold: true
#| code-summary: "Ver c√≥digo de importa√ß√£o"

# =============================================================================
# IMPORTA√á√ÉO DOS DADOS RGF ANEXO 03
# =============================================================================
# Arquivo √∫nico com dados de garantias e contragarantias
# =============================================================================

cat("üì• Importando dados RGF Anexo 03 (Garantias)...\n")

# -----------------------------------------------------------------------------
# Importar arquivo
# -----------------------------------------------------------------------------

rgf_a03 <- read_excel(
  str_c(mes_pasta, "rgf_a03.xlsx"), 
  skip = 5
) %>%
  clean_names() %>%
  mutate(
    # Converter m√™s para num√©rico
    mes_lancamento = as.numeric(mes_lancamento),
    
    # Criar data do lan√ßamento (√∫ltimo dia do m√™s)
    data_lancamento = ceiling_date(
      ymd(paste0(mes_lancamento, "01")), 
      "month"
    ) - days(1)
  )

cat(sprintf("‚úÖ RGF A03: %s registros importados\n", 
            format(nrow(rgf_a03), big.mark = ".", decimal.mark = ",")))
```

## Crit√©rios de Classifica√ß√£o

```{r criterios-rgf-a03}
#| code-fold: true
#| code-summary: "Ver crit√©rios de classifica√ß√£o"

# =============================================================================
# CRIT√âRIOS RGF ANEXO 03 - GARANTIAS E CONTRAGARANTIAS
# =============================================================================
# Organizado em dois grupos:
#   I  - Garantias Concedidas (01-14)
#   II - Contragarantias Recebidas (15-24)
# =============================================================================

criterios_rgf_A03_garantias <- list(
  
  # ===========================================================================
  # GRUPO I - GARANTIAS CONCEDIDAS
  # ===========================================================================
  
  # ---------------------------------------------------------------------------
  # GARANTIAS AOS ESTADOS
  # ---------------------------------------------------------------------------
  
  `01 Garantias aos estados total` = list(
    criterio = "
    conta_contabil_numero %in% c('812110104', '812110204', '899913301', '899913302') &
    conta_corrente %in% c('CG0000064', 'CG0000069')
    "
  ),
  
  `02 Garantias aos estados opera√ß√µes externas` = list(
    criterio = "
    (conta_contabil_numero == '812110204' &
     conta_corrente == 'CG0000069') |
    (conta_contabil_numero == '899913302' &
     conta_corrente == 'CG0000069')
    "
  ),
  
  `03 Garantias aos estados opera√ß√µes internas` = list(
    criterio = "
    (conta_contabil_numero == '812110104' &
     conta_corrente == 'CG0000064') |
    (conta_contabil_numero == '899913301' &
     conta_corrente == 'CG0000064')
    "
  ),
  
  # ---------------------------------------------------------------------------
  # GARANTIAS AOS MUNIC√çPIOS
  # ---------------------------------------------------------------------------
  
  `04 Garantias aos munic√≠pios total` = list(
    criterio = "
    conta_contabil_numero %in% c('812110104', '812110204') &
    conta_corrente %in% c('CG0000065', 'CG0000070')
    "
  ),
  
  `05 Garantias aos munic√≠pios opera√ß√µes externas` = list(
    criterio = "
    conta_contabil_numero == '812110204' &
    conta_corrente == 'CG0000070'
    "
  ),
  
  `06 Garantias aos munic√≠pios opera√ß√µes internas` = list(
    criterio = "
    conta_contabil_numero == '812110104' &
    conta_corrente == 'CG0000065'
    "
  ),
  
  # ---------------------------------------------------------------------------
  # GARANTIAS √ÄS ENTIDADES CONTROLADAS
  # ---------------------------------------------------------------------------
  
  `07 Garantias √†s entidades controladas total` = list(
    criterio = "
    conta_contabil_numero %in% c('812110104', '812110204') &
    conta_corrente %in% c('CG0000067', 'CG0000071', 'CG0000072')
    "
  ),
  
  `08 Garantias √†s entidades opera√ß√µes externas` = list(
    criterio = "
    conta_contabil_numero == '812110204' &
    conta_corrente %in% c('CG0000071', 'CG0000072')
    "
  ),
  
  `09 Garantias √†s entidades opera√ß√µes internas` = list(
    criterio = "
    conta_contabil_numero == '812110104' &
    conta_corrente == 'CG0000067'
    "
  ),
  
  # ---------------------------------------------------------------------------
  # GARANTIAS POR FUNDOS E PROGRAMAS
  # ---------------------------------------------------------------------------
  
  `10 Garantias por fundos e programas total` = list(
    criterio = "
    (conta_contabil_numero == '812110104' & 
     (conta_corrente %in% c('CGASCA001', 'CGLEI8036') | 
      startsWith(conta_corrente, 'CGFSCEIRB') |
      startsWith(conta_corrente, 'CGPPRONAF') |
      startsWith(conta_corrente, 'CGPRCACAU') |
      startsWith(conta_corrente, 'CGASCAD'))) |
    conta_contabil_numero == '812110110'
    "
  ),
  
  `11 Garantias fundos seguros-garantia` = list(
    criterio = "
    conta_contabil_numero == '812110110' &
    (conta_corrente == '999' | is.na(conta_corrente))
    "
  ),
  
  `12 Garantias fundos ASCA` = list(
    criterio = "
    conta_contabil_numero == '812110104' &
    conta_corrente == 'CGASCA001'
    "
  ),
  
  `13 Garantias fundos Lei 8036 (FGTS)` = list(
    criterio = "
    conta_contabil_numero == '812110104' &
    conta_corrente == 'CGLEI8036'
    "
  ),
  
  # ---------------------------------------------------------------------------
  # TOTAL GERAL DE GARANTIAS
  # ---------------------------------------------------------------------------
  
  `14 Garantias total geral` = list(
    criterio = "
    conta_contabil_numero %in% c('812110104', '812110110', '812110204', '899913301', '899913302')
    "
  ),
  
  # ===========================================================================
  # GRUPO II - CONTRAGARANTIAS RECEBIDAS
  # ===========================================================================
  
  # ---------------------------------------------------------------------------
  # CONTRAGARANTIAS DOS ESTADOS
  # ---------------------------------------------------------------------------
  
  `15 Contragarantias dos estados total` = list(
    criterio = "
    conta_contabil_numero %in% c('811110304', '811110404') &
    conta_corrente %in% c('CG0000064', 'CG0000069')
    "
  ),
  
  `16 Contragarantias dos estados opera√ß√µes externas` = list(
    criterio = "
    conta_contabil_numero == '811110404' &
    conta_corrente == 'CG0000069'
    "
  ),
  
  `17 Contragarantias dos estados opera√ß√µes internas` = list(
    criterio = "
    conta_contabil_numero == '811110304' &
    conta_corrente == 'CG0000064'
    "
  ),
  
  # ---------------------------------------------------------------------------
  # CONTRAGARANTIAS DOS MUNIC√çPIOS
  # ---------------------------------------------------------------------------
  
  `18 Contragarantias dos munic√≠pios total` = list(
    criterio = "
    conta_contabil_numero %in% c('811110304', '811110404') &
    conta_corrente %in% c('CG0000065', 'CG0000070')
    "
  ),
  
  `19 Contragarantias dos munic√≠pios opera√ß√µes externas` = list(
    criterio = "
    conta_contabil_numero == '811110404' &
    conta_corrente == 'CG0000070'
    "
  ),
  
  `20 Contragarantias dos munic√≠pios opera√ß√µes internas` = list(
    criterio = "
    conta_contabil_numero == '811110304' &
    conta_corrente == 'CG0000065'
    "
  ),
  
  # ---------------------------------------------------------------------------
  # CONTRAGARANTIAS DAS ENTIDADES CONTROLADAS
  # ---------------------------------------------------------------------------
  
  `21 Contragarantias das entidades controladas total` = list(
    criterio = "
    conta_contabil_numero %in% c('811110304', '811110404') &
    conta_corrente %in% c('CG0000067', 'CG0000071', 'CG0000072')
    "
  ),
  
  `22 Contragarantias das entidades opera√ß√µes externas` = list(
    criterio = "
    conta_contabil_numero == '811110404' &
    conta_corrente %in% c('CG0000071', 'CG0000072')
    "
  ),
  
  `23 Contragarantias das entidades opera√ß√µes internas` = list(
    criterio = "
    conta_contabil_numero == '811110304' &
    conta_corrente == 'CG0000067'
    "
  ),
  
  # ---------------------------------------------------------------------------
  # TOTAL GERAL DE CONTRAGARANTIAS
  # ---------------------------------------------------------------------------
  
  `24 Contragarantias total geral` = list(
    criterio = "
    conta_contabil_numero %in% c('811110304', '811110404')
    "
  )
)

cat("‚úÖ Crit√©rios RGF Anexo 03 definidos\n")
cat(sprintf("   Total de categorias: %d\n", length(criterios_rgf_A03_garantias)))
```

## Aplica√ß√£o dos Crit√©rios

```{r aplicar-criterios-rgf-a03}
#| code-fold: true
#| code-summary: "Ver c√≥digo de aplica√ß√£o dos crit√©rios"

# =============================================================================
# APLICA√á√ÉO DOS CRIT√âRIOS DE GARANTIAS
# =============================================================================

cat("üìä Processando crit√©rios do RGF Anexo 03...\n")

# -----------------------------------------------------------------------------
# Aplicar crit√©rios
# -----------------------------------------------------------------------------

garantias_processado <- aplicar_criterios(
  rgf_a03, 
  criterios_rgf_A03_garantias
)

cat(sprintf("‚úÖ Crit√©rios aplicados: %d registros\n", nrow(garantias_processado)))

# -----------------------------------------------------------------------------
# Agregar por ordem/nome
# -----------------------------------------------------------------------------

garantias_agregado <- garantias_processado %>% 
  group_by(ordem, nome) %>% 
  summarise(
    valor = sum(valor, na.rm = TRUE), 
    .groups = "drop"
  ) %>%
  arrange(ordem)

# =============================================================================
# CALCULAR TOTAIS PARA VARI√ÅVEIS GLOBAIS
# =============================================================================

# Total de Garantias Concedidas (linha 14)
valor_garantias_total <- garantias_agregado %>%
  filter(ordem == "14") %>%
  pull(valor)

# Total de Contragarantias Recebidas (linha 24)
valor_contragarantias_total <- garantias_agregado %>%
  filter(ordem == "24") %>%
  pull(valor)

# Garantias l√≠quidas (garantias - contragarantias)
valor_garantias_liquidas <- valor_garantias_total - valor_contragarantias_total

cat(sprintf("‚úÖ Total Garantias: R$ %s\n", formatar_numero(valor_garantias_total)))
cat(sprintf("‚úÖ Total Contragarantias: R$ %s\n", formatar_numero(valor_contragarantias_total)))
```

## Resultados

```{r resultado-rgf-a03}
#| code-fold: true
#| column: page

# =============================================================================
# EXIBIR RESULTADOS
# =============================================================================

datatable(
  garantias_agregado,
  caption = "RGF Anexo 03 - Garantias e Contragarantias de Valores",
  rownames = FALSE,
  options = list(
    pageLength = -1,
    scrollX = TRUE,
    lengthMenu = list(c(10, 25, 50, -1), c('10', '25', '50', 'Todas'))
  )
) %>% 
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")
```

## Resumo das Garantias

```{r resumo-rgf-a03}
#| code-fold: true
#| code-summary: "Ver resumo das garantias"

# =============================================================================
# RESUMO DAS GARANTIAS POR BENEFICI√ÅRIO
# =============================================================================

# Garantias por benefici√°rio
garantias_estados <- garantias_agregado %>% filter(ordem == "01") %>% pull(valor)
garantias_municipios <- garantias_agregado %>% filter(ordem == "04") %>% pull(valor)
garantias_entidades <- garantias_agregado %>% filter(ordem == "07") %>% pull(valor)
garantias_fundos <- garantias_agregado %>% filter(ordem == "10") %>% pull(valor)

# Contragarantias por benefici√°rio
contragarantias_estados <- garantias_agregado %>% filter(ordem == "15") %>% pull(valor)
contragarantias_municipios <- garantias_agregado %>% filter(ordem == "18") %>% pull(valor)
contragarantias_entidades <- garantias_agregado %>% filter(ordem == "21") %>% pull(valor)

# Exibir resumo
cat("\nüìä RESUMO DAS GARANTIAS\n")
cat("=======================\n\n")

cat("GARANTIAS CONCEDIDAS:\n")
cat(sprintf("  Estados:              R$ %s\n", formatar_numero(garantias_estados)))
cat(sprintf("  Munic√≠pios:           R$ %s\n", formatar_numero(garantias_municipios)))
cat(sprintf("  Entidades Controladas:R$ %s\n", formatar_numero(garantias_entidades)))
cat(sprintf("  Fundos e Programas:   R$ %s\n", formatar_numero(garantias_fundos)))
cat(sprintf("  TOTAL:                R$ %s\n\n", formatar_numero(valor_garantias_total)))

cat("CONTRAGARANTIAS RECEBIDAS:\n")
cat(sprintf("  Estados:              R$ %s\n", formatar_numero(contragarantias_estados)))
cat(sprintf("  Munic√≠pios:           R$ %s\n", formatar_numero(contragarantias_municipios)))
cat(sprintf("  Entidades Controladas:R$ %s\n", formatar_numero(contragarantias_entidades)))
cat(sprintf("  TOTAL:                R$ %s\n\n", formatar_numero(valor_contragarantias_total)))

cat(sprintf("GARANTIAS L√çQUIDAS:     R$ %s\n", formatar_numero(valor_garantias_liquidas)))
```

## Notas Metodol√≥gicas

```{r notas-rgf-a03}
#| echo: false

# =============================================================================
# NOTAS METODOL√ìGICAS
# =============================================================================

notas <- tibble::tribble(
  ~Item, ~Descri√ß√£o,
  "1", "Valores em R$ (reais)",
  "2", "Contas 812* = Garantias concedidas",
  "3", "Contas 811* = Contragarantias recebidas",
  "4", "Contas 899913* = Garantias de controle (complementar)",
  "5", "Conta corrente identifica o benefici√°rio da garantia",
  "6", "Opera√ß√µes externas = financiamentos internacionais",
  "7", "Opera√ß√µes internas = financiamentos nacionais"
)

knitr::kable(notas, col.names = c("Item", "Descri√ß√£o"))
```

## Observa√ß√µes Importantes

::: {.callout-note}
### Limite de Garantias (LRF)

O limite de garantias conforme a LRF √© de **60% da RCL** para a Uni√£o. O valor atual deve ser comparado com este limite no RGF Anexo 06 (Demonstrativo Simplificado).
:::

::: {.callout-tip}
### Contas Cont√°beis

As principais contas cont√°beis utilizadas s√£o:

- **812110104**: Garantias internas
- **812110204**: Garantias externas
- **812110110**: Seguros-garantia
- **811110304**: Contragarantias internas
- **811110404**: Contragarantias externas
:::





# üìã RGF Anexo 04 - Opera√ß√µes de Cr√©dito {#sec-rgf-a04}

## Ficha T√©cnica

```{r ficha-tecnica-rgf-a04}
#| echo: false

# =============================================================================
# FICHA T√âCNICA DO ANEXO
# =============================================================================

ficha_tecnica <- tibble::tribble(
  ~Campo,                 ~Informa√ß√£o,
  "Relat√≥rio",            "RGF - Relat√≥rio de Gest√£o Fiscal",
  "Anexo",                "Anexo 04",
  "Nome",                 "Demonstrativo das Opera√ß√µes de Cr√©dito",
  "Base Legal",           "LRF Art. 55, inciso I, al√≠nea 'd' e Art. 32",
  "Periodicidade",        "Quadrimestral",
  "Grau de Dificuldade",  "‚≠ê‚≠ê‚≠ê M√©dio",
  "√öltima Atualiza√ß√£o",   format(Sys.Date(), "%d/%m/%Y")
)

knitr::kable(ficha_tecnica, col.names = c("Campo", "Informa√ß√£o"))
```

## Arquivos Necess√°rios

```{r arquivos-rgf-a04}
#| echo: false

# =============================================================================
# ARQUIVOS DO TESOURO GERENCIAL UTILIZADOS
# =============================================================================

arquivos <- tibble::tribble(
  ~Arquivo,                    ~Descri√ß√£o,                                    ~Filtros_TG,
  "rgf_a04_receitas.xlsx",     "Receitas de opera√ß√µes de cr√©dito",            "Or√ß. Fiscal, Contas 621*",
  "rgf_a04_despesas.xlsx",     "Aplica√ß√£o dos recursos (despesas)",           "Or√ß. Fiscal, Contas 622*",
  "rgf_a02_balancete.xlsx",    "Opera√ß√µes extraor√ßament√°rias",                "Or√ß. Fiscal, Contas 896* e 212*"
)

knitr::kable(arquivos, col.names = c("Arquivo", "Descri√ß√£o", "Filtros no TG"))
```

## Atributos Utilizados

```{r atributos-rgf-a04}
#| echo: false

# =============================================================================
# ATRIBUTOS (COLUNAS) DOS ARQUIVOS E SEUS USOS
# =============================================================================

atributos <- tibble::tribble(
  ~Atributo,                           ~Tipo,       ~Uso,                  ~Descri√ß√£o,

  "conta_contabil_numero",             "character", "TG / Crit√©rio",       "N√∫mero da conta cont√°bil (PCASP)",
  "natureza_receita_codigo_completo",  "character", "TG / Crit√©rio",       "C√≥digo completo da natureza de receita",
  "grupo_despesa_codigo_grupo",        "character", "TG / Crit√©rio",       "C√≥digo do grupo de despesa (1-6)",
  "mes_lancamento",                    "numeric",   "TG / R",              "M√™s do lan√ßamento (YYYYMM)",
  "saldo_r_conta_contabil",            "numeric",   "TG / R",              "Saldo da conta cont√°bil",
  "movim_liquido_r_item_informacao",   "numeric",   "TG / R",              "Movimento l√≠quido",
  "data_lancamento",                   "Date",      "R",                   "Data calculada do lan√ßamento"
)

knitr::kable(atributos, col.names = c("Atributo", "Tipo", "Uso", "Descri√ß√£o"))
```

## V√≠nculos com Outros Anexos

```{r vinculos-rgf-a04}
#| echo: false

# =============================================================================
# RELACIONAMENTO COM OUTROS ANEXOS
# =============================================================================

vinculos <- tibble::tribble(
  ~Anexo_Relacionado,   ~Tipo_V√≠nculo,    ~Descri√ß√£o,
  "RREO Anexo 03",      "Refer√™ncia",     "RCL utilizada para c√°lculo do limite de opera√ß√µes",
  "RGF Anexo 02",       "Refer√™ncia",     "Balancete compartilhado para extraor√ßament√°rias",
  "RGF Anexo 06",       "Consolida√ß√£o",   "Valores consolidados no demonstrativo simplificado"
)

knitr::kable(vinculos, col.names = c("Anexo Relacionado", "Tipo de V√≠nculo", "Descri√ß√£o"))
```

## Estrutura do Demonstrativo

```{r estrutura-rgf-a04}
#| echo: false

# =============================================================================
# ESTRUTURA DO DEMONSTRATIVO - OPERA√á√ïES DE CR√âDITO
# =============================================================================

estrutura <- tibble::tribble(
  ~Ordem, ~Item,                                                    ~Grupo,
  "01",   "Mobili√°ria Interna - Refinanciamento",                   "I - Sujeitas ao Limite",
  "02",   "Mobili√°ria Interna - Outras Or√ßament√°rias",              "I - Sujeitas ao Limite",
  "03",   "Mobili√°ria Interna - Extraor√ß. Aporte Bacen",            "I - Sujeitas ao Limite",
  "04",   "Mobili√°ria Interna - Extraor√ß. Aporte Empresas",         "I - Sujeitas ao Limite",
  "05",   "Mobili√°ria Interna - Extraor√ß. Trocas e Demais",         "I - Sujeitas ao Limite",
  "06",   "Mobili√°ria Externa - Refinanciamento",                   "I - Sujeitas ao Limite",
  "07",   "Mobili√°ria Externa - Assun√ß√£o/Reconhecimento D√≠vidas",   "I - Sujeitas ao Limite",
  "08",   "Mobili√°ria Externa - Outras Op. Mobili√°rias",            "I - Sujeitas ao Limite",
  "09",   "Contratual Interna - Abertura de Cr√©dito",               "I - Sujeitas ao Limite",
  "10",   "Contratual Interna - Assun√ß√£o/Reconhecimento D√≠vidas",   "I - Sujeitas ao Limite",
  "11",   "Contratual Interna - Outras Op. Contratuais",            "I - Sujeitas ao Limite",
  "12",   "Contratual Externa - Abertura Cr√©dito Or√ßament√°rias",    "I - Sujeitas ao Limite",
  "13",   "Contratual Externa - Abertura Cr√©dito Extraor√ß.",        "I - Sujeitas ao Limite",
  "14",   "Contratual Externa - Assun√ß√£o/Reconhecimento D√≠vidas",   "I - Sujeitas ao Limite",
  "15",   "Contratual Externa - Outras Op. Contratuais",            "I - Sujeitas ao Limite",
  "16",   "Amortiza√ß√£o/Refinanciamento",                            "II - Aplica√ß√£o dos Recursos",
  "17",   "Outras Despesas Correntes",                              "II - Aplica√ß√£o dos Recursos",
  "18",   "Pessoal e Encargos Sociais",                             "II - Aplica√ß√£o dos Recursos",
  "19",   "Juros e Encargos da D√≠vida",                             "II - Aplica√ß√£o dos Recursos",
  "20",   "Investimentos",                                          "II - Aplica√ß√£o dos Recursos",
  "21",   "Invers√µes Financeiras",                                  "II - Aplica√ß√£o dos Recursos"
)

knitr::kable(estrutura, col.names = c("Ordem", "Item", "Grupo"))
```

## Importa√ß√£o dos Dados

```{r importar-rgf-a04}
#| code-fold: true
#| code-summary: "Ver c√≥digo de importa√ß√£o"

# =============================================================================
# IMPORTA√á√ÉO DOS DADOS RGF ANEXO 04
# =============================================================================
# O anexo utiliza 3 bases de dados:
#   1. rgf_a04_receitas - Receitas de opera√ß√µes de cr√©dito
#   2. rgf_a04_despesas - Aplica√ß√£o dos recursos
#   3. rgf_a02_balancete - Opera√ß√µes extraor√ßament√°rias (compartilhado com A02)
# =============================================================================

cat("üì• Importando dados RGF Anexo 04 (Opera√ß√µes de Cr√©dito)...\n")

# -----------------------------------------------------------------------------
# Lista de arquivos espec√≠ficos do A04
# -----------------------------------------------------------------------------

arquivos_a04 <- list(
  receitas = str_c(mes_pasta, "rgf_a04_receitas.xlsx"),
  despesas = str_c(mes_pasta, "rgf_a04_despesas.xlsx")
)

# -----------------------------------------------------------------------------
# Importar em paralelo
# -----------------------------------------------------------------------------

dados_a04_lista <- future_map(
  arquivos_a04,
  function(arquivo) {
    read_excel(arquivo, skip = 5) %>%
      clean_names() %>%
      mutate(
        mes_lancamento = as.numeric(mes_lancamento),
        data_lancamento = ceiling_date(
          ymd(paste0(mes_lancamento, "01")), 
          "month"
        ) - days(1)
      )
  },
  .progress = TRUE
)

# Atribuir aos objetos
rgf_a04_receitas <- dados_a04_lista$receitas
rgf_a04_despesas <- dados_a04_lista$despesas

cat(sprintf("‚úÖ RGF A04 Receitas: %s registros\n", 
            format(nrow(rgf_a04_receitas), big.mark = ".", decimal.mark = ",")))
cat(sprintf("‚úÖ RGF A04 Despesas: %s registros\n", 
            format(nrow(rgf_a04_despesas), big.mark = ".", decimal.mark = ",")))

# -----------------------------------------------------------------------------
# Verificar se rgf_a02_balancete j√° foi importado
# -----------------------------------------------------------------------------
# O balancete √© compartilhado com o RGF A02 para opera√ß√µes extraor√ßament√°rias

if (!exists("rgf_a02_balancete")) {
  cat("‚ö†Ô∏è rgf_a02_balancete n√£o encontrado. Importando...\n")
  rgf_a02_balancete <- read_excel(
    str_c(mes_pasta, "rgf_a02_balancete.xlsx"), 
    skip = 5
  ) %>%
    clean_names() %>%
    mutate(
      mes_lancamento = as.numeric(mes_lancamento),
      data_lancamento = ceiling_date(
        ymd(paste0(mes_lancamento, "01")), 
        "month"
      ) - days(1)
    )
  cat(sprintf("‚úÖ Balancete: %s registros\n", 
              format(nrow(rgf_a02_balancete), big.mark = ".", decimal.mark = ",")))
} else {
  cat("‚úÖ rgf_a02_balancete j√° dispon√≠vel\n")
}
```

## Crit√©rios de Classifica√ß√£o

### Parte 1: Receitas Or√ßament√°rias

```{r criterios-receitas-rgf-a04}
#| code-fold: true
#| code-summary: "Ver crit√©rios - Receitas Or√ßament√°rias"

# =============================================================================
# PARTE 1: RECEITAS OR√áAMENT√ÅRIAS
# Base: rgf_a04_receitas
# Contas cont√°beis: 621* (Receitas de Opera√ß√µes de Cr√©dito)
# =============================================================================

criterios_rgf_A04_receitas <- list(
  
  # ---------------------------------------------------------------------------
  # MOBILI√ÅRIA INTERNA
  # ---------------------------------------------------------------------------
  
  `01 Mobili√°ria interna refinanciamento` = list(
    criterio = "
    conta_contabil_numero %in% c('621200000', '621310000', '621320000', 
                                  '621330000', '621340000', '621390000') &
    (startsWith(natureza_receita_codigo_completo, '2111002') |
     startsWith(natureza_receita_codigo_completo, '8111002') |
     natureza_receita_codigo_completo %in% c('21110200', '21110201', 
                                             '81110200', '81110201'))
    "
  ),
  
  `02 Mobili√°ria interna outras or√ßament√°rias` = list(
    criterio = "
    conta_contabil_numero %in% c('621200000', '621310000', '621320000', 
                                  '621330000', '621340000', '621390000') &
    (startsWith(natureza_receita_codigo_completo, '2111003') |
     startsWith(natureza_receita_codigo_completo, '8111001') |
     natureza_receita_codigo_completo %in% c('21110300', '21110301', 
                                             '21110100', '21110101'))
    "
  ),
  
  # ---------------------------------------------------------------------------
  # MOBILI√ÅRIA EXTERNA
  # ---------------------------------------------------------------------------
  
  `06 Mobili√°ria externa refinanciamento` = list(
    criterio = "
    conta_contabil_numero %in% c('621200000', '621310000', '621320000', 
                                  '621330000', '621340000', '621390000') &
    natureza_receita_codigo_completo %in% c('21210201', '21210202', 
                                            '21210021', '21210022')
    "
  ),
  
  `08 Mobili√°ria externa outras opera√ß√µes mobili√°rias externas` = list(
    criterio = "
    conta_contabil_numero %in% c('621200000', '621310000', '621320000', 
                                  '621330000', '621340000', '621390000') &
    natureza_receita_codigo_completo %in% c('21210101', '21210102', 
                                            '21210011', '21210012')
    "
  ),
  
  # ---------------------------------------------------------------------------
  # CONTRATUAL INTERNA
  # ---------------------------------------------------------------------------
  
  `09 Contratual interna abertura de cr√©dito` = list(
    criterio = "
    conta_contabil_numero %in% c('621200000', '621310000', '621320000', 
                                  '621330000', '621340000', '621390000') &
    startsWith(natureza_receita_codigo_completo, '2112001')
    "
  ),
  
  `11 Contratual interna outras opera√ß√µes contratuais internas` = list(
    criterio = "
    conta_contabil_numero %in% c('621200000', '621310000', '621320000', 
                                  '621330000', '621340000', '621390000') &
    startsWith(natureza_receita_codigo_completo, '2119001')
    "
  ),
  
  # ---------------------------------------------------------------------------
  # CONTRATUAL EXTERNA
  # ---------------------------------------------------------------------------
  
  `12 Contratual externa abertura de cr√©dito or√ßament√°rias` = list(
    criterio = "
    conta_contabil_numero %in% c('621200000', '621310000', '621320000', 
                                  '621330000', '621340000', '621390000') &
    (startsWith(natureza_receita_codigo_completo, '2122001') |
     natureza_receita_codigo_completo %in% c('21220100', '21220101', '21220102'))
    "
  ),
  
  `15 Contratual externa outras opera√ß√µes contratuais externas` = list(
    criterio = "
    conta_contabil_numero %in% c('621200000', '621310000', '621320000', 
                                  '621330000', '621340000', '621390000') &
    startsWith(natureza_receita_codigo_completo, '2129001')
    "
  )
)

cat("‚úÖ Crit√©rios de Receitas definidos\n")
```

### Parte 2: Opera√ß√µes Extraor√ßament√°rias

```{r criterios-extra-rgf-a04}
#| code-fold: true
#| code-summary: "Ver crit√©rios - Extraor√ßament√°rias"

# =============================================================================
# PARTE 2: OPERA√á√ïES EXTRAOR√áAMENT√ÅRIAS
# Base: rgf_a02_balancete (compartilhado com RGF A02)
# Contas cont√°beis: 896* (Emiss√µes extraor√ßament√°rias) e 212*
# =============================================================================

criterios_rgf_A04_extra_orcamentarias <- list(
  
  # ---------------------------------------------------------------------------
  # MOBILI√ÅRIA INTERNA - EXTRAOR√áAMENT√ÅRIAS
  # ---------------------------------------------------------------------------
  
  `03 Mobili√°ria interna extraor√ßament√°rias aporte Bacen` = list(
    criterio = "
    conta_contabil_numero %in% c('896110303', '896110304')
    "
  ),
  
  `04 Mobili√°ria interna extraor√ßament√°rias aporte em empresas` = list(
    criterio = "
    conta_contabil_numero %in% c('896110311', '896110312')
    "
  ),
  
  `05 Mobili√°ria interna extraor√ßament√°rias trocas e demais opera√ß√µes internas` = list(
    criterio = "
    conta_contabil_numero %in% c('896110301', '896110302', '896110305', '896110306')
    "
  ),
  
  # ---------------------------------------------------------------------------
  # MOBILI√ÅRIA EXTERNA - EXTRAOR√áAMENT√ÅRIAS
  # ---------------------------------------------------------------------------
  
  `07 Mobili√°ria externa assun√ß√£o reconhecimento e confiss√£o de d√≠vidas` = list(
    criterio = "
    conta_contabil_numero %in% c('896110309', '896110310')
    "
  ),
  
  # ---------------------------------------------------------------------------
  # CONTRATUAL INTERNA - EXTRAOR√áAMENT√ÅRIAS
  # ---------------------------------------------------------------------------
  
  `10 Contratual interna assun√ß√£o reconhecimento e confiss√£o de d√≠vidas` = list(
    criterio = "
    conta_contabil_numero == '212110398'
    "
  ),
  
  # ---------------------------------------------------------------------------
  # CONTRATUAL EXTERNA - EXTRAOR√áAMENT√ÅRIAS
  # ---------------------------------------------------------------------------
  
  `13 Contratual externa abertura de cr√©dito extraor√ßament√°rias` = list(
    criterio = "
    conta_contabil_numero %in% c('896110307', '896110308')
    "
  ),
  
  `14 Contratual externa assun√ß√£o reconhecimento e confiss√£o de d√≠vidas` = list(
    criterio = "FALSE"
  )
)

cat("‚úÖ Crit√©rios Extraor√ßament√°rios definidos\n")
```

### Parte 3: Aplica√ß√£o dos Recursos (Despesas)

```{r criterios-despesas-rgf-a04}
#| code-fold: true
#| code-summary: "Ver crit√©rios - Despesas"

# =============================================================================
# PARTE 3: APLICA√á√ÉO DOS RECURSOS (DESPESAS)
# Base: rgf_a04_despesas
# Contas cont√°beis: 622* (Execu√ß√£o de Despesa)
# =============================================================================

criterios_rgf_A04_despesas <- list(
  
  # ---------------------------------------------------------------------------
  # APLICA√á√ÉO DOS RECURSOS POR GRUPO DE DESPESA
  # ---------------------------------------------------------------------------
  
  `16 Amortiza√ß√£o refinanciamento` = list(
    criterio = "
    conta_contabil_numero %in% c('622130400', '622130600', '622130700') &
    grupo_despesa_codigo_grupo == '6'
    "
  ),
  
  `17 Outras despesas correntes` = list(
    criterio = "
    conta_contabil_numero %in% c('622130400', '622130600', '622130700') &
    grupo_despesa_codigo_grupo == '3'
    "
  ),
  
  `18 Pessoal e encargos sociais` = list(
    criterio = "
    conta_contabil_numero %in% c('622130400', '622130600', '622130700') &
    grupo_despesa_codigo_grupo == '1'
    "
  ),
  
  `19 Juros e encargos da d√≠vida` = list(
    criterio = "
    conta_contabil_numero %in% c('622130400', '622130600', '622130700') &
    grupo_despesa_codigo_grupo == '2'
    "
  ),
  
  `20 Investimentos` = list(
    criterio = "
    conta_contabil_numero %in% c('622130400', '622130600', '622130700') &
    grupo_despesa_codigo_grupo == '4'
    "
  ),
  
  `21 Invers√µes financeiras` = list(
    criterio = "
    conta_contabil_numero %in% c('622130400', '622130600', '622130700') &
    grupo_despesa_codigo_grupo == '5'
    "
  )
)

cat("‚úÖ Crit√©rios de Despesas definidos\n")
```

## Aplica√ß√£o dos Crit√©rios

```{r aplicar-criterios-rgf-a04}
#| code-fold: true
#| code-summary: "Ver c√≥digo de aplica√ß√£o dos crit√©rios"

# =============================================================================
# APLICA√á√ÉO DOS CRIT√âRIOS
# =============================================================================

cat("üìä Processando crit√©rios do RGF Anexo 04...\n")

# -----------------------------------------------------------------------------
# 1. Receitas Or√ßament√°rias
# -----------------------------------------------------------------------------

df_criterios_rgf_A04_receitas <- aplicar_criterios(
  rgf_a04_receitas, 
  criterios_rgf_A04_receitas
)

cat(sprintf("‚úÖ Receitas processadas: %d registros\n", nrow(df_criterios_rgf_A04_receitas)))

# -----------------------------------------------------------------------------
# 2. Opera√ß√µes Extraor√ßament√°rias
# -----------------------------------------------------------------------------

df_criterios_rgf_A04_extra_orcamentarias <- aplicar_criterios(
  rgf_a02_balancete, 
  criterios_rgf_A04_extra_orcamentarias
)

cat(sprintf("‚úÖ Extraor√ßament√°rias processadas: %d registros\n", 
            nrow(df_criterios_rgf_A04_extra_orcamentarias)))

# -----------------------------------------------------------------------------
# 3. Despesas (Aplica√ß√£o dos Recursos)
# -----------------------------------------------------------------------------

df_criterios_rgf_A04_despesas <- aplicar_criterios(
  rgf_a04_despesas, 
  criterios_rgf_A04_despesas
)

cat(sprintf("‚úÖ Despesas processadas: %d registros\n", nrow(df_criterios_rgf_A04_despesas)))
```

## Consolida√ß√£o dos Resultados

```{r consolidar-rgf-a04}
#| code-fold: true
#| code-summary: "Ver c√≥digo de consolida√ß√£o"

# =============================================================================
# CONSOLIDA√á√ÉO DOS RESULTADOS
# =============================================================================

# -----------------------------------------------------------------------------
# Consolidar todas as partes
# -----------------------------------------------------------------------------

df_rgf_A04_consolidado <- bind_rows(
  df_criterios_rgf_A04_receitas,
  df_criterios_rgf_A04_extra_orcamentarias,
  df_criterios_rgf_A04_despesas
) %>%
  arrange(ordem)

# -----------------------------------------------------------------------------
# Agregar por ordem/nome
# -----------------------------------------------------------------------------

operacoes_credito_agregado <- df_rgf_A04_consolidado %>%
  group_by(ordem, nome) %>%
  summarise(
    valor = sum(valor, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(ordem)

# =============================================================================
# CALCULAR TOTAIS PARA VARI√ÅVEIS GLOBAIS
# =============================================================================

# Total de Opera√ß√µes de Cr√©dito (linhas 01-15)
valor_operacoes_credito_total <- operacoes_credito_agregado %>%
  filter(as.numeric(ordem) <= 15) %>%
  summarise(valor = sum(valor, na.rm = TRUE)) %>%
  pull(valor)

# Total de Aplica√ß√£o dos Recursos (linhas 16-21)
valor_aplicacao_recursos_total <- operacoes_credito_agregado %>%
  filter(as.numeric(ordem) >= 16) %>%
  summarise(valor = sum(valor, na.rm = TRUE)) %>%
  pull(valor)

cat(sprintf("\n‚úÖ Consolida√ß√£o conclu√≠da\n"))
cat(sprintf("   Total Opera√ß√µes de Cr√©dito: R$ %s\n", formatar_numero(valor_operacoes_credito_total)))
cat(sprintf("   Total Aplica√ß√£o Recursos:   R$ %s\n", formatar_numero(valor_aplicacao_recursos_total)))
```

## Resultados

### Receitas de Opera√ß√µes de Cr√©dito

```{r resultado-receitas-rgf-a04}
#| code-fold: true
#| column: page

# =============================================================================
# EXIBIR RECEITAS
# =============================================================================

datatable(
  df_criterios_rgf_A04_receitas %>%
    group_by(ordem, nome) %>%
    summarise(valor = sum(valor, na.rm = TRUE), .groups = "drop") %>%
    arrange(ordem),
  caption = "RGF Anexo 04 - Receitas de Opera√ß√µes de Cr√©dito (Or√ßament√°rias)",
  rownames = FALSE,
  options = list(
    pageLength = -1,
    scrollX = TRUE,
    dom = 't'
  )
) %>% 
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")
```

### Opera√ß√µes Extraor√ßament√°rias

```{r resultado-extra-rgf-a04}
#| code-fold: true
#| column: page

# =============================================================================
# EXIBIR EXTRAOR√áAMENT√ÅRIAS
# =============================================================================

datatable(
  df_criterios_rgf_A04_extra_orcamentarias %>%
    group_by(ordem, nome) %>%
    summarise(valor = sum(valor, na.rm = TRUE), .groups = "drop") %>%
    arrange(ordem),
  caption = "RGF Anexo 04 - Opera√ß√µes Extraor√ßament√°rias",
  rownames = FALSE,
  options = list(
    pageLength = -1,
    scrollX = TRUE,
    dom = 't'
  )
) %>% 
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")
```

### Aplica√ß√£o dos Recursos (Despesas)

```{r resultado-despesas-rgf-a04}
#| code-fold: true
#| column: page

# =============================================================================
# EXIBIR DESPESAS
# =============================================================================

datatable(
  df_criterios_rgf_A04_despesas %>%
    group_by(ordem, nome) %>%
    summarise(valor = sum(valor, na.rm = TRUE), .groups = "drop") %>%
    arrange(ordem),
  caption = "RGF Anexo 04 - Aplica√ß√£o dos Recursos (Despesas)",
  rownames = FALSE,
  options = list(
    pageLength = -1,
    scrollX = TRUE,
    dom = 't'
  )
) %>% 
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")
```

### Consolidado

```{r resultado-consolidado-rgf-a04}
#| code-fold: true
#| column: page

# =============================================================================
# EXIBIR CONSOLIDADO
# =============================================================================

datatable(
  operacoes_credito_agregado,
  caption = "RGF Anexo 04 - Demonstrativo Consolidado",
  rownames = FALSE,
  options = list(
    pageLength = -1,
    scrollX = TRUE,
    lengthMenu = list(c(10, 25, 50, -1), c('10', '25', '50', 'Todas'))
  )
) %>% 
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")
```

## Resumo das Opera√ß√µes

```{r resumo-rgf-a04}
#| code-fold: true
#| code-summary: "Ver resumo das opera√ß√µes"

# =============================================================================
# RESUMO DAS OPERA√á√ïES DE CR√âDITO
# =============================================================================

# Opera√ß√µes Mobili√°rias
mobiliaria_interna <- operacoes_credito_agregado %>%
  filter(ordem %in% c("01", "02", "03", "04", "05")) %>%
  summarise(valor = sum(valor, na.rm = TRUE)) %>%
  pull(valor)

mobiliaria_externa <- operacoes_credito_agregado %>%
  filter(ordem %in% c("06", "07", "08")) %>%
  summarise(valor = sum(valor, na.rm = TRUE)) %>%
  pull(valor)

# Opera√ß√µes Contratuais
contratual_interna <- operacoes_credito_agregado %>%
  filter(ordem %in% c("09", "10", "11")) %>%
  summarise(valor = sum(valor, na.rm = TRUE)) %>%
  pull(valor)

contratual_externa <- operacoes_credito_agregado %>%
  filter(ordem %in% c("12", "13", "14", "15")) %>%
  summarise(valor = sum(valor, na.rm = TRUE)) %>%
  pull(valor)

# Exibir resumo
cat("\nüìä RESUMO DAS OPERA√á√ïES DE CR√âDITO\n")
cat("===================================\n\n")

cat("OPERA√á√ïES DE CR√âDITO:\n")
cat(sprintf("  Mobili√°ria Interna:   R$ %s\n", formatar_numero(mobiliaria_interna)))
cat(sprintf("  Mobili√°ria Externa:   R$ %s\n", formatar_numero(mobiliaria_externa)))
cat(sprintf("  Contratual Interna:   R$ %s\n", formatar_numero(contratual_interna)))
cat(sprintf("  Contratual Externa:   R$ %s\n", formatar_numero(contratual_externa)))
cat(sprintf("  TOTAL:                R$ %s\n\n", formatar_numero(valor_operacoes_credito_total)))

cat("APLICA√á√ÉO DOS RECURSOS:\n")
cat(sprintf("  TOTAL:                R$ %s\n", formatar_numero(valor_aplicacao_recursos_total)))
```

## Notas Metodol√≥gicas

```{r notas-rgf-a04}
#| echo: false

# =============================================================================
# NOTAS METODOL√ìGICAS
# =============================================================================

notas <- tibble::tribble(
  ~Item, ~Descri√ß√£o,
  "1", "Valores em R$ (reais)",
  "2", "Contas 621* = Receitas de opera√ß√µes de cr√©dito (or√ßament√°rias)",
  "3", "Contas 622* = Execu√ß√£o de despesa (aplica√ß√£o dos recursos)",
  "4", "Contas 896* = Emiss√µes extraor√ßament√°rias de t√≠tulos",
  "5", "Opera√ß√µes mobili√°rias = t√≠tulos p√∫blicos",
  "6", "Opera√ß√µes contratuais = empr√©stimos e financiamentos",
  "7", "O balancete (rgf_a02_balancete) √© compartilhado com o RGF Anexo 02"
)

knitr::kable(notas, col.names = c("Item", "Descri√ß√£o"))
```

## Observa√ß√µes Importantes

::: {.callout-note}
### Limite de Opera√ß√µes de Cr√©dito (LRF)

O limite de opera√ß√µes de cr√©dito conforme a LRF √© de **16% da RCL** para a Uni√£o. O valor deve ser comparado com este limite no RGF Anexo 06 (Demonstrativo Simplificado).
:::

::: {.callout-warning}
### Opera√ß√µes Extraor√ßament√°rias

As opera√ß√µes extraor√ßament√°rias (linhas 03-05, 07, 10, 13-14) utilizam dados do **balancete** (rgf_a02_balancete), que √© compartilhado com o RGF Anexo 02. Certifique-se de que este arquivo foi importado antes de processar o Anexo 04.
:::

::: {.callout-tip}
### Naturezas de Receita

As principais naturezas de receita utilizadas s√£o:

- **2111**: Opera√ß√µes de Cr√©dito Internas - Mobili√°rias
- **2112**: Opera√ß√µes de Cr√©dito Internas - Contratuais
- **2121**: Opera√ß√µes de Cr√©dito Externas - Mobili√°rias
- **2122**: Opera√ß√µes de Cr√©dito Externas - Contratuais
:::



# üìã RGF Anexo 05 - Disponibilidades de Caixa {#sec-rgf-a05}

## Ficha T√©cnica

```{r ficha-tecnica-rgf-a05}
#| echo: false

# =============================================================================
# FICHA T√âCNICA DO ANEXO
# =============================================================================

ficha_tecnica <- tibble::tribble(
  ~Campo,                 ~Informa√ß√£o,
  "Relat√≥rio",            "RGF - Relat√≥rio de Gest√£o Fiscal",
  "Anexo",                "Anexo 05",
  "Nome",                 "Demonstrativo da Disponibilidade de Caixa e dos Restos a Pagar",
  "Base Legal",           "LRF Art. 55, inciso III, al√≠nea 'a'",
  "Periodicidade",        "Quadrimestral",
  "Grau de Dificuldade",  "‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Muito Dif√≠cil",
  "√öltima Atualiza√ß√£o",   format(Sys.Date(), "%d/%m/%Y")
)

knitr::kable(ficha_tecnica, col.names = c("Campo", "Informa√ß√£o"))
```

## Arquivos Necess√°rios

```{r arquivos-rgf-a05}
#| echo: false

# =============================================================================
# ARQUIVOS DO TESOURO GERENCIAL UTILIZADOS
# =============================================================================

arquivos <- tibble::tribble(
  ~Arquivo,                              ~Descri√ß√£o,                                    ~Filtros_TG,
  "rgf_a05_111_ate_fonte_002.xlsx",      "Disponibilidades fontes 000-002",             "Or√ß. Fiscal, Fontes 000-002",
  "rgf_a05_111_fonte_003_052.xlsx",      "Disponibilidades fontes 003-052",             "Or√ß. Fiscal, Fontes 003-052",
  "rgf_a05_111_fonte_053_em_diante_executivo.xlsx", "Disponibilidades fontes 053+ (Exec.)", "Or√ß. Fiscal, Fontes 053+, Poder Executivo",
  "rgf_a05_111_fonte_053_em_diante_demais.xlsx",    "Disponibilidades fontes 053+ (Demais)", "Or√ß. Fiscal, Fontes 053+, Demais Poderes",
  "rgf_a05_21.xlsx",                     "Passivos circulantes",                        "Or√ß. Fiscal, Contas 21*",
  "rgf_a05_22_23.xlsx",                  "Passivos n√£o circulantes",                    "Or√ß. Fiscal, Contas 22* e 23*",
  "rgf_a05_contas_contabeis.xlsx",       "Contas cont√°beis espec√≠ficas",                "Or√ß. Fiscal, Contas espec√≠ficas",
  "disponibilidade_inicial.xlsx",         "Disponibilidade inicial (arquivo auxiliar)",  "Planilha Excel com abas Uni√£o e Executivo"
)

knitr::kable(arquivos, col.names = c("Arquivo", "Descri√ß√£o", "Filtros no TG"))
```

## Atributos Utilizados

```{r atributos-rgf-a05}
#| echo: false

# =============================================================================
# ATRIBUTOS (COLUNAS) DOS ARQUIVOS E SEUS USOS
# =============================================================================

atributos <- tibble::tribble(
  ~Atributo,                                    ~Tipo,       ~Uso,                  ~Descri√ß√£o,
  "conta_contabil_numero",                      "character", "TG / Crit√©rio",       "N√∫mero da conta cont√°bil (PCASP)",
  "fonte_recursos_codigo",                      "character", "TG / Crit√©rio",       "C√≥digo da fonte de recursos",
  "isf_lancamento",                             "character", "TG / Crit√©rio",       "Indicador de Super√°vit Financeiro (F/P)",
  "ug_executora_codigo",                        "character", "TG / Crit√©rio",       "C√≥digo da UG executora",
  "orgao_c_cor_codigo",                         "character", "TG / Crit√©rio",       "C√≥digo do √≥rg√£o (conta corrente)",
  "orgao_uge_poder_codigo",                     "character", "TG / Crit√©rio",       "C√≥digo do poder (0=Executivo)",
  "orgao_uge_orgao_maximo_codigo",              "character", "TG / Crit√©rio",       "C√≥digo do √≥rg√£o m√°ximo",
  "detalhe_orgao_central_codigo_detalhe_oc",    "character", "TG / Crit√©rio",       "C√≥digo detalhe √≥rg√£o central",
  "detalhe_orgao_central_id_fonte",             "character", "TG / Crit√©rio",       "ID fonte √≥rg√£o central",
  "mes_lancamento",                             "numeric",   "TG / R",              "M√™s do lan√ßamento (YYYYMM)",
  "saldo_r_conta_contabil",                     "numeric",   "TG / R",              "Saldo da conta cont√°bil",
  "data_lancamento",                            "Date",      "R",                   "Data calculada do lan√ßamento"
)

knitr::kable(atributos, col.names = c("Atributo", "Tipo", "Uso", "Descri√ß√£o"))
```

## V√≠nculos com Outros Anexos

```{r vinculos-rgf-a05}
#| echo: false

# =============================================================================
# RELACIONAMENTO COM OUTROS ANEXOS
# =============================================================================

vinculos <- tibble::tribble(
  ~Anexo_Relacionado,   ~Tipo_V√≠nculo,    ~Descri√ß√£o,
  "RGF Anexo 02",       "Refer√™ncia",     "Balancete para algumas contas espec√≠ficas",
  "RGF Anexo 06",       "Consolida√ß√£o",   "Valores consolidados no demonstrativo simplificado"
)

knitr::kable(vinculos, col.names = c("Anexo Relacionado", "Tipo de V√≠nculo", "Descri√ß√£o"))
```

## Estrutura do Demonstrativo

```{r estrutura-rgf-a05}
#| echo: false

# =============================================================================
# ESTRUTURA DO DEMONSTRATIVO - LINHAS POR FONTE DE RECURSOS
# =============================================================================

estrutura <- tibble::tribble(
  ~C√≥digo,                        ~Linha,                              ~Fontes,
  "0_nao_vinculados",             "Recursos N√£o Vinculados",           "000",
  "1_educacao",                   "Educa√ß√£o",                          "008, 012, 130, 133, 134",
  "2_seguridade_exceto_previdencia", "Seguridade (exceto Previd√™ncia)", "001, 002, 004, 005, 006, 010, 017, 023, 024, 035, 040, ...",
  "3_rpps",                       "RPPS",                              "055, 056, 125",
  "4_rgps",                       "RGPS",                              "054",
  "5_divida",                     "D√≠vida",                            "400, 401, 443, 444, 448, + espec√≠ficas",
  "6_transferencias",             "Transfer√™ncias",                    "201-289",
  "7_fundos_orgaos_programa",     "Fundos, √ìrg√£os e Programas",        "003-199 (exceto anteriores)",
  "8_extraorcamentario",          "Extraor√ßament√°rio",                 "491",
  "9_nao_classificados",          "Recursos a Classificar",            "490, -9, -7"
)

knitr::kable(estrutura, col.names = c("C√≥digo", "Linha", "Fontes de Recursos"))
```

## Colunas do Demonstrativo

```{r colunas-rgf-a05}
#| echo: false

# =============================================================================
# COLUNAS DO DEMONSTRATIVO
# =============================================================================

colunas <- tibble::tribble(
  ~Coluna,                                    ~Descri√ß√£o,
  "Disponibilidade Inicial",                  "Saldo inicial do exerc√≠cio (arquivo auxiliar)",
  "Receitas",                                 "Receitas or√ßament√°rias realizadas",
  "Despesas",                                 "Despesas or√ßament√°rias pagas",
  "Demais Fluxos",                            "Ajustes e outros fluxos",
  "Disponibilidade Bruta",                    "Caixa bruto antes de obriga√ß√µes",
  "RP Liquidados NP - Exerc√≠cios Anteriores", "Restos a pagar liquidados n√£o pagos (anos anteriores)",
  "RP Liquidados NP - Do Exerc√≠cio",          "Restos a pagar liquidados n√£o pagos (ano atual)",
  "RP Empenhados NL - Exerc√≠cios Anteriores", "Restos a pagar empenhados n√£o liquidados",
  "Demais Obriga√ß√µes Financeiras",            "Outras obriga√ß√µes financeiras",
  "Disponibilidade Antes Inscri√ß√£o RP",       "Disponibilidade l√≠quida final"
)

knitr::kable(colunas, col.names = c("Coluna", "Descri√ß√£o"))
```

## Importa√ß√£o dos Dados

```{r importar-rgf-a05}
#| code-fold: true
#| code-summary: "Ver c√≥digo de importa√ß√£o"

# =============================================================================
# IMPORTA√á√ÉO DOS DADOS RGF ANEXO 05
# =============================================================================
# O anexo utiliza m√∫ltiplos arquivos segmentados por fonte de recursos
# =============================================================================

cat("üì• Importando dados RGF Anexo 05 (Disponibilidades)...\n")

# -----------------------------------------------------------------------------
# Buscar todos os arquivos rgf_a05
# -----------------------------------------------------------------------------

arq_rgf_a05 <- list.files(
  path = mes_pasta, 
  pattern = 'rgf_a05', 
  full.names = TRUE
)

cat(sprintf("   Encontrados %d arquivos\n", length(arq_rgf_a05)))

# -----------------------------------------------------------------------------
# Importar em paralelo
# -----------------------------------------------------------------------------

rgf_a05 <- importar_excel_paralelo(arq_rgf_a05, skip = 5, .progress = TRUE) %>%
  mutate(
    saldo_r_conta_contabil = as.numeric(saldo_r_conta_contabil),
    mes_lancamento = as.numeric(mes_lancamento),
    data_lancamento = ceiling_date(
      ymd(paste0(mes_lancamento, "01")), 
      "month"
    ) - days(1)
  )

cat(sprintf("‚úÖ RGF A05: %s registros (%d arquivos)\n", 
            format(nrow(rgf_a05), big.mark = ".", decimal.mark = ","), 
            length(arq_rgf_a05)))
```

## Prepara√ß√£o dos Dados

```{r preparar-rgf-a05}
#| code-fold: true
#| code-summary: "Ver c√≥digo de prepara√ß√£o"

# =============================================================================
# PREPARA√á√ÉO DOS DADOS
# =============================================================================

# -----------------------------------------------------------------------------
# Criar chaves compostas para identifica√ß√£o
# -----------------------------------------------------------------------------

rgf_a05 <- rgf_a05 %>% 
  mutate(
    # Chave √≥rg√£o + fonte completa
    orgao_fonte = str_c(
      detalhe_orgao_central_codigo_detalhe_oc, "_",
      detalhe_orgao_central_id_fonte, "_",
      fonte_recursos_codigo
    ),
    
    # Chave √≥rg√£o + fonte (sem c√≥digo fonte)
    tg_orgao_fonte = str_c(
      detalhe_orgao_central_codigo_detalhe_oc, "_",
      detalhe_orgao_central_id_fonte
    )
  )

# -----------------------------------------------------------------------------
# Classificar por linhas (fontes de recursos)
# -----------------------------------------------------------------------------

# Operador auxiliar "not in"
`%notin%` <- Negate(`%in%`)

if (!"linhas" %in% names(rgf_a05)) {
  rgf_a05 <- rgf_a05 %>%
    mutate(
      linhas = case_when(
        # Recursos N√£o Vinculados
        fonte_recursos_codigo %in% c("000") ~ "0_nao_vinculados",
        
        # Educa√ß√£o
        fonte_recursos_codigo %in% c("008", "012", "130", "133", "134") ~ "1_educacao",
        
        # Seguridade Social (exceto Previd√™ncia)
        fonte_recursos_codigo %in% c(
          "001", "002", "004", "005", "006", "010", "017", "023", "024", 
          "035", "040", "048", "049", "094", "126", "155", "156", "179", "184"
        ) ~ "2_seguridade_exceto_previdencia",
        fonte_recursos_codigo %in% c("122", "123") & 
          tg_orgao_fonte %notin% c("000278_153", "000278_154") ~ "2_seguridade_exceto_previdencia",
        
        # RPPS
        fonte_recursos_codigo %in% c("055", "056", "125") ~ "3_rpps",
        
        # RGPS
        fonte_recursos_codigo %in% c("054") ~ "4_rgps",
        
        # D√≠vida
        fonte_recursos_codigo %in% c("400", "401", "443", "444", "448") ~ "5_divida",
        fonte_recursos_codigo %in% c("034", "121", "122", "123") & 
          tg_orgao_fonte %in% c("000278_133", "000278_152", "000278_153", "000278_154") ~ "5_divida",
        
        # Transfer√™ncias
        fonte_recursos_codigo %in% c(
          "201", "202", "203", "206", "207", "208", "209", "210", "211", "213",
          "219", "229", "234", "235", "241", "242", "251", 
          "286", "287", "288", "289"
        ) ~ "6_transferencias",
        
        # Fundos, √ìrg√£os e Programas (demais fontes)
        fonte_recursos_codigo %in% c(
          "003", "007", "009", "011", "013", "014", "015", "016", "018", "019",
          "020", "021", "022", "025", "026", "027", "028", "029", "030", "031",
          "032", "033", "034", "037", "038", "039", "041", "042", "043", "044",
          "045", "046", "047", "050", "051", "052", "053", "057", "058", "059",
          "060", "061", "062", "063", "064", "065", "066", "067", "068", "069",
          "070", "071", "072", "073", "074", "075", "076", "077", "078", "079",
          "080", "081", "082", "083", "084", "085", "086", "087", "088", "089",
          "090", "091", "092", "093", "095", "096", "097", "098", "099", "100",
          "101", "102", "103", "104", "105", "106", "107", "108", "109", "110",
          "111", "112", "113", "114", "115", "116", "118", "119", "120", "121",
          "124", "127", "128", "129", "131", "132", "135", "136", "137", "138", 
          "139", "140", "141", "144", "145", "177", "178", "180", "181", "182", 
          "183", "449"
        ) ~ "7_fundos_orgaos_programa",
        (fonte_recursos_codigo %in% c("034", "121") & 
           tg_orgao_fonte %notin% c("000278_133", "000278_152")) ~ "7_fundos_orgaos_programa",
        
        # Extraor√ßament√°rio
        fonte_recursos_codigo %in% c("491") ~ "8_extraorcamentario",
        
        # N√£o Classificados / A Classificar
        fonte_recursos_codigo %in% c("490", "'-9", "'-7") ~ "9_nao_classificados",
        
        # Outros (n√£o classificados nas categorias acima)
        TRUE ~ "outros"
      )
    )
}

cat("‚úÖ Dados preparados com classifica√ß√£o de linhas\n")

# Verificar distribui√ß√£o
cat("\nüìä Distribui√ß√£o por linha:\n")
rgf_a05 %>% 
  count(linhas) %>%
  arrange(linhas) %>%
  print()
```

## Crit√©rios de Classifica√ß√£o

```{r criterios-rgf-a05}
#| code-fold: true
#| code-summary: "Ver crit√©rios de classifica√ß√£o"

# =============================================================================
# CRIT√âRIOS RGF ANEXO 05 - DISPONIBILIDADE DE CAIXA E RESTOS A PAGAR
# =============================================================================
# 22 crit√©rios para classifica√ß√£o das contas cont√°beis
# =============================================================================

criterios_rgf_a05_disponibilidade <- list(
  
  # ===========================================================================
  # RECEITAS E DESPESAS
  # ===========================================================================
  
  `01_receitas` = list(
    criterio = "
    conta_contabil_numero %in% c('621200000', '621310000', '621320000', 
                                  '621330000', '621390000')
    "
  ),
  
  `02_despesas` = list(
    criterio = "
    conta_contabil_numero %in% c('622920104', '631400000', '632200000')
    "
  ),
  
  # ===========================================================================
  # DISPONIBILIDADE DE CAIXA
  # ===========================================================================
  
  `03_disponibilidade_caixa_bruta` = list(
    criterio = "
    startsWith(conta_contabil_numero, '111') &
    isf_lancamento == 'F' &
    conta_contabil_numero != '111110205'
    "
  ),
  
  `04_deducao_receitas_classificar` = list(
    criterio = "
    conta_contabil_numero %in% c('111113001', '491110101', '491110102', '491110103', 
                                  '491110108', '491010101', '491010102', '491010103', 
                                  '491019701', '491019702', '491019703')
    "
  ),
  
  # ===========================================================================
  # RESTOS A PAGAR
  # ===========================================================================
  
  `05_rp_liquidados_nao_pagos_exercicios_anteriores` = list(
    criterio = "
    conta_contabil_numero %in% c('632100000', '631300000')
    "
  ),
  
  `06_rp_liquidados_nao_pagos_exercicio` = list(
    criterio = "
    conta_contabil_numero %in% c('632710000', '632720000', '632700000')
    "
  ),
  
  `07_rp_empenhados_nao_liquidados_exercicios_anteriores` = list(
    criterio = "
    conta_contabil_numero %in% c('631100000', '631200000', '631510000', '631520000', 
                                  '631530000', '631810000', '631820000', '631830000', 
                                  '631840000', '631540000')
    "
  ),
  
  # ===========================================================================
  # DEMAIS OBRIGA√á√ïES
  # ===========================================================================
  
  `08_demais_obrigacoes_i` = list(
    criterio = "
    startsWith(conta_contabil_numero, '2') &
    isf_lancamento == 'F' &
    !conta_contabil_numero %in% c('218923901', '218923902', '218923903', '218914001')
    "
  ),
  
  `09_demais_obrigacoes_ii_2f_da_codiv` = list(
    criterio = "
    startsWith(conta_contabil_numero, '2') &
    isf_lancamento == 'F' &
    ug_executora_codigo == '170600'
    "
  ),
  
  `10_deducao_demais_obrigacoes_i` = list(
    criterio = "
    conta_contabil_numero %in% c('631570000', '631590000', '631540000', '632100000', 
                                  '632720000', '531710200', '531720100', '218923901')
    "
  ),
  
  `11_rp_empenhados_nao_liquidados_exercicio` = list(
    criterio = "
    conta_contabil_numero %in% c('531710100', '531710200', '531720100')
    "
  ),
  
  `12_empenhos_nao_liquidados_cancelados` = list(
    criterio = "
    conta_contabil_numero == '631910000'
    "
  ),
  
  # ===========================================================================
  # CONTAS ESPEC√çFICAS
  # ===========================================================================
  
  `13_conta_822240101_recebimento_rp_autorizado` = list(
    criterio = "
    conta_contabil_numero == '822240101'
    "
  ),
  
  `14_conta_822140101_liberacao_rp_autorizado` = list(
    criterio = "
    conta_contabil_numero == '822140101'
    "
  ),
  
  `15_conta_894310000_disp_recursos_ted_liberar` = list(
    criterio = "
    conta_contabil_numero == '894310000'
    "
  ),
  
  `16_conta_894320000_disp_recursos_ted_receber` = list(
    criterio = "
    conta_contabil_numero == '894320000'
    "
  ),
  
  # ===========================================================================
  # DEDU√á√ïES
  # ===========================================================================
  
  `17_deducao_limite_saque_i` = list(
    criterio = "
    conta_contabil_numero %in% c('218924001') &
    isf_lancamento == 'F'
    "
  ),
  
  `18_deducao_limite_saque_ii_poder_executivo` = list(
    criterio = "
    conta_contabil_numero %in% c('218924001', '218924002') &
    orgao_c_cor_codigo %in% c('01000', '02000', '02001', '11000', '12000', 
                              '13000', '14000', '15000', '17000', '34000', 
                              '51100', '53000') &
    isf_lancamento == 'F'
    "
  ),
  
  `19_deducao_disponibilidade_liquida_111110205` = list(
    criterio = "
    conta_contabil_numero == '111110205'
    "
  ),
  
  `20_deducao_demais_obrigacoes_ii` = list(
    criterio = "
    conta_contabil_numero %in% c('218924001', '218914001') &
    isf_lancamento == 'F'
    "
  ),
  
  # ===========================================================================
  # DEMAIS OBRIGA√á√ïES (NOVOS)
  # ===========================================================================
  
  `21_demais_obrigacoes_new` = list(
    criterio = "
    startsWith(conta_contabil_numero, '2') &
    !conta_contabil_numero %in% c('218923901', '218923902', '218923903', 
                                   '218924001', '218914001') &
    isf_lancamento == 'F' &
    ug_executora_codigo != '170600'
    "
  ),
  
  `22_demais_obrigacoes_subtracao` = list(
    criterio = "
    conta_contabil_numero %in% c('631200000', '631300000', '631520000', '632100000', 
                                  '631540000', '218929031', '218929032', '218929033', 
                                  '531720100', '531710200', '632710000', '632720000')
    "
  )
)

cat("‚úÖ Crit√©rios RGF Anexo 05 definidos\n")
cat(sprintf("   Total de categorias: %d\n", length(criterios_rgf_a05_disponibilidade)))
```

## Aplica√ß√£o dos Crit√©rios

```{r aplicar-criterios-rgf-a05}
#| code-fold: true
#| code-summary: "Ver c√≥digo de aplica√ß√£o dos crit√©rios"

# =============================================================================
# APLICA√á√ÉO DOS CRIT√âRIOS
# =============================================================================

cat("üìä Processando crit√©rios do RGF Anexo 05...\n")

# -----------------------------------------------------------------------------
# Fun√ß√£o auxiliar para obter coluna (com fallback para 0)
# -----------------------------------------------------------------------------

get_col <- function(df, nome_coluna) {
  if (nome_coluna %in% names(df)) {
    return(df[[nome_coluna]])
  } else {
    return(0)
  }
}

# -----------------------------------------------------------------------------
# Criar abrang√™ncias: Uni√£o e Executivo
# -----------------------------------------------------------------------------

# Uni√£o: TODOS os registros
rgf_a05_uniao <- rgf_a05 %>%
  mutate(abrangencia = "uniao")

# Executivo: Apenas Poder Executivo, exceto DPU (34000) e MPU (59000)
rgf_a05_executivo <- rgf_a05 %>%
  filter(
    orgao_uge_poder_codigo == "0" & 
    !(orgao_uge_orgao_maximo_codigo %in% c("34000", "59000"))
  ) %>%
  mutate(abrangencia = "executivo")

# Combinar as duas abrang√™ncias
rgf_a05_abrangencia <- bind_rows(rgf_a05_uniao, rgf_a05_executivo)

cat(sprintf("‚úÖ Uni√£o: %s registros\n", 
            format(nrow(rgf_a05_uniao), big.mark = ".", decimal.mark = ",")))
cat(sprintf("‚úÖ Executivo: %s registros\n", 
            format(nrow(rgf_a05_executivo), big.mark = ".", decimal.mark = ",")))

# -----------------------------------------------------------------------------
# Aplicar crit√©rios COM abrang√™ncia
# -----------------------------------------------------------------------------

resultado_rgf_a05 <- aplicar_criterios(
  df = rgf_a05_abrangencia,
  criterios = criterios_rgf_a05_disponibilidade,
  group_vars = c("linhas", "abrangencia")
)

cat(sprintf("‚úÖ Crit√©rios aplicados: %d registros\n", nrow(resultado_rgf_a05)))
```

## C√°lculos e Consolida√ß√£o

```{r calcular-rgf-a05}
#| code-fold: true
#| code-summary: "Ver c√≥digo de c√°lculos"

# =============================================================================
# C√ÅLCULOS DO DEMONSTRATIVO
# =============================================================================

# -----------------------------------------------------------------------------
# Pivotar para formato wide
# -----------------------------------------------------------------------------

rgf_a05_wide <- resultado_rgf_a05 %>%
  select(mes_lancamento, linhas, abrangencia, categoria, valor) %>%
  pivot_wider(names_from = categoria, values_from = valor, values_fill = 0)

# -----------------------------------------------------------------------------
# Renomear colunas b√°sicas
# -----------------------------------------------------------------------------

rgf_a05_wide <- rgf_a05_wide %>%
  mutate(
    # Receitas e despesas
    receitas = get_col(., "01_receitas"),
    despesas = get_col(., "02_despesas"),
    
    # Disponibilidade de caixa
    disponibilidade_caixa_bruta = get_col(., "03_disponibilidade_caixa_bruta"),
    deducao_receitas_classificar = get_col(., "04_deducao_receitas_classificar"),
    
    # Restos a Pagar
    rp_liquidados_nao_pagos_exercicios_anteriores = 
      get_col(., "05_rp_liquidados_nao_pagos_exercicios_anteriores"),
    rp_liquidados_nao_pagos_exercicio = 
      get_col(., "06_rp_liquidados_nao_pagos_exercicio"),
    rp_empenhados_nao_liquidados_exercicios_anteriores = 
      get_col(., "07_rp_empenhados_nao_liquidados_exercicios_anteriores"),
    
    # Obriga√ß√µes
    demais_obrigacoes_new = get_col(., "21_demais_obrigacoes_new"),
    demais_obrigacoes_subtracao = get_col(., "22_demais_obrigacoes_subtracao"),
    
    # TEDs
    conta_894310000_disp_recursos_ted_liberar = 
      get_col(., "15_conta_894310000_disp_recursos_ted_liberar"),
    conta_894320000_disp_recursos_ted_receber = 
      get_col(., "16_conta_894320000_disp_recursos_ted_receber")
  )

# -----------------------------------------------------------------------------
# Calcular Disponibilidade Bruta Clean
# -----------------------------------------------------------------------------

rgf_a05_clean <- rgf_a05_wide %>%
  mutate(
    disponibilidade_bruta_clean = case_when(
      linhas == "7_fundos_orgaos_programa" ~ 
        disponibilidade_caixa_bruta + 
        conta_894320000_disp_recursos_ted_receber - 
        conta_894310000_disp_recursos_ted_liberar,
      
      linhas == "9_nao_classificados" ~ 
        disponibilidade_caixa_bruta - deducao_receitas_classificar,
      
      TRUE ~ disponibilidade_caixa_bruta
    )
  )

# -----------------------------------------------------------------------------
# Calcular Demais Obriga√ß√µes Financeiras Clean
# -----------------------------------------------------------------------------

rgf_a05_clean <- rgf_a05_clean %>%
  mutate(
    demais_obrigacoes_financeiras_clean = case_when(
      linhas == "7_fundos_orgaos_programa" ~ 
        demais_obrigacoes_new - demais_obrigacoes_subtracao,
      
      TRUE ~ 
        demais_obrigacoes_new - demais_obrigacoes_subtracao + 
        conta_894310000_disp_recursos_ted_liberar - 
        conta_894320000_disp_recursos_ted_receber
    )
  )

# -----------------------------------------------------------------------------
# Ler Disponibilidade Inicial (arquivo auxiliar)
# -----------------------------------------------------------------------------

# Verificar se arquivo existe
arquivo_disp_inicial <- "disponibilidade_inicial.xlsx"

if (file.exists(arquivo_disp_inicial)) {
  # Ler aba Uni√£o
  disp_inicial_uniao <- read_excel(arquivo_disp_inicial, sheet = "uniao") %>%
    mutate(abrangencia = "uniao")
  
  # Ler aba Executivo
  disp_inicial_executivo <- read_excel(arquivo_disp_inicial, sheet = "executivo") %>%
    mutate(abrangencia = "executivo")
  
  # Combinar as duas abas
  disponibilidade_inicial <- bind_rows(disp_inicial_uniao, disp_inicial_executivo)
  
  # Join com dados processados
  rgf_a05_clean <- rgf_a05_clean %>%
    left_join(disponibilidade_inicial, by = c("linhas", "abrangencia"))
  
  cat("‚úÖ Disponibilidade inicial carregada\n")
} else {
  # Criar coluna com zeros se arquivo n√£o existir
  rgf_a05_clean <- rgf_a05_clean %>%
    mutate(disponibilidade_inicial = 0)
  
  cat("‚ö†Ô∏è Arquivo disponibilidade_inicial.xlsx n√£o encontrado - usando zeros\n")
}

# -----------------------------------------------------------------------------
# Calcular Demais Fluxos Clean
# -----------------------------------------------------------------------------

rgf_a05_clean <- rgf_a05_clean %>%
  mutate(
    demais_fluxos_clean = 
      disponibilidade_inicial + 
      receitas - 
      despesas - 
      disponibilidade_bruta_clean
  )

# -----------------------------------------------------------------------------
# Calcular Disponibilidade Antes da Inscri√ß√£o de RP
# -----------------------------------------------------------------------------

rgf_a05_clean <- rgf_a05_clean %>%
  mutate(
    disponibilidade_antes_inscr_rp_clean = 
      disponibilidade_bruta_clean - 
      rp_liquidados_nao_pagos_exercicios_anteriores - 
      rp_empenhados_nao_liquidados_exercicios_anteriores - 
      rp_liquidados_nao_pagos_exercicio - 
      demais_obrigacoes_financeiras_clean
  )

cat("‚úÖ C√°lculos conclu√≠dos\n")
```

## Resultados Finais

```{r resultado-final-rgf-a05}
#| code-fold: true
#| code-summary: "Ver c√≥digo de resultados"

# =============================================================================
# PREPARAR RESULTADOS FINAIS
# =============================================================================

# -----------------------------------------------------------------------------
# Selecionar e ordenar colunas finais
# -----------------------------------------------------------------------------

rgf_a05_final <- rgf_a05_clean %>%
  select(
    mes_lancamento,
    linhas,
    abrangencia,
    disponibilidade_inicial,
    receitas,
    despesas,
    demais_fluxos_clean,
    disponibilidade_bruta_clean,
    rp_liquidados_nao_pagos_exercicios_anteriores,
    rp_liquidados_nao_pagos_exercicio,
    rp_empenhados_nao_liquidados_exercicios_anteriores,
    demais_obrigacoes_financeiras_clean,
    disponibilidade_antes_inscr_rp_clean
  ) %>%
  arrange(abrangencia, linhas)

# -----------------------------------------------------------------------------
# Separar Uni√£o e Executivo
# -----------------------------------------------------------------------------

rgf_a05_resultado_uniao <- rgf_a05_final %>%
  filter(abrangencia == "uniao") %>%
  select(-abrangencia)

rgf_a05_resultado_executivo <- rgf_a05_final %>%
  filter(abrangencia == "executivo") %>%
  select(-abrangencia)

# -----------------------------------------------------------------------------
# Fun√ß√£o para formatar tabelas
# -----------------------------------------------------------------------------

formatar_tabela_a05 <- function(df) {
  df %>% 
    filter(linhas != "outros") %>% 
    adorn_totals("row") %>%
    mutate(
      across(
        where(is.numeric) & !matches("mes_lancamento"),
        ~ round(.x, 2)
      )
    )
}

rgf_a05_uniao_formatada <- formatar_tabela_a05(rgf_a05_resultado_uniao)
rgf_a05_executivo_formatada <- formatar_tabela_a05(rgf_a05_resultado_executivo)

# =============================================================================
# CALCULAR TOTAIS PARA VARI√ÅVEIS GLOBAIS
# =============================================================================

# Total de Disponibilidade - Uni√£o
valor_disponibilidade_uniao <- rgf_a05_uniao_formatada %>%
  filter(linhas == "Total") %>%
  pull(disponibilidade_antes_inscr_rp_clean)

# Total de Disponibilidade - Executivo
valor_disponibilidade_executivo <- rgf_a05_executivo_formatada %>%
  filter(linhas == "Total") %>%
  pull(disponibilidade_antes_inscr_rp_clean)

cat(sprintf("\n‚úÖ Disponibilidade Final - Uni√£o: R$ %s\n", 
            formatar_numero(valor_disponibilidade_uniao)))
cat(sprintf("‚úÖ Disponibilidade Final - Executivo: R$ %s\n", 
            formatar_numero(valor_disponibilidade_executivo)))
```

### Tabela Uni√£o (Todos os Poderes)

```{r tabela-uniao-rgf-a05}
#| column: screen

# =============================================================================
# TABELA UNI√ÉO
# =============================================================================

# Preparar nomes das colunas
novos_nomes <- rgf_a05_uniao_formatada %>% 
  select(-mes_lancamento) %>% 
  colnames() %>%
  gsub("_clean", "", .) %>%
  gsub("_", " ", .) %>%
  gsub("nao pagos", "NP", .) %>%
  gsub("exercicios", "exerc.", .) %>%
  gsub("anteriores", "ant.", .) %>%
  gsub("liquidados", "liq.", .) %>%
  gsub("empenhados", "emp.", .) %>%
  gsub("disponibilidade", "disp.", .)

datatable(
  rgf_a05_uniao_formatada %>% select(-mes_lancamento),
  colnames = novos_nomes,
  caption = "RGF Anexo 05 - UNI√ÉO (Todos os Poderes)",
  options = list(scrollX = TRUE, pageLength = 15),
  rownames = FALSE
) %>%
  formatCurrency(2:11, "", mark = ".", dec.mark = ",", digits = 2)
```

### Tabela Poder Executivo

```{r tabela-executivo-rgf-a05}
#| column: screen

# =============================================================================
# TABELA EXECUTIVO
# =============================================================================

datatable(
  rgf_a05_executivo_formatada %>% select(-mes_lancamento),
  colnames = novos_nomes,
  caption = "RGF Anexo 05 - PODER EXECUTIVO (exceto DPU e MPU)",
  options = list(scrollX = TRUE, pageLength = 15),
  rownames = FALSE
) %>%
  formatCurrency(2:11, "", mark = ".", dec.mark = ",", digits = 2)
```

## Notas Metodol√≥gicas

```{r notas-rgf-a05}
#| echo: false

# =============================================================================
# NOTAS METODOL√ìGICAS
# =============================================================================

notas <- tibble::tribble(
  ~Item, ~Descri√ß√£o,
  "1", "Valores em R$ (reais)",
  "2", "ISF = F indica item Financeiro",
  "3", "Uni√£o inclui todos os poderes e √≥rg√£os",
  "4", "Executivo exclui DPU (34000) e MPU (59000)",
  "5", "Disponibilidade inicial vem de arquivo auxiliar externo",
  "6", "Linhas s√£o classificadas por fonte de recursos",
  "7", "TEDs s√£o ajustados na linha 'Fundos, √ìrg√£os e Programas'",
  "8", "Recursos a Classificar t√™m dedu√ß√£o espec√≠fica"
)

knitr::kable(notas, col.names = c("Item", "Descri√ß√£o"))
```

## Observa√ß√µes Importantes

::: {.callout-warning}
### Complexidade do Anexo

O RGF Anexo 05 √© um dos anexos mais complexos, envolvendo:

- **M√∫ltiplos arquivos** segmentados por fonte de recursos
- **Classifica√ß√£o de linhas** baseada em fontes
- **Duas abrang√™ncias** (Uni√£o e Executivo)
- **22 crit√©rios** de classifica√ß√£o
- **Arquivo externo** de disponibilidade inicial
:::

::: {.callout-note}
### Arquivo de Disponibilidade Inicial

O arquivo `disponibilidade_inicial.xlsx` deve conter duas abas:

- **uniao**: Disponibilidade inicial para a Uni√£o
- **executivo**: Disponibilidade inicial para o Poder Executivo

Cada aba deve ter as colunas: `linhas` e `disponibilidade_inicial`
:::

::: {.callout-tip}
### Principais Contas Cont√°beis

- **111***: Disponibilidades (caixa e equivalentes)
- **2***: Passivos (obriga√ß√µes)
- **631***: Restos a Pagar n√£o processados
- **632***: Restos a Pagar processados
- **894***: TEDs a liberar/receber
:::


# üìã RREO Anexo 01 - Balan√ßo Or√ßament√°rio {#sec-rreo-a01}

## Ficha T√©cnica

```{r ficha-tecnica-rreo-a01}
#| echo: false

# =============================================================================
# FICHA T√âCNICA DO ANEXO
# =============================================================================

ficha_tecnica <- tibble::tribble(
  ~Campo,                 ~Informa√ß√£o,
  "Relat√≥rio",            "RREO - Relat√≥rio Resumido da Execu√ß√£o Or√ßament√°ria",
  "Anexo",                "Anexo 01",
  "Nome",                 "Balan√ßo Or√ßament√°rio",
  "Base Legal",           "LRF Art. 52, inciso I e II, al√≠neas 'a' e 'b'",
  "Periodicidade",        "Bimestral",
  "Grau de Dificuldade",  "‚≠ê‚≠ê‚≠ê‚≠ê Dif√≠cil",
  "√öltima Atualiza√ß√£o",   format(Sys.Date(), "%d/%m/%Y")
)

knitr::kable(ficha_tecnica, col.names = c("Campo", "Informa√ß√£o"))
```

## Arquivos Necess√°rios

```{r arquivos-rreo-a01}
#| echo: false

# =============================================================================
# ARQUIVOS DO TESOURO GERENCIAL UTILIZADOS
# =============================================================================

arquivos <- tibble::tribble(
  ~Arquivo,                              ~Descri√ß√£o,                          ~Filtros_TG,
  "tg_receita_liquida.xlsx",             "Receitas realizadas",               "Or√ß. Fiscal, Item Informa√ß√£o",
  "tg_receita_previsao.xlsx",            "Previs√£o de receitas",              "Or√ß. Fiscal, Item Informa√ß√£o",
  "tg_despesa_dotacao_inicial.xlsx",     "Dota√ß√£o inicial de despesas",       "Or√ß. Fiscal",
  "tg_despesa_dotacao_atualizada_*.xlsx", "Dota√ß√£o atualizada (partes)",      "Or√ß. Fiscal",
  "tg_despesa_despesas_empenhadas_*.xlsx", "Despesas empenhadas (partes)",    "Or√ß. Fiscal",
  "tg_despesa_despesas_liquidadas.xlsx", "Despesas liquidadas",               "Or√ß. Fiscal",
  "tg_despesa_pagamentos_totais.xlsx",   "Despesas pagas",                    "Or√ß. Fiscal"
)

knitr::kable(arquivos, col.names = c("Arquivo", "Descri√ß√£o", "Filtros no TG"))
```

## Atributos Utilizados

### Receitas

```{r atributos-receitas-rreo-a01}
#| echo: false

# =============================================================================
# ATRIBUTOS DE RECEITAS
# =============================================================================

atributos_receitas <- tibble::tribble(
  ~Atributo,                               ~Tipo,       ~Uso,                  ~Descri√ß√£o,
  "nre1_categoria_economica_codigo",       "numeric",   "TG / Crit√©rio",       "Categoria econ√¥mica (1=Corrente, 2=Capital, 7/8=Intra)",
  "nre2_origem_receita_codigo_origem",     "numeric",   "TG / Crit√©rio",       "Origem da receita (1-9)",
  "nre3_especie_receita_codigo_especie",   "numeric",   "TG / Crit√©rio",       "Esp√©cie da receita",
  "natureza_receita_codigo_completo",      "character", "TG / Crit√©rio",       "C√≥digo completo da natureza de receita",
  "item_informacao_codigo",                "character", "TG / Crit√©rio",       "C√≥digo do item (1=Prev.Inicial, 2=Prev.Atualizada, 5=Realizada)",
  "item_informacao_nome",                  "character", "TG / Apresenta√ß√£o",   "Nome do item de informa√ß√£o",
  "mes_lancamento",                        "numeric",   "TG / R",              "M√™s do lan√ßamento (YYYYMM)",
  "saldo_r_item_informacao",               "numeric",   "TG / R",              "Saldo do item de informa√ß√£o"
)

knitr::kable(atributos_receitas, col.names = c("Atributo", "Tipo", "Uso", "Descri√ß√£o"))
```

### Despesas

```{r atributos-despesas-rreo-a01}
#| echo: false

# =============================================================================
# ATRIBUTOS DE DESPESAS
# =============================================================================

atributos_despesas <- tibble::tribble(
  ~Atributo,                               ~Tipo,       ~Uso,                  ~Descri√ß√£o,
  "categoria_economica_despesa_codigo",    "numeric",   "TG / Crit√©rio",       "Categoria econ√¥mica (3=Corrente, 4=Capital, 9=Reserva)",
  "grupo_despesa_codigo_grupo",            "numeric",   "TG / Crit√©rio",       "Grupo de despesa (1-6)",
  "modalidade_aplicacao_codigo",           "character", "TG / Crit√©rio",       "Modalidade de aplica√ß√£o (91=Intra)",
  "elemento_despesa_codigo",               "character", "TG / Crit√©rio",       "Elemento de despesa",
  "subfuncao_governo_codigo",              "character", "TG / Crit√©rio",       "Subfun√ß√£o de governo",
  "fonte_recursos_codigo",                 "character", "TG / Crit√©rio",       "Fonte de recursos",
  "unidade_orcamentaria_codigo",           "character", "TG / Crit√©rio",       "C√≥digo da unidade or√ßament√°ria",
  "item_informacao_codigo",                "character", "TG / Crit√©rio",       "C√≥digo do item de informa√ß√£o",
  "mes_lancamento",                        "numeric",   "TG / R",              "M√™s do lan√ßamento (YYYYMM)",
  "saldo_r_item_informacao",               "numeric",   "TG / R",              "Saldo do item de informa√ß√£o"
)

knitr::kable(atributos_despesas, col.names = c("Atributo", "Tipo", "Uso", "Descri√ß√£o"))
```

## V√≠nculos com Outros Anexos

```{r vinculos-rreo-a01}
#| echo: false

# =============================================================================
# RELACIONAMENTO COM OUTROS ANEXOS
# =============================================================================

vinculos <- tibble::tribble(
  ~Anexo_Relacionado,   ~Tipo_V√≠nculo,    ~Descri√ß√£o,
  "RREO Anexo 03",      "Refer√™ncia",     "RCL utiliza receitas correntes",
  "RREO Anexo 06",      "Refer√™ncia",     "Resultado prim√°rio utiliza receitas e despesas",
  "RREO Anexo 07",      "Refer√™ncia",     "Restos a pagar utiliza despesas"
)

knitr::kable(vinculos, col.names = c("Anexo Relacionado", "Tipo de V√≠nculo", "Descri√ß√£o"))
```

## Estrutura do Demonstrativo

### Receitas

```{r estrutura-receitas-rreo-a01}
#| echo: false

# =============================================================================
# ESTRUTURA - RECEITAS
# =============================================================================

estrutura_receitas <- tibble::tribble(
  ~Ordem, ~Item,                                           ~Grupo,
  "01",   "RECEITAS CORRENTES (I)",                        "Receitas Correntes",
  "02",   "Impostos, Taxas e Contribui√ß√µes de Melhoria",   "Receitas Correntes",
  "03",   "Impostos",                                      "Receitas Correntes",
  "04",   "Taxas",                                         "Receitas Correntes",
  "05",   "Contribui√ß√µes",                                 "Receitas Correntes",
  "06",   "Contribui√ß√µes Sociais",                         "Receitas Correntes",
  "07",   "Contribui√ß√µes de Interven√ß√£o no Dom√≠nio Econ.", "Receitas Correntes",
  "08",   "Receita Patrimonial",                           "Receitas Correntes",
  "16",   "Receita Agropecu√°ria",                          "Receitas Correntes",
  "17",   "Receita Industrial",                            "Receitas Correntes",
  "18",   "Receitas de Servi√ßos",                          "Receitas Correntes",
  "24",   "Transfer√™ncias Correntes",                      "Receitas Correntes",
  "32",   "Outras Receitas Correntes",                     "Receitas Correntes",
  "39",   "RECEITAS DE CAPITAL (II)",                      "Receitas de Capital",
  "40",   "Opera√ß√µes de Cr√©dito",                          "Receitas de Capital",
  "43",   "Aliena√ß√£o de Bens",                             "Receitas de Capital",
  "47",   "Amortiza√ß√µes de Empr√©stimos",                   "Receitas de Capital",
  "48",   "Transfer√™ncias de Capital",                     "Receitas de Capital",
  "55",   "Outras Receitas de Capital",                    "Receitas de Capital",
  "58",   "RECEITAS CORRENTES INTRA (I-I)",                "Receitas Intra",
  "79",   "SUBTOTAL DAS RECEITAS (III) = (I + II)",        "Subtotais",
  "80",   "OPERA√á√ïES DE CR√âDITO - REFINANCIAMENTO (IV)",   "Refinanciamento",
  "85",   "SUBTOTAL COM REFINANCIAMENTO (V) = (III + IV)", "Subtotais"
)

knitr::kable(estrutura_receitas, col.names = c("Ordem", "Item", "Grupo"))
```

### Despesas

```{r estrutura-despesas-rreo-a01}
#| echo: false

# =============================================================================
# ESTRUTURA - DESPESAS
# =============================================================================

estrutura_despesas <- tibble::tribble(
  ~Ordem, ~Item,                                              ~Grupo,
  "01",   "DESPESAS (Exceto Intra-Or√ßament√°rias) (IX)",       "Despesas",
  "02",   "Despesas Correntes",                               "Despesas Correntes",
  "03",   "Pessoal e Encargos Sociais",                       "Despesas Correntes",
  "04",   "Juros e Encargos da D√≠vida",                       "Despesas Correntes",
  "05",   "Outras Despesas Correntes",                        "Despesas Correntes",
  "06",   "Transfer√™ncia a Estados, DF e Munic√≠pios",         "Despesas Correntes",
  "07",   "Benef√≠cios Previdenci√°rios",                       "Despesas Correntes",
  "08",   "Demais Despesas Correntes",                        "Despesas Correntes",
  "09",   "Despesas de Capital",                              "Despesas de Capital",
  "10",   "Investimentos",                                    "Despesas de Capital",
  "11",   "Invers√µes Financeiras",                            "Despesas de Capital",
  "12",   "Amortiza√ß√£o da D√≠vida",                            "Despesas de Capital",
  "13",   "Reserva de Conting√™ncia",                          "Reserva",
  "14",   "DESPESAS INTRA-OR√áAMENT√ÅRIAS (X)",                 "Despesas Intra",
  "26",   "SUBTOTAL DAS DESPESAS (XI) = (IX + X)",            "Subtotais",
  "27",   "AMORTIZA√á√ÉO DA D√çVIDA - REFINANCIAMENTO (XII)",    "Refinanciamento",
  "34",   "SUBTOTAL COM REFINANCIAMENTO (XIII) = (XI + XII)", "Subtotais"
)

knitr::kable(estrutura_despesas, col.names = c("Ordem", "Item", "Grupo"))
```

## Importa√ß√£o dos Dados

### Receitas

```{r importar-receitas-rreo-a01}
#| code-fold: true
#| code-summary: "Ver c√≥digo de importa√ß√£o - Receitas"

# =============================================================================
# IMPORTA√á√ÉO DOS DADOS DE RECEITAS
# =============================================================================
# Dois arquivos principais:
#   1. tg_receita_liquida.xlsx - Receitas realizadas
#   2. tg_receita_previsao.xlsx - Previs√£o de receitas
# =============================================================================

cat("üì• Importando dados de receitas...\n")

# -----------------------------------------------------------------------------
# Definir arquivos a importar
# -----------------------------------------------------------------------------

arquivos_receita <- c(
  str_c(mes_pasta, "tg_receita_liquida.xlsx"),
  str_c(mes_pasta, "tg_receita_previsao.xlsx")
)

# -----------------------------------------------------------------------------
# Importar em paralelo
# -----------------------------------------------------------------------------

dados_receita <- importar_excel_paralelo(
  arquivos = arquivos_receita, 
  skip = 5, 
  .progress = TRUE
) %>%
  # Filtrar apenas or√ßamento fiscal
  filter(orgao_uge_orcam_fiscal_s_n == "PERTENCE") %>%
  mutate(
    # Convers√£o de data
    mes_lancamento = as.numeric(mes_lancamento),
    data_lancamento = ceiling_date(
      ymd(paste0(mes_lancamento, "01")), 
      "month"
    ) - days(1),
    
    # Vari√°veis derivadas - tipo_modalidade
    tipo_modalidade = ifelse(
      nre1_categoria_economica_codigo %in% c(7, 8), 
      "intra", 
      "exceto intra"
    ),
    
    # Vari√°veis derivadas - refinanciamento
    refinanciamento = ifelse(
      natureza_receita_codigo_completo %in% c(81110201, 21110201, 21210201), 
      "sim", 
      "nao"
    )
  )

cat(sprintf("‚úÖ Dados de receita: %s registros\n", 
            format(nrow(dados_receita), big.mark = ".", decimal.mark = ",")))
```

### Despesas

```{r importar-despesas-rreo-a01}
#| code-fold: true
#| code-summary: "Ver c√≥digo de importa√ß√£o - Despesas"

# =============================================================================
# IMPORTA√á√ÉO DOS DADOS DE DESPESAS
# =============================================================================
# M√∫ltiplos arquivos com padr√£o 'tg_despesa_*'
# =============================================================================

cat("üì• Importando dados de despesas...\n")

# -----------------------------------------------------------------------------
# Buscar todos os arquivos de despesa
# -----------------------------------------------------------------------------

arq_despesa <- list.files(
  path = mes_pasta, 
  pattern = 'tg_despesa', 
  full.names = TRUE
)

cat(sprintf("   Encontrados %d arquivos\n", length(arq_despesa)))

# -----------------------------------------------------------------------------
# Importar em paralelo
# -----------------------------------------------------------------------------

dados_despesa <- importar_excel_paralelo(
  arquivos = arq_despesa, 
  skip = 5, 
  .progress = TRUE
) %>%
  # Filtrar apenas or√ßamento fiscal
  filter(orgao_uge_orcam_fiscal_s_n == "PERTENCE") %>%
  mutate(
    # Converter colunas num√©ricas
    across(contains("saldo"), as.numeric),
    across(contains("valor"), as.numeric),
    mes_lancamento = as.numeric(mes_lancamento),
    
    # Convers√£o de data
    data_lancamento = ceiling_date(
      ymd(paste0(mes_lancamento, "01")), 
      "month"
    ) - days(1),
    
    # Vari√°veis derivadas - tipo_modalidade
    tipo_modalidade = ifelse(
      modalidade_aplicacao_codigo == 91,
      "intra",
      "exceto intra"
    ),
    
    # Vari√°veis derivadas - refinanciamento
    refinanciamento = case_when(
      grupo_despesa_codigo_grupo == 6 &
        elemento_despesa_codigo %in% c(76, 77) &
        subfuncao_governo_codigo %in% c(841, 842, 843, 844, 846) &
        fonte_recursos_codigo == "443" ~ "sim",
      TRUE ~ "nao"
    ),
    
    # Vari√°veis derivadas - poder
    poder = case_when(
      orgao_uge_orgao_maximo_codigo %in% c(59000) ~ "MINIST√âRIO P√öBLICO DA UNI√ÉO",
      orgao_uge_orgao_maximo_codigo %in% c(29000) ~ "DEFENSORIA P√öBLICA",
      TRUE ~ orgao_uge_poder_nome
    ),
    
    # Vari√°veis derivadas - transferencia
    transferencia = ifelse(
      modalidade_aplicacao_codigo %in% c('30', '31', '32', '35', '36', '40', '41', '42', '45', '46'), 
      "_transferencia", 
      "aplicacao_direta"
    )
  )

cat(sprintf("‚úÖ Dados de despesa: %s registros\n", 
            format(nrow(dados_despesa), big.mark = ".", decimal.mark = ",")))
```

## Crit√©rios de Classifica√ß√£o

### Receitas

```{r criterios-receitas-rreo-a01}
#| code-fold: true
#| code-summary: "Ver crit√©rios - Receitas"

# =============================================================================
# CRIT√âRIOS RREO ANEXO 01 - RECEITAS
# =============================================================================
# 85 crit√©rios para classifica√ß√£o das receitas or√ßament√°rias
# =============================================================================

criterios_rreo_A01_receitas_bo <- list(
  
  # ===========================================================================
  # RECEITAS CORRENTES
  # ===========================================================================
  
  `01_receitas_correntes` = list(
    criterio = "nre1_categoria_economica_codigo == 1"
  ),
  
  `02_impostos_taxas_contrib_melhoria` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 1 &
    nre3_especie_receita_codigo_especie %in% c(1, 2, 3)
    "
  ),
  
  `03_impostos` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 1 &
    nre3_especie_receita_codigo_especie == 1
    "
  ),
  
  `04_taxas` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 1 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  `05_contribuicoes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 2
    "
  ),
  
  `06_contribuicoes_sociais` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 2 &
    nre3_especie_receita_codigo_especie == 1
    "
  ),
  
  `07_contrib_intervencao_dominio_economico` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 2 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  `08_receita_patrimonial` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3
    "
  ),
  
  `09_exploracao_patrimonio_imobiliario` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3 &
    nre3_especie_receita_codigo_especie == 1
    "
  ),
  
  `10_valores_mobiliarios` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  `11_delegacao_servicos_publicos` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3 &
    nre3_especie_receita_codigo_especie == 3
    "
  ),
  
  `12_exploracao_recursos_naturais` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3 &
    nre3_especie_receita_codigo_especie == 4
    "
  ),
  
  `13_exploracao_patrimonio_intangivel` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3 &
    nre3_especie_receita_codigo_especie == 5
    "
  ),
  
  `14_cessao_direitos` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3 &
    nre3_especie_receita_codigo_especie == 6
    "
  ),
  
  `15_demais_receitas_patrimoniais` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3 &
    nre3_especie_receita_codigo_especie == 9
    "
  ),
  
  `16_receita_agropecuaria` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 4
    "
  ),
  
  `17_receita_industrial` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 5
    "
  ),
  
  `18_receitas_servicos` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 6
    "
  ),
  
  `19_servicos_admin_comerciais` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '161')"
  ),
  
  `20_servicos_navegacao_transporte` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '162')"
  ),
  
  `21_servicos_saude` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '163')"
  ),
  
  `22_servicos_financeiros` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '164')"
  ),
  
  `23_outros_servicos` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '169')"
  ),
  
  # ---------------------------------------------------------------------------
  # TRANSFER√äNCIAS CORRENTES
  # ---------------------------------------------------------------------------
  
  `24_transferencias_correntes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 7
    "
  ),
  
  `25_transf_uniao_entidades` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 7 &
    nre3_especie_receita_codigo_especie == 1
    "
  ),
  
  `26_transf_estados_df_entidades` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 7 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  `27_transf_municipios_entidades` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 7 &
    nre3_especie_receita_codigo_especie == 3
    "
  ),
  
  `28_transf_instituicoes_privadas` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 7 &
    nre3_especie_receita_codigo_especie == 4
    "
  ),
  
  `29_transf_outras_instituicoes_publicas` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 7 &
    nre3_especie_receita_codigo_especie == 5
    "
  ),
  
  `30_transf_exterior` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 7 &
    nre3_especie_receita_codigo_especie == 6
    "
  ),
  
  `31_demais_transf_correntes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 7 &
    nre3_especie_receita_codigo_especie == 9
    "
  ),
  
  # ---------------------------------------------------------------------------
  # OUTRAS RECEITAS CORRENTES
  # ---------------------------------------------------------------------------
  
  `32_outras_receitas_correntes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 9
    "
  ),
  
  `33_multas_admin_contratuais` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 9 &
    nre3_especie_receita_codigo_especie == 1
    "
  ),
  
  `34_indenizacoes_restituicoes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 9 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  `35_bens_direitos_valores` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 9 &
    nre3_especie_receita_codigo_especie == 3
    "
  ),
  
  `36_multas_juros_mora_capital` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 9 &
    nre3_especie_receita_codigo_especie == 4
    "
  ),
  
  `37_demais_receitas_correntes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 9 &
    nre3_especie_receita_codigo_especie == 9
    "
  ),
  
  `38_receitas_correntes_classificar` = list(
    criterio = "
    nre2_origem_receita_codigo_origem == 8 &
    nre3_especie_receita_codigo_especie == 8
    "
  ),
  
  # ===========================================================================
  # RECEITAS DE CAPITAL
  # ===========================================================================
  
  `39_receitas_capital` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 &
    !(startsWith(natureza_receita_codigo_completo, '21110201') |
      startsWith(natureza_receita_codigo_completo, '21210201'))
    "
  ),
  
  `40_operacoes_credito` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 1 &
    !(startsWith(natureza_receita_codigo_completo, '21110201') |
      startsWith(natureza_receita_codigo_completo, '21210201'))
    "
  ),
  
  `41_operacoes_credito_internas` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 1 &
    nre3_especie_receita_codigo_especie == 1 &
    !startsWith(natureza_receita_codigo_completo, '21110201')
    "
  ),
  
  `42_operacoes_credito_externas` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 1 &
    nre3_especie_receita_codigo_especie == 2 &
    !startsWith(natureza_receita_codigo_completo, '21210201')
    "
  ),
  
  `43_alienacao_bens` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 2
    "
  ),
  
  `44_alienacao_bens_moveis` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 2 &
    nre3_especie_receita_codigo_especie == 1
    "
  ),
  
  `45_alienacao_bens_imoveis` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 2 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  `46_alienacao_bens_intangiveis` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '223')"
  ),
  
  `47_amortizacoes_emprestimos` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 3
    "
  ),
  
  `48_transferencias_capital` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 4
    "
  ),
  
  `55_outras_receitas_capital` = list(
    criterio = "
    nre2_origem_receita_codigo_origem == 9 &
    nre1_categoria_economica_codigo == 2
    "
  ),
  
  `56_resultado_banco_central` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 9 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  `57_remuneracao_disponibilidades_tesouro` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '293')"
  ),
  
  # ===========================================================================
  # RECEITAS INTRA-OR√áAMENT√ÅRIAS
  # ===========================================================================
  
  `58_receitas_correntes_intra` = list(
    criterio = "nre1_categoria_economica_codigo == 7"
  ),
  
  # ===========================================================================
  # SUBTOTAIS E REFINANCIAMENTO
  # ===========================================================================
  
  `79_subtotal_receitas` = list(
    criterio = "
    nre1_categoria_economica_codigo %in% c(1, 2, 7, 8) &
    !(startsWith(natureza_receita_codigo_completo, '21110201') |
      startsWith(natureza_receita_codigo_completo, '21210201') |
      startsWith(natureza_receita_codigo_completo, '81110201') |
      startsWith(natureza_receita_codigo_completo, '81210201'))
    "
  ),
  
  `80_operacoes_credito_refinanciamento` = list(
    criterio = "
    startsWith(natureza_receita_codigo_completo, '21110201') |
    startsWith(natureza_receita_codigo_completo, '21210201') |
    startsWith(natureza_receita_codigo_completo, '81110201') |
    startsWith(natureza_receita_codigo_completo, '81210201')
    "
  ),
  
  `81_operacoes_credito_internas_refinanciamento` = list(
    criterio = "
    startsWith(natureza_receita_codigo_completo, '21110201') |
    startsWith(natureza_receita_codigo_completo, '81110201')
    "
  ),
  
  `85_subtotal_com_refinanciamento` = list(
    criterio = "nre1_categoria_economica_codigo %in% c(1, 2, 7, 8)"
  )
)

cat("‚úÖ Crit√©rios de Receitas definidos\n")
cat(sprintf("   Total de categorias: %d\n", length(criterios_rreo_A01_receitas_bo)))
```

### Despesas

```{r criterios-despesas-rreo-a01}
#| code-fold: true
#| code-summary: "Ver crit√©rios - Despesas"

# =============================================================================
# CRIT√âRIOS RREO ANEXO 01 - DESPESAS
# =============================================================================
# 34 crit√©rios para classifica√ß√£o das despesas or√ßament√°rias
# =============================================================================

criterios_rreo_A01_despesas_bo <- list(
  
  # ===========================================================================
  # DESPESAS (EXCETO INTRA-OR√áAMENT√ÅRIAS)
  # ===========================================================================
  
  `01_despesas_exceto_intra` = list(
    criterio = "
    modalidade_aplicacao_codigo != 91 &
    !(elemento_despesa_codigo %in% c('76', '77') &
      subfuncao_governo_codigo %in% c('841', '842', '843', '844', '846') &
      fonte_recursos_codigo == '443')
    "
  ),
  
  # ---------------------------------------------------------------------------
  # DESPESAS CORRENTES
  # ---------------------------------------------------------------------------
  
  `02_despesas_correntes` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    modalidade_aplicacao_codigo != 91
    "
  ),
  
  `03_pessoal_encargos_sociais` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 1 &
    modalidade_aplicacao_codigo != 91
    "
  ),
  
  `04_juros_encargos_divida` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 2 &
    modalidade_aplicacao_codigo != 91
    "
  ),
  
  `05_outras_despesas_correntes` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 3 &
    modalidade_aplicacao_codigo != 91
    "
  ),
  
  `06_transferencia_estados_df_municipios` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 3 &
    modalidade_aplicacao_codigo %in% c('30', '31', '32', '40', '41', '42', '43', '44', '45', '46') &
    modalidade_aplicacao_codigo != 91
    "
  ),
  
  `07_beneficios_previdenciarios` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 3 &
    modalidade_aplicacao_codigo != 91 &
    unidade_orcamentaria_codigo %in% c('55902', '40904', '33904', '25917')
    "
  ),
  
  `08_demais_despesas_correntes` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 3 &
    modalidade_aplicacao_codigo != 91 &
    !(modalidade_aplicacao_codigo %in% c('30', '31', '32', '40', '41', '42', '43', '44', '45', '46')) &
    !(unidade_orcamentaria_codigo %in% c('55902', '40904', '33904', '25917'))
    "
  ),
  
  # ---------------------------------------------------------------------------
  # DESPESAS DE CAPITAL
  # ---------------------------------------------------------------------------
  
  `09_despesas_capital` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 &
    modalidade_aplicacao_codigo != 91 &
    !(elemento_despesa_codigo %in% c('76', '77') &
      subfuncao_governo_codigo %in% c('841', '842', '843', '844', '846') &
      fonte_recursos_codigo == '443')
    "
  ),
  
  `10_investimentos` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 &
    grupo_despesa_codigo_grupo == 4 &
    modalidade_aplicacao_codigo != 91
    "
  ),
  
  `11_inversoes_financeiras` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 &
    grupo_despesa_codigo_grupo == 5 &
    modalidade_aplicacao_codigo != 91
    "
  ),
  
  `12_amortizacao_divida` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 &
    grupo_despesa_codigo_grupo == 6 &
    modalidade_aplicacao_codigo != 91 &
    !(elemento_despesa_codigo %in% c('76', '77') &
      subfuncao_governo_codigo %in% c('841', '842', '843', '844', '846') &
      fonte_recursos_codigo == '443')
    "
  ),
  
  # ---------------------------------------------------------------------------
  # RESERVA DE CONTING√äNCIA
  # ---------------------------------------------------------------------------
  
  `13_reserva_contingencia` = list(
    criterio = "
    categoria_economica_despesa_codigo == 9 &
    modalidade_aplicacao_codigo != 91
    "
  ),
  
  # ===========================================================================
  # DESPESAS INTRA-OR√áAMENT√ÅRIAS
  # ===========================================================================
  
  `14_despesas_intra` = list(
    criterio = "modalidade_aplicacao_codigo == 91"
  ),
  
  `15_despesas_correntes_intra` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    modalidade_aplicacao_codigo == 91
    "
  ),
  
  `16_pessoal_encargos_sociais_intra` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 1 &
    modalidade_aplicacao_codigo == 91
    "
  ),
  
  `17_juros_encargos_divida_intra` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 2 &
    modalidade_aplicacao_codigo == 91
    "
  ),
  
  `18_outras_despesas_correntes_intra` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 3 &
    modalidade_aplicacao_codigo == 91
    "
  ),
  
  `21_despesas_capital_intra` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 &
    modalidade_aplicacao_codigo == 91
    "
  ),
  
  # ===========================================================================
  # SUBTOTAIS
  # ===========================================================================
  
  `26_subtotal_despesas` = list(
    criterio = "
    categoria_economica_despesa_codigo %in% c(3, 4, 9) &
    !(elemento_despesa_codigo %in% c('76', '77') &
      subfuncao_governo_codigo %in% c('841', '842', '843', '844', '846') &
      fonte_recursos_codigo == '443')
    "
  ),
  
  # ===========================================================================
  # REFINANCIAMENTO
  # ===========================================================================
  
  `27_amortizacao_divida_refinanciamento` = list(
    criterio = "
    grupo_despesa_codigo_grupo == 6 &
    elemento_despesa_codigo %in% c('76', '77') &
    subfuncao_governo_codigo %in% c('841', '842', '843', '844', '846') &
    fonte_recursos_codigo == '443'
    "
  ),
  
  `28_amortizacao_divida_interna` = list(
    criterio = "
    grupo_despesa_codigo_grupo == 6 &
    elemento_despesa_codigo %in% c('76', '77') &
    subfuncao_governo_codigo %in% c('841', '843', '846') &
    fonte_recursos_codigo == '443'
    "
  ),
  
  `29_divida_mobiliaria` = list(
    criterio = "
    grupo_despesa_codigo_grupo == 6 &
    elemento_despesa_codigo == '76' &
    subfuncao_governo_codigo %in% c('841', '843', '846') &
    fonte_recursos_codigo == '443'
    "
  ),
  
  `31_amortizacao_divida_externa` = list(
    criterio = "
    grupo_despesa_codigo_grupo == 6 &
    elemento_despesa_codigo %in% c('76', '77') &
    subfuncao_governo_codigo %in% c('842', '844') &
    fonte_recursos_codigo == '443'
    "
  ),
  
  `34_subtotal_com_refinanciamento` = list(
    criterio = "categoria_economica_despesa_codigo %in% c(3, 4, 9)"
  )
)

cat("‚úÖ Crit√©rios de Despesas definidos\n")
cat(sprintf("   Total de categorias: %d\n", length(criterios_rreo_A01_despesas_bo)))
```

## Aplica√ß√£o dos Crit√©rios

```{r aplicar-criterios-rreo-a01}
#| code-fold: true
#| code-summary: "Ver c√≥digo de aplica√ß√£o"

# =============================================================================
# APLICA√á√ÉO DOS CRIT√âRIOS
# =============================================================================

cat("üìä Processando crit√©rios do RREO Anexo 01...\n")

# -----------------------------------------------------------------------------
# Aplicar crit√©rios de Receitas
# -----------------------------------------------------------------------------

df_criterios_rreo_A01_receitas_bo <- aplicar_criterios(
  dados_receita, 
  criterios_rreo_A01_receitas_bo, 
  group_vars = c("item_informacao_codigo", "item_informacao_nome")
)

cat(sprintf("‚úÖ Receitas processadas: %d registros\n", nrow(df_criterios_rreo_A01_receitas_bo)))

# -----------------------------------------------------------------------------
# Aplicar crit√©rios de Despesas
# -----------------------------------------------------------------------------

df_criterios_rreo_A01_despesas_bo <- aplicar_criterios(
  dados_despesa, 
  criterios_rreo_A01_despesas_bo, 
  group_vars = c("item_informacao_codigo", "item_informacao_nome")
)

cat(sprintf("‚úÖ Despesas processadas: %d registros\n", nrow(df_criterios_rreo_A01_despesas_bo)))
```

## Resultados

### Receitas

```{r resultado-receitas-rreo-a01}
#| code-fold: true
#| column: page

# =============================================================================
# EXIBIR RECEITAS - Receita Realizada (item_informacao_codigo = 5)
# =============================================================================

receitas_realizadas <- df_criterios_rreo_A01_receitas_bo %>%
  filter(item_informacao_codigo == "5") %>%
  group_by(ordem, nome) %>%
  summarise(valor = sum(valor, na.rm = TRUE), .groups = "drop") %>%
  arrange(ordem)

datatable(
  receitas_realizadas,
  caption = "RREO Anexo 01 - Receitas Realizadas",
  rownames = FALSE,
  options = list(
    pageLength = 20,
    scrollX = TRUE,
    dom = 'tip'
  )
) %>% 
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")
```

### Despesas

```{r resultado-despesas-rreo-a01}
#| code-fold: true
#| column: page

# =============================================================================
# EXIBIR DESPESAS - Despesas Pagas (item_informacao_codigo = 25)
# =============================================================================

despesas_pagas <- df_criterios_rreo_A01_despesas_bo %>%
  filter(item_informacao_codigo == "25") %>%
  group_by(ordem, nome) %>%
  summarise(valor = sum(valor, na.rm = TRUE), .groups = "drop") %>%
  arrange(ordem)

datatable(
  despesas_pagas,
  caption = "RREO Anexo 01 - Despesas Pagas",
  rownames = FALSE,
  options = list(
    pageLength = 20,
    scrollX = TRUE,
    dom = 'tip'
  )
) %>% 
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")
```

## Resultado Or√ßament√°rio

```{r resultado-orcamentario-rreo-a01}
#| code-fold: true
#| code-summary: "Ver c√°lculo do resultado"

# =============================================================================
# C√ÅLCULO DO RESULTADO OR√áAMENT√ÅRIO
# =============================================================================

# Receita total com refinanciamento (linha 85, item 5)
receita_total <- df_criterios_rreo_A01_receitas_bo %>% 
  filter(ordem == "85", item_informacao_codigo == "5") %>% 
  summarise(valor = sum(valor, na.rm = TRUE)) %>%
  pull(valor)

# Despesa total com refinanciamento (linha 34, item 25)
despesa_total <- df_criterios_rreo_A01_despesas_bo %>% 
  filter(ordem == "34", item_informacao_codigo == "25") %>% 
  summarise(valor = sum(valor, na.rm = TRUE)) %>%
  pull(valor)

# Resultado or√ßament√°rio
resultado_orcamentario <- receita_total - despesa_total

# Exibir resultado
cat("\nüìä RESULTADO OR√áAMENT√ÅRIO\n")
cat("=========================\n\n")
cat(sprintf("Receita Total (com refinanc.): R$ %s\n", formatar_numero(receita_total)))
cat(sprintf("Despesa Total (com refinanc.): R$ %s\n", formatar_numero(despesa_total)))
cat(sprintf("RESULTADO OR√áAMENT√ÅRIO:        R$ %s\n", formatar_numero(resultado_orcamentario)))

if (resultado_orcamentario >= 0) {
  cat("\n‚úÖ SUPER√ÅVIT OR√áAMENT√ÅRIO\n")
} else {
  cat("\n‚ö†Ô∏è D√âFICIT OR√áAMENT√ÅRIO\n")
}
```

```{r tabela-resultado-rreo-a01}
#| echo: false

# =============================================================================
# TABELA RESUMO DO RESULTADO
# =============================================================================

df_resultado <- tibble(
  Tipo = c("Receita Total", "Despesa Total", "Resultado Or√ßament√°rio"),
  Valor = c(receita_total, despesa_total, resultado_orcamentario)
)

datatable(
  df_resultado,
  caption = "RREO Anexo 01 - Resultado Or√ßament√°rio",
  rownames = FALSE,
  options = list(
    pageLength = -1,
    dom = 't'
  )
) %>% 
  formatRound(c("Valor"), 2, mark = ".", dec.mark = ",")
```

## Notas Metodol√≥gicas

```{r notas-rreo-a01}
#| echo: false

# =============================================================================
# NOTAS METODOL√ìGICAS
# =============================================================================

notas <- tibble::tribble(
  ~Item, ~Descri√ß√£o,
  "1", "Valores em R$ (reais)",
  "2", "Receitas intra-or√ßament√°rias: categorias 7 e 8",
  "3", "Despesas intra-or√ßament√°rias: modalidade de aplica√ß√£o 91",
  "4", "Refinanciamento exclu√≠do dos subtotais principais",
  "5", "Item informa√ß√£o 5 = Receita Realizada",
  "6", "Item informa√ß√£o 25 = Despesas Pagas",
  "7", "Resultado = Receita - Despesa (positivo = super√°vit)"
)

knitr::kable(notas, col.names = c("Item", "Descri√ß√£o"))
```

## Observa√ß√µes Importantes

::: {.callout-note}
### Itens de Informa√ß√£o

Os principais itens de informa√ß√£o utilizados s√£o:

**Receitas:**
- **1**: Previs√£o Inicial
- **2**: Previs√£o Atualizada
- **5**: Receita Realizada

**Despesas:**
- **9**: Dota√ß√£o Inicial
- **23**: Dota√ß√£o Atualizada
- **10**: Despesas Empenhadas
- **18**: Despesas Liquidadas
- **25**: Despesas Pagas
:::

::: {.callout-warning}
### Refinanciamento da D√≠vida

As opera√ß√µes de refinanciamento s√£o tratadas separadamente:

- **Receitas de refinanciamento**: Naturezas que come√ßam com 21110201, 21210201, 81110201, 81210201
- **Despesas de refinanciamento**: Grupo 6 + Elementos 76/77 + Subfun√ß√µes 841-846 + Fonte 443

Estas opera√ß√µes s√£o inclu√≠das apenas no "Subtotal com Refinanciamento".
:::

::: {.callout-tip}
### Classifica√ß√£o da Despesa

A classifica√ß√£o de despesas utiliza m√∫ltiplos atributos:

- **Categoria Econ√¥mica**: 3 (Corrente), 4 (Capital), 9 (Reserva)
- **Grupo de Despesa**: 1-6
- **Modalidade de Aplica√ß√£o**: 91 indica intra-or√ßament√°ria
- **Elemento de Despesa**: 76/77 para refinanciamento
:::


# üìã RREO Anexo 02 - Fun√ß√£o e Subfun√ß√£o

```{r}
datatable(dados_despesa %>% group_by( refinanciamento) %>% filter(item_informacao_codigo == 23) %>% summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao)) %>% adorn_totals() )%>% formatRound("saldo_r_item_informacao", 2, mark = ".", dec.mark = "," )%>% 
  DT::formatStyle(columns = colnames(.$x$data), fontSize = '100%')

# datatable(dados_despesa %>% group_by(funcao_governo_codigo, funcao_governo_nome, refinanciamento) %>% filter(item_informacao_codigo == 23) %>% summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao)) %>% adorn_totals() )%>% formatRound("saldo_r_item_informacao", 2, mark = ".", dec.mark = "," )%>% 
#   DT::formatStyle(columns = colnames(.$x$data), fontSize = '75%')
```

# üìã RREO Anexo 03 - RCL

```{r}
#| code-fold: true
#| output: false


# ===============================================================================
# CRIT√âRIOS PARA RECEITAS - ANEXO 3 RCL
# ===============================================================================

criterios_rreo_A03_rcl_receitas_rcl <- list(
  
  # === RECEITAS CORRENTES POR ORIGEM (01-09) ===
  
  # IMPOSTOS, TAXAS E CONTRIBUI√á√ïES DE MELHORIA
  `01  Impostos, Taxas e Contribui√ß√µes de Melhoria` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 1"
  ),
  
  # RECEITA DE CONTRIBUI√á√ïES
  `02  Receita de Contribui√ß√µes` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 2"
  ),
  
  # RECEITA PATRIMONIAL
  `03  Receita Patrimonial` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 3"
  ),
  
  # RECEITA AGROPECU√ÅRIA
  `04  Receita Agropecu√°ria` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 4"
  ),
  
  # RECEITA INDUSTRIAL
  `05  Receita Industrial` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 5"
  ),
  
  # RECEITA DE SERVI√áOS
  `06  Receita de Servi√ßos` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 6"
  ),
  
  # TRANSFER√äNCIAS CORRENTES
  `07  Transfer√™ncias Correntes` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 7"
  ),
  
  # RECEITAS CORRENTES A CLASSIFICAR
  `08  Receitas Correntes a Classificar` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 8"
  ),
  
  # OUTRAS RECEITAS CORRENTES
  `09  Outras Receitas Correntes` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 9"
  ),
  
  # === ITENS ESPEC√çFICOS PARA C√ÅLCULO DA RCL ===
  
  # TRANSFER√äNCIAS CONSTITUCIONAIS E LEGAIS
  `10  Transfer√™ncias Constitucionais e Legais` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 7 & (
      grepl('FPE|FPM|CONSTITUCIONAL|LEGAL', natureza_receita_nome, ignore.case = TRUE) |
      grepl('^172[0-9]', natureza_receita_codigo_completo) |
      grepl('^171[0-9]', natureza_receita_codigo_completo)
    )
    "
  ),
  
  # CONTRIB. EMPREGADORES E TRAB. PARA SEG. SOCIAL
  `11  Contrib. Empregadores e Trabalhadores para Seguridade Social` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & fonte_recursos_codigo == '054' & 
    !natureza_receita_codigo_completo %in% c(
      '19900300', '19900310', '19900311', '19900312', '19900313', '19900314',
      '19990300', '19990301', '19990302', '19990303', '19990304'
    )
    "
  ),
  
  # CONTRIB. DO SERVIDOR PARA O PLANO DE PREVID√äNCIA
  `12  Contrib. Plano Seguridade Social do Servidor` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & (
      fonte_recursos_codigo %in% c('055', '056') |
      natureza_receita_codigo_completo == '12150116'
    )
    "
  ),
  
  # COMPENSA√á√ÉO FINANC. ENTRE REGIMES PREVID√äNCIA
  `13  Compensa√ß√£o Financeira entre Regimes RPPS` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & natureza_receita_codigo_completo %in% c(
      '19900300', '19900310', '19900311', '19900312', '19900313', '19900314',
      '19990300', '19990301', '19990302', '19990303', '19990304'
    )
    "
  ),
  
  # CONTRIB. DOS MILITARES PARA O CUSTEIO DAS PENS√ïES
  `14  Contrib. para Custeio Pens√µes Militares` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & (
      grepl('^1210051', natureza_receita_codigo_completo) |
      grepl('^1215041', natureza_receita_codigo_completo) |
      grepl('^121911', natureza_receita_codigo_completo)
    )
    "
  ),
  
  # CONTRIBUI√á√ïES PARA PIS/PASEP
  `15  Contribui√ß√£o para PIS/PASEP` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & (
      (grepl('^1210091|^1212', natureza_receita_codigo_completo) & 
       !fonte_recursos_codigo %in% c('055', '056', '054')) |
      (!grepl('^1210091|^1212', natureza_receita_codigo_completo) & 
       fonte_recursos_codigo %in% c('040', '041'))
    )
    "
  ),
  
  # DEDU√á√ïES DAS RECEITAS - CORRIGIDO
  `16  Dedu√ß√µes das Receitas` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & (
      (grepl('^1212', natureza_receita_codigo_completo) & fonte_recursos_codigo %in% c('031', '032', '040', '041')) |
      (grepl('^1214', natureza_receita_codigo_completo) & fonte_recursos_codigo == '054') |
      (grepl('^1215', natureza_receita_codigo_completo) & fonte_recursos_codigo %in% c('023', '032', '055', '056')) |
      (grepl('^1219', natureza_receita_codigo_completo) & fonte_recursos_codigo == '054') |
      (grepl('^1911', natureza_receita_codigo_completo) & fonte_recursos_codigo == '054') |
      (grepl('^1922', natureza_receita_codigo_completo) & fonte_recursos_codigo %in% c('040', '054', '056')) |
      (grepl('^1923', natureza_receita_codigo_completo) & fonte_recursos_codigo == '054') |
      (grepl('^1999', natureza_receita_codigo_completo) & fonte_recursos_codigo == '054')
    )
    "
  )
)


aplicar_criterios(rreo_a03_rcl_receitas , criterios_rreo_A03_rcl_receitas_rcl, group_vars = c("item_informacao_codigo"))


```

```{r}
#| code-fold: true
#| output: false
# ===============================================================================
# CRIT√âRIOS PARA DESPESAS (DEDU√á√ïES) - ANEXO 3 RCL
# ===============================================================================

criterios_rreo_A03_rcl_despesas_rcl <- list(
  
  # TRANSFER√äNCIAS CONSTITUCIONAIS E LEGAIS (DESPESAS)
  `17  Transfer√™ncias Constitucionais e Legais` = list(
    criterio = "
    (
      acao_governo_codigo %in% c('0044', '0045', '0046', '0050', '0051', '00H6', '006M', 
                                 '00G6', '0169', '0223', '0369', '0546', '0547', '0999', 
                                 '099B', '0A53', '0C03', '0C33', '0E25', '0E36', '00PX', 
                                 '00QR', '00S3', '00S7', '00S8', '00SE', '00RX', '00UH') &
      modalidade_aplicacao_codigo %in% c('30', '31', '32', '35', '36', '40', '41', '42', '45', '46') &
      programa_governo_codigo == '0903'
    ) |
    grepl('^28846090900RX', pt) |
    acao_governo_codigo %in% c('0E36', '00SB')
    "
  ),
  
  # OUTRAS DEDU√á√ïES (DESPESAS)
  `18  Outras Dedu√ß√µes` = list(
    criterio = "
    
    acao_governo_codigo %in% c('0E36', '00SB') | 
    grepl('^28846090900RX', programa_governo_codigo) | 
    (programa_governo_codigo %in% c('0903', '2030', '2080') & 
     modalidade_aplicacao_codigo %in% c(30, 31, 32, 35, 36, 40, 41, 42, 45, 46) & 
     acao_governo_codigo %in% c('0044', '0045', '0046', '0050', '0051', '00H6', '006M', 
                                '00G6', '0169', '0223', '0369', '0546', '0547', '0999', 
                                '099B', '0A53', '0C03', '0C33', '0E25', '0E36', '00PX', 
                                '00QR', '00S3', '00S7', '00S8', '00SE', '00RX', '00UH'))
    "
  )
)


criterios_rreo_A03_rcl_rp_cancelado_rcl <- list(
  
  `19 RP Cancelados de Transfer√™ncias Constitucionais e Legais` = list(
    criterio = "
    (
      acao_governo_codigo %in% c('0044', '0045', '0046', '0050', '0051', '00H6', '006M', 
                                 '00G6', '0169', '0223', '0369', '0546', '0547', '0999', 
                                 '099B', '0A53', '0C03', '0C33', '0E25', '0E36', '00PX', 
                                 '00QR', '00S3', '00S7', '00S8', '00SE', '00RX', '00UH') &
      modalidade_aplicacao_codigo %in% c('30', '31', '32', '35', '36', '40', '41', '42', '45', '46') &
      programa_governo_codigo == '0903'
    ) |
    grepl('^28846090900RX', pt) |
    acao_governo_codigo %in% c('0E36', '00SB')
    "
  )
)


aplicar_criterios(df = rreo_a03_rcl_despesas , criterios_rreo_A03_rcl_despesas_rcl, group_vars = c("item_informacao_codigo"))



aplicar_criterios(df = rreo_a03_rcl_despesas, criterios_rreo_A03_rcl_rp_cancelado_rcl, group_vars = c("item_informacao_codigo"))
```

```{r}



rcl <- rbind(df_criterios_rreo_A03_rcl_receitas_rcl ,df_criterios_rreo_A03_rcl_despesas_rcl%>% filter(item_informacao_codigo %in% c( "25", "27")))

rcl <- rbind(rcl,df_criterios_rreo_A03_rcl_rp_cancelado_rcl%>% filter(item_informacao_codigo == "51"))

rcl <- rcl   %>%
  mutate(
    tipo =
      case_when(
        ordem %in% c("01" , "02", "03", "04", "05", "06", "07", "08" , "09") ~ "receitas",
        ordem %in% c( "11" , "12", "13", "14", "15", "17" ) ~ "deducoes",
        ordem == "19" ~ "rp_cancelado",
        .default = "demais"
        
        )
  )


# minimo_saude <- (rcl%>%
#   filter(
#     year(data_lancamento) == year(ym(mes_filtro))
#   )  %>% group_by( tipo) %>% summarise(valor = sum(valor))  %>% pivot_wider(names_from = tipo, values_from = valor, values_fill = 0 ) %>% mutate(resultado = receitas - deducoes + rp_cancelado ) )$resultado* 0.15

rcl_12_meses <- rcl %>% 
  filter(
    ym(mes_filtro)-months(11)< data_lancamento &
     data_lancamento < ym(mes_filtro) +  months(1)
      )  %>% group_by( tipo, data_lancamento) %>% summarise(valor = sum(valor))  %>% pivot_wider(names_from = tipo, values_from = valor, values_fill = 0 ) %>% mutate(resultado = receitas - deducoes + rp_cancelado ) 


formatar_real <- function(valor, decimais = 2, prefixo = "R$ ") {
  paste0(prefixo, 
         format(valor, 
                big.mark = ".",
                decimal.mark = ",",
                nsmall = decimais,
                scientific = FALSE))
}


minimo_saude <- sum((rcl_12_meses %>% filter(year(data_lancamento) == year(ym(mes_filtro))))$resultado* 0.15)

# Uso
formatar_real(sum(rcl_12_meses$resultado))



formatar_real(minimo_saude)


formatar_real(sum((rcl_12_meses %>% filter(year(data_lancamento) == year(ym(mes_filtro))))$resultado))

```

------------------------------------------------------------------------

# üìã RREO Anexo 04 Previd√™ncia

O **Anexo 04** apresenta o demonstrativo das receitas e despesas previdenci√°rias do Governo Federal, segregado em tr√™s sistemas:

## üèõÔ∏è REGIME GERAL DE PREVID√äNCIA SOCIAL (RGPS)

### üí∞ Crit√©rios de Receitas RGPS

```{r criterios-receitas-rgps}
#| include: false

criterios_rreo_A04_rgps_receitas_rgps <- list(
  
  # RECEITAS CORRENTES - DOS EMPREGADORES, TRABALHADORES E DEMAIS SEGURADOS
  `01  Receitas Correntes - Dos Empregadores, Trabalhadores e Demais Segurados` = list(
    criterio = "natureza_receita_codigo_completo %in% c('12100311', '12100312', '12100313', '12100311') & nre2_origem_receita_codigo_origem %in% c(2) | startsWith(natureza_receita_codigo_completo, '1214') "
  ),
  
  # RECEITAS CORRENTES - DEMAIS CONTRIBUI√á√ïES  
  `02  Receitas Correntes - Demais Contribui√ß√µes` = list(
    criterio = "nre2_origem_receita_codigo_origem %in% c(2) & natureza_receita_codigo_completo %notin% c('12100311', '12100312', '12100313')"
  ),
  
  # OUTRAS RECEITAS CORRENTES - COMPENSA√á√ÉO PREVIDENCI√ÅRIA RPPS/RGPS
  `03  Outras Receitas Correntes - Compensa√ß√£o Previdenci√°ria RPPS/RGPS` = list(
    criterio = "nre2_origem_receita_codigo_origem %in% c(9)"
  ),
  
  # DEMAIS RECEITAS CORRENTES
  `04  Demais Receitas Correntes` = list(
    criterio = "nre1_categoria_economica_codigo %in% c(1) & nre2_origem_receita_codigo_origem %notin% c(2,9)"
  ),
  
  # RECEITAS DE CAPITAL - ALIENA√á√ïES
  `05  Receitas de Capital - Aliena√ß√µes` = list(
    criterio = "nre2_origem_receita_codigo_origem %in% c(2) & nre1_categoria_economica_codigo %in% c(2)"
  ),
  
  # DEMAIS RECEITAS DE CAPITAL
  `06  Demais Receitas de Capital` = list(
    criterio = "nre1_categoria_economica_codigo %in% c(2) & nre2_origem_receita_codigo_origem %notin% c(2)"
  ),
  
  # RECEITAS INTRA-OR√áAMENT√ÅRIAS
  `07  Receitas INTRA-OR√áAMENT√ÅRIAS` = list(
    criterio = "nre1_categoria_economica_codigo %in% c(7, 8)"
  )
)
```

### üí∏ Crit√©rios de Despesas RGPS

```{r criterios-despesas-rgps}
#| include: false

criterios_rreo_A04_rgps_despesas_rgps <- list(
  
  # APOSENTADORIAS
  `01  Aposentadorias` = list(
    criterio = "elemento_despesa_codigo %in% c('53', '54') & grupo_despesa_codigo_grupo %in% c(3) & modalidade_aplicacao_codigo %notin% c('91')"
  ),
  
  # PENS√ïES
  `02  Pens√µes` = list(
    criterio = "elemento_despesa_codigo %in% c('55', '56') & grupo_despesa_codigo_grupo %in% c(3) & modalidade_aplicacao_codigo %notin% c('91')"
  ),
  
  # OUTROS BENEF√çCIOS
  `03  Outros Benef√≠cios` = list(
    criterio = "elemento_despesa_codigo %in% c('57', '58') & grupo_despesa_codigo_grupo %in% c(3) & modalidade_aplicacao_codigo %notin% c('91')"
  ),
  
  # COMPENSA√á√ÉO PREVIDENCI√ÅRIA DO RGPS PARA O RPPS
  `04  Compensa√ß√£o Previdenci√°ria do RGPS para o RPPS` = list(
    criterio = "elemento_despesa_codigo %notin% c('57', '58', '53', '54', '55', '56') & acao_governo_codigo %in% c('009W', '0531') & grupo_despesa_codigo_grupo %in% c(3) & modalidade_aplicacao_codigo %notin% c('91')"
  ),
  
  # DEMAIS DESPESAS
  `05  Demais Despesas` = list(
    criterio = "elemento_despesa_codigo %notin% c('57', '58', '53', '54', '55', '56') & acao_governo_codigo %notin% c('009W', '0531') & grupo_despesa_codigo_grupo %in% c(3) & modalidade_aplicacao_codigo %notin% c('91')"
  ),
  
  # A DETALHAR
  `06  A detalhar` = list(
    criterio = "elemento_despesa_codigo %in% c('00') & grupo_despesa_codigo_grupo %in% c(3) & modalidade_aplicacao_codigo %notin% c('91')"
  ),
  
  # DESPESAS PREVIDENCI√ÅRIAS (INTRA)
  `07  Despesas Previdenci√°rias (INTRA)` = list(
    criterio = "grupo_despesa_codigo_grupo %in% c(3) & modalidade_aplicacao_codigo %in% c('91') & elemento_despesa_codigo %notin% c('01', '03', '05')"
  )
)


```

### üìä Processamento RGPS - Receitas

```{r processar-rgps-receitas}
#| include: false

(aplicar_criterios(df = dados_receita %>% 
    filter(
      unidade_orcamentaria_codigo %in% c(33904, 40904, 55902, 25917) | 
      natureza_receita_codigo_completo == 79900211), criterios_rreo_A04_rgps_receitas_rgps))




```

### üìä Processamento RGPS - Despesas

```{r processar-rgps-despesas}
#| include: false

aplicar_criterios(df = dados_despesa %>% 
    filter(unidade_orcamentaria_codigo %in% c(33904, 40904, 55902, 25917)), criterios_rreo_A04_rgps_despesas_rgps)


 
```

### Resultado RGPS

```{r}

df_resultado_rgps <- tibble(
  Receita_RGPS = aplicar_criterios(
    df = dados_receita %>%
      filter(
        unidade_orcamentaria_codigo %in% c(33904, 40904, 55902, 25917) |
        natureza_receita_codigo_completo == 79900211,
        item_informacao_codigo %in% c(5)
      ), 
    criterios_rreo_A04_rgps_receitas_rgps
  ) %>% 
    filter(ordem != "02") %>% 
    summarise(valor = sum(valor)) %>% 
    pull(valor),
  
  Despesa_RGPS = aplicar_criterios(
    df = dados_despesa %>%
      filter(
        unidade_orcamentaria_codigo %in% c(33904, 40904, 55902, 25917),
        item_informacao_codigo %in% c(25)
      ), 
    criterios_rreo_A04_rgps_despesas_rgps
  ) %>% 
    summarise(valor = sum(valor)) %>% 
    pull(valor)
) %>%
  mutate(Resultado_RGPS = Receita_RGPS - Despesa_RGPS) %>%
  pivot_longer(
    cols = everything(),
    names_to = "Tipo",
    values_to = "Valor"
  )

# Exibir com DT::datatable formatado
DT::datatable(
  df_resultado_rgps,
  options = list(dom = 't', pageLength = 3),
  rownames = FALSE
) %>%
  DT::formatCurrency("Valor", currency = "R$ ", digits = 2, mark = ".", dec.mark = ",")
```

## üë• REGIME PR√ìPRIO DE PREVID√äNCIA SOCIAL (RPPS)

### üí∞ Crit√©rios de Receitas RPPS

```{r criterios-receitas-rpps}
criterios_rreo_A04_rpps_receitas_civil_militar_rpps <- list(
  
 # CIVIS - RECEITA SEGURADOS - Ativo (CORRIGIDO)
`01  CIVIS - RECEITA SEGURADOS - Ativo` = list(
  criterio = "fonte_recursos_codigo %notin% c('00', '000') & (natureza_receita_codigo_completo %in% c('12100423', '12100421', '12100422', '12100424', '12100461', '12100462', '12100463', '12100464') | startsWith(natureza_receita_codigo_completo, '1215011') | startsWith(natureza_receita_codigo_completo, '1215014') | startsWith(natureza_receita_codigo_completo, '121503'))"
),

# CIVIS - RECEITA SEGURADOS - Inativos (CORRIGIDO)
`02  CIVIS - RECEITA SEGURADOS - Inativos` = list(
  criterio = "fonte_recursos_codigo %notin% c('00', '000') & (natureza_receita_codigo_completo %in% c('12100431', '12100433', '12100432', '12100434', '12100471') | startsWith(natureza_receita_codigo_completo, '1215012') | startsWith(natureza_receita_codigo_completo, '1215015'))"
),

# CIVIS - RECEITAS SEGURADOS - Pensionistas (CORRIGIDO) 
`03  CIVIS - RECEITAS SEGURADOS - Pensionistas` = list(
  criterio = "fonte_recursos_codigo %notin% c('00', '000') & (natureza_receita_codigo_completo %in% c('12100481', '12100441', '12100442', '12100443', '12100444') | startsWith(natureza_receita_codigo_completo, '1215013') | startsWith(natureza_receita_codigo_completo, '1215016'))"
),

# CIVIS - RECEITA PATRONAL - Ativo (CORRIGIDO)
`04  CIVIS - RECEITA PATRONAL - Ativo` = list(
  criterio = "fonte_recursos_codigo %notin% c('00', '000') & (natureza_receita_codigo_completo %in% c('12100411', '12100413', '12100412', '12100414', '72100411', '72100413', '72100414', '72100451', '72100452', '12100452', '12100453', '12100454') | startsWith(natureza_receita_codigo_completo, '121502') | startsWith(natureza_receita_codigo_completo, '721502'))"
),

# CIVIS - RECEITA PATRONAL - Inativos e Pensionistas (J√Å CORRETO)
`05  CIVIS - RECEITA PATRONAL - Inativos e Pensionistas - vinculada` = list(
  criterio = "fonte_recursos_codigo %notin% c('00', '000') & natureza_receita_codigo_completo %in% c('72100441')"
),
  
  # DRU - FCDF
  `06  DRU - FCDF` = list(
    criterio = "fonte_recursos_codigo %in% c('000', '00') & endsWith(fonte_recursos_detalhada_codigo, '980001') & startsWith(natureza_receita_codigo_completo, '12151')"
  ),
  
  # MILITARES - RECEITAS - Segurados
  `07  MILITARES - RECEITAS - Segurados` = list(
    criterio = "fonte_recursos_codigo %notin% c('00', '000') & 
(natureza_receita_codigo_completo %in% c('12100511', '12100512', '12100513', '12105141', '12150411', '12150412', '12150421', '12150043', '12150044') | 
startsWith(natureza_receita_codigo_completo, '121911'))"
  )
  
  # # Total das Receitas RPPS
  # `08  Total das Receitas RPPS` = list(
  #   criterio = "unidade_orcamentaria_codigo %notin% c('33904', '40904') & fonte_recursos_codigo %notin% c('54', '00', '000', '054') & (grepl('PENSOES MILIT|PENS.MIL|RPPS|CPSS|CIV', natureza_receita_nome, ignore.case = TRUE) | startsWith(natureza_receita_codigo_completo, '1215') | startsWith(natureza_receita_codigo_completo, '7215'))"
  # )
)
```

### üí∏ Crit√©rios de Despesas RPPS

```{r criterios-despesas-rpps}
criterios_rreo_A04_rpps_despesas_civil_militar_rpps <- list(
  
  # CIVIS - DESPESAS - A detalhar
  `01  CIVIS - DESPESAS - A detalhar` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845') & grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %in% c('00') & acao_governo_codigo %in% c('0053', '0181') & funcao_governo_codigo %notin% c('10', '08')"
  ),
  
  # CIVIS - DESPESAS - Aposentadorias
  `02  CIVIS - DESPESAS - Aposentadorias` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845') & grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %in% c('01') & acao_governo_codigo %in% c('0053', '0181')"
  ),
  
  # CIVIS - DESPESAS - Pens√µes
  `03  CIVIS - DESPESAS - Pens√µes` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845') & grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %in% c('03') & acao_governo_codigo %in% c('0053', '0181')"
  ),
  
  # CIVIS - DESPESAS - Outros Benef√≠cios Previdenci√°rios
  `04  CIVIS - DESPESAS - Outros Benef√≠cios Previdenci√°rios` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845', '846') & grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %notin% c('00', '01', '03') & (acao_governo_codigo %in% c('0053', '0181', '0005', '0625') & funcao_governo_codigo %notin% c('10', '08') | acao_governo_codigo %in% c('0397'))"
  ),
  
  # MILITARES - DESPESAS - A Detalhar Pens√µes
  `05  MILITARES - DESPESAS - A Detalhar Pens√µes` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845') & grupo_despesa_codigo_grupo %in% c(1) & acao_governo_codigo %in% c('0179', '000Q') & elemento_despesa_codigo %in% c('00')"
  ),
  
  # MILITARES - DESPESAS - Pens√µes
  `06  MILITARES - DESPESAS - Pens√µes` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845', '846') & grupo_despesa_codigo_grupo %in% c(1) & acao_governo_codigo %in% c('0179', '00QD') & elemento_despesa_codigo %in% c('03')"
  ),
  
  # MILITARES - DESPESAS - Outros Benef√≠cios Pensionistas
  `07  MILITARES - DESPESAS - Outros Benef√≠cios Pensionistas` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(2) & acao_governo_codigo %in% c('214H', '218K', '0179', '00QD') & elemento_despesa_codigo %notin% c('00', '01', '03') & grupo_despesa_codigo_grupo %in% c(1)"
  ),
  
  
    # MILITARES - DESPESAS - A Detalhar Inativos
  `08  MILITARES - DESPESAS - A Detalhar Inativos` = list(
    criterio = "grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %in% c('00') & acao_governo_codigo %in% c('214H', '218K')"
  ),
  
  # MILITARES - DESPESAS - Inativos
  `09  MILITARES - DESPESAS - Inativos` = list(
    criterio = "grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %in% c('01') & acao_governo_codigo %in% c('214H', '218K')"
  ),
  

  
   # MILITARES - DESPESAS - Outros Outros Benef√≠cios Inativos
  `10  MILITARES - DESPESAS - Outros Outros Benef√≠cios Inativos` = list(
    criterio = "grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %notin% c( '00', '01') & acao_governo_codigo %in% c('214H', '218K')"
  ),
  
     # MILITARES - DESPESAS - Compensa√ß√£o financeira entre RPPSU e os demais RPPS
  `11  MILITARES - DESPESAS - Compensa√ß√£o financeira entre RPPSU e os demais RPPS` = list(
    criterio = "acao_governo_codigo %in% c('00X3')"
  )
)
```

### üìä Processamento RPPS - Receitas

```{r processar-rpps-receitas}
#| include: false

datatable(aplicar_criterios(df = dados_receita %>% 
    filter(
      unidade_orcamentaria_codigo %notin% c(73901),
      fonte_recursos_codigo %notin% c('054')
    ), criterios_rreo_A04_rpps_receitas_civil_militar_rpps))




```

verificar linha 08 Total das Receitas RPPS.

### üìä Processamento RPPS - Despesas

```{r processar-rpps-despesas}
#| include: false
# Processar despesas RPPS



datatable(aplicar_criterios(df = dados_despesa %>% 
    filter(
      unidade_orcamentaria_codigo %notin% c(73901),
      elemento_despesa_codigo %notin% c('04', '07', '11', '13', '16', '39', '67', '96'),
      acao_governo_codigo != '09HB'
    ), criterios_rreo_A04_rpps_despesas_civil_militar_rpps))




```

### Resultado RPPS

```{r resultado_rpps}
# formatar_numero(resultado_rpps <- (
#   aplicar_criterios(df = dados_receita %>% 
#     filter(
#       unidade_orcamentaria_codigo %notin% c(73901),
#       fonte_recursos_codigo %notin% c('054'),
#            item_informacao_codigo %in% c(5)
#     ), criterios_rreo_A04_rpps_receitas_civil_militar_rpps)%>% summarise(valor=sum(valor))
#   -
#   aplicar_criterios(df = dados_despesa %>% 
#     filter(
#       unidade_orcamentaria_codigo %notin% c(73901),
#       elemento_despesa_codigo %notin% c('04', '07', '11', '13', '16', '39', '67', '96'),
#       acao_governo_codigo != '09HB',
#            item_informacao_codigo %in% c(25)
#     ), criterios_rreo_A04_rpps_despesas_civil_militar_rpps)%>% summarise(valor=sum(valor))
# ))
```

```{r}
# Tabela estruturada para RPPS CIVIL (Servidores Civis)
df_resultado_rpps_civil <- tibble(
  Receita_RPPS_Civil = aplicar_criterios(
    df = dados_receita %>%
      filter(
        unidade_orcamentaria_codigo %notin% c(73901),
        fonte_recursos_codigo %notin% c('054'),
        item_informacao_codigo %in% c(5)
      ), 
    criterios_rreo_A04_rpps_receitas_civil_militar_rpps
  ) %>%
    # Filtra apenas linhas de CIVIS (01 a 06)
    filter(grepl("^0[1-6]", ordem)) %>%
    summarise(valor = sum(valor)) %>% 
    pull(valor),
  
  Despesa_RPPS_Civil = aplicar_criterios(
    df = dados_despesa %>%
      filter(
        unidade_orcamentaria_codigo %notin% c(73901),
        elemento_despesa_codigo %notin% c('04', '07', '11', '13', '16', '39', '67', '96'),
        acao_governo_codigo != '09HB',
        item_informacao_codigo %in% c(25)
      ), 
    criterios_rreo_A04_rpps_despesas_civil_militar_rpps
  ) %>%
    # Filtra apenas linhas de CIVIS (01 a 04)
     filter(str_detect(nome, "CIVIS")) %>%
    summarise(valor = sum(valor)) %>% 
    pull(valor)
) %>%
  mutate(Resultado_RPPS_Civil = Receita_RPPS_Civil - Despesa_RPPS_Civil) %>%
  pivot_longer(
    cols = everything(),
    names_to = "Tipo",
    values_to = "Valor"
  )

# Exibir tabela formatada
DT::datatable(
  df_resultado_rpps_civil,
  options = list(dom = 't', pageLength = 3),
  rownames = FALSE
) %>%
  DT::formatCurrency("Valor", currency = "R$ ", digits = 2, mark = ".", dec.mark = ",")
```

```{r}
# Tabela estruturada para RPPS MILITAR (Militares)
df_resultado_rpps_militar <- tibble(
  Receita_RPPS_Militar = aplicar_criterios(
    df = dados_receita %>%
      filter(
        unidade_orcamentaria_codigo %notin% c(73901),
        fonte_recursos_codigo %notin% c('054'),
        item_informacao_codigo %in% c(5)
      ), 
    criterios_rreo_A04_rpps_receitas_civil_militar_rpps
  ) %>%
    # Filtra apenas linha de MILITARES (07)
    filter(grepl("^07", ordem)) %>%
    summarise(valor = sum(valor)) %>% 
    pull(valor),
  
  Despesa_RPPS_Militar = aplicar_criterios(
    df = dados_despesa %>%
      filter(
        unidade_orcamentaria_codigo %notin% c(73901),
        elemento_despesa_codigo %notin% c('04', '07', '11', '13', '16', '39', '67', '96'),
        acao_governo_codigo != '09HB',
        item_informacao_codigo %in% c(25)
      ), 
    criterios_rreo_A04_rpps_despesas_civil_militar_rpps
  ) %>%
   
    filter(str_detect(nome, "MILITARES")) %>%
    summarise(valor = sum(valor)) %>% 
    pull(valor)
) %>%
  mutate(Resultado_RPPS_Militar = Receita_RPPS_Militar - Despesa_RPPS_Militar) %>%
  pivot_longer(
    cols = everything(),
    names_to = "Tipo",
    values_to = "Valor"
  )

# Exibir tabela formatada
DT::datatable(
  df_resultado_rpps_militar,
  options = list(dom = 't', pageLength = 3),
  rownames = FALSE
) %>%
  DT::formatCurrency("Valor", currency = "R$ ", digits = 2, mark = ".", dec.mark = ",")
```

```{r}
# Tabela estruturada para RPPS (Regime Pr√≥prio de Previd√™ncia Social)
df_resultado_rpps <- tibble(
  Receita_RPPS = aplicar_criterios(
    df = dados_receita %>%
      filter(
        unidade_orcamentaria_codigo %notin% c(73901),
        fonte_recursos_codigo %notin% c('054'),
        item_informacao_codigo %in% c(5)
      ), 
    criterios_rreo_A04_rpps_receitas_civil_militar_rpps
  ) %>% 
    summarise(valor = sum(valor)) %>% 
    pull(valor),
  
  Despesa_RPPS = aplicar_criterios(
    df = dados_despesa %>%
      filter(
        unidade_orcamentaria_codigo %notin% c(73901),
        elemento_despesa_codigo %notin% c('04', '07', '11', '13', '16', '39', '67', '96'),
        acao_governo_codigo != '09HB',
        item_informacao_codigo %in% c(25)
      ), 
    criterios_rreo_A04_rpps_despesas_civil_militar_rpps
  ) %>% 
    summarise(valor = sum(valor)) %>% 
    pull(valor)
) %>%
  mutate(Resultado_RPPS = Receita_RPPS - Despesa_RPPS) %>%
  pivot_longer(
    cols = everything(),
    names_to = "Tipo",
    values_to = "Valor"
  )

# Exibir tabela formatada
DT::datatable(
  df_resultado_rpps,
  options = list(dom = 't', pageLength = 3),
  rownames = FALSE
) %>%
  DT::formatCurrency("Valor", currency = "R$ ", digits = 2, mark = ".", dec.mark = ",")
```

## üèõÔ∏è REGIME PR√ìPRIO DE PREVID√äNCIA SOCIAL - FCDF

### üí∞ Crit√©rios de Receitas FCDF

```{r criterios-receitas-fcdf}
#| include: false
criterios_rreo_A04_rpps_receitas_fcdf<- list(
  
  # FCDF - RECEITA SEGURADOS - Ativo
  `01  FCDF - RECEITA SEGURADOS - Ativo` = list(
    criterio = "fonte_recursos_codigo %notin% c('00', '000') & (natureza_receita_codigo_completo %in% c('12100431', '12104211', '12104221', '12104231', '12104411', '12104421', '12104431', '12104611', '12104621', '12104631', '12191111', '12191321', '12191411') | startsWith(natureza_receita_codigo_completo, '121503') | startsWith(natureza_receita_codigo_completo, '1215011') | startsWith(natureza_receita_codigo_completo, '1215014'))"
  ),
  
  # FCDF - RECEITA SEGURADOS - Inativos
  `02  FCDF - RECEITA SEGURADOS - Inativos` = list(
    criterio = "fonte_recursos_codigo %notin% c('00', '000') & (natureza_receita_codigo_completo %in% c('12104311', '12104321', '12104331', '12104341', '12104711') | startsWith(natureza_receita_codigo_completo, '1215012') | startsWith(natureza_receita_codigo_completo, '1215015'))"
  ),
  
  # FCDF - RECEITAS SEGURADOS - Pensionistas
  `03  FCDF - RECEITAS SEGURADOS - Pensionistas` = list(
    criterio = "fonte_recursos_codigo %notin% c('00', '000') & (natureza_receita_codigo_completo %in% c('12104811', '12104411', '12104421', '12104431', '12104441', '12105121', '12105131') | startsWith(natureza_receita_codigo_completo, '1215013') | startsWith(natureza_receita_codigo_completo, '1215016'))"
  ),
  
  # FCDF - RECEITA PATRONAL - Ativo
  `04  FCDF - RECEITA PATRONAL - Ativo` = list(
    criterio = "fonte_recursos_codigo %notin% c('00', '000') & (natureza_receita_codigo_completo %in% c('12104111', '12104131', '12104121', '12104141', '72104111', '72104121', '72104131', '72104141', '72104511', '72104521', '72104531', '72104541') | startsWith(natureza_receita_codigo_completo, '121502') | startsWith(natureza_receita_codigo_completo, '721502'))"
  ),
  
  # FCDF - RECEITA PATRONAL - Inativos e Pensionistas - vinculada
  `05  FCDF - RECEITA PATRONAL - Inativos e Pensionistas - vinculada` = list(
    criterio = "fonte_recursos_codigo %notin% c('00', '000') & natureza_receita_codigo_completo %in% c('72104411', '12150211')"
  ),
  
  # DRU - FCDF
  `06  DRU - FCDF` = list(
    criterio = "fonte_recursos_codigo %in% c('00', '000') & (natureza_receita_codigo_completo %in% c('12104811', '12104411', '12104421', '12104431', '12104441', '12105111', '12104211', '12104221', '12104231', '12104311', '12104321', '12104331', '12104341', '12104521', '12104531', '12104621', '12104631', '12104721', '12104731', '12104741', '12104831', '12104841') | startsWith(natureza_receita_codigo_completo, '1215') | startsWith(natureza_receita_codigo_completo, '7215'))"
  ),
  
  # Total de Receitas RPPS FCDF
  `07  Total de Receitas RPPS FCDF` = list(
    criterio = "unidade_orcamentaria_codigo %notin% c('55902', '33904') & fonte_recursos_codigo %notin% c('54', '054') & fonte_recursos_detalhada_codigo %notin% c('010073910') & fonte_recursos_codigo %in% c('23', '56', '023', '056', '024') & (grepl('PENSI|PENSO|RPPS|CPSS', natureza_receita_nome, ignore.case = TRUE))"
  )
)
```

### üí∏ Crit√©rios de Despesas FCDF

```{r criterios-despesas-fcdf}
#| include: false
criterios_rreo_A04_rpps_despesas_fcdf <- list(
  
  # FCDF - DESPESAS - A detalhar
  `01  FCDF - DESPESAS - A detalhar` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(1, 2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845') & grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %in% c('00') & acao_governo_codigo %in% c('00Q2', '00QN', '00NS')"
  ),
  
  # FCDF - DESPESAS - Aposentadorias
  `02  FCDF - DESPESAS - Aposentadorias` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(1, 2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845') & grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %in% c('01') & acao_governo_codigo %in% c('00Q2', '00QN', '00NS', '0312', '00NR')"
  ),
  
  # FCDF - DESPESAS - Pens√µes
  `03  FCDF - DESPESAS - Pens√µes` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(1, 2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845') & grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %in% c('03') & acao_governo_codigo %in% c('00Q2', '00QN', '00NS', '0312', '00NR')"
  ),
  
  # FCDF - DESPESAS - Outros Benef√≠cios Previdenci√°rios
  `04  FCDF - DESPESAS - Outros Benef√≠cios Previdenci√°rios` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(1, 2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845', '846') & grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %notin% c('00', '01', '03') & (acao_governo_codigo %in% c('00Q2', '00NS', '00QN') | (acao_governo_codigo %in% c('0005', '0625') & funcao_governo_codigo %notin% c('10', '08')))"
  )
)
```

### üìä Processamento FCDF - Receitas

```{r processar-fcdf-receitas}
#| include: false

datatable(aplicar_criterios(df = dados_receita %>% 
    filter(unidade_orcamentaria_codigo %in% c(73901)),
    criterios_rreo_A04_rpps_receitas_fcdf))





```

### üìä Processamento FCDF - Despesas

```{r processar-fcdf-despesas}
#| include: false

datatable(aplicar_criterios(df = dados_despesa %>% 
    filter(
      unidade_orcamentaria_codigo %in% c(73901),
      elemento_despesa_codigo %notin% c('04', '07', '11', '13', '16', '39', '67', '96'),
      acao_governo_codigo != '09HB'
    ),
    criterios_rreo_A04_rpps_despesas_fcdf))




```

### Resultado FCDF

```{r}
#| include: false
formatar_numero(resultado_fcdf <- (
  aplicar_criterios(df = dados_receita %>% 
    filter(unidade_orcamentaria_codigo %in% c(73901),
           item_informacao_codigo %in% c(5)),
    criterios_rreo_A04_rpps_receitas_fcdf)%>% summarise(valor=sum(valor))
    -
aplicar_criterios(df = dados_despesa %>% 
    filter(
      unidade_orcamentaria_codigo %in% c(73901),
      elemento_despesa_codigo %notin% c('04', '07', '11', '13', '16', '39', '67', '96'),
      acao_governo_codigo != '09HB',
      item_informacao_codigo %in% c(25)
    ),
    criterios_rreo_A04_rpps_despesas_fcdf)%>% summarise(valor=sum(valor))
))

```

```{r}
# Tabela estruturada para FCDF (Fundo Constitucional do Distrito Federal)
df_resultado_fcdf <- tibble(
  Receita_FCDF = aplicar_criterios(
    df = dados_receita %>%
      filter(
        unidade_orcamentaria_codigo %in% c(73901),
        item_informacao_codigo %in% c(5)
      ), 
    criterios_rreo_A04_rpps_receitas_fcdf
  ) %>% 
    summarise(valor = sum(valor)) %>% 
    pull(valor),
  
  Despesa_FCDF = aplicar_criterios(
    df = dados_despesa %>%
      filter(
        unidade_orcamentaria_codigo %in% c(73901),
        elemento_despesa_codigo %notin% c('04', '07', '11', '13', '16', '39', '67', '96'),
        acao_governo_codigo != '09HB',
        item_informacao_codigo %in% c(25)
      ), 
    criterios_rreo_A04_rpps_despesas_fcdf
  ) %>% 
    summarise(valor = sum(valor)) %>% 
    pull(valor)
) %>%
  mutate(Resultado_FCDF = Receita_FCDF - Despesa_FCDF) %>%
  pivot_longer(
    cols = everything(),
    names_to = "Tipo",
    values_to = "Valor"
  )

# Exibir tabela formatada
DT::datatable(
  df_resultado_fcdf,
  options = list(dom = 't', pageLength = 3),
  rownames = FALSE
) %>%
  DT::formatCurrency("Valor", currency = "R$ ", digits = 2, mark = ".", dec.mark = ",")
```

# üìã RREO Anexo 06 (Resultado Prim√°rio)

## Processamento Anexo 06

```{r criterio_anexo_06}

# ===============================================================================
# CRIT√âRIOS RREO ANEXO 6 - RESULTADO PRIM√ÅRIO (AJUSTADO)
# ===============================================================================

# ===============================================================================
# 1. RECEITAS PRIM√ÅRIAS (dados_receita)
# ===============================================================================
criterios_rreo_A06_receitas_A06 <- list(
  
  # RECEITAS CORRENTES (I) - Total
  `01  RECEITAS CORRENTES (I)` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    item_informacao_codigo == 5
    "
  ),
  
  # IMPOSTOS, TAXAS E CONTRIBUI√á√ïES DE MELHORIA (Subitem)
  `02  ___Impostos, Taxas e Contribui√ß√µes de Melhoria` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 1 & 
    item_informacao_codigo == 5
    "
  ),
  
  # CONTRIBUI√á√ïES (Subitem)
  `03  ___Contribui√ß√µes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 2 & 
    item_informacao_codigo == 5
    "
  ),
  
  # RECEITA PATRIMONIAL (Subitem)
  `04  ___Receita Patrimonial` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3 & 
    item_informacao_codigo == 5
    "
  ),
  
  # APLICA√á√ïES FINANCEIRAS (II) - DEDU√á√ÉO (Sub-subitem)
  `05  ______Aplica√ß√µes Financeiras (II)` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    (natureza_receita_codigo_completo %in% c('13210101', '13210201', '13210301', '13210501') |
     startsWith(natureza_receita_codigo_completo, '1321004') |
     startsWith(natureza_receita_codigo_completo, '1329001')) & 
    item_informacao_codigo == 5
    "
  ),
  
  # OUTRAS RECEITAS PATRIMONIAIS (Sub-subitem)
  `06  ______Outras Receitas Patrimoniais` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3 & 
    !(natureza_receita_codigo_completo %in% c('13210101', '13210201', '13210301', '13210501') |
      startsWith(natureza_receita_codigo_completo, '1321004') |
      startsWith(natureza_receita_codigo_completo, '1329001')) & 
    item_informacao_codigo == 5
    "
  ),
  
  # TRANSFER√äNCIAS CORRENTES (Subitem)
  `07  ___Transfer√™ncias Correntes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 7 & 
    item_informacao_codigo == 5
    "
  ),
  
  # DEMAIS RECEITAS CORRENTES (Subitem)
  `08  ___Demais Receitas Correntes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    (startsWith(natureza_receita_codigo_completo, '14') |
     startsWith(natureza_receita_codigo_completo, '15') |
     startsWith(natureza_receita_codigo_completo, '16') |
     startsWith(natureza_receita_codigo_completo, '18') |
     startsWith(natureza_receita_codigo_completo, '19')) & 
    item_informacao_codigo == 5
    "
  ),
  
  # OUTRAS RECEITAS FINANCEIRAS (III) - DEDU√á√ÉO (Sub-subitem)
  `09  ______Outras Receitas Financeiras (III)` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    (natureza_receita_codigo_completo %in% c('16410101', '16410102', '19991101', '19991102', '16410301') |
     startsWith(natureza_receita_codigo_completo, '1922012') |
     startsWith(natureza_receita_codigo_completo, '1990992')) & 
    item_informacao_codigo == 5
    "
  ),
  
  # RECEITAS CORRENTES RESTANTES (Sub-subitem)
  `10  ______Receitas Correntes Restantes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    (startsWith(natureza_receita_codigo_completo, '14') |
     startsWith(natureza_receita_codigo_completo, '15') |
     startsWith(natureza_receita_codigo_completo, '16') |
     startsWith(natureza_receita_codigo_completo, '18') |
     startsWith(natureza_receita_codigo_completo, '19')) & 
    !(natureza_receita_codigo_completo %in% c('16410101', '16410102', '19991101', '19991102', '16410301') |
      startsWith(natureza_receita_codigo_completo, '1922012') |
      startsWith(natureza_receita_codigo_completo, '1990992')) & 
    item_informacao_codigo == 5
    "
  ),
  
  # RECEITAS PRIM√ÅRIAS CORRENTES (IV) - F√ìRMULA
  `11  RECEITAS PRIM√ÅRIAS CORRENTES (IV) = (I - II - III)` = list(
    criterio = "{01 - 05 - 09}"
  ),
  
  # RECEITAS DE CAPITAL (V) - Total
  `12  RECEITAS DE CAPITAL (V)` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    item_informacao_codigo == 5
    "
  ),
  
  # OPERA√á√ïES DE CR√âDITO (VI) - DEDU√á√ÉO (Subitem)
  `13  ___Opera√ß√µes de Cr√©dito (VI)` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 1 & 
    item_informacao_codigo == 5
    "
  ),
  
  # AMORTIZA√á√ÉO DE EMPR√âSTIMOS (VII) - DEDU√á√ÉO (Subitem)
  `14  ___Amortiza√ß√£o de Empr√©stimos (VII)` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 3 & 
    item_informacao_codigo == 5
    "
  ),
  
  # ALIENA√á√ïES DE BENS (Subitem)
  `15  ___Aliena√ß√µes de Bens` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 2 & 
    item_informacao_codigo == 5
    "
  ),
  
  # RECEITAS DE ALIENA√á√ÉO DE INVESTIMENTOS PERMANENTES (IX) - Sub-subitem
  `16  ______Receitas de Aliena√ß√£o de Investimentos Permanentes (IX)` = list(
    criterio = "
    natureza_receita_codigo_completo == 22110011 & 
    item_informacao_codigo == 5
    "
  ),
  
  # OUTRAS ALIENA√á√ïES DE BENS (Sub-subitem)
  `17  ______Outras Aliena√ß√µes de Bens` = list(
    criterio = "
    natureza_receita_codigo_completo == '22110011' & 
    item_informacao_codigo == 5
    "
  ),
  
  # TRANSFER√äNCIAS DE CAPITAL (Subitem)
  `18  ___Transfer√™ncias de Capital` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 4 & 
    item_informacao_codigo == 5
    "
  ),
  
  # OUTRAS RECEITAS DE CAPITAL (Subitem)
  `19  ___Outras Receitas de Capital` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem %in% c(5, 6, 7, 8, 9) & 
    item_informacao_codigo == 5
    "
  ),
  
  # OUTRAS RECEITAS DE CAPITAL N√ÉO PRIM√ÅRIAS (X) - DEDU√á√ÉO (Sub-subitem)
  `20  ______Outras Receitas de Capital N√£o Prim√°rias (X)` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    (startsWith(natureza_receita_codigo_completo, '292') |
     startsWith(natureza_receita_codigo_completo, '293') |
     startsWith(natureza_receita_codigo_completo, '294')) & 
    item_informacao_codigo == 5
    "
  ),
  
  # RECEITAS PRIM√ÅRIAS DE CAPITAL (XI) - F√ìRMULA
  `21  RECEITAS PRIM√ÅRIAS DE CAPITAL (XI) = (V - VI - VII - IX - X)` = list(
    criterio = "{12 - 13 - 14 - 16 - 20}"
  ),
  
  # RECEITA PRIM√ÅRIA TOTAL (XII) - F√ìRMULA
  `22  RECEITA PRIM√ÅRIA TOTAL (XII) = (IV + XI)` = list(
    criterio = "{11 + 21}"
  )
)

# ===============================================================================
# 2. DESPESAS - CATEGORIA/GRUPO (dados_categoria_grupo)
# ===============================================================================
criterios_rreo_A06_despesas_categoria_grupo_A06 <- list(
  
  # DESPESAS CORRENTES (XIII)
  `23  DESPESAS CORRENTES (XIII)` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # PESSOAL E ENCARGOS SOCIAIS (Subitem)
  `24  ___Pessoal e Encargos Sociais` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 & 
    grupo_despesa_codigo_grupo == 1 & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # JUROS E ENCARGOS DA D√çVIDA (XIV) - DEDU√á√ÉO (Subitem)
  `25  ___Juros e Encargos da D√≠vida (XIV)` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 & 
    grupo_despesa_codigo_grupo == 2 & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # OUTRAS DESPESAS CORRENTES (Subitem)
  `26  ___Outras Despesas Correntes` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 & 
    grupo_despesa_codigo_grupo == 3 & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # DESPESAS PRIM√ÅRIAS CORRENTES (XV) - F√ìRMULA
  `27  DESPESAS PRIM√ÅRIAS CORRENTES (XV) = (XIII - XIV)` = list(
    criterio = "{23 - 25}"
  ),
  
  # DESPESAS DE CAPITAL (XVI)
  `28  DESPESAS DE CAPITAL (XVI)` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # INVESTIMENTOS (Subitem)
  `29  ___Investimentos` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 & 
    grupo_despesa_codigo_grupo == 4 & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # INVERS√ïES FINANCEIRAS (Subitem)
  `30  ___Invers√µes Financeiras` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 & 
    grupo_despesa_codigo_grupo == 5 & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # AMORTIZA√á√ÉO DA D√çVIDA (XX) - DEDU√á√ÉO (Subitem)
  `31  ___Amortiza√ß√£o da D√≠vida (XX)` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 & 
    grupo_despesa_codigo_grupo == 6 & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  )
)

# ===============================================================================
# 3. DESPESAS - NATUREZA DETALHADA (dados_ndd)
# ===============================================================================
criterios_rreo_A06_despesas_natureza_detalhada_A06 <- list(
  
  # TRANSFER√äNCIAS CONSTITUCIONAIS E LEGAIS
  `32  ______Transfer√™ncias Constitucionais e Legais` = list(
    criterio = "
    (startsWith(natureza_despesa_detalhada_codigo, '333081') | 
     startsWith(natureza_despesa_detalhada_codigo, '334081')) & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # DEMAIS DESPESAS CORRENTES - F√ìRMULA
  `33  ______Demais Despesas Correntes` = list(
    criterio = "{26 - 32}"
  ),
  
  # CONCESS√ÉO DE EMPR√âSTIMOS E FINANCIAMENTOS (XVII)
  `34  ______Concess√£o de Empr√©stimos e Financiamentos (XVII)` = list(
    criterio = "
    (natureza_despesa_detalhada_codigo %in% c('45909206', '45909208', '45909266') |
     (str_starts(natureza_despesa_detalhada_codigo, '45') & 
      elemento_despesa_codigo == '66')) & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # AQUISI√á√ÉO DE T√çTULOS DE CAPITAL J√Å INTEGRALIZADO (XVIII)
  `35  ______Aquisi√ß√£o de T√≠tulos de Capital j√° Integralizado (XVIII)` = list(
    criterio = "
    natureza_despesa_detalhada_codigo %in% c('45919206', '45919208') & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # DEMAIS INVERS√ïES FINANCEIRAS - F√ìRMULA
  `36  ______Demais Invers√µes Financeiras` = list(
    criterio = "{30 - 34 - 35}"
  ),
  
  # Item 37 removido - agora usa dados_despesa
  
  # COTAS DOS FUNDOS GARANTIDORES
  `38  ______Cotas dos Fundos Garantidores (metodologia CESEF - prim√°rio)` = list(
    criterio = "
    natureza_despesa_detalhada_codigo == '45919266' & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  )
)

# ===============================================================================
# 4. DISPONIBILIDADES (tg_RPN_disponibilidades)
# ===============================================================================
criterios_rreo_A06_disponibilidades_A06 <- list(
  
  # DISPONIBILIDADES - RECURSOS A CLASSIFICAR
  `39  Disponibilidades - Recursos a Classificar` = list(
    criterio = "
    fonte_recursos_codigo %in% c('77', '490') & 
    orgao_uge_tipo_administracao_codigo != 7
    "
  ),
  
  # DISPONIBILIDADES - RECURSOS DIVERSOS
  `40  Disponibilidades - Recursos Diversos` = list(
    criterio = "
    fonte_recursos_codigo %in% c('90', '491') & 
    orgao_uge_tipo_administracao_codigo != 7
    "
  )
)

# ===============================================================================
# 5. JUROS ATIVOS E PASSIVOS (dados_juros) - CORRIGIDO
# ===============================================================================
criterios_rreo_A06_juros_ativos_passivos_A06 <- list(
  
  # JUROS ATIVOS (XXV) - VPA Classe 4
  # Prefixos: 44111, 44113, 44114, 44115, 44121, 44131, 44133, 44134, 44135, 
  #           44141, 44211, 44213, 44214, 44215, 44221
  # Contas espec√≠ficas: 445110100, 445210100
  `41  Juros Ativos` = list(
    criterio = "
    substr(conta_contabil_numero, 1, 5) %in% c('44111', '44113', '44114', '44115', '44121', '44131', 
                                               '44133', '44134', '44135', '44141', '44211', '44213', 
                                               '44214', '44215', '44221') |
    conta_contabil_numero %in% c('445110100', '445210100')
    "
  ),
  
  # JUROS PASSIVOS (XXVI) - VPD Classe 3
  # Prefixos: 34111, 34113, 34114, 34115, 34121, 34131, 34141, 34181, 34183, 
  #           34184, 34185, 34191, 34211, 34213, 34214, 34215, 34221, 34291
  `42  Juros Passivos` = list(
    criterio = "
    substr(conta_contabil_numero, 1, 5) %in% c('34111', '34113', '34114', '34115', '34121', '34131', 
                                               '34141', '34181', '34183', '34184', '34185', '34191',
                                               '34211', '34213', '34214', '34215', '34221', '34291')
    "
  ),
  
  # FUNDOS - JUROS ATIVOS (mesmos prefixos do item 41)
  # Valor esperado: 15.174.626.701
  `43  Fundos - Juros Ativos` = list(
    criterio = "
    orgao_uge_tipo_administracao_codigo == '7' & 
    ug_executora_codigo != '380916' & 
    !orgao_uge_codigo %in% c('25915', '37904') &
    (substr(conta_contabil_numero, 1, 5) %in% c('44111', '44113', '44114', '44115', '44121', '44131', 
                                                '44133', '44134', '44135', '44141', '44211', '44213', 
                                                '44214', '44215', '44221') |
     conta_contabil_numero %in% c('445110100', '445210100'))
    "
  ),
  
  # FUNDOS - JUROS PASSIVOS (mesmos prefixos do item 42)
  # Valor esperado: 2.364.213.994
  `44  Fundos - Juros Passivos` = list(
    criterio = "
    orgao_uge_tipo_administracao_codigo == '7' & 
    ug_executora_codigo != '380916' & 
    !orgao_uge_codigo %in% c('25915', '37904') &
    substr(conta_contabil_numero, 1, 5) %in% c('34111', '34113', '34114', '34115', '34121', '34131', 
                                               '34141', '34181', '34183', '34184', '34185', '34191',
                                               '34211', '34213', '34214', '34215', '34221', '34291')
    "
  )
)

# ===============================================================================
# 6. SUBS√çDIOS CESEF (dados_despesa) - Item 37
# ===============================================================================
criterios_rreo_A06_subsidios_cesef <- list(
  
  `37  ______Subs√≠dios (metodologia CESEF - financeiro prim√°rio)` = list(
    criterio = "
    acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                              '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                              '20GI', '006C', '00ED', '00EE', '00SG')
    "
  )
)


# ===============================================================================
# AJUSTES PARA O ANEXO 6 DO RREO (VPA/VPD de ajustes patrimoniais) - 2025
# VERS√ÉO CORRIGIDA - baseada nos prints oficiais do TG
#
# OBSERVA√á√ÉO IMPORTANTE:
# Os atributos "NS - Classifica√ß√£o Cont√°bil 1" e "NS - Classifica√ß√£o Cont√°bil 2"
# foram OMITIDOS pois inviabilizavam a gera√ß√£o do relat√≥rio por exceder o limite
# de spool do TG. Isso pode causar diferen√ßas em alguns itens (especialmente 57).
#
# VALIDA√á√ÉO: 19/23 itens OK (83%)
# 
# ITENS COM PROBLEMAS (necessitam reextra√ß√£o do TG):
# - Item 50: Conta 343110100 N√ÉO EXISTE no arquivo rreo_a06_ajustes.xlsx
# - Item 57: Atributos NS Classif. Cont√°bil 1 e 2 foram omitidos
# - Item 59: Contas 365010100, 365040100, 365050100, 365150100 n√£o existem no arquivo
# - Item 62: Contas 443140100, 443150100, 443340100 n√£o existem no arquivo
# ===============================================================================

criterios_rreo_A06_ajuste <- list(

  # ---------------------------------------------------------------------------
  # VPD - VARIA√á√ïES MONET√ÅRIAS DA D√çVIDA CONTRATUAL
  # Print: vpd_01.png
  # Contas: 343110100, 343540100, 343550100
  # 
  # NOTA: A conta 343110100 N√ÉO EXISTE no arquivo rreo_a06_ajustes.xlsx
  # Isso causa diferen√ßa de ~906 mi. Necess√°rio reextrair do TG.
  # ---------------------------------------------------------------------------
  `50 VPD - Varia√ß√µes Monet√°rias da D√≠vida Contratual` = list(
    criterio = "
    conta_contabil_numero %in% c('343110100', '343540100', '343550100')
    "
  ),

  # ---------------------------------------------------------------------------
  # VPD - VARIA√á√ïES CAMBIAIS DA D√çVIDA CONTRATUAL
  # Print: vpd_01.png
  # Conta: 343210200
  # ---------------------------------------------------------------------------
  `51 VPD - Varia√ß√µes Cambiais da D√≠vida Contratual` = list(
    criterio = "
    conta_contabil_numero == '343210200'
    "
  ),

  # ---------------------------------------------------------------------------
  # VPD - VARIA√á√ïES MONET√ÅRIAS DA D√çVIDA MOBILI√ÅRIA
  # Print: vpd_01.png
  # (Conta 343310100 E UG 170600) OU (Conta 343340100 E UG 170512)
  # ---------------------------------------------------------------------------
  `52 VPD - Varia√ß√µes Monet√°rias da D√≠vida Mobili√°ria` = list(
    criterio = "
    (conta_contabil_numero == '343310100' & ug_executora_codigo == '170600') |
    (conta_contabil_numero == '343340100' & ug_executora_codigo == '170512')
    "
  ),

  # ---------------------------------------------------------------------------
  # VPD - VARIA√á√ïES CAMBIAIS DA D√çVIDA MOBILI√ÅRIA
  # Print: vpd_01.png
  # Conta: 343410200, UG: 170600
  # ---------------------------------------------------------------------------
  `53 VPD - Varia√ß√µes Cambiais da D√≠vida Mobili√°ria` = list(
    criterio = "
    conta_contabil_numero == '343410200' &
    ug_executora_codigo == '170600'
    "
  ),

  # ---------------------------------------------------------------------------
  # VPD - ATUALIZA√á√ÉO MONET√ÅRIA NEGATIVA
  # Print: vpd_02.png
  # Contas: 343910103, 343940103, 343950103
  # UGs: 170600, 170512, 380916, 170700
  # ---------------------------------------------------------------------------
  `54 VPD - Atualiza√ß√£o Monet√°ria Negativa` = list(
    criterio = "
    conta_contabil_numero %in% c('343910103', '343940103', '343950103') &
    ug_executora_codigo %in% c('170600', '170512', '380916', '170700')
    "
  ),

  # ---------------------------------------------------------------------------
  # VPD - INCORPORA√á√ÉO DE PASSIVOS
  # Print: vpd_02.png
  # Contas: 364010100, 364110100
  # UGs: 170600, 170512
  # ---------------------------------------------------------------------------
  `55 VPD - Incorpora√ß√£o de Passivos` = list(
    criterio = "
    conta_contabil_numero %in% c('364010100', '364110100') &
    ug_executora_codigo %in% c('170600', '170512')
    "
  ),

  # ---------------------------------------------------------------------------
  # VPD - RESULTADO NEGATIVO BACEN
  # Print: vpd_02.png
  # Conta: 348110100
  # ---------------------------------------------------------------------------
  `56 VPD - Resultado Negativo BACEN` = list(
    criterio = "
    conta_contabil_numero == '348110100'
    "
  ),

  # ---------------------------------------------------------------------------
  # CONSTITUI√á√ÉO DE SUBVEN√á√ïES ECON√îMICAS - COPEC
  # Print: vpd_09.png
  # UG: 170700
  # Contas: 395010100, 395110100
  # Evento: 581012
  # 
  # NOTA IMPORTANTE: O crit√©rio oficial tamb√©m usa:
  # - NS Classifica√ß√£o Cont√°bil 1: 217710101, 227710101, 222210200, 212210300,
  #   222110200, 212110301, 212110303, 212110700, 212210601, 212310201, 212310202,
  #   212410201, 217310301, 217310602, 217350402, 222310102, 222410101, 227310301
  # - NS Classifica√ß√£o Cont√°bil 2: 395010100, 395110100
  # Estes atributos foram OMITIDOS do arquivo, causando diferen√ßa de ~9.7 bi
  # O valor correto seria calculado pela metodologia completa do TG.
  # ---------------------------------------------------------------------------
  `57 VPD - Constitui√ß√£o de Subven√ß√µes Econ√¥micas - COPEC` = list(
    criterio = "
    ug_executora_codigo == '170700' &
    conta_contabil_numero %in% c('395010100', '395110100') &
    evento_codigo == '541559'
    "
  ),

  # ---------------------------------------------------------------------------
  # VPD - OUTRAS VARIA√á√ïES CAMBIAIS
  # Print: vpd_03.png
  # Contas: 343910200, 343940200, 343950200
  # (UG: 170512, 170700) OU (UG 380916 E NS Classif. Cont√°bil 2: 121110309)
  # NOTA: O filtro de NS Classif. Cont√°bil 2 foi omitido
  # ---------------------------------------------------------------------------
  `58 VPD - Outras Varia√ß√µes Cambiais` = list(
    criterio = "
    conta_contabil_numero %in% c('343910200', '343940200', '343950200') &
    ug_executora_codigo %in% c('170512', '170700', '380916')
    "
  ),

  # ---------------------------------------------------------------------------
  # VPD - DESINCORPORA√á√ÉO DE ATIVOS
  # Print: vpd_03.png
  # Contas: 365040100, 365010100, 365050100, 365140100, 365110100, 365150100
  # UGs: 170512, 170700
  #
  # NOTA: No arquivo atual s√≥ existem 365110100 e 365140100
  # As contas 365010100, 365040100, 365050100, 365150100 N√ÉO EXISTEM
  # Isso causa diferen√ßa de ~84 mi. Necess√°rio reextrair do TG.
  # ---------------------------------------------------------------------------
  `59 VPD - Desincorpora√ß√£o de Ativos` = list(
    criterio = "
    conta_contabil_numero %in% c('365010100', '365040100', '365050100', 
                                 '365110100', '365140100', '365150100') &
    ug_executora_codigo %in% c('170512', '170700')
    "
  ),

  # ---------------------------------------------------------------------------
  # VPD - REVERS√ÉO DE SUBVEN√á√ïES ECON√îMICAS - COPEC
  # Print: vpd_04.png
  # Evento: 541559
  # Contas: 395010100, 395110100
  # UG: 170700
  # ---------------------------------------------------------------------------
  `60 VPD - Revers√£o de Subven√ß√µes Econ√¥micas - COPEC` = list(
    criterio = "
    conta_contabil_numero %in% c('395010100', '395110100') &
    evento_codigo == '541559' &
    ug_executora_codigo == '170700'
    "
  ),

  # ---------------------------------------------------------------------------
  # VPD - VAR MONET E CAMBIAIS DE EMPREST e FINANC CONCEDIDOS
  # Print: vpd_04.png
  # Contas: 343510200, 343540200, 343550200, 343510100
  # UGs: 170512, 170526, 170705, 170600, 380916, 170700
  # ---------------------------------------------------------------------------
  `61 VPD - Var Monet e Cambiais de Emprest e Financ Concedidos` = list(
    criterio = "
    conta_contabil_numero %in% c('343510100', '343510200', '343540200', '343550200') &
    ug_executora_codigo %in% c('170512', '170526', '170600', '170700', '170705', '380916')
    "
  ),

  # ---------------------------------------------------------------------------
  # VPA - VAR MONET E CAMBIAIS DE EMPREST e FINANC CONCEDIDOS
  # Print: vpd_04.png
  # Contas: 443140100, 443150100, 443110100, 443310100, 443340100
  # UGs: 170512, 170526, 170705, 170600, 380916, 170700
  #
  # NOTA: No arquivo atual s√≥ existem 443110100 e 443310100
  # As contas 443140100, 443150100, 443340100 N√ÉO EXISTEM
  # Isso causa diferen√ßa de ~55 bi. Necess√°rio reextrair do TG.
  # ---------------------------------------------------------------------------
  `62 VPA - Var Monet e Cambiais de Emprest e Financ Concedidos` = list(
    criterio = "
    conta_contabil_numero %in% c('443110100', '443140100', '443150100', 
                                 '443310100', '443340100') &
    ug_executora_codigo %in% c('170512', '170526', '170600', '170700', '170705', '380916')
    "
  ),

  # ---------------------------------------------------------------------------
  # VPA - ATUALIZA√á√ÉO MONET√ÅRIA POSITIVA
  # Print: vpd_05.png
  # Contas: 443910101, 443940101, 443950101
  # UGs: 170512, 170526, 170705, 170600, 170700
  # ---------------------------------------------------------------------------
  `63 VPA - Atualiza√ß√£o Monet√°ria Positiva` = list(
    criterio = "
    conta_contabil_numero %in% c('443910101', '443940101', '443950101') &
    ug_executora_codigo %in% c('170512', '170526', '170600', '170700', '170705')
    "
  ),

  # ---------------------------------------------------------------------------
  # VPA - OUTRAS VARIA√á√ïES MONET√ÅRIAS
  # Print: vpd_05.png
  # Contas: 443910100, 443940100, 443950100
  # UGs: 170512, 170526, 170705, 170600, 170700
  # ---------------------------------------------------------------------------
  `64 VPA - Outras Varia√ß√µes Monet√°rias` = list(
    criterio = "
    conta_contabil_numero %in% c('443910100', '443940100', '443950100') &
    ug_executora_codigo %in% c('170512', '170526', '170600', '170700', '170705')
    "
  ),

  # ---------------------------------------------------------------------------
  # VPA - OUTRAS VARIA√á√ïES CAMBIAIS
  # Print: vpd_05.png
  # Contas: 443910200, 443940200, 443950200
  # UGs: 170512, 170526, 170705, 170600, 120002, 170700
  # ---------------------------------------------------------------------------
  `65 VPA - Outras Varia√ß√µes Cambiais` = list(
    criterio = "
    conta_contabil_numero %in% c('443910200', '443940200', '443950200') &
    ug_executora_codigo %in% c('120002', '170512', '170526', '170600', '170700', '170705')
    "
  ),

  # ---------------------------------------------------------------------------
  # VPA - GANHOS COM DESINCORPORA√á√ÉO DE PASSIVOS
  # Print: vpd_06.png
  # Contas: 464010100, 464040100, 464050100, 464110100, 464140100, 464150100
  # UG: 170600
  # ---------------------------------------------------------------------------
  `66 VPA - Ganhos com Desincorpora√ß√£o de Passivos` = list(
    criterio = "
    conta_contabil_numero %in% c('464010100', '464040100', '464050100',
                                 '464110100', '464140100', '464150100') &
    ug_executora_codigo == '170600'
    "
  ),

  # ---------------------------------------------------------------------------
  # VPA - RESULTADO POSITIVO BACEN
  # Print: vpd_06.png
  # Conta: 448110100
  # ---------------------------------------------------------------------------
  `67 VPA - Resultado Positivo BACEN` = list(
    criterio = "
    conta_contabil_numero == '448110100'
    "
  ),

  # ---------------------------------------------------------------------------
  # VPA - OUTRAS VAR PATRIMONIAIS AUMENTATIVAS
  # Print: vpd_06.png
  # Contas: 449010100, 449040100, 449050100, 449110100, 449140100, 449150100
  # UGs: 170512, 170705, 170526
  # ---------------------------------------------------------------------------
  `68 VPA - Outras Varia√ß√µes Patrimoniais Aumentativas` = list(
    criterio = "
    conta_contabil_numero %in% c('449010100', '449040100', '449050100',
                                 '449110100', '449140100', '449150100') &
    ug_executora_codigo %in% c('170512', '170526', '170705')
    "
  ),

  # ---------------------------------------------------------------------------
  # VPA - REMUNERA√á√ÉO DOS DEP√ìSITOS BANC√ÅRIOS (FINANCEIRO???)
  # Print: vpd_07.png
  # Contas: 445110100, 445210100
  # AND NOT (√ìrg√£o UGE Tipo Administra√ß√£o = 7:FUNDOS) EXCETO UG 380916
  # Evento N√£o em: 581798, 586798
  # ---------------------------------------------------------------------------
  `69 VPA - Remunera√ß√£o dos Dep√≥sitos Banc√°rios` = list(
    criterio = "
    conta_contabil_numero %in% c('445110100', '445210100') &
    (orgao_uge_tipo_administracao_codigo != '7' | ug_executora_codigo == '380916') &
    !(evento_codigo %in% c('581798', '586798'))
    "
  ),

  # ---------------------------------------------------------------------------
  # VPA - REVERS√ÉO DE PROVIS√ïES E DE AJUSTES PARA PERDAS
  # Print: vpd_07.png
  # Contas: 497110100, 497140100, 497150100, 497210100, 497240100
  # UGs: 170700, 170512, 170526, 170705
  # ---------------------------------------------------------------------------
  `70 VPA - Revers√£o de Provis√µes e de Ajustes para Perdas` = list(
    criterio = "
    conta_contabil_numero %in% c('497110100', '497140100', '497150100',
                                 '497210100', '497240100') &
    ug_executora_codigo %in% c('170512', '170526', '170700', '170705')
    "
  ),

  # ---------------------------------------------------------------------------
  # VPA - OUTROS GANHOS COM INCORPORA√á√ÉO DE ATIVOS
  # Print: vpd_07.png
  # Contas: 463920100, 463940100
  # UG: 170512
  # ---------------------------------------------------------------------------
  `71 VPA - Outros Ganhos com Incorpora√ß√£o de Ativos` = list(
    criterio = "
    conta_contabil_numero %in% c('463920100', '463940100') &
    ug_executora_codigo == '170512'
    "
  ),

  # ---------------------------------------------------------------------------
  # (-) CR√âDITO EMPENHADO EM LIQUIDA√á√ÉO (EXCETO CODIV)
  # Print: vpd_08.png
  # Conta: 622130200
  # UG Executora N√ÉO RELACIONADO: 170600 (ou seja, EXCLUI a UG 170600!)
  # ---------------------------------------------------------------------------
  `72 Cr√©dito Empenhado em Liquida√ß√£o (exceto CODIV)` = list(
    criterio = "
    conta_contabil_numero == '622130200' &
    ug_executora_codigo != '170600'
    "
  ),

  # ---------------------------------------------------------------------------
  # APLICA√á√ïES FINANCEIRAS - FECHAMENTO C√ÇMBIO
  # Print: vpd_08.png
  # Conta: 111215100
  # ---------------------------------------------------------------------------
  `73 Aplica√ß√µes Financeiras - Fechamento C√¢mbio` = list(
    criterio = "
    conta_contabil_numero == '111215100'
    "
  ),

  # ---------------------------------------------------------------------------
  # JUROS E ENCARGOS PASSIVOS - OUTRAS VPD FINANCEIRAS
  # Print: vpd_08.png
  # Contas: 349910100, 349940100, 349950100
  # UGs: 170512, 170500
  # ---------------------------------------------------------------------------
  `74 Juros e Encargos Passivos - Outras VPD Financeiras` = list(
    criterio = "
    conta_contabil_numero %in% c('349910100', '349940100', '349950100') &
    ug_executora_codigo %in% c('170500', '170512')
    "
  ),

  # ---------------------------------------------------------------------------
  # PASSIVO D√çVIDA P√öBLICA REF FIES E MANTENEDORAS
  # Print: vpd_09.png
  # Evento: 591738
  # Conta: 222110101
  # ---------------------------------------------------------------------------
  `75 Passivo D√≠vida P√∫blica REF FIES e Mantenedoras` = list(
    criterio = "
    conta_contabil_numero == '222110101' &
    evento_codigo == '591738'
    "
  ),

  # ---------------------------------------------------------------------------
  # AJUSTES DE EXERC√çCIOS ANTERIORES
  # Print: vpd_09.png
  # Conta: 237110300
  # UGs: 170512, 170700
  # ---------------------------------------------------------------------------
  `76 Ajustes de Exerc√≠cios Anteriores` = list(
    criterio = "
    conta_contabil_numero == '237110300' &
    ug_executora_codigo %in% c('170512', '170700')
    "
  )
)
```

![ajustar totaliza√ß√£o](subsitio_cesef.png)

```{r processar_resultado_primario}


# Aplicar crit√©rios e consolidar em uma √∫nica opera√ß√£o
rreo_a06_consolidado <- bind_rows(
  aplicar_criterios(
    df = dados_categoria_grupo %>% filter(mes_lancamento == mes_filtro, item_informacao_codigo == "56"),
    criterios = criterios_rreo_A06_despesas_categoria_grupo_A06
  ),
  aplicar_criterios(
    df = dados_receita,
    criterios = criterios_rreo_A06_receitas_A06
  ),
  aplicar_criterios(
    df = dados_ndd %>% filter(item_informacao_codigo == "56", mes_lancamento == mes_filtro),
    criterios = criterios_rreo_A06_despesas_natureza_detalhada_A06
  ),
  # Item 37 - Subs√≠dios CESEF (fonte: dados_despesa)
  aplicar_criterios(
    df = dados_despesa %>% filter(mes_lancamento == mes_filtro, item_informacao_codigo == "56"),
    criterios = criterios_rreo_A06_subsidios_cesef
  ),
  aplicar_criterios(
    df = dados_juros,
    criterios = criterios_rreo_A06_juros_ativos_passivos_A06
  ),
  aplicar_criterios(
    df = tg_RPN_disponibilidades,
    criterios = criterios_rreo_A06_disponibilidades_A06
  ),
  aplicar_criterios(
    df = dados_ajustes,
    criterios = criterios_rreo_A06_ajuste
  )
)

# Agrupar por mes_lancamento, categoria e somar valores
rreo_a06_final <- rreo_a06_consolidado %>%
  group_by(mes_lancamento, categoria, ordem) %>%
  summarise(
    valor = sum(valor, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(mes_lancamento, categoria)
  
  

datatable(rreo_a06_final)%>%
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")
 
  


```

```{r}
# ==============================================================================
# RREO ANEXO 6 - RESULTADO PRIM√ÅRIO E NOMINAL
# ==============================================================================
# Dados: rreo_a06_final (consolidado de todos os crit√©rios)
# Ajuste Metodol√≥gico: planilha comparativo.xlsx (RP_RTN) - RP_TG calculado
#
# F√ìRMULAS:
#   Receita Prim√°ria = Rec.Correntes - Aplica√ß√µes - Outras Fin. + Rec.Capital - Op.Cr√©d - Amort.Emp - Outras N√£o Prim
#   Despesa Prim√°ria = Desp.Correntes - Juros + Desp.Capital + Subs√≠dios - Amortiza√ß√£o - Concess√£o
#   RP TG = Receita Prim√°ria - Despesa Prim√°ria
#   Ajuste Metodol√≥gico = RP_RTN (linha 6 comparativo) - RP_TG
#   RP Final = RP TG + Ajuste Metodol√≥gico
#   Juros Ativos = Item 41 + Item 62 + Item 63 + Item 64
#   Juros Passivos = Item 42 + Item 50 + Item 52 + Item 54 + Item 61
#   RN = RP Final + Juros Ativos - Juros Passivos
# ==============================================================================

#| echo: true
#| output: true

# ------------------------------------------------------------------------------
# 1. FUN√á√ÉO AUXILIAR - Obter valor por c√≥digo da categoria
# ------------------------------------------------------------------------------
obter_valor <- function(codigo) {
  linha <- rreo_a06_final %>% 
    filter(str_detect(categoria, paste0("^", sprintf("%02d", codigo), " ")))
  if (nrow(linha) == 0) return(0)
  return(linha$valor[1])
}

# ------------------------------------------------------------------------------
# 2. RECEITAS PRIM√ÅRIAS
# ------------------------------------------------------------------------------
rec_correntes <- obter_valor(1)
aplicacoes_fin <- obter_valor(5)
outras_rec_fin <- obter_valor(9)
rec_capital <- obter_valor(12)
op_credito <- obter_valor(13)
amort_emprestimos <- obter_valor(14)
outras_rec_cap_nao_prim <- obter_valor(20)

receita_primaria_corrente <- rec_correntes - aplicacoes_fin - outras_rec_fin
receita_primaria_capital <- rec_capital - op_credito - amort_emprestimos - outras_rec_cap_nao_prim
receita_primaria_total <- receita_primaria_corrente + receita_primaria_capital

# ------------------------------------------------------------------------------
# 3. DESPESAS PRIM√ÅRIAS
# ------------------------------------------------------------------------------
desp_correntes <- obter_valor(23)
juros_divida <- obter_valor(25)
desp_capital <- obter_valor(28)
amort_divida <- obter_valor(31)
conc_emprestimos <- obter_valor(34)
subsidios_cesef <- obter_valor(37)

despesa_primaria_corrente <- desp_correntes - juros_divida
despesa_primaria_capital <- desp_capital + subsidios_cesef - amort_divida - conc_emprestimos
despesa_primaria_total <- despesa_primaria_corrente + despesa_primaria_capital

# ------------------------------------------------------------------------------
# 4. RESULTADO PRIM√ÅRIO TG (sem ajuste)
# ------------------------------------------------------------------------------
resultado_primario_tg <- receita_primaria_total - despesa_primaria_total

# ------------------------------------------------------------------------------
# 5. AJUSTE METODOL√ìGICO = RP_RTN - RP_TG
# ------------------------------------------------------------------------------
arquivo_comparativo <- str_c(mes_pasta, "comparativo.xlsx")

ajuste_metodologico <- tryCatch({
  if (file.exists(arquivo_comparativo)) {
    mes_ref <- as.numeric(substr(mes_filtro, 5, 6))
    col_inicio <- 86  # CH = janeiro/2025
    col_fim <- col_inicio + mes_ref - 1
    
    # Linha 6: I. RESULTADO PRIM√ÅRIO - RTN
    rp_rtn_dados <- read_excel(
      arquivo_comparativo, 
      sheet = "Comparativo", 
      range = cellranger::cell_limits(c(6, col_inicio), c(6, col_fim)),
      col_names = FALSE
    )
    
    # Somar valores RTN (em milh√µes) e converter para unidades
    soma_rp_rtn <- sum(as.numeric(rp_rtn_dados), na.rm = TRUE) * 1000000
    
    # Ajuste = RP_RTN - RP_TG
    ajuste <- soma_rp_rtn - resultado_primario_tg
    ajuste
  } else {
    warning(sprintf("Arquivo n√£o encontrado: %s\nUsando ajuste = 0", arquivo_comparativo))
    0
  }
}, error = function(e) {
  warning(sprintf("Erro ao ler comparativo: %s\nUsando ajuste = 0", e$message))
  0
})

# ------------------------------------------------------------------------------
# 6. RESULTADO PRIM√ÅRIO FINAL
# ------------------------------------------------------------------------------
resultado_primario_final <- resultado_primario_tg + ajuste_metodologico

# ------------------------------------------------------------------------------
# 7. JUROS NOMINAIS
# ------------------------------------------------------------------------------
# Juros Ativos (XXV) = Item 41 + Item 62 + Item 63 + Item 64
# Juros Passivos (XXVI) = Item 42 + Item 50 + Item 52 + Item 54 + Item 61

item_41 <- obter_valor(41)  # Juros Ativos (base)
item_62 <- obter_valor(62)  # VPA - Var Monet Emprest Concedidos
item_63 <- obter_valor(63)  # VPA - Atualiza√ß√£o Monet√°ria Positiva
item_64 <- obter_valor(64)  # VPA - Outras Varia√ß√µes Monet√°rias

item_42 <- obter_valor(42)  # Juros Passivos (base)
item_50 <- obter_valor(50)  # VPD - Var Monet√°ria D√≠vida Contratual
item_52 <- obter_valor(52)  # VPD - Var Monet√°ria D√≠vida Mobili√°ria
item_54 <- obter_valor(54)  # VPD - Atualiza√ß√£o Monet√°ria Negativa
item_61 <- obter_valor(61)  # VPD - Var Monet Emprest Concedidos

juros_ativos <- item_41 + item_62 + item_63 + item_64
juros_passivos <- item_42 + item_50 + item_52 + item_54 + item_61

# ------------------------------------------------------------------------------
# 8. RESULTADO NOMINAL
# ------------------------------------------------------------------------------
resultado_nominal_final <- resultado_primario_final + juros_ativos - juros_passivos

# ------------------------------------------------------------------------------
# 9. TABELA RESUMO FINAL
# ------------------------------------------------------------------------------
resultado_final <- tibble(
  componente = c(
    "RECEITAS PRIM√ÅRIAS",
    "  Receita Prim√°ria Corrente (I - II - III)",
    "  Receita Prim√°ria de Capital (V - VI - VII - X)",
    "  RECEITA PRIM√ÅRIA TOTAL (III)",
    "",
    "DESPESAS PRIM√ÅRIAS",
    "  Despesa Prim√°ria Corrente (XIII - XIV)",
    "  Despesa Prim√°ria de Capital (XVI + Subs√≠dios - XX - XVII)",
    "  DESPESA PRIM√ÅRIA TOTAL (VIII)",
    "",
    "RESULTADO PRIM√ÅRIO TG (III - VIII)",
    "(+) Ajuste Metodol√≥gico (RTN - TG)",
    "RESULTADO PRIM√ÅRIO FINAL (VI)",
    "",
    "JUROS NOMINAIS",
    "  Juros e Encargos Ativos (VII)",
    "    Item 41 - Juros Ativos (base)",
    "    Item 62 - VPA Var Monet Emprest Concedidos",
    "    Item 63 - VPA Atualiza√ß√£o Monet√°ria Positiva",
    "    Item 64 - VPA Outras Varia√ß√µes Monet√°rias",
    "  Juros e Encargos Passivos (VIII)",
    "    Item 42 - Juros Passivos (base)",
    "    Item 50 - VPD Var Monet√°ria D√≠vida Contratual",
    "    Item 52 - VPD Var Monet√°ria D√≠vida Mobili√°ria",
    "    Item 54 - VPD Atualiza√ß√£o Monet√°ria Negativa",
    "    Item 61 - VPD Var Monet Emprest Concedidos",
    "",
    "RESULTADO NOMINAL (IX) = VI + VII - VIII"
  ),
  valor = c(
    NA,
    receita_primaria_corrente,
    receita_primaria_capital,
    receita_primaria_total,
    NA,
    NA,
    despesa_primaria_corrente,
    despesa_primaria_capital,
    despesa_primaria_total,
    NA,
    resultado_primario_tg,
    ajuste_metodologico,
    resultado_primario_final,
    NA,
    NA,
    juros_ativos,
    item_41,
    item_62,
    item_63,
    item_64,
    juros_passivos,
    item_42,
    item_50,
    item_52,
    item_54,
    item_61,
    NA,
    resultado_nominal_final
  )
)

datatable(
  resultado_final %>%
    mutate(
      valor_milhares = round(valor / 1000, 0),
      valor = ifelse(is.na(valor), "", format(round(valor, 0), big.mark = ".", decimal.mark = ",")),
      valor_milhares = ifelse(valor == "", "", format(valor_milhares, big.mark = ".", decimal.mark = ","))
    ),
  caption = "RREO Anexo 6 - Resultado Prim√°rio e Nominal",
  options = list(pageLength = 30, dom = 't',
    columnDefs = list(list(className = 'dt-right', targets = c(1, 2)))),
  rownames = FALSE
) %>%
  formatStyle('componente', fontWeight = styleEqual(
    c("  RECEITA PRIM√ÅRIA TOTAL (III)", "  DESPESA PRIM√ÅRIA TOTAL (VIII)", 
      "RESULTADO PRIM√ÅRIO FINAL (VI)", "  Juros e Encargos Ativos (VII)",
      "  Juros e Encargos Passivos (VIII)", "RESULTADO NOMINAL (IX) = VI + VII - VIII"),
    rep("bold", 6)
  ))

# ------------------------------------------------------------------------------
# 10. EXPORTAR VARI√ÅVEIS
# ------------------------------------------------------------------------------
valor_resultado_primario <- resultado_primario_final
valor_resultado_nominal <- resultado_nominal_final
valor_ajuste_metodologico <- ajuste_metodologico
valor_juros_ativos <- juros_ativos
valor_juros_passivos <- juros_passivos
```

```{r}
# ==============================================================================
# RREO ANEXO 6 - RESULTADO NOMINAL ABAIXO DA LINHA (SIMPLIFICADO)
# ==============================================================================
# F√≥rmula: RN = DCL(dez/24) - DCL(nov/25)
# ==============================================================================

#| echo: true
#| output: true

# ==============================================================================
# RREO ANEXO 6 - RESULTADO NOMINAL ABAIXO DA LINHA E DISCREP√ÇNCIA
# ==============================================================================
# F√≥rmula: 
#   RN Abaixo da Linha = DCL(dez/24) - DCL(atual)
#   Discrep√¢ncia = RN Acima da Linha - RN Abaixo da Linha
#
# Pr√©-requisitos:
#   - valor_dcl_num (calculado no chunk da DCL, valor num√©rico)
#   - resultado_nominal_final (calculado no chunk Resultado Prim√°rio e Nominal)
# ==============================================================================

#| echo: true
#| output: true

# DCL Dezembro/2024 (valor oficial em R$ milhares)
dcl_dez_2024 <- 7177279131

# DCL Atual (em R$ milhares)
dcl_atual <- round(valor_dcl_num / 1000, 0)

# Resultado Nominal Abaixo da Linha
rn_abaixo_linha <- dcl_dez_2024 - dcl_atual

# Resultado Nominal Acima da Linha (j√° calculado anteriormente)
rn_acima_linha <- round(resultado_nominal_final / 1000, 0)

# Discrep√¢ncia
discrepancia <- rn_acima_linha - rn_abaixo_linha

# Exibir resultado
tibble(
  componente = c(
    "DCL Dezembro/2024 (a)",
    "DCL Atual (b)", 
    "RESULTADO NOMINAL - Abaixo da Linha (a - b)",
    "",
    "RESULTADO NOMINAL - Acima da Linha",
    "",
    "DISCREP√ÇNCIA"
  ),
  valor_milhares = c(dcl_dez_2024, dcl_atual, rn_abaixo_linha, NA, rn_acima_linha, NA, discrepancia)
) %>%
  mutate(valor_milhares = ifelse(is.na(valor_milhares), "", 
                                 format(valor_milhares, big.mark = ".", decimal.mark = ","))) %>%
  knitr::kable(col.names = c("Componente", "R$ milhares"), align = c("l", "r"))



```

```{r}
# ==============================================================================
# RREO ANEXO 6 - RESULTADO NOMINAL E PRIM√ÅRIO ABAIXO DA LINHA
# ==============================================================================
# F√≥rmulas: 
#   RN Abaixo da Linha (XIV) = DCL(dez/24) - DCL(atual)
#   RN Ajustado (XIX) = XIV + XV - XI + XX + XVIII
#   RP Abaixo da Linha = RN Ajustado - (Juros Ativos - Juros Passivos)
#
# Pr√©-requisitos:
#   - valor_dcl_num (do chunk DCL)
#   - resultado_nominal_final, juros_ativos, juros_passivos (do chunk RP/RN)
#   - valores_linhas (da DCL consolidada)
#   - rreo_a06_final (crit√©rios consolidados)
# ==============================================================================

#| echo: true
#| output: true

# ------------------------------------------------------------------------------
# 1. VALORES DEZEMBRO/2024 (oficiais em R$ milhares)
# ------------------------------------------------------------------------------
dez_2024 <- list(
  dcl = 7177279131,
  rp_processados = 129994061,
  passivos_insuf = 0,
  precatorios = 3997030,
  aplic_fundos = 40841099
)

# ------------------------------------------------------------------------------
# 2. FUN√á√ÉO AUXILIAR - Obter valor por ordem do rreo_a06_final
# ------------------------------------------------------------------------------
obter_item <- function(cod) {
  linha <- rreo_a06_final %>% filter(ordem == sprintf("%02d", cod))
  if (nrow(linha) == 0) return(0)
  linha$valor[1] / 1000  # Converter para milhares
}

# ------------------------------------------------------------------------------
# 3. VALORES ATUAIS (de valores_linhas, em milhares)
# ------------------------------------------------------------------------------
obter_ordem <- function(ordens) {
  valores_linhas %>% 
    filter(ordem %in% ordens) %>% 
    summarise(v = sum(valor_total, na.rm = TRUE)) %>% 
    pull(v) / 1000
}

atual <- list(
  dcl = round(valor_dcl_num / 1000, 0),
  rp_processados = obter_ordem("25"),
  passivos_insuf = obter_ordem("10"),
  precatorios = obter_ordem(c("08", "38")),
  aplic_fundos = obter_ordem(c("14", "15", "16"))
)

# ------------------------------------------------------------------------------
# 4. RESULTADO NOMINAL - ABAIXO DA LINHA (XIV)
# ------------------------------------------------------------------------------
rn_abaixo_linha <- dez_2024$dcl - atual$dcl

# ------------------------------------------------------------------------------
# 5. AJUSTES PARA RESULTADO NOMINAL AJUSTADO
# ------------------------------------------------------------------------------

# 5.1 Varia√ß√£o Saldo RPP (XV)
var_saldo_rpp <- atual$rp_processados - dez_2024$rp_processados

# 5.2 Receita Aliena√ß√£o Investimentos (XI)
receita_alien_invest <- 0

# 5.3 Passivos Reconhecidos (XX)
passivos_reconhecidos <- atual$passivos_insuf - dez_2024$passivos_insuf

# ------------------------------------------------------------------------------
# 6. OUTROS AJUSTES (XVIII) - C√°lculo autom√°tico
# ------------------------------------------------------------------------------

# 6.1 VPDs (+) - Varia√ß√µes Patrimoniais Diminutivas
vpd_var_cambial_contratual <- obter_item(51)
vpd_var_cambial_mobiliaria <- obter_item(53)
vpd_resultado_neg_bacen <- 0  # Quando houver crit√©rio
vpd_constituicao_ajustes <- 9748641  # TODO: criar crit√©rio espec√≠fico
vpd_reversao_subvencoes <- obter_item(57)
vpd_outras_var_cambiais <- obter_item(58)
vpd_desincorp_ativos <- obter_item(59)

total_vpds <- vpd_var_cambial_contratual + vpd_var_cambial_mobiliaria + 
              vpd_resultado_neg_bacen + vpd_constituicao_ajustes + 
              vpd_reversao_subvencoes + vpd_outras_var_cambiais + vpd_desincorp_ativos

# 6.2 VPAs (-) - Varia√ß√µes Patrimoniais Aumentativas
vpa_outras_var_cambiais <- obter_item(65)
vpa_resultado_pos_bacen <- 0  # Quando houver crit√©rio
vpa_outras_var_patrim <- obter_item(68)
vpa_ganhos_incorp_ativos <- obter_item(71)
vpa_reversao_provisoes <- obter_item(70)

total_vpas <- vpa_outras_var_cambiais + vpa_resultado_pos_bacen + 
              vpa_outras_var_patrim + vpa_ganhos_incorp_ativos + vpa_reversao_provisoes

# 6.3 Demais Ajustes - Ajustes na DCL
var_precatorios <- atual$precatorios - dez_2024$precatorios
var_aplic_fundos <- atual$aplic_fundos - dez_2024$aplic_fundos

juros_ativos_fundos <- obter_item(43)
juros_passivos_fundos <- obter_item(44)
juros_fundos_liquido <- juros_ativos_fundos - juros_passivos_fundos

fies <- obter_item(75)

ajustes_dcl <- var_precatorios - var_aplic_fundos + juros_fundos_liquido + fies

# 6.4 Outros
desp_fin_impacto_primario <- 7801975  # TODO: criar crit√©rio espec√≠fico
ajustes_exerc_anteriores <- obter_item(76)

outros <- -(desp_fin_impacto_primario + ajustes_exerc_anteriores)

demais_ajustes <- ajustes_dcl + outros

# Total Outros Ajustes
outros_ajustes <- total_vpds - total_vpas + demais_ajustes

# ------------------------------------------------------------------------------
# 7. RESULTADO NOMINAL AJUSTADO - ABAIXO DA LINHA (XIX)
# ------------------------------------------------------------------------------
rn_ajustado_abaixo <- rn_abaixo_linha + var_saldo_rpp - receita_alien_invest + 
                      passivos_reconhecidos + outros_ajustes

# ------------------------------------------------------------------------------
# 8. JUROS NOMINAIS (j√° calculados no chunk anterior)
# ------------------------------------------------------------------------------
juros_nominais <- round((juros_ativos - juros_passivos) / 1000, 0)

# ------------------------------------------------------------------------------
# 9. RESULTADO PRIM√ÅRIO - ABAIXO DA LINHA
# ------------------------------------------------------------------------------
rp_abaixo_linha <- rn_ajustado_abaixo - juros_nominais

# ------------------------------------------------------------------------------
# 10. RESULTADO NOMINAL - ACIMA DA LINHA (j√° calculado)
# ------------------------------------------------------------------------------
rn_acima_linha <- round(resultado_nominal_final / 1000, 0)

# ------------------------------------------------------------------------------
# 11. DISCREP√ÇNCIA
# ------------------------------------------------------------------------------
discrepancia <- rn_acima_linha - rn_ajustado_abaixo

# ------------------------------------------------------------------------------
# 12. TABELA RESULTADO NOMINAL ABAIXO DA LINHA
# ------------------------------------------------------------------------------
tabela_rn_abaixo <- tibble(
  componente = c(
    "C√ÅLCULO DO RESULTADO NOMINAL - ABAIXO DA LINHA",
    "",
    "DCL Dezembro/2024 (a)",
    "DCL Atual (b)",
    "RESULTADO NOMINAL - Abaixo da Linha (XIV) = (a - b)",
    "",
    "VARIA√á√ÉO SALDO RPP (XV)",
    "RECEITA ALIENA√á√ÉO INVEST. PERMANENTES (XI)",
    "PASSIVOS RECONHECIDOS NA DC (XX)",
    "OUTROS AJUSTES (XVIII)",
    "",
    "RESULTADO NOMINAL AJUSTADO - Abaixo da Linha (XIX)",
    "",
    "RESULTADO NOMINAL - Acima da Linha (IX)",
    "",
    "DISCREP√ÇNCIA"
  ),
  valor_milhares = c(
    NA, NA,
    dez_2024$dcl,
    atual$dcl,
    rn_abaixo_linha,
    NA,
    var_saldo_rpp,
    receita_alien_invest,
    passivos_reconhecidos,
    outros_ajustes,
    NA,
    rn_ajustado_abaixo,
    NA,
    rn_acima_linha,
    NA,
    discrepancia
  )
)

tabela_rn_abaixo %>%
  mutate(valor_milhares = ifelse(is.na(valor_milhares), "", 
                                 format(round(valor_milhares, 0), big.mark = ".", decimal.mark = ","))) %>%
  knitr::kable(col.names = c("Componente", "R$ milhares"), align = c("l", "r"),
               caption = "RREO Anexo 6 - Resultado Nominal Abaixo da Linha")

# ------------------------------------------------------------------------------
# 13. DETALHAMENTO OUTROS AJUSTES (XVIII)
# ------------------------------------------------------------------------------
tabela_outros_ajustes <- tibble(
  componente = c(
    "OUTROS AJUSTES (XVIII) - DETALHAMENTO",
    "",
    "(+) Varia√ß√µes Patrimoniais Diminutivas",
    "    (+) Varia√ß√µes Cambiais D√≠vida Contratual (item 51)",
    "    (+) Varia√ß√µes Cambiais D√≠vida Mobili√°ria (item 53)",
    "    (+) Resultado Negativo Bacen",
    "    (+) Constitui√ß√£o Ajuste Perdas [FIXO]",
    "    (+) Revers√£o Provis√µes Subven√ß√µes - COPEC (item 57)",
    "    (+) Outras Varia√ß√µes Cambiais (item 58)",
    "    (+) Desincorpora√ß√£o Ativos (item 59)",
    "",
    "(-) Varia√ß√µes Patrimoniais Aumentativas",
    "    (-) Outras Varia√ß√µes Cambiais (item 65)",
    "    (-) Resultado Positivo Bacen",
    "    (-) Outras Varia√ß√µes Patrimoniais (item 68)",
    "    (-) Outros Ganhos Incorpora√ß√£o Ativos (item 71)",
    "    (-) Revers√£o Provis√µes/Ajustes (item 70)",
    "",
    "(+) Demais Ajustes",
    "    (+) Varia√ß√£o Precat√≥rios",
    "    (-) Varia√ß√£o Aplic Fundos",
    "    (+) Juros Fundos L√≠quido (item 43 - item 44)",
    "    (+) FIES (item 75)",
    "    (-) Desp Fin Impacto Prim√°rio [FIXO]",
    "    (-) Ajustes Exerc Anteriores (item 76)",
    "",
    "TOTAL OUTROS AJUSTES (XVIII)"
  ),
  valor_milhares = c(
    NA, NA,
    total_vpds,
    vpd_var_cambial_contratual,
    vpd_var_cambial_mobiliaria,
    vpd_resultado_neg_bacen,
    vpd_constituicao_ajustes,
    vpd_reversao_subvencoes,
    vpd_outras_var_cambiais,
    vpd_desincorp_ativos,
    NA,
    total_vpas,
    vpa_outras_var_cambiais,
    vpa_resultado_pos_bacen,
    vpa_outras_var_patrim,
    vpa_ganhos_incorp_ativos,
    vpa_reversao_provisoes,
    NA,
    demais_ajustes,
    var_precatorios,
    -var_aplic_fundos,
    juros_fundos_liquido,
    fies,
    -desp_fin_impacto_primario,
    -ajustes_exerc_anteriores,
    NA,
    outros_ajustes
  )
)

tabela_outros_ajustes %>%
  mutate(valor_milhares = ifelse(is.na(valor_milhares), "", 
                                 format(round(valor_milhares, 0), big.mark = ".", decimal.mark = ","))) %>%
  knitr::kable(col.names = c("Componente", "R$ milhares"), align = c("l", "r"),
               caption = "Detalhamento dos Outros Ajustes (XVIII)")

# ------------------------------------------------------------------------------
# 14. TABELA RESULTADO PRIM√ÅRIO ABAIXO DA LINHA
# ------------------------------------------------------------------------------
tabela_rp_abaixo <- tibble(
  componente = c(
    "C√ÅLCULO DO RESULTADO PRIM√ÅRIO - ABAIXO DA LINHA",
    "",
    "RESULTADO NOMINAL AJUSTADO - Abaixo da Linha (XIX)",
    "(-) Juros e Encargos Ativos (VII)",
    "(+) Juros e Encargos Passivos (VIII)",
    "Juros Nominais (VII - VIII)",
    "",
    "RESULTADO PRIM√ÅRIO - Abaixo da Linha (XXIII) = XIX - (VII - VIII)"
  ),
  valor_milhares = c(
    NA, NA,
    rn_ajustado_abaixo,
    round(juros_ativos / 1000, 0),
    round(juros_passivos / 1000, 0),
    juros_nominais,
    NA,
    rp_abaixo_linha
  )
)

tabela_rp_abaixo %>%
  mutate(valor_milhares = ifelse(is.na(valor_milhares), "", 
                                 format(round(valor_milhares, 0), big.mark = ".", decimal.mark = ","))) %>%
  knitr::kable(col.names = c("Componente", "R$ milhares"), align = c("l", "r"),
               caption = "RREO Anexo 6 - Resultado Prim√°rio Abaixo da Linha")

# ------------------------------------------------------------------------------
# 15. RESUMO COMPARATIVO
# ------------------------------------------------------------------------------
cat("\n")
cat(strrep("=", 70), "\n")
cat("RESUMO COMPARATIVO - ACIMA x ABAIXO DA LINHA (R$ milhares)\n")
cat(strrep("=", 70), "\n")
cat(sprintf("Resultado Prim√°rio - Acima da Linha:    %s\n", 
            format(round(resultado_primario_final / 1000, 0), big.mark = ".", decimal.mark = ",")))
cat(sprintf("Resultado Prim√°rio - Abaixo da Linha:   %s\n", 
            format(round(rp_abaixo_linha, 0), big.mark = ".", decimal.mark = ",")))
cat(strrep("-", 70), "\n")
cat(sprintf("Resultado Nominal - Acima da Linha:     %s\n", 
            format(rn_acima_linha, big.mark = ".", decimal.mark = ",")))
cat(sprintf("Resultado Nominal Ajust - Abaixo:       %s\n", 
            format(round(rn_ajustado_abaixo, 0), big.mark = ".", decimal.mark = ",")))
cat(sprintf("Discrep√¢ncia:                           %s\n", 
            format(round(discrepancia, 0), big.mark = ".", decimal.mark = ",")))
cat(strrep("=", 70), "\n")

# ------------------------------------------------------------------------------
# 16. EXPORTAR VARI√ÅVEIS
# ------------------------------------------------------------------------------
valor_rn_abaixo_linha <- rn_abaixo_linha
valor_rn_ajustado_abaixo <- rn_ajustado_abaixo
valor_rp_abaixo_linha <- rp_abaixo_linha
valor_rn_acima_linha <- rn_acima_linha
valor_discrepancia <- discrepancia
valor_outros_ajustes <- outros_ajustes

```

# üìã RREO Anexo 07 - Restos a Pagar

## üìù Descri√ß√£o

Este anexo apresenta os Restos a Pagar classificados por:

-   **Tipo de Modalidade**: Intragovernamental vs Exceto Intragovernamental
-   **√ìrg√£o**: M√°ximo da estrutura organizacional
-   **Situa√ß√£o**: Processados e N√£o Processados

## üéØ Processamento dos Dados

### 

### Defini√ß√£o dos Agrupamentos

```{r agrupamentos_anexo_07}
#| echo: true

# Definir colunas de agrupamento
agrupado_despesa_tipo_modalidade_orgao <- c(
  "tipo_modalidade", 
  "orgao_uge_orgao_maximo_codigo", 
  "orgao_uge_orgao_maximo_nome"
)


```

## üìà Tabela Principal - Restos a Pagar por Modalidade e √ìrg√£o

```{r tabela_anexo_07}
#| echo: true

# Processar e exibir tabela principal usando fun√ß√µes centralizadas
# dt_formatada(
#   tabela_pivotada(dados_rp_anexo_07 %>% filter(mes_lancamento == mes_filtro), agrupado_despesa_tipo_modalidade_orgao), 
#   agrupado_despesa_tipo_modalidade_orgao
# )


datatable(dados_rp_anexo_07 %>%
            group_by( item_informacao_nome) %>%
            filter(mes_lancamento == mes_filtro) %>% 
            summarise(valor = sum(saldo_r_item_informacao, na.rm = TRUE)))%>%
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")
```

# üìã RREO Anexo 08 - MDE {#sec-anexo-08}

## üìù Descri√ß√£o

Este anexo apresenta as **Receitas e Despesas com Manuten√ß√£o e Desenvolvimento do Ensino (MDE)**, incluindo:

-   üìä **Classifica√ß√£o por categoria** conforme crit√©rios espec√≠ficos
-   üí∞ **C√°lculo da RLI** (Receita L√≠quida de Impostos)
-   üéØ **Percentual de aplica√ß√£o** em MDE
-   üìã **An√°lise de transfer√™ncias constitucionais**

## üéØ Defini√ß√£o dos Crit√©rios

### Crit√©rios de Educa√ß√£o

```{r criterios_educacao}
#| echo: true
#| include: false

# Definir a lista de crit√©rios para classifica√ß√£o das despesas MDE
criterios_rreo_A08_mde_despesas <- list(
  `01 - COMPLEMENTA√á√ÉO DA UNI√ÉO AO FUNDEB` = list(
    criterio = "acao_governo_codigo %in% c('00SB', '0E36')"
  ),
  `03 - EDUCA√á√ÉO B√ÅSICA` = list(
    criterio = "fonte_recursos_codigo %notin% c('008', '035', '133', '134', '213', '242') & iduso_codigo == 8 & elemento_despesa_codigo %notin% c('01', '03', '59') & subfuncao_governo_codigo == '368'"
  ),
  `04 - ENSINO SUPERIOR` = list(
    criterio = "fonte_recursos_codigo %notin% c('008', '035', '133', '134', '213', '242') & iduso_codigo == 8 & elemento_despesa_codigo %notin% c('01', '03', '59') & subfuncao_governo_codigo %in% c('364')"
  ),
  `05 - ENSINO PROFISSIONAL N√ÉO INTEGRADO AO ENSINO REGULAR` = list(
    criterio = "fonte_recursos_codigo %notin% c('008', '035', '133', '134') & iduso_codigo == 8 & elemento_despesa_codigo %notin% c('01', '03', '59') & subfuncao_governo_codigo == '363'"
  ),
  `06 - OUTRAS` = list(
    criterio = "fonte_recursos_codigo %notin% c('008', '035', '133', '134') & iduso_codigo == 8 & elemento_despesa_codigo %notin% c('01', '03', '59') & !subfuncao_governo_codigo %in% c('363', '364', '368') & acao_governo_codigo %notin% c('00SB', '0E36')"
  ),
  `08 - COMPLEMENTA√á√ÉO DA UNI√ÉO - VAAF` = list(
    criterio = "acao_governo_codigo %in% c('00SB', '0E36')  & plano_orcamentario_codigo_po == '0001'"
  ),
  `09 - COMPLEMENTA√á√ÉO DA UNI√ÉO - VAAT` = list(
    criterio = "acao_governo_codigo %in% c('00SB', '0E36') & plano_orcamentario_codigo_po %in% c('0002')  & plano_orcamentario_codigo_po %in% c('0003', '0004') & funcao_governo_codigo == '12' & subfuncao_governo_codigo == '847' & programa_governo_codigo == 5111 & acao_governo_codigo == '00SB' & unidade_orcamentaria_codigo == '26298' "
  ),
  `09b - VAAT po 26298 12 847 5111 00SB 0003` = list(
    criterio = "fonte_recursos_codigo %notin% c('008') & plano_orcamentario_codigo_po %in% c('0003') & funcao_governo_codigo == '12' & subfuncao_governo_codigo == '847' & programa_governo_codigo == 5111 & acao_governo_codigo == '00SB' & unidade_orcamentaria_codigo == '26298'"
  ),
  `11 - DESPESAS CUSTEADAS COM A CONTRIBUI√á√ÉO SOCIAL DO SAL√ÅRIO-EDUCA√á√ÉO` = list(
    criterio = "fonte_recursos_codigo %in% c('133', '134', '213', '008', '035', '212') & iduso_codigo == 8 & acao_governo_codigo %notin% c('00SB', '0E36')"
  ),
  `12 - DESPESAS COM O FUNDO CONSTITUCIONAL DO DISTRITO FEDERAL - FCDF` = list(
    criterio = "acao_governo_codigo %in% c('0312') & fonte_recursos_codigo %notin% c('133', '134', '213', '008', '035', '212')"
  ),
  `13 - DESPESAS CUSTEADAS COM RECEITAS DE ROYALTIES DE EXPLORA√á√ÉO DO PR√â-SAL` = list(
    criterio = "fonte_recursos_codigo %in% c('242') & iduso_codigo == 8 & elemento_despesa_codigo %in% c('01', '03', '59')"
  ),
  `14 - DEMAIS DESPESAS COM EDUCA√á√ÉO` = list(
    criterio = "iduso_codigo == 8 & fonte_recursos_codigo %in% c('008', '035', '133', '134', '213', '050', '000') & elemento_despesa_codigo %in% c('01', '03', '59') & acao_governo_codigo %notin% c('00SB', '0312', '0E36')"
  )
)

aplicar_criterios(dados_despesa %>% filter(item_informacao_codigo == "25"), criterios_rreo_A08_mde_despesas)
```

## üí∞ C√°lculo da Receita L√≠quida de Impostos (RLI)

### Receitas Base para RLI

```{r receitas_rli}

#| echo: true




# Receitas que comp√µem a base da RLI (impostos)
receitas_base_rli <- dados_receita %>% 
  filter(
    item_informacao_codigo == "5",
    startsWith(natureza_receita_codigo_completo, '711') | 
    startsWith(natureza_receita_codigo_completo, "111")
  ) %>% 
  group_by(mes_lancamento) %>% 
  summarise(
    receita = sum(saldo_r_item_informacao, na.rm = TRUE),
    .groups = "drop"
  )


```

### Transfer√™ncias Constitucionais

```{r transferencias_anexo_08}
#| echo: true

# Classificar transfer√™ncias constitucionais
rli_transf <- dados_despesa %>% 
  filter(item_informacao_codigo == "56") %>% 
  mutate(
    transferencia = case_when(
      acao_governo_codigo == "0044" ~ "FPE",
      acao_governo_codigo == "0045" ~ "FPM", 
      acao_governo_codigo == "0046" ~ "IPI_repasse",
      acao_governo_codigo == "0C33" ~ "FUNDEB",
      acao_governo_codigo == "00H6" ~ "IOF_repasse",
      acao_governo_codigo == "006M" ~ "ITR_repasse",
      .default = "demais"
    )
  ) %>% 
  group_by(transferencia, mes_lancamento) %>%  
  summarise(
    valor_transferencia = sum(saldo_r_item_informacao, na.rm = TRUE),
    .groups = "drop"
  )

# Mostrar transfer√™ncias por tipo
transferencias_resumo <- rli_transf %>%
  group_by(transferencia) %>%
  summarise(
    total = sum(valor_transferencia, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(desc(total)) %>%
  mutate(total_formatado = formatar_numero(total))


```

### C√°lculo da RLI Mensal

```{r rli_mensal}

#| echo: true

# Consolidar transfer√™ncias (exceto "demais")
transferencias_consolidadas <- rli_transf %>% 
  filter(transferencia != "demais") %>% 
  group_by(mes_lancamento) %>% 
  summarise(
    transferencia_total = sum(valor_transferencia, na.rm = TRUE),
    .groups = "drop"
  )

# Calcular RLI mensal
rli_mensal <- full_join(
  receitas_base_rli, 
  transferencias_consolidadas, 
  by = "mes_lancamento"
) %>%
  mutate(
    transferencia_total = ifelse(is.na(transferencia_total), 0, transferencia_total),
    receita = ifelse(is.na(receita), 0, receita),
    rli = (receita - transferencia_total) * 0.18
  ) %>%
  # Ordenar por m√™s corretamente
  mutate(
    mes_ordenacao = case_when(
      str_detect(mes_lancamento, "JAN") ~ 1,
      str_detect(mes_lancamento, "FEV") ~ 2,
      str_detect(mes_lancamento, "MAR") ~ 3,
      str_detect(mes_lancamento, "ABR") ~ 4,
      str_detect(mes_lancamento, "MAI") ~ 5,
      str_detect(mes_lancamento, "JUN") ~ 6,
      str_detect(mes_lancamento, "JUL") ~ 7,
      str_detect(mes_lancamento, "AGO") ~ 8,
      str_detect(mes_lancamento, "SET") ~ 9,
      str_detect(mes_lancamento, "OUT") ~ 10,
      str_detect(mes_lancamento, "NOV") ~ 11,
      str_detect(mes_lancamento, "DEZ") ~ 12,
      TRUE ~ 99
    )
  ) %>%
  arrange(mes_ordenacao) %>%
  select(-mes_ordenacao) %>%
  mutate(
    receita_formatada = formatar_numero(receita),
    transferencia_formatada = formatar_numero(transferencia_total),
    rli_formatado = formatar_numero(rli)
  )

# Exibir com DT::datatable
DT::datatable(
  rli_mensal %>% 
    select(mes_lancamento, receita_formatada, transferencia_formatada, rli_formatado),
  colnames = c("M√™s", "Receita Base", "Transfer√™ncias", "RLI (18%)"),
  caption = "üìä Receita L√≠quida de Impostos (RLI) Mensal",
  rownames = FALSE,
  options = list(
    pageLength = 15,
    dom = 'ft',
    columnDefs = list(
      list(className = 'dt-left', targets = "_all")  # Alinhar tudo √† esquerda
    ),
    language = list(
      url = '//cdn.datatables.net/plug-ins/1.10.11/i18n/Portuguese.json'
    )
  )
) %>%
  DT::formatStyle(
    columns = c("receita_formatada", "transferencia_formatada", "rli_formatado"),
    textAlign = 'right'  # N√∫meros √† direita
  ) %>%
  DT::formatStyle(
    columns = "mes_lancamento",
    textAlign = 'left',   # M√™s √† esquerda
    fontWeight = 'bold'
  )
```

## üéØ Aplica√ß√£o M√≠nima em MDE

### RLI do Per√≠odo de Refer√™ncia

```{r rli_periodo}

#| echo: true

# RLI espec√≠fica do m√™s de refer√™ncia
rli_atual <- rli_mensal %>% 
  filter(mes_lancamento == mes_filtro) %>% 
  summarise(minimo_mde = sum(rli, na.rm = TRUE)) %>%
  pull(minimo_mde)

print(paste("üìÖ RLI para", mes_filtro, ":", formatar_numero(rli_atual)))
```

### Despesas MDE do Per√≠odo

```{r despesas_mde}

# Despesas MDE das categorias principais (02, 03, 04, 05, 06)
despesa_mde <- aplicar_criterios(dados_despesa %>% filter(item_informacao_codigo == 25), criterios_rreo_A08_mde_despesas) %>% 
  filter(
    mes_lancamento == mes_filtro,
    ordem %in% c(
      "03",
      "04", 
      "05",
      "06"
    )
  ) %>% 
  summarise(valor = sum(valor, na.rm = TRUE)) 

print(formatar_numero(despesa_mde$valor))
```

### Complementa√ß√£o FUNDEB

```{r complementacao_fundeb}

#| echo: true

# Complementa√ß√£o FUNDEB (100% da complementa√ß√£o da Uni√£o)
complementacao_fundeb <- dados_despesa %>% 
  filter(
    item_informacao_codigo == 25, 
    mes_lancamento == mes_filtro,
    acao_governo_codigo %in% c('0E36', '00SB')
  ) %>% 
  summarise(comp_fundeb = sum(saldo_r_item_informacao, na.rm = TRUE) ) %>%
  pull(comp_fundeb)

print(paste("üéØ Complementa√ß√£o FUNDEB (100%):", formatar_numero(complementacao_fundeb)))
```

### Restos a Pagar MDE

```{r rp_mde}
#| echo: true
#| include: false

# AJUSTADO: Agrupado por item de informa√ß√£o
despesa_mde_rp_detalhado <- dados_rp_anexo_08 %>%
  filter(
    mes_lancamento == mes_filtro,  
    !elemento_despesa_codigo %in% c('01', '03'),
    (
      (fonte_recursos_codigo %in% c('000', '012', '00', '12') & 
       (iduso_codigo == 8 | lei_calmon_s_n == 'SIM')) |
      (ne_c_cor_ano_emissao >= 2020 & 
       !fonte_recursos_codigo %in% c('133', '134', '213', '08', '13', '93') & 
       iduso_codigo == 8)
    )
  ) %>%
  group_by(item_informacao_codigo, item_informacao_nome) %>%
  summarise(
    valor = sum(saldo_r_item_informacao, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(item_informacao_codigo)

# Total consolidado para c√°lculos
despesa_mde_rp <- sum(despesa_mde_rp_detalhado$valor, na.rm = TRUE)

print("üìã Restos a Pagar MDE por Item de Informa√ß√£o:")
print(despesa_mde_rp_detalhado)
print(paste("üìã Total RP MDE:", formatar_numero(despesa_mde_rp)))
```

## üìä C√°lculo do Percentual de Aplica√ß√£o

```{r percentual_aplicacao}

#| echo: true

# C√°lculo do percentual total aplicado em MDE
total_despesas_mde <- despesa_mde + (complementacao_fundeb*0.3)
percentual_aplicacao <- (as.numeric(total_despesas_mde) / as.numeric(rli_atual)) *100

# Fun√ß√£o para formatar valores em R$ (com as.numeric para dataframes)
formatar_real <- function(valor) {
  paste0("R$ ", format(as.numeric(valor), big.mark = ".", decimal.mark = ",", scientific = FALSE))
}

# Tabela resumo
resumo_aplicacao <- data.frame(
  Item = c(
    "üí∞ Despesas MDE Principais",
    "üéØ Complementa√ß√£o FUNDEB (100%)",
    "üìã Restos a Pagar MDE",
    "üìä Total Despesas MDE",
    "üìà 18% da RLI (Base de C√°lculo)",
    "üéØ Percentual Aplicado"),
  
  Valor = c(
    formatar_real(despesa_mde),
    formatar_real(complementacao_fundeb),
    formatar_real(despesa_mde_rp),
    formatar_real(total_despesas_mde),
    formatar_real(rli_atual),
    paste0(round(as.numeric(percentual_aplicacao), 2), "%")
  ),
  Status = c(
    "‚úÖ Calculado",
    "‚úÖ Calculado", 
    "‚úÖ Calculado",
    "‚úÖ Consolidado",
    "‚úÖ Base",
    ifelse(as.numeric(percentual_aplicacao) >= 100, "‚úÖ Atendido", "‚ùå N√£o Atendido")
  ),
  stringsAsFactors = FALSE
)


# Renderizar tabela
kable(resumo_aplicacao, 
      caption = "üéØ Resumo da Aplica√ß√£o em MDE",
      format = "html",
      col.names = c("Item", "Valor", "Status"),
      align = c("l", "r", "c")) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE
  ) %>%
  row_spec(0, bold = TRUE, background = "#f8f9fa") %>%
  row_spec(6, bold = TRUE, 
           background = ifelse(as.numeric(percentual_aplicacao) >= 100, "#d4edda", "#f8d7da"),
           color = ifelse(as.numeric(percentual_aplicacao) >= 100, "#155724", "#721c24")) %>%
  column_spec(2, width = "200px")

# Resultado resumido
cat("\n=== RESULTADO FINAL ===\n")
cat("Total de Despesas MDE: R$", format(as.numeric(total_despesas_mde), big.mark = ".", decimal.mark = ","), "\n")
cat("18% da RLI (Base): R$", format(as.numeric(rli_atual), big.mark = ".", decimal.mark = ","), "\n")
cat("Percentual Aplicado:", round(as.numeric(percentual_aplicacao), 2), "%\n")
cat("Situa√ß√£o:", ifelse(as.numeric(percentual_aplicacao) >= 100, "‚úÖ ATENDE", "‚ùå N√ÉO ATENDE"), "ao m√≠nimo constitucional\n")
```

# üìã RREO Anexo 09 - Regra de Ouro.

```{r}
# Ler arquivo
dados <- read_excel("data/regra_de_ouro/regra_de_ouro_fabric_atual.xlsx", skip = 5) %>%
  clean_names()

# Filtrar linha da data e agrupar
resultado <- dados %>%
  filter(!grepl("^\\d{2}/\\d{2}/\\d{4}$", grupo_para_regra_de_ouro_tesouro_transparente)) %>%
  group_by(item = grupo_para_regra_de_ouro_tesouro_transparente) %>%
  summarise(
    saldo_abertura = sum(saldo_r_conta_contabil[grepl("000", mes_lancamento)], na.rm = TRUE),
    saldo_mes_atual = sum(saldo_r_conta_contabil[!grepl("000", mes_lancamento)], na.rm = TRUE),
    variacao = saldo_mes_atual - saldo_abertura
  )

# Identificar o m√™s atual
mes_atual <- dados %>%
  filter(!is.na(mes_lancamento), !grepl("000", mes_lancamento)) %>%
  pull(mes_lancamento) %>%
  first()

# Calcular Regra de Ouro
despesas <- resultado$variacao[resultado$item == "Despesas"]
receitas <- resultado$variacao[resultado$item == "Receitas"]
divida <- resultado$variacao[resultado$item == "Subconta da D√≠vida"]

regra_ouro <- despesas - (receitas - divida)

# Criar tabela com resultado da Regra de Ouro
regra_ouro_df <- data.frame(
  Indicador = "Regra de Ouro",
  Valor = regra_ouro,
  Status = ifelse(regra_ouro > 0, "N√ÉO CUMPRIDA", "CUMPRIDA")
)

# Exibir tabelas com DT::datatable
datatable(resultado, 
          caption = paste("Varia√ß√£o dos Saldos - M√™s", mes_atual, "vs Abertura"),
          options = list(pageLength = 10),
          rownames = FALSE) %>%
  formatCurrency(c("saldo_abertura", "saldo_mes_atual", "variacao"), 
                 currency = "R$ ", 
                 digits = 2, 
                 mark = ".", 
                 dec.mark = ",")

datatable(regra_ouro_df,
          caption = paste("Resultado da Regra de Ouro - M√™s", mes_atual),
          options = list(pageLength = 10, dom = 't'),
          rownames = FALSE) %>%
  formatCurrency("Valor", 
                 currency = "R$ ", 
                 digits = 2, 
                 mark = ".", 
                 dec.mark = ",")


```

```{r}
# ==============================================================================
# RREO ANEXO 9 - REGRA DE OURO
# ==============================================================================

# ------------------------------------------------------------------------------
# VARI√ÅVEL MANUAL - Saldo inicial da d√≠vida (ajustar anualmente)
# ------------------------------------------------------------------------------
saldo_inicial_divida <- 731471695519.71  # Saldo abertura 2025 (000/2025)

# ------------------------------------------------------------------------------
# 1. RECEITAS DE OPERA√á√ïES DE CR√âDITO
# ------------------------------------------------------------------------------
# Filtro: Item Informa√ß√£o = 5 (Receita L√≠quida), Origem = 21 ou 81

receitas_op_credito <- dados_receita %>%
  filter(
    mes_lancamento == mes_filtro,
    item_informacao_codigo == "5",
    str_starts(natureza_receita_codigo_completo, "21") | 
    str_starts(natureza_receita_codigo_completo, "81")
  ) %>%
  summarise(valor = sum(saldo_r_item_informacao, na.rm = TRUE)) %>%
  pull(valor)

# ------------------------------------------------------------------------------
# 2. DESPESAS DE CAPITAL (Liquidadas + Inscritas em RP N√£o Processados)
# ------------------------------------------------------------------------------
# Filtro: Categoria = 4 (Capital), Item Informa√ß√£o = 25 (Liquidadas)
# Nota: Inscritas em RP NP pode estar em outra fonte

despesas_capital <- dados_despesa %>%
  filter(
    mes_lancamento == mes_filtro,
    categoria_economica_despesa_codigo == "4",
    item_informacao_codigo == "25"
  ) %>%
  summarise(valor = sum(saldo_r_item_informacao, na.rm = TRUE)) %>%
  pull(valor)

# ------------------------------------------------------------------------------
# 3. SUBCONTA DA D√çVIDA (Saldo atual)
# ------------------------------------------------------------------------------
saldo_atual_divida <- rgf_a02_balancete %>%
  filter(
    conta_contabil_numero == "111110401",
    mes_lancamento == mes_filtro
  ) %>%
  summarise(valor = sum(saldo_r_conta_contabil, na.rm = TRUE)) %>%
  pull(valor)

variacao_divida <- saldo_atual_divida - saldo_inicial_divida

# ------------------------------------------------------------------------------
# 4. C√ÅLCULO DA REGRA DE OURO
# ------------------------------------------------------------------------------
regra_ouro <- despesas_capital - (receitas_op_credito - variacao_divida)
status <- ifelse(regra_ouro > 0, "N√ÉO CUMPRIDA", "CUMPRIDA")

# ------------------------------------------------------------------------------
# 5. RESULTADO
# ------------------------------------------------------------------------------
tibble(
  Componente = c(
    "Receitas de Opera√ß√µes de Cr√©dito (I)",
    "(-) Varia√ß√£o Subconta da D√≠vida (II)",
    "= Receitas L√≠quidas (III = I - II)",
    "Despesas de Capital (IV)",
    "REGRA DE OURO (IV - III)"
  ),
  Valor = c(
    receitas_op_credito,
    variacao_divida,
    receitas_op_credito - variacao_divida,
    despesas_capital,
    regra_ouro
  )
) %>%
  datatable(
    caption = paste("Regra de Ouro -", mes_filtro, "| Status:", status),
    options = list(dom = 't')
  ) %>%
  formatRound("Valor", 2, mark = ".", dec.mark = ",")
```

# üìã RREO Anexo 11 - Aliena√ß√£o de Ativos.

# üìã RREO Anexo 12 - Sa√∫de.

## üìã Introdu√ß√£o

O **Anexo 12 do RREO** apresenta o demonstrativo das receitas e despesas com a√ß√µes e servi√ßos p√∫blicos de sa√∫de do Governo Federal, conforme estabelecido pela Emenda Constitucional n¬∫ 29/2000 e regulamentado pela Lei Complementar n¬∫ 141/2012.

Este relat√≥rio consolida informa√ß√µes sobre: - **Despesas Computadas**: Aplica√ß√µes diretas e transfer√™ncias nas subfun√ß√µes espec√≠ficas de sa√∫de - **Despesas N√£o Computadas**: Despesas do Minist√©rio da Sa√∫de n√£o computadas para o limite constitucional - **An√°lise por Modalidade**: Separa√ß√£o entre aplica√ß√£o direta e transfer√™ncias - **Indicadores de Cumprimento**: Verifica√ß√£o do atendimento aos limites constitucionais

## üè• Processamento das Despesas com Sa√∫de

### 1. Despesas Computadas - Subfun√ß√µes Espec√≠ficas

```{r despesas-saude-especificas}

#| include: false
# Filtrar despesas das subfun√ß√µes espec√≠ficas de sa√∫de (301-306)
despesas_saude <- dados_despesa %>% 
  filter(
    mes_lancamento == mes_filtro, 
    iduso_codigo == 6, 
    item_informacao_codigo == 25, 
    subfuncao_governo_codigo %in% c(301, 302, 303, 304, 305, 306)
  ) %>% 
  group_by(
    subfuncao_governo_codigo, 
    subfuncao_governo_nome, 
    categoria_economica_despesa_codigo,
    categoria_economica_despesa_nome, 
    modalidade_aplicacao_codigo
  ) %>% 
  summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao), .groups = "drop")

# Classificar por tipo de aplica√ß√£o
despesas_saude <- despesas_saude %>% 
  mutate(
    transferencia = ifelse(
      modalidade_aplicacao_codigo %in% c('30', '31', '32', '35', '36', '40', '41', '42', '45', '46'), 
      "_transferencia", 
      "aplicacao_direta"
    )
  )

# Criar tabela consolidada INCLUINDO LINHAS COM ZERO
tabela_saude_especificas <- despesas_saude %>% 
  group_by(
    subfuncao_governo_codigo, 
    subfuncao_governo_nome,
    categoria_economica_despesa_codigo, 
    categoria_economica_despesa_nome, 
    transferencia
  ) %>% 
  summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao), .groups = "drop") %>%
  # MANTER TODAS AS LINHAS, incluindo as com valor zero
  filter(TRUE)  # N√£o filtrar valores zero

# Exibir tabela
# DT::datatable(
#   tabela_saude_especificas,
#   caption = "Despesas com Sa√∫de - Subfun√ß√µes Espec√≠ficas (301-306) - Incluindo Valores Zero",
#   options = list(
#     pageLength = 20,  # Aumentar para mostrar mais linhas
#     scrollX = TRUE,
#     language = list(url = '//cdn.datatables.net/plug-ins/1.10.11/i18n/Portuguese-Brasil.json')
#   )
# ) %>%
#   DT::formatRound("saldo_r_item_informacao", 2, mark = ".", dec.mark = ",")

# Calcular total das subfun√ß√µes espec√≠ficas
total_subfuncoes_especificas <- sum(despesas_saude$saldo_r_item_informacao)
cat("\nüí∞ **Total das Subfun√ß√µes Espec√≠ficas de Sa√∫de:** R$", 
    format(total_subfuncoes_especificas, big.mark = ".", decimal.mark = ","), "\n")
```

### 2. Despesas em Outras Subfun√ß√µes (Demais)

```{r despesas-saude-demais}

#| include: false
# Calcular despesas em outras subfun√ß√µes
despesas_saude_demais <- as.numeric(
  dados_despesa %>% 
  filter(
    mes_lancamento == mes_filtro, 
    iduso_codigo == 6, 
    item_informacao_codigo == 25, 
    subfuncao_governo_codigo %notin% c(301, 302, 303, 304, 305, 306)
  ) %>% 
  summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao))
)

cat("üí∞ **Total das Demais Subfun√ß√µes de Sa√∫de:** R$", 
    format(despesas_saude_demais, big.mark = ".", decimal.mark = ","), "\n")

# Total geral das despesas computadas
total_despesas_computadas <- total_subfuncoes_especificas + despesas_saude_demais
cat("üí∞ **Total Geral das Despesas Computadas:** R$", 
    format(total_despesas_computadas, big.mark = ".", decimal.mark = ","), "\n\n")
```

### 3. An√°lise Consolidada de Todas as Despesas

```{r despesas-saude-consolidada}

#| include: false
# Processar todas as despesas de sa√∫de com agrupamento
despesas_saude_completa <- dados_despesa %>% 
  filter(
    mes_lancamento == mes_filtro, 
    iduso_codigo == 6, 
    item_informacao_codigo == 25
  ) %>% 
  group_by(
    subfuncao_governo_codigo, 
    subfuncao_governo_nome, 
    categoria_economica_despesa_codigo,
    categoria_economica_despesa_nome, 
    modalidade_aplicacao_codigo
  ) %>% 
  summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao), .groups = "drop")

# Reclassificar subfun√ß√µes e modalidades
despesas_saude_completa <- despesas_saude_completa %>% 
  mutate(
    subfuncao_governo_codigo = case_when(
      subfuncao_governo_codigo %in% c(301, 302, 303, 304, 305, 306) ~ as.character(subfuncao_governo_codigo),
      TRUE ~ "demais"
    ),
    subfuncao_governo_nome = case_when(
      subfuncao_governo_codigo %in% c("301", "302", "303", "304", "305", "306") ~ subfuncao_governo_nome,
      TRUE ~ "demais"
    ),
    transferencia = ifelse(
      modalidade_aplicacao_codigo %in% c('30', '31', '32', '35', '36', '40', '41', '42', '45', '46'), 
      "_transferencia", 
      "aplicacao_direta"
    )
  )

# Criar tabela consolidada final INCLUINDO VALORES ZERO
tabela_consolidada <- despesas_saude_completa %>% 
  group_by(
    subfuncao_governo_codigo, 
    subfuncao_governo_nome,
    categoria_economica_despesa_codigo, 
    categoria_economica_despesa_nome, 
    transferencia
  ) %>% 
  summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao), .groups = "drop") %>%
  # MANTER TODAS AS LINHAS, incluindo as com valor zero
  arrange(subfuncao_governo_codigo, categoria_economica_despesa_codigo, transferencia)

# Exibir tabela consolidada
# DT::datatable(
#   tabela_consolidada %>% adorn_totals(),
#   caption = "Despesas com Sa√∫de - An√°lise Consolidada (Incluindo Valores Zero)",
#   options = list(
#     pageLength = 25,  # Aumentar para mostrar mais linhas
#     scrollX = TRUE,
#     language = list(url = '//cdn.datatables.net/plug-ins/1.10.11/i18n/Portuguese-Brasil.json')
#   )
# ) %>%
#   DT::formatRound("saldo_r_item_informacao", 2, mark = ".", dec.mark = ",")

# Total consolidado em milhares
total_consolidado <- sum(despesas_saude_completa$saldo_r_item_informacao) / 1000
cat("\nüí∞ **Total Consolidado das Despesas com Sa√∫de:** R$", 
    format(total_consolidado, big.mark = ".", decimal.mark = ","), "mil\n")

cat("\nüí∞ **cumprimento do m√≠nimo:** ", 
    format(total_consolidado*1000/minimo_saude*100, big.mark = ".", decimal.mark = ","), "%\n")
```

## üö´ Despesas N√£o Computadas

### Despesas do Minist√©rio da Sa√∫de N√£o Computadas

```{r despesas-nao-computadas}

#| include: false
# Filtrar despesas n√£o computadas do Minist√©rio da Sa√∫de
despesa_saude_nao_computadas <- dados_despesa %>% 
  filter(
    mes_lancamento == mes_filtro, 
    iduso_codigo != 6, 
    item_informacao_codigo == 25,
    uo_orgao_superior_codigo == "36000", 
    unidade_orcamentaria_codigo != "74202"
  ) %>% 
  group_by(
    subfuncao_governo_codigo, 
    subfuncao_governo_nome, 
    categoria_economica_despesa_codigo,
    categoria_economica_despesa_nome, 
    modalidade_aplicacao_codigo
  ) %>%  
  summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao), .groups = "drop")

# Reclassificar para an√°lise
despesa_saude_nao_computadas <- despesa_saude_nao_computadas %>% 
  mutate(
    subfuncao_governo_codigo = case_when(
      subfuncao_governo_codigo %in% c(301, 302, 303, 304, 305, 306) ~ as.character(subfuncao_governo_codigo),
      TRUE ~ "demais"
    ),
    subfuncao_governo_nome = case_when(
      subfuncao_governo_codigo %in% c("301", "302", "303", "304", "305", "306") ~ subfuncao_governo_nome,
      TRUE ~ "demais"
    ),
    transferencia = ifelse(
      modalidade_aplicacao_codigo %in% c('30', '31', '32', '35', '36', '40', '41', '42', '45', '46'), 
      "_transferencia", 
      "aplicacao_direta"
    )
  )

# Tabela das despesas n√£o computadas INCLUINDO VALORES ZERO
tabela_nao_computadas <- despesa_saude_nao_computadas %>% 
  group_by(
    subfuncao_governo_codigo, 
    subfuncao_governo_nome,
    categoria_economica_despesa_codigo, 
    categoria_economica_despesa_nome, 
    transferencia
  ) %>% 
  summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao), .groups = "drop") %>%
  # MANTER TODAS AS LINHAS, incluindo as com valor zero
  arrange(subfuncao_governo_codigo, categoria_economica_despesa_codigo, transferencia)

# Exibir tabela
# DT::datatable(
#   tabela_nao_computadas,
#   caption = "Despesas do Minist√©rio da Sa√∫de N√ÉO Computadas para o Limite (Incluindo Valores Zero)",
#   options = list(
#     pageLength = 20,  # Aumentar para mostrar mais linhas
#     scrollX = TRUE,
#     language = list(url = '//cdn.datatables.net/plug-ins/1.10.11/i18n/Portuguese-Brasil.json')
#   )
# ) %>%
#   DT::formatRound("saldo_r_item_informacao", 2, mark = ".", dec.mark = ",")
```

```{r}



# Calcular total das subfun√ß√µes espec√≠ficas
total_subfuncoes_especificas <- sum(despesas_saude$saldo_r_item_informacao)
cat("\nüí∞ **Total das Subfun√ß√µes Espec√≠ficas de Sa√∫de:** R$", 
    format(total_subfuncoes_especificas, big.mark = ".", decimal.mark = ","), "\n")

cat("üí∞ **Total das Demais Subfun√ß√µes de Sa√∫de:** R$", 
    format(despesas_saude_demais, big.mark = ".", decimal.mark = ","), "\n")

# Total geral das despesas computadas
total_despesas_computadas <- total_subfuncoes_especificas + despesas_saude_demais
cat("üí∞ **Total Geral das Despesas Computadas:** R$", 
    format(total_despesas_computadas, big.mark = ".", decimal.mark = ","), "\n\n")




# Cumprimento do minimo

# cat("\nüí∞ **Cumprimento do minimo:** ",
#     format(total_despesas_computadas/minimo_saude*100, big.mark = ".", decimal.mark = ",", digits = 4), "%\n")

```

# üìã RREO Tabela 01

## üí∞ RECEITAS OR√áAMENT√ÅRIAS

```{r criterios_receitas}

# ======================================
# CRIT√âRIOS DA TABELA 1 - RECEITAS
# ======================================

criterios_rreo_T01_receitas <- list(
  
  # === RECEITAS CORRENTES ===
  
  # Receita Tribut√°ria
  `01  Receita Tribut√°ria` = list(
    criterio = "(nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 1) | (nre1_categoria_economica_codigo == 7 & nre2_origem_receita_codigo_origem == 1)"
  ),
  
  # Receita de Contribui√ß√µes
  `02  Receita de Contribui√ß√µes` = list(
    criterio = "(nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 2) | (nre1_categoria_economica_codigo == 7 & nre2_origem_receita_codigo_origem == 2)"
  ),
  
  # Receita Patrimonial
  `03  Receita Patrimonial` = list(
    criterio = "(nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 3) | (nre1_categoria_economica_codigo == 7 & nre2_origem_receita_codigo_origem == 3)"
  ),
  
  # Receita Agropecu√°ria
  `04  Receita Agropecu√°ria` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 4"
  ),
  
  # Receita Industrial
  `05  Receita Industrial` = list(
    criterio = "(nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 5) | (nre1_categoria_economica_codigo == 7 & nre2_origem_receita_codigo_origem == 5)"
  ),
  
  # Receita de Servi√ßos
  `06  Receita de Servi√ßos` = list(
    criterio = "(nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 6) | (nre1_categoria_economica_codigo == 7 & nre2_origem_receita_codigo_origem == 6)"
  ),
  
  # Transfer√™ncias Correntes
  `07  Transfer√™ncias Correntes` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 7"
  ),
  
  # Receitas Correntes a Classificar
  `08  Receitas Correntes a Classificar` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 8"
  ),
  
  # Outras Receitas Correntes
  `09  Outras Receitas Correntes` = list(
    criterio = "(nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 9) | (nre1_categoria_economica_codigo == 7 & nre2_origem_receita_codigo_origem == 9)"
  ),
  
  # === RECEITAS DE CAPITAL ===
  
  # Opera√ß√µes de Cr√©dito
  `10  Opera√ß√µes de Cr√©dito` = list(
    criterio = "(nre1_categoria_economica_codigo == 2 & nre2_origem_receita_codigo_origem == 1) | (nre1_categoria_economica_codigo == 8 & nre2_origem_receita_codigo_origem == 1)"
  ),
  
  # Aliena√ß√£o de Bens
  `11  Aliena√ß√£o de Bens` = list(
    criterio = "(nre1_categoria_economica_codigo == 2 & nre2_origem_receita_codigo_origem == 2) | (nre1_categoria_economica_codigo == 8 & nre2_origem_receita_codigo_origem == 2)"
  ),
  
  # Transfer√™ncias de Capital
  `12  Transfer√™ncias de Capital` = list(
    criterio = "nre1_categoria_economica_codigo == 2 & nre2_origem_receita_codigo_origem == 4"
  ),
  
  # Outras Receitas de Capital
  `13  Outras Receitas de Capital` = list(
    criterio = "(nre1_categoria_economica_codigo == 2 & nre2_origem_receita_codigo_origem == 5) | (nre1_categoria_economica_codigo == 8 & nre2_origem_receita_codigo_origem == 5)"
  ),
  
  # SUBTOTAL (I) - Receitas Correntes + Receitas de Capital - Intra-or√ßament√°rias
  `14  SUBTOTAL (I)` = list(
    criterio = "nre1_categoria_economica_codigo %in% c(1, 2, 7, 8)"
  )
)
```

```{r processar-receitas}


# Processar dados de receitas



datatable(aplicar_criterios(
  df = dados_receita %>% filter(esfera_orcamentaria_codigo == 2, item_informacao_codigo == "5") %>% unique(),
  criterios = criterios_rreo_T01_receitas)%>% group_by(categoria) %>% summarise(valor = sum(valor, na.rm = TRUE))) %>%
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")


```

## üí∏ DESPESAS OR√áAMENT√ÅRIAS

```{r criterios-despesas}


# ======================================
# CRIT√âRIOS DA TABELA 1 - DESPESAS
# ======================================

criterios_rreo_T01_despesas_T01 <- list(
  
  # === DESPESAS CORRENTES ===
  
  # Pessoal e Encargos Sociais
  `01  Pessoal e Encargos Sociais` = list(
    criterio = "grupo_despesa_codigo_grupo == '1'"
  ),
  
  # Juros e Encargos da D√≠vida
  `02  Juros e Encargos da D√≠vida` = list(
    criterio = "grupo_despesa_codigo_grupo == '2'"
  ),
  
  # Outras Despesas Correntes
  `03  Outras Despesas Correntes` = list(
    criterio = "grupo_despesa_codigo_grupo == '3'"
  ),
  
  # Benef√≠cios Previdenci√°rios
  `04  Benef√≠cios Previdenci√°rios` = list(
    criterio = "grupo_despesa_codigo_grupo == '3' & unidade_orcamentaria_codigo %in% c('55902', '40904', '33904', '25917')"
  ),
  
  # Transfer√™ncias
  `05  Transfer√™ncias` = list(
    criterio = "grupo_despesa_codigo_grupo == '3' & modalidade_aplicacao_codigo %in% c('30', '31', '35', '36', '40', '41', '42', '45')"
  ),
  
  # Demais Despesas Correntes
  `06  Demais Despesas Correntes` = list(
    criterio = "
    grupo_despesa_codigo_grupo == '3' & 
    !unidade_orcamentaria_codigo %in% c('55902', '40904', '33904', '25917') &
    !modalidade_aplicacao_codigo %in% c('30', '31', '35', '36', '40', '41', '42', '45')
    "
  ),
  
  # === DESPESAS DE CAPITAL ===
  
  # Investimentos
  `07  Investimentos` = list(
    criterio = "grupo_despesa_codigo_grupo == '4'"
  ),
  
  # Invers√µes Financeiras
  `08  Invers√µes Financeiras` = list(
    criterio = "grupo_despesa_codigo_grupo == '5'"
  ),
  
  # Amortiza√ß√£o da D√≠vida
  `09  Amortiza√ß√£o da D√≠vida` = list(
    criterio = "grupo_despesa_codigo_grupo == '6'"
  ),
  
  # RESERVA DE CONTING√äNCIA
  `10  RESERVA DE CONTING√äNCIA` = list(
    criterio = "grupo_despesa_codigo_grupo == '9'"
  ),
  
  # SUBTOTAL (III) - Total das Despesas
  `11  SUBTOTAL (III)` = list(
    criterio = "grupo_despesa_codigo_grupo %in% c('1', '2', '3', '4', '5', '6', '9')"
  )
)
```

```{r processar-despesas}

# Processar dados de despesas
datatable(aplicar_criterios(
  df = dados_despesa %>% filter(esfera_orcamentaria_codigo == 2, item_informacao_codigo == "25") %>% unique(),
  criterios = criterios_rreo_T01_despesas_T01) %>% group_by(categoria) %>% summarise(valor = sum(valor, na.rm = TRUE))) %>%
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")


```

### Resultado da Seguridade Social

```{r}
(formatar_numero (resultado_seguridade <- as.numeric(df_criterios_rreo_T01_receitas %>% filter(ordem == "14") %>% summarise(valor= valor))-as.numeric(df_criterios_rreo_T01_despesas_T01 %>% filter(ordem == "11") %>% summarise(valor= valor))) )

```

## üìä Tabela 01A - Detalhamento das Receitas

```{r criterios-tabela1a}

# ======================================
# CRIT√âRIOS DA TABELA 1A - COLUNAS 2025
# ======================================
criterios_rreo_T01a_receita_prevista_T01 <- list(
  
  # === PREVIS√ÉO ATUALIZADA (a) ===
  
  # Previs√£o Atualizada da Receita
  `PREVISAO_ATUALIZADA` = list(
    criterio = "
    natureza_receita_codigo_completo %in% c('12100111', '12100121', '12100131', '12100211', '12102121', '12102131', 
                                            '12106511', '12106611', '12106711', '12107211', '12107411', '12107611',
                                            '12108111', '12109131', '12101011', '12101311', '12101411', '12101611',
                                            '12106131', '12106211', '12106411', '12106511', '12106611', '12106711',
                                            '12110051', '12110061', '12106211', '12100511', '12106311', '12106711',
                                            '12104211', '12104311', '12101051') &
    fonte_recursos_codigo == '000' &
    esfera_orcamentaria_codigo == '1'
    "
  ),
  
  # === RECEITAS REALIZADAS NO M√äS ===
  
  # Receita Or√ßament√°ria Arrecadada no M√™s
  `RECEITA_REALIZADA_MES` = list(
    criterio = "
    fonte_recursos_codigo == '000' &
    (endsWith(fonte_recursos_detalhada_codigo, '98001') | endsWith(fonte_recursos_detalhada_codigo, '73910'))
    "
  ),
  
  # === RECEITAS REALIZADAS AT√â O M√äS ===
  
  # Receita Or√ßament√°ria Arrecadada Acumulada
  `RECEITA_REALIZADA_ACUMULADA` = list(
    criterio = "
    fonte_recursos_codigo == '000' &
    (endsWith(fonte_recursos_detalhada_codigo, '98001') | endsWith(fonte_recursos_detalhada_codigo, '73910'))
    "
  )
)
```

```{r processar-tabela1a}

# Processar Tabela 01A
datatable(aplicar_criterios(
  df = dados_receita %>% filter(esfera_orcamentaria_codigo == 2) %>% unique(),
  criterios = criterios_rreo_T01a_receita_prevista_T01
)%>% group_by(categoria) %>% summarise(valor = sum(valor, na.rm = TRUE))) %>%
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")


```

## üè• Seguridade Social

```{r criterios-seguridade}

# Crit√©rios para an√°lise da Seguridade Social
criterios_rreo_T01B_seguridade_T01B <- list(
  
  # SA√öDE
  `01  Sa√∫de` = list(
    criterio = "iduso_codigo %in% c('6') & funcao_governo_codigo %notin% c('08')"
  ),
  
  # RGPS - UNIDADE OR√áAMENT√ÅRIA  
  `02  RGPS - Receitas da Previd√™ncia Social` = list(
    criterio = "unidade_orcamentaria_codigo %in% c('33904', '40404', '35902', '29917')"
  ),
  
  # ASSIST√äNCIA SOCIAL
  `03  Assist√™ncia Social` = list(
    criterio = "funcao_governo_codigo %in% c('08') & acao_governo_codigo %notin% c('0581', '0544', '0563', '0658', '0585', '0653', '0636')"
  ),
  
  # ABONO SALARIAL
  `04  Abono Salarial` = list(
    criterio = "acao_governo_codigo %in% c('0581')"
  ),
  
  # SEGURO DESEMPREGO
  `05  Seguro Desemprego` = list(
    criterio = "acao_governo_codigo %in% c('00H4', '0583', '0585', '0686', '0653')"
  )
)
```

```{r processar-seguridade}

# Processar dados da Seguridade Social
datatable(aplicar_criterios(
  df = dados_despesa %>% filter(esfera_orcamentaria_codigo == 2, item_informacao_codigo == "25") %>% unique(),
  criterios = criterios_rreo_T01B_seguridade_T01B
)%>% group_by(categoria) %>% summarise(valor = sum(valor, na.rm = TRUE))) %>%
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")


```

# üìã RREO Tabela 02

## üìä Crit√©rios da Tabela 02

```{r criterios-tabela02}

# ======================================
# CRIT√âRIOS DA TABELA 02 -
# ======================================

criterios_rreo_T02_despesas_T02 <- list(
  
  # APLICA√á√ÉO DIRETA (ser√° calculado por soma dos subitens)
  `01  Aplica√ß√£o Direta` = list(
    criterio = "FALSE"  # Ser√° calculado por soma posterior
  ),
  
  # A DETALHAR
  `02  A Detalhar` = list(
    criterio = "elemento_despesa_codigo %in% c('00') "
  ),
  
  # PESSOAL CIVIL (ser√° calculado por soma dos subitens)
  `03  Pessoal Civil` = list(
    criterio = "FALSE"  # Ser√° calculado por soma posterior
  ),
  
  # PESSOAL CIVIL - VENCIMENTOS E VANTAGENS FIXAS
  `04  Pessoal Civil - Vencimentos e Vantagens Fixas` = list(
    criterio = "elemento_despesa_codigo %in% c('11')"
  ),
  
  # PESSOAL CIVIL - OUTRAS DESPESAS VARI√ÅVEIS
  `05  Pessoal Civil - Outras Despesas Vari√°veis` = list(
    criterio = "elemento_despesa_codigo %in% c('16')"
  ),
  
  # PESSOAL CIVIL - APOSENTADORIA
  `06  Pessoal Civil - Aposentadoria` = list(
    criterio = "elemento_despesa_codigo %in% c('01') & (orgao_uge_orgao_maximo_codigo %notin% c('52000') | (orgao_uge_orgao_maximo_codigo %in% c('52000') & acao_governo_codigo %in% c('0181')))"
  ),
  
  # PESSOAL CIVIL - PENS√ïES
  `07  Pessoal Civil - Pens√µes` = list(
    criterio = "elemento_despesa_codigo %in% c('03') & (orgao_uge_orgao_maximo_codigo %notin% c('52000') | (orgao_uge_orgao_maximo_codigo %in% c('52000') & acao_governo_codigo %in% c('0181')))"
  ),
  
  # PESSOAL CIVIL - CONTRIBUI√á√ïES A ENTIDADES FECHADAS DE PREVID√äNCIA
  `08  Pessoal Civil - Contribui√ß√µes a Entidades Fechadas de Previd√™ncia` = list(
    criterio = "elemento_despesa_codigo %in% c('07') & orgao_uge_orgao_maximo_codigo %notin% c('52000')"
  ),
  
  # PESSOAL CIVIL - OBRIGA√á√ïES PATRONAIS
  `09  Pessoal Civil - Obriga√ß√µes Patronais` = list(
    criterio = "elemento_despesa_codigo %in% c('13') & orgao_uge_orgao_maximo_codigo %notin% c('52000')"
  ),
  
  # PESSOAL CIVIL - OUTRAS APLICA√á√ïES
  `10  Pessoal Civil - Outras Aplica√ß√µes` = list(
    criterio = "
    (elemento_despesa_codigo %notin% c('00', '01', '03') & 
     orgao_uge_orgao_maximo_codigo %in% c('52000') & 
     acao_governo_codigo %in% c('0181')) | 
    (elemento_despesa_codigo %notin% c('00', '01', '03', '07', '11', '12', '13', '16', '17', '41') & 
     orgao_uge_orgao_maximo_codigo %notin% c('52000'))
    "
  ),
  
  # PESSOAL MILITAR (ser√° calculado por soma dos subitens)
  `11  Pessoal Militar` = list(
    criterio = "FALSE"  # Ser√° calculado por soma posterior
  ),
  
  # PESSOAL MILITAR - VENCIMENTOS E VANTAGENS FIXAS
  `12  Pessoal Militar - Vencimentos e Vantagens Fixas` = list(
    criterio = "elemento_despesa_codigo %in% c('12')"
  ),
  
  # PESSOAL MILITAR - OUTRAS DESPESAS VARI√ÅVEIS
  `13  Pessoal Militar - Outras Despesas Vari√°veis` = list(
    criterio = "elemento_despesa_codigo %in% c('17')"
  ),
  
  # PESSOAL MILITAR - REFORMAS
  `14  Pessoal Militar - Reformas` = list(
    criterio = "elemento_despesa_codigo %in% c('01') & orgao_uge_orgao_maximo_codigo %in% c('52000') & acao_governo_codigo %notin% c('0181')"
  ),
  
  # PESSOAL MILITAR - PENS√ïES
  `15  Pessoal Militar - Pens√µes` = list(
    criterio = "elemento_despesa_codigo %in% c('03') & orgao_uge_orgao_maximo_codigo %in% c('52000') & acao_governo_codigo %notin% c('0181')"
  ),
  
  # PESSOAL MILITAR - OBRIGA√á√ïES PATRONAIS
  `16  Pessoal Militar - Obriga√ß√µes Patronais` = list(
    criterio = "elemento_despesa_codigo %in% c('13') & orgao_uge_orgao_maximo_codigo %in% c('52000')"
  ),
  
  # PESSOAL MILITAR - OUTRAS APLICA√á√ïES (+)
  `17  Pessoal Militar - Outras Aplica√ß√µes (+)` = list(
    criterio = "elemento_despesa_codigo %notin% c('00', '01', '03', '11', '12', '13', '16', '17', '41') & orgao_uge_orgao_maximo_codigo %in% c('52000')"
  ),
  
  # PESSOAL MILITAR - OUTRAS APLICA√á√ïES (-)
  `18  Pessoal Militar - Outras Aplica√ß√µes (-)` = list(
    criterio = "elemento_despesa_codigo %notin% c('00', '01', '03', '11') & orgao_uge_orgao_maximo_codigo %in% c('52000') & acao_governo_codigo %in% c('0181')"
  ),
  
  # TRANSFER√äNCIAS INTERGOVERNAMENTAIS
  `19  Transfer√™ncias Intergovernamentais` = list(
    criterio = "elemento_despesa_codigo %in% c('41')"
  ),
  
  # TRANSFER√äNCIAS A ESTADOS E AO DF
  `20  Transfer√™ncias a Estados e ao DF` = list(
    criterio = "elemento_despesa_codigo %in% c('41')"
  )
)
```

### üíº Processamento dos Dados

### üìä Despesa Liquidada

```{r processar-liquidada}




datatable(aplicar_criterios(df = dados_despesa %>% 
    filter( grupo_despesa_codigo_grupo == 1,  orgao_uge_orcam_fiscal_s_n == "PERTENCE",   mes_lancamento == mes_filtro, item_informacao_codigo == 25
    ),
  criterios = criterios_rreo_T02_despesas_T02,
  group_vars = c("orgao_uge_tipo_administracao_nome")) %>% group_by(categoria, orgao_uge_tipo_administracao_nome) %>% summarise(valor = sum(valor, na.rm = TRUE)) %>% pivot_wider(names_from = "orgao_uge_tipo_administracao_nome", values_from = "valor") ) %>%
  formatRound(c('ADMINISTRACAO DIRETA',
  'AUTARQUIA',
  'ECONOMIA MISTA',
  'EMPRESA PUBLICA COMERCIAL E FINANCEIRA',
  'FUNDACAO',
  'FUNDOS'), 2, mark = ".", dec.mark = ",")



```

### ‚úÖ Teste Pessoal Militar

```{r validacao-militar}

# Valida√ß√£o espec√≠fica para Pessoal Militar
validacao_militar <- dados_despesa %>% 
  group_by(orgao_uge_tipo_administracao_nome) %>%
  filter(
    grupo_despesa_codigo_grupo == 1,
    mes_lancamento == mes_filtro,
    item_informacao_codigo == "9"
  ) %>% 
  filter(
    (elemento_despesa_codigo %in% c('12', '17')) |
    (elemento_despesa_codigo %in% c('01') & 
     orgao_uge_orgao_maximo_codigo %in% c('52000') &
     acao_governo_codigo %notin% c('0181')) |
    (elemento_despesa_codigo %in% c('03') & 
     orgao_uge_orgao_maximo_codigo %in% c('52000') &
     acao_governo_codigo %notin% c('0181')) |
    (elemento_despesa_codigo %in% c('13') & 
     orgao_uge_orgao_maximo_codigo %in% c('52000'))
  ) %>% 
  summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao, na.rm = TRUE), .groups = "drop")

datatable(validacao_militar, 
          caption = "Valida√ß√£o - Pessoal Militar") %>%
  formatRound(c('saldo_r_item_informacao'), 2, mark = ".", dec.mark = ",")
```

### ‚úÖ Teste Pessoal Civil

```{r validacao-civil}

# Valida√ß√£o espec√≠fica para Pessoal Civil
validacao_civil <- dados_despesa %>% 
  group_by(orgao_uge_tipo_administracao_nome) %>%
  filter(
    grupo_despesa_codigo_grupo == 1,
    mes_lancamento == mes_filtro,
    item_informacao_codigo == "9"
  ) %>% 
  filter(
    # Condi√ß√µes espec√≠ficas para Pessoal Civil
    (elemento_despesa_codigo %in% c('11', '16')) |
    (elemento_despesa_codigo == '01' & orgao_uge_orgao_maximo_codigo != '52000') |
    (elemento_despesa_codigo == '01' & orgao_uge_orgao_maximo_codigo == '52000' & acao_governo_codigo == '0181') |
    (elemento_despesa_codigo == '03' & orgao_uge_orgao_maximo_codigo != '52000') |
    (elemento_despesa_codigo == '03' & orgao_uge_orgao_maximo_codigo == '52000' & acao_governo_codigo == '0181') |
    (elemento_despesa_codigo == '07' & orgao_uge_orgao_maximo_codigo != '52000') |
    (elemento_despesa_codigo == '13' & orgao_uge_orgao_maximo_codigo != '52000') |
    (elemento_despesa_codigo %notin% c('00', '01', '03', '07', '11', '12', '13', '16', '17', '41') & 
     orgao_uge_orgao_maximo_codigo != '52000') |
    (elemento_despesa_codigo %notin% c('00', '01', '03') & 
     orgao_uge_orgao_maximo_codigo == '52000' & 
     acao_governo_codigo == '0181')
  ) %>% 
  summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao, na.rm = TRUE), .groups = "drop")

datatable(validacao_civil, 
          caption = "Valida√ß√£o - Pessoal Civil") %>%
  formatRound(c('saldo_r_item_informacao'), 2, mark = ".", dec.mark = ",")
```

# üìã RREO Tabela 03

```{r tabela_3}

# agrupado_despesa_orgao <- c("orgao_uge_orgao_maximo_codigo", "orgao_uge_orgao_maximo_nome")
# 
# dados_agregados_orgao <- dados_despesa %>% 
#   filter(resultado_eof_codigo == 6) %>%
#   group_by(across(all_of(c(agrupado_despesa_orgao, "item_informacao_nome")))) %>%
#   summarise(
#     saldo_r_item_informacao = sum(saldo_r_item_informacao, na.rm = TRUE),
#     .groups = "drop"
#   )
# 
# dt_formatada(
#   tabela_pivotada(dados_agregados_orgao, agrupado_despesa_orgao),
#   agrupado_despesa_orgao
# )


formatar_numero((dados_despesa %>% 
  filter(resultado_eof_codigo == 6, item_informacao_codigo == 23) %>% summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao, na.rm =  TRUE)))$saldo_r_item_informacao)
```

```{r}
#| label: diagnostico-objetos-vazios
#| code-fold: true
#| eval: false

# ==============================================================================
# DIAGN√ìSTICO: Investigar Objetos Vazios
# ==============================================================================

# Criar consolida√ß√£o tempor√°ria para diagn√≥stico
dados_consolidados_temp <- consolidar_criterios(save_global = FALSE)

cat("\nüìä ESTRUTURA COMPLETA DOS DADOS CONSOLIDADOS:\n\n")

# Ver distribui√ß√£o por relat√≥rio e anexo
dados_consolidados_temp %>%
  group_by(relatorio, anexo_codigo) %>%
  summarise(
    n_linhas = n(),
    detalhes = paste(unique(detalhe), collapse = " | "),
    anexos_nome = paste(unique(anexo_nome), collapse = " | "),
    .groups = "drop"
  ) %>%
  arrange(relatorio, anexo_codigo) %>%
  print(n = 50)

# ==============================================================================
# 1. INVESTIGAR RGF A01 (Pessoal)
# ==============================================================================

cat("\n\nüîç RGF A01 - PESSOAL:\n")

rgf_a01_todos <- dados_consolidados_temp %>%
  filter(relatorio == "rgf", anexo_codigo == "A01")

if (nrow(rgf_a01_todos) == 0) {
  cat("‚ùå Nenhum dado encontrado para RGF A01\n")
  cat("Verificando poss√≠veis varia√ß√µes:\n")
  
  # Tentar outras combina√ß√µes
  dados_consolidados_temp %>%
    filter(grepl("rgf", relatorio, ignore.case = TRUE)) %>%
    distinct(relatorio, anexo_codigo, anexo_nome) %>%
    print()
} else {
  cat(sprintf("‚úÖ Encontrados %d linhas em RGF A01\n", nrow(rgf_a01_todos)))
  cat("\nValores √∫nicos:\n")
  cat("  - detalhe: ", paste(unique(rgf_a01_todos$detalhe), collapse = ", "), "\n")
  cat("  - anexo_nome: ", paste(unique(rgf_a01_todos$anexo_nome), collapse = ", "), "\n")
}

# ==============================================================================
# 2. INVESTIGAR RGF A03 (Garantias)
# ==============================================================================

cat("\n\nüîç RGF A03 - GARANTIAS:\n")

rgf_a03_todos <- dados_consolidados_temp %>%
  filter(relatorio == "rgf", anexo_codigo == "A03")

if (nrow(rgf_a03_todos) == 0) {
  cat("‚ùå Nenhum dado encontrado para RGF A03\n")
} else {
  cat(sprintf("‚úÖ Encontrados %d linhas em RGF A03\n", nrow(rgf_a03_todos)))
}

# ==============================================================================
# 3. INVESTIGAR RGF A05 (Disponibilidades)
# ==============================================================================

cat("\n\nüîç RGF A05 - DISPONIBILIDADES:\n")

# Tentar com 'A05' mai√∫sculo
rgf_a05_maiusculo <- dados_consolidados_temp %>%
  filter(relatorio == "rgf", anexo_codigo == "A05")

# Tentar com 'a05' min√∫sculo
rgf_a05_minusculo <- dados_consolidados_temp %>%
  filter(relatorio == "rgf", anexo_codigo == "a05")

cat(sprintf("  Com 'A05' mai√∫sculo: %d linhas\n", nrow(rgf_a05_maiusculo)))
cat(sprintf("  Com 'a05' min√∫sculo: %d linhas\n", nrow(rgf_a05_minusculo)))

if (nrow(rgf_a05_maiusculo) == 0 && nrow(rgf_a05_minusculo) == 0) {
  cat("‚ùå Nenhum dado encontrado para RGF A05\n")
  cat("C√≥digos de anexo dispon√≠veis em RGF:\n")
  dados_consolidados_temp %>%
    filter(relatorio == "rgf") %>%
    distinct(anexo_codigo) %>%
    arrange(anexo_codigo) %>%
    print()
}

# ==============================================================================
# 4. INVESTIGAR RREO A01 - Balan√ßo Or√ßament√°rio (Receitas/Despesas)
# ==============================================================================

cat("\n\nüîç RREO A01 - BALAN√áO OR√áAMENT√ÅRIO:\n")

rreo_a01_todos <- dados_consolidados_temp %>%
  filter(relatorio == "rreo", anexo_codigo == "A01")

cat(sprintf("Total: %d linhas\n", nrow(rreo_a01_todos)))
cat("\nValores √∫nicos de 'detalhe':\n")
print(unique(rreo_a01_todos$detalhe))

# Testar filtros
bo_receitas_teste <- rreo_a01_todos %>%
  filter(grepl("receitas", detalhe, ignore.case = TRUE))

bo_despesas_teste <- rreo_a01_todos %>%
  filter(grepl("despesas", detalhe, ignore.case = TRUE))

cat(sprintf("\nCom filtro 'receitas': %d linhas\n", nrow(bo_receitas_teste)))
cat(sprintf("Com filtro 'despesas': %d linhas\n", nrow(bo_despesas_teste)))

# ==============================================================================
# 5. RESUMO DE TODOS OS C√ìDIGOS DISPON√çVEIS
# ==============================================================================

cat("\n\nüìã TODOS OS C√ìDIGOS DISPON√çVEIS:\n\n")

dados_consolidados_temp %>%
  group_by(relatorio, anexo_codigo) %>%
  summarise(n = n(), .groups = "drop") %>%
  arrange(relatorio, anexo_codigo) %>%
  print(n = 50)
```

# Consolida√ß√£o

```{r}

#| code-fold: true
#| eval: false
#| label: consolidacao-master

# ==============================================================================
# CONSOLIDA√á√ÉO MASTER - FONTE √öNICA DA VERDADE
# ==============================================================================

dados_consolidados <- consolidar_criterios(save_global = FALSE)

message(sprintf("‚úÖ Consolida√ß√£o: %d linhas de %d relat√≥rios", 
                nrow(dados_consolidados),
                n_distinct(dados_consolidados$anexo_codigo)))

# ==============================================================================
# RGF
# ==============================================================================

# ------------------------------------------------------------------------------
# RGF A01 - PESSOAL (J√Å CRIADO ANTES COM aplicar_criterios INLINE)
# ------------------------------------------------------------------------------

# Os objetos pessoal e pessoal_rp j√° foram criados pelos chunks anteriores
# Apenas verificamos se existem

if (exists("pessoal") && exists("pessoal_rp")) {
  message(sprintf("‚úÖ RGF A01 - Pessoal: %d linhas | RP: %d linhas", 
                  nrow(pessoal), nrow(pessoal_rp)))
} else {
  warning("‚ö†Ô∏è RGF A01 - Objetos pessoal/pessoal_rp n√£o encontrados")
  pessoal <- tibble()
  pessoal_rp <- tibble()
}

# ------------------------------------------------------------------------------
# RGF A02 - DCL
# ------------------------------------------------------------------------------

dcl_completo <- dados_consolidados %>%
  filter(relatorio == "rgf", anexo_codigo == "A02")

message(sprintf("‚úÖ RGF A02 - DCL: %d linhas", nrow(dcl_completo)))

# ------------------------------------------------------------------------------
# RGF A03 - GARANTIAS
# ------------------------------------------------------------------------------

garantias <- dados_consolidados %>%
  filter(relatorio == "rgf", anexo_codigo == "A03")

if (nrow(garantias) == 0) {
  warning("‚ö†Ô∏è RGF A03 - Garantias n√£o encontrado")
  warning("   Verificar se aplicar_criterios foi extra√≠do do datatable()")
} else {
  message(sprintf("‚úÖ RGF A03 - Garantias: %d linhas", nrow(garantias)))
}

# ------------------------------------------------------------------------------
# RGF A04 - OPERA√á√ïES DE CR√âDITO
# ------------------------------------------------------------------------------

operacoes_credito <- dados_consolidados %>%
  filter(relatorio == "rgf", anexo_codigo == "A04")

message(sprintf("‚úÖ RGF A04 - Opera√ß√µes: %d linhas", nrow(operacoes_credito)))

# ------------------------------------------------------------------------------
# RGF A05 - DISPONIBILIDADES
# ------------------------------------------------------------------------------

disponibilidades <- dados_consolidados %>%
  filter(relatorio == "rgf", anexo_codigo == "A05")

if (nrow(disponibilidades) == 0) {
  warning("‚ö†Ô∏è RGF A05 - Disponibilidades n√£o encontrado")
  warning("   Verificar se vers√£o simplificada foi criada")
} else {
  message(sprintf("‚úÖ RGF A05 - Disponibilidades: %d linhas", nrow(disponibilidades)))
}

# ==============================================================================
# RREO
# ==============================================================================

# ------------------------------------------------------------------------------
# RREO A01 - BALAN√áO OR√áAMENT√ÅRIO
# ------------------------------------------------------------------------------

balanco_orcamentario <- dados_consolidados %>%
  filter(relatorio == "rreo", anexo_codigo == "A01")

# üîß USAR anexo_nome EM VEZ DE detalhe
bo_receitas <- balanco_orcamentario %>%
  filter(anexo_nome == "receitas")

bo_despesas <- balanco_orcamentario %>%
  filter(anexo_nome == "despesas")

message(sprintf("‚úÖ RREO A01 - Balan√ßo: %d linhas (receitas: %d | despesas: %d)", 
                nrow(balanco_orcamentario), nrow(bo_receitas), nrow(bo_despesas)))

# ------------------------------------------------------------------------------
# RREO A03 - RCL
# ------------------------------------------------------------------------------

rcl <- dados_consolidados %>%
  filter(relatorio == "rreo", anexo_codigo == "A03") %>%
  filter(
    (detalhe == "receitas_rcl") |
    (detalhe == "despesas_rcl" & item_informacao_codigo == "25") |
    (detalhe == "rp_cancelado_rcl" & item_informacao_codigo == "51")
  ) %>%
  mutate(
    tipo = case_when(
      ordem %in% c("01", "02", "03", "04", "05", "06", "07", "08", "09") ~ "receitas",
      ordem %in% c("11", "12", "13", "14", "15", "17") ~ "deducoes",
      ordem == "19" ~ "rp_cancelado",
      .default = "demais"
    )
  )

if (!exists("mes_filtro")) {
  mes_filtro <- max(rcl$mes_lancamento, na.rm = TRUE)
}

minimo_saude
# minimo_saude <- rcl %>%
#   filter(year(data_lancamento) == year(ym(mes_filtro))) %>%
#   group_by(tipo) %>%
#   summarise(valor = sum(valor, na.rm = TRUE), .groups = "drop") %>%
#   pivot_wider(names_from = tipo, values_from = valor, values_fill = 0)
# 
# colunas_esperadas <- c("deducoes", "demais", "receitas", "rp_cancelado")
# for (col in colunas_esperadas) {
#   if (!col %in% names(minimo_saude)) minimo_saude[[col]] <- 0
# }

message(sprintf("‚úÖ RREO A03 - RCL: %d linhas", nrow(rcl)))

# ------------------------------------------------------------------------------
# RREO A04 - PREVID√äNCIA
# ------------------------------------------------------------------------------

previdencia <- dados_consolidados %>%
  filter(relatorio == "rreo", anexo_codigo == "A04")

rgps_receita <- previdencia %>% filter(detalhe == "receitas_rgps")
rgps_despesa <- previdencia %>% filter(detalhe == "despesas_rgps")
fcdf_receita <- previdencia %>% filter(detalhe == "receitas_fcdf")
fcdf_despesa <- previdencia %>% filter(detalhe == "despesas_fcdf")
rpps_receita <- previdencia %>% filter(detalhe == "receitas_civil_militar_rpps")
rpps_despesa <- previdencia %>% filter(detalhe == "despesas_civil_militar_rpps")

message(sprintf("‚úÖ RREO A04 - Previd√™ncia: %d linhas", nrow(previdencia)))

# ------------------------------------------------------------------------------
# RREO - OUTROS
# ------------------------------------------------------------------------------

rreo_a06 <- dados_consolidados %>% filter(relatorio == "rreo", anexo_codigo == "A06")
rreo_a08 <- dados_consolidados %>% filter(relatorio == "rreo", anexo_codigo == "A08")
rreo_t01 <- dados_consolidados %>% filter(relatorio == "rreo", anexo_codigo == "T01")
rreo_t01b <- dados_consolidados %>% filter(relatorio == "rreo", anexo_codigo == "T01B")
rreo_t02 <- dados_consolidados %>% filter(relatorio == "rreo", anexo_codigo == "T02")

message("‚úÖ Consolida√ß√£o completa!")
```

```{r}
#| column: screen
datatable(rcl %>% 
              filter(
                  ym(mes_filtro)-months(11)< data_lancamento &
                      data_lancamento < ym(mes_filtro) +  months(1)
              ) %>% group_by(ordem, nome, data_lancamento) %>% summarise(valor = sum(valor)) %>% pivot_wider(names_from = data_lancamento, values_from = valor))%>%
    formatCurrency(3:14, "", mark = ".", dec.mark = ",", digits = 2)
```

# Consolidado Final

```{r}

# dcl

cat("\nüí∞ **DCL d√≠vida:** ", 
    valor_dcl, "\n")


# Resultado orcamentario

# Exibir com DT::datatable formatado
DT::datatable(
  df_resultado,
  options = list(dom = 't', pageLength = 3),
  rownames = FALSE
) %>%
  DT::formatCurrency("Valor", currency = "R$ ", digits = 2, mark = ".", dec.mark = ",")

# Funcao




datatable(dados_despesa %>% group_by( refinanciamento) %>% filter(item_informacao_codigo == 23) %>% summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao)) %>% adorn_totals(), caption = "RREO Anexo 02: Fun√ß√£o" )%>% formatRound("saldo_r_item_informacao", 2, mark = ".", dec.mark = "," )%>% 
  DT::formatStyle(columns = colnames(.$x$data), fontSize = '100%')


# RCL

print("RCL")

cat("\nüí∞ **RCL:** ", 
    formatar_real(sum(rcl_12_meses$resultado)), "\n")








# RGPS
DT::datatable(
  df_resultado_rgps,
  options = list(dom = 't', pageLength = 3),
  rownames = FALSE
) %>%
  DT::formatCurrency("Valor", currency = "R$ ", digits = 2, mark = ".", dec.mark = ",")


# RPPS Civil

DT::datatable(
  df_resultado_rpps_civil,
  options = list(dom = 't', pageLength = 3),
  rownames = FALSE
) %>%
  DT::formatCurrency("Valor", currency = "R$ ", digits = 2, mark = ".", dec.mark = ",")


# RPPS Militar

# Exibir tabela formatada
DT::datatable(
  df_resultado_rpps_militar,
  options = list(dom = 't', pageLength = 3),
  rownames = FALSE
) %>%
  DT::formatCurrency("Valor", currency = "R$ ", digits = 2, mark = ".", dec.mark = ",")


# RPPS

DT::datatable(
  df_resultado_rpps,
  options = list(dom = 't', pageLength = 3),
  rownames = FALSE
) %>%
  DT::formatCurrency("Valor", currency = "R$ ", digits = 2, mark = ".", dec.mark = ",")



# RPPS FCDP

DT::datatable(
  df_resultado_fcdf,
  options = list(dom = 't', pageLength = 3),
  rownames = FALSE
) %>%
  DT::formatCurrency("Valor", currency = "R$ ", digits = 2, mark = ".", dec.mark = ",")



# ==============================================================================
# RREO ANEXO 6 - RESULTADO PRIM√ÅRIO
# ==============================================================================

# Fun√ß√£o auxiliar
obter_valor <- function(codigo) {
  linha <- rreo_a06_final %>% 
    filter(str_detect(categoria, paste0("^", sprintf("%02d", codigo), "  ")))
  if (nrow(linha) == 0) return(0)
  return(linha$valor[1])
}

# C√°lculos
resultado_primario <- tibble(
  componente = c(
    "RECEITA PRIM√ÅRIA CORRENTE (IV)",
    "RECEITA PRIM√ÅRIA DE CAPITAL (XI)",
    "RECEITA PRIM√ÅRIA TOTAL (XII)",
    "DESPESA PRIM√ÅRIA CORRENTE (XV)",
    "DESPESA PRIM√ÅRIA DE CAPITAL (XXI)",
    "(+) Subs√≠dios CESEF",
    "DESPESA PRIM√ÅRIA TOTAL (XXIII)",
    "RESULTADO PRIM√ÅRIO (XII - XXIII)"
  ),
  valor = c(
    obter_valor(1) - obter_valor(5) - obter_valor(9),
    obter_valor(12) - obter_valor(13) - obter_valor(14) - obter_valor(20),
    NA,  # ser√° calculado
    obter_valor(23) - obter_valor(25),
    obter_valor(28) - obter_valor(34) - obter_valor(31),
    obter_valor(37),
    NA,  # ser√° calculado
    NA   # ser√° calculado
  )
) %>%
  mutate(
    valor = case_when(
      componente == "RECEITA PRIM√ÅRIA TOTAL (XII)" ~ valor[1] + valor[2],
      componente == "DESPESA PRIM√ÅRIA TOTAL (XXIII)" ~ valor[4] + valor[5] + valor[6],
      componente == "RESULTADO PRIM√ÅRIO (XII - XXIII)" ~ (valor[1] + valor[2]) - (valor[4] + valor[5] + valor[6]),
      TRUE ~ valor
    )
  )

# Exibir
datatable(resultado_primario) %>%
  formatRound("valor", 2, mark = ".", dec.mark = ",")

# Educa√ß√£o

# Renderizar tabela
kable(resumo_aplicacao, 
      caption = "üéØ Resumo da Aplica√ß√£o em MDE",
      format = "html",
      col.names = c("Item", "Valor", "Status"),
      align = c("l", "r", "c")) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE
  ) %>%
  row_spec(0, bold = TRUE, background = "#f8f9fa") %>%
  row_spec(6, bold = TRUE, 
           background = ifelse(as.numeric(percentual_aplicacao) >= 100, "#d4edda", "#f8d7da"),
           color = ifelse(as.numeric(percentual_aplicacao) >= 100, "#155724", "#721c24")) %>%
  column_spec(2, width = "200px")


# regra de ouro

datatable(regra_ouro_df,
          caption = paste("Resultado da Regra de Ouro - M√™s", mes_atual),
          options = list(pageLength = 10, dom = 't'),
          rownames = FALSE) %>%
  formatCurrency("Valor", 
                 currency = "R$ ", 
                 digits = 2, 
                 mark = ".", 
                 dec.mark = ",")



# ==============================================================================
# RREO ANEXO 9 - REGRA DE OURO
# ==============================================================================

# ------------------------------------------------------------------------------
# VARI√ÅVEL MANUAL - Saldo inicial da d√≠vida (ajustar anualmente)
# ------------------------------------------------------------------------------
saldo_inicial_divida <- 731471695519.71  # Saldo abertura 2025 (000/2025)

# ------------------------------------------------------------------------------
# 1. RECEITAS DE OPERA√á√ïES DE CR√âDITO
# ------------------------------------------------------------------------------
# Filtro: Item Informa√ß√£o = 5 (Receita L√≠quida), Origem = 21 ou 81

receitas_op_credito <- dados_receita %>%
  filter(
    mes_lancamento == mes_filtro,
    item_informacao_codigo == "5",
    str_starts(natureza_receita_codigo_completo, "21") | 
    str_starts(natureza_receita_codigo_completo, "81")
  ) %>%
  summarise(valor = sum(saldo_r_item_informacao, na.rm = TRUE)) %>%
  pull(valor)

# ------------------------------------------------------------------------------
# 2. DESPESAS DE CAPITAL (Liquidadas + Inscritas em RP N√£o Processados)
# ------------------------------------------------------------------------------
# Filtro: Categoria = 4 (Capital), Item Informa√ß√£o = 25 (Liquidadas)
# Nota: Inscritas em RP NP pode estar em outra fonte

despesas_capital <- dados_despesa %>%
  filter(
    mes_lancamento == mes_filtro,
    categoria_economica_despesa_codigo == "4",
    item_informacao_codigo == "25"
  ) %>%
  summarise(valor = sum(saldo_r_item_informacao, na.rm = TRUE)) %>%
  pull(valor)

# ------------------------------------------------------------------------------
# 3. SUBCONTA DA D√çVIDA (Saldo atual)
# ------------------------------------------------------------------------------
saldo_atual_divida <- rgf_a02_balancete %>%
  filter(
    conta_contabil_numero == "111110401",
    mes_lancamento == mes_filtro
  ) %>%
  summarise(valor = sum(saldo_r_conta_contabil, na.rm = TRUE)) %>%
  pull(valor)

variacao_divida <- saldo_atual_divida - saldo_inicial_divida

# ------------------------------------------------------------------------------
# 4. C√ÅLCULO DA REGRA DE OURO
# ------------------------------------------------------------------------------
regra_ouro <- despesas_capital - (receitas_op_credito - variacao_divida)
status <- ifelse(regra_ouro > 0, "N√ÉO CUMPRIDA", "CUMPRIDA")

# ------------------------------------------------------------------------------
# 5. RESULTADO
# ------------------------------------------------------------------------------
tibble(
  Componente = c(
    "Receitas de Opera√ß√µes de Cr√©dito (I)",
    "(-) Varia√ß√£o Subconta da D√≠vida (II)",
    "= Receitas L√≠quidas (III = I - II)",
    "Despesas de Capital (IV)",
    "REGRA DE OURO (IV - III)"
  ),
  Valor = c(
    receitas_op_credito,
    variacao_divida,
    receitas_op_credito - variacao_divida,
    despesas_capital,
    regra_ouro
  )
) %>%
  datatable(
    caption = paste("Regra de Ouro -", mes_filtro, "| Status:", status),
    options = list(dom = 't')
  ) %>%
  formatRound("Valor", 2, mark = ".", dec.mark = ",")

# Sa√∫de

# Sa√∫de - usando print() e datatable() em vez de cat()

# Exibir m√≠nimo sa√∫de como tabela
datatable(
  data.frame(
    Indicador = "M√≠nimo Constitucional Sa√∫de (15% RCL)",
    Valor = if(is.data.frame(minimo_saude)) {
      (minimo_saude$receitas - minimo_saude$deducoes + minimo_saude$rp_cancelado) * 0.15
    } else {
      minimo_saude
    }
  ),
  options = list(dom = 't'),
  rownames = FALSE
) %>%
  formatCurrency("Valor", currency = "R$ ", digits = 2, mark = ".", dec.mark = ",")

# Total consolidado
total_consolidado <- sum(despesas_saude_completa$saldo_r_item_informacao, na.rm = TRUE) / 1000

# Calcular valor do m√≠nimo para compara√ß√£o
valor_minimo <- if(is.data.frame(minimo_saude)) {
  (minimo_saude$receitas - minimo_saude$deducoes + minimo_saude$rp_cancelado) * 0.15
} else {
  as.numeric(minimo_saude)
}

# Calcular percentual
pct_cumprimento <- (total_consolidado * 1000 / valor_minimo) * 100

# Exibir como datatable
datatable(
  data.frame(
    Indicador = c("Total Despesas Sa√∫de (R$ mil)", "M√≠nimo Constitucional", "Cumprimento (%)"),
    Valor = c(
      format(total_consolidado, big.mark = ".", decimal.mark = ",", nsmall = 2),
      format(valor_minimo / 1000, big.mark = ".", decimal.mark = ",", nsmall = 2),
      paste0(format(pct_cumprimento, digits = 4, nsmall = 2), "%")
    )
  ),
  options = list(dom = 't'),
  rownames = FALSE,
  caption = "üí∞ Cumprimento do M√≠nimo Constitucional - Sa√∫de"
)


# resultado seguridade

# Op√ß√£o 1: usar pull()
resultado_seguridade <- as.numeric(
  df_criterios_rreo_T01_receitas %>% 
    filter(ordem == "14") %>% 
    summarise(valor = valor) %>% 
    pull(valor)
) - as.numeric(
  df_criterios_rreo_T01_despesas_T01 %>% 
    filter(ordem == "11") %>% 
    summarise(valor = valor) %>% 
    pull(valor)
)

data.frame(
  Indicador = "Resultado Seguridade",
  Valor = resultado_seguridade
) %>%
  datatable(
    options = list(dom = 't', pageLength = 1),
    rownames = FALSE,
    caption = "üí∞ Resultado Seguridade"
  ) %>%
  formatCurrency("Valor", currency = "R$ ", digits = 2, mark = ".", dec.mark = ",")

datatable(aplicar_criterios(
  df = dados_despesa %>% filter(esfera_orcamentaria_codigo == 2, item_informacao_codigo == "25") %>% unique(),
  criterios = criterios_rreo_T01B_seguridade_T01B
)%>% group_by(categoria) %>% summarise(valor = sum(valor, na.rm = TRUE))) %>%
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")

# Tabela 02

datatable(
  aplicar_criterios(
    df = dados_despesa %>% 
      filter(
        grupo_despesa_codigo_grupo == 1,
        orgao_uge_orcam_fiscal_s_n == "PERTENCE",
        mes_lancamento == mes_filtro,
        item_informacao_codigo %in% c(13, 25)  # Dota√ß√£o e Liquidada
      ),
    criterios = criterios_rreo_T02_despesas_T02,
    group_vars = c("orgao_uge_tipo_administracao_nome", "item_informacao_nome")
  ) %>% 
    group_by(orgao_uge_tipo_administracao_nome, item_informacao_nome) %>% 
    summarise(valor = sum(valor, na.rm = TRUE), .groups = "drop") %>% 
    pivot_wider(names_from = "orgao_uge_tipo_administracao_nome", values_from = "valor") %>%
    select(
      item_informacao_nome,
      `ADMINISTRACAO DIRETA`,
      AUTARQUIA,
      FUNDACAO,
      `EMPRESA PUBLICA COMERCIAL E FINANCEIRA`,
      `ECONOMIA MISTA`,
      FUNDOS
    )
) %>%
  formatRound(
    c('ADMINISTRACAO DIRETA',
      'AUTARQUIA',
      'FUNDACAO',
      'EMPRESA PUBLICA COMERCIAL E FINANCEIRA',
      'ECONOMIA MISTA',
      'FUNDOS'), 
    2, mark = ".", dec.mark = ","
  )

# Tabela 03




cat( "\nüí∞ **Tabela 03:** ", formatar_numero((dados_despesa %>% 
  filter(resultado_eof_codigo == 6, item_informacao_codigo == 23) %>% summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao, na.rm =  TRUE)))$saldo_r_item_informacao), "\n") 

```

```{r}
datatable(aplicar_criterios(df = dados_despesa %>% 
    filter( grupo_despesa_codigo_grupo == 1,  orgao_uge_orcam_fiscal_s_n == "PERTENCE",   mes_lancamento == mes_filtro, item_informacao_codigo == 25
    ),
  criterios = criterios_rreo_T02_despesas_T02,
  group_vars = c("orgao_uge_tipo_administracao_nome")) %>% group_by(categoria, orgao_uge_tipo_administracao_nome) %>% summarise(valor = sum(valor, na.rm = TRUE)) %>% pivot_wider(names_from = "orgao_uge_tipo_administracao_nome", values_from = "valor") ) %>%
  formatRound(c('ADMINISTRACAO DIRETA',
  'AUTARQUIA',
  'ECONOMIA MISTA',
  'EMPRESA PUBLICA COMERCIAL E FINANCEIRA',
  'FUNDACAO',
  'FUNDOS'), 2, mark = ".", dec.mark = ",")


datatable(
  aplicar_criterios(
    df = dados_despesa %>% 
      filter(
        grupo_despesa_codigo_grupo == 1,
        orgao_uge_orcam_fiscal_s_n == "PERTENCE",
        mes_lancamento == mes_filtro,
        item_informacao_codigo == 25
      ),
    criterios = criterios_rreo_T02_despesas_T02,
    group_vars = c("orgao_uge_tipo_administracao_nome")
  ) %>% 
    group_by(orgao_uge_tipo_administracao_nome) %>% 
    summarise(valor = sum(valor, na.rm = TRUE)) %>% 
    pivot_wider(names_from = "orgao_uge_tipo_administracao_nome", values_from = "valor") %>%
    # Reordenar colunas conforme relat√≥rio oficial
    select(
      `ADMINISTRACAO DIRETA`,
      AUTARQUIA,
      FUNDACAO,
      `EMPRESA PUBLICA COMERCIAL E FINANCEIRA`,
      `ECONOMIA MISTA`,
      FUNDOS
    )
) %>%
  formatRound(
    c('ADMINISTRACAO DIRETA',
      'AUTARQUIA',
      'FUNDACAO',
      'EMPRESA PUBLICA COMERCIAL E FINANCEIRA',
      'ECONOMIA MISTA',
      'FUNDOS'), 
    2, mark = ".", dec.mark = ","
  )
```

```{r}
#| column: screen
# 
# dados_consolidados <- consolidar_criterios(save_global = FALSE)
# 
# datatable(dados_consolidados %>% group_by(dataframe_nome,relatorio, anexo_codigo, anexo_nome, detalhe) %>% count())
# 
# 
# 
# datatable(dados_consolidados)
# 
# # No seu c√≥digo, ap√≥s definir mes_pasta:
# df_arquivos_tg <- mapear_arquivos_tg(mes_pasta)
# 
# # Visualizar
# datatable(df_arquivos_tg)
```

# importar RGF anexo 6 e RREO anexo 14

```{r}
# ============================================================================
# VALIDACAO - COMPARACAO COM RELATORIOS OFICIAIS
# ============================================================================
# Compara valores calculados com RREO Anexo 14 e RGF Anexo 06 oficiais.
# Valores oficiais estao em R$ milhares.
#
# IMPORTANTE: Este chunk deve ser executado APOS o chunk {r variaveis_globais}
# onde mes_filtro e mes_pasta sao definidos.
# ============================================================================

#| echo: true
#| output: true

# ----------------------------------------------------------------------------
# CONFIGURACAO
# ----------------------------------------------------------------------------
# Se mes_pasta nao existir, defina aqui:
if (!exists("mes_pasta")) {
  mes_filtro <- "202511"
  mes_pasta <- str_c("data/", mes_filtro, "/")
}

# Arquivos oficiais (ajuste os nomes conforme necessario)
arquivo_rreo_a14 <- str_c(mes_pasta, "Anexo 14 - Simplificado.xlsm")
arquivo_rgf_a06 <- str_c(mes_pasta, "Anexo 6 Simplificado - 2025.xlsx")

# ----------------------------------------------------------------------------
# FUNCAO AUXILIAR: Ler valor de uma celula
# ----------------------------------------------------------------------------

ler_celula <- function(arquivo, celula, sheet = 1) {
  tryCatch({
    read_excel(arquivo, sheet = sheet, range = celula, col_names = FALSE)[[1]][1]
  }, error = function(e) NA_real_)
}

# ----------------------------------------------------------------------------
# MAPEAMENTO RREO ANEXO 14 - Celulas e descricoes
# ----------------------------------------------------------------------------

mapa_rreo_a14 <- tribble(
  ~item, ~celula, ~descricao,
  
  # BALANCO ORCAMENTARIO - RECEITAS (linhas 10-14)
  "previsao_inicial",        "B10", "Previsao Inicial da Receita",
  "previsao_atualizada",     "B11", "Previsao Atualizada",
  "receitas_realizadas",     "B12", "Receitas Realizadas",
  "saldos_anteriores",       "B14", "Saldos de Exercicios Anteriores",
  

  # BALANCO ORCAMENTARIO - DESPESAS (linhas 17-22)
  "dotacao_inicial",         "B17", "Dotacao Inicial",
  "dotacao_atualizada",      "B18", "Dotacao Atualizada",
  "despesas_empenhadas",     "B19", "Despesas Empenhadas",
  "despesas_liquidadas",     "B20", "Despesas Liquidadas",
  "despesas_pagas",          "E21", "Despesas Pagas",
  "superavit_orcamentario",  "B22", "Superavit Orcamentario",
  
  # DESPESAS POR FUNCAO (linhas 25-26) - exceto refinanciamento
  "funcao_empenhadas",       "B25", "Desp. Empenhadas por Funcao",
  "funcao_liquidadas",       "B26", "Desp. Liquidadas por Funcao",
  
  # RCL (linha 29)
  "rcl",                     "B29", "Receita Corrente Liquida",
  
  # RGPS (linhas 32-34)
  "rgps_receitas",           "B32", "RGPS - Receitas",
  "rgps_despesas",           "B33", "RGPS - Despesas",
  "rgps_resultado",          "B34", "RGPS - Resultado",
  
  # RPPS Civil (linhas 36-38)
  "rpps_receitas",           "B36", "RPPS - Receitas",
  "rpps_despesas",           "B37", "RPPS - Despesas",
  "rpps_resultado",          "B38", "RPPS - Resultado",
  
  # Militares (linhas 40-42)
  "militar_receitas",        "B40", "Militares - Receitas",
  "militar_despesas",        "B41", "Militares - Despesas",
  "militar_resultado",       "B42", "Militares - Resultado",
  
  # FCDF (linhas 44-46)
  "fcdf_receitas",           "B44", "FCDF - Receitas",
  "fcdf_despesas",           "B45", "FCDF - Despesas",
  "fcdf_resultado",          "B46", "FCDF - Resultado",
  
  # RESULTADOS (linhas 58-59)
  "resultado_nominal",       "B58", "Resultado Nominal",
  "resultado_primario",      "B59", "Resultado Primario",
  
  # RESTOS A PAGAR PROCESSADOS (linha 62)
  "rpp_inscricao",           "B62", "RP Processados - Inscricao",
  "rpp_cancelamento",        "C62", "RP Processados - Cancelamento",
  "rpp_pagamento",           "D62", "RP Processados - Pagamento",
  "rpp_saldo",               "E62", "RP Processados - Saldo",
  
  # RESTOS A PAGAR NAO PROCESSADOS (linha 68)
  "rpnp_inscricao",          "B68", "RPNP - Inscricao",
  "rpnp_cancelamento",       "C68", "RPNP - Cancelamento",
  "rpnp_pagamento",          "D68", "RPNP - Pagamento",
  "rpnp_saldo",              "E68", "RPNP - Saldo",
  
  # MDE (linhas 77, 79)
  "mde_aplicado",            "B77", "MDE - Valor Aplicado",
  "mde_minimo",              "C77", "MDE - Minimo a Aplicar",
  "fundeb_complementacao",   "B79", "Complementacao FUNDEB",
  
  # ASPS (linha 82)
  "asps_aplicado",           "B82", "ASPS - Valor Aplicado",
  "asps_minimo",             "C82", "ASPS - Minimo a Aplicar"
)

# ----------------------------------------------------------------------------
# MAPEAMENTO RGF ANEXO 06 - Celulas e descricoes
# ----------------------------------------------------------------------------

mapa_rgf_a06 <- tribble(
  ~item, ~celula, ~descricao,
  
  # RCL (linha 10)
  "rcl",                     "B10", "Receita Corrente Liquida",
  
  # PESSOAL - EXECUTIVO (linhas 15-18)
  "dtp_executivo",           "B15", "DTP - Poder Executivo",
  "limite_max_exec",         "B16", "Limite Maximo - Executivo",
  "limite_prud_exec",        "B17", "Limite Prudencial - Executivo",
  "limite_alerta_exec",      "B18", "Limite Alerta - Executivo",
  
  # PESSOAL - AMAPA (linhas 20-23)
  "dtp_amapa",               "B20", "DTP - Amapa",
  "limite_max_ap",           "B21", "Limite Maximo - Amapa",
  "limite_prud_ap",          "B22", "Limite Prudencial - Amapa",
  "limite_alerta_ap",        "B23", "Limite Alerta - Amapa",
  
  # PESSOAL - RORAIMA (linhas 25-28)
  "dtp_roraima",             "B25", "DTP - Roraima",
  "limite_max_rr",           "B26", "Limite Maximo - Roraima",
  "limite_prud_rr",          "B27", "Limite Prudencial - Roraima",
  "limite_alerta_rr",        "B28", "Limite Alerta - Roraima",
  
  # PESSOAL - DF (linhas 30-33)
  "dtp_df",                  "B30", "DTP - Distrito Federal",
  "limite_max_df",           "B31", "Limite Maximo - DF",
  "limite_prud_df",          "B32", "Limite Prudencial - DF",
  "limite_alerta_df",        "B33", "Limite Alerta - DF",
  
  # DIVIDA (linha 36-37)
  "dcl",                     "B36", "Divida Consolidada Liquida",
  "limite_dcl",              "B37", "Limite DCL (Resolucao SF)",
  
  # GARANTIAS (linhas 40-41)
  "garantias",               "B40", "Total das Garantias",
  "limite_garantias",        "B41", "Limite Garantias",
  
  # OPERACOES DE CREDITO (linhas 44-45)
  "op_credito",              "B44", "Operacoes de Credito",
  "limite_op_credito",       "B45", "Limite Op. Credito",
  
  # DISPONIBILIDADE (linha 52)
  "rpnp_exercicio",          "B52", "RPNP do Exercicio",
  "disponibilidade_caixa",   "C52", "Disponibilidade de Caixa Liquida"
)

# ----------------------------------------------------------------------------
# FUNCAO: Ler todos os valores oficiais de um arquivo
# ----------------------------------------------------------------------------

ler_valores_oficiais <- function(arquivo, mapa) {
  
  if (!file.exists(arquivo)) {
    cat(sprintf("AVISO: Arquivo nao encontrado: %s\n", arquivo))
    return(mapa %>% mutate(valor_oficial = NA_real_))
  }
  
  cat(sprintf("Lendo: %s\n", basename(arquivo)))
  
  mapa %>%
    rowwise() %>%
    mutate(valor_oficial = ler_celula(arquivo, celula)) %>%
    ungroup()
}

# ----------------------------------------------------------------------------
# FUNCAO: Comparar valores (oficial em milhares vs sistema em unidades)
# ----------------------------------------------------------------------------

comparar_com_sistema <- function(df_oficial, df_sistema, coluna_valor = "valor") {
  
  df_oficial %>%
    left_join(
      df_sistema %>% select(item, valor_sistema = !!sym(coluna_valor)), 
      by = "item"
    ) %>%
    mutate(
      # Sistema em milhares para comparar
      sistema_milhar = valor_sistema / 1000,
      
      # Diferencas
      diferenca = sistema_milhar - valor_oficial,
      dif_pct = ifelse(
        !is.na(valor_oficial) & valor_oficial != 0,
        round((diferenca / abs(valor_oficial)) * 100, 4),
        NA_real_
      ),
      
      # Status
      status = case_when(
        is.na(valor_oficial) ~ "Sem oficial",
        is.na(valor_sistema) ~ "Sem sistema",
        abs(diferenca) < 1 ~ "OK",
        abs(dif_pct) < 0.01 ~ "OK",
        abs(dif_pct) < 0.1 ~ "Atencao",
        TRUE ~ "DIVERGENTE"
      )
    ) %>%
    select(item, descricao, celula, 
           oficial = valor_oficial, 
           sistema = sistema_milhar, 
           diferenca, dif_pct, status)
}

# ----------------------------------------------------------------------------
# FUNCAO: Exibir resultado da validacao
# ----------------------------------------------------------------------------

exibir_validacao <- function(df, titulo) {
  
  cat(sprintf("\n========== %s ==========\n", titulo))
  
  # Contagem por status
  resumo <- df %>% count(status)
  for (i in 1:nrow(resumo)) {
    cat(sprintf("  %s: %d\n", resumo$status[i], resumo$n[i]))
  }
  
  # Tabela com formatacao
  df %>%
    mutate(
      oficial = ifelse(is.na(oficial), "-", format(round(oficial), big.mark = ".", decimal.mark = ",")),
      sistema = ifelse(is.na(sistema), "-", format(round(sistema), big.mark = ".", decimal.mark = ",")),
      diferenca = ifelse(is.na(diferenca), "-", format(round(diferenca), big.mark = ".", decimal.mark = ",")),
      dif_pct = ifelse(is.na(dif_pct), "-", paste0(format(dif_pct, nsmall = 4), "%"))
    ) %>%
    datatable(
      caption = titulo,
      options = list(pageLength = 50, dom = 'Bfrtip'),
      rownames = FALSE
    ) %>%
    formatStyle(
      'status',
      backgroundColor = styleEqual(
        c("OK", "Atencao", "DIVERGENTE", "Sem oficial", "Sem sistema"),
        c("#90EE90", "#FFFF99", "#FF6B6B", "#D3D3D3", "#D3D3D3")
      )
    )
}

# ============================================================================
# EXECUCAO DA VALIDACAO
# ============================================================================

# 1. Ler valores oficiais
cat("=== LEITURA DOS ARQUIVOS OFICIAIS ===\n")
rreo_oficial <- ler_valores_oficiais(arquivo_rreo_a14, mapa_rreo_a14)
rgf_oficial <- ler_valores_oficiais(arquivo_rgf_a06, mapa_rgf_a06)

# 2. Preparar valores do sistema
# ADAPTE esta secao conforme a estrutura do seu df_criterios_consolidado
# Exemplo:

# sistema_rreo <- tribble(
#   ~item, ~valor,
#   "previsao_inicial", sum(df_criterios_consolidado %>% filter(...) %>% pull(valor)),
#   "receitas_realizadas", sum(...),
#   ...
# )

# 3. Comparar e exibir
# comparacao_rreo <- comparar_com_sistema(rreo_oficial, sistema_rreo)
# exibir_validacao(comparacao_rreo, "VALIDACAO RREO ANEXO 14")

# comparacao_rgf <- comparar_com_sistema(rgf_oficial, sistema_rgf)
# exibir_validacao(comparacao_rgf, "VALIDACAO RGF ANEXO 06")

# ============================================================================
# VISUALIZACAO RAPIDA DOS VALORES OFICIAIS
# ============================================================================

cat("\n=== VALORES OFICIAIS RREO A14 (em milhares) ===\n")
rreo_oficial %>%
  filter(!is.na(valor_oficial)) %>%
  mutate(valor_formatado = format(valor_oficial, big.mark = ".", decimal.mark = ",")) %>%
  select(item, descricao, celula, valor_formatado) %>%
  print(n = 50)

cat("\n=== VALORES OFICIAIS RGF A06 (em milhares) ===\n")
rgf_oficial %>%
  filter(!is.na(valor_oficial)) %>%
  mutate(valor_formatado = format(valor_oficial, big.mark = ".", decimal.mark = ",")) %>%
  select(item, descricao, celula, valor_formatado) %>%
  print(n = 30)
```

# Valida√ß√£o RREO

```{r}
# Validacao RREO A14 e RGF A06 - Sistema vs Oficial (R$ milhares)

#| echo: true
#| output: true

# Funcao auxiliar para extrair valor com seguranca
extrair_valor <- function(df, filtro_col, filtro_valor, coluna_valor = "Valor") {
  tryCatch({
    resultado <- df %>% filter(!!sym(filtro_col) == filtro_valor)
    if (nrow(resultado) == 0) return(NA_real_)
    val <- resultado[[coluna_valor]][1]
    if (is.null(val) || length(val) == 0) return(NA_real_)
    return(as.numeric(val))
  }, error = function(e) NA_real_)
}

# Funcao para ler celula do Excel
ler_celula <- function(arquivo, celula, sheet = 1) {
  tryCatch({
    read_excel(arquivo, sheet = sheet, range = celula, col_names = FALSE)[[1]][1]
  }, error = function(e) NA_real_)
}

# MAPEAMENTO COMPLETO RREO A14
mapa_rreo_a14 <- tribble(
  ~item, ~celula, ~descricao, ~fonte,
  # Balanco Orcamentario - Receitas (Anexo 1)
  "bo_previsao_inicial",    "B10", "BO - Previsao Inicial Receita", "A01",
  "bo_previsao_atualizada", "B11", "BO - Previsao Atualizada", "A01",
  "bo_receitas_realizadas", "B12", "BO - Receitas Realizadas", "A01",
  "bo_saldos_anteriores",   "B14", "BO - Saldos Exerc. Anteriores", "A01",
  
  # Balanco Orcamentario - Despesas (Anexo 2)
  "bo_dotacao_inicial",     "B17", "BO - Dotacao Inicial", "A02",
  "bo_dotacao_atualizada",  "B18", "BO - Dotacao Atualizada", "A02",
  "bo_despesas_empenhadas", "B19", "BO - Despesas Empenhadas", "A02",
  "bo_despesas_liquidadas", "B20", "BO - Despesas Liquidadas", "A02",
  "bo_despesas_pagas",      "E21", "BO - Despesas Pagas", "A02",
  "bo_superavit",           "B22", "BO - Superavit Orcamentario", "A02",
  
  # Despesas por Funcao (Anexo 2 - exceto refinanciamento)
  "funcao_empenhadas",      "B25", "Funcao - Desp. Empenhadas", "A02",
  "funcao_liquidadas",      "B26", "Funcao - Desp. Liquidadas", "A02",
  
  # RCL (Anexo 3)
  "rcl",                    "B29", "Receita Corrente Liquida", "A03",
  
  # RGPS (Anexo 4)
  "rgps_receitas",          "B32", "RGPS - Receitas", "A04",
  "rgps_despesas",          "B33", "RGPS - Despesas", "A04",
  "rgps_resultado",         "B34", "RGPS - Resultado", "A04",
  
  # RPPS Civil (Anexo 4)
  "rpps_receitas",          "B36", "RPPS Civil - Receitas", "A04",
  "rpps_despesas",          "B37", "RPPS Civil - Despesas", "A04",
  "rpps_resultado",         "B38", "RPPS Civil - Resultado", "A04",
  
  # Militares (Anexo 4)
  "militar_receitas",       "B40", "Militares - Receitas", "A04",
  "militar_despesas",       "B41", "Militares - Despesas", "A04",
  "militar_resultado",      "B42", "Militares - Resultado", "A04",
  
  # FCDF (Anexo 4)
  "fcdf_receitas",          "B44", "FCDF - Receitas", "A04",
  "fcdf_despesas",          "B45", "FCDF - Despesas", "A04",
  "fcdf_resultado",         "B46", "FCDF - Resultado", "A04",
  
  # Resultados (Anexo 6)
  "resultado_nominal",      "B58", "Resultado Nominal", "A06",
  "resultado_primario",     "B59", "Resultado Primario", "A06",
  
  # Restos a Pagar Processados (Anexo 7)
  "rpp_inscricao",          "B62", "RP Proc - Inscricao", "A07",
  "rpp_cancelamento",       "C62", "RP Proc - Cancelamento", "A07",
  "rpp_pagamento",          "D62", "RP Proc - Pagamento", "A07",
  "rpp_saldo",              "E62", "RP Proc - Saldo", "A07",
  
  # Restos a Pagar Nao Processados (Anexo 7)
  "rpnp_inscricao",         "B68", "RPNP - Inscricao", "A07",
  "rpnp_cancelamento",      "C68", "RPNP - Cancelamento", "A07",
  "rpnp_pagamento",         "D68", "RPNP - Pagamento", "A07",
  "rpnp_saldo",             "E68", "RPNP - Saldo", "A07",
  
  # MDE (Anexo 8)
  "mde_aplicado",           "B77", "MDE - Valor Aplicado", "A08",
  "mde_minimo",             "C77", "MDE - Minimo a Aplicar", "A08",
  "fundeb_complementacao",  "B79", "Complementacao FUNDEB", "A08",
  
  # ASPS (Anexo 12)
  "asps_aplicado",          "B82", "ASPS - Valor Aplicado", "A12",
  "asps_minimo",            "C82", "ASPS - Minimo a Aplicar", "A12"
)

# COLETAR VALORES DO SISTEMA - RREO
cat("Coletando valores do sistema RREO...\n")

# RCL
valor_rcl <- tryCatch({
  res <- sum(rcl_12_meses$resultado, na.rm = TRUE)
  if (length(res) == 0) NA_real_ else as.numeric(res[1])
}, error = function(e) NA_real_)

# RGPS
valor_rgps_rec <- extrair_valor(df_resultado_rgps, "Tipo", "Receita_RGPS")
valor_rgps_desp <- extrair_valor(df_resultado_rgps, "Tipo", "Despesa_RGPS")
valor_rgps_res <- extrair_valor(df_resultado_rgps, "Tipo", "Resultado_RGPS")

# RPPS Civil
valor_rpps_rec <- extrair_valor(df_resultado_rpps_civil, "Tipo", "Receita_RPPS_Civil")
valor_rpps_desp <- extrair_valor(df_resultado_rpps_civil, "Tipo", "Despesa_RPPS_Civil")
valor_rpps_res <- extrair_valor(df_resultado_rpps_civil, "Tipo", "Resultado_RPPS_Civil")

# RPPS Militar
valor_mil_rec <- extrair_valor(df_resultado_rpps_militar, "Tipo", "Receita_RPPS_Militar")
valor_mil_desp <- extrair_valor(df_resultado_rpps_militar, "Tipo", "Despesa_RPPS_Militar")
valor_mil_res <- extrair_valor(df_resultado_rpps_militar, "Tipo", "Resultado_RPPS_Militar")

# FCDF
valor_fcdf_rec <- extrair_valor(df_resultado_fcdf, "Tipo", "Receita_FCDF")
valor_fcdf_desp <- extrair_valor(df_resultado_fcdf, "Tipo", "Despesa_FCDF")
valor_fcdf_res <- extrair_valor(df_resultado_fcdf, "Tipo", "Resultado_FCDF")

# Resultado Primario e Nominal
# =====================================
# Fonte: rp_claude.xlsm (planilha do setor que consolida dados do Comparativo CESEF)
# A aba "Comparativo CESEF" recebe dados da outra √°rea (RTN)

arquivo_rp <- str_c(mes_pasta, "rp_claude.xlsm")

# Resultado Prim√°rio - c√©lula E53
valor_res_prim <- tryCatch({
  if (file.exists(arquivo_rp)) {
    read_excel(arquivo_rp, 
               sheet = "Anexo 6 RP e RN Novo (INTERNET)", 
               range = "E53", 
               col_names = FALSE)[[1]][1] * 1000  # milhares -> unidades
  } else {
    # Fallback: usar c√°lculo do sistema (sem ajuste metodol√≥gico)
    res <- resultado_primario %>%
      filter(componente == "RESULTADO PRIM√ÅRIO (XII - XXIII)") %>%
      pull(valor)
    if (length(res) == 0) NA_real_ else as.numeric(res[1])
  }
}, error = function(e) NA_real_)

# Resultado Nominal - c√©lula C60
valor_res_nominal <- tryCatch({
  if (file.exists(arquivo_rp)) {
    read_excel(arquivo_rp, 
               sheet = "Anexo 6 RP e RN Novo (INTERNET)", 
               range = "C60", 
               col_names = FALSE)[[1]][1] * 1000  # milhares -> unidades
  } else {
    NA_real_
  }
}, error = function(e) NA_real_)

# MDE - Total Despesas (usar variavel direta se existir)
valor_mde <- tryCatch({
  if (exists("total_despesas_mde")) {
    as.numeric(total_despesas_mde)
  } else {
    # Fallback para resumo_aplicacao
    texto <- resumo_aplicacao %>% filter(grepl("Total Despesas MDE|Total Aplicado", Item)) %>% pull(Valor)
    if (length(texto) == 0) return(NA_real_)
    as.numeric(gsub("[^0-9.-]", "", texto[1]))
  }
}, error = function(e) NA_real_)

# MDE - Minimo (18% RLI) - usar variavel direta
valor_mde_minimo <- tryCatch({
  if (exists("rli_atual")) {
    as.numeric(rli_atual)
  } else {
    texto <- resumo_aplicacao %>% filter(grepl("18%|Base de C√°lculo|RLI", Item)) %>% pull(Valor)
    if (length(texto) == 0) return(NA_real_)
    as.numeric(gsub("[^0-9.-]", "", texto[1]))
  }
}, error = function(e) NA_real_)

# FUNDEB - Complementacao (100%)
valor_fundeb <- tryCatch({
  if (exists("complementacao_fundeb")) {
    as.numeric(complementacao_fundeb)
  } else {
    texto <- resumo_aplicacao %>% filter(grepl("Complementa√ß√£o FUNDEB|FUNDEB", Item)) %>% pull(Valor)
    if (length(texto) == 0) return(NA_real_)
    as.numeric(gsub("[^0-9.-]", "", texto[1]))
  }
}, error = function(e) NA_real_)

# Balanco Orcamentario - Receitas
# Previsao Inicial (codigo 1)
valor_bo_prev_ini <- tryCatch({
  dados_receita %>% 
    filter(item_informacao_codigo == "1") %>% 
    summarise(v = sum(saldo_r_item_informacao, na.rm = TRUE)) %>% 
    pull(v)
}, error = function(e) NA_real_)

# Previsao Atualizada = Previsao Inicial (mesmo valor no TG)
valor_bo_prev_atu <- valor_bo_prev_ini

# Receitas Realizadas (codigo 5)
valor_bo_rec_rea <- tryCatch({
  dados_receita %>% 
    filter(item_informacao_codigo == "5") %>% 
    summarise(v = sum(saldo_r_item_informacao, na.rm = TRUE)) %>% 
    pull(v)
}, error = function(e) NA_real_)

# Saldos de Exercicios Anteriores (Superavit Financeiro + Excesso Arrecadacao + Creditos Cancelados)
valor_bo_saldos_ant <- tryCatch({
  rgf_a02_balancete %>% 
    filter(
      startsWith(conta_contabil_numero, "5221"),
      conta_contabil_numero %in% c("522190101", "522190201", "522130300", 
                                    "522130200", "522130100", "522190109", "522190209")
    ) %>% 
    summarise(v = sum(saldo_r_conta_contabil, na.rm = TRUE)) %>% 
    pull(v)
}, error = function(e) NA_real_)

# Balanco Orcamentario - Despesas
# Dotacao Inicial (codigo 9)
valor_bo_dot_ini <- tryCatch({
  dados_despesa %>% 
    filter(item_informacao_codigo == "9") %>% 
    summarise(v = sum(saldo_r_item_informacao, na.rm = TRUE)) %>% 
    pull(v)
}, error = function(e) NA_real_)

# Dotacao Atualizada (codigo 13)
valor_bo_dot_atu <- tryCatch({
  dados_despesa %>% 
    filter(item_informacao_codigo == "13") %>% 
    summarise(v = sum(saldo_r_item_informacao, na.rm = TRUE)) %>% 
    pull(v)
}, error = function(e) NA_real_)

# Despesas Empenhadas (codigo 23)
valor_bo_emp <- tryCatch({
  dados_despesa %>% 
    filter(item_informacao_codigo == "23") %>% 
    summarise(v = sum(saldo_r_item_informacao, na.rm = TRUE)) %>% 
    pull(v)
}, error = function(e) NA_real_)

# Despesas Liquidadas (codigo 25)
valor_bo_liq <- tryCatch({
  dados_despesa %>% 
    filter(item_informacao_codigo == "25") %>% 
    summarise(v = sum(saldo_r_item_informacao, na.rm = TRUE)) %>% 
    pull(v)
}, error = function(e) NA_real_)

# Despesas Pagas (codigo 28) - APENAS exercicio, n√£o RAP
valor_bo_pag <- tryCatch({
  dados_despesa %>% 
    filter(item_informacao_codigo == "28") %>% 
    summarise(v = sum(saldo_r_item_informacao, na.rm = TRUE)) %>% 
    pull(v)
}, error = function(e) NA_real_)

# Superavit Orcamentario = Receitas Realizadas - Despesas Liquidadas
valor_bo_superavit <- tryCatch({
  valor_bo_rec_rea - valor_bo_liq
}, error = function(e) NA_real_)

# Despesas por Funcao (exceto refinanciamento) - usar minusculas
valor_funcao_emp <- tryCatch({
  dados_despesa %>% 
    filter(item_informacao_codigo == "23", refinanciamento == "nao") %>% 
    summarise(v = sum(saldo_r_item_informacao, na.rm = TRUE)) %>% 
    pull(v)
}, error = function(e) NA_real_)

valor_funcao_liq <- tryCatch({
  dados_despesa %>% 
    filter(item_informacao_codigo == "25", refinanciamento == "nao") %>% 
    summarise(v = sum(saldo_r_item_informacao, na.rm = TRUE)) %>% 
    pull(v)
}, error = function(e) NA_real_)

# Restos a Pagar - usar dados_rp_anexo_07
# RP Processados - Inscricao (soma dos dois itens de inscritos)
valor_rpp_insc_calc <- tryCatch({
  dados_rp_anexo_07 %>%
    filter(mes_lancamento == mes_filtro,
           item_informacao_nome %in% c("RP Processados Inscritos em 31 de Dezembro do Ano Anterior",
                                       "RP Processados Inscritos em Exerc√≠cios Anteriores")) %>%
    summarise(v = sum(saldo_r_item_informacao, na.rm = TRUE)) %>%
    pull(v)
}, error = function(e) NA_real_)

# RP Processados - Cancelamento
valor_rpp_cancel <- tryCatch({
  dados_rp_anexo_07 %>%
    filter(mes_lancamento == mes_filtro,
           item_informacao_nome == "RP Processados Cancelados") %>%
    summarise(v = sum(saldo_r_item_informacao, na.rm = TRUE)) %>%
    pull(v)
}, error = function(e) NA_real_)

# RP Processados - Pagamento
valor_rpp_pag <- tryCatch({
  dados_rp_anexo_07 %>%
    filter(mes_lancamento == mes_filtro,
           item_informacao_nome == "RP Processados Pagos") %>%
    summarise(v = sum(saldo_r_item_informacao, na.rm = TRUE)) %>%
    pull(v)
}, error = function(e) NA_real_)

# RP Processados - Saldo
valor_rpp_saldo <- tryCatch({
  dados_rp_anexo_07 %>%
    filter(mes_lancamento == mes_filtro,
           item_informacao_nome == "RP Processados a Pagar (saldo a pagar)") %>%
    summarise(v = sum(saldo_r_item_informacao, na.rm = TRUE)) %>%
    pull(v)
}, error = function(e) NA_real_)

# RPNP - Inscricao (soma dos dois itens de inscritos)
valor_rpnp_insc_calc <- tryCatch({
  dados_rp_anexo_07 %>%
    filter(mes_lancamento == mes_filtro,
           item_informacao_nome %in% c("RPNP Inscritos em 31 de Dezembro do Ano Anterior",
                                       "RPNP Inscritos em Exerc√≠cios Anteriores")) %>%
    summarise(v = sum(saldo_r_item_informacao, na.rm = TRUE)) %>%
    pull(v)
}, error = function(e) NA_real_)

# RPNP - Cancelamento
valor_rpnp_cancel <- tryCatch({
  dados_rp_anexo_07 %>%
    filter(mes_lancamento == mes_filtro,
           item_informacao_nome == "RPNP Cancelados") %>%
    summarise(v = sum(saldo_r_item_informacao, na.rm = TRUE)) %>%
    pull(v)
}, error = function(e) NA_real_)

# RPNP - Pagamento
valor_rpnp_pag <- tryCatch({
  dados_rp_anexo_07 %>%
    filter(mes_lancamento == mes_filtro,
           item_informacao_nome == "RPNP Pagos") %>%
    summarise(v = sum(saldo_r_item_informacao, na.rm = TRUE)) %>%
    pull(v)
}, error = function(e) NA_real_)

# RPNP - Saldo
valor_rpnp_saldo <- tryCatch({
  dados_rp_anexo_07 %>%
    filter(mes_lancamento == mes_filtro,
           item_informacao_nome == "RPNP a Pagar (saldo a pagar)") %>%
    summarise(v = sum(saldo_r_item_informacao, na.rm = TRUE)) %>%
    pull(v)
}, error = function(e) NA_real_)

# ASPS - Valor Aplicado (usar total_despesas_computadas se existir)
valor_asps <- tryCatch({
  if (exists("total_despesas_computadas")) total_despesas_computadas else NA_real_
}, error = function(e) NA_real_)

# ASPS - Minimo (15% da RCL)
valor_asps_minimo <- tryCatch({
  if (exists("minimo_saude")) {
    if (is.data.frame(minimo_saude)) {
      (minimo_saude$receitas - minimo_saude$deducoes + minimo_saude$rp_cancelado) * 0.15
    } else {
      as.numeric(minimo_saude)
    }
  } else {
    NA_real_
  }
}, error = function(e) NA_real_)

# Montar dataframe do sistema RREO
sistema_rreo <- tibble(
  item = c(
    "bo_previsao_inicial", "bo_previsao_atualizada", "bo_receitas_realizadas", "bo_saldos_anteriores",
    "bo_dotacao_inicial", "bo_dotacao_atualizada", "bo_despesas_empenhadas", "bo_despesas_liquidadas", 
    "bo_despesas_pagas", "bo_superavit",
    "funcao_empenhadas", "funcao_liquidadas",
    "rcl",
    "rgps_receitas", "rgps_despesas", "rgps_resultado",
    "rpps_receitas", "rpps_despesas", "rpps_resultado",
    "militar_receitas", "militar_despesas", "militar_resultado",
    "fcdf_receitas", "fcdf_despesas", "fcdf_resultado",
    "resultado_nominal", "resultado_primario",
    "rpp_inscricao", "rpp_cancelamento", "rpp_pagamento", "rpp_saldo",
    "rpnp_inscricao", "rpnp_cancelamento", "rpnp_pagamento", "rpnp_saldo",
    "mde_aplicado", "mde_minimo", "fundeb_complementacao",
    "asps_aplicado", "asps_minimo"
  ),
  valor = c(
    valor_bo_prev_ini, valor_bo_prev_atu, valor_bo_rec_rea, valor_bo_saldos_ant,
    valor_bo_dot_ini, valor_bo_dot_atu, valor_bo_emp, valor_bo_liq,
    valor_bo_pag, valor_bo_superavit,
    valor_funcao_emp, valor_funcao_liq,
    valor_rcl,
    valor_rgps_rec, valor_rgps_desp, valor_rgps_res,
    valor_rpps_rec, valor_rpps_desp, valor_rpps_res,
    valor_mil_rec, valor_mil_desp, valor_mil_res,
    valor_fcdf_rec, valor_fcdf_desp, valor_fcdf_res,
    valor_res_nominal, valor_res_prim,
    valor_rpp_insc_calc, valor_rpp_cancel, valor_rpp_pag, valor_rpp_saldo,
    valor_rpnp_insc_calc, valor_rpnp_cancel, valor_rpnp_pag, valor_rpnp_saldo,
    valor_mde, valor_mde_minimo, valor_fundeb,
    valor_asps, valor_asps_minimo
  )
) %>%
  mutate(valor_milhar = valor / 1000)

# LER VALORES OFICIAIS RREO
arquivo_rreo_a14 <- str_c(mes_pasta, "Anexo 14 - Simplificado.xlsm")
cat(sprintf("Lendo arquivo oficial: %s\n", arquivo_rreo_a14))

rreo_oficial <- mapa_rreo_a14 %>%
  rowwise() %>%
  mutate(valor_oficial = as.numeric(ler_celula(arquivo_rreo_a14, celula))) %>%
  ungroup()

# COMPARAR VALORES RREO
comparacao_rreo <- rreo_oficial %>%
  left_join(sistema_rreo %>% select(item, sistema = valor_milhar), by = "item") %>%
  mutate(
    diferenca = sistema - valor_oficial,
    dif_pct = ifelse(!is.na(valor_oficial) & valor_oficial != 0,
                     (diferenca / abs(valor_oficial)) * 100, NA_real_),
    status = case_when(
      is.na(valor_oficial) ~ "Sem oficial",
      is.na(sistema) ~ "Sem sistema",
      abs(diferenca) < 1 ~ "OK",
      abs(dif_pct) < 0.1 ~ "OK",
      abs(dif_pct) < 1 ~ "Verificar",
      TRUE ~ "DIVERGENTE"
    )
  ) %>%
  select(item, descricao, fonte, celula, oficial = valor_oficial, sistema, diferenca, dif_pct, status)

# EXIBIR RREO
cat("\n--- VALIDACAO RREO ANEXO 14 ---\n")
resumo_rreo <- comparacao_rreo %>% count(status)
for (i in 1:nrow(resumo_rreo)) cat(sprintf("  %s: %d\n", resumo_rreo$status[i], resumo_rreo$n[i]))


```

```{r}
#| column: screen 
datatable(
  comparacao_rreo %>%
    mutate(
      oficial = ifelse(is.na(oficial), "-", format(round(oficial, 0), big.mark = ".", decimal.mark = ",")),
      sistema = ifelse(is.na(sistema), "-", format(round(sistema, 0), big.mark = ".", decimal.mark = ",")),
      diferenca = ifelse(is.na(diferenca), "-", format(round(diferenca, 0), big.mark = ".", decimal.mark = ",")),
      dif_pct = ifelse(is.na(dif_pct), "-", paste0(format(round(dif_pct, 1), nsmall = 1), "%"))
    ),
  caption = "RREO Anexo 14 - Sistema vs Oficial (R$ milhares)",
  options = list(pageLength = 50, dom = 't',
    columnDefs = list(list(className = 'dt-right', targets = c(4, 5, 6, 7)))),
  rownames = FALSE
) %>%
  formatStyle('status', backgroundColor = styleEqual(
    c("OK", "Verificar", "DIVERGENTE", "Sem oficial", "Sem sistema"),
    c("#90EE90", "#FFD700", "#FF6B6B", "#D3D3D3", "#D3D3D3")
  ))
```

```{r}
# Validacao RGF A06 - Sistema vs Oficial (R$ milhares)

#| echo: true
#| output: true
#| eval: false

# # MAPEAMENTO RGF A06
# mapa_rgf_a06 <- tribble(
#   ~item, ~celula, ~descricao, ~fonte,
#   # RCL
#   "rcl",                   "B10", "Receita Corrente Liquida", "RGF",
#   
#   # Pessoal - Executivo
#   "dtp_executivo",         "B15", "DTP - Poder Executivo", "A01",
#   "limite_max_exec",       "B16", "Limite Maximo - Executivo", "A01",
#   "limite_prud_exec",      "B17", "Limite Prudencial - Executivo", "A01",
#   "limite_alerta_exec",    "B18", "Limite Alerta - Executivo", "A01",
#   
#   # Pessoal - Amapa
#   "dtp_amapa",             "B20", "DTP - Amapa", "A01",
#   "limite_max_ap",         "B21", "Limite Maximo - Amapa", "A01",
#   "limite_prud_ap",        "B22", "Limite Prudencial - Amapa", "A01",
#   "limite_alerta_ap",      "B23", "Limite Alerta - Amapa", "A01",
#   
#   # Pessoal - Roraima
#   "dtp_roraima",           "B25", "DTP - Roraima", "A01",
#   "limite_max_rr",         "B26", "Limite Maximo - Roraima", "A01",
#   "limite_prud_rr",        "B27", "Limite Prudencial - Roraima", "A01",
#   "limite_alerta_rr",      "B28", "Limite Alerta - Roraima", "A01",
#   
#   # Pessoal - DF
#   "dtp_df",                "B30", "DTP - Distrito Federal", "A01",
#   "limite_max_df",         "B31", "Limite Maximo - DF", "A01",
#   "limite_prud_df",        "B32", "Limite Prudencial - DF", "A01",
#   "limite_alerta_df",      "B33", "Limite Alerta - DF", "A01",
#   
#   # Divida (Anexo 2)
#   "dcl",                   "B36", "Divida Consolidada Liquida", "A02",
#   "limite_dcl",            "B37", "Limite DCL (Resolucao SF)", "A02",
#   
#   # Garantias (Anexo 3)
#   "garantias",             "B40", "Total das Garantias", "A03",
#   "limite_garantias",      "B41", "Limite Garantias", "A03",
#   
#   # Operacoes de Credito (Anexo 4)
#   "op_credito",            "B44", "Operacoes de Credito", "A04",
#   "limite_op_credito",     "B45", "Limite Op. Credito", "A04",
#   
#   # Disponibilidade (Anexo 5)
#   "rpnp_exercicio",        "B52", "RPNP do Exercicio", "A05",
#   "disponibilidade_caixa", "C52", "Disponibilidade Caixa Liquida", "A05"
# )
# 
# # COLETAR VALORES DO SISTEMA - RGF
# cat("Coletando valores do sistema RGF...\n")
# 
# # RCL para RGF (mesma do RREO ou especifica)
# valor_rcl_rgf <- tryCatch({
#   res <- sum(rcl_12_meses$resultado, na.rm = TRUE)
#   if (length(res) == 0) NA_real_ else as.numeric(res[1])
# }, error = function(e) NA_real_)
# 
# # DTP Executivo (ajustar conforme sua variavel)
# valor_dtp_exec <- tryCatch({
#   if (exists("dtp_executivo")) dtp_executivo else NA_real_
# }, error = function(e) NA_real_)
# 
# # DTP Amapa
# valor_dtp_ap <- tryCatch({
#   if (exists("dtp_amapa")) dtp_amapa else NA_real_
# }, error = function(e) NA_real_)
# 
# # DTP Roraima
# valor_dtp_rr <- tryCatch({
#   if (exists("dtp_roraima")) dtp_roraima else NA_real_
# }, error = function(e) NA_real_)
# 
# # DTP DF
# valor_dtp_df <- tryCatch({
#   if (exists("dtp_df")) dtp_df else NA_real_
# }, error = function(e) NA_real_)
# 
# # DCL
# valor_dcl_rgf <- tryCatch({
#   if (exists("valor_dcl")) valor_dcl else NA_real_
# }, error = function(e) NA_real_)
# 
# # Garantias
# valor_garantias <- tryCatch({
#   if (exists("total_garantias")) total_garantias else NA_real_
# }, error = function(e) NA_real_)
# 
# # Operacoes de Credito
# valor_op_cred <- tryCatch({
#   if (exists("op_credito_total")) op_credito_total else NA_real_
# }, error = function(e) NA_real_)
# 
# # Limites (calcular a partir da RCL)
# rcl_rgf <- valor_rcl_rgf / 1000  # em milhares
# limite_max_exec <- rcl_rgf * 0.379  # 37,9% para Executivo
# limite_prud_exec <- limite_max_exec * 0.95
# limite_alerta_exec <- limite_max_exec * 0.90
# 
# # Montar dataframe do sistema RGF
# sistema_rgf <- tibble(
#   item = c(
#     "rcl",
#     "dtp_executivo", "limite_max_exec", "limite_prud_exec", "limite_alerta_exec",
#     "dtp_amapa", "limite_max_ap", "limite_prud_ap", "limite_alerta_ap",
#     "dtp_roraima", "limite_max_rr", "limite_prud_rr", "limite_alerta_rr",
#     "dtp_df", "limite_max_df", "limite_prud_df", "limite_alerta_df",
#     "dcl", "limite_dcl",
#     "garantias", "limite_garantias",
#     "op_credito", "limite_op_credito",
#     "rpnp_exercicio", "disponibilidade_caixa"
#   ),
#   valor = c(
#     valor_rcl_rgf,
#     valor_dtp_exec, NA_real_, NA_real_, NA_real_,
#     valor_dtp_ap, NA_real_, NA_real_, NA_real_,
#     valor_dtp_rr, NA_real_, NA_real_, NA_real_,
#     valor_dtp_df, NA_real_, NA_real_, NA_real_,
#     valor_dcl_rgf, NA_real_,
#     valor_garantias, NA_real_,
#     valor_op_cred, NA_real_,
#     NA_real_, NA_real_
#   )
# ) %>%
#   mutate(valor_milhar = valor / 1000)
# 
# # LER VALORES OFICIAIS RGF
# arquivo_rgf_a06 <- str_c(mes_pasta, "rgf_a06_oficial.xlsx")
# 
# # Verificar se arquivo existe
# if (file.exists(arquivo_rgf_a06)) {
#   cat(sprintf("Lendo arquivo oficial: %s\n", arquivo_rgf_a06))
#   
#   rgf_oficial <- mapa_rgf_a06 %>%
#     rowwise() %>%
#     mutate(valor_oficial = as.numeric(ler_celula(arquivo_rgf_a06, celula))) %>%
#     ungroup()
#   
#   # COMPARAR VALORES RGF
#   comparacao_rgf <- rgf_oficial %>%
#     left_join(sistema_rgf %>% select(item, sistema = valor_milhar), by = "item") %>%
#     mutate(
#       diferenca = sistema - valor_oficial,
#       dif_pct = ifelse(!is.na(valor_oficial) & valor_oficial != 0,
#                        (diferenca / abs(valor_oficial)) * 100, NA_real_),
#       status = case_when(
#         is.na(valor_oficial) ~ "Sem oficial",
#         is.na(sistema) ~ "Sem sistema",
#         abs(diferenca) < 1 ~ "OK",
#         abs(dif_pct) < 0.1 ~ "OK",
#         abs(dif_pct) < 1 ~ "Verificar",
#         TRUE ~ "DIVERGENTE"
#       )
#     ) %>%
#     select(item, descricao, fonte, celula, oficial = valor_oficial, sistema, diferenca, dif_pct, status)
#   
#   # EXIBIR RGF
#   cat("\n--- VALIDACAO RGF ANEXO 06 ---\n")
#   resumo_rgf <- comparacao_rgf %>% count(status)
#   for (i in 1:nrow(resumo_rgf)) cat(sprintf("  %s: %d\n", resumo_rgf$status[i], resumo_rgf$n[i]))
#   
#   datatable(
#     comparacao_rgf %>%
#       mutate(
#         oficial = ifelse(is.na(oficial), "-", format(round(oficial, 0), big.mark = ".", decimal.mark = ",")),
#         sistema = ifelse(is.na(sistema), "-", format(round(sistema, 0), big.mark = ".", decimal.mark = ",")),
#         diferenca = ifelse(is.na(diferenca), "-", format(round(diferenca, 0), big.mark = ".", decimal.mark = ",")),
#         dif_pct = ifelse(is.na(dif_pct), "-", paste0(format(round(dif_pct, 1), nsmall = 1), "%"))
#       ),
#     caption = "RGF Anexo 06 - Sistema vs Oficial (R$ milhares)",
#     options = list(pageLength = 30, dom = 't',
#       columnDefs = list(list(className = 'dt-right', targets = c(4, 5, 6, 7)))),
#     rownames = FALSE
#   ) %>%
#     formatStyle('status', backgroundColor = styleEqual(
#       c("OK", "Verificar", "DIVERGENTE", "Sem oficial", "Sem sistema"),
#       c("#90EE90", "#FFD700", "#FF6B6B", "#D3D3D3", "#D3D3D3")
#     ))
# } else {
#   cat(sprintf("AVISO: Arquivo RGF nao encontrado: %s\n", arquivo_rgf_a06))
#   cat("Pulando validacao do RGF.\n")
# }
```

```{r}
rgf_a02_balancete %>% filter(startsWith( conta_contabil_numero, "5221"), conta_contabil_numero %in% c(522190101,522190201 , 522130300, 522130200, 522130100, 522190109, 522190209 )) %>% group_by(conta_contabil_nome, conta_contabil_numero) %>% summarise(saldo_r_conta_contabil = sum(saldo_r_conta_contabil))


rgf_a02_balancete %>% filter(startsWith( conta_contabil_numero, "5221"), conta_contabil_numero %in% c(522190101,522190201 , 522130300, 522130200, 522130100, 522190109, 522190209 ))  %>% summarise(saldo_r_conta_contabil = sum(saldo_r_conta_contabil))
```
