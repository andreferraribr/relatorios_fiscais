---
title: "üìä RREO & RGF - Relat√≥rios Fiscais"
subtitle: "Sistema Unificado de Relat√≥rios Fiscais do Governo Federal"
author: "Governo Federal"
date: today
execute:
  warning: false
  message: false
  cache: false
  
format:
  html:
    theme: cosmo
    toc: true
    toc-depth: 3
    number-sections: true
    code-fold: true
    code-summary: "Mostrar c√≥digo"
    fig-width: 10
    fig-height: 6
    tbl-cap-location: top
    self-contained: true
---

# üìö Carregamento de Bibliotecas e Configura√ß√µes {#sec-setup}

```{r setup}
#| include: false


# Bibliotecas principais
library(dplyr)
library(tidyr)
library(stringr)
library(readxl)
library(janitor)
library(purrr)
library(forcats)
library(DT)
library(knitr)
library(kableExtra)
library(readr)
library(scales)
library(lubridate)
library(rlang)

Sys.setlocale("LC_TIME", "pt_BR.UTF-8")

# Configura√ß√µes globais
options(OutDec = ".")
options(scipen = 999)

# Configura√ß√µes DT
options(DT.options = 
  list(
    pageLength = 50,
    lengthMenu = c(5, 10, 25, 50, 100),
    language = list(url = '//cdn.datatables.net/plug-ins/1.10.11/i18n/Portuguese.json')
  )
)

# ============================================================================
# ‚ö° OTIMIZA√á√ïES DE PERFORMANCE E PARALELIZA√á√ÉO
# ============================================================================

# Carregar bibliotecas de paraleliza√ß√£o
suppressPackageStartupMessages({
  library(furrr)      # Para processamento paralelo com purrr
  library(future)     # Backend de paraleliza√ß√£o
  library(data.table) # Para opera√ß√µes ultrarr√°pidas em dados grandes
})

# Detectar recursos dispon√≠veis
cores_disponiveis <- parallel::detectCores()

# Obter mem√≥ria total (compat√≠vel com Windows)
memoria_info <- tryCatch({
  resultado <- system("wmic computersystem get totalphysicalmemory", intern = TRUE)
  as.numeric(gsub("[^0-9]", "", resultado[2])) / (1024^3)
}, error = function(e) {
  32.0  # Fallback
})

cat("\n")
cat("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n")
cat("‚ïë        ‚ö° OTIMIZA√á√ÉO DE PERFORMANCE - SISTEMA ATIVADO        ‚ïë\n")
cat("‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£\n")
cat(sprintf("‚ïë üñ•Ô∏è  CPU: %d cores dispon√≠veis%s‚ïë\n", 
    cores_disponiveis, 
    strrep(" ", 44 - nchar(as.character(cores_disponiveis)))))
cat(sprintf("‚ïë üíæ RAM: %.1f GB%s‚ïë\n", 
    memoria_info, 
    strrep(" ", 48 - nchar(sprintf("%.1f GB", memoria_info)))))

# Configurar paraleliza√ß√£o (usar at√© 10 cores, deixar 2 para o sistema)
cores_usar <- min(10, max(1, cores_disponiveis - 2))
cat(sprintf("‚ïë ‚öôÔ∏è  Cores para processamento paralelo: %d%s‚ïë\n", 
    cores_usar,
    strrep(" ", 29 - nchar(as.character(cores_usar)))))

# Configurar backend de paraleliza√ß√£o
plan(multisession, workers = cores_usar)

# Desabilitar paraleliza√ß√£o autom√°tica do data.table para evitar conflitos
setDTthreads(1)

cat("‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£\n")
cat("‚ïë ‚úÖ Paraleliza√ß√£o configurada e ativa                        ‚ïë\n")
cat("‚ïë ‚úÖ Otimiza√ß√µes de mem√≥ria ativadas                          ‚ïë\n")
cat("‚ïë ‚úÖ Backend: future::multisession                            ‚ïë\n")
cat("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n")
cat("\n")

# ============================================================================
# FUN√á√ïES OTIMIZADAS PARA IMPORTA√á√ÉO PARALELA
# ============================================================================

# ============================================================================
# üîß CORRE√á√ÉO: Fun√ß√£o importar_excel_paralelo ATUALIZADA
# ============================================================================
# SUBSTITUA a fun√ß√£o antiga no chunk {r setup} por esta vers√£o

importar_excel_paralelo <- function(arquivos, skip = 5, .progress = TRUE) {
  if (length(arquivos) == 0) {
    warning("Nenhum arquivo fornecido")
    return(data.frame())
  }
  
  cat(sprintf("üì• Importando %d arquivos em paralelo...\n", length(arquivos)))
  
  resultado <- future_map_dfr(
    arquivos, 
    function(arq) {
      df <- read_excel(arq, skip = skip, col_types = "text") %>%
        clean_names()
      
      # ============================================================================
      # ‚úÖ CONVERS√ÉO AUTOM√ÅTICA DE COLUNAS NUM√âRICAS
      # ============================================================================
      # Padr√µes de nomes de colunas que devem ser num√©ricas
      numeric_patterns <- c(
        "^saldo_r",           # saldo_r_item_informacao, saldo_r_conta_contabil
        "^movim.*_r",         # movim_liquido_r_item_informacao
        "^valor",             # valor_lancado, valor_empenhado, valor_liquidado
        "_valor$",            # qualquer_coisa_valor
        "_saldo$",            # qualquer_coisa_saldo
        "saldo.*atual",       # saldo_dotacao_atual
        "mes_lancamento"      # mes_lancamento
      )
      
      # Encontrar colunas que correspondem aos padr√µes
      cols_numericas <- names(df)[str_detect(names(df), 
                                              paste(numeric_patterns, collapse = "|"))]
      
      # Converter para num√©rico (com suppressWarnings para NAs esperados)
      if (length(cols_numericas) > 0) {
        df <- df %>%
          mutate(across(all_of(cols_numericas), ~ suppressWarnings(as.numeric(.))))
      }
      
      return(df)
    },
    .progress = .progress,
    .options = furrr_options(seed = TRUE)
  )
  
  cat(sprintf("‚úÖ Importa√ß√£o conclu√≠da: %s registros\n", 
              format(nrow(resultado), big.mark = ".", decimal.mark = ",")))
  
  # Mostrar quais colunas foram convertidas
  cols_convertidas <- names(resultado)[sapply(resultado, is.numeric)]
  if (length(cols_convertidas) > 0) {
    cat(sprintf("   üìä Colunas num√©ricas: %d\n", length(cols_convertidas)))
  }
  
  return(resultado)
}

cat("‚úÖ Fun√ß√£o importar_excel_paralelo() ATUALIZADA carregada!\n\n")



# Operadores customizados
`%notin%` <- Negate(`%in%`)
`%||%` <- function(x, y) if(is.null(x) || length(x) == 0 || is.na(x)) y else x

formatar_numero <- function(x) {
  format(x, big.mark = ".", decimal.mark = ",", scientific = FALSE, nsmall = 2)
}

print("‚úÖ Bibliotecas carregadas com sucesso!")
```

## üîß Vari√°veis Globais

```{r variaveis_globais}
# Filtro principal do m√™s
mes_filtro <- "202511"

mes_pasta <- str_c("data/",mes_filtro,"/")

print(paste("üìÖ M√™s de refer√™ncia definido:", mes_filtro))
```

# üì• Importa√ß√£o dos Dados {#sec-dados}

## üßæ Dados de Receita

```{r dados_receita}
#| echo: true
#| eval: true
#| include: false

# ============================================================================
# ‚ö° VERS√ÉO OTIMIZADA - IMPORTA√á√ÉO PARALELA
# ============================================================================

# Definir arquivos a importar
arquivos_receita <- c(
  str_c(mes_pasta, "tg_receita_liquida.xlsx"),
  str_c(mes_pasta, "tg_receita_previsao.xlsx")
)

cat("üì• Importando dados de receita em paralelo...\n")

# Importar ambos os arquivos simultaneamente
dados_receita <- importar_excel_paralelo(
  arquivos = arquivos_receita, 
  skip = 5, 
  .progress = TRUE
) %>%
  # Filtrar e transformar uma √∫nica vez
  filter(orgao_uge_orcam_fiscal_s_n == "PERTENCE") %>%
  mutate(
    # Convers√£o de data
    mes_lancamento = as.numeric(mes_lancamento),
    data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1),
    
    # Vari√°veis derivadas
    tipo_modalidade = ifelse(
      nre1_categoria_economica_codigo %in% c(7, 8), 
      "intra", 
      "exceto intra"
    ),
    
    refinanciamento = ifelse(
      natureza_receita_codigo_completo %in% c(81110201, 21110201, 21210201), 
      "sim", 
      "nao"
    )
  )

cat(sprintf("‚úÖ Dados de receita carregados: %s registros\n", 
            format(nrow(dados_receita), big.mark = ".", decimal.mark = ",")))
cat(sprintf("   ‚Ä¢ Mem√≥ria utilizada: %.1f MB\n", 
            object.size(dados_receita) / 1024^2))
```

## üí∞ Dados de Despesa

```{r dados_despesa_rreo}
#| echo: true


#| include: false

# ============================================================================
# ‚ö° VERS√ÉO OTIMIZADA - IMPORTA√á√ÉO PARALELA
# ============================================================================

# Buscar todos os arquivos de despesa
arq_despesa <- list.files(
  path = mes_pasta, 
  pattern = 'tg_despesa', 
  full.names = TRUE
)

cat(sprintf("üì• Importando %d arquivos de despesa em paralelo...\n", length(arq_despesa)))

# Importar todos os arquivos simultaneamente
dados_despesa <- importar_excel_paralelo(
  arquivos = arq_despesa, 
  skip = 5, 
  .progress = TRUE
) %>%
  # Filtrar e transformar
  filter(orgao_uge_orcam_fiscal_s_n == "PERTENCE") %>%
  mutate(
    # Converter colunas num√©ricas espec√≠ficas
    across(contains("saldo"), as.numeric),
    across(contains("valor"), as.numeric),
    mes_lancamento = as.numeric(mes_lancamento),
    
    # Convers√£o de data
    data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1),
    
    # Vari√°veis derivadas - tipo_modalidade
    tipo_modalidade = ifelse(
      modalidade_aplicacao_codigo == 91,
      "intra",
      "exceto intra"
    ),
    
    # Vari√°veis derivadas - refinanciamento
    refinanciamento = case_when(
      grupo_despesa_codigo_grupo == 6 &
        elemento_despesa_codigo %in% c(76, 77) &
        subfuncao_governo_codigo %in% c(841, 842, 843, 844, 846) &
        fonte_recursos_codigo == "443" ~ "sim",
      !(grupo_despesa_codigo_grupo == 6 &
        elemento_despesa_codigo %in% c(76, 77) &
        subfuncao_governo_codigo %in% c(841, 842, 843, 844, 846) &
        fonte_recursos_codigo == "443") ~ "nao",
      TRUE ~ "escape"
    ),
    
    # Vari√°veis derivadas - poder
    poder = case_when(
      orgao_uge_orgao_maximo_codigo %in% c(59000) ~ "MINIST√âRIO P√öBLICO DA UNI√ÉO",
      orgao_uge_orgao_maximo_codigo %in% c(29000) ~ "DEFENSORIA P√öBLICA",
      TRUE ~ orgao_uge_poder_nome
    ),
    
    # Vari√°veis derivadas - transferencia
    transferencia = ifelse(
      modalidade_aplicacao_codigo %in% c('30', '31', '32', '35', '36', '40', '41', '42', '45', '46'), 
      "_transferencia", 
      "aplicacao_direta"
    )
  )

cat(sprintf("‚úÖ Dados de despesa carregados: %s registros\n", 
            format(nrow(dados_despesa), big.mark = ".", decimal.mark = ",")))
cat(sprintf("   ‚Ä¢ Arquivos processados: %d\n", length(arq_despesa)))
cat(sprintf("   ‚Ä¢ Mem√≥ria utilizada: %.1f MB\n", 
            object.size(dados_despesa) / 1024^2))

# Estat√≠sticas r√°pidas
cat("\nüìä Resumo por tipo_modalidade:\n")
print(dados_despesa %>% count(tipo_modalidade, sort = TRUE))

cat("\nüìä Resumo por refinanciamento:\n")
print(dados_despesa %>% count(refinanciamento, sort = TRUE))
```

## üìã Dados de Restos a Pagar

```{r dados_rp}
#| echo: true
#| include: false

# ============================================================================
# ‚ö° VERS√ÉO OTIMIZADA - IMPORTA√á√ÉO PARALELA MANTENDO ESTRUTURAS SEPARADAS
# ============================================================================

# Definir lista de arquivos a importar
arquivos_rp <- list(
  anexo_07 = str_c(mes_pasta, "rreo_a07_rp.xlsx"),
  anexo_12 = str_c(mes_pasta, "rreo_a12_rp.xlsx"),
  anexo_08 = str_c(mes_pasta, "rreo_a08_rp.xlsx"),
  anexo_03_rcl = str_c(mes_pasta, "rreo_a03_rp.xlsx")
)

cat(sprintf("üì• Importando %d arquivos de RP em paralelo...\n", length(arquivos_rp)))

# Importar todos simultaneamente, cada um mant√©m sua estrutura pr√≥pria
tempo_inicio <- Sys.time()

dados_rp_lista <- future_map(
  arquivos_rp,
  function(arquivo) {
    read_excel(arquivo, skip = 5) %>%
      clean_names() %>%
      mutate(
        mes_lancamento = as.numeric(mes_lancamento),
        data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1)
      )
  },
  .progress = TRUE,
  .options = furrr_options(seed = TRUE)
)

tempo_fim <- Sys.time()

# Extrair cada arquivo para sua vari√°vel espec√≠fica
# Anexo 07 precisa de transforma√ß√µes adicionais
dados_rp_anexo_07 <- dados_rp_lista$anexo_07 %>%
  mutate(
    tipo_modalidade = ifelse(
      modalidade_aplicacao_codigo == 91, 
      "intra", 
      "exceto intra"
    ),
    poder = case_when(
      orgao_uge_orgao_maximo_codigo %in% c(59000) ~ "MINIST√âRIO P√öBLICO DA UNI√ÉO",
      orgao_uge_orgao_maximo_codigo %in% c(29000) ~ "DEFENSORIA P√öBLICA",
      TRUE ~ orgao_uge_poder_nome
    )
  )

# Outros anexos mant√™m estrutura b√°sica
dados_rp_anexo_12 <- dados_rp_lista$anexo_12
dados_rp_anexo_08 <- dados_rp_lista$anexo_08
dados_rp_anexo_03_rcl <- dados_rp_lista$anexo_03_rcl

# Relat√≥rio de importa√ß√£o
cat("\n‚úÖ Dados de Restos a Pagar carregados:\n")
cat(sprintf("   ‚Ä¢ Anexo 07: %s registros (%.1f MB)\n", 
            format(nrow(dados_rp_anexo_07), big.mark = ".", decimal.mark = ","),
            object.size(dados_rp_anexo_07) / 1024^2))
cat(sprintf("   ‚Ä¢ Anexo 12: %s registros (%.1f MB)\n", 
            format(nrow(dados_rp_anexo_12), big.mark = ".", decimal.mark = ","),
            object.size(dados_rp_anexo_12) / 1024^2))
cat(sprintf("   ‚Ä¢ Anexo 08: %s registros (%.1f MB)\n", 
            format(nrow(dados_rp_anexo_08), big.mark = ".", decimal.mark = ","),
            object.size(dados_rp_anexo_08) / 1024^2))
cat(sprintf("   ‚Ä¢ Anexo 03 RCL: %s registros (%.1f MB)\n", 
            format(nrow(dados_rp_anexo_03_rcl), big.mark = ".", decimal.mark = ","),
            object.size(dados_rp_anexo_03_rcl) / 1024^2))

# Mem√≥ria total
memoria_total <- (object.size(dados_rp_anexo_07) + 
                  object.size(dados_rp_anexo_12) + 
                  object.size(dados_rp_anexo_08) + 
                  object.size(dados_rp_anexo_03_rcl)) / 1024^2

cat(sprintf("   ‚Ä¢ Mem√≥ria total: %.1f MB\n", memoria_total))
cat(sprintf("   ‚Ä¢ Tempo de importa√ß√£o: %.1f segundos\n", 
            as.numeric(difftime(tempo_fim, tempo_inicio, units = "secs"))))
```

## üè¶ Dados RREO Anexo 06 - Resultado Prim√°rio

```{r dados_rreo_a06_resultado_primario}
#| echo: true
#| include: false

# ============================================================================
# ‚ö° VERS√ÉO OTIMIZADA - IMPORTA√á√ÉO PARALELA DE 4 ARQUIVOS
# ============================================================================

# Definir arquivos
arquivos_a06 <- list(
  ndd = str_c(mes_pasta, "rreo_a06_despesas_primarias_ndd.xlsx"),
  categoria_grupo = str_c(mes_pasta, "rreo_a06_despesas_primarias_categoria_grupo.xlsx"),
  juros = str_c(mes_pasta, "rreo_a06_juros.xlsx"),
  disponibilidades = str_c(mes_pasta, "rreo_a06_disponibilidades.xlsx"),
  ajustes = str_c(mes_pasta, "rreo_a06_ajustes.xlsx")
)

cat(sprintf("üì• Importando %d arquivos do Anexo 06 em paralelo...\n", length(arquivos_a06)))

# Importar todos simultaneamente
dados_a06_lista <- future_map(
  arquivos_a06,
  function(arquivo) {
    read_excel(arquivo, skip = 5) %>%
      clean_names() %>%
      mutate(
        mes_lancamento = as.numeric(mes_lancamento),
        data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1)
      )
  },
  .progress = TRUE,
  .options = furrr_options(seed = TRUE)
)

# Extrair para vari√°veis espec√≠ficas
dados_ndd <- dados_a06_lista$ndd
dados_categoria_grupo <- dados_a06_lista$categoria_grupo
dados_juros <- dados_a06_lista$juros
tg_RPN_juros <- dados_juros  # Alias para compatibilidade
tg_RPN_disponibilidades <- dados_a06_lista$disponibilidades
dados_ajustes <- dados_a06_lista$ajustes

cat("\n‚úÖ Dados do Anexo 06 carregados:\n")
cat(sprintf("   ‚Ä¢ NDD: %s registros\n", 
            format(nrow(dados_ndd), big.mark = ".", decimal.mark = ",")))
cat(sprintf("   ‚Ä¢ Categoria/Grupo: %s registros\n", 
            format(nrow(dados_categoria_grupo), big.mark = ".", decimal.mark = ",")))
cat(sprintf("   ‚Ä¢ Juros: %s registros\n", 
            format(nrow(dados_juros), big.mark = ".", decimal.mark = ",")))
cat(sprintf("   ‚Ä¢ Disponibilidades: %s registros\n", 
            format(nrow(tg_RPN_disponibilidades), big.mark = ".", decimal.mark = ",")))
```

## üìä Dados RCL - RREO Anexo 03

```{r importar-dados-rcll}
#| include: false

cat("üì• Importando dados RCL (RREO A03)...\n")

# ============================================================================
# IMPORTA√á√ÉO
# ============================================================================

# Despesas
cat("   ‚Ä¢ Importando RCL Despesas...\n")
rreo_a03_rcl_despesas <- read_excel(
  str_c(mes_pasta, "rreo_a03_rcl_despesas.xlsx"), 
  skip = 5
) %>%
  clean_names() %>%
  mutate(
    # Converter coluna num√©rica
    movim_liquido_r_item_informacao = as.numeric(movim_liquido_r_item_informacao),
    mes_lancamento = as.numeric(mes_lancamento),
    data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1),
    # ‚úÖ CRIAR ALIAS para compatibilidade com crit√©rios
    saldo_r_item_informacao = movim_liquido_r_item_informacao
  )

# Receitas
cat("   ‚Ä¢ Importando RCL Receitas...\n")
rreo_a03_rcl_receitas <- read_excel(
  str_c(mes_pasta, "rreo_a03_rcl_receitas.xlsx"), 
  skip = 5
) %>%
  clean_names() %>%
  mutate(
    # Converter coluna num√©rica
    movim_liquido_r_item_informacao = as.numeric(movim_liquido_r_item_informacao),
    mes_lancamento = as.numeric(mes_lancamento),
    data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1),
    # ‚úÖ CRIAR ALIAS para compatibilidade com crit√©rios
    saldo_r_item_informacao = movim_liquido_r_item_informacao
  )

cat(sprintf("\n‚úì RCL Despesas: %s registros\n", 
            format(nrow(rreo_a03_rcl_despesas), big.mark = ".", decimal.mark = ",")))
cat(sprintf("‚úì RCL Receitas: %s registros\n", 
            format(nrow(rreo_a03_rcl_receitas), big.mark = ".", decimal.mark = ",")))

# ============================================================================
# VERIFICA√á√ÉO
# ============================================================================
cat("\nüîç Verifica√ß√£o:\n")
cat(sprintf("   Colunas em despesas: %d\n", ncol(rreo_a03_rcl_despesas)))
cat(sprintf("   Colunas em receitas: %d\n", ncol(rreo_a03_rcl_receitas)))

# Verificar que alias foi criado e √© num√©rico
cat("\n‚úÖ Alias 'saldo_r_item_informacao' criado:\n")
cat(sprintf("   Despesas: %s (tipo: %s)\n", 
            "saldo_r_item_informacao" %in% names(rreo_a03_rcl_despesas),
            class(rreo_a03_rcl_despesas$saldo_r_item_informacao)[1]))
cat(sprintf("   Receitas: %s (tipo: %s)\n", 
            "saldo_r_item_informacao" %in% names(rreo_a03_rcl_receitas),
            class(rreo_a03_rcl_receitas$saldo_r_item_informacao)[1]))

# Teste de agrega√ß√£o
cat("\nüß™ Teste de agrega√ß√£o:\n")
teste_desp <- rreo_a03_rcl_despesas %>% 
  summarise(
    total_movim = sum(movim_liquido_r_item_informacao, na.rm = TRUE),
    total_saldo = sum(saldo_r_item_informacao, na.rm = TRUE)
  )
cat(sprintf("   Despesas (movim_liquido): %s\n", 
            format(teste_desp$total_movim, big.mark = ".", decimal.mark = ",")))
cat(sprintf("   Despesas (saldo_r alias): %s\n", 
            format(teste_desp$total_saldo, big.mark = ".", decimal.mark = ",")))

teste_rec <- rreo_a03_rcl_receitas %>% 
  summarise(
    total_movim = sum(movim_liquido_r_item_informacao, na.rm = TRUE),
    total_saldo = sum(saldo_r_item_informacao, na.rm = TRUE)
  )
cat(sprintf("   Receitas (movim_liquido): %s\n", 
            format(teste_rec$total_movim, big.mark = ".", decimal.mark = ",")))
cat(sprintf("   Receitas (saldo_r alias): %s\n", 
            format(teste_rec$total_saldo, big.mark = ".", decimal.mark = ",")))

cat("\n‚úÖ Importa√ß√£o RCL conclu√≠da com sucesso!\n")
```

## üë• Dados RGF Anexo 01 - Despesa com Pessoal

```{r importar-dados-rgf-a01}
#| include: false

cat("üì• Importando dados RGF A01 (Despesa Pessoal)...\n")

# ============================================================================
# ‚ö° VERS√ÉO OTIMIZADA - IMPORTA√á√ÉO PARALELA
# ============================================================================

# RGF Anexo 1
arq_rgf_a01 <- list.files(path = mes_pasta, pattern = 'rgf_a01_', full.names = TRUE)

cat(sprintf("   Encontrados %d arquivos\n", length(arq_rgf_a01)))

rgf_a01 <- importar_excel_paralelo(arq_rgf_a01, skip = 5, .progress = TRUE) %>%
  mutate(
    movim_liquido_r_item_informacao = as.numeric(movim_liquido_r_item_informacao),
    mes_lancamento = as.numeric(mes_lancamento),
    data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1)
  )

cat(sprintf("‚úì RGF A01: %s registros (%d arquivos)\n", 
            format(nrow(rgf_a01), big.mark = ".", decimal.mark = ","), 
            length(arq_rgf_a01)))
```

## üèõÔ∏è Dados RGF Anexo 02 - D√≠vida Consolidada L√≠quida (DCL)

```{r importar-dados-rgf-a02}
#| include: false

cat("üì• Importando dados RGF A02 (DCL)...\n")

# ============================================================================
# ‚ö° VERS√ÉO OTIMIZADA - IMPORTA√á√ÉO PARALELA
# ============================================================================

# Fun√ß√£o auxiliar para processar arquivo (mantida para compatibilidade)
processar_arquivo_rgf_a02 <- function(file_path, skip_rows = 5) {
  df <- read_excel(file_path, skip = skip_rows, col_types = "text") %>%
    clean_names()
  
  if ("mes_lancamento" %in% names(df)) {
    df <- df %>%
      mutate(
        mes_lancamento = as.numeric(mes_lancamento),
        data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1)
      )
  }
  
  # Converte colunas num√©ricas automaticamente
  numeric_patterns <- c("^saldo_r", "^movim_liquido_r")
  cols_to_convert <- names(df)[str_detect(names(df), paste(numeric_patterns, collapse = "|"))]
  
  for (col in cols_to_convert) {
    df <- df %>% mutate(!!sym(col) := as.numeric(!!sym(col)))
  }
  
  return(df)
}

# Lista TODOS os arquivos rgf_a02_*.xlsx
arq_rgf_a02 <- list.files(
  path = mes_pasta,
  pattern = "^rgf_a02_.*\\.xlsx$",
  full.names = TRUE
)

cat(sprintf("   Encontrados %d arquivos\n", length(arq_rgf_a02)))

# Processar em paralelo
rgf_a02_list <- future_map(
  arq_rgf_a02,
  processar_arquivo_rgf_a02,
  .progress = TRUE,
  .options = furrr_options(seed = TRUE)
)

# Nomeia os dataframes
names(rgf_a02_list) <- basename(arq_rgf_a02) %>% str_remove("\\.xlsx$")

# Coloca cada um no ambiente global
list2env(rgf_a02_list, envir = .GlobalEnv)

cat(sprintf("‚úì RGF A02: %d arquivos importados\n", length(arq_rgf_a02)))
```

## üîê Dados RGF Anexo 03 - Garantias e Contragarantias

```{r importar-dados-rgf-a03}
#| include: false

cat("üì• Importando dados RGF A03 (Garantias)...\n")

# RGF Anexo 3
rgf_a03 <- read_excel(str_c(mes_pasta, "rgf_a03.xlsx"), skip = 5) %>%
  clean_names() %>%
  mutate(
    mes_lancamento = as.numeric(mes_lancamento),
    data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1)
  )

cat(sprintf("‚úì RGF A03: %s registros\n", 
            format(nrow(rgf_a03), big.mark = ".", decimal.mark = ",")))
```

## üí≥ Dados RGF Anexo 04 - Opera√ß√µes de Cr√©dito

```{r importar-dados-rgf-a04}
#| include: false
#| column: screen

cat("üì• Importando dados RGF A04 (Opera√ß√µes Cr√©dito)...\n")

# ============================================================================
# ‚ö° VERS√ÉO OTIMIZADA - IMPORTA√á√ÉO PARALELA
# ============================================================================

arquivos_a04 <- list(
  receitas = str_c(mes_pasta, "rgf_a04_receitas.xlsx"),
  despesas = str_c(mes_pasta, "rgf_a04_despesas.xlsx")
)

# Importar em paralelo
dados_a04_lista <- future_map(
  arquivos_a04,
  function(arquivo) {
    read_excel(arquivo, skip = 5) %>%
      clean_names() %>%
      mutate(
        mes_lancamento = as.numeric(mes_lancamento),
        data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1)
      )
  },
  .progress = TRUE
)

rgf_a04_receitas <- dados_a04_lista$receitas
rgf_a04_despesas <- dados_a04_lista$despesas

cat(sprintf("‚úì RGF A04 Receitas: %s registros\n", 
            format(nrow(rgf_a04_receitas), big.mark = ".", decimal.mark = ",")))
cat(sprintf("‚úì RGF A04 Despesas: %s registros\n", 
            format(nrow(rgf_a04_despesas), big.mark = ".", decimal.mark = ",")))
```

## üí∞ Dados RGF Anexo 05 - Disponibilidades de Caixa

```{r importar-dados-rgf-a05}


#| include: false

cat("üì• Importando dados RGF A05 (Disponibilidades)...\n")

# ============================================================================
# ‚ö° VERS√ÉO OTIMIZADA - IMPORTA√á√ÉO PARALELA
# ============================================================================

# Buscar todos os arquivos rgf_a05
arq_rgf_a05 <- list.files(path = mes_pasta, pattern = 'rgf_a05', full.names = TRUE)

cat(sprintf("   Encontrados %d arquivos\n", length(arq_rgf_a05)))

rgf_a05 <- importar_excel_paralelo(arq_rgf_a05, skip = 5, .progress = TRUE) %>%
  mutate(
    saldo_r_conta_contabil = as.numeric(saldo_r_conta_contabil),
    mes_lancamento = as.numeric(mes_lancamento),
    data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1)
  )

cat(sprintf("‚úì RGF A05: %s registros (%d arquivos)\n", 
            format(nrow(rgf_a05), big.mark = ".", decimal.mark = ","), 
            length(arq_rgf_a05)))
```

# Fun√ß√µes {#sec-funcoes-aux}

## Mapear arquivo

```{r}
# ============================================================================
# FUNCAO: mapear_arquivos_tg
# ============================================================================
# Gera uma tabela de apoio mapeando arquivos xlsx e seus filtros do TG.
# Basta informar o caminho da pasta com os arquivos.
#
# Uso: Chamar uma vez para ter a visao de todos os arquivos utilizados.
#
# Parametros:
#   - pasta: caminho da pasta com os arquivos xlsx
#   - pattern: padrao para filtrar arquivos (default: todos xlsx)
#
# Retorna:
#   - DataFrame com: arquivo, filtros_tg
# ============================================================================

mapear_arquivos_tg <- function(pasta, pattern = "\\.xlsx$") {
  
  # Listar todos os arquivos xlsx na pasta
  arquivos <- list.files(
    path = pasta, 
    pattern = pattern, 
    full.names = TRUE
  )
  
  if (length(arquivos) == 0) {
    warning("Nenhum arquivo encontrado na pasta")
    return(data.frame())
  }
  
  cat(sprintf("Mapeando %d arquivos...\n", length(arquivos)))
  
  # Extrair filtros de cada arquivo (celula A4)
  resultado <- map_df(arquivos, function(arq) {
    
    filtros_tg <- tryCatch({
      celula_a4 <- read_excel(arq, range = "A4", col_names = FALSE)
      as.character(celula_a4[[1]][1])
    }, error = function(e) {
      NA_character_
    })
    
    data.frame(
      arquivo = basename(arq),
      filtros_tg = filtros_tg,
      stringsAsFactors = FALSE
    )
  })
  
  # Salvar no ambiente global
  assign("df_arquivos_tg", resultado, envir = .GlobalEnv)
  
  cat(sprintf("Tabela gerada: df_arquivos_tg (%d arquivos)\n", nrow(resultado)))
  
  return(resultado)
}


# ============================================================================
# EXEMPLO DE USO:
# ============================================================================
# df_arquivos_tg <- mapear_arquivos_tg(mes_pasta)
# 
# # Visualizar
# datatable(df_arquivos_tg)
# ============================================================================
```

## Aplicar Crit√©rios

```{r}
#| include: false

#' Aplica crit√©rios de filtro e agrupamento a um dataframe
#'
#' @param df Dataframe de entrada com dados fiscais
#' @param criterios Lista nomeada de crit√©rios (cada item com campo 'criterio')
#' @param group_vars Vetor de vari√°veis para agrupamento (opcional)
#' @param save_global Se TRUE, salva resultado no ambiente global com nome autom√°tico (padr√£o: FALSE)
#' @param validate_criteria Se TRUE, valida crit√©rios antes de executar (padr√£o: TRUE)
#'
#' @return Dataframe com resultados agregados por categoria
#'
#' @examples
#' # Uso moderno (recomendado)
#' resultado <- aplicar_criterios(dados_despesa, criterios_rgf_A01)
#' 
#' # Compatibilidade com c√≥digo antigo
#' aplicar_criterios(dados_despesa, criterios_rgf_A01, save_global = TRUE)
#'
aplicar_criterios <- function(df, 
                               criterios, 
                               group_vars = NULL,
                               save_global = TRUE,
                               validate_criteria = TRUE) {
  
  # ============================================================================
  # 1. DETEC√á√ÉO AUTOM√ÅTICA DA M√âTRICA
  # ============================================================================
  metrica <- names(df)[grepl("^(saldo|movim)", names(df), ignore.case = TRUE)][1]
  
  if (is.na(metrica) || length(metrica) == 0) {
    stop("N√£o foi poss√≠vel detectar coluna de m√©trica (saldo_* ou movim_*)")
  }
  
  # ============================================================================
  # 2. CAPTURAR METADADOS DO DATAFRAME
  # ============================================================================
  df_completo <- paste(deparse(substitute(df)), collapse = " ")
  
  # Separar nome da df de eventuais filtros
  if (grepl("%>%", df_completo)) {
    df_nome <- trimws(strsplit(df_completo, "%>%")[[1]][1])
    df_filtros <- paste(strsplit(df_completo, "%>%")[[1]][-1], collapse = " %>% ")
    df_filtros <- trimws(df_filtros)
  } else {
    df_nome <- df_completo
    df_filtros <- NA
  }
  
  # Capturar nome da vari√°vel criterios
  criterios_nome <- deparse(substitute(criterios))
  
  # ============================================================================
  # 3. DEFINIR VARI√ÅVEIS DE AGRUPAMENTO
  # ============================================================================
  if (is.null(group_vars)) {
    group_vars <- c("mes_lancamento", "data_lancamento")
  } else {
    # Garantir que mes_lancamento e data_lancamento estejam inclu√≠dos
    if (!"mes_lancamento" %in% group_vars) {
      group_vars <- c("mes_lancamento", group_vars)
    }
    if (!"data_lancamento" %in% group_vars) {
      group_vars <- c("data_lancamento", group_vars)
    }
  }
  
  # Verificar quais colunas existem na df
  group_vars <- group_vars[group_vars %in% names(df)]
  
  # ============================================================================
  # 4. EXTRAIR METADADOS DOS CRIT√âRIOS
  # ============================================================================
  partes <- strsplit(criterios_nome, "_")[[1]]
  
  if (partes[1] == "criterios") {
    partes <- partes[-1]
  }
  
  relatorio <- if (length(partes) >= 1) partes[1] else NA
  anexo_codigo <- if (length(partes) >= 2) partes[2] else NA
  anexo_nome <- if (length(partes) >= 3) partes[3] else NA
  detalhe <- if (length(partes) >= 4) paste(partes[4:length(partes)], collapse = "_") else NA
  
  # ============================================================================
  # 5. VALIDAR CRIT√âRIOS (OPCIONAL)
  # ============================================================================
  if (validate_criteria) {
    for (cat_nome in names(criterios)) {
      crit <- criterios[[cat_nome]]
      
      # Pular f√≥rmulas matem√°ticas
      if (grepl("\\{[^}]+\\}", crit$criterio)) {
        next
      }
      
      # Tentar parsear para verificar sintaxe
      tryCatch({
        rlang::parse_expr(crit$criterio)
      }, error = function(e) {
        warning(sprintf("‚ö†Ô∏è Crit√©rio inv√°lido em categoria '%s': %s\n   Express√£o: %s", 
                       cat_nome, e$message, crit$criterio))
      })
    }
  }
  
  # ============================================================================
  # 6. APLICAR CRIT√âRIOS (COM RLANG - SEGURO)
  # ============================================================================
  resultado <- map_df(names(criterios), function(categoria) {
    crit <- criterios[[categoria]]
    
    # Pular f√≥rmulas matem√°ticas - ser√£o tratadas em calcular_operacoes
    if (grepl("\\{[^}]+\\}", crit$criterio)) {
      return(data.frame())
    }
    
    # Extrair flag de print do nome da categoria
    if (grepl("_s$", categoria)) {
      print_flag <- "s"
      categoria_limpa <- str_replace(categoria, "_s$", "")
    } else if (grepl("_n$", categoria)) {
      print_flag <- "n"
      categoria_limpa <- str_replace(categoria, "_n$", "")
    } else {
      print_flag <- "s"  # default
      categoria_limpa <- categoria
    }
    
    # ========================================================================
    # üîß CORRE√á√ÉO PRINCIPAL: Usar rlang em vez de eval(parse())
    # ========================================================================
    condicao_expr <- tryCatch({
      # Parsear express√£o de forma segura
      expr <- rlang::parse_expr(crit$criterio)
      
      # Avaliar no contexto do dataframe
      rlang::eval_tidy(expr, data = df)
      
    }, error = function(e) {
      stop(sprintf(
        "‚ùå Erro ao avaliar crit√©rio em categoria '%s':\n   Express√£o: %s\n   Erro: %s", 
        categoria, crit$criterio, e$message
      ))
    })
    
    # Verificar se retornou vetor l√≥gico
    if (!is.logical(condicao_expr)) {
      stop(sprintf(
        "‚ùå Crit√©rio n√£o retornou vetor l√≥gico em categoria '%s':\n   Express√£o: %s\n   Tipo retornado: %s",
        categoria, crit$criterio, class(condicao_expr)[1]
      ))
    }
    
    # ========================================================================
    # 7. APLICAR FILTRO E AGRUPAR
    # ========================================================================
    if (length(group_vars) > 0) {
      resultado_filtrado <- df %>%
        filter(condicao_expr) %>%
        group_by(across(all_of(group_vars))) %>%
        summarise(
          valor = sum(.data[[metrica]], na.rm = TRUE),
          .groups = "drop"
        ) %>%
       mutate(
  categoria = categoria_limpa,
  metrica = metrica,
  dataframe_nome = df_nome,
  dataframe_filtros = df_filtros,
  criterios_nome_completo = criterios_nome,  # ‚Üê ADICIONAR ISTO
  relatorio = relatorio,
  anexo_codigo = anexo_codigo,
  anexo_nome = anexo_nome,
  detalhe = detalhe,
  print = print_flag,
  filtro = crit$criterio
)
    } else {
      resultado_filtrado <- df %>%
        filter(condicao_expr) %>%
        summarise(
          valor = sum(.data[[metrica]], na.rm = TRUE)
        ) %>%
        mutate(
  categoria = categoria_limpa,
  metrica = metrica,
  dataframe_nome = df_nome,
  dataframe_filtros = df_filtros,
  criterios_nome_completo = criterios_nome,  # ‚Üê ADICIONAR ISTO
  relatorio = relatorio,
  anexo_codigo = anexo_codigo,
  anexo_nome = anexo_nome,
  detalhe = detalhe,
  print = print_flag,
  filtro = crit$criterio
)
    }
    
    # ========================================================================
    # üîß CORRE√á√ÉO: Usar str_extract em vez de separate(sep = 2)
    # ========================================================================
    resultado_final <- resultado_filtrado %>%
      mutate(
        # Extrair ordem (1 ou 2 d√≠gitos no in√≠cio)
        ordem = str_extract(categoria, "^\\d{1,2}"),
        # Extrair nome (tudo ap√≥s os d√≠gitos e espa√ßos)
        nome = str_trim(str_remove(categoria, "^\\d{1,2}\\s*"))
      ) %>%
      select(any_of(c("mes_lancamento", "data_lancamento")), everything())
    
    return(resultado_final)
  })
  
  # ============================================================================
  # 8. SALVAR NO AMBIENTE GLOBAL (OPCIONAL)
  # ============================================================================
  if (save_global) {
    novo_nome <- paste0("df_", criterios_nome)
    assign(novo_nome, resultado, envir = .GlobalEnv)
    message("‚úÖ Resultado salvo em vari√°vel global: ", novo_nome)
  }
  
  # ============================================================================
  # 9. RETORNAR RESULTADO
  # ============================================================================
  return(resultado)
}

```

```{r}

consolidar_criterios <- function(save_global = FALSE) {
  
  # ============================================================================
  # 1. OBTER DATAFRAMES DO AMBIENTE GLOBAL
  # ============================================================================
  objetos <- ls(envir = .GlobalEnv)
  df_criterios <- objetos[grepl("^df_criterios", objetos)]
  
  if (length(df_criterios) == 0) {
    warning("‚ö†Ô∏è Nenhuma dataframe com prefixo 'df_criterios' foi encontrada no ambiente global")
    return(data.frame())
  }
  
  message(sprintf("üìä Encontradas %d dataframes para consolidar", length(df_criterios)))
  
  # ============================================================================
  # 2. OBTER E PADRONIZAR DATAFRAMES
  # ============================================================================
  tabelas <- map(df_criterios, ~ get(.x, envir = .GlobalEnv))
  
  # Padronizar tipos de colunas antes de combinar
  tabelas_padronizadas <- map(tabelas, function(tabela) {
    
    # Converter colunas problem√°ticas para character
    if ("dataframe_filtros" %in% names(tabela)) {
      tabela$dataframe_filtros <- as.character(tabela$dataframe_filtros)
      tabela$dataframe_filtros[is.na(tabela$dataframe_filtros)] <- ""
    }
    
    if ("item_informacao_codigo" %in% names(tabela)) {
      tabela$item_informacao_codigo <- as.character(tabela$item_informacao_codigo)
    }
    if ("item_informacao_nome" %in% names(tabela)) {
      tabela$item_informacao_nome <- as.character(tabela$item_informacao_nome)
    }
    
    if ("relatorio" %in% names(tabela)) {
      tabela$relatorio <- as.character(tabela$relatorio)
    }
    if ("anexo_codigo" %in% names(tabela)) {
      tabela$anexo_codigo <- as.character(tabela$anexo_codigo)
    }
    if ("anexo_nome" %in% names(tabela)) {
      tabela$anexo_nome <- as.character(tabela$anexo_nome)
    }
    if ("detalhe" %in% names(tabela)) {
      tabela$detalhe <- as.character(tabela$detalhe)
    }
    
    return(tabela)
  })
  
  # ============================================================================
  # 3. COMBINAR TODAS AS TABELAS (SEM AGRUPAR AINDA)
  # ============================================================================
  resultado_completo <- bind_rows(tabelas_padronizadas)
  
  message(sprintf("‚úÖ Consolidadas %d linhas de dados", nrow(resultado_completo)))
  
  # ============================================================================
  # 4. üîß CORRE√á√ÉO: IDENTIFICAR TODAS AS COLUNAS PARA AGRUPAMENTO
  # ============================================================================
  # Colunas padr√£o que sempre existem
  colunas_padrao <- c("mes_lancamento", "data_lancamento", "ordem", "nome", 
                      "metrica", "dataframe_nome", "dataframe_filtros",
                      "relatorio", "anexo_codigo", "anexo_nome", 
                      "detalhe", "print", "filtro")
  
  # üîß NOVO: Identificar colunas EXTRAS que vieram de group_vars
  todas_colunas <- names(resultado_completo)
  colunas_extras <- setdiff(
    todas_colunas, 
    c(colunas_padrao, "valor", "categoria", "chave")
  )
  
  # Colunas para agrupamento = padr√£o + extras
  colunas_agrupamento <- c(colunas_padrao, colunas_extras)
  
  # Filtrar apenas as que realmente existem
  colunas_agrupamento <- colunas_agrupamento[colunas_agrupamento %in% todas_colunas]
  
  message(sprintf("üìã Agrupando por %d colunas (incluindo vari√°veis customizadas)", 
                  length(colunas_agrupamento)))
  
  # ============================================================================
  # 5. AGRUPAR E SUMARIZAR (PRESERVANDO TODAS AS DIMENS√ïES)
  # ============================================================================
  resultado <- resultado_completo %>%
    group_by(across(all_of(colunas_agrupamento))) %>%
    summarise(valor = sum(valor, na.rm = TRUE), .groups = "drop") %>%
    arrange(mes_lancamento, relatorio, anexo_codigo, detalhe, ordem)
  
  # ============================================================================
  # 6. CRIAR COLUNAS DERIVADAS
  # ============================================================================
  resultado <- resultado %>%
    mutate(
      # Garantir que data_lancamento existe
      data_lancamento = if_else(
        is.na(data_lancamento),
        ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1),
        data_lancamento
      ),
      # Criar chave √∫nica
      chave = paste0(
        mes_lancamento, "_", 
        tolower(relatorio), "_", 
        tolower(anexo_codigo), "_", 
        tolower(detalhe), "_", 
        ordem
      )
    )
  
  # ============================================================================
  # 7. REORDENAR COLUNAS (PADR√ÉO + EXTRAS + VALOR)
  # ============================================================================
  colunas_ordem <- c(
    "chave", "mes_lancamento", "data_lancamento", 
    "dataframe_nome", "dataframe_filtros", 
    "relatorio", "anexo_codigo", "anexo_nome", 
    "detalhe", "print", "filtro", "metrica"
  )
  
  # Adicionar colunas extras na ordem
  colunas_ordem <- c(colunas_ordem, colunas_extras)
  
  # Adicionar ordem, nome, valor no final
  colunas_ordem <- c(colunas_ordem, "ordem", "nome", "valor")
  
  # Selecionar apenas colunas que existem (sem duplicatas)
  colunas_ordem <- unique(colunas_ordem[colunas_ordem %in% names(resultado)])
  
  resultado <- resultado %>% select(all_of(colunas_ordem))
  
  # ============================================================================
  # 8. SALVAR NO AMBIENTE GLOBAL (OPCIONAL)
  # ============================================================================
  if (save_global) {
    assign("df_criterios_consolidado", resultado, envir = .GlobalEnv)
    message("‚úÖ Dados consolidados salvos em: df_criterios_consolidado")
  }
  
  # ============================================================================
  # 9. RETORNAR RESULTADO
  # ============================================================================
  return(resultado)
}


```

## Formata√ß√£o de N√∫meros

```{r formatar_numero}
#| echo: true
#| include: false

#' Formatar n√∫meros para exibi√ß√£o brasileira
#' @param x Vetor num√©rico a ser formatado
#' @return String formatada com ponto como separador de milhares e v√≠rgula como decimal
formatar_numero <- function(x) {
  format(x, big.mark = ".", decimal.mark = ",", scientific = FALSE, nsmall = 2)
}

# Teste da fun√ß√£o
exemplo_numero <- 1234567.89
print(paste("N√∫mero original:", exemplo_numero))
print(paste("N√∫mero formatado:", formatar_numero(exemplo_numero)))
```

## Formata√ß√£o de Tabelas

```{r dt_formatada}
#| echo: true
#| include: false

#' Criar tabela DT formatada com totais
#' @param df Data frame a ser formatado
#' @param grupo Vetor com nomes das colunas de agrupamento (n√£o num√©ricas)
#' @return Objeto DT formatado
dt_formatada <- function(df, grupo) {
  # library(DT)
  # library(janitor)
  
  datatable(
    df %>% adorn_totals("row"), 
    rownames = FALSE,
    extensions = 'Buttons',
    options = list(
      lengthMenu = c(5, 10, 25, 50, 100),
      dom = 'Bfrtip',
      buttons = list('excel')
    )
  ) %>% 
  formatRound(
    setdiff(df %>% colnames(), grupo), 
    2, 
    mark = ".", 
    dec.mark = ","
  ) %>% 
  DT::formatStyle(
    columns = colnames(.$x$data), 
    fontSize = '75%'
  )
}

print("‚úÖ Fun√ß√£o dt_formatada definida")
```

## Tabela Pivotada

```{r tabela_pivotada}
#| echo: true
#| include: false

#' Pivotar tabela a partir dos itens de informa√ß√£o
#' @param df Data frame com dados
#' @param grupo Vetor com nomes das colunas de agrupamento
#' @return Data frame pivotado e sumarizado
tabela_pivotada <- function(df, grupo) {
  # library(dplyr)
  # library(tidyr)
  
  # Obter itens √∫nicos de informa√ß√£o
  itens <- df$item_informacao_nome %>% unique() %>% na.omit()
  
  # Verificar se a coluna principal existe
  if (!"saldo_r_item_informacao" %in% names(df)) {
    stop("Coluna 'saldo_r_item_informacao' n√£o encontrada no data frame")
  }
  
  # Pivotar e sumarizar apenas a coluna num√©rica
  df %>% 
    group_by(!!!syms(grupo)) %>% 
    pivot_wider(
      names_from = item_informacao_nome, 
      values_from = saldo_r_item_informacao,
      values_fill = 0
    ) %>% 
    # Sumarizar apenas as colunas que correspondem aos itens (num√©ricas)
    summarise(
      across(all_of(itens), ~ sum(.x, na.rm = TRUE)),
      .groups = "drop"
    )
}


```

## Calcular opera√ß√µes

```{r calcular_operacoes}
#| echo: true
#| include: false
# Fun√ß√£o para realizar opera√ß√µes matem√°ticas usando as chaves √∫nicas
calcular_operacoes <- function(dados_consolidados = NULL, ...) {
  
  # Se dados n√£o fornecidos, usar consolidar_criterios()
  if (is.null(dados_consolidados)) {
    dados_consolidados <- consolidar_criterios()
  }
  
  # Capturar as opera√ß√µes passadas como argumentos
  operacoes <- list(...)
  
  if (length(operacoes) == 0) {
    stop("Nenhuma opera√ß√£o foi especificada")
  }
  
  # Criar um lookup table para facilitar a busca
  lookup_valores <- setNames(dados_consolidados$valor, dados_consolidados$chave)
  
  # Processar cada opera√ß√£o
  resultados <- map(names(operacoes), function(nome_operacao) {
    operacao <- operacoes[[nome_operacao]]
    
    if (is.character(operacao)) {
      # Opera√ß√£o simples: apenas a f√≥rmula como string
      formula <- operacao
    } else if (is.list(operacao) && !is.null(operacao$formula)) {
      # Opera√ß√£o estruturada
      formula <- operacao$formula
    } else {
      stop(paste("Opera√ß√£o", nome_operacao, "deve ser uma string (f√≥rmula) ou list com 'formula'"))
    }
    
    formula_processada <- formula
    
    # Encontrar todas as chaves na f√≥rmula (padr√£o: YYYYMM_texto_texto_texto_NN)
    chaves <- str_extract_all(formula, "[0-9]{6}_[a-zA-Z0-9/_]+_[a-zA-Z0-9/_]+_[a-zA-Z0-9/_]+_[0-9]+")[[1]]
    
    for (chave in chaves) {
      valor <- ifelse(chave %in% names(lookup_valores), 
                      lookup_valores[[chave]], 
                      0)
      # Converter para num√©rico e usar format cient√≠fico se necess√°rio para evitar v√≠rgulas
      valor_numerico <- as.numeric(valor)
      # Usar options para garantir nota√ß√£o sem v√≠rgula
      valor_limpo <- format(valor_numerico, scientific = FALSE, big.mark = "")
      
      formula_processada <- str_replace(formula_processada, 
                                        fixed(chave), 
                                        valor_limpo)
    }
    
    # Avaliar a express√£o matem√°tica
    resultado_calculo <- eval(parse(text = formula_processada))
    
    return(list(
      operacao = nome_operacao,
      formula_original = formula,
      formula_processada = formula_processada,
      resultado = resultado_calculo
    ))
  })
  
  names(resultados) <- names(operacoes)
  return(resultados)
}
```

# RGF - Relat√≥rio de Gest√£o Fiscal

# üìã RGF Anexo 01 - Despesa com Pessoal {#sec-rgf-a01}

## Ficha T√©cnica

```{r ficha-tecnica-rgf-a01}
#| echo: false

# =============================================================================
# FICHA T√âCNICA DO ANEXO
# =============================================================================

ficha_tecnica <- tibble::tribble(
  ~Campo,                 ~Informa√ß√£o,
  "Relat√≥rio",            "RGF - Relat√≥rio de Gest√£o Fiscal",
  "Anexo",                "Anexo 01",
  "Nome",                 "Demonstrativo da Despesa com Pessoal",
  "Base Legal",           "LRF Art. 55, inciso I, al√≠nea 'a'",
  "Periodicidade",        "Quadrimestral",
  "Grau de Dificuldade",  "‚≠ê‚≠ê‚≠ê‚≠ê Dif√≠cil",
  "√öltima Atualiza√ß√£o",   format(Sys.Date(), "%d/%m/%Y")
)

knitr::kable(ficha_tecnica, col.names = c("Campo", "Informa√ß√£o"))
```

## Arquivos Necess√°rios

```{r arquivos-rgf-a01}
#| echo: false

# =============================================================================
# ARQUIVOS DO TESOURO GERENCIAL UTILIZADOS
# =============================================================================

arquivos <- tibble::tribble(
  ~Arquivo,                    ~Descri√ß√£o,                                    ~Filtros_TG,
  "rgf_a01_jan.xlsx",          "Despesa pessoal - Janeiro",                   "M√™s = 01",
  "rgf_a01_fev.xlsx",          "Despesa pessoal - Fevereiro",                 "M√™s = 02",
  "rgf_a01_mar.xlsx",          "Despesa pessoal - Mar√ßo",                     "M√™s = 03",
  "rgf_a01_abr.xlsx",          "Despesa pessoal - Abril",                     "M√™s = 04",
  "rgf_a01_mai.xlsx",          "Despesa pessoal - Maio",                      "M√™s = 05",
  "rgf_a01_jun.xlsx",          "Despesa pessoal - Junho",                     "M√™s = 06",
  "rgf_a01_jul.xlsx",          "Despesa pessoal - Julho",                     "M√™s = 07",
  "rgf_a01_ago.xlsx",          "Despesa pessoal - Agosto",                    "M√™s = 08",
  "rgf_a01_set.xlsx",          "Despesa pessoal - Setembro",                  "M√™s = 09",
  "rgf_a01_out.xlsx",          "Despesa pessoal - Outubro",                   "M√™s = 10",
  "rgf_a01_nov.xlsx",          "Despesa pessoal - Novembro (se aplic√°vel)",   "M√™s = 11",
  "rgf_a01_dez.xlsx",          "Despesa pessoal - Dezembro (se aplic√°vel)",   "M√™s = 12"
)

knitr::kable(arquivos, col.names = c("Arquivo", "Descri√ß√£o", "Filtros no TG"))
```

## Atributos Utilizados

```{r atributos-rgf-a01}
#| echo: false

# =============================================================================
# ATRIBUTOS (COLUNAS) DOS ARQUIVOS E SEUS USOS
# =============================================================================
# Legenda de Uso:
#   TG        = Campo vindo do Tesouro Gerencial
#   R         = Campo calculado em R
#   Crit√©rio  = Usado nos filtros/crit√©rios
#   Apresenta√ß√£o = Usado na exibi√ß√£o final

atributos <- tibble::tribble(
  ~Atributo,                          ~Tipo,       ~Uso,                         ~Descri√ß√£o,
  "grupo_despesa_codigo_grupo",       "character", "TG / Crit√©rio",              "C√≥digo do grupo de despesa (1=Pessoal)",
  "elemento_despesa_codigo",          "character", "TG / Crit√©rio",              "C√≥digo do elemento de despesa",
  "natureza_despesa_detalhada_codigo","character", "TG / Crit√©rio",              "C√≥digo detalhado da natureza de despesa",
  "natureza_despesa_detalhada_nome",  "character", "TG / Crit√©rio",              "Nome da natureza de despesa (para detec√ß√£o de termos)",
  "modalidade_aplicacao_codigo",      "character", "TG / Crit√©rio",              "C√≥digo da modalidade de aplica√ß√£o",
  "fonte_recursos_codigo",            "character", "TG / Crit√©rio",              "C√≥digo da fonte de recursos",
  "unidade_orcamentaria_codigo",      "character", "TG / Crit√©rio",              "C√≥digo da UO (para AP, RR, DF)",
  "plano_orcamentario_codigo_po",     "character", "TG / Crit√©rio",              "C√≥digo do Plano Or√ßament√°rio",
  "acao_governo_codigo",              "character", "TG / Crit√©rio",              "C√≥digo da a√ß√£o de governo",
  "uo_poder",                         "character", "TG / Crit√©rio",              "Identificador do Poder (0=Executivo)",
  "uo_orgao_maximo_codigo",           "character", "TG / Crit√©rio",              "C√≥digo do √≥rg√£o m√°ximo",
  "item_informacao_codigo",           "character", "TG / Crit√©rio",              "C√≥digo do item (25=Liquidado, 27=RPNP)",
  "mes_lancamento",                   "numeric",   "TG / R",                     "M√™s do lan√ßamento (YYYYMM)",
  "movim_liquido_r_item_informacao",  "numeric",   "TG / R",                     "Valor do movimento l√≠quido",
  "data_lancamento",                  "Date",      "R",                          "Data calculada do lan√ßamento",
  "categoria_pessoal",                "character", "R / Crit√©rio / Apresenta√ß√£o","Categoria: executivo, AP, RR, DF, demais"
)

knitr::kable(atributos, col.names = c("Atributo", "Tipo", "Uso", "Descri√ß√£o"))
```

## V√≠nculos com Outros Anexos

```{r vinculos-rgf-a01}
#| echo: false

# =============================================================================
# RELACIONAMENTO COM OUTROS ANEXOS
# =============================================================================

vinculos <- tibble::tribble(
  ~Anexo_Relacionado,   ~Tipo_V√≠nculo,    ~Descri√ß√£o,
  "RREO Anexo 03",      "Refer√™ncia",     "RCL utilizada para c√°lculo dos limites",
  "RGF Anexo 06",       "Consolida√ß√£o",   "Valores consolidados no demonstrativo simplificado"
)

knitr::kable(vinculos, col.names = c("Anexo Relacionado", "Tipo de V√≠nculo", "Descri√ß√£o"))
```

## Estrutura do Demonstrativo

```{r estrutura-rgf-a01}
#| echo: false

# =============================================================================
# ESTRUTURA DO DEMONSTRATIVO - GRUPOS E ITENS
# =============================================================================

estrutura <- tibble::tribble(
  ~Ordem, ~Item,                                           ~Grupo,
  "11",   "Vencimentos, Vantagens e Outras Desp. Vari√°veis", "I - Despesa Bruta",
"12",   "Obriga√ß√µes Patronais",                          "I - Despesa Bruta",
  "13",   "Aposentadorias, Reserva e Reformas",             "I - Despesa Bruta",
  "14",   "Pens√µes",                                        "I - Despesa Bruta",
  "15",   "Outras Despesas com Inativos",                   "I - Despesa Bruta",
  "16",   "Outras Despesas de Pessoal - Terceiriza√ß√£o",     "I - Despesa Bruta",
  "17",   "Despesa com Pessoal n√£o Executada Or√ßam.",       "I - Despesa Bruta",
  "21",   "Indeniza√ß√µes por Demiss√£o e Incentivos",         "II - Despesas N√£o Computadas",
  "22",   "Decorrentes de Decis√£o Judicial",                "II - Despesas N√£o Computadas",
  "23",   "Despesas de Exerc√≠cios Anteriores",              "II - Despesas N√£o Computadas",
  "24",   "Inativos e Pensionistas com Recursos Vinculados","II - Despesas N√£o Computadas"
)

knitr::kable(estrutura, col.names = c("Ordem", "Item", "Grupo"))
```

## Categoriza√ß√£o por Regi√£o/Poder

```{r categorizar-rgf-a01}
#| code-fold: true
#| code-summary: "Ver c√≥digo de categoriza√ß√£o"

# =============================================================================
# CATEGORIZA√á√ÉO DOS DADOS POR REGI√ÉO/PODER
# =============================================================================
# O demonstrativo √© segregado por:
#   - Poder Executivo Federal
#   - Ex-Territ√≥rios (AP, RR)
#   - Distrito Federal (DF)
# =============================================================================

rgf_a01 <- rgf_a01 %>%
  mutate(
    categoria_pessoal = case_when(
      
      # -------------------------------------------------------------------------
      # DESPESAS RESSALVADAS (aplicar primeiro - mais espec√≠fico)
      # -------------------------------------------------------------------------
      # Naturezas de despesa que s√£o ressalvadas do c√°lculo
      natureza_despesa_detalhada_codigo %in% c(
        "31900503", "31900504", "31900505", "31900506", 
        "31900507", "31900508", "31900501", "31900502"
      ) ~ "ressalvadas",
      
      # -------------------------------------------------------------------------
      # AMAP√Å (AP)
      # -------------------------------------------------------------------------
      # UO 73113 + PO 0004 + A√ß√µes espec√≠ficas
      unidade_orcamentaria_codigo == "73113" & 
        plano_orcamentario_codigo_po == "0004" &
        acao_governo_codigo %in% c("0179", "0181", "214H") ~ "AP",
      
      # -------------------------------------------------------------------------
      # RORAIMA (RR)
      # -------------------------------------------------------------------------
      # UO 73113 + PO 0003 + A√ß√µes espec√≠ficas
      unidade_orcamentaria_codigo == "73113" & 
        plano_orcamentario_codigo_po == "0003" & 
        acao_governo_codigo %in% c("0179", "0181", "214H") ~ "RR",
      
      # -------------------------------------------------------------------------
      # DISTRITO FEDERAL (DF)
      # -------------------------------------------------------------------------
      # UO 73901 = FCDF (Fundo Constitucional do DF)
      unidade_orcamentaria_codigo == "73901" ~ "DF",
      
      # -------------------------------------------------------------------------
      # PODER EXECUTIVO FEDERAL
      # -------------------------------------------------------------------------
      # uo_poder = 0 (Executivo)
      # Exceto √≥rg√£os 34000 (MPU) e 59000 (n√£o identificado)
      uo_poder == "0" &
        !uo_orgao_maximo_codigo %in% c("34000", "59000") ~ "executivo",
      
      # -------------------------------------------------------------------------
      # DEMAIS
      # -------------------------------------------------------------------------
      TRUE ~ "demais"
    )
  )

# Exibir contagem por categoria
cat("\nüìä Distribui√ß√£o por categoria:\n")
rgf_a01 %>%
  count(categoria_pessoal) %>%
  arrange(desc(n)) %>%
  print()
```

## Crit√©rios de Classifica√ß√£o

```{r criterios-rgf-a01}
#| code-fold: true
#| code-summary: "Ver crit√©rios de classifica√ß√£o"

# =============================================================================
# CRIT√âRIOS RGF ANEXO 01 - DEFINI√á√ÉO DOS FILTROS
# =============================================================================
# Numera√ß√£o compat√≠vel com a estrutura do demonstrativo:
#   - Grupo I (1x): Componentes da Despesa Bruta
#   - Grupo II (2x): Despesas N√£o Computadas
# =============================================================================

criterios_rgf_A01_pessoal_rgf <- list(
  
  # ===========================================================================
  # GRUPO I - COMPONENTES DA DESPESA BRUTA
  # ===========================================================================
  
  # ---------------------------------------------------------------------------
  # 11 - VENCIMENTOS, VANTAGENS E OUTRAS DESPESAS VARI√ÅVEIS
  # ---------------------------------------------------------------------------
  # Grupo 1 (Pessoal), excluindo:
  #   - Elementos 01, 03, 34 (aposentadoria, pens√£o, terceiriza√ß√£o)
  #   - Obriga√ß√µes patronais
  #   - Benef√≠cios previdenci√°rios
  #   - Termos de inativos
  #   - Despesas com inativos espec√≠ficas
  
  `11  Vencimentos, Vantagens e Outras Despesas Vari√°veis` = list(
    criterio = "
    grupo_despesa_codigo_grupo == '1' &
    !elemento_despesa_codigo %in% c('01', '03', '34') &
    
    # EXCLUS√ÉO: Obriga√ß√µes Patronais
    !(
      (substr(natureza_despesa_detalhada_codigo, 1, 1) == '3' &
       grupo_despesa_codigo_grupo == '1' &
       elemento_despesa_codigo == '92' &
       ((modalidade_aplicacao_codigo == '90' & 
         natureza_despesa_detalhada_codigo %in% c('31909213', '31909207')) |
        (modalidade_aplicacao_codigo == '91' & 
         natureza_despesa_detalhada_codigo == '31919213'))) |
      elemento_despesa_codigo %in% c('13', '07')
    ) &
    
    # EXCLUS√ÉO: Benef√≠cios Previdenci√°rios
    !(
      (substr(natureza_despesa_detalhada_codigo, 1, 1) == '3' &
       grupo_despesa_codigo_grupo == '1' &
       elemento_despesa_codigo == '92' &
       natureza_despesa_detalhada_codigo == '31909205' &
       modalidade_aplicacao_codigo %in% c('90', '91')) |
      str_detect(natureza_despesa_detalhada_codigo, '0599')
    ) &
    
    # EXCLUS√ÉO: Termos de Inativos (por nome)
    !str_detect(natureza_despesa_detalhada_nome, 
                '\\\\bAPOSENT|\\\\bINAT|\\\\bREFORMA|\\\\bPENS|LEI 7\\\\.963/1989') &
    
    # EXCLUS√ÉO: Despesas com Inativos espec√≠ficas
    !(
      grupo_despesa_codigo_grupo == '1' &
      elemento_despesa_codigo == '05' &
      (str_detect(natureza_despesa_detalhada_codigo, '0505') | 
       str_detect(natureza_despesa_detalhada_codigo, '0506') |
       str_detect(natureza_despesa_detalhada_codigo, '0507') |
       str_detect(natureza_despesa_detalhada_codigo, '0508')) &
      elemento_despesa_codigo %in% c('05', '08', '09', '17', '91', '92', '94')
    )
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 12 - OBRIGA√á√ïES PATRONAIS
  # ---------------------------------------------------------------------------
  # Elementos 13 (Obriga√ß√µes Patronais) e 07 (Contrib. RPPS)
  # Mais naturezas espec√≠ficas de contribui√ß√µes patronais
  
  `12  Obriga√ß√µes Patronais` = list(
    criterio = "
    grupo_despesa_codigo_grupo == '1' & 
    elemento_despesa_codigo %in% c('13', '07') | 
    natureza_despesa_detalhada_codigo %in% c('31909213', '31919213', '31909207')
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 13 - APOSENTADORIAS, RESERVA E REFORMAS
  # ---------------------------------------------------------------------------
  # Elemento 01 (Aposentadorias/Reformas/Pens√µes RPPS)
  # Mais naturezas espec√≠ficas de aposentadorias
  
  `13  Aposentadorias, Reserva e Reformas` = list(
    criterio = "
    grupo_despesa_codigo_grupo == '1' & 
    elemento_despesa_codigo == '01' | 
    natureza_despesa_detalhada_codigo %in% c(
      '31901702', '31909109', '31909112', '31909115', '31909118', 
      '31909123', '31909124', '31909128', '31909129', '31909201', 
      '31909403', '31909404', '31909413', '31909414'
    )
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 14 - PENS√ïES
  # ---------------------------------------------------------------------------
  # Elemento 03 (Pens√µes)
  # Mais naturezas espec√≠ficas de pens√µes
  
  `14  Pens√µes` = list(
    criterio = "
    grupo_despesa_codigo_grupo == '1' & 
    (elemento_despesa_codigo == '03' | 
     natureza_despesa_detalhada_codigo %in% c(
       '31909110', '31909113', '31909116', '31909119', '31909131', 
       '31909136', '31909137', '31909130', '31909203', '31909220', 
       '31909221', '31909406', '31909413'
     ))
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 15 - OUTRAS DESPESAS COM INATIVOS
  # ---------------------------------------------------------------------------
  # Elementos espec√≠ficos + detec√ß√£o de termos de inativos
  # Excluindo naturezas j√° classificadas em outras categorias
  
  `15  Outras Despesas com Inativos` = list(
    criterio = "
    grupo_despesa_codigo_grupo == '1' & 
    elemento_despesa_codigo %in% c('05', '08', '09', '17', '31', '32') & 
    str_detect(natureza_despesa_detalhada_nome, 
               'APOSENT|INAT|REFORMA|PEN|LEI 7\\\\.963/1989') & 
    !(str_detect(natureza_despesa_detalhada_codigo, '0599') & 
      natureza_despesa_detalhada_codigo %in% c('31909205', '31919205')) & 
    !(str_detect(natureza_despesa_detalhada_codigo, '0505') | 
      str_detect(natureza_despesa_detalhada_codigo, '0506') | 
      str_detect(natureza_despesa_detalhada_codigo, '0507') | 
      str_detect(natureza_despesa_detalhada_codigo, '0508'))
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 16 - OUTRAS DESPESAS DE PESSOAL - TERCEIRIZA√á√ÉO
  # ---------------------------------------------------------------------------
  # Elemento 34 (Outras Desp. Pessoal - Terceiriza√ß√£o)
  # Grupos 1 e 3
  
  `16  Outras Despesas de Pessoal - Terceiriza√ß√£o` = list(
    criterio = "
    grupo_despesa_codigo_grupo %in% c('1', '3') & 
    elemento_despesa_codigo == '34'
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 17 - DESPESA COM PESSOAL N√ÉO EXECUTADA OR√áAMENTARIAMENTE
  # ---------------------------------------------------------------------------
  # Placeholder - ajustar conforme metodologia
  
  `17  Despesa com Pessoal n√£o Executada Or√ßamentariamente` = list(
    criterio = "FALSE"
  ),
  
  # ===========================================================================
  # GRUPO II - DESPESAS N√ÉO COMPUTADAS
  # ===========================================================================
  
  # ---------------------------------------------------------------------------
  # 21 - INDENIZA√á√ïES POR DEMISS√ÉO E INCENTIVOS
  # ---------------------------------------------------------------------------
  # Elemento 94 (Indeniza√ß√µes e Restitui√ß√µes Trabalhistas)
  # Excluindo fontes vinculadas com termos de inativos
  
  `21  Indeniza√ß√µes por Demiss√£o e Incentivos` = list(
    criterio = "
    grupo_despesa_codigo_grupo == '1' &
    elemento_despesa_codigo == '94' &
    !(
      fonte_recursos_codigo %in% c('023', '024', '055', '056') &
      str_detect(natureza_despesa_detalhada_nome, 
                 'APOSENT|INAT|REFORMA|PEN|LEI 7\\\\.963/1989')
    )
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 22 - DECORRENTES DE DECIS√ÉO JUDICIAL
  # ---------------------------------------------------------------------------
  # Elemento 91 (Senten√ßas Judiciais)
  # Excluindo fontes vinculadas com termos de inativos
  
  `22  Decorrentes de Decis√£o Judicial` = list(
    criterio = "
    grupo_despesa_codigo_grupo == '1' &
    elemento_despesa_codigo == '91' &
    !(
      fonte_recursos_codigo %in% c('023', '024', '055', '056') &
      str_detect(natureza_despesa_detalhada_nome, 
                 'APOSENT|INAT|REFORMA|PEN|LEI 7\\\\.963/1989')
    )
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 23 - DESPESAS DE EXERC√çCIOS ANTERIORES
  # ---------------------------------------------------------------------------
  # Elemento 92 (Despesas de Exerc√≠cios Anteriores)
  # Excluindo fontes vinculadas com termos de inativos
  
  `23  Despesas de Exerc√≠cios Anteriores` = list(
    criterio = "
    grupo_despesa_codigo_grupo == '1' &
    elemento_despesa_codigo == '92' &
    !(
      fonte_recursos_codigo %in% c('023', '024', '055', '056') &
      str_detect(natureza_despesa_detalhada_nome, 
                 'APOSENT|INAT|REFORMA|PEN|LEI 7\\\\.963/1989')
    )
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 24 - INATIVOS E PENSIONISTAS COM RECURSOS VINCULADOS
  # ---------------------------------------------------------------------------
  # Fontes vinculadas (023, 024, 055, 056) com:
  #   - Elementos de aposentadoria/pens√£o
  #   - OU elementos diversos com termos de inativos
  
  `24  Inativos e Pensionistas com Recursos Vinculados` = list(
    criterio = "
    grupo_despesa_codigo_grupo == '1' &
    fonte_recursos_codigo %in% c('023', '024', '055', '056') &
    (
      elemento_despesa_codigo %in% c('01', '03') |
      (
        elemento_despesa_codigo %in% c('05', '08', '09', '17', '91', '92', '94') &
        str_detect(natureza_despesa_detalhada_nome, 
                   'APOSENT|INAT|REFORMA|PEN|LEI 7\\\\.963/1989')
      )
    )
    "
  )
)

cat("‚úÖ Crit√©rios RGF Anexo 01 definidos\n")
cat(sprintf("   Total de categorias: %d\n", length(criterios_rgf_A01_pessoal_rgf)))
```

## Aplica√ß√£o dos Crit√©rios

```{r aplicar-criterios-rgf-a01}
#| code-fold: true
#| code-summary: "Ver c√≥digo de aplica√ß√£o dos crit√©rios"

# =============================================================================
# APLICA√á√ÉO DOS CRIT√âRIOS DE DESPESA COM PESSOAL
# =============================================================================
# Item de Informa√ß√£o:
#   - 25 = Despesa Liquidada
#   - 27 = Restos a Pagar N√£o Processados (RPNP)
# =============================================================================

# -----------------------------------------------------------------------------
# 1. Despesa Liquidada (item 25)
# -----------------------------------------------------------------------------

pessoal <- aplicar_criterios(
  rgf_a01 %>% filter(item_informacao_codigo == "25"),
  criterios_rgf_A01_pessoal_rgf,
  group_vars = c("categoria_pessoal")
)

cat(sprintf("‚úÖ Despesa liquidada processada: %d registros\n", nrow(pessoal)))

# -----------------------------------------------------------------------------
# 2. Restos a Pagar N√£o Processados (item 27)
# -----------------------------------------------------------------------------

pessoal_rp <- aplicar_criterios(
  rgf_a01 %>% filter(item_informacao_codigo == "27"),
  criterios_rgf_A01_pessoal_rgf,
  group_vars = c("categoria_pessoal")
)

cat(sprintf("‚úÖ RPNP processado: %d registros\n", nrow(pessoal_rp)))

# -----------------------------------------------------------------------------
# 3. Categorias para exibi√ß√£o
# -----------------------------------------------------------------------------

# Categorias com despesa liquidada + RPNP
categorias <- c("AP", "DF", "RR", "executivo")

# Categorias apenas com despesa liquidada (sem RPNP)
categorias_rp <- c("DF", "executivo")
```

## Fun√ß√£o para Gera√ß√£o das Tabelas

```{r funcao-tabela-rgf-a01}
#| code-fold: true
#| code-summary: "Ver fun√ß√£o de gera√ß√£o de tabelas"

# =============================================================================
# FUN√á√ÉO: gerar_tabela_pessoal
# =============================================================================
# Gera uma tabela DT com os valores de despesa com pessoal, pivotada por m√™s,
# incluindo RPNP quando dispon√≠vel.
#
# Par√¢metros:
#   data_pessoal    - Dataframe com despesa liquidada (item 25)
#   data_pessoal_rp - Dataframe com RPNP (item 27)
#   categoria_filtro - Categoria a exibir: "executivo", "AP", "RR", "DF"
#   formato_numero  - Se TRUE, formata n√∫meros com separador de milhar
#
# Retorno:
#   Objeto datatable formatado
# =============================================================================

gerar_tabela_pessoal <- function(
  data_pessoal, 
  data_pessoal_rp, 
  categoria_filtro, 
  formato_numero = TRUE
) {
  
  # ---------------------------------------------------------------------------
  # 1. Preparar dados de pessoal (item 25 - Liquidado)
  # ---------------------------------------------------------------------------
  
  pessoal_prep <- data_pessoal %>% 
    filter(categoria_pessoal == categoria_filtro) %>% 
    mutate(
      # Formatar m√™s/ano em mai√∫sculas (ex: JAN/25)
      mes_ano = toupper(format(data_lancamento, "%b/%y")),
      tipo = "pessoal"
    )
  
  # ---------------------------------------------------------------------------
  # 2. Preparar dados de RPNP (item 27) - se existirem
  # ---------------------------------------------------------------------------
  
  rp_prep <- data_pessoal_rp %>% 
    filter(categoria_pessoal == categoria_filtro)
  
  if (nrow(rp_prep) > 0) {
    rp_prep <- rp_prep %>%
      mutate(
        mes_ano = "RPNP",  # Coluna fixa para RPNP
        tipo = "rp"
      )
  }
  
  # ---------------------------------------------------------------------------
  # 3. Combinar pessoal + RPNP
  # ---------------------------------------------------------------------------
  
  dados_combinados <- bind_rows(pessoal_prep, rp_prep)
  
  # ---------------------------------------------------------------------------
  # 4. Criar tabela pivotada
  # ---------------------------------------------------------------------------
  
  # Ordenar meses cronologicamente
  dados_combinados <- dados_combinados %>%
    arrange(data_lancamento) %>%
    mutate(mes_ano = factor(mes_ano, levels = unique(mes_ano)))
  
  # Pivotar: linhas = categoria, colunas = m√™s
  tabela <- dados_combinados %>% 
    group_by(mes_ano, categoria) %>% 
    summarise(valor = sum(valor / 1000), .groups = "drop") %>%  # Em milhares
    pivot_wider(
      names_from = mes_ano, 
      values_from = valor, 
      values_fill = 0
    )
  
  # ---------------------------------------------------------------------------
  # 5. Adicionar coluna de TOTAL (√∫ltimos 12 meses)
  # ---------------------------------------------------------------------------
  
  # Identificar colunas de meses (exceto categoria e RPNP)
  colunas_meses <- setdiff(names(tabela), c("categoria", "RPNP"))
  
  # Calcular total dos 12 meses
  tabela <- tabela %>%
    mutate(
      `TOTAL (√öLTIMOS 12 MESES)` = rowSums(
        select(., all_of(colunas_meses)), 
        na.rm = TRUE
      )
    )
  
  # Reordenar colunas: categoria, meses, total, RPNP
  if ("RPNP" %in% names(tabela)) {
    tabela <- tabela %>%
      select(categoria, all_of(colunas_meses), `TOTAL (√öLTIMOS 12 MESES)`, RPNP)
  } else {
    tabela <- tabela %>%
      select(categoria, all_of(colunas_meses), `TOTAL (√öLTIMOS 12 MESES)`)
  }
  
  # ---------------------------------------------------------------------------
  # 6. Criar DataTable
  # ---------------------------------------------------------------------------
  
  dt <- datatable(
    tabela,
    caption = paste("Despesa com Pessoal -", categoria_filtro, "(R$ milhares)"),
    rownames = FALSE,
    options = list(
      pageLength = -1,      # Mostrar todas as linhas
      scrollX = TRUE,       # Scroll horizontal
      dom = 'ft'            # Apenas filtro e tabela
    )
  )
  
  # ---------------------------------------------------------------------------
  # 7. Formatar n√∫meros
  # ---------------------------------------------------------------------------
  
  if (formato_numero) {
    colunas_numericas <- which(sapply(tabela, is.numeric))
    
    dt <- dt %>% 
      formatRound(
        columns = colunas_numericas, 
        digits = 0,           # Sem casas decimais
        mark = ".",           # Separador de milhar
        dec.mark = ","        # Separador decimal
      )
  }
  
  return(dt)
}
```

## Resultados

### Poder Executivo Federal

```{r resultado-executivo-rgf-a01}
#| code-fold: true
#| column: screen

gerar_tabela_pessoal(pessoal, pessoal_rp, "executivo")
```

### Amap√° (AP)

```{r resultado-ap-rgf-a01}
#| code-fold: true
#| column: screen

gerar_tabela_pessoal(pessoal, pessoal_rp, "AP")
```

### Roraima (RR)

```{r resultado-rr-rgf-a01}
#| code-fold: true
#| column: screen

gerar_tabela_pessoal(pessoal, pessoal_rp, "RR")
```

### Distrito Federal (DF)

```{r resultado-df-rgf-a01}
#| code-fold: true
#| column: screen

gerar_tabela_pessoal(pessoal, pessoal_rp, "DF")
```

## Notas Metodol√≥gicas

```{r notas-rgf-a01}
#| echo: false

# =============================================================================
# NOTAS METODOL√ìGICAS
# =============================================================================

notas <- tibble::tribble(
  ~Item, ~Descri√ß√£o,
  "1", "Valores em R$ milhares",
  "2", "Despesa Liquidada = Item de Informa√ß√£o 25",
  "3", "RPNP = Restos a Pagar N√£o Processados (Item 27)",
  "4", "Total 12 meses = Soma dos √∫ltimos 12 meses de despesa liquidada",
  "5", "Padr√µes de texto (APOSENT, INAT, etc.) usados para identificar despesas com inativos",
  "6", "Fontes vinculadas (023, 024, 055, 056) = Recursos previdenci√°rios"
)

knitr::kable(notas, col.names = c("Item", "Descri√ß√£o"))
```

## Observa√ß√µes Importantes

::: callout-warning
### Falsos Positivos na Detec√ß√£o de Termos

O padr√£o `PEN` captura tanto **PENS√ïES** (correto) quanto termos como **COMPENSA√á√ïES** e **DEPEND√äNCIAS** (falsos positivos). Aten√ß√£o especial deve ser dada √† an√°lise de:

-   REFORMA - pode capturar "REFORMA AGR√ÅRIA" (falso positivo)
-   PEN - captura "COMPENSA√á√ïES" indevidamente
:::

::: callout-note
### Filtros do Tesouro Gerencial

O Tesouro Gerencial usa o operador **"Cont√©m"** para detec√ß√£o de termos, que √© equivalente ao padr√£o sem word boundaries (`\\b`) em R. Isso pode gerar falsos positivos que devem ser tratados manualmente.
:::

# üìã RGF Anexo 02 - D√≠vida Consolidada L√≠quida {#sec-rgf-a02}

## Ficha T√©cnica

```{r ficha-tecnica-rgf-a02}
#| echo: false

# =============================================================================
# FICHA T√âCNICA DO ANEXO
# =============================================================================

ficha_tecnica <- tibble::tribble(
  ~Campo,                 ~Informa√ß√£o,
  "Relat√≥rio",            "RGF - Relat√≥rio de Gest√£o Fiscal",
  "Anexo",                "Anexo 02",
  "Nome",                 "Demonstrativo da D√≠vida Consolidada L√≠quida - DCL",
  "Base Legal",           "LRF Art. 55, inciso I, al√≠nea 'b'",
  "Periodicidade",        "Quadrimestral",
  "Grau de Dificuldade",  "‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Muito Dif√≠cil",
  "√öltima Atualiza√ß√£o",   format(Sys.Date(), "%d/%m/%Y")
)

knitr::kable(ficha_tecnica, col.names = c("Campo", "Informa√ß√£o"))
```

## Arquivos Necess√°rios

```{r arquivos-rgf-a02}
#| echo: false

# =============================================================================
# ARQUIVOS DO TESOURO GERENCIAL UTILIZADOS
# =============================================================================
# O Anexo 02 utiliza M√öLTIPLAS bases de dados com filtros espec√≠ficos

arquivos <- tibble::tribble(
  ~Arquivo,                                    ~Descri√ß√£o,                                    ~Filtros_TG,
  "rgf_a02_precatorios.xlsx",                  "Precat√≥rios posteriores a 05/05/2000",        "Or√ß. Fiscal, Contas espec√≠ficas",
  "rgf_a02_rp_exceto_170600.xlsx",             "RP processados (exceto UG 170600)",           "Contas espec√≠ficas, UG != 170600, A√ß√£o != 0005",
  "rgf_a02_rp_todas_ugs.xlsx",                 "RP processados (todas UGs)",                  "Contas espec√≠ficas, A√ß√£o != 0005",
  "rgf_a02_ug_170512.xlsx",                    "D√≠vida assumida e renegociada",               "Or√ß. Fiscal, UG = 170512",
  "rgf_a02_creditos_bancarios.xlsx",           "Cr√©ditos banc√°rios",                          "Or√ß. Fiscal, UG IN (170705, 170526, 170700)",
  "rgf_a02_entidade.xlsx",                     "D√≠vida mobili√°ria por entidade",              "Or√ß. Fiscal, Contas espec√≠ficas",
  "rgf_a02_aplicacao_titulos_publicos.xlsx",   "Aplica√ß√µes em t√≠tulos p√∫blicos",              "Or√ß. Fiscal, √ìrg√£o UGE != 25901, Tipo Admin IN (3,4,5,6,8)",
  "rgf_a02_balancete.xlsx",                    "Balancete geral (principal)",                 "Or√ß. Fiscal",
  "rgf_a02_balancete_fat.xlsx",                "Disponibilidades FAT",                        "Or√ß. Fiscal, UG = 380916",
  "rgf_a02_balancete_fundos.xlsx",             "Aplica√ß√µes em fundos (Tipo Admin 7)",         "Or√ß. Fiscal, √ìrg√£o != 25915,37904, Tipo Admin = 7",
  "rgf_a02_balancete_fundos_111215100.xlsx",   "Aplica√ß√µes em fundos (conta espec√≠fica)",     "Or√ß. Fiscal, √ìrg√£o != 25915,37904, Conta = 111215100",
  "rgf_a02_balancete_deducoes_depositos_a_vista.xlsx", "Dep√≥sitos √† vista (dedu√ß√µes)",        "Or√ß. Fiscal, √ìrg√£o != 25901, UG != 380916",
  "rgf_a02_dcl_passivo_atuarial.xlsx",         "Passivo atuarial (RPPS e militares)",         "Or√ß. Fiscal"
)

knitr::kable(arquivos, col.names = c("Arquivo", "Descri√ß√£o", "Filtros no TG"))
```

## Atributos Utilizados

```{r atributos-rgf-a02}
#| echo: false

# =============================================================================
# ATRIBUTOS (COLUNAS) DOS ARQUIVOS E SEUS USOS
# =============================================================================

atributos <- tibble::tribble(
  ~Atributo,                   ~Tipo,       ~Uso,                  ~Descri√ß√£o,
  "conta_contabil_numero",     "character", "TG / Crit√©rio",       "N√∫mero da conta cont√°bil (PCASP)",
  "conta_contabil_nome",       "character", "TG / Apresenta√ß√£o",   "Nome da conta cont√°bil",
  "entidade_c_cor_numero",     "character", "TG / Crit√©rio",       "C√≥digo da entidade/conta corrente",
  "entidade_c_cor_nome",       "character", "TG / Crit√©rio",       "Nome da entidade (para detec√ß√£o de padr√µes)",
  "conta_corrente",            "character", "TG / Crit√©rio",       "Conta corrente espec√≠fica",
  "acao_governo_codigo",       "character", "TG / Crit√©rio",       "C√≥digo da a√ß√£o de governo",
  "unidade_orcamentaria_codigo","character","TG / Crit√©rio",       "C√≥digo da UO",
  "ug_executora_codigo",       "character", "TG / Crit√©rio",       "C√≥digo da UG executora",
  "isf_lancamento",            "character", "TG / Crit√©rio",       "Indicador de Super√°vit Financeiro (P=Prim√°rio)",
  "c_con_subgrupo_3_nome",     "character", "TG / Crit√©rio",       "Nome do subgrupo cont√°bil",
  "mes_lancamento",            "numeric",   "TG / R",              "M√™s do lan√ßamento (YYYYMM)",
  "saldo_r_conta_contabil",    "numeric",   "TG / R",              "Saldo da conta cont√°bil",
  "data_lancamento",           "Date",      "R",                   "Data calculada do lan√ßamento"
)

knitr::kable(atributos, col.names = c("Atributo", "Tipo", "Uso", "Descri√ß√£o"))
```

## V√≠nculos com Outros Anexos

```{r vinculos-rgf-a02}
#| echo: false

# =============================================================================
# RELACIONAMENTO COM OUTROS ANEXOS
# =============================================================================

vinculos <- tibble::tribble(
  ~Anexo_Relacionado,   ~Tipo_V√≠nculo,    ~Descri√ß√£o,
  "RREO Anexo 03",      "Refer√™ncia",     "RCL utilizada para c√°lculo do limite da DCL",
  "RGF Anexo 05",       "Refer√™ncia",     "Disponibilidades para c√°lculo de liquidez",
  "RGF Anexo 06",       "Consolida√ß√£o",   "Valores consolidados no demonstrativo simplificado"
)

knitr::kable(vinculos, col.names = c("Anexo Relacionado", "Tipo de V√≠nculo", "Descri√ß√£o"))
```

## Estrutura do Demonstrativo

```{r estrutura-rgf-a02}
#| echo: false

# =============================================================================
# ESTRUTURA DO DEMONSTRATIVO - COMPONENTES DA DCL
# =============================================================================

estrutura <- tibble::tribble(
  ~Ordem, ~Item,                                           ~Sinal,
  "01",   "D√≠vida Mobili√°ria TN Interna",                   "+",
  "02",   "Aplica√ß√£o em T√≠tulos P√∫blicos (dedu√ß√£o)",        "-",
  "03",   "D√≠vida Mobili√°ria TN em BCB",                    "+",
  "04",   "D√≠vida Securitizada",                            "+",
  "05",   "D√≠vida Mobili√°ria Externa",                      "+",
  "06",   "Opera√ß√µes de Equaliza√ß√£o Cambial",               "+",
  "07",   "Demais D√≠vidas Contratuais",                     "+",
  "08",   "Precat√≥rios posteriores a 05/05/2000",           "+",
  "09",   "D√≠vida Assumida pela Uni√£o",                     "+",
  "10",   "Passivos por Insufici√™ncia de Recursos",         "+",
  "11",   "Dep√≥sitos do TN em BCB (dedu√ß√£o)",               "-",
  "12",   "Dep√≥sitos √† Vista (dedu√ß√£o)",                    "-",
  "13",   "Disponibilidades FAT (dedu√ß√£o)",                 "-",
  "14",   "Aplica√ß√µes em Fundos Diversos 1 (dedu√ß√£o)",      "-",
  "15",   "Aplica√ß√µes em Fundos Diversos 2 (dedu√ß√£o)",      "-",
  "16",   "Aplica√ß√µes em Fundos Diversos 3 (dedu√ß√£o)",      "-",
  "17",   "D√≠vidas Renegociadas (dedu√ß√£o)",                 "-",
  "18",   "Cr√©ditos Lei 8.727/93 (dedu√ß√£o)",                "-",
  "19",   "D√≠vida Externa Renegociada (dedu√ß√£o)",           "-",
  "20",   "Demais D√≠vidas Renegociadas (dedu√ß√£o)",          "-",
  "21",   "Ajustes para Perdas (positivo)",                 "+",
  "22",   "Outros Cr√©ditos Banc√°rios (dedu√ß√£o)",            "-",
  "23",   "Outros Cr√©ditos Banc√°rios - Ajustes",            "+",
  "24",   "Resultado Positivo TN/BCB (dedu√ß√£o)",            "-",
  "25",   "Restos a Pagar Processados",                     "+",
  "26",   "D√≠vida Mobili√°ria TN Interna INTRA (dedu√ß√£o)",   "-",
  "38",   "Precat√≥rios (ajuste s/ a√ß√µes 0005 e 0EC7)",      "-",
  "40",   "RPPS Civil (passivo atuarial)",                  "+",
  "41",   "Despesas Previdenci√°rias FCDF",                  "+",
  "42",   "Militares Inativos",                             "+",
  "43",   "Pens√µes Militares",                              "+"
)

knitr::kable(estrutura, col.names = c("Ordem", "Item", "Sinal"))
```

## Crit√©rios de Classifica√ß√£o

### Base: Precat√≥rios

```{r criterios-precatorios}
#| code-fold: true
#| code-summary: "Ver crit√©rios - Precat√≥rios"

# =============================================================================
# BASE: rgf_a02_precatorios
# Filtros TG: Or√ßamento Fiscal, Contas espec√≠ficas
# =============================================================================

criterios_rgf_A02_dcl_precatorios <- list(
  
  # ---------------------------------------------------------------------------
  # 08 - PRECAT√ìRIOS POSTERIORES A 05/05/2000
  # ---------------------------------------------------------------------------
  # Inclui a√ß√µes de precat√≥rios, exceto conta 622130400
  # A√ß√£o 0Z01 apenas se UO = 71103
  
  `08 Precat√≥rios posteriores a 05/05/2000` = list(
    criterio = "
    conta_contabil_numero != c('622130400') &
    acao_governo_codigo %in% c('0005', '00U9', '00UP', '0EC8', '0EC7', '00WU') |
    (unidade_orcamentaria_codigo == '71103' & acao_governo_codigo == '0Z01')
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 38 - PRECAT√ìRIOS (AJUSTE SEM A√á√ïES 0005 e 0EC7)
  # ---------------------------------------------------------------------------
  # Conta espec√≠fica 622130400 com a√ß√µes 0005 e 0EC7
  
  `38 Precat√≥rios posteriores a 05/05/2000 sem a√ß√£o 0005 e 0EC7` = list(
    criterio = "
    conta_contabil_numero == c('622130400') & 
    acao_governo_codigo %in% c('0005', '0EC7') |
    (unidade_orcamentaria_codigo == '71103' & acao_governo_codigo == '0Z01')
    "
  )
)
```

### Base: Restos a Pagar

```{r criterios-rp}
#| code-fold: true
#| code-summary: "Ver crit√©rios - Restos a Pagar"

# =============================================================================
# BASE: rgf_a02_rp_exceto_170600
# Filtros TG: Contas espec√≠ficas, UG != 170600, A√ß√£o != 0005
# =============================================================================

criterios_rgf_A02_dcl_rp_exceto_170600 <- list(
  
  `25 Restos a pagar processados parte 1` = list(
    criterio = "TRUE"
  )
)

# =============================================================================
# BASE: rgf_a02_rp_todas_ugs
# Filtros TG: Contas espec√≠ficas, A√ß√£o != 0005
# =============================================================================

criterios_rgf_A02_dcl_rp_todas_ugs <- list(
  
  `25 Restos a pagar processados parte 2` = list(
    criterio = "TRUE"
  )
)
```

### Base: UG 170512 (STN)

```{r criterios-ug170512}
#| code-fold: true
#| code-summary: "Ver crit√©rios - UG 170512"

# =============================================================================
# BASE: rgf_a02_ug_170512
# Filtros TG: Or√ßamento Fiscal, UG = 170512 (Secretaria do Tesouro Nacional)
# =============================================================================

criterios_rgf_A02_dcl_ug_170512 <- list(
  
  # ---------------------------------------------------------------------------
  # 09 - D√çVIDA ASSUMIDA PELA UNI√ÉO
  # ---------------------------------------------------------------------------
  
  `09 D√≠vida assumida pela Uni√£o` = list(
    criterio = "
    conta_contabil_numero %in% c('218912600', '228911600', '227310401') &
    isf_lancamento == 'P' &
    conta_corrente != 'PF1705118'
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 17 - D√çVIDAS RENEGOCIADAS (DEDU√á√ÉO)
  # ---------------------------------------------------------------------------
  # Leis 9.496/97 e 2.185/2001
  
  `17 D√≠vidas renegociadas dedu√ß√£o` = list(
    criterio = "
    conta_contabil_numero %in% c(
      '121110301', '112410100', '121110318', '112410600', 
      '121140301', '121150301', '112440100', '112450100', 
      '121140318', '121150318', '112440600', '112450600', 
      '112410401', '112450401', '112440401', '121249818', 
      '113814200', '113844200', '113854200'
    ) &
    (entidade_c_cor_numero %in% c(
      'PF1705320', 'PF1705524', 'PF1705528', 'PF1705546', 
      'PF1705547', 'PF1705548', 'PF1705406', 'PF1705525', 
      'PF1705529', 'PF1705544', 'PF1705545'
    ) |
    grepl('9\\\\.496/97', entidade_c_cor_nome) |
    grepl('2\\\\.185/2001', entidade_c_cor_nome))
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 18 - CR√âDITOS LEI 8.727/93 (DEDU√á√ÉO)
  # ---------------------------------------------------------------------------
  
  `18 Cr√©ditos Lei 8.727/93 dedu√ß√£o` = list(
    criterio = "
    conta_contabil_numero %in% c(
      '121110301', '112410100', '121110318', '112410600', 
      '121140301', '121150301', '112440100', '112450100', 
      '121140318', '121150318', '112440600', '112450600', 
      '112410401', '121219818', '112450401', '112440401', 
      '121249818', '113814200', '113844200', '113854200'
    ) &
    (entidade_c_cor_numero %in% c('PF1705109', 'PF1705536', 'TN0000016', 'TN0000017') |
     grepl('8\\\\.727/93', entidade_c_cor_nome))
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 19 - D√çVIDA EXTERNA RENEGOCIADA (DEDU√á√ÉO)
  # ---------------------------------------------------------------------------
  
  `19 D√≠vida externa renegociada dedu√ß√£o` = list(
    criterio = "
    conta_contabil_numero %in% c(
      '121110301', '112410100', '121110318', '112410600', 
      '121140301', '121150301', '112440100', '112450100', 
      '121140318', '121150318', '112440600', '112450600', 
      '112410401', '121219818', '112450401', '112440401', 
      '121249818', '113844200', '113814200', '113854200', 
      '121259818'
    ) &
    (entidade_c_cor_numero %in% c(
      'PF1705104', 'PF1705114', 'PF1705117', 'PF1705521', 
      'PF1705534', 'PF1705116', 'PF1705531', 'PF1705532', 
      'PF1705113', 'PF1701536', 'PF1705520', 'PF1705533', 
      'PF1705464', 'PF1705534', 'PF1705119', 'PF1705384'
    ) |
    grepl('DMLP', entidade_c_cor_nome) |
    grepl('FRANCA|FRAN√áA', entidade_c_cor_nome) |
    grepl('EXTER', entidade_c_cor_nome) |
    grepl('MF 030', entidade_c_cor_nome) |
    grepl('BIB', entidade_c_cor_nome))
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 20 - DEMAIS D√çVIDAS RENEGOCIADAS (DEDU√á√ÉO)
  # ---------------------------------------------------------------------------
  
  `20 Demais d√≠vidas renegociadas dedu√ß√£o` = list(
    criterio = "
    conta_contabil_numero %in% c(
      '121110301', '112410100', '121110318', '112410600', 
      '121140301', '121150301', '112440100', '112450100', 
      '121140318', '121150318', '112440600', '112450600', 
      '112410401', '112450401', '112440401', '121249818', 
      '113844200', '113814200', '113854200', '121259818'
    )
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 21 - AJUSTES PARA PERDAS (POSITIVO)
  # ---------------------------------------------------------------------------
  
  `21 Ajustes para perdas (positivo)` = list(
    criterio = "
    conta_contabil_numero %in% c(
      '112940401', '112950401', '113940101', '112910401', 
      '113950101', '121119902', '121149904', '121159904', 
      '121119904', '121249903', '121259903'
    )
    "
  )
)
```

### Base: Cr√©ditos Banc√°rios

```{r criterios-creditos-bancarios}
#| code-fold: true
#| code-summary: "Ver crit√©rios - Cr√©ditos Banc√°rios"

# =============================================================================
# BASE: rgf_a02_creditos_bancarios
# Filtros TG: Or√ßamento Fiscal, UG IN (170705, 170526, 170700)
# =============================================================================

criterios_rgf_A02_dcl_creditos_bancarios <- list(
  
  # ---------------------------------------------------------------------------
  # 22 - OUTROS CR√âDITOS BANC√ÅRIOS (DEDU√á√ÉO)
  # ---------------------------------------------------------------------------
  
  `22 Outros cr√©ditos banc√°rios dedu√ß√£o` = list(
    criterio = "
    conta_contabil_numero %in% c(
      '112410301', '112410303', '112440301', '112450301', 
      '112440303', '112450303', '112410100', '121110301', 
      '121110314', '121110308', '121140301', '121150301', 
      '121140308', '121150308', '112411300', '121110316', 
      '121110320', '112410302', '112410304', '112410201', 
      '112410203', '112410403', '121110312'
    )
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 23 - OUTROS CR√âDITOS BANC√ÅRIOS - AJUSTES (POSITIVO)
  # ---------------------------------------------------------------------------
  
  `23 Outros cr√©ditos banc√°rios ajustes (positivo)` = list(
    criterio = "
    conta_contabil_numero %in% c('112910401', '121119904', '121119907', '112910403')
    "
  )
)
```

### Base: Entidade (D√≠vida Mobili√°ria)

```{r criterios-entidade}
#| code-fold: true
#| code-summary: "Ver crit√©rios - Entidade"

# =============================================================================
# BASE: rgf_a02_entidade
# Filtros TG: Or√ßamento Fiscal, Contas espec√≠ficas
# =============================================================================

criterios_rgf_A02_dcl_entidade <- list(
  
  # ---------------------------------------------------------------------------
  # 01 - D√çVIDA MOBILI√ÅRIA TN INTERNA
  # ---------------------------------------------------------------------------
  # T√≠tulos p√∫blicos federais (LTN, LFT, NTN-B, NTN-F, etc.)
  
  `01 D√≠vida mobili√°ria TN interna` = list(
    criterio = "
    conta_contabil_numero %in% c(
      '899913900', '899913901', '899913902', '899913903', 
      '899913904', '899913905', '899913906'
    ) &
    entidade_c_cor_numero %in% c(
      'DP1000001', 'DP1400001', 'DP1500001', 'DP1700001', 
      'DP1800001', 'DP2000001', 'DP2300007', 'DP2400001', 
      'DP2600001', 'DP2800001', 'DP3000001', 'DP3400001', 
      'DP5000001', 'DP5500001', 'DP5800001', 'DP6100001', 
      'DP6200001', 'DP6300001', 'DP6600001', 'DP7000001', 
      'DP8000001', 'DP9000001', 'DP9102001', 'DP1200001'
    )
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 03 - D√çVIDA MOBILI√ÅRIA TN EM BCB
  # ---------------------------------------------------------------------------
  # T√≠tulos em carteira do Banco Central
  
  `03 D√≠vida mobili√°ria do TN (em BCB)` = list(
    criterio = "
    conta_contabil_numero %in% c('899913901', '899913902', '899913907', '899913908') &
    entidade_c_cor_numero %in% c(
      'DP1500010', 'DP1700010', 'DP1800010', 'DP2300010', 
      'DP5500010', 'DP7000010', 'DP9000010', 'DP3201450'
    )
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 04 - D√çVIDA SECURITIZADA
  # ---------------------------------------------------------------------------
  # T√≠tulos de securitiza√ß√£o e TDA
  
  `04 D√≠vida securitizada` = list(
    criterio = "
    (conta_contabil_numero %in% c(
      '899913900', '899913901', '899913902', '899913903', 
      '899913904', '899913905', '899913906'
    ) &
    entidade_c_cor_numero %in% c(
      'DP3100001', 'DP3200001', 'DP3200002', 'DP3201031', 
      'DP3201032', 'DP3201059', 'DP3201077', 'DP3201078', 
      'DP3201080', 'DP3201081', 'DP3201145', 'DP3201202', 
      'DP3201222', 'DP3201228', 'DP3201233', 'DP3201250', 
      'DP3201256', 'DP3201257', 'DP3201258', 'DP3201259', 
      'DP3201260', 'DP3201262', 'DP3201271', 'DP3201272', 
      'DP3201275', 'DP3201276', 'DP3201277', 'DP3201280', 
      'DP3201281', 'DP3201296', 'DP3201299', 'DP3201362', 
      'DP3201368', 'DP3201378', 'DP3201390'
    )) |
    conta_contabil_numero %in% c('212110202', '222110102')
    "
  )
)
```

### Base: Aplica√ß√£o em T√≠tulos P√∫blicos

```{r criterios-aplicacao-titulos}
#| code-fold: true
#| code-summary: "Ver crit√©rios - Aplica√ß√£o em T√≠tulos"

# =============================================================================
# BASE: rgf_a02_aplicacao_titulos_publicos
# Filtros TG: Or√ßamento Fiscal, √ìrg√£o UGE != 25901,
#             Tipo Admin IN (3,4,5,6,8), Conta come√ßa com 1111150
# =============================================================================

criterios_rgf_A02_dcl_aplicacao_titulos_publicos <- list(
  
  # ---------------------------------------------------------------------------
  # 02 - APLICA√á√ÉO EM T√çTULOS P√öBLICOS (DEDU√á√ÉO)
  # ---------------------------------------------------------------------------
  # Exclui contas espec√≠ficas que n√£o devem ser deduzidas
  
  `02 Aplica√ß√£o em t√≠tulos p√∫blicos` = list(
    criterio = "
    !conta_contabil_numero %in% c('111115005', '111115011', '111115012')
    "
  )
)
```

### Base: Balancete (Principal)

```{r criterios-balancete}
#| code-fold: true
#| code-summary: "Ver crit√©rios - Balancete"

# =============================================================================
# BASE: rgf_a02_balancete (renomeado de rgf_a02_balancete)
# Filtros TG: Or√ßamento Fiscal
# NOTA: Esta base √© usada em diversos anexos al√©m do RGF A02
# =============================================================================

criterios_rgf_A02_dcl_balancete <- list(
  
  # ---------------------------------------------------------------------------
  # 05 - D√çVIDA MOBILI√ÅRIA EXTERNA
  # ---------------------------------------------------------------------------
  
  `05 D√≠vida mobili√°ria externa` = list(
    criterio = "
    conta_contabil_numero %in% c('899913903', '899913904')
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 06 - OPERA√á√ïES DE EQUALIZA√á√ÉO CAMBIAL
  # ---------------------------------------------------------------------------
  
  `06 Opera√ß√µes de equaliza√ß√£o cambial` = list(
    criterio = "
    conta_contabil_numero %in% c('218912902', '218942902', '218952902', '218912901')
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 07 - DEMAIS D√çVIDAS CONTRATUAIS
  # ---------------------------------------------------------------------------
  
  `07 Demais d√≠vidas contratuais` = list(
    criterio = "
    isf_lancamento == 'P' &
    conta_contabil_numero %in% c(
      '222210200', '212210300', '222110200', '212110301', '212110303', '212510103',
      '212140303', '212150303', '212540103', '212550103', '212140301', '212150301',
      '217310301', '217310602', '217350402', '227310301', '212110700', '212210601',
      '212310201', '212310202', '212410201', '222310101', '222310102', '222410101',
      '217710101', '227710101', '227310401'
    )
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 10 - PASSIVOS POR INSUFICI√äNCIA DE RECURSOS
  # ---------------------------------------------------------------------------
  
  `10 Passivos por insufici√™ncia de recursos` = list(
    criterio = "
    conta_contabil_numero %in% c(
      '213110400', '211110101', '214419800', '223110100', 
      '211210100', '213140400', '213150400', 
      '214119900', '211459800', '211419800'
    ) &
    isf_lancamento == 'P'
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 11 - DEP√ìSITOS DO TN EM BCB (DEDU√á√ÉO)
  # ---------------------------------------------------------------------------
  
  `11 Dep√≥sitos do TN (em BCB) dedu√ß√£o` = list(
    criterio = "
    startsWith(conta_contabil_numero, '1111102') |
    startsWith(conta_contabil_numero, '1111103') |
    startsWith(conta_contabil_numero, '1111104')
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 12 - DEP√ìSITOS √Ä VISTA (DEDU√á√ÉO) - PARTE 1
  # ---------------------------------------------------------------------------
  
  `12 Dep√≥sitos √† vista dedu√ß√£o` = list(
    criterio = "
    startsWith(conta_contabil_numero, '1112102') |
    startsWith(conta_contabil_numero, '1112103') |
    startsWith(conta_contabil_numero, '1112150') |
    startsWith(conta_contabil_numero, '1112152')
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 24 - RESULTADO POSITIVO TN/BCB (DEDU√á√ÉO)
  # ---------------------------------------------------------------------------
  
  `24 Resultado positivo TN/BCB dedu√ß√£o` = list(
    criterio = "
    conta_contabil_numero %in% c('113813001', '113813002')
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 26 - D√çVIDA MOBILI√ÅRIA TN INTERNA INTRA (DEDU√á√ÉO)
  # ---------------------------------------------------------------------------
  
  `26 D√≠vida mobili√°ria TN interna (intra) dedu√ß√£o` = list(
    criterio = "
    conta_contabil_numero == '222120101'
    "
  )
)
```

### Base: Balancete FAT

```{r criterios-balancete-fat}
#| code-fold: true
#| code-summary: "Ver crit√©rios - Balancete FAT"

# =============================================================================
# BASE: rgf_a02_balancete_fat
# Filtros TG: Or√ßamento Fiscal, UG = 380916
# =============================================================================

criterios_rgf_A02_dcl_balancete_fat <- list(
  
  # ---------------------------------------------------------------------------
  # 13 - DISPONIBILIDADES FAT (DEDU√á√ÉO)
  # ---------------------------------------------------------------------------
  
  `13 Disponibilidade FAT dedu√ß√£o` = list(
    criterio = "
    startsWith(conta_contabil_numero, '1111119') |
    startsWith(conta_contabil_numero, '1124103') |
    startsWith(conta_contabil_numero, '1135407') |
    startsWith(conta_contabil_numero, '1135113') |
    startsWith(conta_contabil_numero, '1135115') |
    startsWith(conta_contabil_numero, '1124101') |
    startsWith(conta_contabil_numero, '1135111') |
    startsWith(conta_contabil_numero, '1135107') |
    startsWith(conta_contabil_numero, '11121') |
    startsWith(conta_contabil_numero, '1135114') |
    startsWith(conta_contabil_numero, '1135112') |
    startsWith(conta_contabil_numero, '1135116') |
    startsWith(conta_contabil_numero, '1211503') |
    startsWith(conta_contabil_numero, '1211403') |
    startsWith(conta_contabil_numero, '1211103') |
    startsWith(conta_contabil_numero, '1135507') |
    startsWith(conta_contabil_numero, '1212105') |
    conta_contabil_numero %in% c(
      '111115009', '111115011', '111115014', 
      '111115015', '111115016', '111115006'
    )
    "
  )
)
```

### Base: Balancete Fundos

```{r criterios-balancete-fundos}
#| code-fold: true
#| code-summary: "Ver crit√©rios - Balancete Fundos"

# =============================================================================
# BASE: rgf_a02_balancete_fundos_111215100
# Filtros TG: Or√ßamento Fiscal, √ìrg√£o != 25915,37904, Conta = 111215100
# =============================================================================

criterios_rgf_A02_dcl_balancete_fundos_111215100 <- list(
  
  `14 Aplica√ß√µes em fundos diversos 1 dedu√ß√£o` = list(
    criterio = "TRUE"
  )
)

# =============================================================================
# BASE: rgf_a02_balancete_fundos
# Filtros TG: Or√ßamento Fiscal, √ìrg√£o != 25915,37904, Tipo Admin = 7
# =============================================================================

criterios_rgf_A02_dcl_balancete_fundos <- list(
  
  # ---------------------------------------------------------------------------
  # 15 - APLICA√á√ïES EM FUNDOS DIVERSOS 2 (DEDU√á√ÉO)
  # ---------------------------------------------------------------------------
  
  `15 Aplica√ß√µes em fundos diversos 2 dedu√ß√£o` = list(
    criterio = "
    startsWith(conta_contabil_numero, '23')
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 16 - APLICA√á√ïES EM FUNDOS DIVERSOS 3 (DEDU√á√ÉO)
  # ---------------------------------------------------------------------------
  
  `16 Aplica√ß√µes em fundos diversos 3 dedu√ß√£o` = list(
    criterio = "
    startsWith(conta_contabil_numero, '1111102') |
    startsWith(conta_contabil_numero, '1111103') |
    startsWith(conta_contabil_numero, '1111104') |
    startsWith(conta_contabil_numero, '1111119') |
    conta_contabil_numero %in% c('111210200', '111210300', '111215000', '111215200') |
    (startsWith(conta_contabil_numero, '1111102') & ug_executora_codigo != '380916') |
    c_con_subgrupo_3_nome %in% c('INVESTIMENTOS', 'IMOBILIZADO', 'INTANGIVEL', 'DIFERIDO')
    "
  )
)

# =============================================================================
# BASE: rgf_a02_balancete_deducoes_depositos_a_vista
# Filtros TG: Or√ßamento Fiscal, √ìrg√£o != 25901, UG != 380916
# =============================================================================

criterios_rgf_A02_dcl_balancete_deducoes_depositos_a_vista <- list(
  
  `12 Dep√≥sitos √† vista dedu√ß√£o` = list(
    criterio = "
    startsWith(conta_contabil_numero, '1111119')
    "
  )
)
```

### Base: Passivo Atuarial

```{r criterios-passivo-atuarial}
#| code-fold: true
#| code-summary: "Ver crit√©rios - Passivo Atuarial"

# =============================================================================
# BASE: rgf_a02_dcl_passivo_atuarial
# Filtros TG: Or√ßamento Fiscal
# =============================================================================

criterios_rgf_A02_dcl_passivo_atuarial <- list(
  
  # ---------------------------------------------------------------------------
  # 40 - RPPS CIVIL
  # ---------------------------------------------------------------------------
  
  `40 RPPS civil` = list(
    criterio = "
    ug_executora_codigo == '400043' &
    conta_contabil_numero %in% c(
      '217919900', '227210301', '227210303', '227210304', 
      '227210401', '227210402', '227210403', '227210404'
    )
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 41 - DESPESAS PREVIDENCI√ÅRIAS DO FCDF
  # ---------------------------------------------------------------------------
  
  `41 Despesas previdenci√°rias do FCDF` = list(
    criterio = "
    ug_executora_codigo == '170392' &
    conta_contabil_numero %in% c(
      '217919900', '227210301', '227210303', '227210304', 
      '227210401', '227210402', '227210403', '227210404'
    )
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 42 - MILITARES INATIVOS
  # ---------------------------------------------------------------------------
  
  `42 Militares inativos` = list(
    criterio = "
    ug_executora_codigo %in% c('120052', '160063', '773200') &
    conta_contabil_numero %in% c('217910700', '227910700')
    "
  ),
  
  # ---------------------------------------------------------------------------
  # 43 - PENS√ïES MILITARES
  # ---------------------------------------------------------------------------
  
  `43 Pens√µes militares` = list(
    criterio = "
    ug_executora_codigo %in% c('120052', '160063', '773200') &
    conta_contabil_numero %in% c('217910600', '227910600')
    "
  )
)
```

## Aplica√ß√£o dos Crit√©rios

```{r aplicar-criterios-rgf-a02}
#| code-fold: true
#| code-summary: "Ver c√≥digo de aplica√ß√£o dos crit√©rios"

# =============================================================================
# PROCESSAMENTO DOS CRIT√âRIOS DCL
# =============================================================================
# Cada base de dados tem seus crit√©rios aplicados separadamente
# =============================================================================

cat("üìä Processando crit√©rios do RGF Anexo 02...\n")

# -----------------------------------------------------------------------------
# 1. Precat√≥rios
# -----------------------------------------------------------------------------

df_criterios_rgf_A02_dcl_precatorios <- aplicar_criterios(
  df = rgf_a02_precatorios,
  criterios = criterios_rgf_A02_dcl_precatorios
)

cat("‚úÖ Precat√≥rios processados\n")

# -----------------------------------------------------------------------------
# 2. Restos a Pagar (duas bases)
# -----------------------------------------------------------------------------

df_criterios_rgf_A02_dcl_rp_exceto_170600 <- aplicar_criterios(
  df = rgf_a02_rp_exceto_170600,
  criterios = criterios_rgf_A02_dcl_rp_exceto_170600
)

df_criterios_rgf_A02_dcl_rp_todas_ugs <- aplicar_criterios(
  df = rgf_a02_rp_todas_ugs,
  criterios = criterios_rgf_A02_dcl_rp_todas_ugs
)

cat("‚úÖ Restos a Pagar processados\n")

# -----------------------------------------------------------------------------
# 3. UG 170512 (STN)
# -----------------------------------------------------------------------------

df_criterios_rgf_A02_dcl_ug_170512 <- aplicar_criterios(
  df = rgf_a02_ug_170512,
  criterios = criterios_rgf_A02_dcl_ug_170512
)

cat("‚úÖ UG 170512 processada\n")

# -----------------------------------------------------------------------------
# 4. Cr√©ditos Banc√°rios
# -----------------------------------------------------------------------------

df_criterios_rgf_A02_dcl_creditos_bancarios <- aplicar_criterios(
  df = rgf_a02_creditos_bancarios,
  criterios = criterios_rgf_A02_dcl_creditos_bancarios
)

cat("‚úÖ Cr√©ditos banc√°rios processados\n")

# -----------------------------------------------------------------------------
# 5. Entidade (D√≠vida Mobili√°ria)
# -----------------------------------------------------------------------------

df_criterios_rgf_A02_dcl_entidade <- aplicar_criterios(
  df = rgf_a02_entidade,
  criterios = criterios_rgf_A02_dcl_entidade
)

cat("‚úÖ Entidade processada\n")

# -----------------------------------------------------------------------------
# 6. Balancete (Principal)
# -----------------------------------------------------------------------------

df_criterios_rgf_A02_dcl_balancete <- aplicar_criterios(
  df = rgf_a02_balancete,
  criterios = criterios_rgf_A02_dcl_balancete
)

cat("‚úÖ Balancete processado\n")

# -----------------------------------------------------------------------------
# 7. Aplica√ß√£o em T√≠tulos P√∫blicos
# -----------------------------------------------------------------------------

df_criterios_rgf_A02_dcl_aplicacao_titulos_publicos <- aplicar_criterios(
  df = rgf_a02_aplicacao_titulos_publicos,
  criterios = criterios_rgf_A02_dcl_aplicacao_titulos_publicos
)

cat("‚úÖ Aplica√ß√£o em t√≠tulos processada\n")

# -----------------------------------------------------------------------------
# 8. Balancete FAT
# -----------------------------------------------------------------------------

df_criterios_rgf_A02_dcl_balancete_fat <- aplicar_criterios(
  df = rgf_a02_balancete_fat,
  criterios = criterios_rgf_A02_dcl_balancete_fat
)

cat("‚úÖ Balancete FAT processado\n")

# -----------------------------------------------------------------------------
# 9. Balancete Fundos (duas bases)
# -----------------------------------------------------------------------------

df_criterios_rgf_A02_dcl_balancete_fundos_111215100 <- aplicar_criterios(
  df = rgf_a02_balancete_fundos_111215100,
  criterios = criterios_rgf_A02_dcl_balancete_fundos_111215100
)

df_criterios_rgf_A02_dcl_balancete_fundos <- aplicar_criterios(
  df = rgf_a02_balancete_fundos,
  criterios = criterios_rgf_A02_dcl_balancete_fundos
)

cat("‚úÖ Balancete Fundos processado\n")

# -----------------------------------------------------------------------------
# 10. Dep√≥sitos √† Vista (dedu√ß√µes)
# -----------------------------------------------------------------------------

df_criterios_rgf_A02_dcl_balancete_deducoes_depositos_a_vista <- aplicar_criterios(
  df = rgf_a02_balancete_deducoes_depositos_a_vista,
  criterios = criterios_rgf_A02_dcl_balancete_deducoes_depositos_a_vista
)

cat("‚úÖ Dep√≥sitos √† vista processados\n")

# -----------------------------------------------------------------------------
# 11. Passivo Atuarial
# -----------------------------------------------------------------------------

df_criterios_rgf_A02_dcl_passivo_atuarial <- aplicar_criterios(
  df = rgf_a02_dcl_passivo_atuarial,
  criterios = criterios_rgf_A02_dcl_passivo_atuarial
)

cat("‚úÖ Passivo atuarial processado\n")
```

## Consolida√ß√£o dos Resultados

```{r consolidar-rgf-a02}
#| code-fold: true
#| code-summary: "Ver c√≥digo de consolida√ß√£o"

# =============================================================================
# CONSOLIDA√á√ÉO DOS RESULTADOS
# =============================================================================

# -----------------------------------------------------------------------------
# 1. Consolidar Restos a Pagar (partes 1 e 2)
# -----------------------------------------------------------------------------

df_criterios_rgf_A02_dcl_rp <- bind_rows(
  df_criterios_rgf_A02_dcl_rp_exceto_170600,
  df_criterios_rgf_A02_dcl_rp_todas_ugs
) %>%
  mutate(
    nome = str_replace(nome, " parte [12]$", "")
  ) %>%
  group_by(mes_lancamento, dataframe_nome, dataframe_filtros, relatorio, 
           anexo_codigo, anexo_nome, detalhe, print, filtro, metrica, 
           ordem, nome) %>%
  summarise(valor = sum(valor, na.rm = TRUE), .groups = "drop")

# -----------------------------------------------------------------------------
# 2. Consolidar Dep√≥sitos √† Vista (partes 1 e 2)
# -----------------------------------------------------------------------------

df_criterios_rgf_A02_dcl_depositos_vista <- bind_rows(
  df_criterios_rgf_A02_dcl_balancete_deducoes_depositos_a_vista,
  df_criterios_rgf_A02_dcl_balancete %>% 
    filter(str_detect(nome, "^12 "))
) %>%
  mutate(
    nome = str_replace(nome, " parte [12]$", "")
  ) %>%
  group_by(mes_lancamento, dataframe_nome, dataframe_filtros, relatorio, 
           anexo_codigo, anexo_nome, detalhe, print, filtro, metrica, 
           ordem, nome) %>%
  summarise(valor = sum(valor, na.rm = TRUE), .groups = "drop")

# -----------------------------------------------------------------------------
# 3. Consolidar TODOS os resultados
# -----------------------------------------------------------------------------

df_rgf_A02_dcl_consolidado <- bind_rows(
  df_criterios_rgf_A02_dcl_precatorios,
  df_criterios_rgf_A02_dcl_rp,
  df_criterios_rgf_A02_dcl_ug_170512,
  df_criterios_rgf_A02_dcl_creditos_bancarios,
  df_criterios_rgf_A02_dcl_entidade,
  df_criterios_rgf_A02_dcl_balancete %>% 
    filter(!str_detect(nome, "^12 ")),
  df_criterios_rgf_A02_dcl_aplicacao_titulos_publicos,
  df_criterios_rgf_A02_dcl_balancete_fat,
  df_criterios_rgf_A02_dcl_balancete_fundos_111215100,
  df_criterios_rgf_A02_dcl_balancete_fundos,
  df_criterios_rgf_A02_dcl_depositos_vista,
  df_criterios_rgf_A02_dcl_passivo_atuarial
) %>%
  arrange(mes_lancamento, ordem)

cat(sprintf("‚úÖ Consolida√ß√£o conclu√≠da: %d linhas\n", nrow(df_rgf_A02_dcl_consolidado)))
```

## Ajuste de Sinais

```{r ajuste-sinais-rgf-a02}
#| code-fold: true
#| code-summary: "Ver c√≥digo de ajuste de sinais"

# =============================================================================
# AJUSTE DE SINAIS PARA C√ÅLCULO DA DCL
# =============================================================================
# Algumas linhas s√£o DEDU√á√ïES e devem ter sinal invertido
# =============================================================================

valores_linhas <- df_rgf_A02_dcl_consolidado %>%
  group_by(ordem, nome) %>%
  summarise(
    valor_total = sum(valor, na.rm = TRUE),
    valor_absoluto = sum(abs(valor), na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(ordem)

# Aplicar sinais (linhas de dedu√ß√£o ficam negativas)
valores_linhas <- valores_linhas %>% 
  mutate(
    valor = case_when(
      # Linhas que devem ser subtra√≠das (dedu√ß√µes)
      ordem %in% c("02", "25", "26", "38", "16") ~ -valor_total,
      # Demais linhas mant√™m sinal original
      .default = valor_total
    )
  )

# =============================================================================
# C√ÅLCULO DO VALOR DA DCL (NUM√âRICO)
# =============================================================================
# Esta vari√°vel √© utilizada em outros anexos (RREO A06, RGF A06)
# F√≥rmula: D√≠vida Consolidada Bruta - Dedu√ß√µes
# =============================================================================

valor_dcl_num <- (valores_linhas %>% 
  filter(ordem %in% c("01", "02", "03", "04", "05", "26", 
                      "06", "07", "08", "09", "10", "38")) %>% 
  summarise(valor = sum(valor, na.rm = TRUE)))$valor - 
  (valores_linhas %>% 
  filter(ordem %in% c("11", "12", "14", "15", "16", 
                      "20", "21", "22", "23", "25")) %>% 
  summarise(valor = sum(valor, na.rm = TRUE)))$valor

# Valor formatado para exibi√ß√£o
valor_dcl <- formatar_numero(valor_dcl_num)

cat(sprintf("‚úÖ DCL calculada: R$ %s\n", valor_dcl))
```

## Resultados

```{r resultado-rgf-a02}
#| code-fold: true
#| column: page

# =============================================================================
# EXIBIR RESULTADOS
# =============================================================================

datatable(
  valores_linhas,
  caption = "RGF Anexo 02 - Componentes da DCL",
  rownames = FALSE,
  options = list(
    pageLength = -1,
    scrollX = TRUE,
    lengthMenu = list(c(10, 25, 50, -1), c('10', '25', '50', 'Todas'))
  )
) %>% 
  formatRound(c("valor_total", "valor_absoluto", "valor"), 2, mark = ".", dec.mark = ",")
```

## C√°lculos da DCL

```{r calculos-dcl}
#| code-fold: true
#| code-summary: "Ver c√°lculos da DCL"

# =============================================================================
# C√ÅLCULOS AGREGADOS DA DCL
# =============================================================================

# D√≠vida Mobili√°ria = 01 + 02 + 03 + 04 + 05 + 26
divida_mobiliaria <- valores_linhas %>% 
  filter(ordem %in% c("01", "02", "03", "04", "05", "26")) %>% 
  summarise(valor = sum(valor, na.rm = TRUE)) %>%
  pull(valor)

# D√≠vida Consolidada = D√≠vida Mobili√°ria + 06 + 07 + 08 + 09 + 10 + 38
divida_consolidada <- valores_linhas %>% 
  filter(ordem %in% c("01", "02", "03", "04", "05", "26", "06", "07", "08", "09", "10", "38")) %>% 
  summarise(valor = sum(valor, na.rm = TRUE)) %>%
  pull(valor)

# Precat√≥rios (08 + 38)
precatorios <- valores_linhas %>% 
  filter(ordem %in% c("08", "38")) %>% 
  summarise(valor = sum(valor, na.rm = TRUE)) %>%
  pull(valor)

# Dedu√ß√µes TN/BCB (11 + 12)
deducoes_tn_bcb <- valores_linhas %>% 
  filter(ordem %in% c("11", "12")) %>% 
  summarise(valor = sum(valor, na.rm = TRUE)) %>%
  pull(valor)

# Exibir resumo
cat("\nüìä RESUMO DA DCL\n")
cat("================\n")
cat(sprintf("D√≠vida Mobili√°ria:   R$ %s\n", formatar_numero(divida_mobiliaria)))
cat(sprintf("D√≠vida Consolidada:  R$ %s\n", formatar_numero(divida_consolidada)))
cat(sprintf("Precat√≥rios:         R$ %s\n", formatar_numero(precatorios)))
cat(sprintf("Dedu√ß√µes TN/BCB:     R$ %s\n", formatar_numero(deducoes_tn_bcb)))
cat(sprintf("DCL (valor_dcl_num): R$ %s\n", valor_dcl))
```

## Notas Metodol√≥gicas

```{r notas-rgf-a02}
#| echo: false

# =============================================================================
# NOTAS METODOL√ìGICAS
# =============================================================================

notas <- tibble::tribble(
  ~Item, ~Descri√ß√£o,
  "1", "Valores em R$ (reais)",
  "2", "ISF = P indica item Prim√°rio (relevante para DCL)",
  "3", "Linhas de dedu√ß√£o (-) s√£o subtra√≠das da d√≠vida bruta",
  "4", "RP Processados consolida dados de duas bases (exceto 170600 + todas UGs)",
  "5", "Dep√≥sitos √† vista consolida dados do balancete geral + base espec√≠fica",
  "6", "Passivo atuarial inclui RPPS civil, FCDF e militares",
  "7", "D√≠vida mobili√°ria inclui todos os t√≠tulos p√∫blicos federais"
)

knitr::kable(notas, col.names = c("Item", "Descri√ß√£o"))
```

## Observa√ß√µes Importantes

::: callout-warning
### Complexidade do Anexo

O RGF Anexo 02 √© o demonstrativo mais complexo, utilizando **13 bases de dados diferentes** do Tesouro Gerencial, cada uma com filtros espec√≠ficos. A correta extra√ß√£o dos dados no TG √© fundamental para a precis√£o dos c√°lculos.
:::

::: callout-note
### Sobre o Balancete

O arquivo `rgf_a02_balancete.xlsx` (renomeado para "balancete") √© utilizado em diversos anexos al√©m do RGF A02. Por isso, foi sugerida a renomea√ß√£o para um nome mais gen√©rico que reflita seu uso compartilhado.
:::

::: callout-tip
### Verifica√ß√£o dos Resultados

Para validar os valores, compare com o demonstrativo oficial publicado no SICONFI. As principais fontes de diverg√™ncia s√£o:

-   Diferen√ßas de data/m√™s de refer√™ncia
-   Filtros incorretos na extra√ß√£o do TG
-   Contas cont√°beis atualizadas no PCASP
:::

# üìã RGF Anexo 03 - Garantias e Contragarantias {#sec-rgf-a03}

## Ficha T√©cnica

```{r ficha-tecnica-rgf-a03}
#| echo: false

# =============================================================================
# FICHA T√âCNICA DO ANEXO
# =============================================================================

ficha_tecnica <- tibble::tribble(
  ~Campo,                 ~Informa√ß√£o,
  "Relat√≥rio",            "RGF - Relat√≥rio de Gest√£o Fiscal",
  "Anexo",                "Anexo 03",
  "Nome",                 "Demonstrativo das Garantias e Contragarantias de Valores",
  "Base Legal",           "LRF Art. 55, inciso I, al√≠nea 'c' e Art. 40, ¬ß 1¬∫",
  "Periodicidade",        "Quadrimestral",
  "Grau de Dificuldade",  "‚≠ê‚≠ê F√°cil",
  "√öltima Atualiza√ß√£o",   format(Sys.Date(), "%d/%m/%Y")
)

knitr::kable(ficha_tecnica, col.names = c("Campo", "Informa√ß√£o"))
```

## Arquivos Necess√°rios

```{r arquivos-rgf-a03}
#| echo: false

# =============================================================================
# ARQUIVOS DO TESOURO GERENCIAL UTILIZADOS
# =============================================================================

arquivos <- tibble::tribble(
  ~Arquivo,              ~Descri√ß√£o,                                    ~Filtros_TG,
  "rgf_a03.xlsx",        "Garantias e contragarantias de valores",      "Or√ßamento Fiscal, Contas 81* e 89*"
)

knitr::kable(arquivos, col.names = c("Arquivo", "Descri√ß√£o", "Filtros no TG"))
```

## Atributos Utilizados

```{r atributos-rgf-a03}
#| echo: false

# =============================================================================
# ATRIBUTOS (COLUNAS) DOS ARQUIVOS E SEUS USOS
# =============================================================================

atributos <- tibble::tribble(
  ~Atributo,                   ~Tipo,       ~Uso,                  ~Descri√ß√£o,
  "conta_contabil_numero",     "character", "TG / Crit√©rio",       "N√∫mero da conta cont√°bil (PCASP)",
  "conta_contabil_nome",       "character", "TG / Apresenta√ß√£o",   "Nome da conta cont√°bil",
  "conta_corrente",            "character", "TG / Crit√©rio",       "Conta corrente (identifica benefici√°rio)",
  "mes_lancamento",            "numeric",   "TG / R",              "M√™s do lan√ßamento (YYYYMM)",
  "saldo_r_conta_contabil",    "numeric",   "TG / R",              "Saldo da conta cont√°bil",
  "data_lancamento",           "Date",      "R",                   "Data calculada do lan√ßamento"
)

knitr::kable(atributos, col.names = c("Atributo", "Tipo", "Uso", "Descri√ß√£o"))
```

## V√≠nculos com Outros Anexos

```{r vinculos-rgf-a03}
#| echo: false

# =============================================================================
# RELACIONAMENTO COM OUTROS ANEXOS
# =============================================================================

vinculos <- tibble::tribble(
  ~Anexo_Relacionado,   ~Tipo_V√≠nculo,    ~Descri√ß√£o,
  "RREO Anexo 03",      "Refer√™ncia",     "RCL utilizada para c√°lculo do limite de garantias",
  "RGF Anexo 06",       "Consolida√ß√£o",   "Valores consolidados no demonstrativo simplificado"
)

knitr::kable(vinculos, col.names = c("Anexo Relacionado", "Tipo de V√≠nculo", "Descri√ß√£o"))
```

## Estrutura do Demonstrativo

```{r estrutura-rgf-a03}
#| echo: false

# =============================================================================
# ESTRUTURA DO DEMONSTRATIVO - GARANTIAS E CONTRAGARANTIAS
# =============================================================================

estrutura <- tibble::tribble(
  ~Ordem, ~Item,                                           ~Grupo,
  "01",   "Garantias aos Estados - Total",                 "I - Garantias Concedidas",
  "02",   "Garantias aos Estados - Op. Externas",          "I - Garantias Concedidas",
  "03",   "Garantias aos Estados - Op. Internas",          "I - Garantias Concedidas",
  "04",   "Garantias aos Munic√≠pios - Total",              "I - Garantias Concedidas",
  "05",   "Garantias aos Munic√≠pios - Op. Externas",       "I - Garantias Concedidas",
  "06",   "Garantias aos Munic√≠pios - Op. Internas",       "I - Garantias Concedidas",
  "07",   "Garantias √†s Entidades Controladas - Total",    "I - Garantias Concedidas",
  "08",   "Garantias √†s Entidades - Op. Externas",         "I - Garantias Concedidas",
  "09",   "Garantias √†s Entidades - Op. Internas",         "I - Garantias Concedidas",
  "10",   "Garantias por Fundos e Programas - Total",      "I - Garantias Concedidas",
  "11",   "Garantias Fundos - Seguros-Garantia",           "I - Garantias Concedidas",
  "12",   "Garantias Fundos - ASCA",                       "I - Garantias Concedidas",
  "13",   "Garantias Fundos - Lei 8.036 (FGTS)",           "I - Garantias Concedidas",
  "14",   "TOTAL GARANTIAS CONCEDIDAS",                    "I - Garantias Concedidas",
  "15",   "Contragarantias dos Estados - Total",           "II - Contragarantias Recebidas",
  "16",   "Contragarantias dos Estados - Op. Externas",    "II - Contragarantias Recebidas",
  "17",   "Contragarantias dos Estados - Op. Internas",    "II - Contragarantias Recebidas",
  "18",   "Contragarantias dos Munic√≠pios - Total",        "II - Contragarantias Recebidas",
  "19",   "Contragarantias dos Munic√≠pios - Op. Externas", "II - Contragarantias Recebidas",
  "20",   "Contragarantias dos Munic√≠pios - Op. Internas", "II - Contragarantias Recebidas",
  "21",   "Contragarantias das Entidades - Total",         "II - Contragarantias Recebidas",
  "22",   "Contragarantias das Entidades - Op. Externas",  "II - Contragarantias Recebidas",
  "23",   "Contragarantias das Entidades - Op. Internas",  "II - Contragarantias Recebidas",
  "24",   "TOTAL CONTRAGARANTIAS RECEBIDAS",               "II - Contragarantias Recebidas"
)

knitr::kable(estrutura, col.names = c("Ordem", "Item", "Grupo"))
```

## Contas Correntes de Refer√™ncia

```{r contas-correntes-rgf-a03}
#| echo: false

# =============================================================================
# TABELA DE CONTAS CORRENTES (BENEFICI√ÅRIOS)
# =============================================================================

contas_correntes <- tibble::tribble(
  ~Conta_Corrente,  ~Benefici√°rio,                    ~Tipo_Opera√ß√£o,
  "CG0000064",      "Estados",                        "Opera√ß√µes Internas",
  "CG0000069",      "Estados",                        "Opera√ß√µes Externas",
  "CG0000065",      "Munic√≠pios",                     "Opera√ß√µes Internas",
  "CG0000070",      "Munic√≠pios",                     "Opera√ß√µes Externas",
  "CG0000067",      "Entidades Controladas",          "Opera√ß√µes Internas",
  "CG0000071",      "Entidades Controladas",          "Opera√ß√µes Externas (tipo 1)",
  "CG0000072",      "Entidades Controladas",          "Opera√ß√µes Externas (tipo 2)",
  "CGASCA001",      "Fundos - ASCA",                  "Programas",
  "CGLEI8036",      "Fundos - Lei 8.036 (FGTS)",      "Programas"
)

knitr::kable(contas_correntes, col.names = c("Conta Corrente", "Benefici√°rio", "Tipo de Opera√ß√£o"))
```

## Crit√©rios de Classifica√ß√£o

```{r criterios-rgf-a03}
#| code-fold: true
#| code-summary: "Ver crit√©rios de classifica√ß√£o"

# =============================================================================
# CRIT√âRIOS RGF ANEXO 03 - GARANTIAS E CONTRAGARANTIAS
# =============================================================================
# Organizado em dois grupos:
#   I  - Garantias Concedidas (01-14)
#   II - Contragarantias Recebidas (15-24)
# =============================================================================

criterios_rgf_A03_garantias <- list(
  
  # ===========================================================================
  # GRUPO I - GARANTIAS CONCEDIDAS
  # ===========================================================================
  
  # ---------------------------------------------------------------------------
  # GARANTIAS AOS ESTADOS
  # ---------------------------------------------------------------------------
  
  `01 Garantias aos estados total` = list(
    criterio = "
    conta_contabil_numero %in% c('812110104', '812110204', '899913301', '899913302') &
    conta_corrente %in% c('CG0000064', 'CG0000069')
    "
  ),
  
  `02 Garantias aos estados opera√ß√µes externas` = list(
    criterio = "
    (conta_contabil_numero == '812110204' &
     conta_corrente == 'CG0000069') |
    (conta_contabil_numero == '899913302' &
     conta_corrente == 'CG0000069')
    "
  ),
  
  `03 Garantias aos estados opera√ß√µes internas` = list(
    criterio = "
    (conta_contabil_numero == '812110104' &
     conta_corrente == 'CG0000064') |
    (conta_contabil_numero == '899913301' &
     conta_corrente == 'CG0000064')
    "
  ),
  
  # ---------------------------------------------------------------------------
  # GARANTIAS AOS MUNIC√çPIOS
  # ---------------------------------------------------------------------------
  
  `04 Garantias aos munic√≠pios total` = list(
    criterio = "
    conta_contabil_numero %in% c('812110104', '812110204') &
    conta_corrente %in% c('CG0000065', 'CG0000070')
    "
  ),
  
  `05 Garantias aos munic√≠pios opera√ß√µes externas` = list(
    criterio = "
    conta_contabil_numero == '812110204' &
    conta_corrente == 'CG0000070'
    "
  ),
  
  `06 Garantias aos munic√≠pios opera√ß√µes internas` = list(
    criterio = "
    conta_contabil_numero == '812110104' &
    conta_corrente == 'CG0000065'
    "
  ),
  
  # ---------------------------------------------------------------------------
  # GARANTIAS √ÄS ENTIDADES CONTROLADAS
  # ---------------------------------------------------------------------------
  
  `07 Garantias √†s entidades controladas total` = list(
    criterio = "
    conta_contabil_numero %in% c('812110104', '812110204') &
    conta_corrente %in% c('CG0000067', 'CG0000071', 'CG0000072')
    "
  ),
  
  `08 Garantias √†s entidades opera√ß√µes externas` = list(
    criterio = "
    conta_contabil_numero == '812110204' &
    conta_corrente %in% c('CG0000071', 'CG0000072')
    "
  ),
  
  `09 Garantias √†s entidades opera√ß√µes internas` = list(
    criterio = "
    conta_contabil_numero == '812110104' &
    conta_corrente == 'CG0000067'
    "
  ),
  
  # ---------------------------------------------------------------------------
  # GARANTIAS POR FUNDOS E PROGRAMAS
  # ---------------------------------------------------------------------------
  
  `10 Garantias por fundos e programas total` = list(
    criterio = "
    (conta_contabil_numero == '812110104' & 
     (conta_corrente %in% c('CGASCA001', 'CGLEI8036') | 
      startsWith(conta_corrente, 'CGFSCEIRB') |
      startsWith(conta_corrente, 'CGPPRONAF') |
      startsWith(conta_corrente, 'CGPRCACAU') |
      startsWith(conta_corrente, 'CGASCAD'))) |
    conta_contabil_numero == '812110110'
    "
  ),
  
  `11 Garantias fundos seguros-garantia` = list(
    criterio = "
    conta_contabil_numero == '812110110' &
    (conta_corrente == '999' | is.na(conta_corrente))
    "
  ),
  
  `12 Garantias fundos ASCA` = list(
    criterio = "
    conta_contabil_numero == '812110104' &
    conta_corrente == 'CGASCA001'
    "
  ),
  
  `13 Garantias fundos Lei 8036 (FGTS)` = list(
    criterio = "
    conta_contabil_numero == '812110104' &
    conta_corrente == 'CGLEI8036'
    "
  ),
  
  # ---------------------------------------------------------------------------
  # TOTAL GERAL DE GARANTIAS
  # ---------------------------------------------------------------------------
  
  `14 Garantias total geral` = list(
    criterio = "
    conta_contabil_numero %in% c('812110104', '812110110', '812110204', '899913301', '899913302')
    "
  ),
  
  # ===========================================================================
  # GRUPO II - CONTRAGARANTIAS RECEBIDAS
  # ===========================================================================
  
  # ---------------------------------------------------------------------------
  # CONTRAGARANTIAS DOS ESTADOS
  # ---------------------------------------------------------------------------
  
  `15 Contragarantias dos estados total` = list(
    criterio = "
    conta_contabil_numero %in% c('811110304', '811110404') &
    conta_corrente %in% c('CG0000064', 'CG0000069')
    "
  ),
  
  `16 Contragarantias dos estados opera√ß√µes externas` = list(
    criterio = "
    conta_contabil_numero == '811110404' &
    conta_corrente == 'CG0000069'
    "
  ),
  
  `17 Contragarantias dos estados opera√ß√µes internas` = list(
    criterio = "
    conta_contabil_numero == '811110304' &
    conta_corrente == 'CG0000064'
    "
  ),
  
  # ---------------------------------------------------------------------------
  # CONTRAGARANTIAS DOS MUNIC√çPIOS
  # ---------------------------------------------------------------------------
  
  `18 Contragarantias dos munic√≠pios total` = list(
    criterio = "
    conta_contabil_numero %in% c('811110304', '811110404') &
    conta_corrente %in% c('CG0000065', 'CG0000070')
    "
  ),
  
  `19 Contragarantias dos munic√≠pios opera√ß√µes externas` = list(
    criterio = "
    conta_contabil_numero == '811110404' &
    conta_corrente == 'CG0000070'
    "
  ),
  
  `20 Contragarantias dos munic√≠pios opera√ß√µes internas` = list(
    criterio = "
    conta_contabil_numero == '811110304' &
    conta_corrente == 'CG0000065'
    "
  ),
  
  # ---------------------------------------------------------------------------
  # CONTRAGARANTIAS DAS ENTIDADES CONTROLADAS
  # ---------------------------------------------------------------------------
  
  `21 Contragarantias das entidades controladas total` = list(
    criterio = "
    conta_contabil_numero %in% c('811110304', '811110404') &
    conta_corrente %in% c('CG0000067', 'CG0000071', 'CG0000072')
    "
  ),
  
  `22 Contragarantias das entidades opera√ß√µes externas` = list(
    criterio = "
    conta_contabil_numero == '811110404' &
    conta_corrente %in% c('CG0000071', 'CG0000072')
    "
  ),
  
  `23 Contragarantias das entidades opera√ß√µes internas` = list(
    criterio = "
    conta_contabil_numero == '811110304' &
    conta_corrente == 'CG0000067'
    "
  ),
  
  # ---------------------------------------------------------------------------
  # TOTAL GERAL DE CONTRAGARANTIAS
  # ---------------------------------------------------------------------------
  
  `24 Contragarantias total geral` = list(
    criterio = "
    conta_contabil_numero %in% c('811110304', '811110404')
    "
  )
)

cat("‚úÖ Crit√©rios RGF Anexo 03 definidos\n")
cat(sprintf("   Total de categorias: %d\n", length(criterios_rgf_A03_garantias)))
```

## Aplica√ß√£o dos Crit√©rios

```{r aplicar-criterios-rgf-a03}
#| code-fold: true
#| code-summary: "Ver c√≥digo de aplica√ß√£o dos crit√©rios"

# =============================================================================
# APLICA√á√ÉO DOS CRIT√âRIOS DE GARANTIAS
# =============================================================================

cat("üìä Processando crit√©rios do RGF Anexo 03...\n")

# -----------------------------------------------------------------------------
# Aplicar crit√©rios
# -----------------------------------------------------------------------------

garantias_processado <- aplicar_criterios(
  rgf_a03, 
  criterios_rgf_A03_garantias
)

cat(sprintf("‚úÖ Crit√©rios aplicados: %d registros\n", nrow(garantias_processado)))

# -----------------------------------------------------------------------------
# Agregar por ordem/nome
# -----------------------------------------------------------------------------

garantias_agregado <- garantias_processado %>% 
  group_by(ordem, nome) %>% 
  summarise(
    valor = sum(valor, na.rm = TRUE), 
    .groups = "drop"
  ) %>%
  arrange(ordem)

# =============================================================================
# CALCULAR TOTAIS PARA VARI√ÅVEIS GLOBAIS
# =============================================================================

# Total de Garantias Concedidas (linha 14)
valor_garantias_total <- garantias_agregado %>%
  filter(ordem == "14") %>%
  pull(valor)

# Total de Contragarantias Recebidas (linha 24)
valor_contragarantias_total <- garantias_agregado %>%
  filter(ordem == "24") %>%
  pull(valor)

# Garantias l√≠quidas (garantias - contragarantias)
valor_garantias_liquidas <- valor_garantias_total - valor_contragarantias_total

cat(sprintf("‚úÖ Total Garantias: R$ %s\n", formatar_numero(valor_garantias_total)))
cat(sprintf("‚úÖ Total Contragarantias: R$ %s\n", formatar_numero(valor_contragarantias_total)))
```

## Resultados

```{r resultado-rgf-a03}
#| code-fold: true
#| column: page

# =============================================================================
# EXIBIR RESULTADOS
# =============================================================================

datatable(
  garantias_agregado,
  caption = "RGF Anexo 03 - Garantias e Contragarantias de Valores",
  rownames = FALSE,
  options = list(
    pageLength = -1,
    scrollX = TRUE,
    lengthMenu = list(c(10, 25, 50, -1), c('10', '25', '50', 'Todas'))
  )
) %>% 
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")
```

## Resumo das Garantias

```{r resumo-rgf-a03}
#| code-fold: true
#| code-summary: "Ver resumo das garantias"

# =============================================================================
# RESUMO DAS GARANTIAS POR BENEFICI√ÅRIO
# =============================================================================

# Garantias por benefici√°rio
garantias_estados <- garantias_agregado %>% filter(ordem == "01") %>% pull(valor)
garantias_municipios <- garantias_agregado %>% filter(ordem == "04") %>% pull(valor)
garantias_entidades <- garantias_agregado %>% filter(ordem == "07") %>% pull(valor)
garantias_fundos <- garantias_agregado %>% filter(ordem == "10") %>% pull(valor)

# Contragarantias por benefici√°rio
contragarantias_estados <- garantias_agregado %>% filter(ordem == "15") %>% pull(valor)
contragarantias_municipios <- garantias_agregado %>% filter(ordem == "18") %>% pull(valor)
contragarantias_entidades <- garantias_agregado %>% filter(ordem == "21") %>% pull(valor)

# Exibir resumo
cat("\nüìä RESUMO DAS GARANTIAS\n")
cat("=======================\n\n")

cat("GARANTIAS CONCEDIDAS:\n")
cat(sprintf("  Estados:              R$ %s\n", formatar_numero(garantias_estados)))
cat(sprintf("  Munic√≠pios:           R$ %s\n", formatar_numero(garantias_municipios)))
cat(sprintf("  Entidades Controladas:R$ %s\n", formatar_numero(garantias_entidades)))
cat(sprintf("  Fundos e Programas:   R$ %s\n", formatar_numero(garantias_fundos)))
cat(sprintf("  TOTAL:                R$ %s\n\n", formatar_numero(valor_garantias_total)))

cat("CONTRAGARANTIAS RECEBIDAS:\n")
cat(sprintf("  Estados:              R$ %s\n", formatar_numero(contragarantias_estados)))
cat(sprintf("  Munic√≠pios:           R$ %s\n", formatar_numero(contragarantias_municipios)))
cat(sprintf("  Entidades Controladas:R$ %s\n", formatar_numero(contragarantias_entidades)))
cat(sprintf("  TOTAL:                R$ %s\n\n", formatar_numero(valor_contragarantias_total)))

cat(sprintf("GARANTIAS L√çQUIDAS:     R$ %s\n", formatar_numero(valor_garantias_liquidas)))
```

## Notas Metodol√≥gicas

```{r notas-rgf-a03}
#| echo: false

# =============================================================================
# NOTAS METODOL√ìGICAS
# =============================================================================

notas <- tibble::tribble(
  ~Item, ~Descri√ß√£o,
  "1", "Valores em R$ (reais)",
  "2", "Contas 812* = Garantias concedidas",
  "3", "Contas 811* = Contragarantias recebidas",
  "4", "Contas 899913* = Garantias de controle (complementar)",
  "5", "Conta corrente identifica o benefici√°rio da garantia",
  "6", "Opera√ß√µes externas = financiamentos internacionais",
  "7", "Opera√ß√µes internas = financiamentos nacionais"
)

knitr::kable(notas, col.names = c("Item", "Descri√ß√£o"))
```

## Observa√ß√µes Importantes

::: callout-note
### Limite de Garantias (LRF)

O limite de garantias conforme a LRF √© de **60% da RCL** para a Uni√£o. O valor atual deve ser comparado com este limite no RGF Anexo 06 (Demonstrativo Simplificado).
:::

::: callout-tip
### Contas Cont√°beis

As principais contas cont√°beis utilizadas s√£o:

-   **812110104**: Garantias internas
-   **812110204**: Garantias externas
-   **812110110**: Seguros-garantia
-   **811110304**: Contragarantias internas
-   **811110404**: Contragarantias externas
:::

# üìã RGF Anexo 04 - Opera√ß√µes de Cr√©dito {#sec-rgf-a04}

## Ficha T√©cnica

```{r ficha-tecnica-rgf-a04}
#| echo: false

# =============================================================================
# FICHA T√âCNICA DO ANEXO
# =============================================================================

ficha_tecnica <- tibble::tribble(
  ~Campo,                 ~Informa√ß√£o,
  "Relat√≥rio",            "RGF - Relat√≥rio de Gest√£o Fiscal",
  "Anexo",                "Anexo 04",
  "Nome",                 "Demonstrativo das Opera√ß√µes de Cr√©dito",
  "Base Legal",           "LRF Art. 55, inciso I, al√≠nea 'd' e Art. 32",
  "Periodicidade",        "Quadrimestral",
  "Grau de Dificuldade",  "‚≠ê‚≠ê‚≠ê M√©dio",
  "√öltima Atualiza√ß√£o",   format(Sys.Date(), "%d/%m/%Y")
)

knitr::kable(ficha_tecnica, col.names = c("Campo", "Informa√ß√£o"))
```

## Arquivos Necess√°rios

```{r arquivos-rgf-a04}
#| echo: false

# =============================================================================
# ARQUIVOS DO TESOURO GERENCIAL UTILIZADOS
# =============================================================================

arquivos <- tibble::tribble(
  ~Arquivo,                    ~Descri√ß√£o,                                    ~Filtros_TG,
  "rgf_a04_receitas.xlsx",     "Receitas de opera√ß√µes de cr√©dito",            "Or√ß. Fiscal, Contas 621*",
  "rgf_a04_despesas.xlsx",     "Aplica√ß√£o dos recursos (despesas)",           "Or√ß. Fiscal, Contas 622*",
  "rgf_a02_balancete.xlsx",    "Opera√ß√µes extraor√ßament√°rias",                "Or√ß. Fiscal, Contas 896* e 212*"
)

knitr::kable(arquivos, col.names = c("Arquivo", "Descri√ß√£o", "Filtros no TG"))
```

## Atributos Utilizados

```{r atributos-rgf-a04}
#| echo: false

# =============================================================================
# ATRIBUTOS (COLUNAS) DOS ARQUIVOS E SEUS USOS
# =============================================================================

atributos <- tibble::tribble(
  ~Atributo,                           ~Tipo,       ~Uso,                  ~Descri√ß√£o,

  "conta_contabil_numero",             "character", "TG / Crit√©rio",       "N√∫mero da conta cont√°bil (PCASP)",
  "natureza_receita_codigo_completo",  "character", "TG / Crit√©rio",       "C√≥digo completo da natureza de receita",
  "grupo_despesa_codigo_grupo",        "character", "TG / Crit√©rio",       "C√≥digo do grupo de despesa (1-6)",
  "mes_lancamento",                    "numeric",   "TG / R",              "M√™s do lan√ßamento (YYYYMM)",
  "saldo_r_conta_contabil",            "numeric",   "TG / R",              "Saldo da conta cont√°bil",
  "movim_liquido_r_item_informacao",   "numeric",   "TG / R",              "Movimento l√≠quido",
  "data_lancamento",                   "Date",      "R",                   "Data calculada do lan√ßamento"
)

knitr::kable(atributos, col.names = c("Atributo", "Tipo", "Uso", "Descri√ß√£o"))
```

## V√≠nculos com Outros Anexos

```{r vinculos-rgf-a04}
#| echo: false

# =============================================================================
# RELACIONAMENTO COM OUTROS ANEXOS
# =============================================================================

vinculos <- tibble::tribble(
  ~Anexo_Relacionado,   ~Tipo_V√≠nculo,    ~Descri√ß√£o,
  "RREO Anexo 03",      "Refer√™ncia",     "RCL utilizada para c√°lculo do limite de opera√ß√µes",
  "RGF Anexo 02",       "Refer√™ncia",     "Balancete compartilhado para extraor√ßament√°rias",
  "RGF Anexo 06",       "Consolida√ß√£o",   "Valores consolidados no demonstrativo simplificado"
)

knitr::kable(vinculos, col.names = c("Anexo Relacionado", "Tipo de V√≠nculo", "Descri√ß√£o"))
```

## Estrutura do Demonstrativo

```{r estrutura-rgf-a04}
#| echo: false

# =============================================================================
# ESTRUTURA DO DEMONSTRATIVO - OPERA√á√ïES DE CR√âDITO
# =============================================================================

estrutura <- tibble::tribble(
  ~Ordem, ~Item,                                                    ~Grupo,
  "01",   "Mobili√°ria Interna - Refinanciamento",                   "I - Sujeitas ao Limite",
  "02",   "Mobili√°ria Interna - Outras Or√ßament√°rias",              "I - Sujeitas ao Limite",
  "03",   "Mobili√°ria Interna - Extraor√ß. Aporte Bacen",            "I - Sujeitas ao Limite",
  "04",   "Mobili√°ria Interna - Extraor√ß. Aporte Empresas",         "I - Sujeitas ao Limite",
  "05",   "Mobili√°ria Interna - Extraor√ß. Trocas e Demais",         "I - Sujeitas ao Limite",
  "06",   "Mobili√°ria Externa - Refinanciamento",                   "I - Sujeitas ao Limite",
  "07",   "Mobili√°ria Externa - Assun√ß√£o/Reconhecimento D√≠vidas",   "I - Sujeitas ao Limite",
  "08",   "Mobili√°ria Externa - Outras Op. Mobili√°rias",            "I - Sujeitas ao Limite",
  "09",   "Contratual Interna - Abertura de Cr√©dito",               "I - Sujeitas ao Limite",
  "10",   "Contratual Interna - Assun√ß√£o/Reconhecimento D√≠vidas",   "I - Sujeitas ao Limite",
  "11",   "Contratual Interna - Outras Op. Contratuais",            "I - Sujeitas ao Limite",
  "12",   "Contratual Externa - Abertura Cr√©dito Or√ßament√°rias",    "I - Sujeitas ao Limite",
  "13",   "Contratual Externa - Abertura Cr√©dito Extraor√ß.",        "I - Sujeitas ao Limite",
  "14",   "Contratual Externa - Assun√ß√£o/Reconhecimento D√≠vidas",   "I - Sujeitas ao Limite",
  "15",   "Contratual Externa - Outras Op. Contratuais",            "I - Sujeitas ao Limite",
  "16",   "Amortiza√ß√£o/Refinanciamento",                            "II - Aplica√ß√£o dos Recursos",
  "17",   "Outras Despesas Correntes",                              "II - Aplica√ß√£o dos Recursos",
  "18",   "Pessoal e Encargos Sociais",                             "II - Aplica√ß√£o dos Recursos",
  "19",   "Juros e Encargos da D√≠vida",                             "II - Aplica√ß√£o dos Recursos",
  "20",   "Investimentos",                                          "II - Aplica√ß√£o dos Recursos",
  "21",   "Invers√µes Financeiras",                                  "II - Aplica√ß√£o dos Recursos"
)

knitr::kable(estrutura, col.names = c("Ordem", "Item", "Grupo"))
```

## Crit√©rios de Classifica√ß√£o

### Parte 1: Receitas Or√ßament√°rias

```{r criterios-receitas-rgf-a04}
#| code-fold: true
#| code-summary: "Ver crit√©rios - Receitas Or√ßament√°rias"

# =============================================================================
# PARTE 1: RECEITAS OR√áAMENT√ÅRIAS
# Base: rgf_a04_receitas
# Contas cont√°beis: 621* (Receitas de Opera√ß√µes de Cr√©dito)
# =============================================================================

criterios_rgf_A04_receitas <- list(
  
  # ---------------------------------------------------------------------------
  # MOBILI√ÅRIA INTERNA
  # ---------------------------------------------------------------------------
  
  `01 Mobili√°ria interna refinanciamento` = list(
    criterio = "
    conta_contabil_numero %in% c('621200000', '621310000', '621320000', 
                                  '621330000', '621340000', '621390000') &
    (startsWith(natureza_receita_codigo_completo, '2111002') |
     startsWith(natureza_receita_codigo_completo, '8111002') |
     natureza_receita_codigo_completo %in% c('21110200', '21110201', 
                                             '81110200', '81110201'))
    "
  ),
  
  `02 Mobili√°ria interna outras or√ßament√°rias` = list(
    criterio = "
    conta_contabil_numero %in% c('621200000', '621310000', '621320000', 
                                  '621330000', '621340000', '621390000') &
    (startsWith(natureza_receita_codigo_completo, '2111003') |
     startsWith(natureza_receita_codigo_completo, '8111001') |
     natureza_receita_codigo_completo %in% c('21110300', '21110301', 
                                             '21110100', '21110101'))
    "
  ),
  
  # ---------------------------------------------------------------------------
  # MOBILI√ÅRIA EXTERNA
  # ---------------------------------------------------------------------------
  
  `06 Mobili√°ria externa refinanciamento` = list(
    criterio = "
    conta_contabil_numero %in% c('621200000', '621310000', '621320000', 
                                  '621330000', '621340000', '621390000') &
    natureza_receita_codigo_completo %in% c('21210201', '21210202', 
                                            '21210021', '21210022')
    "
  ),
  
  `08 Mobili√°ria externa outras opera√ß√µes mobili√°rias externas` = list(
    criterio = "
    conta_contabil_numero %in% c('621200000', '621310000', '621320000', 
                                  '621330000', '621340000', '621390000') &
    natureza_receita_codigo_completo %in% c('21210101', '21210102', 
                                            '21210011', '21210012')
    "
  ),
  
  # ---------------------------------------------------------------------------
  # CONTRATUAL INTERNA
  # ---------------------------------------------------------------------------
  
  `09 Contratual interna abertura de cr√©dito` = list(
    criterio = "
    conta_contabil_numero %in% c('621200000', '621310000', '621320000', 
                                  '621330000', '621340000', '621390000') &
    startsWith(natureza_receita_codigo_completo, '2112001')
    "
  ),
  
  `11 Contratual interna outras opera√ß√µes contratuais internas` = list(
    criterio = "
    conta_contabil_numero %in% c('621200000', '621310000', '621320000', 
                                  '621330000', '621340000', '621390000') &
    startsWith(natureza_receita_codigo_completo, '2119001')
    "
  ),
  
  # ---------------------------------------------------------------------------
  # CONTRATUAL EXTERNA
  # ---------------------------------------------------------------------------
  
  `12 Contratual externa abertura de cr√©dito or√ßament√°rias` = list(
    criterio = "
    conta_contabil_numero %in% c('621200000', '621310000', '621320000', 
                                  '621330000', '621340000', '621390000') &
    (startsWith(natureza_receita_codigo_completo, '2122001') |
     natureza_receita_codigo_completo %in% c('21220100', '21220101', '21220102'))
    "
  ),
  
  `15 Contratual externa outras opera√ß√µes contratuais externas` = list(
    criterio = "
    conta_contabil_numero %in% c('621200000', '621310000', '621320000', 
                                  '621330000', '621340000', '621390000') &
    startsWith(natureza_receita_codigo_completo, '2129001')
    "
  )
)

cat("‚úÖ Crit√©rios de Receitas definidos\n")
```

### Parte 2: Opera√ß√µes Extraor√ßament√°rias

```{r criterios-extra-rgf-a04}
#| code-fold: true
#| code-summary: "Ver crit√©rios - Extraor√ßament√°rias"

# =============================================================================
# PARTE 2: OPERA√á√ïES EXTRAOR√áAMENT√ÅRIAS
# Base: rgf_a02_balancete (compartilhado com RGF A02)
# Contas cont√°beis: 896* (Emiss√µes extraor√ßament√°rias) e 212*
# =============================================================================

criterios_rgf_A04_extra_orcamentarias <- list(
  
  # ---------------------------------------------------------------------------
  # MOBILI√ÅRIA INTERNA - EXTRAOR√áAMENT√ÅRIAS
  # ---------------------------------------------------------------------------
  
  `03 Mobili√°ria interna extraor√ßament√°rias aporte Bacen` = list(
    criterio = "
    conta_contabil_numero %in% c('896110303', '896110304')
    "
  ),
  
  `04 Mobili√°ria interna extraor√ßament√°rias aporte em empresas` = list(
    criterio = "
    conta_contabil_numero %in% c('896110311', '896110312')
    "
  ),
  
  `05 Mobili√°ria interna extraor√ßament√°rias trocas e demais opera√ß√µes internas` = list(
    criterio = "
    conta_contabil_numero %in% c('896110301', '896110302', '896110305', '896110306')
    "
  ),
  
  # ---------------------------------------------------------------------------
  # MOBILI√ÅRIA EXTERNA - EXTRAOR√áAMENT√ÅRIAS
  # ---------------------------------------------------------------------------
  
  `07 Mobili√°ria externa assun√ß√£o reconhecimento e confiss√£o de d√≠vidas` = list(
    criterio = "
    conta_contabil_numero %in% c('896110309', '896110310')
    "
  ),
  
  # ---------------------------------------------------------------------------
  # CONTRATUAL INTERNA - EXTRAOR√áAMENT√ÅRIAS
  # ---------------------------------------------------------------------------
  
  `10 Contratual interna assun√ß√£o reconhecimento e confiss√£o de d√≠vidas` = list(
    criterio = "
    conta_contabil_numero == '212110398'
    "
  ),
  
  # ---------------------------------------------------------------------------
  # CONTRATUAL EXTERNA - EXTRAOR√áAMENT√ÅRIAS
  # ---------------------------------------------------------------------------
  
  `13 Contratual externa abertura de cr√©dito extraor√ßament√°rias` = list(
    criterio = "
    conta_contabil_numero %in% c('896110307', '896110308')
    "
  ),
  
  `14 Contratual externa assun√ß√£o reconhecimento e confiss√£o de d√≠vidas` = list(
    criterio = "FALSE"
  )
)

cat("‚úÖ Crit√©rios Extraor√ßament√°rios definidos\n")
```

### Parte 3: Aplica√ß√£o dos Recursos (Despesas)

```{r criterios-despesas-rgf-a04}
#| code-fold: true
#| code-summary: "Ver crit√©rios - Despesas"

# =============================================================================
# PARTE 3: APLICA√á√ÉO DOS RECURSOS (DESPESAS)
# Base: rgf_a04_despesas
# Contas cont√°beis: 622* (Execu√ß√£o de Despesa)
# =============================================================================

criterios_rgf_A04_despesas <- list(
  
  # ---------------------------------------------------------------------------
  # APLICA√á√ÉO DOS RECURSOS POR GRUPO DE DESPESA
  # ---------------------------------------------------------------------------
  
  `16 Amortiza√ß√£o refinanciamento` = list(
    criterio = "
    conta_contabil_numero %in% c('622130400', '622130600', '622130700') &
    grupo_despesa_codigo_grupo == '6'
    "
  ),
  
  `17 Outras despesas correntes` = list(
    criterio = "
    conta_contabil_numero %in% c('622130400', '622130600', '622130700') &
    grupo_despesa_codigo_grupo == '3'
    "
  ),
  
  `18 Pessoal e encargos sociais` = list(
    criterio = "
    conta_contabil_numero %in% c('622130400', '622130600', '622130700') &
    grupo_despesa_codigo_grupo == '1'
    "
  ),
  
  `19 Juros e encargos da d√≠vida` = list(
    criterio = "
    conta_contabil_numero %in% c('622130400', '622130600', '622130700') &
    grupo_despesa_codigo_grupo == '2'
    "
  ),
  
  `20 Investimentos` = list(
    criterio = "
    conta_contabil_numero %in% c('622130400', '622130600', '622130700') &
    grupo_despesa_codigo_grupo == '4'
    "
  ),
  
  `21 Invers√µes financeiras` = list(
    criterio = "
    conta_contabil_numero %in% c('622130400', '622130600', '622130700') &
    grupo_despesa_codigo_grupo == '5'
    "
  )
)

cat("‚úÖ Crit√©rios de Despesas definidos\n")
```

## Aplica√ß√£o dos Crit√©rios

```{r aplicar-criterios-rgf-a04}
#| code-fold: true
#| code-summary: "Ver c√≥digo de aplica√ß√£o dos crit√©rios"

# =============================================================================
# APLICA√á√ÉO DOS CRIT√âRIOS
# =============================================================================

cat("üìä Processando crit√©rios do RGF Anexo 04...\n")

# -----------------------------------------------------------------------------
# 1. Receitas Or√ßament√°rias
# -----------------------------------------------------------------------------

df_criterios_rgf_A04_receitas <- aplicar_criterios(
  rgf_a04_receitas, 
  criterios_rgf_A04_receitas
)

cat(sprintf("‚úÖ Receitas processadas: %d registros\n", nrow(df_criterios_rgf_A04_receitas)))

# -----------------------------------------------------------------------------
# 2. Opera√ß√µes Extraor√ßament√°rias
# -----------------------------------------------------------------------------

df_criterios_rgf_A04_extra_orcamentarias <- aplicar_criterios(
  rgf_a02_balancete, 
  criterios_rgf_A04_extra_orcamentarias
)

cat(sprintf("‚úÖ Extraor√ßament√°rias processadas: %d registros\n", 
            nrow(df_criterios_rgf_A04_extra_orcamentarias)))

# -----------------------------------------------------------------------------
# 3. Despesas (Aplica√ß√£o dos Recursos)
# -----------------------------------------------------------------------------

df_criterios_rgf_A04_despesas <- aplicar_criterios(
  rgf_a04_despesas, 
  criterios_rgf_A04_despesas
)

cat(sprintf("‚úÖ Despesas processadas: %d registros\n", nrow(df_criterios_rgf_A04_despesas)))
```

## Consolida√ß√£o dos Resultados

```{r consolidar-rgf-a04}
#| code-fold: true
#| code-summary: "Ver c√≥digo de consolida√ß√£o"

# =============================================================================
# CONSOLIDA√á√ÉO DOS RESULTADOS
# =============================================================================

# -----------------------------------------------------------------------------
# Consolidar todas as partes
# -----------------------------------------------------------------------------

df_rgf_A04_consolidado <- bind_rows(
  df_criterios_rgf_A04_receitas,
  df_criterios_rgf_A04_extra_orcamentarias,
  df_criterios_rgf_A04_despesas
) %>%
  arrange(ordem)

# -----------------------------------------------------------------------------
# Agregar por ordem/nome
# -----------------------------------------------------------------------------

operacoes_credito_agregado <- df_rgf_A04_consolidado %>%
  group_by(ordem, nome) %>%
  summarise(
    valor = sum(valor, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(ordem)

# =============================================================================
# CALCULAR TOTAIS PARA VARI√ÅVEIS GLOBAIS
# =============================================================================

# Total de Opera√ß√µes de Cr√©dito (linhas 01-15)
valor_operacoes_credito_total <- operacoes_credito_agregado %>%
  filter(as.numeric(ordem) <= 15) %>%
  summarise(valor = sum(valor, na.rm = TRUE)) %>%
  pull(valor)

# Total de Aplica√ß√£o dos Recursos (linhas 16-21)
valor_aplicacao_recursos_total <- operacoes_credito_agregado %>%
  filter(as.numeric(ordem) >= 16) %>%
  summarise(valor = sum(valor, na.rm = TRUE)) %>%
  pull(valor)

cat(sprintf("\n‚úÖ Consolida√ß√£o conclu√≠da\n"))
cat(sprintf("   Total Opera√ß√µes de Cr√©dito: R$ %s\n", formatar_numero(valor_operacoes_credito_total)))
cat(sprintf("   Total Aplica√ß√£o Recursos:   R$ %s\n", formatar_numero(valor_aplicacao_recursos_total)))
```

## Resultados

### Receitas de Opera√ß√µes de Cr√©dito

```{r resultado-receitas-rgf-a04}
#| code-fold: true
#| column: page

# =============================================================================
# EXIBIR RECEITAS
# =============================================================================

datatable(
  df_criterios_rgf_A04_receitas %>%
    group_by(ordem, nome) %>%
    summarise(valor = sum(valor, na.rm = TRUE), .groups = "drop") %>%
    arrange(ordem),
  caption = "RGF Anexo 04 - Receitas de Opera√ß√µes de Cr√©dito (Or√ßament√°rias)",
  rownames = FALSE,
  options = list(
    pageLength = -1,
    scrollX = TRUE,
    dom = 't'
  )
) %>% 
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")
```

### Opera√ß√µes Extraor√ßament√°rias

```{r resultado-extra-rgf-a04}
#| code-fold: true
#| column: page

# =============================================================================
# EXIBIR EXTRAOR√áAMENT√ÅRIAS
# =============================================================================

datatable(
  df_criterios_rgf_A04_extra_orcamentarias %>%
    group_by(ordem, nome) %>%
    summarise(valor = sum(valor, na.rm = TRUE), .groups = "drop") %>%
    arrange(ordem),
  caption = "RGF Anexo 04 - Opera√ß√µes Extraor√ßament√°rias",
  rownames = FALSE,
  options = list(
    pageLength = -1,
    scrollX = TRUE,
    dom = 't'
  )
) %>% 
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")
```

### Aplica√ß√£o dos Recursos (Despesas)

```{r resultado-despesas-rgf-a04}
#| code-fold: true
#| column: page

# =============================================================================
# EXIBIR DESPESAS
# =============================================================================

datatable(
  df_criterios_rgf_A04_despesas %>%
    group_by(ordem, nome) %>%
    summarise(valor = sum(valor, na.rm = TRUE), .groups = "drop") %>%
    arrange(ordem),
  caption = "RGF Anexo 04 - Aplica√ß√£o dos Recursos (Despesas)",
  rownames = FALSE,
  options = list(
    pageLength = -1,
    scrollX = TRUE,
    dom = 't'
  )
) %>% 
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")
```

### Consolidado

```{r resultado-consolidado-rgf-a04}
#| code-fold: true
#| column: page

# =============================================================================
# EXIBIR CONSOLIDADO
# =============================================================================

datatable(
  operacoes_credito_agregado,
  caption = "RGF Anexo 04 - Demonstrativo Consolidado",
  rownames = FALSE,
  options = list(
    pageLength = -1,
    scrollX = TRUE,
    lengthMenu = list(c(10, 25, 50, -1), c('10', '25', '50', 'Todas'))
  )
) %>% 
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")
```

## Resumo das Opera√ß√µes

```{r resumo-rgf-a04}
#| code-fold: true
#| code-summary: "Ver resumo das opera√ß√µes"

# =============================================================================
# RESUMO DAS OPERA√á√ïES DE CR√âDITO
# =============================================================================

# Opera√ß√µes Mobili√°rias
mobiliaria_interna <- operacoes_credito_agregado %>%
  filter(ordem %in% c("01", "02", "03", "04", "05")) %>%
  summarise(valor = sum(valor, na.rm = TRUE)) %>%
  pull(valor)

mobiliaria_externa <- operacoes_credito_agregado %>%
  filter(ordem %in% c("06", "07", "08")) %>%
  summarise(valor = sum(valor, na.rm = TRUE)) %>%
  pull(valor)

# Opera√ß√µes Contratuais
contratual_interna <- operacoes_credito_agregado %>%
  filter(ordem %in% c("09", "10", "11")) %>%
  summarise(valor = sum(valor, na.rm = TRUE)) %>%
  pull(valor)

contratual_externa <- operacoes_credito_agregado %>%
  filter(ordem %in% c("12", "13", "14", "15")) %>%
  summarise(valor = sum(valor, na.rm = TRUE)) %>%
  pull(valor)

# Exibir resumo
cat("\nüìä RESUMO DAS OPERA√á√ïES DE CR√âDITO\n")
cat("===================================\n\n")

cat("OPERA√á√ïES DE CR√âDITO:\n")
cat(sprintf("  Mobili√°ria Interna:   R$ %s\n", formatar_numero(mobiliaria_interna)))
cat(sprintf("  Mobili√°ria Externa:   R$ %s\n", formatar_numero(mobiliaria_externa)))
cat(sprintf("  Contratual Interna:   R$ %s\n", formatar_numero(contratual_interna)))
cat(sprintf("  Contratual Externa:   R$ %s\n", formatar_numero(contratual_externa)))
cat(sprintf("  TOTAL:                R$ %s\n\n", formatar_numero(valor_operacoes_credito_total)))

cat("APLICA√á√ÉO DOS RECURSOS:\n")
cat(sprintf("  TOTAL:                R$ %s\n", formatar_numero(valor_aplicacao_recursos_total)))
```

## Notas Metodol√≥gicas

```{r notas-rgf-a04}
#| echo: false

# =============================================================================
# NOTAS METODOL√ìGICAS
# =============================================================================

notas <- tibble::tribble(
  ~Item, ~Descri√ß√£o,
  "1", "Valores em R$ (reais)",
  "2", "Contas 621* = Receitas de opera√ß√µes de cr√©dito (or√ßament√°rias)",
  "3", "Contas 622* = Execu√ß√£o de despesa (aplica√ß√£o dos recursos)",
  "4", "Contas 896* = Emiss√µes extraor√ßament√°rias de t√≠tulos",
  "5", "Opera√ß√µes mobili√°rias = t√≠tulos p√∫blicos",
  "6", "Opera√ß√µes contratuais = empr√©stimos e financiamentos",
  "7", "O balancete (rgf_a02_balancete) √© compartilhado com o RGF Anexo 02"
)

knitr::kable(notas, col.names = c("Item", "Descri√ß√£o"))
```

## Observa√ß√µes Importantes

::: callout-note
### Limite de Opera√ß√µes de Cr√©dito (LRF)

O limite de opera√ß√µes de cr√©dito conforme a LRF √© de **16% da RCL** para a Uni√£o. O valor deve ser comparado com este limite no RGF Anexo 06 (Demonstrativo Simplificado).
:::

::: callout-warning
### Opera√ß√µes Extraor√ßament√°rias

As opera√ß√µes extraor√ßament√°rias (linhas 03-05, 07, 10, 13-14) utilizam dados do **balancete** (rgf_a02_balancete), que √© compartilhado com o RGF Anexo 02. Certifique-se de que este arquivo foi importado antes de processar o Anexo 04.
:::

::: callout-tip
### Naturezas de Receita

As principais naturezas de receita utilizadas s√£o:

-   **2111**: Opera√ß√µes de Cr√©dito Internas - Mobili√°rias
-   **2112**: Opera√ß√µes de Cr√©dito Internas - Contratuais
-   **2121**: Opera√ß√µes de Cr√©dito Externas - Mobili√°rias
-   **2122**: Opera√ß√µes de Cr√©dito Externas - Contratuais
:::

# üìã RGF Anexo 05 - Disponibilidades de Caixa {#sec-rgf-a05}

## Ficha T√©cnica

```{r ficha-tecnica-rgf-a05}
#| echo: false

# =============================================================================
# FICHA T√âCNICA DO ANEXO
# =============================================================================

ficha_tecnica <- tibble::tribble(
  ~Campo,                 ~Informa√ß√£o,
  "Relat√≥rio",            "RGF - Relat√≥rio de Gest√£o Fiscal",
  "Anexo",                "Anexo 05",
  "Nome",                 "Demonstrativo da Disponibilidade de Caixa e dos Restos a Pagar",
  "Base Legal",           "LRF Art. 55, inciso III, al√≠nea 'a'",
  "Periodicidade",        "Quadrimestral",
  "Grau de Dificuldade",  "‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Muito Dif√≠cil",
  "√öltima Atualiza√ß√£o",   format(Sys.Date(), "%d/%m/%Y")
)

knitr::kable(ficha_tecnica, col.names = c("Campo", "Informa√ß√£o"))
```

## Arquivos Necess√°rios

```{r arquivos-rgf-a05}
#| echo: false

# =============================================================================
# ARQUIVOS DO TESOURO GERENCIAL UTILIZADOS
# =============================================================================

arquivos <- tibble::tribble(
  ~Arquivo,                              ~Descri√ß√£o,                                    ~Filtros_TG,
  "rgf_a05_111_ate_fonte_002.xlsx",      "Disponibilidades fontes 000-002",             "Or√ß. Fiscal, Fontes 000-002",
  "rgf_a05_111_fonte_003_052.xlsx",      "Disponibilidades fontes 003-052",             "Or√ß. Fiscal, Fontes 003-052",
  "rgf_a05_111_fonte_053_em_diante_executivo.xlsx", "Disponibilidades fontes 053+ (Exec.)", "Or√ß. Fiscal, Fontes 053+, Poder Executivo",
  "rgf_a05_111_fonte_053_em_diante_demais.xlsx",    "Disponibilidades fontes 053+ (Demais)", "Or√ß. Fiscal, Fontes 053+, Demais Poderes",
  "rgf_a05_21.xlsx",                     "Passivos circulantes",                        "Or√ß. Fiscal, Contas 21*",
  "rgf_a05_22_23.xlsx",                  "Passivos n√£o circulantes",                    "Or√ß. Fiscal, Contas 22* e 23*",
  "rgf_a05_contas_contabeis.xlsx",       "Contas cont√°beis espec√≠ficas",                "Or√ß. Fiscal, Contas espec√≠ficas",
  "disponibilidade_inicial.xlsx",         "Disponibilidade inicial (arquivo auxiliar)",  "Planilha Excel com abas Uni√£o e Executivo"
)

knitr::kable(arquivos, col.names = c("Arquivo", "Descri√ß√£o", "Filtros no TG"))
```

## Atributos Utilizados

```{r atributos-rgf-a05}
#| echo: false

# =============================================================================
# ATRIBUTOS (COLUNAS) DOS ARQUIVOS E SEUS USOS
# =============================================================================

atributos <- tibble::tribble(
  ~Atributo,                                    ~Tipo,       ~Uso,                  ~Descri√ß√£o,
  "conta_contabil_numero",                      "character", "TG / Crit√©rio",       "N√∫mero da conta cont√°bil (PCASP)",
  "fonte_recursos_codigo",                      "character", "TG / Crit√©rio",       "C√≥digo da fonte de recursos",
  "isf_lancamento",                             "character", "TG / Crit√©rio",       "Indicador de Super√°vit Financeiro (F/P)",
  "ug_executora_codigo",                        "character", "TG / Crit√©rio",       "C√≥digo da UG executora",
  "orgao_c_cor_codigo",                         "character", "TG / Crit√©rio",       "C√≥digo do √≥rg√£o (conta corrente)",
  "orgao_uge_poder_codigo",                     "character", "TG / Crit√©rio",       "C√≥digo do poder (0=Executivo)",
  "orgao_uge_orgao_maximo_codigo",              "character", "TG / Crit√©rio",       "C√≥digo do √≥rg√£o m√°ximo",
  "detalhe_orgao_central_codigo_detalhe_oc",    "character", "TG / Crit√©rio",       "C√≥digo detalhe √≥rg√£o central",
  "detalhe_orgao_central_id_fonte",             "character", "TG / Crit√©rio",       "ID fonte √≥rg√£o central",
  "mes_lancamento",                             "numeric",   "TG / R",              "M√™s do lan√ßamento (YYYYMM)",
  "saldo_r_conta_contabil",                     "numeric",   "TG / R",              "Saldo da conta cont√°bil",
  "data_lancamento",                            "Date",      "R",                   "Data calculada do lan√ßamento"
)

knitr::kable(atributos, col.names = c("Atributo", "Tipo", "Uso", "Descri√ß√£o"))
```

## V√≠nculos com Outros Anexos

```{r vinculos-rgf-a05}
#| echo: false

# =============================================================================
# RELACIONAMENTO COM OUTROS ANEXOS
# =============================================================================

vinculos <- tibble::tribble(
  ~Anexo_Relacionado,   ~Tipo_V√≠nculo,    ~Descri√ß√£o,
  "RGF Anexo 02",       "Refer√™ncia",     "Balancete para algumas contas espec√≠ficas",
  "RGF Anexo 06",       "Consolida√ß√£o",   "Valores consolidados no demonstrativo simplificado"
)

knitr::kable(vinculos, col.names = c("Anexo Relacionado", "Tipo de V√≠nculo", "Descri√ß√£o"))
```

## Estrutura do Demonstrativo

```{r estrutura-rgf-a05}
#| echo: false

# =============================================================================
# ESTRUTURA DO DEMONSTRATIVO - LINHAS POR FONTE DE RECURSOS
# =============================================================================

estrutura <- tibble::tribble(
  ~C√≥digo,                        ~Linha,                              ~Fontes,
  "0_nao_vinculados",             "Recursos N√£o Vinculados",           "000",
  "1_educacao",                   "Educa√ß√£o",                          "008, 012, 130, 133, 134, 142, 143, 151",
  "2_seguridade_exceto_previdencia", "Seguridade (exceto Previd√™ncia)", "001, 002, 004, 005, 006, 010, 017, 023, 024, 035, 040, ...",
  "3_rpps",                       "RPPS",                              "055, 056, 125",
  "4_rgps",                       "RGPS",                              "054",
  "5_divida",                     "D√≠vida",                            "400, 401, 443, 444, 448, + espec√≠ficas",
  "6_transferencias",             "Transfer√™ncias",                    "201-289",
  "7_fundos_orgaos_programa",     "Fundos, √ìrg√£os e Programas",        "003-199 (exceto anteriores)",
  "8_extraorcamentario",          "Extraor√ßament√°rio",                 "491",
  "9_nao_classificados",          "Recursos a Classificar",            "490, -9, -7"
)

knitr::kable(estrutura, col.names = c("C√≥digo", "Linha", "Fontes de Recursos"))
```

## Colunas do Demonstrativo

```{r colunas-rgf-a05}
#| echo: false

# =============================================================================
# COLUNAS DO DEMONSTRATIVO
# =============================================================================

colunas <- tibble::tribble(
  ~Coluna,                                    ~Descri√ß√£o,
  "Disponibilidade Inicial",                  "Saldo inicial do exerc√≠cio (arquivo auxiliar)",
  "Receitas",                                 "Receitas or√ßament√°rias realizadas",
  "Despesas",                                 "Despesas or√ßament√°rias pagas",
  "Demais Fluxos",                            "Ajustes e outros fluxos",
  "Disponibilidade Bruta",                    "Caixa bruto antes de obriga√ß√µes",
  "RP Liquidados NP - Exerc√≠cios Anteriores", "Restos a pagar liquidados n√£o pagos (anos anteriores)",
  "RP Liquidados NP - Do Exerc√≠cio",          "Restos a pagar liquidados n√£o pagos (ano atual)",
  "RP Empenhados NL - Exerc√≠cios Anteriores", "Restos a pagar empenhados n√£o liquidados",
  "Demais Obriga√ß√µes Financeiras",            "Outras obriga√ß√µes financeiras",
  "Disponibilidade Antes Inscri√ß√£o RP",       "Disponibilidade l√≠quida final"
)

knitr::kable(colunas, col.names = c("Coluna", "Descri√ß√£o"))
```

## Prepara√ß√£o dos Dados

```{r preparar-rgf-a05}
#| code-fold: true
#| code-summary: "Ver c√≥digo de prepara√ß√£o"

# =============================================================================
# PREPARA√á√ÉO DOS DADOS
# =============================================================================

# -----------------------------------------------------------------------------
# Criar chaves compostas para identifica√ß√£o
# -----------------------------------------------------------------------------

rgf_a05 <- rgf_a05 %>% 
  mutate(
    # Chave √≥rg√£o + fonte completa
    orgao_fonte = str_c(
      detalhe_orgao_central_codigo_detalhe_oc, "_",
      detalhe_orgao_central_id_fonte, "_",
      fonte_recursos_codigo
    ),
    
    # Chave √≥rg√£o + fonte (sem c√≥digo fonte)
    tg_orgao_fonte = str_c(
      detalhe_orgao_central_codigo_detalhe_oc, "_",
      detalhe_orgao_central_id_fonte
    )
  )

# -----------------------------------------------------------------------------
# Classificar por linhas (fontes de recursos)
# -----------------------------------------------------------------------------

# Operador auxiliar "not in"
`%notin%` <- Negate(`%in%`)

if (!"linhas" %in% names(rgf_a05)) {
  rgf_a05 <- rgf_a05 %>%
    mutate(
      linhas = case_when(
        # Recursos N√£o Vinculados
        fonte_recursos_codigo %in% c("000") ~ "0_nao_vinculados",
        
        # Educa√ß√£o
        fonte_recursos_codigo %in% c("008", "012", "130", "133", "134", "142", "143", "151") ~ "1_educacao",
        
        # Seguridade Social (exceto Previd√™ncia)
        fonte_recursos_codigo %in% c(
          "001", "002", "004", "005", "006", "010", "017", "023", "024", 
          "035", "040", "048", "049", "094", "126", "155", "156", "179", "184"
        ) ~ "2_seguridade_exceto_previdencia",
        fonte_recursos_codigo %in% c("122", "123") & 
          tg_orgao_fonte %notin% c("000278_153", "000278_154") ~ "2_seguridade_exceto_previdencia",
        
        # RPPS
        fonte_recursos_codigo %in% c("055", "056", "125") ~ "3_rpps",
        
        # RGPS
        fonte_recursos_codigo %in% c("054") ~ "4_rgps",
        
        # D√≠vida
        fonte_recursos_codigo %in% c("400", "401", "443", "444", "448") ~ "5_divida",
        fonte_recursos_codigo %in% c("034", "121", "122", "123") & 
          tg_orgao_fonte %in% c("000278_133", "000278_152", "000278_153", "000278_154") ~ "5_divida",
        
        # Transfer√™ncias
        fonte_recursos_codigo %in% c(
          "201", "202", "203", "206", "207", "208", "209", "210", "211", "213",
          "219", "229", "234", "235", "241", "242", "251", 
          "286", "287", "288", "289"
        ) ~ "6_transferencias",
        
        # Fundos, √ìrg√£os e Programas (demais fontes)
        fonte_recursos_codigo %in% c(
          "003", "007", "009", "011", "013", "014", "015", "016", "018", "019",
          "020", "021", "022", "025", "026", "027", "028", "029", "030", "031",
          "032", "033", "034", "037", "038", "039", "041", "042", "043", "044",
          "045", "046", "047", "050", "051", "052", "053", "057", "058", "059",
          "060", "061", "062", "063", "064", "065", "066", "067", "068", "069",
          "070", "071", "072", "073", "074", "075", "076", "077", "078", "079",
          "080", "081", "082", "083", "084", "085", "086", "087", "088", "089",
          "090", "091", "092", "093", "095", "096", "097", "098", "099", "100",
          "101", "102", "103", "104", "105", "106", "107", "108", "109", "110",
          "111", "112", "113", "114", "115", "116", "118", "119", "120", "121",
          "124", "127", "128", "129", "131", "132", "135", "136", "137", "138", 
          "139", "140", "141", "144", "145", "147", "149", "152", "153", "177",
          "178", "180", "181", "182", "183", "449"
        ) ~ "7_fundos_orgaos_programa",
        (fonte_recursos_codigo %in% c("034", "121") & 
           tg_orgao_fonte %notin% c("000278_133", "000278_152")) ~ "7_fundos_orgaos_programa",
        
        # Extraor√ßament√°rio
        fonte_recursos_codigo %in% c("491") ~ "8_extraorcamentario",
        
        # N√£o Classificados / A Classificar
        fonte_recursos_codigo %in% c("490", "'-9", "'-7") ~ "9_nao_classificados",
        
        # Outros (n√£o classificados nas categorias acima)
        TRUE ~ "outros"
      )
    )
}

cat("‚úÖ Dados preparados com classifica√ß√£o de linhas\n")

# Verificar distribui√ß√£o
cat("\nüìä Distribui√ß√£o por linha:\n")
rgf_a05 %>% 
  count(linhas) %>%
  arrange(linhas) %>%
  print()
```

## Crit√©rios de Classifica√ß√£o

```{r criterios-rgf-a05}
#| code-fold: true
#| code-summary: "Ver crit√©rios de classifica√ß√£o"

# =============================================================================
# CRIT√âRIOS RGF ANEXO 05 - DISPONIBILIDADE DE CAIXA E RESTOS A PAGAR
# =============================================================================
# 22 crit√©rios para classifica√ß√£o das contas cont√°beis
# =============================================================================

criterios_rgf_a05_disponibilidade <- list(
  
  # ===========================================================================
  # RECEITAS E DESPESAS
  # ===========================================================================
  
  `01_receitas` = list(
    criterio = "
    conta_contabil_numero %in% c('621200000', '621310000', '621320000', 
                                  '621330000', '621390000')
    "
  ),
  
  `02_despesas` = list(
    criterio = "
    conta_contabil_numero %in% c('622920104', '631400000', '632200000')
    "
  ),
  
  # ===========================================================================
  # DISPONIBILIDADE DE CAIXA
  # ===========================================================================
  
  `03_disponibilidade_caixa_bruta` = list(
    criterio = "
    startsWith(conta_contabil_numero, '111') &
    isf_lancamento == 'F' &
    conta_contabil_numero != '111110205'
    "
  ),
  
  `04_deducao_receitas_classificar` = list(
    criterio = "
    conta_contabil_numero %in% c('111113001', '491110101', '491110102', '491110103', 
                                  '491110108', '491010101', '491010102', '491010103', 
                                  '491019701', '491019702', '491019703')
    "
  ),
  
  # ===========================================================================
  # RESTOS A PAGAR
  # ===========================================================================
  
  `05_rp_liquidados_nao_pagos_exercicios_anteriores` = list(
    criterio = "
    conta_contabil_numero %in% c('632100000', '631300000')
    "
  ),
  
  `06_rp_liquidados_nao_pagos_exercicio` = list(
    criterio = "
    conta_contabil_numero %in% c('632710000', '632720000', '632700000')
    "
  ),
  
  `07_rp_empenhados_nao_liquidados_exercicios_anteriores` = list(
    criterio = "
    conta_contabil_numero %in% c('631100000', '631200000', '631510000', '631520000', 
                                  '631530000', '631810000', '631820000', '631830000', 
                                  '631840000', '631540000')
    "
  ),
  
  # ===========================================================================
  # DEMAIS OBRIGA√á√ïES
  # ===========================================================================
  
  `08_demais_obrigacoes_i` = list(
    criterio = "
    startsWith(conta_contabil_numero, '2') &
    isf_lancamento == 'F' &
    !conta_contabil_numero %in% c('218923901', '218923902', '218923903', '218914001')
    "
  ),
  
  `09_demais_obrigacoes_ii_2f_da_codiv` = list(
    criterio = "
    startsWith(conta_contabil_numero, '2') &
    isf_lancamento == 'F' &
    ug_executora_codigo == '170600'
    "
  ),
  
  `10_deducao_demais_obrigacoes_i` = list(
    criterio = "
    conta_contabil_numero %in% c('631570000', '631590000', '631540000', '632100000', 
                                  '632720000', '531710200', '531720100', '218923901')
    "
  ),
  
  `11_rp_empenhados_nao_liquidados_exercicio` = list(
    criterio = "
    conta_contabil_numero %in% c('531710100', '531710200', '531720100')
    "
  ),
  
  `12_empenhos_nao_liquidados_cancelados` = list(
    criterio = "
    conta_contabil_numero == '631910000'
    "
  ),
  
  # ===========================================================================
  # CONTAS ESPEC√çFICAS
  # ===========================================================================
  
  `13_conta_822240101_recebimento_rp_autorizado` = list(
    criterio = "
    conta_contabil_numero == '822240101'
    "
  ),
  
  `14_conta_822140101_liberacao_rp_autorizado` = list(
    criterio = "
    conta_contabil_numero == '822140101'
    "
  ),
  
  `15_conta_894310000_disp_recursos_ted_liberar` = list(
    criterio = "
    conta_contabil_numero == '894310000'
    "
  ),
  
  `16_conta_894320000_disp_recursos_ted_receber` = list(
    criterio = "
    conta_contabil_numero == '894320000'
    "
  ),
  
  # ===========================================================================
  # DEDU√á√ïES
  # ===========================================================================
  
  `17_deducao_limite_saque_i` = list(
    criterio = "
    conta_contabil_numero %in% c('218924001') &
    isf_lancamento == 'F'
    "
  ),
  
  `18_deducao_limite_saque_ii_poder_executivo` = list(
    criterio = "
    conta_contabil_numero %in% c('218924001', '218924002') &
    orgao_c_cor_codigo %in% c('01000', '02000', '02001', '11000', '12000', 
                              '13000', '14000', '15000', '17000', '34000', 
                              '51100', '53000') &
    isf_lancamento == 'F'
    "
  ),
  
  `19_deducao_disponibilidade_liquida_111110205` = list(
    criterio = "
    conta_contabil_numero == '111110205'
    "
  ),
  
  `20_deducao_demais_obrigacoes_ii` = list(
    criterio = "
    conta_contabil_numero %in% c('218924001', '218914001') &
    isf_lancamento == 'F'
    "
  ),
  
  # ===========================================================================
  # DEMAIS OBRIGA√á√ïES (NOVOS)
  # ===========================================================================
  
  `21_demais_obrigacoes_new` = list(
    criterio = "
    startsWith(conta_contabil_numero, '2') &
    !conta_contabil_numero %in% c('218923901', '218923902', '218923903', 
                                   '218924001', '218914001') &
    isf_lancamento == 'F' &
    ug_executora_codigo != '170600'
    "
  ),
  
  `22_demais_obrigacoes_subtracao` = list(
    criterio = "
    conta_contabil_numero %in% c('631200000', '631300000', '631520000', '632100000', 
                                  '631540000', '218929031', '218929032', '218929033', 
                                  '531720100', '531710200', '632710000', '632720000')
    "
  )
)

cat("‚úÖ Crit√©rios RGF Anexo 05 definidos\n")
cat(sprintf("   Total de categorias: %d\n", length(criterios_rgf_a05_disponibilidade)))
```

## Aplica√ß√£o dos Crit√©rios

```{r aplicar-criterios-rgf-a05}
#| code-fold: true
#| code-summary: "Ver c√≥digo de aplica√ß√£o dos crit√©rios"

# =============================================================================
# APLICA√á√ÉO DOS CRIT√âRIOS
# =============================================================================

cat("üìä Processando crit√©rios do RGF Anexo 05...\n")

# -----------------------------------------------------------------------------
# Fun√ß√£o auxiliar para obter coluna (com fallback para 0)
# -----------------------------------------------------------------------------

get_col <- function(df, nome_coluna) {
  if (nome_coluna %in% names(df)) {
    return(df[[nome_coluna]])
  } else {
    return(0)
  }
}

# -----------------------------------------------------------------------------
# Criar abrang√™ncias: Uni√£o e Executivo
# -----------------------------------------------------------------------------

# Uni√£o: TODOS os registros
rgf_a05_uniao <- rgf_a05 %>%
  mutate(abrangencia = "uniao")

# Executivo: Apenas Poder Executivo, exceto DPU (34000) e MPU (59000)
rgf_a05_executivo <- rgf_a05 %>%
  filter(
    orgao_uge_poder_codigo == "0" & 
    !(orgao_uge_orgao_maximo_codigo %in% c("34000", "59000"))
  ) %>%
  mutate(abrangencia = "executivo")

# Combinar as duas abrang√™ncias
rgf_a05_abrangencia <- bind_rows(rgf_a05_uniao, rgf_a05_executivo)

cat(sprintf("‚úÖ Uni√£o: %s registros\n", 
            format(nrow(rgf_a05_uniao), big.mark = ".", decimal.mark = ",")))
cat(sprintf("‚úÖ Executivo: %s registros\n", 
            format(nrow(rgf_a05_executivo), big.mark = ".", decimal.mark = ",")))

# -----------------------------------------------------------------------------
# Aplicar crit√©rios COM abrang√™ncia
# -----------------------------------------------------------------------------

resultado_rgf_a05 <- aplicar_criterios(
  df = rgf_a05_abrangencia,
  criterios = criterios_rgf_a05_disponibilidade,
  group_vars = c("linhas", "abrangencia")
)

cat(sprintf("‚úÖ Crit√©rios aplicados: %d registros\n", nrow(resultado_rgf_a05)))
```

## C√°lculos e Consolida√ß√£o

```{r calcular-rgf-a05}
#| code-fold: true
#| code-summary: "Ver c√≥digo de c√°lculos"

# =============================================================================
# C√ÅLCULOS DO DEMONSTRATIVO
# =============================================================================

# -----------------------------------------------------------------------------
# Pivotar para formato wide
# -----------------------------------------------------------------------------

rgf_a05_wide <- resultado_rgf_a05 %>%
  select(mes_lancamento, linhas, abrangencia, categoria, valor) %>%
  pivot_wider(names_from = categoria, values_from = valor, values_fill = 0)

# -----------------------------------------------------------------------------
# Renomear colunas b√°sicas
# -----------------------------------------------------------------------------

rgf_a05_wide <- rgf_a05_wide %>%
  mutate(
    # Receitas e despesas
    receitas = get_col(., "01_receitas"),
    despesas = get_col(., "02_despesas"),
    
    # Disponibilidade de caixa
    disponibilidade_caixa_bruta = get_col(., "03_disponibilidade_caixa_bruta"),
    deducao_receitas_classificar = get_col(., "04_deducao_receitas_classificar"),
    
    # Restos a Pagar
    rp_liquidados_nao_pagos_exercicios_anteriores = 
      get_col(., "05_rp_liquidados_nao_pagos_exercicios_anteriores"),
    rp_liquidados_nao_pagos_exercicio = 
      get_col(., "06_rp_liquidados_nao_pagos_exercicio"),
    rp_empenhados_nao_liquidados_exercicios_anteriores = 
      get_col(., "07_rp_empenhados_nao_liquidados_exercicios_anteriores"),
    # RP Empenhados Nao Liquidados do Exercicio (so tem saldo em dezembro)
    rp_empenhados_nao_liquidados_exercicio = 
      get_col(., "11_rp_empenhados_nao_liquidados_exercicio"),
    
    # Obriga√ß√µes
    demais_obrigacoes_new = get_col(., "21_demais_obrigacoes_new"),
    demais_obrigacoes_subtracao = get_col(., "22_demais_obrigacoes_subtracao"),
    
    # TEDs
    conta_894310000_disp_recursos_ted_liberar = 
      get_col(., "15_conta_894310000_disp_recursos_ted_liberar"),
    conta_894320000_disp_recursos_ted_receber = 
      get_col(., "16_conta_894320000_disp_recursos_ted_receber")
  )

# -----------------------------------------------------------------------------
# Calcular Disponibilidade Bruta Clean
# -----------------------------------------------------------------------------

rgf_a05_clean <- rgf_a05_wide %>%
  mutate(
    disponibilidade_bruta_clean = case_when(
      linhas == "7_fundos_orgaos_programa" ~ 
        disponibilidade_caixa_bruta + 
        conta_894320000_disp_recursos_ted_receber - 
        conta_894310000_disp_recursos_ted_liberar,
      
      linhas == "9_nao_classificados" ~ 
        disponibilidade_caixa_bruta - deducao_receitas_classificar,
      
      TRUE ~ disponibilidade_caixa_bruta
    )
  )

# -----------------------------------------------------------------------------
# Calcular Demais Obriga√ß√µes Financeiras Clean
# -----------------------------------------------------------------------------

rgf_a05_clean <- rgf_a05_clean %>%
  mutate(
    demais_obrigacoes_financeiras_clean = case_when(
      linhas == "7_fundos_orgaos_programa" ~ 
        demais_obrigacoes_new - demais_obrigacoes_subtracao,
      
      TRUE ~ 
        demais_obrigacoes_new - demais_obrigacoes_subtracao + 
        conta_894310000_disp_recursos_ted_liberar - 
        conta_894320000_disp_recursos_ted_receber
    )
  )

# -----------------------------------------------------------------------------
# Ler Disponibilidade Inicial (arquivo auxiliar)
# -----------------------------------------------------------------------------

# Verificar se arquivo existe
arquivo_disp_inicial <- "disponibilidade_inicial.xlsx"

if (file.exists(arquivo_disp_inicial)) {
  # Ler aba Uni√£o
  disp_inicial_uniao <- read_excel(arquivo_disp_inicial, sheet = "uniao") %>%
    mutate(abrangencia = "uniao")
  
  # Ler aba Executivo
  disp_inicial_executivo <- read_excel(arquivo_disp_inicial, sheet = "executivo") %>%
    mutate(abrangencia = "executivo")
  
  # Combinar as duas abas
  disponibilidade_inicial <- bind_rows(disp_inicial_uniao, disp_inicial_executivo)
  
  # Join com dados processados
  rgf_a05_clean <- rgf_a05_clean %>%
    left_join(disponibilidade_inicial, by = c("linhas", "abrangencia"))
  
  cat("‚úÖ Disponibilidade inicial carregada\n")
} else {
  # Criar coluna com zeros se arquivo n√£o existir
  rgf_a05_clean <- rgf_a05_clean %>%
    mutate(disponibilidade_inicial = 0)
  
  cat("‚ö†Ô∏è Arquivo disponibilidade_inicial.xlsx n√£o encontrado - usando zeros\n")
}

# -----------------------------------------------------------------------------
# Calcular Demais Fluxos Clean
# -----------------------------------------------------------------------------

rgf_a05_clean <- rgf_a05_clean %>%
  mutate(
    demais_fluxos_clean = 
      disponibilidade_inicial + 
      receitas - 
      despesas - 
      disponibilidade_bruta_clean
  )

# -----------------------------------------------------------------------------
# Calcular Disponibilidade Antes da Inscri√ß√£o de RP
# -----------------------------------------------------------------------------

rgf_a05_clean <- rgf_a05_clean %>%
  mutate(
    disponibilidade_antes_inscr_rp_clean = 
      disponibilidade_bruta_clean - 
      rp_liquidados_nao_pagos_exercicios_anteriores - 
      rp_empenhados_nao_liquidados_exercicios_anteriores - 
      rp_liquidados_nao_pagos_exercicio - 
      demais_obrigacoes_financeiras_clean
  )

# -----------------------------------------------------------------------------
# Calcular Disponibilidade APOS Inscricao de RP NP (apenas dezembro)
# -----------------------------------------------------------------------------

rgf_a05_clean <- rgf_a05_clean %>%
  mutate(
    # Disponibilidade apos inscricao de RP NP (subtrair RP Emp NL do Exercicio)
    disponibilidade_apos_inscr_rp_clean = 
      disponibilidade_antes_inscr_rp_clean - 
      rp_empenhados_nao_liquidados_exercicio
  )

cat("‚úÖ C√°lculos conclu√≠dos\n")
```

## Resultados Finais

```{r resultado-final-rgf-a05}
#| code-fold: true
#| code-summary: "Ver c√≥digo de resultados"

# =============================================================================
# PREPARAR RESULTADOS FINAIS
# =============================================================================

# -----------------------------------------------------------------------------
# Selecionar e ordenar colunas finais
# -----------------------------------------------------------------------------

rgf_a05_final <- rgf_a05_clean %>%
  select(
    mes_lancamento,
    linhas,
    abrangencia,
    disponibilidade_inicial,
    receitas,
    despesas,
    demais_fluxos_clean,
    disponibilidade_bruta_clean,
    rp_liquidados_nao_pagos_exercicios_anteriores,
    rp_liquidados_nao_pagos_exercicio,
    rp_empenhados_nao_liquidados_exercicios_anteriores,
    rp_empenhados_nao_liquidados_exercicio,
    demais_obrigacoes_financeiras_clean,
    disponibilidade_antes_inscr_rp_clean,
    disponibilidade_apos_inscr_rp_clean
  ) %>%
  arrange(abrangencia, linhas)

# -----------------------------------------------------------------------------
# Separar Uni√£o e Executivo
# -----------------------------------------------------------------------------

rgf_a05_resultado_uniao <- rgf_a05_final %>%
  filter(abrangencia == "uniao") %>%
  select(-abrangencia)

rgf_a05_resultado_executivo <- rgf_a05_final %>%
  filter(abrangencia == "executivo") %>%
  select(-abrangencia)

# -----------------------------------------------------------------------------
# Fun√ß√£o para formatar tabelas
# -----------------------------------------------------------------------------

formatar_tabela_a05 <- function(df) {
  df %>% 
    filter(linhas != "outros") %>% 
    adorn_totals("row", name = "Total") %>%
    mutate(
      across(
        where(is.numeric) & !matches("mes_lancamento"),
        ~ round(.x, 2)
      )
    )
}

rgf_a05_uniao_formatada <- formatar_tabela_a05(rgf_a05_resultado_uniao)
rgf_a05_executivo_formatada <- formatar_tabela_a05(rgf_a05_resultado_executivo)


# -----------------------------------------------------------------------------
# Fun√ß√£o auxiliar para identificar colunas num√©ricas (exceto mes_lancamento)
# -----------------------------------------------------------------------------

get_numeric_cols <- function(df) {
  df_sem_mes <- df %>% select(-any_of("mes_lancamento"))
  which(sapply(df_sem_mes, is.numeric))
}

# =============================================================================
# CALCULAR TOTAIS PARA VARI√ÅVEIS GLOBAIS
# =============================================================================

# Total de Disponibilidade ANTES - Executivo
valor_disponibilidade_executivo <- rgf_a05_executivo_formatada %>%
  filter(linhas == "Total") %>%
  pull(disponibilidade_antes_inscr_rp_clean)

# Total de Disponibilidade AP√ìS - Executivo (s√≥ dezembro)
valor_disponibilidade_executivo_apos_rp <- rgf_a05_executivo_formatada %>%
  filter(linhas == "Total") %>%
  pull(disponibilidade_apos_inscr_rp_clean)

# Total de Disponibilidade ANTES - Uni√£o
valor_disponibilidade_uniao <- rgf_a05_uniao_formatada %>%
  filter(linhas == "Total") %>%
  pull(disponibilidade_antes_inscr_rp_clean)

# Total de Disponibilidade AP√ìS - Uni√£o (s√≥ dezembro)
valor_disponibilidade_uniao_apos_rp <- rgf_a05_uniao_formatada %>%
  filter(linhas == "Total") %>%
  pull(disponibilidade_apos_inscr_rp_clean)


cat(sprintf("\n‚úÖ Disponibilidade Final - Uni√£o: R$ %s\n", 
            formatar_numero(valor_disponibilidade_uniao)))
cat(sprintf("‚úÖ Disponibilidade Final - Executivo: R$ %s\n", 
            formatar_numero(valor_disponibilidade_executivo)))
```

### Tabela Uni√£o (Todos os Poderes)

```{r tabela-uniao-rgf-a05}
#| column: screen

#| column: screen

# =============================================================================
# TABELA UNI√ÉO
# =============================================================================

# Preparar nomes das colunas
novos_nomes <- rgf_a05_uniao_formatada %>% 
  select(-mes_lancamento) %>% 
  colnames() %>%
  gsub("_clean", "", .) %>%
  gsub("_", " ", .) %>%
  gsub("nao pagos", "NP", .) %>%
  gsub("nao liquidados", "NL", .) %>%
  gsub("exercicios", "exerc.", .) %>%
  gsub("anteriores", "ant.", .) %>%
  gsub("liquidados", "liq.", .) %>%
  gsub("empenhados", "emp.", .) %>%
  gsub("disponibilidade", "disp.", .) %>%
  gsub("apos", "ap√≥s", .) %>%
  gsub("antes", "antes", .)

datatable(
  rgf_a05_uniao_formatada %>% select(-mes_lancamento),
  colnames = novos_nomes,
  caption = "RGF Anexo 05 - UNI√ÉO (Todos os Poderes)",
  options = list(scrollX = TRUE, pageLength = 15),
  rownames = FALSE
) %>%
  formatCurrency(
    columns = get_numeric_cols(rgf_a05_uniao_formatada %>% select(-mes_lancamento)),
    currency = "",
    mark = ".",
    dec.mark = ",",
    digits = 2
  )
```

### Tabela Poder Executivo

```{r tabela-executivo-rgf-a05}
#| column: screen

# =============================================================================
# TABELA EXECUTIVO
# =============================================================================

datatable(
  rgf_a05_executivo_formatada %>% select(-mes_lancamento),
  colnames = novos_nomes,
  caption = "RGF Anexo 05 - PODER EXECUTIVO (exceto DPU e MPU)",
  options = list(scrollX = TRUE, pageLength = 15),
  rownames = FALSE
) %>%
  formatCurrency(
    columns = get_numeric_cols(rgf_a05_executivo_formatada %>% select(-mes_lancamento)),
    currency = "",
    mark = ".",
    dec.mark = ",",
    digits = 2
  )
```

```{r}
# Total de Disponibilidade ANTES - Executivo
valor_disponibilidade_executivo <- rgf_a05_executivo_formatada %>%
  filter(mes_lancamento == "Total") %>%
  pull(disponibilidade_antes_inscr_rp_clean)

# Total de Disponibilidade AP√ìS - Executivo (s√≥ dezembro)
valor_disponibilidade_executivo_apos_rp <- rgf_a05_executivo_formatada %>%
  filter(mes_lancamento == "Total") %>%
  pull(disponibilidade_apos_inscr_rp_clean)

# Total de Disponibilidade ANTES - Uni√£o
valor_disponibilidade_uniao <- rgf_a05_uniao_formatada %>%
  filter(mes_lancamento == "Total") %>%
  pull(disponibilidade_antes_inscr_rp_clean)

# Total de Disponibilidade AP√ìS - Uni√£o (s√≥ dezembro)
valor_disponibilidade_uniao_apos_rp <- rgf_a05_uniao_formatada %>%
  filter(mes_lancamento == "Total") %>%
  pull(disponibilidade_apos_inscr_rp_clean)
```

## Notas Metodol√≥gicas

```{r notas-rgf-a05}
#| echo: false

# =============================================================================
# NOTAS METODOL√ìGICAS
# =============================================================================

notas <- tibble::tribble(
  ~Item, ~Descri√ß√£o,
  "1", "Valores em R$ (reais)",
  "2", "ISF = F indica item Financeiro",
  "3", "Uni√£o inclui todos os poderes e √≥rg√£os",
  "4", "Executivo exclui DPU (34000) e MPU (59000)",
  "5", "Disponibilidade inicial vem de arquivo auxiliar externo",
  "6", "Linhas s√£o classificadas por fonte de recursos",
  "7", "TEDs s√£o ajustados na linha 'Fundos, √ìrg√£os e Programas'",
  "8", "Recursos a Classificar t√™m dedu√ß√£o espec√≠fica"
)

knitr::kable(notas, col.names = c("Item", "Descri√ß√£o"))
```

## Observa√ß√µes Importantes

::: callout-warning
### Complexidade do Anexo

O RGF Anexo 05 √© um dos anexos mais complexos, envolvendo:

-   **M√∫ltiplos arquivos** segmentados por fonte de recursos
-   **Classifica√ß√£o de linhas** baseada em fontes
-   **Duas abrang√™ncias** (Uni√£o e Executivo)
-   **22 crit√©rios** de classifica√ß√£o
-   **Arquivo externo** de disponibilidade inicial
:::

::: callout-note
### Arquivo de Disponibilidade Inicial

O arquivo `disponibilidade_inicial.xlsx` deve conter duas abas:

-   **uniao**: Disponibilidade inicial para a Uni√£o
-   **executivo**: Disponibilidade inicial para o Poder Executivo

Cada aba deve ter as colunas: `linhas` e `disponibilidade_inicial`
:::

::: callout-tip
### Principais Contas Cont√°beis

-   **111**\*: Disponibilidades (caixa e equivalentes)
-   **2**\*: Passivos (obriga√ß√µes)
-   **631**\*: Restos a Pagar n√£o processados
-   **632**\*: Restos a Pagar processados
-   **894**\*: TEDs a liberar/receber
:::

# üìã RREO Anexo 01 - Balan√ßo Or√ßament√°rio {#sec-rreo-a01}

## Ficha T√©cnica

```{r ficha-tecnica-rreo-a01}
#| echo: false

# =============================================================================
# FICHA T√âCNICA DO ANEXO
# =============================================================================

ficha_tecnica <- tibble::tribble(
  ~Campo,                 ~Informa√ß√£o,
  "Relat√≥rio",            "RREO - Relat√≥rio Resumido da Execu√ß√£o Or√ßament√°ria",
  "Anexo",                "Anexo 01",
  "Nome",                 "Balan√ßo Or√ßament√°rio",
  "Base Legal",           "LRF Art. 52, inciso I e II, al√≠neas 'a' e 'b'",
  "Periodicidade",        "Bimestral",
  "Grau de Dificuldade",  "‚≠ê‚≠ê‚≠ê‚≠ê Dif√≠cil",
  "√öltima Atualiza√ß√£o",   format(Sys.Date(), "%d/%m/%Y")
)

knitr::kable(ficha_tecnica, col.names = c("Campo", "Informa√ß√£o"))
```

## Arquivos Necess√°rios

```{r arquivos-rreo-a01}
#| echo: false

# =============================================================================
# ARQUIVOS DO TESOURO GERENCIAL UTILIZADOS
# =============================================================================

arquivos <- tibble::tribble(
  ~Arquivo,                              ~Descri√ß√£o,                          ~Filtros_TG,
  "tg_receita_liquida.xlsx",             "Receitas realizadas",               "Or√ß. Fiscal, Item Informa√ß√£o",
  "tg_receita_previsao.xlsx",            "Previs√£o de receitas",              "Or√ß. Fiscal, Item Informa√ß√£o",
  "tg_despesa_dotacao_inicial.xlsx",     "Dota√ß√£o inicial de despesas",       "Or√ß. Fiscal",
  "tg_despesa_dotacao_atualizada_*.xlsx", "Dota√ß√£o atualizada (partes)",      "Or√ß. Fiscal",
  "tg_despesa_despesas_empenhadas_*.xlsx", "Despesas empenhadas (partes)",    "Or√ß. Fiscal",
  "tg_despesa_despesas_liquidadas.xlsx", "Despesas liquidadas",               "Or√ß. Fiscal",
  "tg_despesa_pagamentos_totais.xlsx",   "Despesas pagas",                    "Or√ß. Fiscal"
)

knitr::kable(arquivos, col.names = c("Arquivo", "Descri√ß√£o", "Filtros no TG"))
```

## Atributos Utilizados

### Receitas

```{r atributos-receitas-rreo-a01}
#| echo: false

# =============================================================================
# ATRIBUTOS DE RECEITAS
# =============================================================================

atributos_receitas <- tibble::tribble(
  ~Atributo,                               ~Tipo,       ~Uso,                  ~Descri√ß√£o,
  "nre1_categoria_economica_codigo",       "numeric",   "TG / Crit√©rio",       "Categoria econ√¥mica (1=Corrente, 2=Capital, 7/8=Intra)",
  "nre2_origem_receita_codigo_origem",     "numeric",   "TG / Crit√©rio",       "Origem da receita (1-9)",
  "nre3_especie_receita_codigo_especie",   "numeric",   "TG / Crit√©rio",       "Esp√©cie da receita",
  "natureza_receita_codigo_completo",      "character", "TG / Crit√©rio",       "C√≥digo completo da natureza de receita",
  "item_informacao_codigo",                "character", "TG / Crit√©rio",       "C√≥digo do item (1=Prev.Inicial, 2=Prev.Atualizada, 5=Realizada)",
  "item_informacao_nome",                  "character", "TG / Apresenta√ß√£o",   "Nome do item de informa√ß√£o",
  "mes_lancamento",                        "numeric",   "TG / R",              "M√™s do lan√ßamento (YYYYMM)",
  "saldo_r_item_informacao",               "numeric",   "TG / R",              "Saldo do item de informa√ß√£o"
)

knitr::kable(atributos_receitas, col.names = c("Atributo", "Tipo", "Uso", "Descri√ß√£o"))
```

### Despesas

```{r atributos-despesas-rreo-a01}
#| echo: false

# =============================================================================
# ATRIBUTOS DE DESPESAS
# =============================================================================

atributos_despesas <- tibble::tribble(
  ~Atributo,                               ~Tipo,       ~Uso,                  ~Descri√ß√£o,
  "categoria_economica_despesa_codigo",    "numeric",   "TG / Crit√©rio",       "Categoria econ√¥mica (3=Corrente, 4=Capital, 9=Reserva)",
  "grupo_despesa_codigo_grupo",            "numeric",   "TG / Crit√©rio",       "Grupo de despesa (1-6)",
  "modalidade_aplicacao_codigo",           "character", "TG / Crit√©rio",       "Modalidade de aplica√ß√£o (91=Intra)",
  "elemento_despesa_codigo",               "character", "TG / Crit√©rio",       "Elemento de despesa",
  "subfuncao_governo_codigo",              "character", "TG / Crit√©rio",       "Subfun√ß√£o de governo",
  "fonte_recursos_codigo",                 "character", "TG / Crit√©rio",       "Fonte de recursos",
  "unidade_orcamentaria_codigo",           "character", "TG / Crit√©rio",       "C√≥digo da unidade or√ßament√°ria",
  "item_informacao_codigo",                "character", "TG / Crit√©rio",       "C√≥digo do item de informa√ß√£o",
  "mes_lancamento",                        "numeric",   "TG / R",              "M√™s do lan√ßamento (YYYYMM)",
  "saldo_r_item_informacao",               "numeric",   "TG / R",              "Saldo do item de informa√ß√£o"
)

knitr::kable(atributos_despesas, col.names = c("Atributo", "Tipo", "Uso", "Descri√ß√£o"))
```

## V√≠nculos com Outros Anexos

```{r vinculos-rreo-a01}
#| echo: false

# =============================================================================
# RELACIONAMENTO COM OUTROS ANEXOS
# =============================================================================

vinculos <- tibble::tribble(
  ~Anexo_Relacionado,   ~Tipo_V√≠nculo,    ~Descri√ß√£o,
  "RREO Anexo 03",      "Refer√™ncia",     "RCL utiliza receitas correntes",
  "RREO Anexo 06",      "Refer√™ncia",     "Resultado prim√°rio utiliza receitas e despesas",
  "RREO Anexo 07",      "Refer√™ncia",     "Restos a pagar utiliza despesas"
)

knitr::kable(vinculos, col.names = c("Anexo Relacionado", "Tipo de V√≠nculo", "Descri√ß√£o"))
```

## Estrutura do Demonstrativo

### Receitas

```{r estrutura-receitas-rreo-a01}
#| echo: false

# =============================================================================
# ESTRUTURA - RECEITAS
# =============================================================================

estrutura_receitas <- tibble::tribble(
  ~Ordem, ~Item,                                           ~Grupo,
  "01",   "RECEITAS CORRENTES (I)",                        "Receitas Correntes",
  "02",   "Impostos, Taxas e Contribui√ß√µes de Melhoria",   "Receitas Correntes",
  "03",   "Impostos",                                      "Receitas Correntes",
  "04",   "Taxas",                                         "Receitas Correntes",
  "05",   "Contribui√ß√µes",                                 "Receitas Correntes",
  "06",   "Contribui√ß√µes Sociais",                         "Receitas Correntes",
  "07",   "Contribui√ß√µes de Interven√ß√£o no Dom√≠nio Econ.", "Receitas Correntes",
  "08",   "Receita Patrimonial",                           "Receitas Correntes",
  "16",   "Receita Agropecu√°ria",                          "Receitas Correntes",
  "17",   "Receita Industrial",                            "Receitas Correntes",
  "18",   "Receitas de Servi√ßos",                          "Receitas Correntes",
  "24",   "Transfer√™ncias Correntes",                      "Receitas Correntes",
  "32",   "Outras Receitas Correntes",                     "Receitas Correntes",
  "39",   "RECEITAS DE CAPITAL (II)",                      "Receitas de Capital",
  "40",   "Opera√ß√µes de Cr√©dito",                          "Receitas de Capital",
  "43",   "Aliena√ß√£o de Bens",                             "Receitas de Capital",
  "47",   "Amortiza√ß√µes de Empr√©stimos",                   "Receitas de Capital",
  "48",   "Transfer√™ncias de Capital",                     "Receitas de Capital",
  "55",   "Outras Receitas de Capital",                    "Receitas de Capital",
  "58",   "RECEITAS CORRENTES INTRA (I-I)",                "Receitas Intra",
  "79",   "SUBTOTAL DAS RECEITAS (III) = (I + II)",        "Subtotais",
  "80",   "OPERA√á√ïES DE CR√âDITO - REFINANCIAMENTO (IV)",   "Refinanciamento",
  "85",   "SUBTOTAL COM REFINANCIAMENTO (V) = (III + IV)", "Subtotais"
)

knitr::kable(estrutura_receitas, col.names = c("Ordem", "Item", "Grupo"))
```

### Despesas

```{r estrutura-despesas-rreo-a01}
#| echo: false

# =============================================================================
# ESTRUTURA - DESPESAS
# =============================================================================

estrutura_despesas <- tibble::tribble(
  ~Ordem, ~Item,                                              ~Grupo,
  "01",   "DESPESAS (Exceto Intra-Or√ßament√°rias) (IX)",       "Despesas",
  "02",   "Despesas Correntes",                               "Despesas Correntes",
  "03",   "Pessoal e Encargos Sociais",                       "Despesas Correntes",
  "04",   "Juros e Encargos da D√≠vida",                       "Despesas Correntes",
  "05",   "Outras Despesas Correntes",                        "Despesas Correntes",
  "06",   "Transfer√™ncia a Estados, DF e Munic√≠pios",         "Despesas Correntes",
  "07",   "Benef√≠cios Previdenci√°rios",                       "Despesas Correntes",
  "08",   "Demais Despesas Correntes",                        "Despesas Correntes",
  "09",   "Despesas de Capital",                              "Despesas de Capital",
  "10",   "Investimentos",                                    "Despesas de Capital",
  "11",   "Invers√µes Financeiras",                            "Despesas de Capital",
  "12",   "Amortiza√ß√£o da D√≠vida",                            "Despesas de Capital",
  "13",   "Reserva de Conting√™ncia",                          "Reserva",
  "14",   "DESPESAS INTRA-OR√áAMENT√ÅRIAS (X)",                 "Despesas Intra",
  "26",   "SUBTOTAL DAS DESPESAS (XI) = (IX + X)",            "Subtotais",
  "27",   "AMORTIZA√á√ÉO DA D√çVIDA - REFINANCIAMENTO (XII)",    "Refinanciamento",
  "34",   "SUBTOTAL COM REFINANCIAMENTO (XIII) = (XI + XII)", "Subtotais"
)

knitr::kable(estrutura_despesas, col.names = c("Ordem", "Item", "Grupo"))
```

## Crit√©rios de Classifica√ß√£o

### Receitas

```{r criterios-receitas-rreo-a01}
#| code-fold: true
#| code-summary: "Ver crit√©rios - Receitas"

# =============================================================================
# CRIT√âRIOS RREO ANEXO 01 - RECEITAS
# =============================================================================
# 85 crit√©rios para classifica√ß√£o das receitas or√ßament√°rias
# =============================================================================

criterios_rreo_A01_receitas_bo <- list(
  
  # ===========================================================================
  # RECEITAS CORRENTES
  # ===========================================================================
  
  `01_receitas_correntes` = list(
    criterio = "nre1_categoria_economica_codigo == 1"
  ),
  
  `02_impostos_taxas_contrib_melhoria` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 1 &
    nre3_especie_receita_codigo_especie %in% c(1, 2, 3)
    "
  ),
  
  `03_impostos` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 1 &
    nre3_especie_receita_codigo_especie == 1
    "
  ),
  
  `04_taxas` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 1 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  `05_contribuicoes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 2
    "
  ),
  
  `06_contribuicoes_sociais` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 2 &
    nre3_especie_receita_codigo_especie == 1
    "
  ),
  
  `07_contrib_intervencao_dominio_economico` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 2 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  `08_receita_patrimonial` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3
    "
  ),
  
  `09_exploracao_patrimonio_imobiliario` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3 &
    nre3_especie_receita_codigo_especie == 1
    "
  ),
  
  `10_valores_mobiliarios` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  `11_delegacao_servicos_publicos` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3 &
    nre3_especie_receita_codigo_especie == 3
    "
  ),
  
  `12_exploracao_recursos_naturais` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3 &
    nre3_especie_receita_codigo_especie == 4
    "
  ),
  
  `13_exploracao_patrimonio_intangivel` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3 &
    nre3_especie_receita_codigo_especie == 5
    "
  ),
  
  `14_cessao_direitos` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3 &
    nre3_especie_receita_codigo_especie == 6
    "
  ),
  
  `15_demais_receitas_patrimoniais` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3 &
    nre3_especie_receita_codigo_especie == 9
    "
  ),
  
  `16_receita_agropecuaria` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 4
    "
  ),
  
  `17_receita_industrial` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 5
    "
  ),
  
  `18_receitas_servicos` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 6
    "
  ),
  
  `19_servicos_admin_comerciais` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '161')"
  ),
  
  `20_servicos_navegacao_transporte` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '162')"
  ),
  
  `21_servicos_saude` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '163')"
  ),
  
  `22_servicos_financeiros` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '164')"
  ),
  
  `23_outros_servicos` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '169')"
  ),
  
  # ---------------------------------------------------------------------------
  # TRANSFER√äNCIAS CORRENTES
  # ---------------------------------------------------------------------------
  
  `24_transferencias_correntes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 7
    "
  ),
  
  `25_transf_uniao_entidades` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 7 &
    nre3_especie_receita_codigo_especie == 1
    "
  ),
  
  `26_transf_estados_df_entidades` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 7 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  `27_transf_municipios_entidades` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 7 &
    nre3_especie_receita_codigo_especie == 3
    "
  ),
  
  `28_transf_instituicoes_privadas` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 7 &
    nre3_especie_receita_codigo_especie == 4
    "
  ),
  
  `29_transf_outras_instituicoes_publicas` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 7 &
    nre3_especie_receita_codigo_especie == 5
    "
  ),
  
  `30_transf_exterior` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 7 &
    nre3_especie_receita_codigo_especie == 6
    "
  ),
  
  `31_demais_transf_correntes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 7 &
    nre3_especie_receita_codigo_especie == 9
    "
  ),
  
  # ---------------------------------------------------------------------------
  # OUTRAS RECEITAS CORRENTES
  # ---------------------------------------------------------------------------
  
  `32_outras_receitas_correntes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 9
    "
  ),
  
  `33_multas_admin_contratuais` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 9 &
    nre3_especie_receita_codigo_especie == 1
    "
  ),
  
  `34_indenizacoes_restituicoes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 9 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  `35_bens_direitos_valores` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 9 &
    nre3_especie_receita_codigo_especie == 3
    "
  ),
  
  `36_multas_juros_mora_capital` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 9 &
    nre3_especie_receita_codigo_especie == 4
    "
  ),
  
  `37_demais_receitas_correntes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 9 &
    nre3_especie_receita_codigo_especie == 9
    "
  ),
  
  `38_receitas_correntes_classificar` = list(
    criterio = "
    nre2_origem_receita_codigo_origem == 8 &
    nre3_especie_receita_codigo_especie == 8
    "
  ),
  
  # ===========================================================================
  # RECEITAS DE CAPITAL
  # ===========================================================================
  
  `39_receitas_capital` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 &
    !(startsWith(natureza_receita_codigo_completo, '21110201') |
      startsWith(natureza_receita_codigo_completo, '21210201'))
    "
  ),
  
  `40_operacoes_credito` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 1 &
    !(startsWith(natureza_receita_codigo_completo, '21110201') |
      startsWith(natureza_receita_codigo_completo, '21210201'))
    "
  ),
  
  `41_operacoes_credito_internas` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 1 &
    nre3_especie_receita_codigo_especie == 1 &
    !startsWith(natureza_receita_codigo_completo, '21110201')
    "
  ),
  
  `42_operacoes_credito_externas` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 1 &
    nre3_especie_receita_codigo_especie == 2 &
    !startsWith(natureza_receita_codigo_completo, '21210201')
    "
  ),
  
  `43_alienacao_bens` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 2
    "
  ),
  
  `44_alienacao_bens_moveis` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 2 &
    nre3_especie_receita_codigo_especie == 1
    "
  ),
  
  `45_alienacao_bens_imoveis` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 2 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  `46_alienacao_bens_intangiveis` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '223')"
  ),
  
  `47_amortizacoes_emprestimos` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 3
    "
  ),
  
  `48_transferencias_capital` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 4
    "
  ),
  
  `55_outras_receitas_capital` = list(
    criterio = "
    nre2_origem_receita_codigo_origem == 9 &
    nre1_categoria_economica_codigo == 2
    "
  ),
  
  `56_resultado_banco_central` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 9 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  `57_remuneracao_disponibilidades_tesouro` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '293')"
  ),
  
  # ===========================================================================
  # RECEITAS INTRA-OR√áAMENT√ÅRIAS
  # ===========================================================================
  
  `58_receitas_correntes_intra` = list(
    criterio = "nre1_categoria_economica_codigo == 7"
  ),
  
  # ===========================================================================
  # SUBTOTAIS E REFINANCIAMENTO
  # ===========================================================================
  
  `79_subtotal_receitas` = list(
    criterio = "
    nre1_categoria_economica_codigo %in% c(1, 2, 7, 8) &
    !(startsWith(natureza_receita_codigo_completo, '21110201') |
      startsWith(natureza_receita_codigo_completo, '21210201') |
      startsWith(natureza_receita_codigo_completo, '81110201') |
      startsWith(natureza_receita_codigo_completo, '81210201'))
    "
  ),
  
  `80_operacoes_credito_refinanciamento` = list(
    criterio = "
    startsWith(natureza_receita_codigo_completo, '21110201') |
    startsWith(natureza_receita_codigo_completo, '21210201') |
    startsWith(natureza_receita_codigo_completo, '81110201') |
    startsWith(natureza_receita_codigo_completo, '81210201')
    "
  ),
  
  `81_operacoes_credito_internas_refinanciamento` = list(
    criterio = "
    startsWith(natureza_receita_codigo_completo, '21110201') |
    startsWith(natureza_receita_codigo_completo, '81110201')
    "
  ),
  
  `85_subtotal_com_refinanciamento` = list(
    criterio = "nre1_categoria_economica_codigo %in% c(1, 2, 7, 8)"
  )
)

cat("‚úÖ Crit√©rios de Receitas definidos\n")
cat(sprintf("   Total de categorias: %d\n", length(criterios_rreo_A01_receitas_bo)))
```

### Despesas

```{r criterios-despesas-rreo-a01}
#| code-fold: true
#| code-summary: "Ver crit√©rios - Despesas"

# =============================================================================
# CRIT√âRIOS RREO ANEXO 01 - DESPESAS
# =============================================================================
# 34 crit√©rios para classifica√ß√£o das despesas or√ßament√°rias
# =============================================================================

criterios_rreo_A01_despesas_bo <- list(
  
  # ===========================================================================
  # DESPESAS (EXCETO INTRA-OR√áAMENT√ÅRIAS)
  # ===========================================================================
  
  `01_despesas_exceto_intra` = list(
    criterio = "
    modalidade_aplicacao_codigo != 91 &
    !(elemento_despesa_codigo %in% c('76', '77') &
      subfuncao_governo_codigo %in% c('841', '842', '843', '844', '846') &
      fonte_recursos_codigo == '443')
    "
  ),
  
  # ---------------------------------------------------------------------------
  # DESPESAS CORRENTES
  # ---------------------------------------------------------------------------
  
  `02_despesas_correntes` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    modalidade_aplicacao_codigo != 91
    "
  ),
  
  `03_pessoal_encargos_sociais` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 1 &
    modalidade_aplicacao_codigo != 91
    "
  ),
  
  `04_juros_encargos_divida` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 2 &
    modalidade_aplicacao_codigo != 91
    "
  ),
  
  `05_outras_despesas_correntes` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 3 &
    modalidade_aplicacao_codigo != 91
    "
  ),
  
  `06_transferencia_estados_df_municipios` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 3 &
    modalidade_aplicacao_codigo %in% c('30', '31', '32', '40', '41', '42', '43', '44', '45', '46') &
    modalidade_aplicacao_codigo != 91
    "
  ),
  
  `07_beneficios_previdenciarios` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 3 &
    modalidade_aplicacao_codigo != 91 &
    unidade_orcamentaria_codigo %in% c('55902', '40904', '33904', '25917')
    "
  ),
  
  `08_demais_despesas_correntes` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 3 &
    modalidade_aplicacao_codigo != 91 &
    !(modalidade_aplicacao_codigo %in% c('30', '31', '32', '40', '41', '42', '43', '44', '45', '46')) &
    !(unidade_orcamentaria_codigo %in% c('55902', '40904', '33904', '25917'))
    "
  ),
  
  # ---------------------------------------------------------------------------
  # DESPESAS DE CAPITAL
  # ---------------------------------------------------------------------------
  
  `09_despesas_capital` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 &
    modalidade_aplicacao_codigo != 91 &
    !(elemento_despesa_codigo %in% c('76', '77') &
      subfuncao_governo_codigo %in% c('841', '842', '843', '844', '846') &
      fonte_recursos_codigo == '443')
    "
  ),
  
  `10_investimentos` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 &
    grupo_despesa_codigo_grupo == 4 &
    modalidade_aplicacao_codigo != 91
    "
  ),
  
  `11_inversoes_financeiras` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 &
    grupo_despesa_codigo_grupo == 5 &
    modalidade_aplicacao_codigo != 91
    "
  ),
  
  `12_amortizacao_divida` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 &
    grupo_despesa_codigo_grupo == 6 &
    modalidade_aplicacao_codigo != 91 &
    !(elemento_despesa_codigo %in% c('76', '77') &
      subfuncao_governo_codigo %in% c('841', '842', '843', '844', '846') &
      fonte_recursos_codigo == '443')
    "
  ),
  
  # ---------------------------------------------------------------------------
  # RESERVA DE CONTING√äNCIA
  # ---------------------------------------------------------------------------
  
  `13_reserva_contingencia` = list(
    criterio = "
    categoria_economica_despesa_codigo == 9 &
    modalidade_aplicacao_codigo != 91
    "
  ),
  
  # ===========================================================================
  # DESPESAS INTRA-OR√áAMENT√ÅRIAS
  # ===========================================================================
  
  `14_despesas_intra` = list(
    criterio = "modalidade_aplicacao_codigo == 91"
  ),
  
  `15_despesas_correntes_intra` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    modalidade_aplicacao_codigo == 91
    "
  ),
  
  `16_pessoal_encargos_sociais_intra` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 1 &
    modalidade_aplicacao_codigo == 91
    "
  ),
  
  `17_juros_encargos_divida_intra` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 2 &
    modalidade_aplicacao_codigo == 91
    "
  ),
  
  `18_outras_despesas_correntes_intra` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 3 &
    modalidade_aplicacao_codigo == 91
    "
  ),
  
  `21_despesas_capital_intra` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 &
    modalidade_aplicacao_codigo == 91
    "
  ),
  
  # ===========================================================================
  # SUBTOTAIS
  # ===========================================================================
  
  `26_subtotal_despesas` = list(
    criterio = "
    categoria_economica_despesa_codigo %in% c(3, 4, 9) &
    !(elemento_despesa_codigo %in% c('76', '77') &
      subfuncao_governo_codigo %in% c('841', '842', '843', '844', '846') &
      fonte_recursos_codigo == '443')
    "
  ),
  
  # ===========================================================================
  # REFINANCIAMENTO
  # ===========================================================================
  
  `27_amortizacao_divida_refinanciamento` = list(
    criterio = "
    grupo_despesa_codigo_grupo == 6 &
    elemento_despesa_codigo %in% c('76', '77') &
    subfuncao_governo_codigo %in% c('841', '842', '843', '844', '846') &
    fonte_recursos_codigo == '443'
    "
  ),
  
  `28_amortizacao_divida_interna` = list(
    criterio = "
    grupo_despesa_codigo_grupo == 6 &
    elemento_despesa_codigo %in% c('76', '77') &
    subfuncao_governo_codigo %in% c('841', '843', '846') &
    fonte_recursos_codigo == '443'
    "
  ),
  
  `29_divida_mobiliaria` = list(
    criterio = "
    grupo_despesa_codigo_grupo == 6 &
    elemento_despesa_codigo == '76' &
    subfuncao_governo_codigo %in% c('841', '843', '846') &
    fonte_recursos_codigo == '443'
    "
  ),
  
  `31_amortizacao_divida_externa` = list(
    criterio = "
    grupo_despesa_codigo_grupo == 6 &
    elemento_despesa_codigo %in% c('76', '77') &
    subfuncao_governo_codigo %in% c('842', '844') &
    fonte_recursos_codigo == '443'
    "
  ),
  
  `34_subtotal_com_refinanciamento` = list(
    criterio = "categoria_economica_despesa_codigo %in% c(3, 4, 9)"
  )
)

cat("‚úÖ Crit√©rios de Despesas definidos\n")
cat(sprintf("   Total de categorias: %d\n", length(criterios_rreo_A01_despesas_bo)))
```

## Aplica√ß√£o dos Crit√©rios

```{r aplicar-criterios-rreo-a01}
#| code-fold: true
#| code-summary: "Ver c√≥digo de aplica√ß√£o"

# =============================================================================
# APLICA√á√ÉO DOS CRIT√âRIOS
# =============================================================================

cat("üìä Processando crit√©rios do RREO Anexo 01...\n")

# -----------------------------------------------------------------------------
# Aplicar crit√©rios de Receitas
# -----------------------------------------------------------------------------

df_criterios_rreo_A01_receitas_bo <- aplicar_criterios(
  dados_receita, 
  criterios_rreo_A01_receitas_bo, 
  group_vars = c("item_informacao_codigo", "item_informacao_nome")
)

cat(sprintf("‚úÖ Receitas processadas: %d registros\n", nrow(df_criterios_rreo_A01_receitas_bo)))

# -----------------------------------------------------------------------------
# Aplicar crit√©rios de Despesas
# -----------------------------------------------------------------------------

df_criterios_rreo_A01_despesas_bo <- aplicar_criterios(
  dados_despesa, 
  criterios_rreo_A01_despesas_bo, 
  group_vars = c("item_informacao_codigo", "item_informacao_nome")
)

cat(sprintf("‚úÖ Despesas processadas: %d registros\n", nrow(df_criterios_rreo_A01_despesas_bo)))
```

## Resultados

### Receitas

```{r resultado-receitas-rreo-a01}
#| code-fold: true
#| column: page

# =============================================================================
# EXIBIR RECEITAS - Receita Realizada (item_informacao_codigo = 5)
# =============================================================================

receitas_realizadas <- df_criterios_rreo_A01_receitas_bo %>%
  filter(item_informacao_codigo == "5") %>%
  group_by(ordem, nome) %>%
  summarise(valor = sum(valor, na.rm = TRUE), .groups = "drop") %>%
  arrange(ordem)

datatable(
  receitas_realizadas,
  caption = "RREO Anexo 01 - Receitas Realizadas",
  rownames = FALSE,
  options = list(
    pageLength = 20,
    scrollX = TRUE,
    dom = 'tip'
  )
) %>% 
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")
```

### Despesas

```{r resultado-despesas-rreo-a01}
#| code-fold: true
#| column: page

# =============================================================================
# EXIBIR DESPESAS - Despesas Pagas (item_informacao_codigo = 25)
# =============================================================================

despesas_pagas <- df_criterios_rreo_A01_despesas_bo %>%
  filter(item_informacao_codigo == "25") %>%
  group_by(ordem, nome) %>%
  summarise(valor = sum(valor, na.rm = TRUE), .groups = "drop") %>%
  arrange(ordem)

datatable(
  despesas_pagas,
  caption = "RREO Anexo 01 - Despesas Pagas",
  rownames = FALSE,
  options = list(
    pageLength = 20,
    scrollX = TRUE,
    dom = 'tip'
  )
) %>% 
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")
```

## Resultado Or√ßament√°rio

```{r resultado-orcamentario-rreo-a01}
#| code-fold: true
#| code-summary: "Ver c√°lculo do resultado"

# =============================================================================
# C√ÅLCULO DO RESULTADO OR√áAMENT√ÅRIO
# =============================================================================

# Receita total com refinanciamento (linha 85, item 5)
receita_total <- df_criterios_rreo_A01_receitas_bo %>% 
  filter(ordem == "85", item_informacao_codigo == "5") %>% 
  summarise(valor = sum(valor, na.rm = TRUE)) %>%
  pull(valor)

# Despesa total com refinanciamento (linha 34, item 25)
despesa_total <- df_criterios_rreo_A01_despesas_bo %>% 
  filter(ordem == "34", item_informacao_codigo == "25") %>% 
  summarise(valor = sum(valor, na.rm = TRUE)) %>%
  pull(valor)

# Resultado or√ßament√°rio
resultado_orcamentario <- receita_total - despesa_total

# Exibir resultado
cat("\nüìä RESULTADO OR√áAMENT√ÅRIO\n")
cat("=========================\n\n")
cat(sprintf("Receita Total (com refinanc.): R$ %s\n", formatar_numero(receita_total)))
cat(sprintf("Despesa Total (com refinanc.): R$ %s\n", formatar_numero(despesa_total)))
cat(sprintf("RESULTADO OR√áAMENT√ÅRIO:        R$ %s\n", formatar_numero(resultado_orcamentario)))

if (resultado_orcamentario >= 0) {
  cat("\n‚úÖ SUPER√ÅVIT OR√áAMENT√ÅRIO\n")
} else {
  cat("\n‚ö†Ô∏è D√âFICIT OR√áAMENT√ÅRIO\n")
}
```

```{r tabela-resultado-rreo-a01}
#| echo: false

# =============================================================================
# TABELA RESUMO DO RESULTADO
# =============================================================================

df_resultado <- tibble(
  Tipo = c("Receita Total", "Despesa Total", "Resultado Or√ßament√°rio"),
  Valor = c(receita_total, despesa_total, resultado_orcamentario)
)

datatable(
  df_resultado,
  caption = "RREO Anexo 01 - Resultado Or√ßament√°rio",
  rownames = FALSE,
  options = list(
    pageLength = -1,
    dom = 't'
  )
) %>% 
  formatRound(c("Valor"), 2, mark = ".", dec.mark = ",")
```

## Notas Metodol√≥gicas

```{r notas-rreo-a01}
#| echo: false

# =============================================================================
# NOTAS METODOL√ìGICAS
# =============================================================================

notas <- tibble::tribble(
  ~Item, ~Descri√ß√£o,
  "1", "Valores em R$ (reais)",
  "2", "Receitas intra-or√ßament√°rias: categorias 7 e 8",
  "3", "Despesas intra-or√ßament√°rias: modalidade de aplica√ß√£o 91",
  "4", "Refinanciamento exclu√≠do dos subtotais principais",
  "5", "Item informa√ß√£o 5 = Receita Realizada",
  "6", "Item informa√ß√£o 25 = Despesas Pagas",
  "7", "Resultado = Receita - Despesa (positivo = super√°vit)"
)

knitr::kable(notas, col.names = c("Item", "Descri√ß√£o"))
```

## Observa√ß√µes Importantes

::: callout-note
### Itens de Informa√ß√£o

Os principais itens de informa√ß√£o utilizados s√£o:

**Receitas:** - **1**: Previs√£o Inicial - **2**: Previs√£o Atualizada - **5**: Receita Realizada

**Despesas:** - **9**: Dota√ß√£o Inicial - **23**: Dota√ß√£o Atualizada - **10**: Despesas Empenhadas - **18**: Despesas Liquidadas - **25**: Despesas Pagas
:::

::: callout-warning
### Refinanciamento da D√≠vida

As opera√ß√µes de refinanciamento s√£o tratadas separadamente:

-   **Receitas de refinanciamento**: Naturezas que come√ßam com 21110201, 21210201, 81110201, 81210201
-   **Despesas de refinanciamento**: Grupo 6 + Elementos 76/77 + Subfun√ß√µes 841-846 + Fonte 443

Estas opera√ß√µes s√£o inclu√≠das apenas no "Subtotal com Refinanciamento".
:::

::: callout-tip
### Classifica√ß√£o da Despesa

A classifica√ß√£o de despesas utiliza m√∫ltiplos atributos:

-   **Categoria Econ√¥mica**: 3 (Corrente), 4 (Capital), 9 (Reserva)
-   **Grupo de Despesa**: 1-6
-   **Modalidade de Aplica√ß√£o**: 91 indica intra-or√ßament√°ria
-   **Elemento de Despesa**: 76/77 para refinanciamento
:::

# üìã RREO Anexo 02 - Despesas por Fun√ß√£o e Subfun√ß√£o

## üìä Ficha T√©cnica

| Item | Descri√ß√£o |
|------------------------------------|------------------------------------|
| **Relat√≥rio** | RREO - Relat√≥rio Resumido da Execu√ß√£o Or√ßament√°ria |
| **Anexo** | Anexo 02 - Demonstrativo da Execu√ß√£o das Despesas por Fun√ß√£o/Subfun√ß√£o |
| **Base Legal** | LRF Art. 52, inciso II, al√≠nea "c" |
| **Periodicidade** | Bimestral |
| **Grau de Dificuldade** | F√°cil |

## üìÅ Arquivos Necess√°rios

| Objeto | Arquivo | Descri√ß√£o |
|------------------------|------------------------|------------------------|
| `dados_despesa` | tg_despesa\_\*.xlsx | Despesas or√ßament√°rias com classifica√ß√£o funcional |

## üìã Atributos Utilizados

| Atributo | Descri√ß√£o | Uso no Anexo |
|------------------------|------------------------|------------------------|
| `funcao_governo_codigo` | C√≥digo da fun√ß√£o | Agrupamento principal (01-28) |
| `funcao_governo_nome` | Nome da fun√ß√£o | Descri√ß√£o da fun√ß√£o |
| `subfuncao_governo_codigo` | C√≥digo da subfun√ß√£o | Detalhamento (xxx) |
| `subfuncao_governo_nome` | Nome da subfun√ß√£o | Descri√ß√£o da subfun√ß√£o |
| `refinanciamento` | Indicador de refinanciamento | Separar refinanciamento da d√≠vida |
| `item_informacao_codigo` | Item de informa√ß√£o | 23 = Dota√ß√£o Atualizada |
| `saldo_r_item_informacao` | Valor do saldo | Valor monet√°rio |

## üîó V√≠nculos com Outros Anexos

| Anexo    | V√≠nculo                                 |
|----------|-----------------------------------------|
| RREO A01 | Totaliza√ß√£o das despesas                |
| RREO A06 | Despesas prim√°rias por fun√ß√£o           |
| RGF A01  | Despesa com pessoal (fun√ß√£o espec√≠fica) |

## üìê Estrutura do Demonstrativo

### Classifica√ß√£o Funcional

A classifica√ß√£o funcional segrega as dota√ß√µes or√ßament√°rias em fun√ß√µes e subfun√ß√µes, buscando responder √† indaga√ß√£o "em que √°rea" de a√ß√£o governamental a despesa ser√° realizada.

**Fun√ß√µes Principais:** - 01 - Legislativa - 02 - Judici√°ria - 03 - Essencial √† Justi√ßa - 04 - Administra√ß√£o - 06 - Seguran√ßa P√∫blica - 08 - Assist√™ncia Social - 09 - Previd√™ncia Social - 10 - Sa√∫de - 12 - Educa√ß√£o - 28 - Encargos Especiais

### Refinanciamento da D√≠vida

Segrega√ß√£o espec√≠fica para opera√ß√µes de refinanciamento da d√≠vida p√∫blica.

## üìä Processamento dos Dados

### Despesas por Refinanciamento

```{r despesas-refinanciamento}
#| echo: true
#| label: despesas-refinanciamento

# ==============================================================================
# DESPESAS POR INDICADOR DE REFINANCIAMENTO
# ==============================================================================
# Objetivo: Segregar despesas de refinanciamento das demais despesas
# Item de informa√ß√£o 23 = Dota√ß√£o Atualizada
# ==============================================================================

if (!exists("dados_despesa")) {

  warning("dados_despesa nao encontrado")
  despesas_refinanciamento <- tibble(
    refinanciamento = NA,
    saldo_r_item_informacao = NA_real_
  )
} else {
  # Agrupar despesas por indicador de refinanciamento
  despesas_refinanciamento <- dados_despesa %>% 
    filter(item_informacao_codigo == 23) %>%
    group_by(refinanciamento) %>% 
    summarise(
      saldo_r_item_informacao = sum(saldo_r_item_informacao, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    janitor::adorn_totals()
  
  # Exibir tabela
  datatable(
    despesas_refinanciamento,
    caption = "üìä Despesas liquidadas por Indicador de Refinanciamento",
    options = list(dom = 't', pageLength = 10),
    rownames = FALSE
  ) %>%
    formatRound("saldo_r_item_informacao", 2, mark = ".", dec.mark = ",")
}
```

### Despesas por Fun√ß√£o

```{r despesas-funcao}
#| echo: true
#| label: despesas-funcao

# ==============================================================================
# DESPESAS LIQUIDADAS POR FUN√á√ÉO DE GOVERNO
# ==============================================================================
# Objetivo: Demonstrar a execu√ß√£o or√ßament√°ria por fun√ß√£o
# ==============================================================================

if (exists("dados_despesa")) {
  # Agrupar despesas por fun√ß√£o
  despesas_funcao <- dados_despesa %>% 
    filter(item_informacao_codigo == 23) %>%
    group_by(funcao_governo_codigo, funcao_governo_nome) %>% 
    summarise(
      saldo_r_item_informacao = sum(saldo_r_item_informacao, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    arrange(funcao_governo_codigo) %>%
    janitor::adorn_totals()
  
  # Exibir tabela
  datatable(
    despesas_funcao,
    caption = "üìä Despesas liquidadas por Fun√ß√£o de Governo",
    options = list(pageLength = 30, dom = 'ft'),
    rownames = FALSE
  ) %>%
    formatRound("saldo_r_item_informacao", 2, mark = ".", dec.mark = ",")
} else {
  cat("Dados n√£o dispon√≠veis\n")
}
```

## üìà Resumo Consolidado

```{r resumo-anexo02}
#| echo: true
#| label: resumo-anexo02

# ==============================================================================
# RESUMO DO ANEXO 02
# ==============================================================================

if (exists("despesas_funcao") && exists("despesas_refinanciamento")) {
  
  # Totais

  total_geral <- despesas_funcao %>% 
    filter(funcao_governo_codigo == "Total") %>% 
    pull(saldo_r_item_informacao)
  
  n_funcoes <- nrow(despesas_funcao) - 1  # Excluir linha de total
  
  cat("\n")
  cat(strrep("=", 60), "\n")
  cat("RESUMO - RREO ANEXO 02\n")
  cat(strrep("=", 60), "\n")
  cat(sprintf("Total de Fun√ß√µes: %d\n", n_funcoes))
  cat(sprintf("Despesa Liquidada Total: R$ %s\n", 
              format(round(total_geral, 2), big.mark = ".", decimal.mark = ",")))
  cat(strrep("=", 60), "\n")
  
  # Exportar vari√°veis
  valor_liquidado_total_a02 <- total_geral
  
} else {
  cat("Dados n√£o dispon√≠veis para resumo\n")
}
```

## üìã Objetos Exportados

| Objeto                     | Descri√ß√£o                              |
|----------------------------|----------------------------------------|
| `despesas_refinanciamento` | Despesas agrupadas por refinanciamento |
| `despesas_funcao`          | Despesas agrupadas por fun√ß√£o          |

| `valor_liquidado_total_a02` \| Total da dota√ß√£o atualizada \|

## üìå Observa√ß√µes Importantes

1.  **Item de Informa√ß√£o 23**: Dota√ß√£o Atualizada (LOA + Cr√©ditos Adicionais)

2.  **Refinanciamento**: Segrega√ß√£o obrigat√≥ria para opera√ß√µes de refinanciamento da d√≠vida p√∫blica mobili√°ria

3.  **Fun√ß√µes T√≠picas**:

    -   Fun√ß√µes 01-04: Poderes e Fun√ß√µes Essenciais
    -   Fun√ß√µes 05-28: Fun√ß√µes de Governo
    -   Fun√ß√£o 28: Encargos Especiais (d√≠vida, transfer√™ncias)

4.  **Subfun√ß√µes**: Podem ser combinadas com qualquer fun√ß√£o (matricialidade)

# RREO Anexo 03 - Receita Corrente Liquida (RCL)

## Ficha Tecnica

| Campo               | Informacao                                         |
|---------------------|----------------------------------------------------|
| Relatorio           | RREO - Relatorio Resumido da Execucao Orcamentaria |
| Anexo               | Anexo 03                                           |
| Nome                | Demonstrativo da Receita Corrente Liquida          |
| Base Legal          | LRF Art. 53, inciso I                              |
| Periodicidade       | Bimestral                                          |
| Grau de Dificuldade | Medio                                              |
| Ultima Atualizacao  | 28/12/2025                                         |

## Arquivos Necessarios

| Arquivo | Descricao | Filtros no TG |
|------------------------|------------------------|------------------------|
| rreo_a03_rcl_receitas.xlsx | Receitas correntes por natureza | Orc. Fiscal e Seguridade, Categoria Economica = 1 (Correntes), Metrica = Movimento Liquido |
| rreo_a03_rcl_despesas.xlsx | Transferencias constitucionais e legais | Orc. Fiscal e Seguridade, Naturezas 333081\* e 334081\*, Metrica = Movimento Liquido |

## Atributos Utilizados

| Atributo | Tipo | Uso | Descricao |
|------------------|------------------|------------------|------------------|
| nre1_categoria_economica_codigo | character | TG / Criterio | Categoria economica (1=Corrente, 2=Capital) |
| nre2_origem_receita_codigo_origem | character | TG / Criterio | Origem da receita (1-9) |
| natureza_receita_codigo_completo | character | TG / Criterio | Codigo completo da natureza de receita |
| item_informacao_codigo | character | TG / Criterio | Tipo de informacao (5=Receita Realizada) |
| natureza_despesa_codigo | character | TG / Criterio | Codigo da natureza de despesa |
| mes_lancamento | numeric | TG / R | Mes do lancamento (YYYYMM) |
| movim_liquido_r_item_informacao | numeric | TG / R | Valor do movimento liquido |
| saldo_r_item_informacao | numeric | R (alias) | Alias para movim_liquido (compatibilidade) |
| data_lancamento | Date | R | Data calculada do lancamento |

## Vinculos com Outros Anexos

| Anexo Relacionado | Tipo de Vinculo | Descricao |
|------------------------|------------------------|------------------------|
| RGF Anexo 01 | Base de Calculo | RCL e o denominador para limites de despesa com pessoal |
| RGF Anexo 02 | Base de Calculo | RCL e o denominador para limite da DCL |
| RGF Anexo 03 | Base de Calculo | RCL e o denominador para limite de garantias |
| RGF Anexo 04 | Base de Calculo | RCL e o denominador para limite de operacoes de credito |
| RGF Anexo 06 | Consolidacao | Valor consolidado no demonstrativo simplificado |
| RREO Anexo 06 | Referencia | Receitas correntes utilizadas no Resultado Primario |

## Estrutura do Demonstrativo

| Ordem | Item                                             | Tipo       |
|-------|--------------------------------------------------|------------|
| 01    | RECEITAS CORRENTES (I)                           | Total      |
| 02    | Impostos, Taxas e Contribuicoes de Melhoria      | Componente |
| 03    | Contribuicoes                                    | Componente |
| 04    | Receita Patrimonial                              | Componente |
| 05    | Transferencias Correntes                         | Componente |
| 06    | Demais Receitas Correntes                        | Componente |
| 07    | DEDUCOES (II)                                    | Deducao    |
| 08    | Transferencias Constitucionais e Legais          | Deducao    |
| 09    | Contrib. Empregador e Trab. p/ Seguridade Social | Deducao    |
| 10    | Contribuicao p/ Custeio Pensoes Militares        | Deducao    |
| 11    | Contribuicao p/ RPPS (Patronal e Servidor)       | Deducao    |
| 12    | Compensacao Financeira entre Regimes Previd.     | Deducao    |
| 13    | Deducoes de Transferencias aos Fundos            | Deducao    |
| 14    | RP NAO PROCESSADOS CANCELADOS (III)              | Adicao     |
| 15    | RECEITA CORRENTE LIQUIDA (I - II + III)          | RESULTADO  |

## Conceitos Importantes

### Formula da RCL

```         
RCL = RECEITAS CORRENTES 
    - Transferencias Constitucionais e Legais
    - Contribuicoes Previdenciarias
    + Restos a Pagar Nao Processados Cancelados
```

### Uso da RCL

A RCL e a base de calculo para os principais limites da LRF:

| Limite                          | Percentual           | Referencia Legal     |
|-------------------------------|---------------------|---------------------|
| Despesa com Pessoal - Uniao     | 50% (total)          | LRF Art. 19          |
| Despesa com Pessoal - Executivo | 40,9%                | LRF Art. 20          |
| Divida Consolidada Liquida      | Resolucao SF 40/2001 | LRF Art. 30          |
| Garantias                       | 60%                  | LRF Art. 9, par. 4   |
| Operacoes de Credito            | 16%                  | Resolucao SF 43/2001 |

### Periodo de Apuracao

A RCL e calculada considerando os **ultimos 12 meses**, incluindo o mes de referencia. Por exemplo, para novembro/2025, considera-se de dezembro/2024 a novembro/2025.

------------------------------------------------------------------------

## üéØ Crit√©rios de Classifica√ß√£o

### Crit√©rios para Receitas

```{r criterios-rcl-receitas}
#| code-fold: true
#| output: false

# =============================================================================
# CRIT√âRIOS PARA RECEITAS - ANEXO 3 RCL
# =============================================================================
# Estes crit√©rios classificam as receitas correntes conforme a estrutura
# do Anexo 03 do RREO
# =============================================================================

criterios_rreo_A03_rcl_receitas_rcl <- list(
  
  # ---------------------------------------------------------------------------
  # RECEITAS CORRENTES POR ORIGEM (01-09)
  # ---------------------------------------------------------------------------
  # Classifica√ß√£o conforme a origem da receita corrente
  # Base: nre1_categoria_economica_codigo == 1 (Receitas Correntes)
  # ---------------------------------------------------------------------------
  
  # IMPOSTOS, TAXAS E CONTRIBUI√á√ïES DE MELHORIA
  `01  Impostos, Taxas e Contribui√ß√µes de Melhoria` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 1"
  ),
  
  # RECEITA DE CONTRIBUI√á√ïES
  `02  Receita de Contribui√ß√µes` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 2"
  ),
  
  # RECEITA PATRIMONIAL
  `03  Receita Patrimonial` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 3"
  ),
  
  # RECEITA AGROPECU√ÅRIA
  `04  Receita Agropecu√°ria` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 4"
  ),
  
  # RECEITA INDUSTRIAL
  `05  Receita Industrial` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 5"
  ),
  
  # RECEITA DE SERVI√áOS
  `06  Receita de Servi√ßos` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 6"
  ),
  
  # TRANSFER√äNCIAS CORRENTES
  `07  Transfer√™ncias Correntes` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 7"
  ),
  
  # RECEITAS CORRENTES A CLASSIFICAR
  `08  Receitas Correntes a Classificar` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 8"
  ),
  
  # OUTRAS RECEITAS CORRENTES
  `09  Outras Receitas Correntes` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 9"
  ),
  
  # ---------------------------------------------------------------------------
  # DEDU√á√ïES DAS RECEITAS (ITENS 10-16)
  # ---------------------------------------------------------------------------
  # Estes itens s√£o deduzidos das receitas correntes para chegar √† RCL
  # ---------------------------------------------------------------------------
  
  # TRANSFER√äNCIAS CONSTITUCIONAIS E LEGAIS (item 10)
  # FPE, FPM, FUNDEB, e outras transfer√™ncias obrigat√≥rias
  `10  Transfer√™ncias Constitucionais e Legais` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 7 & (
      grepl('FPE|FPM|CONSTITUCIONAL|LEGAL', natureza_receita_nome, ignore.case = TRUE) |
      grepl('^172[0-9]', natureza_receita_codigo_completo) |
      grepl('^171[0-9]', natureza_receita_codigo_completo)
    )
    "
  ),
  
  # CONTRIB. EMPREGADORES E TRAB. PARA SEGURIDADE SOCIAL (item 11)
  # Fonte 054 - Contribui√ß√£o para Seguridade Social
  `11  Contrib. Empregadores e Trabalhadores para Seguridade Social` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & fonte_recursos_codigo == '054' & 
    !natureza_receita_codigo_completo %in% c(
      '19900300', '19900310', '19900311', '19900312', '19900313', '19900314',
      '19990300', '19990301', '19990302', '19990303', '19990304'
    )
    "
  ),
  
  # CONTRIB. DO SERVIDOR PARA O PLANO DE PREVID√äNCIA (item 12)
  # Fontes 055 e 056 - Contribui√ß√µes Previdenci√°rias do Servidor
  `12  Contrib. Plano Seguridade Social do Servidor` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & (
      fonte_recursos_codigo %in% c('055', '056') |
      natureza_receita_codigo_completo == '12150116'
    )
    "
  ),
  
  # COMPENSA√á√ÉO FINANC. ENTRE REGIMES PREVID√äNCIA (item 13)
  # Compensa√ß√µes entre RGPS e RPPS
  `13  Compensa√ß√£o Financeira entre Regimes RPPS` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & natureza_receita_codigo_completo %in% c(
      '19900300', '19900310', '19900311', '19900312', '19900313', '19900314',
      '19990300', '19990301', '19990302', '19990303', '19990304'
    )
    "
  ),
  
  # CONTRIB. DOS MILITARES PARA O CUSTEIO DAS PENS√ïES (item 14)
  # Contribui√ß√µes espec√≠ficas dos militares
  `14  Contrib. para Custeio Pens√µes Militares` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & (
      grepl('^1210051', natureza_receita_codigo_completo) |
      grepl('^1215041', natureza_receita_codigo_completo) |
      grepl('^121911', natureza_receita_codigo_completo)
    )
    "
  ),
  
  # CONTRIBUI√á√ïES PARA PIS/PASEP (item 15)
  # Fontes 040 e 041 - PIS/PASEP
  `15  Contribui√ß√£o para PIS/PASEP` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & (
      (grepl('^1210091|^1212', natureza_receita_codigo_completo) & 
       !fonte_recursos_codigo %in% c('055', '056', '054')) |
      (!grepl('^1210091|^1212', natureza_receita_codigo_completo) & 
       fonte_recursos_codigo %in% c('040', '041'))
    )
    "
  ),
  
  # DEDU√á√ïES DAS RECEITAS (item 16)
  # Diversas dedu√ß√µes por fonte e natureza
  `16  Dedu√ß√µes das Receitas` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & (
      (grepl('^1212', natureza_receita_codigo_completo) & fonte_recursos_codigo %in% c('031', '032', '040', '041')) |
      (grepl('^1214', natureza_receita_codigo_completo) & fonte_recursos_codigo == '054') |
      (grepl('^1215', natureza_receita_codigo_completo) & fonte_recursos_codigo %in% c('023', '032', '055', '056')) |
      (grepl('^1219', natureza_receita_codigo_completo) & fonte_recursos_codigo == '054') |
      (grepl('^1911', natureza_receita_codigo_completo) & fonte_recursos_codigo == '054') |
      (grepl('^1922', natureza_receita_codigo_completo) & fonte_recursos_codigo %in% c('040', '054', '056')) |
      (grepl('^1923', natureza_receita_codigo_completo) & fonte_recursos_codigo == '054') |
      (grepl('^1999', natureza_receita_codigo_completo) & fonte_recursos_codigo == '054')
    )
    "
  )
)

# Aplicar crit√©rios de receitas
aplicar_criterios(
  rreo_a03_rcl_receitas, 
  criterios_rreo_A03_rcl_receitas_rcl, 
  group_vars = c("item_informacao_codigo")
)

cat("‚úÖ Crit√©rios de Receitas aplicados!\n")
```

### Crit√©rios para Despesas (Dedu√ß√µes)

```{r criterios-rcl-despesas}
#| code-fold: true
#| output: false

# =============================================================================
# CRIT√âRIOS PARA DESPESAS (DEDU√á√ïES) - ANEXO 3 RCL
# =============================================================================
# Estes crit√©rios classificam as despesas que s√£o deduzidas da RCL
# =============================================================================

criterios_rreo_A03_rcl_despesas_rcl <- list(
  
  # ---------------------------------------------------------------------------
  # TRANSFER√äNCIAS CONSTITUCIONAIS E LEGAIS (DESPESAS)
  # ---------------------------------------------------------------------------
  # A√ß√µes or√ßament√°rias de transfer√™ncias obrigat√≥rias
  # Modalidades de aplica√ß√£o: 30, 31, 32, 35, 36, 40, 41, 42, 45, 46
  # Programa: 0903 (Transfer√™ncias Constitucionais)
  # ---------------------------------------------------------------------------
  
  `17  Transfer√™ncias Constitucionais e Legais` = list(
    criterio = "
    (
      acao_governo_codigo %in% c('0044', '0045', '0046', '0050', '0051', '00H6', '006M', 
                                 '00G6', '0169', '0223', '0369', '0546', '0547', '0999', 
                                 '099B', '0A53', '0C03', '0C33', '0E25', '0E36', '00PX', 
                                 '00QR', '00S3', '00S7', '00S8', '00SE', '00RX', '00UH') &
      modalidade_aplicacao_codigo %in% c('30', '31', '32', '35', '36', '40', '41', '42', '45', '46') &
      programa_governo_codigo == '0903'
    ) |
    grepl('^28846090900RX', pt) |
    acao_governo_codigo %in% c('0E36', '00SB')
    "
  ),
  
  # OUTRAS DEDU√á√ïES (DESPESAS)
  `18  Outras Dedu√ß√µes` = list(
    criterio = "
    acao_governo_codigo %in% c('0E36', '00SB') | 
    grepl('^28846090900RX', programa_governo_codigo) | 
    (programa_governo_codigo %in% c('0903', '2030', '2080') & 
     modalidade_aplicacao_codigo %in% c(30, 31, 32, 35, 36, 40, 41, 42, 45, 46) & 
     acao_governo_codigo %in% c('0044', '0045', '0046', '0050', '0051', '00H6', '006M', 
                                '00G6', '0169', '0223', '0369', '0546', '0547', '0999', 
                                '099B', '0A53', '0C03', '0C33', '0E25', '0E36', '00PX', 
                                '00QR', '00S3', '00S7', '00S8', '00SE', '00RX', '00UH'))
    "
  )
)

# Aplicar crit√©rios de despesas
aplicar_criterios(
  df = rreo_a03_rcl_despesas, 
  criterios_rreo_A03_rcl_despesas_rcl, 
  group_vars = c("item_informacao_codigo")
)

cat("‚úÖ Crit√©rios de Despesas (Dedu√ß√µes) aplicados!\n")
```

### Crit√©rios para RP Cancelados

```{r criterios-rcl-rp-cancelado}
#| code-fold: true
#| output: false

# =============================================================================
# CRIT√âRIOS PARA RP CANCELADOS - ANEXO 3 RCL
# =============================================================================
# RP cancelados de transfer√™ncias constitucionais devem ser somados de volta
# =============================================================================

criterios_rreo_A03_rcl_rp_cancelado_rcl <- list(
  
  `19 RP Cancelados de Transfer√™ncias Constitucionais e Legais` = list(
    criterio = "
    (
      acao_governo_codigo %in% c('0044', '0045', '0046', '0050', '0051', '00H6', '006M', 
                                 '00G6', '0169', '0223', '0369', '0546', '0547', '0999', 
                                 '099B', '0A53', '0C03', '0C33', '0E25', '0E36', '00PX', 
                                 '00QR', '00S3', '00S7', '00S8', '00SE', '00RX', '00UH') &
      modalidade_aplicacao_codigo %in% c('30', '31', '32', '35', '36', '40', '41', '42', '45', '46') &
      programa_governo_codigo == '0903'
    ) |
    grepl('^28846090900RX', pt) |
    acao_governo_codigo %in% c('0E36', '00SB')
    "
  )
)

# Aplicar crit√©rios de RP cancelados
aplicar_criterios(
  df = rreo_a03_rcl_despesas, 
  criterios_rreo_A03_rcl_rp_cancelado_rcl, 
  group_vars = c("item_informacao_codigo")
)

cat("‚úÖ Crit√©rios de RP Cancelados aplicados!\n")
```

------------------------------------------------------------------------

## üìä C√°lculo da RCL

```{r calcular-rcl}
#| code-fold: true

# =============================================================================
# CONSOLIDAR DADOS DA RCL
# =============================================================================
# F√≥rmula: RCL = Receitas Correntes - Dedu√ß√µes + RP Cancelados
# =============================================================================

cat("üìä Consolidando dados da RCL...\n")

# -----------------------------------------------------------------------------
# 1. COMBINAR OS RESULTADOS
# -----------------------------------------------------------------------------

# Receitas (itens 01-09)
rcl <- df_criterios_rreo_A03_rcl_receitas_rcl

# Adicionar Dedu√ß√µes (item 25 e 27 das despesas, item 17)
rcl <- rbind(
  rcl, 
  df_criterios_rreo_A03_rcl_despesas_rcl %>% 
    filter(item_informacao_codigo %in% c("25", "27"))
)

# Adicionar RP Cancelados (item 51)
rcl <- rbind(
  rcl, 
  df_criterios_rreo_A03_rcl_rp_cancelado_rcl %>% 
    filter(item_informacao_codigo == "51")
)

# -----------------------------------------------------------------------------
# 2. CLASSIFICAR OS TIPOS
# -----------------------------------------------------------------------------

rcl <- rcl %>%
  mutate(
    tipo = case_when(
      # Receitas correntes (itens 01-09)
      ordem %in% c("01", "02", "03", "04", "05", "06", "07", "08", "09") ~ "receitas",
      
      # Dedu√ß√µes (itens 11-17)
      ordem %in% c("11", "12", "13", "14", "15", "17") ~ "deducoes",
      
      # RP Cancelados (item 19)
      ordem == "19" ~ "rp_cancelado",
      
      # Demais
      .default = "demais"
    )
  )

cat(sprintf("   ‚úì Total de registros consolidados: %s\n", 
            format(nrow(rcl), big.mark = ".", decimal.mark = ",")))

# -----------------------------------------------------------------------------
# 3. CALCULAR RCL DOS √öLTIMOS 12 MESES
# -----------------------------------------------------------------------------
# A RCL √© calculada considerando os √∫ltimos 12 meses (per√≠odo m√≥vel)
# F√≥rmula: RCL = Receitas - Dedu√ß√µes + RP Cancelados
# -----------------------------------------------------------------------------

cat("\nüìà Calculando RCL dos √∫ltimos 12 meses...\n")

# Definir per√≠odo: √∫ltimos 12 meses at√© o m√™s de refer√™ncia
data_inicio <- ym(mes_filtro) - months(11)
data_fim <- ym(mes_filtro) + months(1)

rcl_12_meses <- rcl %>% 
  filter(
    data_lancamento > data_inicio &
    data_lancamento < data_fim
  ) %>%
  group_by(tipo, data_lancamento) %>% 
  summarise(valor = sum(valor, na.rm = TRUE), .groups = "drop") %>% 
  pivot_wider(
    names_from = tipo, 
    values_from = valor, 
    values_fill = 0
  ) %>%
  mutate(
    # F√≥rmula da RCL: Receitas - Dedu√ß√µes + RP Cancelados
    resultado = receitas - deducoes + rp_cancelado
  )

cat(sprintf("   ‚úì Per√≠odo: %s a %s\n", 
            format(data_inicio, "%m/%Y"), 
            format(ym(mes_filtro), "%m/%Y")))
cat(sprintf("   ‚úì Meses processados: %d\n", nrow(rcl_12_meses)))

# -----------------------------------------------------------------------------
# 4. CALCULAR M√çNIMO PARA SA√öDE (15% da RCL do exerc√≠cio)
# -----------------------------------------------------------------------------

minimo_saude <- sum(
  (rcl_12_meses %>% 
     filter(year(data_lancamento) == year(ym(mes_filtro))))$resultado * 0.15
)

cat(sprintf("\nüíâ M√≠nimo para Sa√∫de (15%% RCL exerc√≠cio): R$ %s\n",
            format(minimo_saude, big.mark = ".", decimal.mark = ",", nsmall = 2)))

# -----------------------------------------------------------------------------
# 5. FUN√á√ÉO DE FORMATA√á√ÉO
# -----------------------------------------------------------------------------

formatar_real <- function(valor, decimais = 2, prefixo = "R$ ") {
  paste0(
    prefixo, 
    format(
      valor, 
      big.mark = ".",
      decimal.mark = ",",
      nsmall = decimais,
      scientific = FALSE
    )
  )
}

cat("\n‚úÖ C√°lculo da RCL conclu√≠do!\n")
```

------------------------------------------------------------------------

## üìã Resultados

### RCL Total (12 meses)

```{r exibir-rcl-total}
#| column: page

# =============================================================================
# EXIBIR RCL TOTAL
# =============================================================================

cat("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n")
cat("            RECEITA CORRENTE L√çQUIDA (RCL)           \n")
cat("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n")

# RCL dos √∫ltimos 12 meses
rcl_total_12_meses <- sum(rcl_12_meses$resultado, na.rm = TRUE)
cat(sprintf("üí∞ RCL (√∫ltimos 12 meses): %s\n\n", formatar_real(rcl_total_12_meses)))

# RCL do exerc√≠cio corrente
rcl_exercicio <- sum(
  (rcl_12_meses %>% 
     filter(year(data_lancamento) == year(ym(mes_filtro))))$resultado,
  na.rm = TRUE
)
cat(sprintf("üìÖ RCL (exerc√≠cio %s): %s\n\n", 
            year(ym(mes_filtro)), 
            formatar_real(rcl_exercicio)))

# M√≠nimo Constitucional para Sa√∫de
cat(sprintf("üíâ M√≠nimo Sa√∫de (15%% RCL exerc√≠cio): %s\n", 
            formatar_real(minimo_saude)))

cat("\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n")
```

### RCL Mensal (√öltimos 12 meses)

```{r tabela-rcl-mensal}
#| column: screen

# =============================================================================
# TABELA - RCL MENSAL
# =============================================================================
# Demonstra a evolu√ß√£o mensal da RCL nos √∫ltimos 12 meses
# =============================================================================

# Criar tabela pivotada por m√™s
tabela_rcl <- rcl %>% 
  filter(
    data_lancamento > (ym(mes_filtro) - months(11)) &
    data_lancamento < (ym(mes_filtro) + months(1))
  ) %>% 
  group_by(ordem, nome, data_lancamento) %>% 
  summarise(valor = sum(valor, na.rm = TRUE), .groups = "drop") %>% 
  pivot_wider(
    names_from = data_lancamento, 
    values_from = valor,
    values_fill = 0
  )

# Exibir com DT::datatable
datatable(
  tabela_rcl,
  caption = "RREO Anexo 03 - Receita Corrente L√≠quida por M√™s",
  options = list(
    pageLength = 25,
    scrollX = TRUE,
    dom = 'Bfrtip'
  ),
  rownames = FALSE
) %>%
  formatCurrency(
    columns = 3:ncol(tabela_rcl), 
    currency = "", 
    mark = ".", 
    dec.mark = ",", 
    digits = 2
  )
```

### Resumo por Tipo

```{r resumo-rcl-tipo}
# =============================================================================
# RESUMO POR TIPO
# =============================================================================

resumo_tipo <- rcl_12_meses %>%
  summarise(
    `Receitas Correntes` = sum(receitas, na.rm = TRUE),
    `(-) Dedu√ß√µes` = sum(deducoes, na.rm = TRUE),
    `(+) RP Cancelados` = sum(rp_cancelado, na.rm = TRUE),
    `= RCL` = sum(resultado, na.rm = TRUE)
  ) %>%
  pivot_longer(
    cols = everything(),
    names_to = "Componente",
    values_to = "Valor"
  )

datatable(
  resumo_tipo,
  caption = "Composi√ß√£o da RCL (√∫ltimos 12 meses)",
  options = list(
    pageLength = 10,
    dom = 't'
  ),
  rownames = FALSE
) %>%
  formatCurrency(
    columns = "Valor", 
    currency = "R$ ", 
    mark = ".", 
    dec.mark = ",", 
    digits = 2
  )
```

------------------------------------------------------------------------

## üíæ Dados Exportados

Os seguintes objetos ficam dispon√≠veis para uso em outros anexos:

| Objeto         | Descri√ß√£o                                           |
|----------------|-----------------------------------------------------|
| `rcl`          | Dados detalhados por categoria e m√™s                |
| `rcl_12_meses` | RCL agregada por m√™s (√∫ltimos 12 meses)             |
| `minimo_saude` | Valor do m√≠nimo constitucional para sa√∫de (15% RCL) |

------------------------------------------------------------------------

## üìë Anexos que Utilizam a RCL

A RCL calculada neste anexo √© utilizada como **base de c√°lculo** para:

### RGF - Relat√≥rio de Gest√£o Fiscal

| Anexo | Descri√ß√£o | Uso da RCL |
|------------------------|------------------------|------------------------|
| **RGF A01** | Despesa com Pessoal | Limite de 60% (Uni√£o) |
| **RGF A02** | D√≠vida Consolidada L√≠quida | Limite de endividamento |
| **RGF A03** | Garantias e Contragarantias | Limite de garantias |
| **RGF A04** | Opera√ß√µes de Cr√©dito | Limite de opera√ß√µes |
| **RGF A06** | Demonstrativo Simplificado | RCL como base para todos os limites |

### RREO - Outros Anexos

| Anexo        | Descri√ß√£o                     | Uso da RCL           |
|--------------|-------------------------------|----------------------|
| **RREO A12** | Receitas e Despesas com Sa√∫de | M√≠nimo de 15% da RCL |

------------------------------------------------------------------------

## üí° Observa√ß√µes Importantes

1.  **Base para LRF**: A RCL √© fundamental para verificar cumprimento dos limites da Lei de Responsabilidade Fiscal

2.  **C√°lculo**: RCL = Receitas Correntes - Transfer√™ncias Constitucionais - Contribui√ß√µes Previdenci√°rias + RP Cancelados

3.  **Per√≠odo**: Utiliza-se a RCL acumulada dos √∫ltimos 12 meses (per√≠odo m√≥vel)

4.  **M√≠nimo Sa√∫de**: 15% da RCL do **exerc√≠cio corrente** (n√£o dos √∫ltimos 12 meses)

5.  **Cr√≠tico**: Todos os anexos RGF dependem deste c√°lculo para verifica√ß√£o de limites

# üìã RREO Anexo 04 - Demonstrativo das Receitas e Despesas Previdenci√°rias

## üìë Ficha T√©cnica

| Campo               | Informa√ß√£o                                            |
|---------------------|---------------------------------------------------|
| Relat√≥rio           | RREO - Relat√≥rio Resumido da Execu√ß√£o Or√ßament√°ria    |
| Anexo               | Anexo 04                                              |
| Nome                | Demonstrativo das Receitas e Despesas Previdenci√°rias |
| Base Legal          | LRF Art. 53, inciso II                                |
| Periodicidade       | Bimestral                                             |
| Grau de Dificuldade | Dif√≠cil                                               |
| √öltima Atualiza√ß√£o  | Dezembro/2025                                         |

## üìÅ Arquivos Necess√°rios

| Arquivo | Descri√ß√£o | Filtros no TG |
|------------------------|------------------------|------------------------|
| dados_receita | Receitas or√ßament√°rias | Base compartilhada - UOs previdenci√°rias |
| dados_despesa | Despesas or√ßament√°rias | Base compartilhada - Subfun√ß√µes 272, 273, 274, 845, 846 |

## üìä Atributos Utilizados

| Atributo | Tipo | Uso | Descri√ß√£o |
|------------------|------------------|------------------|------------------|
| unidade_orcamentaria_codigo | character | TG / Crit√©rio | C√≥digo da UO (33904=INSS, 40904=FAT, 73901=FCDF) |
| natureza_receita_codigo_completo | character | TG / Crit√©rio | C√≥digo completo da natureza de receita |
| natureza_receita_nome | character | TG / Crit√©rio | Nome da natureza de receita |
| nre1_categoria_economica_codigo | character | TG / Crit√©rio | Categoria econ√¥mica (1=Corrente, 2=Capital, 7/8=Intra) |
| nre2_origem_receita_codigo_origem | character | TG / Crit√©rio | Origem da receita |
| fonte_recursos_codigo | character | TG / Crit√©rio | C√≥digo da fonte de recursos |
| fonte_recursos_detalhada_codigo | character | TG / Crit√©rio | C√≥digo detalhado da fonte |
| esfera_orcamentaria_codigo | character | TG / Crit√©rio | Esfera or√ßament√°ria (2=Seguridade) |
| funcao_governo_codigo | character | TG / Crit√©rio | Fun√ß√£o de governo |
| subfuncao_governo_codigo | character | TG / Crit√©rio | Subfun√ß√£o (272, 273, 274, 845, 846) |
| acao_governo_codigo | character | TG / Crit√©rio | C√≥digo da a√ß√£o de governo |
| grupo_despesa_codigo_grupo | character | TG / Crit√©rio | Grupo de despesa (1=Pessoal, 3=ODC) |
| elemento_despesa_codigo | character | TG / Crit√©rio | Elemento de despesa (01, 03, 53-58, etc) |
| modalidade_aplicacao_codigo | character | TG / Crit√©rio | Modalidade (91=Intra) |
| item_informacao_codigo | character | TG / Crit√©rio | Tipo de info (5=Realizado, 25=Empenhado) |
| mes_lancamento | numeric | TG / R | M√™s do lan√ßamento (YYYYMM) |
| saldo_r_item_informacao | numeric | TG / R | Saldo do item de informa√ß√£o |

## üîó V√≠nculos com Outros Anexos

| Anexo Relacionado | Tipo de V√≠nculo | Descri√ß√£o |
|------------------------|------------------------|------------------------|
| RREO Anexo 01 | Refer√™ncia | Receitas or√ßament√°rias base |
| RREO Anexo 02 | Refer√™ncia | Despesas or√ßament√°rias base |
| RGF Anexo 01 | Refer√™ncia | Despesa com pessoal inclui inativos e pensionistas |
| RGF Anexo 02 | Refer√™ncia | Passivo atuarial do RPPS e militares |
| RREO Anexo 14 | Consolida√ß√£o | Proje√ß√£o atuarial do RPPS |

## üìñ Introdu√ß√£o

O **Anexo 04** apresenta o demonstrativo das receitas e despesas previdenci√°rias do Governo Federal, segregado em tr√™s sistemas:

-   **RGPS** - Regime Geral de Previd√™ncia Social (INSS)
-   **RPPS** - Regime Pr√≥prio de Previd√™ncia Social (Servidores Civis e Militares)
-   **FCDF** - Fundo Constitucional do Distrito Federal

------------------------------------------------------------------------

## üèõÔ∏è REGIME GERAL DE PREVID√äNCIA SOCIAL (RGPS)

### Unidades Or√ßament√°rias RGPS

| C√≥digo UO | Nome                                        |
|-----------|---------------------------------------------|
| 33904     | Fundo do Regime Geral de Previd√™ncia Social |
| 40904     | Fundo de Amparo ao Trabalhador (FAT)        |
| 55902     | Fundo Nacional de Assist√™ncia Social        |
| 25917     | Demais UOs vinculadas                       |

### üí∞ Crit√©rios de Receitas RGPS

```{r criterios-receitas-rgps}
#| include: false

criterios_rreo_A04_rgps_receitas_rgps <- list(
  
  `01  Receitas Correntes - Dos Empregadores, Trabalhadores e Demais Segurados` = list(
    criterio = "natureza_receita_codigo_completo %in% c('12100311', '12100312', '12100313', '12100311') & nre2_origem_receita_codigo_origem %in% c(2) | startsWith(natureza_receita_codigo_completo, '1214') "
  ),
  
  `02  Receitas Correntes - Demais Contribui√ß√µes` = list(
    criterio = "nre2_origem_receita_codigo_origem %in% c(2) & natureza_receita_codigo_completo %notin% c('12100311', '12100312', '12100313')"
  ),
  
  `03  Outras Receitas Correntes - Compensa√ß√£o Previdenci√°ria RPPS/RGPS` = list(
    criterio = "nre2_origem_receita_codigo_origem %in% c(9)"
  ),
  
  `04  Demais Receitas Correntes` = list(
    criterio = "nre1_categoria_economica_codigo %in% c(1) & nre2_origem_receita_codigo_origem %notin% c(2,9)"
  ),
  
  `05  Receitas de Capital - Aliena√ß√µes` = list(
    criterio = "nre2_origem_receita_codigo_origem %in% c(2) & nre1_categoria_economica_codigo %in% c(2)"
  ),
  
  `06  Demais Receitas de Capital` = list(
    criterio = "nre1_categoria_economica_codigo %in% c(2) & nre2_origem_receita_codigo_origem %notin% c(2)"
  ),
  
  `07  Receitas INTRA-OR√áAMENT√ÅRIAS` = list(
    criterio = "nre1_categoria_economica_codigo %in% c(7, 8)"
  )
)
```

### üí∏ Crit√©rios de Despesas RGPS

```{r criterios-despesas-rgps}
#| include: false

criterios_rreo_A04_rgps_despesas_rgps <- list(
  
  `01  Aposentadorias` = list(
    criterio = "elemento_despesa_codigo %in% c('53', '54') & grupo_despesa_codigo_grupo %in% c(3) & modalidade_aplicacao_codigo %notin% c('91')"
  ),
  
  `02  Pens√µes` = list(
    criterio = "elemento_despesa_codigo %in% c('55', '56') & grupo_despesa_codigo_grupo %in% c(3) & modalidade_aplicacao_codigo %notin% c('91')"
  ),
  
  `03  Outros Benef√≠cios` = list(
    criterio = "elemento_despesa_codigo %in% c('57', '58') & grupo_despesa_codigo_grupo %in% c(3) & modalidade_aplicacao_codigo %notin% c('91')"
  ),
  
  `04  Compensa√ß√£o Previdenci√°ria do RGPS para o RPPS` = list(
    criterio = "elemento_despesa_codigo %notin% c('57', '58', '53', '54', '55', '56') & acao_governo_codigo %in% c('009W', '0531') & grupo_despesa_codigo_grupo %in% c(3) & modalidade_aplicacao_codigo %notin% c('91')"
  ),
  
  `05  Demais Despesas` = list(
    criterio = "elemento_despesa_codigo %notin% c('57', '58', '53', '54', '55', '56') & acao_governo_codigo %notin% c('009W', '0531') & grupo_despesa_codigo_grupo %in% c(3) & modalidade_aplicacao_codigo %notin% c('91')"
  ),
  
  `06  A detalhar` = list(
    criterio = "elemento_despesa_codigo %in% c('00') & grupo_despesa_codigo_grupo %in% c(3) & modalidade_aplicacao_codigo %notin% c('91')"
  ),
  
  `07  Despesas Previdenci√°rias (INTRA)` = list(
    criterio = "grupo_despesa_codigo_grupo %in% c(3) & modalidade_aplicacao_codigo %in% c('91') & elemento_despesa_codigo %notin% c('01', '03', '05')"
  )
)
```

### üìä Processamento RGPS - Receitas

```{r processar-rgps-receitas}
#| include: false

aplicar_criterios(
  df = dados_receita %>% 
    filter(
      unidade_orcamentaria_codigo %in% c(33904, 40904, 55902, 25917) | 
      natureza_receita_codigo_completo == 79900211
    ), 
  criterios_rreo_A04_rgps_receitas_rgps
)
```

### üìä Processamento RGPS - Despesas

```{r processar-rgps-despesas}
#| include: false

aplicar_criterios(
  df = dados_despesa %>% 
    filter(unidade_orcamentaria_codigo %in% c(33904, 40904, 55902, 25917)), 
  criterios_rreo_A04_rgps_despesas_rgps
)
```

### üìä Resultado RGPS

```{r resultado-rgps}
#| include: true

# =============================================================================
# CALCULO DO RESULTADO PREVIDENCIARIO RGPS
# =============================================================================

if (!exists("dados_receita") || !exists("criterios_rreo_A04_rgps_receitas_rgps")) {
  warning("Objetos necessarios nao encontrados para calculo RGPS")
  df_resultado_rgps <- tibble(
    Tipo = c("Receita_RGPS", "Despesa_RGPS", "Resultado_RGPS"), 
    Valor = c(NA_real_, NA_real_, NA_real_)
  )
} else {
  df_resultado_rgps <- tibble(
    Receita_RGPS = aplicar_criterios(
      df = dados_receita %>%
        filter(
          unidade_orcamentaria_codigo %in% c(33904, 40904, 55902, 25917) |
          natureza_receita_codigo_completo == 79900211,
          item_informacao_codigo %in% c("5", 5)
        ), 
      criterios_rreo_A04_rgps_receitas_rgps
    ) %>% 
      filter(ordem != "02") %>% 
      summarise(valor = sum(valor, na.rm = TRUE)) %>% 
      pull(valor),
    
    Despesa_RGPS = aplicar_criterios(
      df = dados_despesa %>%
        filter(
          unidade_orcamentaria_codigo %in% c(33904, 40904, 55902, 25917),
          item_informacao_codigo %in% c("25", 25)
        ), 
      criterios_rreo_A04_rgps_despesas_rgps
    ) %>% 
      summarise(valor = sum(valor, na.rm = TRUE)) %>% 
      pull(valor)
  ) %>%
    mutate(Resultado_RGPS = Receita_RGPS - Despesa_RGPS) %>%
    pivot_longer(
      cols = everything(),
      names_to = "Tipo",
      values_to = "Valor"
    )
}

# Exibir com DT::datatable formatado
DT::datatable(
  df_resultado_rgps,
  options = list(dom = 't', pageLength = 3),
  rownames = FALSE
) %>%
  DT::formatCurrency("Valor", currency = "R$ ", digits = 2, mark = ".", dec.mark = ",")
```

------------------------------------------------------------------------

## üë• REGIME PR√ìPRIO DE PREVID√äNCIA SOCIAL (RPPS)

### Filtros Gerais RPPS

| Filtro         | Valor        | Descri√ß√£o                                     |
|----------------|----------------|----------------------------------------|
| UO exclu√≠da    | 73901        | Opera√ß√µes Oficiais de Cr√©dito (vai para FCDF) |
| Fonte exclu√≠da | 054, 00, 000 | Fontes n√£o previdenci√°rias                    |

### üí∞ Crit√©rios de Receitas RPPS

```{r criterios-receitas-rpps}
#| include: false

criterios_rreo_A04_rpps_receitas_civil_militar_rpps <- list(
  
  `01  CIVIS - RECEITA SEGURADOS - Ativo` = list(
    criterio = "fonte_recursos_codigo %notin% c('00', '000') & (natureza_receita_codigo_completo %in% c('12100423', '12100421', '12100422', '12100424', '12100461', '12100462', '12100463', '12100464') | startsWith(natureza_receita_codigo_completo, '1215011') | startsWith(natureza_receita_codigo_completo, '1215014') | startsWith(natureza_receita_codigo_completo, '121503'))"
  ),
  
  `02  CIVIS - RECEITA SEGURADOS - Inativos` = list(
    criterio = "fonte_recursos_codigo %notin% c('00', '000') & (natureza_receita_codigo_completo %in% c('12100431', '12100433', '12100432', '12100434', '12100471') | startsWith(natureza_receita_codigo_completo, '1215012') | startsWith(natureza_receita_codigo_completo, '1215015'))"
  ),
  
  `03  CIVIS - RECEITAS SEGURADOS - Pensionistas` = list(
    criterio = "fonte_recursos_codigo %notin% c('00', '000') & (natureza_receita_codigo_completo %in% c('12100481', '12100441', '12100442', '12100443', '12100444') | startsWith(natureza_receita_codigo_completo, '1215013') | startsWith(natureza_receita_codigo_completo, '1215016'))"
  ),
  
  `04  CIVIS - RECEITA PATRONAL - Ativo` = list(
    criterio = "fonte_recursos_codigo %notin% c('00', '000') & (natureza_receita_codigo_completo %in% c('12100411', '12100413', '12100412', '12100414', '72100411', '72100413', '72100414', '72100451', '72100452', '12100452', '12100453', '12100454') | startsWith(natureza_receita_codigo_completo, '121502') | startsWith(natureza_receita_codigo_completo, '721502'))"
  ),
  
  `05  CIVIS - RECEITA PATRONAL - Inativos e Pensionistas - vinculada` = list(
    criterio = "fonte_recursos_codigo %notin% c('00', '000') & natureza_receita_codigo_completo %in% c('72100441')"
  ),
  
  `06  DRU - FCDF` = list(
    criterio = "fonte_recursos_codigo %in% c('000', '00') & endsWith(fonte_recursos_detalhada_codigo, '980001') & startsWith(natureza_receita_codigo_completo, '12151')"
  ),
  
  `07  MILITARES - RECEITAS - Segurados` = list(
    criterio = "fonte_recursos_codigo %notin% c('00', '000') & (natureza_receita_codigo_completo %in% c('12100511', '12100512', '12100513', '12105141', '12150411', '12150412', '12150421', '12150043', '12150044') | startsWith(natureza_receita_codigo_completo, '121911'))"
  )
)
```

### üí∏ Crit√©rios de Despesas RPPS

```{r criterios-despesas-rpps}
#| include: false

criterios_rreo_A04_rpps_despesas_civil_militar_rpps <- list(
  
  `01  CIVIS - DESPESAS - A detalhar` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845') & grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %in% c('00') & acao_governo_codigo %in% c('0053', '0181') & funcao_governo_codigo %notin% c('10', '08')"
  ),
  
  `02  CIVIS - DESPESAS - Aposentadorias` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845') & grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %in% c('01') & acao_governo_codigo %in% c('0053', '0181')"
  ),
  
  `03  CIVIS - DESPESAS - Pens√µes` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845') & grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %in% c('03') & acao_governo_codigo %in% c('0053', '0181')"
  ),
  
  `04  CIVIS - DESPESAS - Outros Benef√≠cios Previdenci√°rios` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845', '846') & grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %notin% c('00', '01', '03') & (acao_governo_codigo %in% c('0053', '0181', '0005', '0625') & funcao_governo_codigo %notin% c('10', '08') | acao_governo_codigo %in% c('0397'))"
  ),
  
  `05  MILITARES - DESPESAS - A Detalhar Pens√µes` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845') & grupo_despesa_codigo_grupo %in% c(1) & acao_governo_codigo %in% c('0179', '000Q') & elemento_despesa_codigo %in% c('00')"
  ),
  
  `06  MILITARES - DESPESAS - Pens√µes` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845', '846') & grupo_despesa_codigo_grupo %in% c(1) & acao_governo_codigo %in% c('0179', '00QD') & elemento_despesa_codigo %in% c('03')"
  ),
  
  `07  MILITARES - DESPESAS - Outros Benef√≠cios Pensionistas` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(2) & acao_governo_codigo %in% c('214H', '218K', '0179', '00QD') & elemento_despesa_codigo %notin% c('00', '01', '03') & grupo_despesa_codigo_grupo %in% c(1)"
  ),
  
  `08  MILITARES - DESPESAS - A Detalhar Inativos` = list(
    criterio = "grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %in% c('00') & acao_governo_codigo %in% c('214H', '218K')"
  ),
  
  `09  MILITARES - DESPESAS - Inativos` = list(
    criterio = "grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %in% c('01') & acao_governo_codigo %in% c('214H', '218K')"
  ),
  
  `10  MILITARES - DESPESAS - Outros Benef√≠cios Inativos` = list(
    criterio = "grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %notin% c('00', '01') & acao_governo_codigo %in% c('214H', '218K')"
  ),
  
  `11  MILITARES - DESPESAS - Compensa√ß√£o financeira entre RPPSU e os demais RPPS` = list(
    criterio = "acao_governo_codigo %in% c('00X3')"
  )
)
```

### üìä Processamento RPPS - Receitas

```{r processar-rpps-receitas}
#| include: false

datatable(
  aplicar_criterios(
    df = dados_receita %>% 
      filter(
        unidade_orcamentaria_codigo %notin% c(73901),
        fonte_recursos_codigo %notin% c('054')
      ), 
    criterios_rreo_A04_rpps_receitas_civil_militar_rpps
  )
)
```

### üìä Processamento RPPS - Despesas

```{r processar-rpps-despesas}
#| include: false

datatable(
  aplicar_criterios(
    df = dados_despesa %>% 
      filter(
        unidade_orcamentaria_codigo %notin% c(73901),
        elemento_despesa_codigo %notin% c('04', '07', '11', '13', '16', '39', '67', '96'),
        acao_governo_codigo != '09HB'
      ), 
    criterios_rreo_A04_rpps_despesas_civil_militar_rpps
  )
)
```

### üìä Resultado RPPS Civil

```{r resultado-rpps-civil}
#| include: true

# =============================================================================
# CALCULO DO RESULTADO PREVIDENCIARIO RPPS CIVIL
# =============================================================================

if (!exists("dados_receita") || !exists("criterios_rreo_A04_rpps_receitas_civil_militar_rpps")) {
  warning("Objetos necessarios nao encontrados para RPPS Civil")
  df_resultado_rpps_civil <- tibble(
    Tipo = c("Receita_RPPS_Civil", "Despesa_RPPS_Civil", "Resultado_RPPS_Civil"), 
    Valor = c(NA_real_, NA_real_, NA_real_)
  )
} else {
  df_resultado_rpps_civil <- tibble(
    Receita_RPPS_Civil = aplicar_criterios(
      df = dados_receita %>%
        filter(
          unidade_orcamentaria_codigo %notin% c(73901),
          fonte_recursos_codigo %notin% c('054'),
          item_informacao_codigo %in% c("5", 5)
        ), 
      criterios_rreo_A04_rpps_receitas_civil_militar_rpps
    ) %>%
      # Filtra apenas linhas de CIVIS (01 a 06)
      filter(grepl("^0[1-6]", ordem)) %>%
      summarise(valor = sum(valor, na.rm = TRUE)) %>% 
      pull(valor),
    
    Despesa_RPPS_Civil = aplicar_criterios(
      df = dados_despesa %>%
        filter(
          unidade_orcamentaria_codigo %notin% c(73901),
          elemento_despesa_codigo %notin% c('04', '07', '11', '13', '16', '39', '67', '96'),
          acao_governo_codigo != '09HB',
          item_informacao_codigo %in% c("25", 25)
        ), 
      criterios_rreo_A04_rpps_despesas_civil_militar_rpps
    ) %>%
      # Filtra apenas linhas de CIVIS (01 a 04)
      filter(str_detect(nome, "CIVIS")) %>%
      summarise(valor = sum(valor, na.rm = TRUE)) %>% 
      pull(valor)
  ) %>%
    mutate(Resultado_RPPS_Civil = Receita_RPPS_Civil - Despesa_RPPS_Civil) %>%
    pivot_longer(
      cols = everything(),
      names_to = "Tipo",
      values_to = "Valor"
    )
}

# Exibir tabela formatada
DT::datatable(
  df_resultado_rpps_civil,
  options = list(dom = 't', pageLength = 3),
  rownames = FALSE
) %>%
  DT::formatCurrency("Valor", currency = "R$ ", digits = 2, mark = ".", dec.mark = ",")
```

### üìä Resultado RPPS Militar

```{r resultado-rpps-militar}
#| include: true

# =============================================================================
# CALCULO DO RESULTADO PREVIDENCIARIO RPPS MILITAR
# =============================================================================

if (!exists("dados_receita") || !exists("criterios_rreo_A04_rpps_receitas_civil_militar_rpps")) {
  warning("Objetos necessarios nao encontrados para RPPS Militar")
  df_resultado_rpps_militar <- tibble(
    Tipo = c("Receita_RPPS_Militar", "Despesa_RPPS_Militar", "Resultado_RPPS_Militar"), 
    Valor = c(NA_real_, NA_real_, NA_real_)
  )
} else {
  df_resultado_rpps_militar <- tibble(
    Receita_RPPS_Militar = aplicar_criterios(
      df = dados_receita %>%
        filter(
          unidade_orcamentaria_codigo %notin% c(73901),
          fonte_recursos_codigo %notin% c('054'),
          item_informacao_codigo %in% c("5", 5)
        ), 
      criterios_rreo_A04_rpps_receitas_civil_militar_rpps
    ) %>%
      # Filtra apenas linha de MILITARES (07)
      filter(grepl("^07", ordem)) %>%
      summarise(valor = sum(valor, na.rm = TRUE)) %>% 
      pull(valor),
    
    Despesa_RPPS_Militar = aplicar_criterios(
      df = dados_despesa %>%
        filter(
          unidade_orcamentaria_codigo %notin% c(73901),
          elemento_despesa_codigo %notin% c('04', '07', '11', '13', '16', '39', '67', '96'),
          acao_governo_codigo != '09HB',
          item_informacao_codigo %in% c("25", 25)
        ), 
      criterios_rreo_A04_rpps_despesas_civil_militar_rpps
    ) %>%
      filter(str_detect(nome, "MILITARES")) %>%
      summarise(valor = sum(valor, na.rm = TRUE)) %>% 
      pull(valor)
  ) %>%
    mutate(Resultado_RPPS_Militar = Receita_RPPS_Militar - Despesa_RPPS_Militar) %>%
    pivot_longer(
      cols = everything(),
      names_to = "Tipo",
      values_to = "Valor"
    )
}

# Exibir tabela formatada
DT::datatable(
  df_resultado_rpps_militar,
  options = list(dom = 't', pageLength = 3),
  rownames = FALSE
) %>%
  DT::formatCurrency("Valor", currency = "R$ ", digits = 2, mark = ".", dec.mark = ",")
```

### üìä Resultado RPPS Total

```{r resultado-rpps-total}
#| include: true

# =============================================================================
# CALCULO DO RESULTADO PREVIDENCIARIO RPPS TOTAL
# =============================================================================

if (!exists("dados_receita") || !exists("criterios_rreo_A04_rpps_receitas_civil_militar_rpps")) {
  warning("Objetos necessarios nao encontrados para RPPS Total")
  df_resultado_rpps <- tibble(
    Tipo = c("Receita_RPPS", "Despesa_RPPS", "Resultado_RPPS"), 
    Valor = c(NA_real_, NA_real_, NA_real_)
  )
} else {
  df_resultado_rpps <- tibble(
    Receita_RPPS = aplicar_criterios(
      df = dados_receita %>%
        filter(
          unidade_orcamentaria_codigo %notin% c(73901),
          fonte_recursos_codigo %notin% c('054'),
          item_informacao_codigo %in% c("5", 5)
        ), 
      criterios_rreo_A04_rpps_receitas_civil_militar_rpps
    ) %>% 
      summarise(valor = sum(valor, na.rm = TRUE)) %>% 
      pull(valor),
    
    Despesa_RPPS = aplicar_criterios(
      df = dados_despesa %>%
        filter(
          unidade_orcamentaria_codigo %notin% c(73901),
          elemento_despesa_codigo %notin% c('04', '07', '11', '13', '16', '39', '67', '96'),
          acao_governo_codigo != '09HB',
          item_informacao_codigo %in% c("25", 25)
        ), 
      criterios_rreo_A04_rpps_despesas_civil_militar_rpps
    ) %>% 
      summarise(valor = sum(valor, na.rm = TRUE)) %>% 
      pull(valor)
  ) %>%
    mutate(Resultado_RPPS = Receita_RPPS - Despesa_RPPS) %>%
    pivot_longer(
      cols = everything(),
      names_to = "Tipo",
      values_to = "Valor"
    )
}

# Exibir tabela formatada
DT::datatable(
  df_resultado_rpps,
  options = list(dom = 't', pageLength = 3),
  rownames = FALSE
) %>%
  DT::formatCurrency("Valor", currency = "R$ ", digits = 2, mark = ".", dec.mark = ",")
```

------------------------------------------------------------------------

## üèõÔ∏è REGIME PR√ìPRIO DE PREVID√äNCIA SOCIAL - FCDF

### üí∞ Crit√©rios de Receitas FCDF

```{r criterios-receitas-fcdf}
#| include: false

criterios_rreo_A04_rpps_receitas_fcdf <- list(
  
  `01  FCDF - RECEITA SEGURADOS - Ativo` = list(
    criterio = "fonte_recursos_codigo %notin% c('00', '000') & (natureza_receita_codigo_completo %in% c('12100431', '12104211', '12104221', '12104231', '12104411', '12104421', '12104431', '12104611', '12104621', '12104631', '12191111', '12191321', '12191411') | startsWith(natureza_receita_codigo_completo, '121503') | startsWith(natureza_receita_codigo_completo, '1215011') | startsWith(natureza_receita_codigo_completo, '1215014'))"
  ),
  
  `02  FCDF - RECEITA SEGURADOS - Inativos` = list(
    criterio = "fonte_recursos_codigo %notin% c('00', '000') & (natureza_receita_codigo_completo %in% c('12104311', '12104321', '12104331', '12104341', '12104711') | startsWith(natureza_receita_codigo_completo, '1215012') | startsWith(natureza_receita_codigo_completo, '1215015'))"
  ),
  
  `03  FCDF - RECEITAS SEGURADOS - Pensionistas` = list(
    criterio = "fonte_recursos_codigo %notin% c('00', '000') & (natureza_receita_codigo_completo %in% c('12104811', '12104411', '12104421', '12104431', '12104441', '12105121', '12105131') | startsWith(natureza_receita_codigo_completo, '1215013') | startsWith(natureza_receita_codigo_completo, '1215016'))"
  ),
  
  `04  FCDF - RECEITA PATRONAL - Ativo` = list(
    criterio = "fonte_recursos_codigo %notin% c('00', '000') & (natureza_receita_codigo_completo %in% c('12104111', '12104131', '12104121', '12104141', '72104111', '72104121', '72104131', '72104141', '72104511', '72104521', '72104531', '72104541') | startsWith(natureza_receita_codigo_completo, '121502') | startsWith(natureza_receita_codigo_completo, '721502'))"
  ),
  
  `05  FCDF - RECEITA PATRONAL - Inativos e Pensionistas - vinculada` = list(
    criterio = "fonte_recursos_codigo %notin% c('00', '000') & natureza_receita_codigo_completo %in% c('72104411', '12150211')"
  ),
  
  `06  DRU - FCDF` = list(
    criterio = "fonte_recursos_codigo %in% c('00', '000') & (natureza_receita_codigo_completo %in% c('12104811', '12104411', '12104421', '12104431', '12104441', '12105111', '12104211', '12104221', '12104231', '12104311', '12104321', '12104331', '12104341', '12104521', '12104531', '12104621', '12104631', '12104721', '12104731', '12104741', '12104831', '12104841') | startsWith(natureza_receita_codigo_completo, '1215') | startsWith(natureza_receita_codigo_completo, '7215'))"
  ),
  
  `07  Total de Receitas RPPS FCDF` = list(
    criterio = "unidade_orcamentaria_codigo %notin% c('55902', '33904') & fonte_recursos_codigo %notin% c('54', '054') & fonte_recursos_detalhada_codigo %notin% c('010073910') & fonte_recursos_codigo %in% c('23', '56', '023', '056', '024') & (grepl('PENSI|PENSO|RPPS|CPSS', natureza_receita_nome, ignore.case = TRUE))"
  )
)
```

### üí∏ Crit√©rios de Despesas FCDF

```{r criterios-despesas-fcdf}
#| include: false

criterios_rreo_A04_rpps_despesas_fcdf <- list(
  
  `01  FCDF - DESPESAS - A detalhar` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(1, 2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845') & grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %in% c('00') & acao_governo_codigo %in% c('00Q2', '00QN', '00NS')"
  ),
  
  `02  FCDF - DESPESAS - Aposentadorias` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(1, 2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845') & grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %in% c('01') & acao_governo_codigo %in% c('00Q2', '00QN', '00NS', '0312', '00NR')"
  ),
  
  `03  FCDF - DESPESAS - Pens√µes` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(1, 2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845') & grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %in% c('03') & acao_governo_codigo %in% c('00Q2', '00QN', '00NS', '0312', '00NR')"
  ),
  
  `04  FCDF - DESPESAS - Outros Benef√≠cios Previdenci√°rios` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(1, 2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845', '846') & grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %notin% c('00', '01', '03') & (acao_governo_codigo %in% c('00Q2', '00NS', '00QN') | (acao_governo_codigo %in% c('0005', '0625') & funcao_governo_codigo %notin% c('10', '08')))"
  )
)
```

### üìä Processamento FCDF - Receitas

```{r processar-fcdf-receitas}
#| include: false

datatable(
  aplicar_criterios(
    df = dados_receita %>% 
      filter(unidade_orcamentaria_codigo %in% c(73901)),
    criterios_rreo_A04_rpps_receitas_fcdf
  )
)
```

### üìä Processamento FCDF - Despesas

```{r processar-fcdf-despesas}
#| include: false

datatable(
  aplicar_criterios(
    df = dados_despesa %>% 
      filter(
        unidade_orcamentaria_codigo %in% c(73901),
        elemento_despesa_codigo %notin% c('04', '07', '11', '13', '16', '39', '67', '96'),
        acao_governo_codigo != '09HB'
      ),
    criterios_rreo_A04_rpps_despesas_fcdf
  )
)
```

### üìä Resultado FCDF

```{r resultado-fcdf}
#| include: true

# =============================================================================
# CALCULO DO RESULTADO PREVIDENCIARIO FCDF
# =============================================================================

if (!exists("dados_receita") || !exists("criterios_rreo_A04_rpps_receitas_fcdf")) {
  warning("Objetos necessarios nao encontrados para FCDF")
  df_resultado_fcdf <- tibble(
    Tipo = c("Receita_FCDF", "Despesa_FCDF", "Resultado_FCDF"), 
    Valor = c(NA_real_, NA_real_, NA_real_)
  )
} else {
  df_resultado_fcdf <- tibble(
    Receita_FCDF = aplicar_criterios(
      df = dados_receita %>%
        filter(
          unidade_orcamentaria_codigo %in% c(73901),
          item_informacao_codigo %in% c("5", 5)
        ), 
      criterios_rreo_A04_rpps_receitas_fcdf
    ) %>% 
      summarise(valor = sum(valor, na.rm = TRUE)) %>% 
      pull(valor),
    
    Despesa_FCDF = aplicar_criterios(
      df = dados_despesa %>%
        filter(
          unidade_orcamentaria_codigo %in% c(73901),
          elemento_despesa_codigo %notin% c('04', '07', '11', '13', '16', '39', '67', '96'),
          acao_governo_codigo != '09HB',
          item_informacao_codigo %in% c("25", 25)
        ), 
      criterios_rreo_A04_rpps_despesas_fcdf
    ) %>% 
      summarise(valor = sum(valor, na.rm = TRUE)) %>% 
      pull(valor)
  ) %>%
    mutate(Resultado_FCDF = Receita_FCDF - Despesa_FCDF) %>%
    pivot_longer(
      cols = everything(),
      names_to = "Tipo",
      values_to = "Valor"
    )
}

# Exibir tabela formatada
DT::datatable(
  df_resultado_fcdf,
  options = list(dom = 't', pageLength = 3),
  rownames = FALSE
) %>%
  DT::formatCurrency("Valor", currency = "R$ ", digits = 2, mark = ".", dec.mark = ",")
```

------------------------------------------------------------------------

## üìä Resumo Consolidado Previd√™ncia

```{r resumo-previdencia}
#| include: true

# =============================================================================
# RESUMO CONSOLIDADO - TODOS OS REGIMES
# =============================================================================

cat("\n")
cat(strrep("=", 70), "\n")
cat("RESUMO PREVIDENCI√ÅRIO - RREO ANEXO 04\n")
cat(strrep("=", 70), "\n\n")

# RGPS
if (exists("df_resultado_rgps")) {
  rgps_rec <- df_resultado_rgps %>% filter(Tipo == "Receita_RGPS") %>% pull(Valor)
  rgps_desp <- df_resultado_rgps %>% filter(Tipo == "Despesa_RGPS") %>% pull(Valor)
  rgps_res <- df_resultado_rgps %>% filter(Tipo == "Resultado_RGPS") %>% pull(Valor)
  
  cat("üìä RGPS - Regime Geral de Previd√™ncia Social\n")
  cat(sprintf("   Receitas:  R$ %s\n", format(rgps_rec, big.mark = ".", decimal.mark = ",", nsmall = 2)))
  cat(sprintf("   Despesas:  R$ %s\n", format(rgps_desp, big.mark = ".", decimal.mark = ",", nsmall = 2)))
  cat(sprintf("   Resultado: R$ %s\n\n", format(rgps_res, big.mark = ".", decimal.mark = ",", nsmall = 2)))
}

# RPPS Civil
if (exists("df_resultado_rpps_civil")) {
  rpps_civ_rec <- df_resultado_rpps_civil %>% filter(Tipo == "Receita_RPPS_Civil") %>% pull(Valor)
  rpps_civ_desp <- df_resultado_rpps_civil %>% filter(Tipo == "Despesa_RPPS_Civil") %>% pull(Valor)
  rpps_civ_res <- df_resultado_rpps_civil %>% filter(Tipo == "Resultado_RPPS_Civil") %>% pull(Valor)
  
  cat("üë• RPPS Civil - Servidores Civis\n")
  cat(sprintf("   Receitas:  R$ %s\n", format(rpps_civ_rec, big.mark = ".", decimal.mark = ",", nsmall = 2)))
  cat(sprintf("   Despesas:  R$ %s\n", format(rpps_civ_desp, big.mark = ".", decimal.mark = ",", nsmall = 2)))
  cat(sprintf("   Resultado: R$ %s\n\n", format(rpps_civ_res, big.mark = ".", decimal.mark = ",", nsmall = 2)))
}

# RPPS Militar
if (exists("df_resultado_rpps_militar")) {
  rpps_mil_rec <- df_resultado_rpps_militar %>% filter(Tipo == "Receita_RPPS_Militar") %>% pull(Valor)
  rpps_mil_desp <- df_resultado_rpps_militar %>% filter(Tipo == "Despesa_RPPS_Militar") %>% pull(Valor)
  rpps_mil_res <- df_resultado_rpps_militar %>% filter(Tipo == "Resultado_RPPS_Militar") %>% pull(Valor)
  
  cat("üéñÔ∏è RPPS Militar - Militares das For√ßas Armadas\n")
  cat(sprintf("   Receitas:  R$ %s\n", format(rpps_mil_rec, big.mark = ".", decimal.mark = ",", nsmall = 2)))
  cat(sprintf("   Despesas:  R$ %s\n", format(rpps_mil_desp, big.mark = ".", decimal.mark = ",", nsmall = 2)))
  cat(sprintf("   Resultado: R$ %s\n\n", format(rpps_mil_res, big.mark = ".", decimal.mark = ",", nsmall = 2)))
}

# FCDF
if (exists("df_resultado_fcdf")) {
  fcdf_rec <- df_resultado_fcdf %>% filter(Tipo == "Receita_FCDF") %>% pull(Valor)
  fcdf_desp <- df_resultado_fcdf %>% filter(Tipo == "Despesa_FCDF") %>% pull(Valor)
  fcdf_res <- df_resultado_fcdf %>% filter(Tipo == "Resultado_FCDF") %>% pull(Valor)
  
  cat("üèõÔ∏è FCDF - Fundo Constitucional do DF\n")
  cat(sprintf("   Receitas:  R$ %s\n", format(fcdf_rec, big.mark = ".", decimal.mark = ",", nsmall = 2)))
  cat(sprintf("   Despesas:  R$ %s\n", format(fcdf_desp, big.mark = ".", decimal.mark = ",", nsmall = 2)))
  cat(sprintf("   Resultado: R$ %s\n\n", format(fcdf_res, big.mark = ".", decimal.mark = ",", nsmall = 2)))
}

cat(strrep("=", 70), "\n")
```

------------------------------------------------------------------------

## üìö Estrutura do Demonstrativo - Receitas

### Receitas RGPS

| Ordem | Item | Crit√©rio Principal |
|------------------------|------------------------|------------------------|
| 01 | Receitas Correntes - Empregadores, Trabalhadores | natureza 12100311-13, 1214\* |
| 02 | Receitas Correntes - Demais Contribui√ß√µes | origem = 2, exceto item 01 |
| 03 | Outras Receitas - Compensa√ß√£o RPPS/RGPS | origem = 9 |
| 04 | Demais Receitas Correntes | categoria = 1, exceto origens 2 e 9 |
| 05 | Receitas de Capital - Aliena√ß√µes | categoria = 2, origem = 2 |
| 06 | Demais Receitas de Capital | categoria = 2, exceto origem 2 |
| 07 | Receitas INTRA-OR√áAMENT√ÅRIAS | categoria = 7 ou 8 |

### Receitas RPPS (Civis)

| Ordem | Item | Crit√©rio Principal |
|------------------------|------------------------|------------------------|
| 01 | CIVIS - Segurados Ativo | natureza 12100421-24, 1215011*, 121503* |
| 02 | CIVIS - Segurados Inativos | natureza 12100431-34, 1215012\* |
| 03 | CIVIS - Segurados Pensionistas | natureza 12100441-44, 1215013\* |
| 04 | CIVIS - Patronal Ativo | natureza 12100411-14, 721502\* |
| 05 | CIVIS - Patronal Inativos/Pensionistas | natureza 72100441 |
| 06 | DRU - FCDF | fonte 000/00, natureza 12151\* |
| 07 | MILITARES - Segurados | natureza 12100511-13, 121911\* |

## üìö Estrutura do Demonstrativo - Despesas

### Despesas RGPS

| Ordem | Item                             | Crit√©rio Principal                 |
|---------------|----------------------------|------------------------------|
| 01    | Aposentadorias                   | elemento = 53, 54; grupo = 3       |
| 02    | Pens√µes                          | elemento = 55, 56; grupo = 3       |
| 03    | Outros Benef√≠cios                | elemento = 57, 58; grupo = 3       |
| 04    | Compensa√ß√£o RGPS para RPPS       | a√ß√£o = 009W, 0531; grupo = 3       |
| 05    | Demais Despesas                  | grupo = 3, exceto itens anteriores |
| 06    | A Detalhar                       | elemento = 00; grupo = 3           |
| 07    | Despesas Previdenci√°rias (INTRA) | modalidade = 91; grupo = 3         |

### Despesas RPPS

| Ordem | Item | Crit√©rio Principal |
|------------------------|------------------------|------------------------|
| 01 | CIVIS - A detalhar | subfun√ß√£o 272-274/845, grupo=1, elemento=00 |
| 02 | CIVIS - Aposentadorias | subfun√ß√£o 272-274/845, grupo=1, elemento=01 |
| 03 | CIVIS - Pens√µes | subfun√ß√£o 272-274/845, grupo=1, elemento=03 |
| 04 | CIVIS - Outros Benef√≠cios | subfun√ß√£o 272-274/845-846, grupo=1 |
| 05-11 | MILITARES | a√ß√µes 0179, 214H, 218K, 00QD, 00X3 |

------------------------------------------------------------------------

## üìñ Conceitos Importantes

### Resultado Previdenci√°rio

```         
RESULTADO PREVIDENCI√ÅRIO = RECEITAS PREVIDENCI√ÅRIAS - DESPESAS PREVIDENCI√ÅRIAS
```

Quando **negativo**, indica **d√©ficit previdenci√°rio** que deve ser coberto pelo Tesouro Nacional.

### Separa√ß√£o RGPS x RPPS

| Aspecto      | RGPS                   | RPPS                |
|--------------|------------------------|---------------------|
| P√∫blico      | Trabalhadores privados | Servidores p√∫blicos |
| Gest√£o       | INSS                   | Tesouro Nacional    |
| UO Principal | 33904                  | Diversas por √≥rg√£o  |
| Elementos    | 53-58                  | 01, 03              |
| Subfun√ß√£o    | 122 (INSS)             | 272, 273, 274       |

### C√≥digos de A√ß√µes Previdenci√°rias

| C√≥digo | Descri√ß√£o | Regime |
|----|----|----|
| 0053 | Pagamento de Aposentadorias e Pens√µes - Civis | RPPS Civil |
| 0181 | Pagamento de Pessoal Inativo - Civis | RPPS Civil |
| 0179 | Pagamento de Pens√µes Militares | RPPS Militar |
| 214H | Pagamento de Inativos das For√ßas Armadas | RPPS Militar |
| 218K | Pagamento de Inativos - Civis do MD | RPPS Militar |
| 00X3 | Compensa√ß√£o Financeira entre RPPSU e demais RPPS | RPPS |
| 009W | Compensa√ß√£o Previdenci√°ria RGPS/RPPS | RGPS |
| 00Q2, 00QN, 00NS | A√ß√µes FCDF | FCDF |

### Exclus√µes Importantes

| Item | Motivo |
|------------------------------------|------------------------------------|
| UO 73901 | Separado no FCDF |
| Fonte 054 | Contribui√ß√µes Sociais do RGPS - evitar duplicidade |
| Elementos 04, 07, 11, 13, 16, 39, 67, 96 | N√£o s√£o benef√≠cios previdenci√°rios |
| A√ß√£o 09HB | A√ß√£o n√£o previdenci√°ria |
| Fun√ß√£o 08, 10 | Assist√™ncia Social e Sa√∫de - n√£o √© previd√™ncia |

------------------------------------------------------------------------

## üì¶ Objetos Exportados

| Objeto | Descri√ß√£o |
|------------------------------------|------------------------------------|
| criterios_rreo_A04_rgps_receitas_rgps | Crit√©rios receitas RGPS |
| criterios_rreo_A04_rgps_despesas_rgps | Crit√©rios despesas RGPS |
| criterios_rreo_A04_rpps_receitas_civil_militar_rpps | Crit√©rios receitas RPPS |
| criterios_rreo_A04_rpps_despesas_civil_militar_rpps | Crit√©rios despesas RPPS |
| criterios_rreo_A04_rpps_receitas_fcdf | Crit√©rios receitas FCDF |
| criterios_rreo_A04_rpps_despesas_fcdf | Crit√©rios despesas FCDF |
| df_resultado_rgps | Resultado Previdenci√°rio RGPS |
| df_resultado_rpps_civil | Resultado RPPS Civis |
| df_resultado_rpps_militar | Resultado RPPS Militares |
| df_resultado_rpps | Resultado RPPS Total |
| df_resultado_fcdf | Resultado FCDF |

------------------------------------------------------------------------

## üìù Observa√ß√µes Adicionais

1.  **Per√≠odo de Apura√ß√£o**: O anexo apresenta valores do bimestre e acumulados no exerc√≠cio.

2.  **Proje√ß√£o Atuarial**: O RREO Anexo 14 apresenta a proje√ß√£o atuarial do RPPS para os pr√≥ximos 75 anos.

3.  **Meta Fiscal**: O resultado previdenci√°rio impacta diretamente o Resultado Prim√°rio da Uni√£o.

4.  **Passivo Atuarial**: O RGF Anexo 02 apresenta o passivo atuarial do RPPS e dos militares na DCL.

5.  **Receitas Intra-Or√ßament√°rias**: Categoria 7 ou 8 representam transfer√™ncias entre √≥rg√£os do mesmo ente.

# üìã RREO Anexo 06 (Resultado Prim√°rio)

## üìä Ficha T√©cnica

| Item | Descri√ß√£o |
|------------------------------------|------------------------------------|
| **Relat√≥rio** | RREO - Relat√≥rio Resumido da Execu√ß√£o Or√ßament√°ria |
| **Anexo** | Anexo 06 - Demonstrativo dos Resultados Prim√°rio e Nominal |
| **Base Legal** | LRF Art. 53, inciso III |
| **Periodicidade** | Bimestral |
| **Grau de Dificuldade** | Muito Dif√≠cil |

## üìÅ Arquivos Necess√°rios

| Objeto | Arquivo | Descri√ß√£o |
|------------------------|------------------------|------------------------|
| `dados_receita` | tg_receita\_\*.xlsx | Receitas or√ßament√°rias |
| `dados_categoria_grupo` | rreo_a06_despesas_primarias_categoria_grupo.xlsx | Despesas por categoria/grupo |
| `dados_ndd` | rreo_a06_despesas_primarias_ndd.xlsx | Despesas por natureza detalhada |
| `dados_despesa` | tg_despesa\_\*.xlsx | Despesas or√ßament√°rias (subs√≠dios CESEF) |
| `dados_juros` | rreo_a06_juros.xlsx | VPA/VPD de juros |
| `tg_RPN_disponibilidades` | tg_RPN_disponibilidades.xlsx | Disponibilidades financeiras |
| `dados_ajustes` | rreo_a06_ajustes.xlsx | VPA/VPD de ajustes patrimoniais |
| `comparativo` | comparativo.xlsx | Valores oficiais RTN para ajuste metodol√≥gico |

## Processamento Anexo 06

```{r criterio_anexo_06}

# ===============================================================================
# CRIT√âRIOS RREO ANEXO 6 - RESULTADO PRIM√ÅRIO (AJUSTADO)
# ===============================================================================

# ===============================================================================
# 1. RECEITAS PRIM√ÅRIAS (dados_receita)
# ===============================================================================
criterios_rreo_A06_receitas_A06 <- list(
  
  # RECEITAS CORRENTES (I) - Total
  `01  RECEITAS CORRENTES (I)` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    item_informacao_codigo == 5
    "
  ),
  
  # IMPOSTOS, TAXAS E CONTRIBUI√á√ïES DE MELHORIA (Subitem)
  `02  ___Impostos, Taxas e Contribui√ß√µes de Melhoria` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 1 & 
    item_informacao_codigo == 5
    "
  ),
  
  # CONTRIBUI√á√ïES (Subitem)
  `03  ___Contribui√ß√µes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 2 & 
    item_informacao_codigo == 5
    "
  ),
  
  # RECEITA PATRIMONIAL (Subitem)
  `04  ___Receita Patrimonial` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3 & 
    item_informacao_codigo == 5
    "
  ),
  
  # APLICA√á√ïES FINANCEIRAS (II) - DEDU√á√ÉO (Sub-subitem)
  `05  ______Aplica√ß√µes Financeiras (II)` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    (natureza_receita_codigo_completo %in% c('13210101', '13210201', '13210301', '13210501') |
     startsWith(natureza_receita_codigo_completo, '1321004') |
     startsWith(natureza_receita_codigo_completo, '1329001')) & 
    item_informacao_codigo == 5
    "
  ),
  
  # OUTRAS RECEITAS PATRIMONIAIS (Sub-subitem)
  `06  ______Outras Receitas Patrimoniais` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3 & 
    !(natureza_receita_codigo_completo %in% c('13210101', '13210201', '13210301', '13210501') |
      startsWith(natureza_receita_codigo_completo, '1321004') |
      startsWith(natureza_receita_codigo_completo, '1329001')) & 
    item_informacao_codigo == 5
    "
  ),
  
  # TRANSFER√äNCIAS CORRENTES (Subitem)
  `07  ___Transfer√™ncias Correntes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 7 & 
    item_informacao_codigo == 5
    "
  ),
  
  # DEMAIS RECEITAS CORRENTES (Subitem)
  `08  ___Demais Receitas Correntes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    (startsWith(natureza_receita_codigo_completo, '14') |
     startsWith(natureza_receita_codigo_completo, '15') |
     startsWith(natureza_receita_codigo_completo, '16') |
     startsWith(natureza_receita_codigo_completo, '18') |
     startsWith(natureza_receita_codigo_completo, '19')) & 
    item_informacao_codigo == 5
    "
  ),
  
  # OUTRAS RECEITAS FINANCEIRAS (III) - DEDU√á√ÉO (Sub-subitem)
  `09  ______Outras Receitas Financeiras (III)` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    (natureza_receita_codigo_completo %in% c('16410101', '16410102', '19991101', '19991102', '16410301') |
     startsWith(natureza_receita_codigo_completo, '1922012') |
     startsWith(natureza_receita_codigo_completo, '1990992')) & 
    item_informacao_codigo == 5
    "
  ),
  
  # RECEITAS CORRENTES RESTANTES (Sub-subitem)
  `10  ______Receitas Correntes Restantes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    (startsWith(natureza_receita_codigo_completo, '14') |
     startsWith(natureza_receita_codigo_completo, '15') |
     startsWith(natureza_receita_codigo_completo, '16') |
     startsWith(natureza_receita_codigo_completo, '18') |
     startsWith(natureza_receita_codigo_completo, '19')) & 
    !(natureza_receita_codigo_completo %in% c('16410101', '16410102', '19991101', '19991102', '16410301') |
      startsWith(natureza_receita_codigo_completo, '1922012') |
      startsWith(natureza_receita_codigo_completo, '1990992')) & 
    item_informacao_codigo == 5
    "
  ),
  
  # RECEITAS PRIM√ÅRIAS CORRENTES (IV) - F√ìRMULA
  `11  RECEITAS PRIM√ÅRIAS CORRENTES (IV) = (I - II - III)` = list(
    criterio = "{01 - 05 - 09}"
  ),
  
  # RECEITAS DE CAPITAL (V) - Total
  `12  RECEITAS DE CAPITAL (V)` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    item_informacao_codigo == 5
    "
  ),
  
  # OPERA√á√ïES DE CR√âDITO (VI) - DEDU√á√ÉO (Subitem)
  `13  ___Opera√ß√µes de Cr√©dito (VI)` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 1 & 
    item_informacao_codigo == 5
    "
  ),
  
  # AMORTIZA√á√ÉO DE EMPR√âSTIMOS (VII) - DEDU√á√ÉO (Subitem)
  `14  ___Amortiza√ß√£o de Empr√©stimos (VII)` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 3 & 
    item_informacao_codigo == 5
    "
  ),
  
  # ALIENA√á√ïES DE BENS (Subitem)
  `15  ___Aliena√ß√µes de Bens` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 2 & 
    item_informacao_codigo == 5
    "
  ),
  
  # RECEITAS DE ALIENA√á√ÉO DE INVESTIMENTOS PERMANENTES (IX) - Sub-subitem
  `16  ______Receitas de Aliena√ß√£o de Investimentos Permanentes (IX)` = list(
    criterio = "
    natureza_receita_codigo_completo == 22110011 & 
    item_informacao_codigo == 5
    "
  ),
  
  # OUTRAS ALIENA√á√ïES DE BENS (Sub-subitem)
  `17  ______Outras Aliena√ß√µes de Bens` = list(
    criterio = "
    natureza_receita_codigo_completo == '22110011' & 
    item_informacao_codigo == 5
    "
  ),
  
  # TRANSFER√äNCIAS DE CAPITAL (Subitem)
  `18  ___Transfer√™ncias de Capital` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 4 & 
    item_informacao_codigo == 5
    "
  ),
  
  # OUTRAS RECEITAS DE CAPITAL (Subitem)
  `19  ___Outras Receitas de Capital` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem %in% c(5, 6, 7, 8, 9) & 
    item_informacao_codigo == 5
    "
  ),
  
  # OUTRAS RECEITAS DE CAPITAL N√ÉO PRIM√ÅRIAS (X) - DEDU√á√ÉO (Sub-subitem)
  `20  ______Outras Receitas de Capital N√£o Prim√°rias (X)` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    (startsWith(natureza_receita_codigo_completo, '292') |
     startsWith(natureza_receita_codigo_completo, '293') |
     startsWith(natureza_receita_codigo_completo, '294')) & 
    item_informacao_codigo == 5
    "
  ),
  
  # RECEITAS PRIM√ÅRIAS DE CAPITAL (XI) - F√ìRMULA
  `21  RECEITAS PRIM√ÅRIAS DE CAPITAL (XI) = (V - VI - VII - IX - X)` = list(
    criterio = "{12 - 13 - 14 - 16 - 20}"
  ),
  
  # RECEITA PRIM√ÅRIA TOTAL (XII) - F√ìRMULA
  `22  RECEITA PRIM√ÅRIA TOTAL (XII) = (IV + XI)` = list(
    criterio = "{11 + 21}"
  )
)

# ===============================================================================
# 2. DESPESAS - CATEGORIA/GRUPO (dados_categoria_grupo)
# ===============================================================================
criterios_rreo_A06_despesas_categoria_grupo_A06 <- list(
  
  # DESPESAS CORRENTES (XIII)
  `23  DESPESAS CORRENTES (XIII)` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # PESSOAL E ENCARGOS SOCIAIS (Subitem)
  `24  ___Pessoal e Encargos Sociais` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 & 
    grupo_despesa_codigo_grupo == 1 & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # JUROS E ENCARGOS DA D√çVIDA (XIV) - DEDU√á√ÉO (Subitem)
  `25  ___Juros e Encargos da D√≠vida (XIV)` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 & 
    grupo_despesa_codigo_grupo == 2 & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # OUTRAS DESPESAS CORRENTES (Subitem)
  `26  ___Outras Despesas Correntes` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 & 
    grupo_despesa_codigo_grupo == 3 & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # DESPESAS PRIM√ÅRIAS CORRENTES (XV) - F√ìRMULA
  `27  DESPESAS PRIM√ÅRIAS CORRENTES (XV) = (XIII - XIV)` = list(
    criterio = "{23 - 25}"
  ),
  
  # DESPESAS DE CAPITAL (XVI)
  `28  DESPESAS DE CAPITAL (XVI)` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # INVESTIMENTOS (Subitem)
  `29  ___Investimentos` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 & 
    grupo_despesa_codigo_grupo == 4 & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # INVERS√ïES FINANCEIRAS (Subitem)
  `30  ___Invers√µes Financeiras` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 & 
    grupo_despesa_codigo_grupo == 5 & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # AMORTIZA√á√ÉO DA D√çVIDA (XX) - DEDU√á√ÉO (Subitem)
  `31  ___Amortiza√ß√£o da D√≠vida (XX)` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 & 
    grupo_despesa_codigo_grupo == 6 & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  )
)

# ===============================================================================
# 3. DESPESAS - NATUREZA DETALHADA (dados_ndd)
# ===============================================================================
criterios_rreo_A06_despesas_natureza_detalhada_A06 <- list(
  
  # TRANSFER√äNCIAS CONSTITUCIONAIS E LEGAIS
  `32  ______Transfer√™ncias Constitucionais e Legais` = list(
    criterio = "
    (startsWith(natureza_despesa_detalhada_codigo, '333081') | 
     startsWith(natureza_despesa_detalhada_codigo, '334081')) & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # DEMAIS DESPESAS CORRENTES - F√ìRMULA
  `33  ______Demais Despesas Correntes` = list(
    criterio = "{26 - 32}"
  ),
  
  # CONCESS√ÉO DE EMPR√âSTIMOS E FINANCIAMENTOS (XVII)
  `34  ______Concess√£o de Empr√©stimos e Financiamentos (XVII)` = list(
    criterio = "
    (natureza_despesa_detalhada_codigo %in% c('45909206', '45909208', '45909266') |
     (str_starts(natureza_despesa_detalhada_codigo, '45') & 
      elemento_despesa_codigo == '66')) & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # AQUISI√á√ÉO DE T√çTULOS DE CAPITAL J√Å INTEGRALIZADO (XVIII)
  `35  ______Aquisi√ß√£o de T√≠tulos de Capital j√° Integralizado (XVIII)` = list(
    criterio = "
    natureza_despesa_detalhada_codigo %in% c('45919206', '45919208') & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # DEMAIS INVERS√ïES FINANCEIRAS - F√ìRMULA
  `36  ______Demais Invers√µes Financeiras` = list(
    criterio = "{30 - 34 - 35}"
  ),
  
  # COTAS DOS FUNDOS GARANTIDORES
  `38  ______Cotas dos Fundos Garantidores (metodologia CESEF - prim√°rio)` = list(
    criterio = "
    natureza_despesa_detalhada_codigo == '45919266' & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  )
)

# ===============================================================================
# 4. DISPONIBILIDADES (tg_RPN_disponibilidades)
# ===============================================================================
criterios_rreo_A06_disponibilidades_A06 <- list(
  
  # DISPONIBILIDADES - RECURSOS A CLASSIFICAR
  `39  Disponibilidades - Recursos a Classificar` = list(
    criterio = "
    fonte_recursos_codigo %in% c('77', '490') & 
    orgao_uge_tipo_administracao_codigo != 7
    "
  ),
  
  # DISPONIBILIDADES - RECURSOS DIVERSOS
  `40  Disponibilidades - Recursos Diversos` = list(
    criterio = "
    fonte_recursos_codigo %in% c('90', '491') & 
    orgao_uge_tipo_administracao_codigo != 7
    "
  )
)

# ===============================================================================
# 5. JUROS ATIVOS E PASSIVOS (dados_juros)
# ===============================================================================
criterios_rreo_A06_juros_ativos_passivos_A06 <- list(
  
  # JUROS ATIVOS (XXV) - VPA Classe 4
  `41  Juros Ativos` = list(
    criterio = "
    substr(conta_contabil_numero, 1, 5) %in% c('44111', '44113', '44114', '44115', '44121', '44131', 
                                               '44133', '44134', '44135', '44141', '44211', '44213', 
                                               '44214', '44215', '44221') |
    conta_contabil_numero %in% c('445110100', '445210100')
    "
  ),
  
  # JUROS PASSIVOS (XXVI) - VPD Classe 3
  `42  Juros Passivos` = list(
    criterio = "
    substr(conta_contabil_numero, 1, 5) %in% c('34111', '34113', '34114', '34115', '34121', '34131', 
                                               '34141', '34181', '34183', '34184', '34185', '34191',
                                               '34211', '34213', '34214', '34215', '34221', '34291')
    "
  ),
  
  # FUNDOS - JUROS ATIVOS
  `43  Fundos - Juros Ativos` = list(
    criterio = "
    orgao_uge_tipo_administracao_codigo == '7' & 
    ug_executora_codigo != '380916' & 
    !orgao_uge_codigo %in% c('25915', '37904') &
    (substr(conta_contabil_numero, 1, 5) %in% c('44111', '44113', '44114', '44115', '44121', '44131', 
                                                '44133', '44134', '44135', '44141', '44211', '44213', 
                                                '44214', '44215', '44221') |
     conta_contabil_numero %in% c('445110100', '445210100'))
    "
  ),
  
  # FUNDOS - JUROS PASSIVOS
  `44  Fundos - Juros Passivos` = list(
    criterio = "
    orgao_uge_tipo_administracao_codigo == '7' & 
    ug_executora_codigo != '380916' & 
    !orgao_uge_codigo %in% c('25915', '37904') &
    substr(conta_contabil_numero, 1, 5) %in% c('34111', '34113', '34114', '34115', '34121', '34131', 
                                               '34141', '34181', '34183', '34184', '34185', '34191',
                                               '34211', '34213', '34214', '34215', '34221', '34291')
    "
  )
)

# ===============================================================================
# 6. SUBS√çDIOS CESEF (dados_despesa) - Item 37
# ===============================================================================
criterios_rreo_A06_subsidios_cesef <- list(
  
  `37  ______Subs√≠dios (metodologia CESEF - financeiro prim√°rio)` = list(
    criterio = "
    acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                              '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                              '20GI', '006C', '00ED', '00EE', '00SG')
    "
  
  )
)



# ===============================================================================
# 6.1 emprestimos (dados_ndd) - Item 38
# ===============================================================================
criterios_rreo_A06_emprestimos <- list(
  
  
  `38  ______Concess√£o de Empr√©stimos e Financiamentos` = list(
    criterio = "
    acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                              '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                              '20GI', '006C', '00ED', '00EE', '00SG') & (
    natureza_despesa_detalhada_codigo %in% c('45909206', '45909208', '45909266') |
    elemento_despesa_codigo == '66'
    )"
  )
)


# ===============================================================================
# 7. AJUSTES PARA O ANEXO 6 DO RREO (VPA/VPD de ajustes patrimoniais)
# ===============================================================================

criterios_rreo_A06_ajuste <- list(

  # VPD - VARIA√á√ïES MONET√ÅRIAS DA D√çVIDA CONTRATUAL
  `50 VPD - Varia√ß√µes Monet√°rias da D√≠vida Contratual` = list(
    criterio = "
    conta_contabil_numero %in% c('343110100', '343540100', '343550100')
    "
  ),

  # VPD - VARIA√á√ïES CAMBIAIS DA D√çVIDA CONTRATUAL
  `51 VPD - Varia√ß√µes Cambiais da D√≠vida Contratual` = list(
    criterio = "
    conta_contabil_numero == '343210200'
    "
  ),

  # VPD - VARIA√á√ïES MONET√ÅRIAS DA D√çVIDA MOBILI√ÅRIA
  `52 VPD - Varia√ß√µes Monet√°rias da D√≠vida Mobili√°ria` = list(
    criterio = "
    (conta_contabil_numero == '343310100' & ug_executora_codigo == '170600') |
    (conta_contabil_numero == '343340100' & ug_executora_codigo == '170512')
    "
  ),

  # VPD - VARIA√á√ïES CAMBIAIS DA D√çVIDA MOBILI√ÅRIA
  `53 VPD - Varia√ß√µes Cambiais da D√≠vida Mobili√°ria` = list(
    criterio = "
    conta_contabil_numero == '343410200' &
    ug_executora_codigo == '170600'
    "
  ),

  # VPD - ATUALIZA√á√ÉO MONET√ÅRIA NEGATIVA
  `54 VPD - Atualiza√ß√£o Monet√°ria Negativa` = list(
    criterio = "
    conta_contabil_numero %in% c('343910103', '343940103', '343950103') &
    ug_executora_codigo %in% c('170600', '170512', '380916', '170700')
    "
  ),

  # VPD - INCORPORA√á√ÉO DE PASSIVOS
  `55 VPD - Incorpora√ß√£o de Passivos` = list(
    criterio = "
    conta_contabil_numero %in% c('364010100', '364110100') &
    ug_executora_codigo %in% c('170600', '170512')
    "
  ),

  # VPD - RESULTADO NEGATIVO BACEN
  `56 VPD - Resultado Negativo BACEN` = list(
    criterio = "
    conta_contabil_numero == '348110100'
    "
  ),

  # VPD - CONSTITUI√á√ÉO DE SUBVEN√á√ïES ECON√îMICAS - COPEC
  `57 VPD - Constitui√ß√£o de Subven√ß√µes Econ√¥micas - COPEC` = list(
    criterio = "
    ug_executora_codigo == '170700' &
    conta_contabil_numero %in% c('395010100', '395110100') &
    evento_codigo == '541559'
    "
  ),

  # VPD - OUTRAS VARIA√á√ïES CAMBIAIS
  `58 VPD - Outras Varia√ß√µes Cambiais` = list(
    criterio = "
    conta_contabil_numero %in% c('343910200', '343940200', '343950200') &
    ug_executora_codigo %in% c('170512', '170700', '380916')
    "
  ),

  # VPD - DESINCORPORA√á√ÉO DE ATIVOS
  `59 VPD - Desincorpora√ß√£o de Ativos` = list(
    criterio = "
    conta_contabil_numero %in% c('365010100', '365040100', '365050100', 
                                 '365110100', '365140100', '365150100') &
    ug_executora_codigo %in% c('170512', '170700')
    "
  ),

  # VPD - REVERS√ÉO DE SUBVEN√á√ïES ECON√îMICAS - COPEC
  `60 VPD - Revers√£o de Subven√ß√µes Econ√¥micas - COPEC` = list(
    criterio = "
    conta_contabil_numero %in% c('395010100', '395110100') &
    evento_codigo == '541559' &
    ug_executora_codigo == '170700'
    "
  ),

  # VPD - VAR MONET E CAMBIAIS DE EMPREST e FINANC CONCEDIDOS
  `61 VPD - Var Monet e Cambiais de Emprest e Financ Concedidos` = list(
    criterio = "
    conta_contabil_numero %in% c('343510100', '343510200', '343540200', '343550200') &
    ug_executora_codigo %in% c('170512', '170526', '170600', '170700', '170705', '380916')
    "
  ),

  # VPA - VAR MONET E CAMBIAIS DE EMPREST e FINANC CONCEDIDOS
  `62 VPA - Var Monet e Cambiais de Emprest e Financ Concedidos` = list(
    criterio = "
    conta_contabil_numero %in% c('443110100', '443140100', '443150100', 
                                 '443310100', '443340100') &
    ug_executora_codigo %in% c('170512', '170526', '170600', '170700', '170705', '380916')
    "
  ),

  # VPA - ATUALIZA√á√ÉO MONET√ÅRIA POSITIVA
  `63 VPA - Atualiza√ß√£o Monet√°ria Positiva` = list(
    criterio = "
    conta_contabil_numero %in% c('443910101', '443940101', '443950101') &
    ug_executora_codigo %in% c('170512', '170526', '170600', '170700', '170705')
    "
  ),

  # VPA - OUTRAS VARIA√á√ïES MONET√ÅRIAS
  `64 VPA - Outras Varia√ß√µes Monet√°rias` = list(
    criterio = "
    conta_contabil_numero %in% c('443910100', '443940100', '443950100') &
    ug_executora_codigo %in% c('170512', '170526', '170600', '170700', '170705')
    "
  ),

  # VPA - OUTRAS VARIA√á√ïES CAMBIAIS
  `65 VPA - Outras Varia√ß√µes Cambiais` = list(
    criterio = "
    conta_contabil_numero %in% c('443910200', '443940200', '443950200') &
    ug_executora_codigo %in% c('120002', '170512', '170526', '170600', '170700', '170705')
    "
  ),

  # VPA - GANHOS COM DESINCORPORA√á√ÉO DE PASSIVOS
  `66 VPA - Ganhos com Desincorpora√ß√£o de Passivos` = list(
    criterio = "
    conta_contabil_numero %in% c('464010100', '464040100', '464050100',
                                 '464110100', '464140100', '464150100') &
    ug_executora_codigo == '170600'
    "
  ),

  # VPA - RESULTADO POSITIVO BACEN
  `67 VPA - Resultado Positivo BACEN` = list(
    criterio = "
    conta_contabil_numero == '448110100'
    "
  ),

  # VPA - OUTRAS VAR PATRIMONIAIS AUMENTATIVAS
  `68 VPA - Outras Varia√ß√µes Patrimoniais Aumentativas` = list(
    criterio = "
    conta_contabil_numero %in% c('449010100', '449040100', '449050100',
                                 '449110100', '449140100', '449150100') &
    ug_executora_codigo %in% c('170512', '170526', '170705')
    "
  ),

  # VPA - REMUNERA√á√ÉO DOS DEP√ìSITOS BANC√ÅRIOS
  `69 VPA - Remunera√ß√£o dos Dep√≥sitos Banc√°rios` = list(
    criterio = "
    conta_contabil_numero %in% c('445110100', '445210100') &
    (orgao_uge_tipo_administracao_codigo != '7' | ug_executora_codigo == '380916') &
    !(evento_codigo %in% c('581798', '586798'))
    "
  ),

  # VPA - REVERS√ÉO DE PROVIS√ïES E DE AJUSTES PARA PERDAS
  `70 VPA - Revers√£o de Provis√µes e de Ajustes para Perdas` = list(
    criterio = "
    conta_contabil_numero %in% c('497110100', '497140100', '497150100',
                                 '497210100', '497240100') &
    ug_executora_codigo %in% c('170512', '170526', '170700', '170705')
    "
  ),

  # VPA - OUTROS GANHOS COM INCORPORA√á√ÉO DE ATIVOS
  `71 VPA - Outros Ganhos com Incorpora√ß√£o de Ativos` = list(
    criterio = "
    conta_contabil_numero %in% c('463920100', '463940100') &
    ug_executora_codigo == '170512'
    "
  ),

  # (-) CR√âDITO EMPENHADO EM LIQUIDA√á√ÉO (EXCETO CODIV)
  `72 Cr√©dito Empenhado em Liquida√ß√£o (exceto CODIV)` = list(
    criterio = "
    conta_contabil_numero == '622130200' &
    ug_executora_codigo != '170600'
    "
  ),

  # APLICA√á√ïES FINANCEIRAS - FECHAMENTO C√ÇMBIO
  `73 Aplica√ß√µes Financeiras - Fechamento C√¢mbio` = list(
    criterio = "
    conta_contabil_numero == '111215100'
    "
  ),

  # JUROS E ENCARGOS PASSIVOS - OUTRAS VPD FINANCEIRAS
  `74 Juros e Encargos Passivos - Outras VPD Financeiras` = list(
    criterio = "
    conta_contabil_numero %in% c('349910100', '349940100', '349950100') &
    ug_executora_codigo %in% c('170500', '170512')
    "
  ),

  # PASSIVO D√çVIDA P√öBLICA REF FIES E MANTENEDORAS
  `75 Passivo D√≠vida P√∫blica REF FIES e Mantenedoras` = list(
    criterio = "
    conta_contabil_numero == '222110101' &
    evento_codigo == '591738'
    "
  ),

  # AJUSTES DE EXERC√çCIOS ANTERIORES
  `76 Ajustes de Exerc√≠cios Anteriores` = list(
    criterio = "
    conta_contabil_numero == '237110300' &
    ug_executora_codigo %in% c('170512', '170700')
    "
  ),

  # Constitui√ß√£o de Ajuste para Perdas
  `77 Constitui√ß√£o de Ajuste para Perdas` = list(
    criterio = "
    ((conta_contabil_numero %in% c('361710400', '361740400', '361750400')   &
    ug_executora_codigo %in% c('170512', '170526',  '170700', '170705'))  |
     (conta_contabil_numero %in% c('361740800', '361749800')   &
    ug_executora_codigo %in% c('170512')))
    "
  )
)
```

## üìä Processamento e Consolida√ß√£o

```{r processar_resultado_primario}
#| include: true

# =============================================================================
# CONSOLIDA√á√ÉO DOS CRIT√âRIOS RREO ANEXO 06
# =============================================================================

# Verificar objetos necess√°rios
objetos_necessarios <- c(
"dados_categoria_grupo", "dados_receita", "dados_ndd", "dados_despesa",
"dados_juros", "tg_RPN_disponibilidades", "dados_ajustes", "mes_filtro"
)

objetos_faltantes <- objetos_necessarios[!sapply(objetos_necessarios, exists)]

if (length(objetos_faltantes) > 0) {
warning(paste("Objetos necessarios nao encontrados:", paste(objetos_faltantes, collapse = ", ")))
rreo_a06_consolidado <- tibble(
  mes_lancamento = NA,
  categoria = "ERRO - Objetos n√£o encontrados",
  ordem = "00",
  valor = NA_real_
)
rreo_a06_final <- rreo_a06_consolidado
} else {
# Aplicar crit√©rios e consolidar em uma √∫nica opera√ß√£o
rreo_a06_consolidado <- bind_rows(
  aplicar_criterios(
    df = dados_categoria_grupo %>% filter(mes_lancamento == mes_filtro, item_informacao_codigo == "56"),
    criterios = criterios_rreo_A06_despesas_categoria_grupo_A06
  ),
  aplicar_criterios(
    df = dados_receita,
    criterios = criterios_rreo_A06_receitas_A06
  ),
  aplicar_criterios(
    df = dados_ndd %>% filter(item_informacao_codigo == "56", mes_lancamento == mes_filtro),
    criterios = criterios_rreo_A06_despesas_natureza_detalhada_A06
  ),
  # Item 37 - Subs√≠dios CESEF (fonte: dados_despesa)
  aplicar_criterios(
    df = dados_despesa %>% filter(mes_lancamento == mes_filtro, item_informacao_codigo == "56"),
    criterios = criterios_rreo_A06_subsidios_cesef
  ),
  aplicar_criterios(
    df = dados_juros,
    criterios = criterios_rreo_A06_juros_ativos_passivos_A06
  ),
  aplicar_criterios(
    df = tg_RPN_disponibilidades,
    criterios = criterios_rreo_A06_disponibilidades_A06
  ),
  aplicar_criterios(
    df = dados_ajustes,
    criterios = criterios_rreo_A06_ajuste
  ),
  # Item 38 - emprestimos (fonte: dados_ndd)
  aplicar_criterios(
    df = dados_ndd %>% filter(mes_lancamento == mes_filtro, item_informacao_codigo == "56"),
    criterios = criterios_rreo_A06_emprestimos
  )
)

# Agrupar por mes_lancamento, categoria e somar valores
rreo_a06_final <- rreo_a06_consolidado %>%
  group_by(mes_lancamento, categoria, ordem) %>%
  summarise(
    valor = sum(valor, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(mes_lancamento, categoria)
}

datatable(rreo_a06_final) %>%
formatRound(c("valor"), 2, mark = ".", dec.mark = ",")
```

## üìà C√°lculo do Resultado Prim√°rio e Nominal

```{r calculo-resultado-primario-nominal}
#| include: true

# ==============================================================================
# RREO ANEXO 6 - RESULTADO PRIM√ÅRIO E NOMINAL
# ==============================================================================
# Dados: rreo_a06_final (consolidado de todos os crit√©rios)
# Ajuste Metodol√≥gico: planilha comparativo.xlsx (RP_RTN) - RP_TG calculado
#
# F√ìRMULAS:
#   Receita Prim√°ria = Rec.Correntes - Aplica√ß√µes - Outras Fin. + Rec.Capital - Op.Cr√©d - Amort.Emp - Outras N√£o Prim
#   Despesa Prim√°ria = Desp.Correntes - Juros + Desp.Capital + Subs√≠dios - Amortiza√ß√£o - Concess√£o
#   RP TG = Receita Prim√°ria - Despesa Prim√°ria
#   Ajuste Metodol√≥gico = RP_RTN (linha 6 comparativo) - RP_TG
#   RP Final = RP TG + Ajuste Metodol√≥gico
#   Juros Ativos = Item 41 + Item 62 + Item 63 + Item 64
#   Juros Passivos = Item 42 + Item 50 + Item 52 + Item 54 + Item 61
#   RN = RP Final + Juros Ativos - Juros Passivos
# ==============================================================================

# Verificar se rreo_a06_final existe
if (!exists("rreo_a06_final")) {
warning("rreo_a06_final nao encontrado - criando objeto vazio")
rreo_a06_final <- tibble(
  mes_lancamento = NA,
  categoria = "ERRO",
  ordem = "00",
  valor = 0
)
}

# ------------------------------------------------------------------------------
# 1. FUN√á√ÉO AUXILIAR - Obter valor por c√≥digo da categoria
# ------------------------------------------------------------------------------
obter_valor <- function(codigo) {
if (!exists("rreo_a06_final")) return(0)
linha <- rreo_a06_final %>% 
  filter(str_detect(categoria, paste0("^", sprintf("%02d", codigo), " ")))
if (nrow(linha) == 0) return(0)
return(linha$valor[1])
}

# ------------------------------------------------------------------------------
# 2. RECEITAS PRIM√ÅRIAS
# ------------------------------------------------------------------------------
rec_correntes <- obter_valor(1)
aplicacoes_fin <- obter_valor(5)
outras_rec_fin <- obter_valor(9)
rec_capital <- obter_valor(12)
op_credito <- obter_valor(13)
amort_emprestimos <- obter_valor(14)
outras_rec_cap_nao_prim <- obter_valor(20)

receita_primaria_corrente <- rec_correntes - aplicacoes_fin - outras_rec_fin
receita_primaria_capital <- rec_capital - op_credito - amort_emprestimos - outras_rec_cap_nao_prim
receita_primaria_total <- receita_primaria_corrente + receita_primaria_capital

# ------------------------------------------------------------------------------
# 3. DESPESAS PRIM√ÅRIAS
# ------------------------------------------------------------------------------
desp_correntes <- obter_valor(23)
juros_divida <- obter_valor(25)
desp_capital <- obter_valor(28)
amort_divida <- obter_valor(31)
conc_emprestimos <- obter_valor(34)
subsidios_cesef <- obter_valor(37)

despesa_primaria_corrente <- desp_correntes - juros_divida
despesa_primaria_capital <- desp_capital + subsidios_cesef - amort_divida - conc_emprestimos
despesa_primaria_total <- despesa_primaria_corrente + despesa_primaria_capital

# ------------------------------------------------------------------------------
# 4. RESULTADO PRIM√ÅRIO TG (sem ajuste)
# ------------------------------------------------------------------------------
resultado_primario_tg <- receita_primaria_total - despesa_primaria_total

# ------------------------------------------------------------------------------
# 5. AJUSTE METODOL√ìGICO = RP_RTN - RP_TG
# ------------------------------------------------------------------------------
arquivo_comparativo <- str_c(mes_pasta, "comparativo.xlsx")

ajuste_metodologico <- tryCatch({
if (file.exists(arquivo_comparativo)) {
  mes_ref <- as.numeric(substr(mes_filtro, 5, 6))
  col_inicio <- 86  # CH = janeiro/2025
  col_fim <- col_inicio + mes_ref - 1
  
  # Linha 6: I. RESULTADO PRIM√ÅRIO - RTN
  rp_rtn_dados <- read_excel(
    arquivo_comparativo, 
    sheet = "Comparativo", 
    range = cellranger::cell_limits(c(6, col_inicio), c(6, col_fim)),
    col_names = FALSE
  )
  
  # Somar valores RTN (em milh√µes) e converter para unidades
  soma_rp_rtn <- sum(as.numeric(rp_rtn_dados), na.rm = TRUE) * 1000000
  
  # Ajuste = RP_RTN - RP_TG
  ajuste <- soma_rp_rtn - resultado_primario_tg
  ajuste
} else {
  warning(sprintf("Arquivo n√£o encontrado: %s\nUsando ajuste = 0", arquivo_comparativo))
  0
}
}, error = function(e) {
warning(sprintf("Erro ao ler comparativo: %s\nUsando ajuste = 0", e$message))
0
})

# ------------------------------------------------------------------------------
# 6. RESULTADO PRIM√ÅRIO FINAL
# ------------------------------------------------------------------------------
resultado_primario_final <- resultado_primario_tg + ajuste_metodologico

# ------------------------------------------------------------------------------
# 7. JUROS NOMINAIS
# ------------------------------------------------------------------------------
# Juros Ativos (XXV) = Item 41 + Item 62 + Item 63 + Item 64
# Juros Passivos (XXVI) = Item 42 + Item 50 + Item 52 + Item 54 + Item 61

item_41 <- obter_valor(41)  # Juros Ativos (base)
item_62 <- obter_valor(62)  # VPA - Var Monet Emprest Concedidos
item_63 <- obter_valor(63)  # VPA - Atualiza√ß√£o Monet√°ria Positiva
item_64 <- obter_valor(64)  # VPA - Outras Varia√ß√µes Monet√°rias

item_42 <- obter_valor(42)  # Juros Passivos (base)
item_50 <- obter_valor(50)  # VPD - Var Monet√°ria D√≠vida Contratual
item_52 <- obter_valor(52)  # VPD - Var Monet√°ria D√≠vida Mobili√°ria
item_54 <- obter_valor(54)  # VPD - Atualiza√ß√£o Monet√°ria Negativa
item_61 <- obter_valor(61)  # VPD - Var Monet Emprest Concedidos

juros_ativos <- item_41 + item_62 + item_63 + item_64
juros_passivos <- item_42 + item_50 + item_52 + item_54 + item_61

# ------------------------------------------------------------------------------
# 8. RESULTADO NOMINAL
# ------------------------------------------------------------------------------
resultado_nominal_final <- resultado_primario_final + juros_ativos - juros_passivos

# ------------------------------------------------------------------------------
# 9. TABELA RESUMO FINAL
# ------------------------------------------------------------------------------
resultado_final <- tibble(
componente = c(
  "RECEITAS PRIM√ÅRIAS",
  "  Receita Prim√°ria Corrente (I - II - III)",
  "  Receita Prim√°ria de Capital (V - VI - VII - X)",
  "  RECEITA PRIM√ÅRIA TOTAL (III)",
  "",
  "DESPESAS PRIM√ÅRIAS",
  "  Despesa Prim√°ria Corrente (XIII - XIV)",
  "  Despesa Prim√°ria de Capital (XVI + Subs√≠dios - XX - XVII)",
  "  DESPESA PRIM√ÅRIA TOTAL (VIII)",
  "",
  "RESULTADO PRIM√ÅRIO TG (III - VIII)",
  "(+) Ajuste Metodol√≥gico (RTN - TG)",
  "RESULTADO PRIM√ÅRIO FINAL (VI)",
  "",
  "JUROS NOMINAIS",
  "  Juros e Encargos Ativos (VII)",
  "    Item 41 - Juros Ativos (base)",
  "    Item 62 - VPA Var Monet Emprest Concedidos",
  "    Item 63 - VPA Atualiza√ß√£o Monet√°ria Positiva",
  "    Item 64 - VPA Outras Varia√ß√µes Monet√°rias",
  "  Juros e Encargos Passivos (VIII)",
  "    Item 42 - Juros Passivos (base)",
  "    Item 50 - VPD Var Monet√°ria D√≠vida Contratual",
  "    Item 52 - VPD Var Monet√°ria D√≠vida Mobili√°ria",
  "    Item 54 - VPD Atualiza√ß√£o Monet√°ria Negativa",
  "    Item 61 - VPD Var Monet Emprest Concedidos",
  "",
  "RESULTADO NOMINAL (IX) = VI + VII - VIII"
),
valor = c(
  NA,
  receita_primaria_corrente,
  receita_primaria_capital,
  receita_primaria_total,
  NA,
  NA,
  despesa_primaria_corrente,
  despesa_primaria_capital,
  despesa_primaria_total,
  NA,
  resultado_primario_tg,
  ajuste_metodologico,
  resultado_primario_final,
  NA,
  NA,
  juros_ativos,
  item_41,
  item_62,
  item_63,
  item_64,
  juros_passivos,
  item_42,
  item_50,
  item_52,
  item_54,
  item_61,
  NA,
  resultado_nominal_final
)
)

datatable(
resultado_final %>%
  mutate(
    valor_milhares = round(valor / 1000, 0),
    valor = ifelse(is.na(valor), "", format(round(valor, 0), big.mark = ".", decimal.mark = ",")),
    valor_milhares = ifelse(valor == "", "", format(valor_milhares, big.mark = ".", decimal.mark = ","))
  ),
caption = "RREO Anexo 6 - Resultado Prim√°rio e Nominal",
options = list(pageLength = 30, dom = 't',
  columnDefs = list(list(className = 'dt-right', targets = c(1, 2)))),
rownames = FALSE
) %>%
formatStyle('componente', fontWeight = styleEqual(
  c("  RECEITA PRIM√ÅRIA TOTAL (III)", "  DESPESA PRIM√ÅRIA TOTAL (VIII)", 
    "RESULTADO PRIM√ÅRIO FINAL (VI)", "  Juros e Encargos Ativos (VII)",
    "  Juros e Encargos Passivos (VIII)", "RESULTADO NOMINAL (IX) = VI + VII - VIII"),
  rep("bold", 6)
))

# ------------------------------------------------------------------------------
# 10. EXPORTAR VARI√ÅVEIS
# ------------------------------------------------------------------------------
valor_resultado_primario <- resultado_primario_final
valor_resultado_nominal <- resultado_nominal_final
valor_ajuste_metodologico <- ajuste_metodologico
valor_juros_ativos <- juros_ativos
valor_juros_passivos <- juros_passivos
```
## üìâ Resultado Abaixo da Linha

```{r resultado-abaixo-linha-v4}
#| include: true

# ==============================================================================
# RREO ANEXO 6 - RESULTADO NOMINAL E PRIM√ÅRIO ABAIXO DA LINHA
# ==============================================================================
# Replicando a aba "Anexo 6 RP e RN Novo (INTERNET)"
#
# ESTRUTURA:
#   D89 = TOTAL OUTROS AJUSTES (XVIII) sem discrep√¢ncia = -124.389.791
#   C120 = Discrep√¢ncia (da ELABORA√á√ÉO P140, sinal invertido)
#   C87 = D89 + C120 = OUTROS AJUSTES com discrep√¢ncia
#
# F√ìRMULAS:
#   C121 = C81 + C84 - C85 + C86 + C87
#   C123 = C121 - (Juros Ativos - Juros Passivos)
# ==============================================================================

# ------------------------------------------------------------------------------
# 1. VALORES DE REFER√äNCIA - DEZEMBRO/2024
# ------------------------------------------------------------------------------

valores_dez_2024 <- list(
  dcl = 7177279131000,           # DCL - D√≠vida Consolidada L√≠quida
  rp_processados = 129994061000, # RP Processados
  precatorios = 3997030000,      # Precat√≥rios na DCL
  aplic_fundos = 40841099221     # Aplica√ß√µes em Fundos Diversos
)

# ------------------------------------------------------------------------------
# 2. FUN√á√ïES AUXILIARES
# ------------------------------------------------------------------------------

fmt_milhar <- function(x) {
  sapply(x, function(val) {
    if (is.na(val) || is.null(val) || length(val) == 0) return("")
    format(round(val / 1000, 0), big.mark = ".", decimal.mark = ",")
  })
}

obter_valor_a06 <- function(cod) {
  if (!exists("rreo_a06_final")) return(0)
  linha <- rreo_a06_final %>% 
    filter(str_detect(categoria, paste0("^", sprintf("%02d", cod), "\\s")))
  if (nrow(linha) == 0) return(0)
  return(sum(linha$valor, na.rm = TRUE))
}

obter_valor_dcl <- function(ordens) {
  if (!exists("valores_linhas")) return(0)
  valores_linhas %>% 
    filter(ordem %in% ordens) %>% 
    summarise(v = sum(valor, na.rm = TRUE)) %>% 
    pull(v)
}

# ------------------------------------------------------------------------------
# 3. COMPONENTES PRINCIPAIS
# ------------------------------------------------------------------------------

# C81 - RN Bruto (varia√ß√£o DCL)
dcl_mes_atual <- if (exists("valor_dcl_num")) valor_dcl_num else 0
resultado_nominal_bruto <- valores_dez_2024$dcl - dcl_mes_atual

# C84 - Varia√ß√£o Saldo RP Processados
rp_processados_atual <- abs(obter_valor_dcl("25"))
variacao_saldo_rpp <- rp_processados_atual - valores_dez_2024$rp_processados

# C85 - Receita Aliena√ß√£o Investimentos (zero)
receita_alienacao <- 0

# C86 - Passivos Reconhecidos na DC
# F√≥rmula: A06 55 - A06 66 + DCL 10
# A06 55 = VPD Incorpora√ß√£o de Passivos (ordem 55)
# A06 66 = VPA Ganhos Desincorpora√ß√£o Passivos (ordem 66)
# DCL 10 = Passivos por Insufici√™ncia de Recursos (ordem 10)
passivos_a06_55 <- obter_valor_a06(55)
passivos_a06_66 <- obter_valor_a06(66)
passivos_dcl_10 <- obter_valor_dcl("10")
passivos_reconhecidos <- passivos_a06_55 - passivos_a06_66 + passivos_dcl_10

# ------------------------------------------------------------------------------
# 4. VPD - VARIA√á√ïES PATRIMONIAIS DIMINUTIVAS (publicadas)
# ------------------------------------------------------------------------------

vpd_cambiais_div_contratual <- obter_valor_a06(51)    # C90
vpd_cambiais_div_mobiliaria <- obter_valor_a06(53)    # C91
vpd_constituicao_ajuste_perdas <- obter_valor_a06(77) # C93
vpd_reversao_subvencoes_copec <- obter_valor_a06(60)  # C94
vpd_outras_var_cambiais <- obter_valor_a06(58)        # C95
vpd_desincorp_ativos <- obter_valor_a06(59)           # C96

total_vpd_ajuste <- vpd_cambiais_div_contratual + vpd_cambiais_div_mobiliaria +
                    vpd_constituicao_ajuste_perdas + vpd_reversao_subvencoes_copec +
                    vpd_outras_var_cambiais + vpd_desincorp_ativos  # C89

# ------------------------------------------------------------------------------
# 5. VPA - VARIA√á√ïES PATRIMONIAIS AUMENTATIVAS (publicadas)
# ------------------------------------------------------------------------------

vpa_outras_var_cambiais <- obter_valor_a06(65)   # C99
vpa_outras_vpa <- obter_valor_a06(68)            # C101
vpa_reversao_provisoes <- obter_valor_a06(70)    # C103
vpa_ganhos_incorp_ativos <- obter_valor_a06(71)  # C102

total_vpa_ajuste <- vpa_outras_var_cambiais + vpa_outras_vpa +
                    vpa_reversao_provisoes + vpa_ganhos_incorp_ativos  # C98

# ------------------------------------------------------------------------------
# 6. DEMAIS AJUSTES
# ------------------------------------------------------------------------------

# Varia√ß√£o Precat√≥rios (C107)
precatorios_atual <- obter_valor_dcl(c("08", "38"))
var_precatorios <- precatorios_atual - valores_dez_2024$precatorios

# Varia√ß√£o Aplica√ß√µes Fundos (C109)
aplic_fundos_saldo_atual <- obter_valor_dcl(c("14", "15", "16")) - obter_valor_dcl("13")
aplic_fundos_ordem_73 <- obter_valor_a06(73)
var_aplic_fundos <- (aplic_fundos_saldo_atual - valores_dez_2024$aplic_fundos) + aplic_fundos_ordem_73

# Juros Fundos L√≠quidos (C110)
juros_fundos_ativos <- obter_valor_a06(43)
juros_fundos_passivos <- obter_valor_a06(44)
juros_fundos_liquidos <- juros_fundos_ativos - juros_fundos_passivos

# FIES (C111)
divida_fies <- obter_valor_a06(75)

# Recursos a Classificar (C113)
recursos_classificar <- obter_valor_a06(39) + obter_valor_a06(40)

# Ajustes Exerc√≠cios Anteriores (C119)
ajustes_exerc_anteriores <- obter_valor_a06(76)

# Concess√£o Empr√©stimos (C114)
concessao_emprestimos_ajuste <- obter_valor_a06(38)

# Subtotal Demais Ajustes
demais_ajustes <- var_precatorios - var_aplic_fundos + juros_fundos_liquidos +
                  divida_fies - recursos_classificar - ajustes_exerc_anteriores -
                  concessao_emprestimos_ajuste

# ------------------------------------------------------------------------------
# 7. TOTAL OUTROS AJUSTES SEM DISCREP√ÇNCIA (D89)
# ------------------------------------------------------------------------------

outros_ajustes_total <- total_vpd_ajuste - total_vpa_ajuste + demais_ajustes  # D89

# ------------------------------------------------------------------------------
# 8. DISCREP√ÇNCIA METODOL√ìGICA (C120)
# ------------------------------------------------------------------------------
# C120 = Discrep√¢ncia Calculada + Ajuste Metodol√≥gico (do comparativo.xlsx)
#
# Parte 1: Discrep√¢ncia Calculada
#   = (P63 + P70 - P71) - P139
#   = (RP_Acima + Juros_Ativos - Juros_Passivos) - RN_Abaixo_sem_disc
#
# Parte 2: Ajuste Metodol√≥gico (j√° calculado anteriormente)
#   = RP_RTN - RP_TG (vari√°vel ajuste_metodologico)
# ------------------------------------------------------------------------------

# Obter valores
rp_acima_linha <- if (exists("resultado_primario_final")) resultado_primario_final else {
  if (exists("valor_resultado_primario")) valor_resultado_primario else 0
}

juros_ativos_calc <- if (exists("juros_ativos")) juros_ativos else 0
juros_passivos_calc <- if (exists("juros_passivos")) juros_passivos else 0
juros_liquidos <- juros_ativos_calc - juros_passivos_calc

# RN sem discrep√¢ncia
rn_sem_disc <- resultado_nominal_bruto + variacao_saldo_rpp - receita_alienacao +
               passivos_reconhecidos + outros_ajustes_total

# Parte 1: Discrep√¢ncia Calculada
discrepancia_calculada <- (rp_acima_linha + juros_ativos_calc - juros_passivos_calc) - rn_sem_disc

# Parte 2: Usar ajuste_metodologico j√° calculado do comparativo.xlsx
ajuste_metodologico_comparativo <- if (exists("ajuste_metodologico")) ajuste_metodologico else 0

# C120 = Discrep√¢ncia Calculada + Ajuste Metodol√≥gico
discrepancia_metodologica <- discrepancia_calculada - ajuste_metodologico_comparativo

# ------------------------------------------------------------------------------
# 9. OUTROS AJUSTES COM DISCREP√ÇNCIA (C87)
# ------------------------------------------------------------------------------

outros_ajustes_com_disc <- outros_ajustes_total + discrepancia_metodologica  # C87

# ------------------------------------------------------------------------------
# 10. RESULTADO NOMINAL AJUSTADO (C121)
# ------------------------------------------------------------------------------
# C121 = C81 + C84 - C85 + C86 + C87

resultado_nominal_ajustado <- resultado_nominal_bruto +   # C81
                              variacao_saldo_rpp -        # C84
                              receita_alienacao +         # C85
                              passivos_reconhecidos +     # C86
                              outros_ajustes_com_disc     # C87

# ------------------------------------------------------------------------------
# 11. RESULTADO PRIM√ÅRIO ABAIXO DA LINHA (C123)
# ------------------------------------------------------------------------------
# C123 = C121 - Juros L√≠quidos

resultado_primario_abaixo <- resultado_nominal_ajustado - juros_liquidos

# ------------------------------------------------------------------------------
# 12. COMPARA√á√ÉO
# ------------------------------------------------------------------------------

rn_acima_linha <- if (exists("resultado_nominal_final")) resultado_nominal_final else {
  if (exists("valor_resultado_nominal")) valor_resultado_nominal else 0
}

diferenca_rn <- rn_acima_linha - resultado_nominal_ajustado
diferenca_rp <- rp_acima_linha - resultado_primario_abaixo

# ------------------------------------------------------------------------------
# 13. EXPORTAR VARI√ÅVEIS
# ------------------------------------------------------------------------------

valor_outros_ajustes_sem_disc <- outros_ajustes_total        # D89
valor_discrepancia_calculada <- discrepancia_calculada       # Parte 1
valor_ajuste_comparativo <- ajuste_metodologico_comparativo * -1  # Parte 2
valor_discrepancia <- discrepancia_metodologica              # C120 = Parte1 + Parte2
valor_outros_ajustes <- outros_ajustes_com_disc              # C87
valor_rn_ajustado <- resultado_nominal_ajustado              # C121
valor_rp_abaixo <- resultado_primario_abaixo                 # C123
```

### Tabela: Detalhamento dos Outros Ajustes (XVIII)

```{r detalhamento-outros-ajustes-v4}
#| include: true

tabela_detalhamento <- tibble(
  componente = c(
    "OUTROS AJUSTES (XVIII) - DETALHAMENTO",
    "",
    "VPD - VARIA√á√ïES PATRIMONIAIS DIMINUTIVAS (+)",
    "  A06 51 - Var Cambiais D√≠vida Contratual",
    "  A06 53 - Var Cambiais D√≠vida Mobili√°ria",
    "  A06 77 - Constitui√ß√£o Ajuste para Perdas",
    "  A06 60 - Revers√£o Subven√ß√µes COPEC",
    "  A06 58 - Outras Varia√ß√µes Cambiais",
    "  A06 59 - Desincorpora√ß√£o de Ativos",
    "  Subtotal VPD",
    "",
    "VPA - VARIA√á√ïES PATRIMONIAIS AUMENTATIVAS (-)",
    "  A06 65 - Outras Varia√ß√µes Cambiais",
    "  A06 68 - Outras VPA",
    "  A06 70 - Revers√£o de Provis√µes",
    "  A06 71 - Ganhos Incorpora√ß√£o Ativos",
    "  Subtotal VPA",
    "",
    "DEMAIS AJUSTES",
    "  Varia√ß√£o Precat√≥rios (DCL 08+38)",
    "  (-) Varia√ß√£o Aplica√ß√µes Fundos",
    "      Saldo (DCL 14+15+16-13) - Dez/24",
    "      + A06 73 (Ajuste C√¢mbio)",
    "  Juros Fundos L√≠quidos (A06 43-44)",
    "  FIES (A06 75)",
    "  (-) Recursos a Classificar (A06 39+40)",
    "  (-) Ajustes Exerc Anteriores (A06 76)",
    "  (-) Concess√£o Empr√©stimos e Financ (A06 38)",
    "  Subtotal Demais Ajustes",
    "",
    "TOTAL OUTROS AJUSTES (XVIII)"
  ),
  valor = c(
    NA, NA,
    NA,
    vpd_cambiais_div_contratual,
    vpd_cambiais_div_mobiliaria,
    vpd_constituicao_ajuste_perdas,
    vpd_reversao_subvencoes_copec,
    vpd_outras_var_cambiais,
    vpd_desincorp_ativos,
    total_vpd_ajuste,
    NA,
    NA,
    vpa_outras_var_cambiais,
    vpa_outras_vpa,
    vpa_reversao_provisoes,
    vpa_ganhos_incorp_ativos,
    total_vpa_ajuste,
    NA,
    NA,
    var_precatorios,
    -var_aplic_fundos,
    aplic_fundos_saldo_atual - valores_dez_2024$aplic_fundos,
    aplic_fundos_ordem_73,
    juros_fundos_liquidos,
    divida_fies,
    -recursos_classificar,
    -ajustes_exerc_anteriores,
    -concessao_emprestimos_ajuste,
    demais_ajustes,
    NA,
    outros_ajustes_total
  )
)

tabela_detalhamento %>%
  mutate(valor_milhares = fmt_milhar(valor)) %>%
  select(componente, valor_milhares) %>%
  knitr::kable(col.names = c("Componente", "R$ milhares"), align = c("l", "r"),
               caption = "Detalhamento dos Outros Ajustes (XVIII)")
```

### Tabela: Resultado Nominal e Prim√°rio - Abaixo da Linha

```{r tabela-rn-rp-abaixo-v4}
#| include: true

tabela_resultado <- tibble(
  linha = c(
    "", "C81", "C84", "C85", "C86", "", "",
    "D89", "", "C120", "", "", "", "C87", "",
    "C121", "", "C123"
  ),
  componente = c(
    "C√ÅLCULO DO RESULTADO - ABAIXO DA LINHA",
    "RESULTADO NOMINAL BRUTO (XIV) - varia√ß√£o DCL",
    "(+) VARIA√á√ÉO SALDO RPP (XV)",
    "(-) RECEITA ALIENA√á√ÉO INVESTIMENTOS (XI)",
    "(+) PASSIVOS RECONHECIDOS NA DC (XVII)",
    "    A06 55 - A06 66 + DCL 10",
    "",
    "OUTROS AJUSTES sem discrep√¢ncia (XVIII)",
    "",
    "(+) Discrep√¢ncia Metodol√≥gica",
    "    Discrep√¢ncia Calculada",
    "    (+) Ajuste Metodol√≥gico Comparativo",
    "",
    "OUTROS AJUSTES com discrep√¢ncia (XVIII)",
    "",
    "RESULTADO NOMINAL AJUSTADO (XIX) = XIV+XV-XI+XVII+XVIII",
    "",
    "RESULTADO PRIM√ÅRIO (XXIII) = XXII - (X - XI)"
  ),
  valor = c(
    NA,
    resultado_nominal_bruto,
    variacao_saldo_rpp,
    -receita_alienacao,
    passivos_reconhecidos,
    NA,
    NA,
    outros_ajustes_total,
    NA,
    discrepancia_metodologica,
    discrepancia_calculada,
    ajuste_metodologico_comparativo,
    NA,
    outros_ajustes_com_disc,
    NA,
    resultado_nominal_ajustado,
    NA,
    resultado_primario_abaixo
  )
)

tabela_resultado %>%
  mutate(valor_milhares = fmt_milhar(valor)) %>%
  select(linha, componente, valor_milhares) %>%
  knitr::kable(col.names = c("Linha", "Componente", "R$ milhares"), 
               align = c("c", "l", "r"),
               caption = "Resultado Nominal e Prim√°rio - Abaixo da Linha")
```

### Tabela: Detalhamento da Discrep√¢ncia Metodol√≥gica (C120)

```{r detalhamento-discrepancia-v4}
#| include: true

tabela_discrepancia <- tibble(
  componente = c(
    "DISCREP√ÇNCIA METODOL√ìGICA (C120) - DETALHAMENTO",
    "",
    "PARTE 1: Discrep√¢ncia Calculada",
    "  P63 - RP Acima da Linha (XII)",
    "  P70 - Juros e Encargos Ativos (XXV)",
    "  P71 - Juros e Encargos Passivos (XXVI)",
    "  (P63 + P70 - P71)",
    "  P139 - RN Abaixo sem discrep√¢ncia",
    "  Discrep√¢ncia Calculada = (P63+P70-P71) - P139",
    "",
    "PARTE 2: Ajuste Metodol√≥gico (comparativo.xlsx)",
    "  ajuste_metodologico = RP_RTN - RP_TG",
    "",
    "TOTAL C120 = Parte 1 + Parte 2"
  ),
  valor = c(
    NA,
    NA,
    NA,
    rp_acima_linha,
    juros_ativos_calc,
    juros_passivos_calc,
    rp_acima_linha + juros_ativos_calc - juros_passivos_calc,
    rn_sem_disc,
    discrepancia_calculada,
    NA,
    NA,
    ajuste_metodologico_comparativo,
    NA,
    discrepancia_metodologica
  )
)

tabela_discrepancia %>%
  mutate(valor_milhares = fmt_milhar(valor)) %>%
  select(componente, valor_milhares) %>%
  knitr::kable(col.names = c("Componente", "R$ milhares"), align = c("l", "r"),
               caption = "Detalhamento da Discrep√¢ncia Metodol√≥gica (C120)")
```

### Tabela: Comparativo Acima x Abaixo da Linha

```{r comparativo-v4}
#| include: true

tabela_comparativo <- tibble(
  metrica = c(
    "RESULTADO PRIM√ÅRIO",
    "  Acima da Linha (XII)",
    "  Abaixo da Linha (XXIII)",
    "  Diferen√ßa",
    "",
    "RESULTADO NOMINAL",
    "  Acima da Linha (IX)",
    "  Abaixo da Linha (XIX)",
    "  Diferen√ßa",
    "",
    "JUROS NOMINAIS",
    "  (+) Juros Ativos (X)",
    "  (-) Juros Passivos (XI)",
    "  = Juros L√≠quidos",
    "",
    "PASSIVOS RECONHECIDOS (C86)",
    "  A06 55 (Incorp Passivos)",
    "  (-) A06 66 (Desincorp Passivos)",
    "  (+) DCL 10 (Passivos Insufici√™ncia)",
    "  = Total C86"
  ),
  valor = c(
    NA,
    rp_acima_linha,
    resultado_primario_abaixo,
    diferenca_rp,
    NA,
    NA,
    rn_acima_linha,
    resultado_nominal_ajustado,
    diferenca_rn,
    NA,
    NA,
    juros_ativos_calc,
    juros_passivos_calc,
    juros_liquidos,
    NA,
    NA,
    passivos_a06_55,
    -passivos_a06_66,
    passivos_dcl_10,
    passivos_reconhecidos
  )
)

tabela_comparativo %>%
  mutate(valor_milhares = fmt_milhar(valor)) %>%
  select(metrica, valor_milhares) %>%
  knitr::kable(col.names = c("M√©trica", "R$ milhares"), align = c("l", "r"),
               caption = "Comparativo Acima x Abaixo da Linha")
```



## F√≥rmulas Resumo

| Componente | F√≥rmula |
|------------------------------------|------------------------------------|
| **Resultado Nominal Bruto (XIV)** | DCL(Dez/2024) - DCL(M√™s Atual) |
| **Varia√ß√£o Saldo RPP (XV)** | RP_Proc(Atual) - RP_Proc(Dez/2024) |
| **Resultado Nominal Ajustado (XIX)** | XIV + XV - Aliena√ß√£o + Passivos DC + Outros Ajustes |
| **Resultado Prim√°rio Abaixo (XXIII)** | XIX - (Juros Ativos - Juros Passivos) |

## Observa√ß√µes

1.  **Valores de Dez/2024**: Podem ser informados manualmente ou lidos da planilha oficial
2.  **DCL M√™s Atual**: Calculada no RGF A02
3.  **Juros**: Calculados no chunk "acima da linha" (itens 41-44 e 50-61)
4.  **Discrep√¢ncia**: Diferen√ßa entre c√°lculo "acima" e "abaixo" da linha

## üìã Objetos Exportados

| Objeto | Descri√ß√£o |
|------------------------------------|------------------------------------|
| `criterios_rreo_A06_receitas_A06` | Crit√©rios para receitas prim√°rias |
| `criterios_rreo_A06_despesas_categoria_grupo_A06` | Crit√©rios para despesas por categoria/grupo |
| `criterios_rreo_A06_despesas_natureza_detalhada_A06` | Crit√©rios para despesas por natureza detalhada |
| `criterios_rreo_A06_disponibilidades_A06` | Crit√©rios para disponibilidades |
| `criterios_rreo_A06_juros_ativos_passivos_A06` | Crit√©rios para juros ativos e passivos |
| `criterios_rreo_A06_subsidios_cesef` | Crit√©rios para subs√≠dios CESEF |
| `criterios_rreo_A06_ajuste` | Crit√©rios para ajustes VPA/VPD |
| `rreo_a06_final` | Dados consolidados de todos os crit√©rios |
| `valor_resultado_primario` | Resultado prim√°rio final |
| `valor_resultado_nominal` | Resultado nominal final |
| `valor_rp_abaixo_linha` | Resultado prim√°rio abaixo da linha |
| `valor_rn_ajustado_abaixo` | Resultado nominal ajustado abaixo da linha |
| `valor_discrepancia` | Discrep√¢ncia entre acima e abaixo da linha |

# üìã RREO Anexo 07 - Restos a Pagar

## üìä Ficha T√©cnica

| Item | Descri√ß√£o |
|------------------------------------|------------------------------------|
| **Relat√≥rio** | RREO - Relat√≥rio Resumido da Execu√ß√£o Or√ßament√°ria |
| **Anexo** | Anexo 07 - Demonstrativo dos Restos a Pagar por Poder e √ìrg√£o |
| **Base Legal** | LRF Art. 53, inciso V |
| **Periodicidade** | Bimestral |
| **Grau de Dificuldade** | M√©dio |

## üìÅ Arquivos Necess√°rios

| Objeto              | Arquivo          | Descri√ß√£o                             |
|-------------------|------------------|-----------------------------------|
| `dados_rp_anexo_07` | rreo_a07_rp.xlsx | Restos a pagar por √≥rg√£o e modalidade |

## üìã Atributos Utilizados

| Atributo | Descri√ß√£o | Uso no Anexo |
|------------------------|------------------------|------------------------|
| `tipo_modalidade` | Tipo de modalidade | Intragovernamental / Exceto Intra |
| `orgao_uge_orgao_maximo_codigo` | C√≥digo do √≥rg√£o m√°ximo | Agrupamento por √≥rg√£o |
| `orgao_uge_orgao_maximo_nome` | Nome do √≥rg√£o m√°ximo | Descri√ß√£o do √≥rg√£o |
| `item_informacao_codigo` | Item de informa√ß√£o | Tipo de RP (processado/n√£o processado) |
| `item_informacao_nome` | Nome do item | Descri√ß√£o do tipo de RP |
| `mes_lancamento` | M√™s de lan√ßamento | Filtro do per√≠odo |
| `saldo_r_item_informacao` | Valor do saldo | Valor monet√°rio |

## üîó V√≠nculos com Outros Anexos

| Anexo    | V√≠nculo                               |
|----------|---------------------------------------|
| RREO A01 | Despesas or√ßament√°rias base           |
| RREO A06 | RP para c√°lculo do resultado prim√°rio |
| RGF A05  | Disponibilidades para cobertura de RP |

## üìê Estrutura do Demonstrativo

### Classifica√ß√£o dos Restos a Pagar

**Por Situa√ß√£o:** - **RP Processados**: Despesas empenhadas e liquidadas, pendentes de pagamento - **RP N√£o Processados**: Despesas empenhadas mas n√£o liquidadas

**Por Modalidade:** - **Intragovernamental**: Opera√ß√µes entre √≥rg√£os do mesmo ente - **Exceto Intragovernamental**: Demais opera√ß√µes

**Movimenta√ß√£o:** - Inscritos em Exerc√≠cios Anteriores - Inscritos em 31/12 do Exerc√≠cio Anterior - Pagos - Cancelados - Saldo

## üéØ Defini√ß√£o dos Agrupamentos

```{r agrupamentos_anexo_07}
#| echo: true
#| label: agrupamentos-anexo-07

# ==============================================================================
# DEFINI√á√ÉO DOS AGRUPAMENTOS PARA O ANEXO 07
# ==============================================================================

# Agrupamento por tipo de modalidade e √≥rg√£o
agrupado_despesa_tipo_modalidade_orgao <- c(
  "tipo_modalidade", 
  "orgao_uge_orgao_maximo_codigo", 
  "orgao_uge_orgao_maximo_nome"
)

# Agrupamento simplificado por √≥rg√£o
agrupado_despesa_orgao <- c(
  "orgao_uge_orgao_maximo_codigo", 
  "orgao_uge_orgao_maximo_nome"
)
```

## üìà Processamento dos Dados

### Tabela Principal - RP por Item de Informa√ß√£o

```{r tabela_anexo_07}
#| echo: true
#| label: tabela-principal-rp

# ==============================================================================
# RESTOS A PAGAR POR ITEM DE INFORMA√á√ÉO
# ==============================================================================
# Objetivo: Demonstrar a movimenta√ß√£o dos RP por tipo
# ==============================================================================

if (!exists("dados_rp_anexo_07")) {
  warning("dados_rp_anexo_07 nao encontrado")
  rp_por_item <- tibble(
    item_informacao_nome = NA,
    valor = NA_real_
  )
} else {
  # Verificar se mes_filtro existe
  if (!exists("mes_filtro")) {
    mes_filtro <- dados_rp_anexo_07 %>% 
      pull(mes_lancamento) %>% 
      unique() %>% 
      tail(1)
    message(sprintf("mes_filtro definido automaticamente: %s", mes_filtro))
  }
  
  # Agrupar RP por item de informa√ß√£o
  rp_por_item <- dados_rp_anexo_07 %>%
    filter(mes_lancamento == mes_filtro) %>%
    group_by(item_informacao_nome) %>%
    summarise(
      valor = sum(saldo_r_item_informacao, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    arrange(item_informacao_nome)
  
  # Exibir tabela
  datatable(
    rp_por_item,
    caption = paste("üìä Restos a Pagar por Item de Informa√ß√£o -", mes_filtro),
    options = list(dom = 't', pageLength = 20),
    rownames = FALSE
  ) %>%
    formatRound("valor", 2, mark = ".", dec.mark = ",")
}
```

# üìã RREO Anexo 08 - MDE (Manuten√ß√£o e Desenvolvimento do Ensino)

## üìä Ficha T√©cnica

| Item | Descri√ß√£o |
|----|----|
| **Relat√≥rio** | RREO - Relat√≥rio Resumido da Execu√ß√£o Or√ßament√°ria |
| **Anexo** | Anexo 08 - Demonstrativo das Receitas e Despesas com MDE |
| **Base Legal** | LRF Art. 52, ¬ß 2¬∫, inciso III; CF Art. 212 |
| **Periodicidade** | Bimestral |
| **Grau de Dificuldade** | Dif√≠cil |

## üìÅ Arquivos Necess√°rios

| Objeto | Arquivo | Descri√ß√£o |
|------------------------|------------------------|------------------------|
| `dados_receita` | tg_receita\_\*.xlsx | Receitas or√ßament√°rias (impostos) |
| `dados_despesa` | tg_despesa\_\*.xlsx | Despesas or√ßament√°rias com educa√ß√£o |
| `dados_rp_anexo_08` | rreo_a08_rp.xlsx | Restos a pagar de educa√ß√£o |

## üìã Atributos Utilizados

| Atributo | Descri√ß√£o | Uso no Anexo |
|------------------------|------------------------|------------------------|
| `natureza_receita_codigo_completo` | C√≥digo completo da natureza | Identificar impostos (111*, 711*) |
| `fonte_recursos_codigo` | C√≥digo da fonte de recursos | Identificar fontes MDE (000, 008, 035, 133, 134, 213, 242) |
| `iduso_codigo` | Identificador de uso | 8 = MDE |
| `acao_governo_codigo` | C√≥digo da a√ß√£o | 00SB, 0E36 = FUNDEB; 0312 = FCDF |
| `elemento_despesa_codigo` | Elemento de despesa | 01, 03, 59 = pessoal |
| `subfuncao_governo_codigo` | Subfun√ß√£o | 363, 364, 368 = ensino |
| `plano_orcamentario_codigo_po` | Plano or√ßament√°rio | 0001 = VAAF; 0002/0003 = VAAT |
| `lei_calmon_s_n` | Indicador Lei Calmon | SIM = MDE |

## üîó V√≠nculos com Outros Anexos

| Anexo    | V√≠nculo                                         |
|----------|-------------------------------------------------|
| RREO A01 | Receitas de impostos base para RLI              |
| RREO A02 | Despesas or√ßament√°rias base                     |
| RGF A01  | Despesa com pessoal inclui inativos da educa√ß√£o |

## üìê Estrutura do Demonstrativo

### Receitas Base para RLI

-   **Impostos**: Naturezas iniciando com 111 ou 711
-   **Transfer√™ncias Constitucionais**: FPE, FPM, IPI, FUNDEB, IOF, ITR

### Despesas MDE

1.  **Complementa√ß√£o da Uni√£o ao FUNDEB**: A√ß√µes 00SB, 0E36
2.  **Educa√ß√£o B√°sica**: Subfun√ß√£o 368, IDUSO 8
3.  **Ensino Superior**: Subfun√ß√£o 364, IDUSO 8
4.  **Ensino Profissional**: Subfun√ß√£o 363, IDUSO 8
5.  **Outras**: Demais subfun√ß√µes, IDUSO 8
6.  **Sal√°rio-Educa√ß√£o**: Fontes 133, 134, 213, 008, 035, 212
7.  **FCDF**: A√ß√£o 0312
8.  **Royalties Pr√©-Sal**: Fonte 242

## üéØ Defini√ß√£o dos Crit√©rios

```{r criterios_educacao}
#| echo: true

# ==============================================================================
# CRIT√âRIOS RREO ANEXO 08 - MDE (Manuten√ß√£o e Desenvolvimento do Ensino)
# ==============================================================================

criterios_rreo_A08_mde_despesas <- list(
  
  # COMPLEMENTA√á√ÉO DA UNI√ÉO AO FUNDEB
  `01 - COMPLEMENTA√á√ÉO DA UNI√ÉO AO FUNDEB` = list(
    criterio = "acao_governo_codigo %in% c('00SB', '0E36')"
  ),
  
  # EDUCA√á√ÉO B√ÅSICA
  `03 - EDUCA√á√ÉO B√ÅSICA` = list(
    criterio = "
    fonte_recursos_codigo %notin% c('008', '035', '133', '134', '213', '242') & 
    iduso_codigo == 8 & 
    elemento_despesa_codigo %notin% c('01', '03', '59') & 
    subfuncao_governo_codigo == '368'
    "
  ),
  
  # ENSINO SUPERIOR
  `04 - ENSINO SUPERIOR` = list(
    criterio = "
    fonte_recursos_codigo %notin% c('008', '035', '133', '134', '213', '242') & 
    iduso_codigo == 8 & 
    elemento_despesa_codigo %notin% c('01', '03', '59') & 
    subfuncao_governo_codigo %in% c('364')
    "
  ),
  
  # ENSINO PROFISSIONAL N√ÉO INTEGRADO AO ENSINO REGULAR
  `05 - ENSINO PROFISSIONAL N√ÉO INTEGRADO AO ENSINO REGULAR` = list(
    criterio = "
    fonte_recursos_codigo %notin% c('008', '035', '133', '134') & 
    iduso_codigo == 8 & 
    elemento_despesa_codigo %notin% c('01', '03', '59') & 
    subfuncao_governo_codigo == '363'
    "
  ),
  
  # OUTRAS DESPESAS MDE
  `06 - OUTRAS` = list(
    criterio = "
    fonte_recursos_codigo %notin% c('008', '035', '133', '134') & 
    iduso_codigo == 8 & 
    elemento_despesa_codigo %notin% c('01', '03', '59') & 
    !subfuncao_governo_codigo %in% c('363', '364', '368') & 
    acao_governo_codigo %notin% c('00SB', '0E36')
    "
  ),
  
  # COMPLEMENTA√á√ÉO DA UNI√ÉO - VAAF
  `08 - COMPLEMENTA√á√ÉO DA UNI√ÉO - VAAF` = list(
    criterio = "
    acao_governo_codigo %in% c('00SB', '0E36') & 
    plano_orcamentario_codigo_po == '0001'
    "
  ),
  
  # COMPLEMENTA√á√ÉO DA UNI√ÉO - VAAT
  `09 - COMPLEMENTA√á√ÉO DA UNI√ÉO - VAAT` = list(
    criterio = "
    acao_governo_codigo %in% c('00SB', '0E36') & 
    plano_orcamentario_codigo_po %in% c('0002') & 
    plano_orcamentario_codigo_po %in% c('0003', '0004') & 
    funcao_governo_codigo == '12' & 
    subfuncao_governo_codigo == '847' & 
    programa_governo_codigo == 5111 & 
    acao_governo_codigo == '00SB' & 
    unidade_orcamentaria_codigo == '26298'
    "
  ),
  
  # VAAT - PO 0003
  `09b - VAAT po 26298 12 847 5111 00SB 0003` = list(
    criterio = "
    fonte_recursos_codigo %notin% c('008') & 
    plano_orcamentario_codigo_po %in% c('0003') & 
    funcao_governo_codigo == '12' & 
    subfuncao_governo_codigo == '847' & 
    programa_governo_codigo == 5111 & 
    acao_governo_codigo == '00SB' & 
    unidade_orcamentaria_codigo == '26298'
    "
  ),
  
  # DESPESAS CUSTEADAS COM A CONTRIBUI√á√ÉO SOCIAL DO SAL√ÅRIO-EDUCA√á√ÉO
  `11 - DESPESAS CUSTEADAS COM A CONTRIBUI√á√ÉO SOCIAL DO SAL√ÅRIO-EDUCA√á√ÉO` = list(
    criterio = "
    fonte_recursos_codigo %in% c('133', '134', '213', '008', '035', '212') & 
    iduso_codigo == 8 & 
    acao_governo_codigo %notin% c('00SB', '0E36')
    "
  ),
  
  # DESPESAS COM O FUNDO CONSTITUCIONAL DO DISTRITO FEDERAL - FCDF
  `12 - DESPESAS COM O FUNDO CONSTITUCIONAL DO DISTRITO FEDERAL - FCDF` = list(
    criterio = "
    acao_governo_codigo %in% c('0312') & 
    fonte_recursos_codigo %notin% c('133', '134', '213', '008', '035', '212')
    "
  ),
  
  # DESPESAS CUSTEADAS COM RECEITAS DE ROYALTIES DE EXPLORA√á√ÉO DO PR√â-SAL
  `13 - DESPESAS CUSTEADAS COM RECEITAS DE ROYALTIES DE EXPLORA√á√ÉO DO PR√â-SAL` = list(
    criterio = "
    fonte_recursos_codigo %in% c('242') & 
    iduso_codigo == 8 & 
    elemento_despesa_codigo %in% c('01', '03', '59')
    "
  ),
  
  # DEMAIS DESPESAS COM EDUCA√á√ÉO
  `14 - DEMAIS DESPESAS COM EDUCA√á√ÉO` = list(
    criterio = "
    iduso_codigo == 8 & 
    fonte_recursos_codigo %in% c('008', '035', '133', '134', '213', '050', '000') & 
    elemento_despesa_codigo %in% c('01', '03', '59') & 
    acao_governo_codigo %notin% c('00SB', '0312', '0E36')
    "
  )
)
```

## üí∞ C√°lculo da Receita L√≠quida de Impostos (RLI)

### Receitas Base para RLI

```{r receitas_rli}
#| echo: true

# ==============================================================================
# RECEITAS QUE COMP√ïEM A BASE DA RLI (IMPOSTOS)
# ==============================================================================

# Verificar se dados_receita existe
if (!exists("dados_receita")) {
  warning("dados_receita nao encontrado")
  receitas_base_rli <- tibble(
    mes_lancamento = NA,
    receita = NA_real_
  )
} else {
  # Receitas de impostos (naturezas 111* e 711*)
  receitas_base_rli <- dados_receita %>% 
    filter(
      item_informacao_codigo == "5",
      startsWith(natureza_receita_codigo_completo, '711') | 
      startsWith(natureza_receita_codigo_completo, "111")
    ) %>% 
    group_by(mes_lancamento) %>% 
    summarise(
      receita = sum(saldo_r_item_informacao, na.rm = TRUE),
      .groups = "drop"
    )
}
```

### Transfer√™ncias Constitucionais

```{r transferencias_anexo_08}
#| echo: true

# ==============================================================================
# TRANSFER√äNCIAS CONSTITUCIONAIS - DEDU√á√ïES DA RLI
# ==============================================================================

if (!exists("dados_despesa")) {
  warning("dados_despesa nao encontrado")
  rli_transf <- tibble(
    transferencia = NA,
    mes_lancamento = NA,
    valor_transferencia = NA_real_
  )
} else {
  # Classificar transfer√™ncias constitucionais por a√ß√£o governamental
  rli_transf <- dados_despesa %>% 
    filter(item_informacao_codigo == "56") %>% 
    mutate(
      transferencia = case_when(
        acao_governo_codigo == "0044" ~ "FPE",
        acao_governo_codigo == "0045" ~ "FPM", 
        acao_governo_codigo == "0046" ~ "IPI_repasse",
        acao_governo_codigo == "0C33" ~ "FUNDEB",
        acao_governo_codigo == "00H6" ~ "IOF_repasse",
        acao_governo_codigo == "006M" ~ "ITR_repasse",
        .default = "demais"
      )
    ) %>% 
    group_by(transferencia, mes_lancamento) %>%  
    summarise(
      valor_transferencia = sum(saldo_r_item_informacao, na.rm = TRUE),
      .groups = "drop"
    )
  
  # Mostrar transfer√™ncias por tipo
  transferencias_resumo <- rli_transf %>%
    group_by(transferencia) %>%
    summarise(
      total = sum(valor_transferencia, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    arrange(desc(total))
    
  datatable(transferencias_resumo, caption = "Transfer√™ncias Constitucionais por Tipo") %>%
    formatRound("total", 2, mark = ".", dec.mark = ",")
}
```

### C√°lculo da RLI Mensal

```{r rli_mensal}
#| echo: true

# ==============================================================================
# C√ÅLCULO DA RLI MENSAL
# F√≥rmula: RLI = (Receita de Impostos - Transfer√™ncias Constitucionais) √ó 18%
# ==============================================================================

if (exists("receitas_base_rli") && exists("rli_transf")) {
  
  # Consolidar transfer√™ncias (exceto "demais")
  transferencias_consolidadas <- rli_transf %>% 
    filter(transferencia != "demais") %>% 
    group_by(mes_lancamento) %>% 
    summarise(
      transferencia_total = sum(valor_transferencia, na.rm = TRUE),
      .groups = "drop"
    )
  
  # Calcular RLI mensal
  rli_mensal <- full_join(
    receitas_base_rli, 
    transferencias_consolidadas, 
    by = "mes_lancamento"
  ) %>%
    mutate(
      transferencia_total = ifelse(is.na(transferencia_total), 0, transferencia_total),
      receita = ifelse(is.na(receita), 0, receita),
      rli = (receita - transferencia_total) * 0.18
    ) %>%
    # Ordenar por m√™s corretamente
    mutate(
      mes_ordenacao = case_when(
        str_detect(mes_lancamento, "JAN") ~ 1,
        str_detect(mes_lancamento, "FEV") ~ 2,
        str_detect(mes_lancamento, "MAR") ~ 3,
        str_detect(mes_lancamento, "ABR") ~ 4,
        str_detect(mes_lancamento, "MAI") ~ 5,
        str_detect(mes_lancamento, "JUN") ~ 6,
        str_detect(mes_lancamento, "JUL") ~ 7,
        str_detect(mes_lancamento, "AGO") ~ 8,
        str_detect(mes_lancamento, "SET") ~ 9,
        str_detect(mes_lancamento, "OUT") ~ 10,
        str_detect(mes_lancamento, "NOV") ~ 11,
        str_detect(mes_lancamento, "DEZ") ~ 12,
        TRUE ~ 99
      )
    ) %>%
    arrange(mes_ordenacao) %>%
    select(-mes_ordenacao)
  
  # Exibir RLI mensal
  DT::datatable(
    rli_mensal %>% 
      mutate(
        receita = format(round(receita, 2), big.mark = ".", decimal.mark = ","),
        transferencia_total = format(round(transferencia_total, 2), big.mark = ".", decimal.mark = ","),
        rli = format(round(rli, 2), big.mark = ".", decimal.mark = ",")
      ),
    colnames = c("M√™s", "Receita Base", "Transfer√™ncias", "RLI (18%)"),
    caption = "üìä Receita L√≠quida de Impostos (RLI) Mensal",
    rownames = FALSE,
    options = list(pageLength = 15, dom = 'ft')
  )
} else {
  cat("Dados n√£o dispon√≠veis para c√°lculo da RLI\n")
  rli_mensal <- tibble(mes_lancamento = NA, receita = 0, transferencia_total = 0, rli = 0)
}
```

## üéØ Aplica√ß√£o M√≠nima em MDE

### RLI do Per√≠odo de Refer√™ncia

```{r rli_periodo}
#| echo: true

# RLI espec√≠fica do m√™s de refer√™ncia
if (exists("rli_mensal") && exists("mes_filtro")) {
  rli_atual <- rli_mensal %>% 
    filter(mes_lancamento == mes_filtro) %>% 
    summarise(minimo_mde = sum(rli, na.rm = TRUE)) %>%
    pull(minimo_mde)
  
  cat(paste("üìÖ RLI para", mes_filtro, ":", 
            format(round(rli_atual, 2), big.mark = ".", decimal.mark = ",")))
} else {
  rli_atual <- 0
  cat("RLI n√£o calculada - dados n√£o dispon√≠veis\n")
}
```

### Despesas MDE do Per√≠odo

```{r despesas_mde}
#| echo: true

# Despesas MDE das categorias principais (03, 04, 05, 06)
if (exists("dados_despesa") && exists("mes_filtro")) {
  despesa_mde <- aplicar_criterios(
    dados_despesa %>% filter(item_informacao_codigo %in% c(25, 27)), 
    criterios_rreo_A08_mde_despesas
  ) %>% 
    filter(
      mes_lancamento == mes_filtro,
      ordem %in% c("03", "04", "05", "06")
    ) %>% 
    summarise(valor = sum(valor, na.rm = TRUE)) 
  
  cat(paste("üí∞ Despesas MDE Principais:", 
            format(round(despesa_mde$valor, 2), big.mark = ".", decimal.mark = ",")))
} else {
  despesa_mde <- tibble(valor = 0)
  cat("Despesas MDE n√£o calculadas - dados n√£o dispon√≠veis\n")
}
```

### Complementa√ß√£o FUNDEB

```{r complementacao_fundeb}
#| echo: true

# Complementa√ß√£o FUNDEB (100% da complementa√ß√£o da Uni√£o)
if (exists("dados_despesa") && exists("mes_filtro")) {
  complementacao_fundeb <- dados_despesa %>% 
    filter(
      item_informacao_codigo %in% c(25, 27), 
      mes_lancamento == mes_filtro,
      acao_governo_codigo %in% c('0E36', '00SB')
    ) %>% 
    summarise(comp_fundeb = sum(saldo_r_item_informacao, na.rm = TRUE)) %>%
    pull(comp_fundeb)
  
  cat(paste("üéØ Complementa√ß√£o FUNDEB (100%):", 
            format(round(complementacao_fundeb, 2), big.mark = ".", decimal.mark = ",")))
} else {
  complementacao_fundeb <- 0
  cat("Complementa√ß√£o FUNDEB n√£o calculada - dados n√£o dispon√≠veis\n")
}
```

### Restos a Pagar MDE

```{r rp_mde}
#| echo: true

# Restos a Pagar MDE
if (exists("dados_rp_anexo_08") && exists("mes_filtro")) {
  despesa_mde_rp_detalhado <- dados_rp_anexo_08 %>%
    filter(
      mes_lancamento == mes_filtro,  
      !elemento_despesa_codigo %in% c('01', '03'),
      (
        (fonte_recursos_codigo %in% c('000', '012', '00', '12') & 
         (iduso_codigo == 8 | lei_calmon_s_n == 'SIM')) |
        (ne_c_cor_ano_emissao >= 2020 & 
         !fonte_recursos_codigo %in% c('133', '134', '213', '08', '13', '93') & 
         iduso_codigo == 8)
      )
    ) %>%
    group_by(item_informacao_codigo, item_informacao_nome) %>%
    summarise(
      valor = sum(saldo_r_item_informacao, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    arrange(item_informacao_codigo)
  
  # Total consolidado para c√°lculos
  despesa_mde_rp <- sum(despesa_mde_rp_detalhado$valor, na.rm = TRUE)
  
  cat(paste("üìã Total RP MDE:", 
            format(round(despesa_mde_rp, 2), big.mark = ".", decimal.mark = ",")))
} else {
  despesa_mde_rp <- 0
  cat("RP MDE n√£o calculado - dados n√£o dispon√≠veis\n")
}
```

## üìä C√°lculo do Percentual de Aplica√ß√£o

```{r percentual_aplicacao}
#| echo: true

# ==============================================================================
# C√ÅLCULO DO PERCENTUAL DE APLICA√á√ÉO EM MDE
# M√≠nimo constitucional: 18% da RLI
# ==============================================================================

# C√°lculo do percentual total aplicado em MDE
total_despesas_mde <- as.numeric(despesa_mde$valor) + (complementacao_fundeb * 0.3)
percentual_aplicacao <- if(rli_atual > 0) {
  (total_despesas_mde / rli_atual) * 100
} else {
  0
}

# Tabela resumo
resumo_aplicacao <- tibble(
  Item = c(
    "üí∞ Despesas MDE Principais",
    "üéØ Complementa√ß√£o FUNDEB (100%)",
    "üìã Restos a Pagar MDE",
    "üìä Total Despesas MDE",
    "üìà 18% da RLI (Base de C√°lculo)",
    "üéØ Percentual Aplicado"
  ),
  Valor = c(
    format(round(as.numeric(despesa_mde$valor), 2), big.mark = ".", decimal.mark = ","),
    format(round(complementacao_fundeb, 2), big.mark = ".", decimal.mark = ","),
    format(round(despesa_mde_rp, 2), big.mark = ".", decimal.mark = ","),
    format(round(total_despesas_mde, 2), big.mark = ".", decimal.mark = ","),
    format(round(rli_atual, 2), big.mark = ".", decimal.mark = ","),
    paste0(round(percentual_aplicacao, 2), "%")
  ),
  Status = c(
    "‚úÖ Calculado",
    "‚úÖ Calculado", 
    "‚úÖ Calculado",
    "‚úÖ Consolidado",
    "‚úÖ Base",
    ifelse(percentual_aplicacao >= 100, "‚úÖ Atendido", "‚ùå N√£o Atendido")
  )
)

# Renderizar tabela
knitr::kable(resumo_aplicacao, 
      caption = "üéØ Resumo da Aplica√ß√£o em MDE",
      col.names = c("Item", "Valor", "Status"),
      align = c("l", "r", "c"))

# Resultado resumido
cat("\n")
cat(strrep("=", 70), "\n")
cat("RESULTADO FINAL - APLICA√á√ÉO EM MDE\n")
cat(strrep("=", 70), "\n")
cat(sprintf("Total de Despesas MDE: R$ %s\n", 
            format(round(total_despesas_mde, 2), big.mark = ".", decimal.mark = ",")))
cat(sprintf("18%% da RLI (Base): R$ %s\n", 
            format(round(rli_atual, 2), big.mark = ".", decimal.mark = ",")))
cat(sprintf("Percentual Aplicado: %.2f%%\n", percentual_aplicacao))
cat(sprintf("Situa√ß√£o: %s ao m√≠nimo constitucional\n", 
            ifelse(percentual_aplicacao >= 100, "‚úÖ ATENDE", "‚ùå N√ÉO ATENDE")))
cat(strrep("=", 70), "\n")

# Exportar vari√°veis
valor_rli_atual <- rli_atual
valor_despesa_mde <- as.numeric(despesa_mde$valor)
valor_complementacao_fundeb <- complementacao_fundeb
valor_total_mde <- total_despesas_mde
valor_percentual_mde <- percentual_aplicacao
```

## üìã Objetos Exportados

| Objeto | Descri√ß√£o |
|------------------------------------|------------------------------------|
| `criterios_rreo_A08_mde_despesas` | Crit√©rios para classifica√ß√£o das despesas MDE |
| `receitas_base_rli` | Receitas de impostos base para RLI |
| `rli_transf` | Transfer√™ncias constitucionais |
| `rli_mensal` | RLI mensal calculada |
| `valor_rli_atual` | RLI do per√≠odo de refer√™ncia |
| `valor_despesa_mde` | Despesas MDE principais |
| `valor_complementacao_fundeb` | Complementa√ß√£o FUNDEB |
| `valor_total_mde` | Total de despesas MDE |
| `valor_percentual_mde` | Percentual de aplica√ß√£o em MDE |

## üìå Observa√ß√µes Importantes

1.  **M√≠nimo Constitucional**: A Uni√£o deve aplicar no m√≠nimo 18% da RLI em MDE (Art. 212 CF)

2.  **Complementa√ß√£o FUNDEB**:

    -   VAAF (PO 0001): Valor Anual por Aluno do FUNDEB
    -   VAAT (PO 0002/0003): Valor Anual Total por Aluno do FUNDEB

3.  **Fontes Espec√≠ficas**:

    -   133/134/213: Sal√°rio-Educa√ß√£o
    -   242: Royalties Pr√©-Sal
    -   000/050: Recursos Ordin√°rios

4.  **Exclus√µes**:

    -   Elementos 01, 03, 59: Pessoal (n√£o computado na base principal)
    -   A√ß√µes 00SB, 0E36: FUNDEB (tratamento especial)

# üìã RREO Anexo 09 - Regra de Ouro

## üìä Ficha T√©cnica

| Item | Descri√ß√£o |
|------------------------------------|------------------------------------|
| **Relat√≥rio** | RREO - Relat√≥rio Resumido da Execu√ß√£o Or√ßament√°ria |
| **Anexo** | Anexo 09 - Demonstrativo das Receitas de Opera√ß√µes de Cr√©dito e Despesas de Capital |
| **Base Legal** | CF Art. 167, inciso III; LRF Art. 12, ¬ß 2¬∫ |
| **Periodicidade** | Bimestral |
| **Grau de Dificuldade** | M√©dio |

## üìÅ Arquivos Necess√°rios

| Objeto          | Arquivo                | Descri√ß√£o                        |
|------------------|-----------------------|--------------------------------|
| `dados_receita` | tg_receita\_\*.xlsx    | Receitas de opera√ß√µes de cr√©dito |
| `dados_despesa` | tg_despesa\_\*.xlsx    | Despesas de capital              |
| `balancete`     | rgf_a02_balancete.xlsx | Saldo da subconta da d√≠vida      |

## üìã Atributos Utilizados

| Atributo | Descri√ß√£o | Uso no Anexo |
|------------------------|------------------------|------------------------|
| `natureza_receita_codigo_completo` | C√≥digo da natureza | Identificar opera√ß√µes de cr√©dito (21*, 81*) |
| `categoria_economica_despesa_codigo` | Categoria da despesa | 4 = Capital |
| `conta_contabil_numero` | N√∫mero da conta cont√°bil | 111110401 = Subconta da d√≠vida |
| `item_informacao_codigo` | Item de informa√ß√£o | 5 = Receita realizada, 25 = Despesa liquidada |
| `mes_lancamento` | M√™s de lan√ßamento | Filtro do per√≠odo |
| `saldo_r_item_informacao` | Valor do saldo | Valor monet√°rio |
| `saldo_r_conta_contabil` | Saldo cont√°bil | Saldo da subconta |

## üîó V√≠nculos com Outros Anexos

| Anexo    | V√≠nculo                           |
|----------|-----------------------------------|
| RREO A01 | Receitas e despesas or√ßament√°rias |
| RREO A04 | Opera√ß√µes de cr√©dito detalhadas   |
| RGF A02  | D√≠vida consolidada l√≠quida        |

## üìê Estrutura do Demonstrativo

### Regra de Ouro Constitucional

A "Regra de Ouro" estabelece que as receitas de opera√ß√µes de cr√©dito n√£o podem exceder o montante das despesas de capital, ressalvadas as autorizadas mediante cr√©ditos suplementares ou especiais com finalidade precisa, aprovados pelo Poder Legislativo por maioria absoluta.

**F√≥rmula:**

```         
Regra de Ouro = Despesas de Capital - (Receitas de Op. Cr√©dito - Varia√ß√£o Subconta D√≠vida)

Se Regra de Ouro ‚â§ 0: CUMPRIDA
Se Regra de Ouro > 0: N√ÉO CUMPRIDA
```

### Componentes

1.  **Receitas de Opera√ß√µes de Cr√©dito (I)**: Naturezas 21\* e 81\*
2.  **Varia√ß√£o da Subconta da D√≠vida (II)**: Conta 111110401
3.  **Receitas L√≠quidas (III = I - II)**
4.  **Despesas de Capital (IV)**: Categoria econ√¥mica 4
5.  **Resultado (IV - III)**

## üéØ Par√¢metros Manuais

```{r parametros_regra_ouro}
#| echo: true
#| label: parametros-regra-ouro

# ==============================================================================
# PAR√ÇMETROS MANUAIS - AJUSTAR ANUALMENTE
# ==============================================================================

# Saldo inicial da subconta da d√≠vida (abertura do exerc√≠cio)
# Este valor deve ser atualizado no in√≠cio de cada exerc√≠cio
saldo_inicial_divida <- 731471695519.71  # Saldo abertura 2025 (000/2025)

cat(sprintf("üìÖ Saldo Inicial da Subconta da D√≠vida: R$ %s\n",
            format(round(saldo_inicial_divida, 2), big.mark = ".", decimal.mark = ",")))
```

## üìà Processamento dos Dados

### 1. Receitas de Opera√ß√µes de Cr√©dito

```{r receitas_op_credito}
#| echo: true
#| label: receitas-operacoes-credito

# ==============================================================================
# RECEITAS DE OPERA√á√ïES DE CR√âDITO
# ==============================================================================
# Filtro: Item Informa√ß√£o = 5 (Receita L√≠quida)
# Naturezas: 21* (Opera√ß√µes de Cr√©dito) e 81* (Op. Cr√©dito Intra)
# ==============================================================================

if (!exists("dados_receita")) {
  warning("dados_receita nao encontrado")
  receitas_op_credito <- 0
} else {
  # Verificar se mes_filtro existe
  if (!exists("mes_filtro")) {
    mes_filtro <- dados_receita %>% 
      pull(mes_lancamento) %>% 
      unique() %>% 
      tail(1)
    message(sprintf("mes_filtro definido automaticamente: %s", mes_filtro))
  }
  
  receitas_op_credito <- dados_receita %>%
    filter(
      mes_lancamento == mes_filtro,
      item_informacao_codigo == "5",
      str_starts(natureza_receita_codigo_completo, "21") | 
      str_starts(natureza_receita_codigo_completo, "81")
    ) %>%
    summarise(valor = sum(saldo_r_item_informacao, na.rm = TRUE)) %>%
    pull(valor)
  
  cat(sprintf("üí∞ Receitas de Opera√ß√µes de Cr√©dito (I): R$ %s\n",
              format(round(receitas_op_credito, 2), big.mark = ".", decimal.mark = ",")))
}
```

### 2. Despesas de Capital

```{r despesas_capital}
#| echo: true
#| label: despesas-capital

# ==============================================================================
# DESPESAS DE CAPITAL
# ==============================================================================
# Filtro: Categoria = 4 (Capital), Item Informa√ß√£o = 25 (Liquidadas)
# Nota: Inclui despesas liquidadas e inscritas em RP N√£o Processados
# ==============================================================================

#verificar se devemos utilizar item informacao 27

if (!exists("dados_despesa")) {
  warning("dados_despesa nao encontrado")
  despesas_capital <- 0
} else {
  despesas_capital <- dados_despesa %>%
    filter(
      mes_lancamento == mes_filtro,
      categoria_economica_despesa_codigo == "4",
      item_informacao_codigo %in% c(25, 27)
    ) %>%
    summarise(valor = sum(saldo_r_item_informacao, na.rm = TRUE)) %>%
    pull(valor)
  
  cat(sprintf("üí∏ Despesas de Capital (IV): R$ %s\n",
              format(round(despesas_capital, 2), big.mark = ".", decimal.mark = ",")))
}
```

### 3. Varia√ß√£o da Subconta da D√≠vida

```{r variacao_subconta}
#| echo: true
#| label: variacao-subconta-divida

# ==============================================================================
# VARIA√á√ÉO DA SUBCONTA DA D√çVIDA
# ==============================================================================
# Conta Cont√°bil: 111110401
# Varia√ß√£o = Saldo Atual - Saldo Inicial
# ==============================================================================

if (!exists("balancete")) {
  warning("balancete nao encontrado - usando rgf_a02_balancete se disponivel")
  
  if (exists("rgf_a02_balancete")) {
    balancete <- rgf_a02_balancete
  } else {
    saldo_atual_divida <- 0
    variacao_divida <- 0
    cat("‚ö†Ô∏è Dados do balancete n√£o dispon√≠veis\n")
  }
}

if (exists("balancete")) {
  saldo_atual_divida <- balancete %>%
    filter(
      conta_contabil_numero == "111110401",
      mes_lancamento == mes_filtro
    ) %>%
    summarise(valor = sum(saldo_r_conta_contabil, na.rm = TRUE)) %>%
    pull(valor)
  
  variacao_divida <- saldo_atual_divida - saldo_inicial_divida
  
  cat(sprintf("üìä Saldo Atual da Subconta: R$ %s\n",
              format(round(saldo_atual_divida, 2), big.mark = ".", decimal.mark = ",")))
  cat(sprintf("üìâ Varia√ß√£o da Subconta (II): R$ %s\n",
              format(round(variacao_divida, 2), big.mark = ".", decimal.mark = ",")))
}
```

### 4. C√°lculo da Regra de Ouro

```{r calculo_regra_ouro}
#| echo: true
#| label: calculo-regra-ouro

# ==============================================================================
# C√ÅLCULO DA REGRA DE OURO
# ==============================================================================
# F√≥rmula: Regra de Ouro = Despesas Capital - (Receitas Op. Cr√©dito - Varia√ß√£o Subconta)
# Se resultado > 0: N√ÉO CUMPRIDA
# Se resultado <= 0: CUMPRIDA
# ==============================================================================

# Calcular receitas l√≠quidas
receitas_liquidas <- receitas_op_credito - variacao_divida

# Calcular regra de ouro
regra_ouro <- despesas_capital - receitas_liquidas

# Determinar status
status_regra_ouro <- ifelse(regra_ouro > 0, "N√ÉO CUMPRIDA", "CUMPRIDA")

# Criar tabela de resultado
resultado_regra_ouro <- tibble(
  Componente = c(
    "Receitas de Opera√ß√µes de Cr√©dito (I)",
    "(-) Varia√ß√£o Subconta da D√≠vida (II)",
    "= Receitas L√≠quidas (III = I - II)",
    "Despesas de Capital (IV)",
    "REGRA DE OURO (IV - III)"
  ),
  Valor = c(
    receitas_op_credito,
    variacao_divida,
    receitas_liquidas,
    despesas_capital,
    regra_ouro
  )
)

# Exibir tabela
datatable(
  resultado_regra_ouro %>%
    mutate(Valor = format(round(Valor, 2), big.mark = ".", decimal.mark = ",")),
  caption = paste("üìä Regra de Ouro -", mes_filtro, "| Status:", status_regra_ouro),
  options = list(dom = 't', pageLength = 10),
  rownames = FALSE
)
```

## üìä Resultado Final

```{r resultado_final_regra_ouro}
#| echo: true
#| label: resultado-final

# ==============================================================================
# RESULTADO FINAL DA REGRA DE OURO
# ==============================================================================

cat("\n")
cat(strrep("=", 70), "\n")
cat("RESULTADO DA REGRA DE OURO\n")
cat(strrep("=", 70), "\n")
cat(sprintf("Per√≠odo de Refer√™ncia: %s\n", mes_filtro))
cat(strrep("-", 70), "\n")
cat(sprintf("Receitas de Opera√ß√µes de Cr√©dito (I):  R$ %s\n",
            format(round(receitas_op_credito, 2), big.mark = ".", decimal.mark = ",")))
cat(sprintf("(-) Varia√ß√£o Subconta da D√≠vida (II):  R$ %s\n",
            format(round(variacao_divida, 2), big.mark = ".", decimal.mark = ",")))
cat(sprintf("= Receitas L√≠quidas (III):             R$ %s\n",
            format(round(receitas_liquidas, 2), big.mark = ".", decimal.mark = ",")))
cat(strrep("-", 70), "\n")
cat(sprintf("Despesas de Capital (IV):              R$ %s\n",
            format(round(despesas_capital, 2), big.mark = ".", decimal.mark = ",")))
cat(strrep("-", 70), "\n")
cat(sprintf("REGRA DE OURO (IV - III):              R$ %s\n",
            format(round(regra_ouro, 2), big.mark = ".", decimal.mark = ",")))
cat(strrep("=", 70), "\n")
cat(sprintf("STATUS: %s %s\n",
            ifelse(status_regra_ouro == "CUMPRIDA", "‚úÖ", "‚ùå"),
            status_regra_ouro))
cat(strrep("=", 70), "\n")

# Exportar vari√°veis
valor_receitas_op_credito <- receitas_op_credito
valor_despesas_capital <- despesas_capital
valor_variacao_subconta <- variacao_divida
valor_regra_ouro <- regra_ouro
```

## üìã Objetos Exportados

| Objeto                 | Descri√ß√£o                        |
|------------------------|----------------------------------|
| `saldo_inicial_divida` | Saldo de abertura da subconta    |
| `receitas_op_credito`  | Receitas de opera√ß√µes de cr√©dito |
| `despesas_capital`     | Despesas de capital liquidadas   |
| `saldo_atual_divida`   | Saldo atual da subconta          |
| `variacao_divida`      | Varia√ß√£o da subconta             |
| `receitas_liquidas`    | Receitas menos varia√ß√£o          |
| `regra_ouro`           | Resultado do c√°lculo             |
| `status_regra_ouro`    | CUMPRIDA ou N√ÉO CUMPRIDA         |
| `resultado_regra_ouro` | Tabela resumo                    |

## üìå Observa√ß√µes Importantes

1.  **Base Constitucional**: Art. 167, III da CF/88 - veda√ß√£o de opera√ß√µes de cr√©dito que excedam despesas de capital

2.  **Exce√ß√µes**:

    -   Cr√©ditos suplementares ou especiais
    -   Aprovados por maioria absoluta
    -   Com finalidade precisa

3.  **Subconta da D√≠vida (111110401)**:

    -   Registra recursos vinculados ao refinanciamento
    -   Varia√ß√£o positiva = aumento de recursos
    -   Varia√ß√£o negativa = utiliza√ß√£o de recursos

4.  **Naturezas de Receita**:

    -   21\*: Opera√ß√µes de Cr√©dito Internas e Externas
    -   81\*: Opera√ß√µes de Cr√©dito Intraor√ßament√°rias

5.  **Atualiza√ß√£o Anual**:

    -   O saldo inicial da subconta deve ser atualizado no in√≠cio de cada exerc√≠cio
    -   Valor obtido do balancete de abertura (000/AAAA)

# üìã RREO Anexo 11 - Aliena√ß√£o de Ativos.

# üìã RREO Anexo 12 - Sa√∫de.

## üìã Introdu√ß√£o

O **Anexo 12 do RREO** apresenta o demonstrativo das receitas e despesas com a√ß√µes e servi√ßos p√∫blicos de sa√∫de do Governo Federal, conforme estabelecido pela Emenda Constitucional n¬∫ 29/2000 e regulamentado pela Lei Complementar n¬∫ 141/2012.

Este relat√≥rio consolida informa√ß√µes sobre: - **Despesas Computadas**: Aplica√ß√µes diretas e transfer√™ncias nas subfun√ß√µes espec√≠ficas de sa√∫de - **Despesas N√£o Computadas**: Despesas do Minist√©rio da Sa√∫de n√£o computadas para o limite constitucional - **An√°lise por Modalidade**: Separa√ß√£o entre aplica√ß√£o direta e transfer√™ncias - **Indicadores de Cumprimento**: Verifica√ß√£o do atendimento aos limites constitucionais

## üè• Processamento das Despesas com Sa√∫de

### 1. Despesas Computadas - Subfun√ß√µes Espec√≠ficas

```{r despesas-saude-especificas}

#| include: false
# Filtrar despesas das subfun√ß√µes espec√≠ficas de sa√∫de (301-306)
despesas_saude <- dados_despesa %>% 
  filter(
    mes_lancamento == mes_filtro, 
    iduso_codigo == 6, 
    item_informacao_codigo %in% c(25, 27), 
    subfuncao_governo_codigo %in% c(301, 302, 303, 304, 305, 306)
  ) %>% 
  group_by(
    subfuncao_governo_codigo, 
    subfuncao_governo_nome, 
    categoria_economica_despesa_codigo,
    categoria_economica_despesa_nome, 
    modalidade_aplicacao_codigo
  ) %>% 
  summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao), .groups = "drop")

# Classificar por tipo de aplica√ß√£o
despesas_saude <- despesas_saude %>% 
  mutate(
    transferencia = ifelse(
      modalidade_aplicacao_codigo %in% c('30', '31', '32', '35', '36', '40', '41', '42', '45', '46'), 
      "_transferencia", 
      "aplicacao_direta"
    )
  )

# Criar tabela consolidada INCLUINDO LINHAS COM ZERO
tabela_saude_especificas <- despesas_saude %>% 
  group_by(
    subfuncao_governo_codigo, 
    subfuncao_governo_nome,
    categoria_economica_despesa_codigo, 
    categoria_economica_despesa_nome, 
    transferencia
  ) %>% 
  summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao), .groups = "drop") %>%
  # MANTER TODAS AS LINHAS, incluindo as com valor zero
  filter(TRUE)  # N√£o filtrar valores zero

# Exibir tabela
# DT::datatable(
#   tabela_saude_especificas,
#   caption = "Despesas com Sa√∫de - Subfun√ß√µes Espec√≠ficas (301-306) - Incluindo Valores Zero",
#   options = list(
#     pageLength = 20,  # Aumentar para mostrar mais linhas
#     scrollX = TRUE,
#     language = list(url = '//cdn.datatables.net/plug-ins/1.10.11/i18n/Portuguese-Brasil.json')
#   )
# ) %>%
#   DT::formatRound("saldo_r_item_informacao", 2, mark = ".", dec.mark = ",")

# Calcular total das subfun√ß√µes espec√≠ficas
total_subfuncoes_especificas <- sum(despesas_saude$saldo_r_item_informacao)
cat("\nüí∞ **Total das Subfun√ß√µes Espec√≠ficas de Sa√∫de:** R$", 
    format(total_subfuncoes_especificas, big.mark = ".", decimal.mark = ","), "\n")
```

### 2. Despesas em Outras Subfun√ß√µes (Demais)

```{r despesas-saude-demais}

#| include: false
# Calcular despesas em outras subfun√ß√µes
despesas_saude_demais <- as.numeric(
  dados_despesa %>% 
  filter(
    mes_lancamento == mes_filtro, 
    iduso_codigo == 6, 
    item_informacao_codigo %in% c(25, 27), 
    subfuncao_governo_codigo %notin% c(301, 302, 303, 304, 305, 306)
  ) %>% 
  summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao))
)

cat("üí∞ **Total das Demais Subfun√ß√µes de Sa√∫de:** R$", 
    format(despesas_saude_demais, big.mark = ".", decimal.mark = ","), "\n")

# Total geral das despesas computadas
total_despesas_computadas <- total_subfuncoes_especificas + despesas_saude_demais
cat("üí∞ **Total Geral das Despesas Computadas:** R$", 
    format(total_despesas_computadas, big.mark = ".", decimal.mark = ","), "\n\n")
```

### 3. An√°lise Consolidada de Todas as Despesas

```{r despesas-saude-consolidada}

#| include: false
# Processar todas as despesas de sa√∫de com agrupamento
despesas_saude_completa <- dados_despesa %>% 
  filter(
    mes_lancamento == mes_filtro, 
    iduso_codigo == 6, 
    item_informacao_codigo %in% c( 25, 27)
  ) %>% 
  group_by(
    subfuncao_governo_codigo, 
    subfuncao_governo_nome, 
    categoria_economica_despesa_codigo,
    categoria_economica_despesa_nome, 
    modalidade_aplicacao_codigo
  ) %>% 
  summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao), .groups = "drop")

# Reclassificar subfun√ß√µes e modalidades
despesas_saude_completa <- despesas_saude_completa %>% 
  mutate(
    subfuncao_governo_codigo = case_when(
      subfuncao_governo_codigo %in% c(301, 302, 303, 304, 305, 306) ~ as.character(subfuncao_governo_codigo),
      TRUE ~ "demais"
    ),
    subfuncao_governo_nome = case_when(
      subfuncao_governo_codigo %in% c("301", "302", "303", "304", "305", "306") ~ subfuncao_governo_nome,
      TRUE ~ "demais"
    ),
    transferencia = ifelse(
      modalidade_aplicacao_codigo %in% c('30', '31', '32', '35', '36', '40', '41', '42', '45', '46'), 
      "_transferencia", 
      "aplicacao_direta"
    )
  )

# Criar tabela consolidada final INCLUINDO VALORES ZERO
tabela_consolidada <- despesas_saude_completa %>% 
  group_by(
    subfuncao_governo_codigo, 
    subfuncao_governo_nome,
    categoria_economica_despesa_codigo, 
    categoria_economica_despesa_nome, 
    transferencia
  ) %>% 
  summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao), .groups = "drop") %>%
  # MANTER TODAS AS LINHAS, incluindo as com valor zero
  arrange(subfuncao_governo_codigo, categoria_economica_despesa_codigo, transferencia)

# Exibir tabela consolidada
# DT::datatable(
#   tabela_consolidada %>% adorn_totals(),
#   caption = "Despesas com Sa√∫de - An√°lise Consolidada (Incluindo Valores Zero)",
#   options = list(
#     pageLength = 25,  # Aumentar para mostrar mais linhas
#     scrollX = TRUE,
#     language = list(url = '//cdn.datatables.net/plug-ins/1.10.11/i18n/Portuguese-Brasil.json')
#   )
# ) %>%
#   DT::formatRound("saldo_r_item_informacao", 2, mark = ".", dec.mark = ",")

# Total consolidado em milhares
total_consolidado <- sum(despesas_saude_completa$saldo_r_item_informacao) / 1000
cat("\nüí∞ **Total Consolidado das Despesas com Sa√∫de:** R$", 
    format(total_consolidado, big.mark = ".", decimal.mark = ","), "mil\n")

cat("\nüí∞ **cumprimento do m√≠nimo:** ", 
    format(total_consolidado*1000/minimo_saude*100, big.mark = ".", decimal.mark = ","), "%\n")


# filter(fonte_recursos_codigo %notin% c(448,449), grupo_despesa_codigo_grupo %notin% c(2,6), acao_governo_codigo %notin% c('0181', '2004', '20YS'), modalidade_aplicacao_codigo %in% c(35, 45, 73, 78)) %>% summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao))

```

## üö´ Despesas N√£o Computadas

### Despesas do Minist√©rio da Sa√∫de N√£o Computadas

```{r despesas-nao-computadas}

#| include: false
# Filtrar despesas n√£o computadas do Minist√©rio da Sa√∫de
despesa_saude_nao_computadas <- dados_despesa %>% 
  filter(
    mes_lancamento == mes_filtro, 
    iduso_codigo != 6, 
    item_informacao_codigo %in% c(25, 27),
    uo_orgao_superior_codigo == "36000", 
    unidade_orcamentaria_codigo != "74202"
  ) %>% 
  group_by(
    subfuncao_governo_codigo, 
    subfuncao_governo_nome, 
    categoria_economica_despesa_codigo,
    categoria_economica_despesa_nome, 
    modalidade_aplicacao_codigo
  ) %>%  
  summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao), .groups = "drop")

# Reclassificar para an√°lise
despesa_saude_nao_computadas <- despesa_saude_nao_computadas %>% 
  mutate(
    subfuncao_governo_codigo = case_when(
      subfuncao_governo_codigo %in% c(301, 302, 303, 304, 305, 306) ~ as.character(subfuncao_governo_codigo),
      TRUE ~ "demais"
    ),
    subfuncao_governo_nome = case_when(
      subfuncao_governo_codigo %in% c("301", "302", "303", "304", "305", "306") ~ subfuncao_governo_nome,
      TRUE ~ "demais"
    ),
    transferencia = ifelse(
      modalidade_aplicacao_codigo %in% c('30', '31', '32', '35', '36', '40', '41', '42', '45', '46'), 
      "_transferencia", 
      "aplicacao_direta"
    )
  )

# Tabela das despesas n√£o computadas INCLUINDO VALORES ZERO
tabela_nao_computadas <- despesa_saude_nao_computadas %>% 
  group_by(
    subfuncao_governo_codigo, 
    subfuncao_governo_nome,
    categoria_economica_despesa_codigo, 
    categoria_economica_despesa_nome, 
    transferencia
  ) %>% 
  summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao), .groups = "drop") %>%
  # MANTER TODAS AS LINHAS, incluindo as com valor zero
  arrange(subfuncao_governo_codigo, categoria_economica_despesa_codigo, transferencia)

# Exibir tabela
# DT::datatable(
#   tabela_nao_computadas,
#   caption = "Despesas do Minist√©rio da Sa√∫de N√ÉO Computadas para o Limite (Incluindo Valores Zero)",
#   options = list(
#     pageLength = 20,  # Aumentar para mostrar mais linhas
#     scrollX = TRUE,
#     language = list(url = '//cdn.datatables.net/plug-ins/1.10.11/i18n/Portuguese-Brasil.json')
#   )
# ) %>%
#   DT::formatRound("saldo_r_item_informacao", 2, mark = ".", dec.mark = ",")
```

### Despesas Custeadas com Disponibilidade de Caixa Vinculada aos RP Cancelados

```{r despesas-rp-cancelados}
#| echo: true

# ==============================================================================
# DESPESAS CUSTEADAS COM DISPONIBILIDADE DE CAIXA VINCULADA AOS RP CANCELADOS
# (Apenas para dezembro)
# ==============================================================================

if (exists("dados_despesa") && exists("mes_filtro")) {
  
  despesas_rp_cancelados <- dados_despesa %>%
    filter(
      mes_lancamento == mes_filtro,
      item_informacao_codigo %in% c(25, 27, "25", "27"),
      iduso_codigo == 6,
      !fonte_recursos_codigo %in% c("448", "449"),
      !grupo_despesa_codigo_grupo %in% c("2", "6"),
      !acao_governo_codigo %in% c("0181", "2004", "20YS"),
      modalidade_aplicacao_codigo %in% c("35", "45", "73", "78")
    ) %>%
    group_by(
      subfuncao_governo_codigo,
      subfuncao_governo_nome,
      modalidade_aplicacao_codigo
    ) %>%
    summarise(
      valor = sum(saldo_r_item_informacao, na.rm = TRUE),
      .groups = "drop"
    )
  
  total_despesas_rp_cancelados <- sum(despesas_rp_cancelados$valor, na.rm = TRUE)
  
  cat("Despesas Custeadas com Disp. Caixa Vinculada aos RP Cancelados: R$", 
      format(total_despesas_rp_cancelados, big.mark = ".", decimal.mark = ","), "\n")
  
} else {
  total_despesas_rp_cancelados <- 0
  despesas_rp_cancelados <- tibble()
  cat("Dados nao disponiveis para calculo de RP Cancelados\n")
}
```

```{r}



# Calcular total das subfun√ß√µes espec√≠ficas
total_subfuncoes_especificas <- sum(despesas_saude$saldo_r_item_informacao)
cat("\nüí∞ **Total das Subfun√ß√µes Espec√≠ficas de Sa√∫de:** R$", 
    format(total_subfuncoes_especificas, big.mark = ".", decimal.mark = ","), "\n")

cat("üí∞ **Total das Demais Subfun√ß√µes de Sa√∫de:** R$", 
    format(despesas_saude_demais, big.mark = ".", decimal.mark = ","), "\n")

# Total geral das despesas computadas
total_despesas_computadas <- total_subfuncoes_especificas + despesas_saude_demais
cat("üí∞ **Total Geral das Despesas Computadas:** R$", 
    format(total_despesas_computadas, big.mark = ".", decimal.mark = ","), "\n\n")




# Cumprimento do minimo

# cat("\nüí∞ **Cumprimento do minimo:** ",
#     format(total_despesas_computadas/minimo_saude*100, big.mark = ".", decimal.mark = ",", digits = 4), "%\n")

```

# üìã RREO Tabela 01 - Receitas e Despesas Or√ßament√°rias

## üìä Ficha T√©cnica

| Item | Descri√ß√£o |
|------------------------------------|------------------------------------|
| **Relat√≥rio** | RREO - Relat√≥rio Resumido da Execu√ß√£o Or√ßament√°ria |
| **Demonstrativo** | Tabela 01 - Balan√ßo Or√ßament√°rio da Seguridade Social |
| **Base Legal** | LRF Art. 52, inciso I |
| **Periodicidade** | Bimestral |
| **Grau de Dificuldade** | M√©dio |

## üìÅ Arquivos Necess√°rios

| Objeto          | Arquivo             | Descri√ß√£o              |
|-----------------|---------------------|------------------------|
| `dados_receita` | tg_receita\_\*.xlsx | Receitas or√ßament√°rias |
| `dados_despesa` | tg_despesa\_\*.xlsx | Despesas or√ßament√°rias |

## üìã Atributos Utilizados

| Atributo | Descri√ß√£o | Uso na Tabela |
|------------------------|------------------------|------------------------|
| `nre1_categoria_economica_codigo` | Categoria econ√¥mica receita | 1=Corrente, 2=Capital, 7/8=Intra |
| `nre2_origem_receita_codigo_origem` | Origem da receita | 1-9 conforme classifica√ß√£o |
| `grupo_despesa_codigo_grupo` | Grupo de despesa | 1-6, 9 |
| `esfera_orcamentaria_codigo` | Esfera or√ßament√°ria | 2=Seguridade Social |
| `item_informacao_codigo` | Item de informa√ß√£o | 5=Realizado, 25=Empenhado |
| `unidade_orcamentaria_codigo` | UO | 33904, 40904 etc = Previd√™ncia |
| `modalidade_aplicacao_codigo` | Modalidade | 30-45 = Transfer√™ncias |

## üîó V√≠nculos com Outros Anexos

| Anexo    | V√≠nculo                     |
|----------|-----------------------------|
| RREO A01 | Receitas or√ßament√°rias base |
| RREO A02 | Despesas or√ßament√°rias base |
| RREO A04 | Detalhamento previdenci√°rio |
| RGF A01  | Despesa com pessoal         |

## üìê Estrutura do Demonstrativo

### Receitas por Categoria/Origem

-   **Receitas Correntes** (Categoria 1): Tribut√°ria, Contribui√ß√µes, Patrimonial, etc.
-   **Receitas de Capital** (Categoria 2): Opera√ß√µes de Cr√©dito, Aliena√ß√µes, etc.
-   **Receitas Intra-Or√ßament√°rias** (Categorias 7 e 8)

### Despesas por Grupo

-   **Despesas Correntes**: Pessoal, Juros, ODC
-   **Despesas de Capital**: Investimentos, Invers√µes, Amortiza√ß√£o
-   **Reserva de Conting√™ncia** (Grupo 9)

## üí∞ RECEITAS OR√áAMENT√ÅRIAS

```{r criterios_receitas}
#| echo: true

# ==============================================================================
# CRIT√âRIOS DA TABELA 01 - RECEITAS OR√áAMENT√ÅRIAS
# ==============================================================================

criterios_rreo_T01_receitas <- list(
  
  # === RECEITAS CORRENTES ===
  
  # Receita Tribut√°ria (Origem 1)
  `01  Receita Tribut√°ria` = list(
    criterio = "
    (nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 1) | 
    (nre1_categoria_economica_codigo == 7 & nre2_origem_receita_codigo_origem == 1)
    "
  ),
  
  # Receita de Contribui√ß√µes (Origem 2)
  `02  Receita de Contribui√ß√µes` = list(
    criterio = "
    (nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 2) | 
    (nre1_categoria_economica_codigo == 7 & nre2_origem_receita_codigo_origem == 2)
    "
  ),
  
  # Receita Patrimonial (Origem 3)
  `03  Receita Patrimonial` = list(
    criterio = "
    (nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 3) | 
    (nre1_categoria_economica_codigo == 7 & nre2_origem_receita_codigo_origem == 3)
    "
  ),
  
  # Receita Agropecu√°ria (Origem 4)
  `04  Receita Agropecu√°ria` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 4
    "
  ),
  
  # Receita Industrial (Origem 5)
  `05  Receita Industrial` = list(
    criterio = "
    (nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 5) | 
    (nre1_categoria_economica_codigo == 7 & nre2_origem_receita_codigo_origem == 5)
    "
  ),
  
  # Receita de Servi√ßos (Origem 6)
  `06  Receita de Servi√ßos` = list(
    criterio = "
    (nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 6) | 
    (nre1_categoria_economica_codigo == 7 & nre2_origem_receita_codigo_origem == 6)
    "
  ),
  
  # Transfer√™ncias Correntes (Origem 7)
  `07  Transfer√™ncias Correntes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 7
    "
  ),
  
  # Receitas Correntes a Classificar (Origem 8)
  `08  Receitas Correntes a Classificar` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 8
    "
  ),
  
  # Outras Receitas Correntes (Origem 9)
  `09  Outras Receitas Correntes` = list(
    criterio = "
    (nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 9) | 
    (nre1_categoria_economica_codigo == 7 & nre2_origem_receita_codigo_origem == 9)
    "
  ),
  
  # === RECEITAS DE CAPITAL ===
  
  # Opera√ß√µes de Cr√©dito (Origem 1)
  `10  Opera√ß√µes de Cr√©dito` = list(
    criterio = "
    (nre1_categoria_economica_codigo == 2 & nre2_origem_receita_codigo_origem == 1) | 
    (nre1_categoria_economica_codigo == 8 & nre2_origem_receita_codigo_origem == 1)
    "
  ),
  
  # Aliena√ß√£o de Bens (Origem 2)
  `11  Aliena√ß√£o de Bens` = list(
    criterio = "
    (nre1_categoria_economica_codigo == 2 & nre2_origem_receita_codigo_origem == 2) | 
    (nre1_categoria_economica_codigo == 8 & nre2_origem_receita_codigo_origem == 2)
    "
  ),
  
  # Transfer√™ncias de Capital (Origem 4)
  `12  Transfer√™ncias de Capital` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & nre2_origem_receita_codigo_origem == 4
    "
  ),
  
  # Outras Receitas de Capital (Origem 5)
  `13  Outras Receitas de Capital` = list(
    criterio = "
    (nre1_categoria_economica_codigo == 2 & nre2_origem_receita_codigo_origem == 5) | 
    (nre1_categoria_economica_codigo == 8 & nre2_origem_receita_codigo_origem == 5)
    "
  ),
  
  # SUBTOTAL (I) - Total de Receitas
  `14  SUBTOTAL (I)` = list(
    criterio = "
    nre1_categoria_economica_codigo %in% c(1, 2, 7, 8)
    "
  )
)
```

### Processamento das Receitas

```{r processar-receitas}
#| echo: true

# ==============================================================================
# PROCESSAMENTO DAS RECEITAS - SEGURIDADE SOCIAL
# ==============================================================================

if (!exists("dados_receita")) {
  warning("dados_receita nao encontrado")
  df_criterios_rreo_T01_receitas <- tibble(
    categoria = "ERRO - Dados n√£o dispon√≠veis",
    ordem = "00",
    valor = NA_real_
  )
} else {
  # Aplicar crit√©rios nas receitas da Seguridade Social
  df_criterios_rreo_T01_receitas <- aplicar_criterios(
    df = dados_receita %>% 
      filter(esfera_orcamentaria_codigo == 2, item_informacao_codigo == "5") %>% 
      unique(),
    criterios = criterios_rreo_T01_receitas
  ) %>% 
    group_by(categoria, ordem) %>% 
    summarise(valor = sum(valor, na.rm = TRUE), .groups = "drop") %>%
    arrange(ordem)
  
  # Exibir resultado
  datatable(
    df_criterios_rreo_T01_receitas,
    caption = "üìä Receitas Or√ßament√°rias - Seguridade Social",
    options = list(pageLength = 20, dom = 'ft'),
    rownames = FALSE
  ) %>%
    formatRound(c("valor"), 2, mark = ".", dec.mark = ",")
}
```

## üí∏ DESPESAS OR√áAMENT√ÅRIAS

```{r criterios-despesas}
#| echo: true

# ==============================================================================
# CRIT√âRIOS DA TABELA 01 - DESPESAS OR√áAMENT√ÅRIAS
# ==============================================================================

criterios_rreo_T01_despesas_T01 <- list(
  
  # === DESPESAS CORRENTES ===
  
  # Pessoal e Encargos Sociais (Grupo 1)
  `01  Pessoal e Encargos Sociais` = list(
    criterio = "grupo_despesa_codigo_grupo == '1'"
  ),
  
  # Juros e Encargos da D√≠vida (Grupo 2)
  `02  Juros e Encargos da D√≠vida` = list(
    criterio = "grupo_despesa_codigo_grupo == '2'"
  ),
  
  # Outras Despesas Correntes (Grupo 3)
  `03  Outras Despesas Correntes` = list(
    criterio = "grupo_despesa_codigo_grupo == '3'"
  ),
  
  # Benef√≠cios Previdenci√°rios (Subitem de ODC)
  `04  Benef√≠cios Previdenci√°rios` = list(
    criterio = "
    grupo_despesa_codigo_grupo == '3' & 
    unidade_orcamentaria_codigo %in% c('55902', '40904', '33904', '25917')
    "
  ),
  
  # Transfer√™ncias (Subitem de ODC)
  `05  Transfer√™ncias` = list(
    criterio = "
    grupo_despesa_codigo_grupo == '3' & 
    modalidade_aplicacao_codigo %in% c('30', '31', '35', '36', '40', '41', '42', '45')
    "
  ),
  
  # Demais Despesas Correntes (Subitem de ODC)
  `06  Demais Despesas Correntes` = list(
    criterio = "
    grupo_despesa_codigo_grupo == '3' & 
    !unidade_orcamentaria_codigo %in% c('55902', '40904', '33904', '25917') &
    !modalidade_aplicacao_codigo %in% c('30', '31', '35', '36', '40', '41', '42', '45')
    "
  ),
  
  # === DESPESAS DE CAPITAL ===
  
  # Investimentos (Grupo 4)
  `07  Investimentos` = list(
    criterio = "grupo_despesa_codigo_grupo == '4'"
  ),
  
  # Invers√µes Financeiras (Grupo 5)
  `08  Invers√µes Financeiras` = list(
    criterio = "grupo_despesa_codigo_grupo == '5'"
  ),
  
  # Amortiza√ß√£o da D√≠vida (Grupo 6)
  `09  Amortiza√ß√£o da D√≠vida` = list(
    criterio = "grupo_despesa_codigo_grupo == '6'"
  ),
  
  # RESERVA DE CONTING√äNCIA (Grupo 9)
  `10  RESERVA DE CONTING√äNCIA` = list(
    criterio = "grupo_despesa_codigo_grupo == '9'"
  ),
  
  # SUBTOTAL (III) - Total das Despesas
  `11  SUBTOTAL (III)` = list(
    criterio = "grupo_despesa_codigo_grupo %in% c('1', '2', '3', '4', '5', '6', '9')"
  )
)
```

### Processamento das Despesas

```{r processar-despesas}
#| echo: true

# ==============================================================================
# PROCESSAMENTO DAS DESPESAS - SEGURIDADE SOCIAL
# ==============================================================================

if (!exists("dados_despesa")) {
  warning("dados_despesa nao encontrado")
  df_criterios_rreo_T01_despesas_T01 <- tibble(
    categoria = "ERRO - Dados n√£o dispon√≠veis",
    ordem = "00",
    valor = NA_real_
  )
} else {
  # Aplicar crit√©rios nas despesas da Seguridade Social
  df_criterios_rreo_T01_despesas_T01 <- aplicar_criterios(
    df = dados_despesa %>% 
      filter(esfera_orcamentaria_codigo == 2, item_informacao_codigo %in% c(25, 27 )) %>% 
      unique(),
    criterios = criterios_rreo_T01_despesas_T01
  ) %>% 
    group_by(categoria, ordem) %>% 
    summarise(valor = sum(valor, na.rm = TRUE), .groups = "drop") %>%
    arrange(ordem)
  
  # Exibir resultado
  datatable(
    df_criterios_rreo_T01_despesas_T01,
    caption = "üìä Despesas Or√ßament√°rias - Seguridade Social",
    options = list(pageLength = 15, dom = 'ft'),
    rownames = FALSE
  ) %>%
    formatRound(c("valor"), 2, mark = ".", dec.mark = ",")
}
```

## üìà Resultado da Seguridade Social

```{r resultado-seguridade}
#| echo: true

# ==============================================================================
# C√ÅLCULO DO RESULTADO DA SEGURIDADE SOCIAL
# F√≥rmula: Resultado = Receitas (SUBTOTAL I) - Despesas (SUBTOTAL III)
# ==============================================================================

if (exists("df_criterios_rreo_T01_receitas") && exists("df_criterios_rreo_T01_despesas_T01")) {
  
  # Obter totais
  receita_total <- df_criterios_rreo_T01_receitas %>% 
    filter(ordem == "14") %>% 
    pull(valor)
  
  despesa_total <- df_criterios_rreo_T01_despesas_T01 %>% 
    filter(ordem == "11") %>% 
    pull(valor)
  
  resultado_seguridade <- receita_total - despesa_total
  
  # Tabela resumo
  resumo_seguridade <- tibble(
    Componente = c(
      "RECEITAS (SUBTOTAL I)",
      "DESPESAS (SUBTOTAL III)",
      "RESULTADO DA SEGURIDADE SOCIAL"
    ),
    Valor = c(receita_total, despesa_total, resultado_seguridade)
  )
  
  datatable(
    resumo_seguridade %>%
      mutate(Valor = format(round(Valor, 2), big.mark = ".", decimal.mark = ",")),
    caption = "üìä Resultado da Seguridade Social",
    options = list(dom = 't', pageLength = 5),
    rownames = FALSE
  )
  
  # Resultado no console
  cat("\n")
  cat(strrep("=", 60), "\n")
  cat("RESULTADO DA SEGURIDADE SOCIAL\n")
  cat(strrep("=", 60), "\n")
  cat(sprintf("Receitas Totais:   R$ %s\n", 
              format(round(receita_total, 2), big.mark = ".", decimal.mark = ",")))
  cat(sprintf("Despesas Totais:   R$ %s\n", 
              format(round(despesa_total, 2), big.mark = ".", decimal.mark = ",")))
  cat(strrep("-", 60), "\n")
  cat(sprintf("RESULTADO:         R$ %s (%s)\n", 
              format(round(resultado_seguridade, 2), big.mark = ".", decimal.mark = ","),
              ifelse(resultado_seguridade >= 0, "SUPER√ÅVIT", "D√âFICIT")))
  cat(strrep("=", 60), "\n")
  
} else {
  resultado_seguridade <- NA
  cat("Dados n√£o dispon√≠veis para c√°lculo do resultado\n")
}
```

## ü•á Seguridade Social por √Årea

```{r criterios-seguridade}
#| echo: true

# ==============================================================================
# CRIT√âRIOS PARA AN√ÅLISE DA SEGURIDADE SOCIAL POR √ÅREA
# ==============================================================================

criterios_rreo_T01B_seguridade_T01B <- list(
  
  # SA√öDE (IDUSO 6)
  `01  Sa√∫de` = list(
    criterio = "iduso_codigo %in% c('6') & funcao_governo_codigo %notin% c('08')"
  ),
  
  # RGPS - UNIDADE OR√áAMENT√ÅRIA (Previd√™ncia)
  `02  RGPS - Receitas da Previd√™ncia Social` = list(
    criterio = "unidade_orcamentaria_codigo %in% c('33904', '40404', '35902', '29917')"
  ),
  
  # ASSIST√äNCIA SOCIAL (Fun√ß√£o 08)
  `03  Assist√™ncia Social` = list(
    criterio = "
    funcao_governo_codigo %in% c('08') & 
    acao_governo_codigo %notin% c('0581', '0544', '0563', '0658', '0585', '0653', '0636')
    "
  ),
  
  # ABONO SALARIAL
  `04  Abono Salarial` = list(
    criterio = "acao_governo_codigo %in% c('0581')"
  ),
  
  # SEGURO DESEMPREGO
  `05  Seguro Desemprego` = list(
    criterio = "acao_governo_codigo %in% c('00H4', '0583', '0585', '0686', '0653')"
  )
)
```

### Processamento por √Årea

```{r processar-seguridade-area}
#| echo: true

# Processar dados da Seguridade Social por √°rea
if (exists("dados_despesa")) {
  df_seguridade_area <- aplicar_criterios(
    df = dados_despesa %>% 
      filter(esfera_orcamentaria_codigo == 2, item_informacao_codigo %in% c(25 , 27)) %>% 
      unique(),
    criterios = criterios_rreo_T01B_seguridade_T01B
  ) %>% 
    group_by(categoria) %>% 
    summarise(valor = sum(valor, na.rm = TRUE), .groups = "drop")
  
  datatable(
    df_seguridade_area,
    caption = "üìä Despesas da Seguridade Social por √Årea",
    options = list(dom = 't', pageLength = 10),
    rownames = FALSE
  ) %>%
    formatRound(c("valor"), 2, mark = ".", dec.mark = ",")
} else {
  cat("Dados n√£o dispon√≠veis\n")
}
```

## üìã Objetos Exportados

| Objeto | Descri√ß√£o |
|------------------------------------|------------------------------------|
| `criterios_rreo_T01_receitas` | Crit√©rios para receitas or√ßament√°rias |
| `criterios_rreo_T01_despesas_T01` | Crit√©rios para despesas or√ßament√°rias |
| `criterios_rreo_T01B_seguridade_T01B` | Crit√©rios para seguridade por √°rea |
| `df_criterios_rreo_T01_receitas` | Receitas processadas |
| `df_criterios_rreo_T01_despesas_T01` | Despesas processadas |
| `df_seguridade_area` | Despesas por √°rea da seguridade |
| `resultado_seguridade` | Resultado (Receitas - Despesas) |

## üìå Observa√ß√µes Importantes

1.  **Esfera Or√ßament√°ria**: Apenas Seguridade Social (c√≥digo 2)

2.  **Receitas Intra-Or√ßament√°rias**: Categorias 7 e 8 s√£o inclu√≠das

3.  **UOs Previdenci√°rias**:

    -   33904: INSS
    -   40904: FAT
    -   55902: RPPS
    -   25917: Minist√©rio da Previd√™ncia

4.  **Modalidades de Transfer√™ncia**: 30, 31, 35, 36, 40, 41, 42, 45

# üìã RREO Tabela 02 - Despesas por Modalidade de Aplica√ß√£o

## üìä Ficha T√©cnica

| Item | Descri√ß√£o |
|----|----|
| **Relat√≥rio** | RREO - Relat√≥rio Resumido da Execu√ß√£o Or√ßament√°ria |
| **Demonstrativo** | Tabela 02 - Despesas com Pessoal por Modalidade |
| **Base Legal** | LRF Art. 52, inciso I |
| **Periodicidade** | Bimestral |
| **Grau de Dificuldade** | Dif√≠cil |

## üìÅ Arquivos Necess√°rios

| Objeto          | Arquivo             | Descri√ß√£o              |
|-----------------|---------------------|------------------------|
| `dados_despesa` | tg_despesa\_\*.xlsx | Despesas or√ßament√°rias |

## üìã Atributos Utilizados

| Atributo | Descri√ß√£o | Uso na Tabela |
|------------------------|------------------------|------------------------|
| `grupo_despesa_codigo_grupo` | Grupo de despesa | 1 = Pessoal e Encargos |
| `elemento_despesa_codigo` | Elemento de despesa | 00-41 conforme classifica√ß√£o |
| `orgao_uge_orgao_maximo_codigo` | √ìrg√£o m√°ximo | 52000 = Minist√©rio da Defesa |
| `acao_governo_codigo` | C√≥digo da a√ß√£o | 0181 = Pessoal Civil no MD |
| `orgao_uge_tipo_administracao_nome` | Tipo de administra√ß√£o | Direta, Autarquia, etc. |
| `orgao_uge_orcam_fiscal_s_n` | Indicador or√ßamento fiscal | PERTENCE |
| `mes_lancamento` | M√™s de lan√ßamento | Filtro do per√≠odo |

## üîó V√≠nculos com Outros Anexos

| Anexo    | V√≠nculo                      |
|----------|------------------------------|
| RREO A02 | Despesas or√ßament√°rias base  |
| RGF A01  | Despesa com pessoal (limite) |
| RREO T01 | Despesas totais por grupo    |

## üìê Estrutura do Demonstrativo

### Pessoal Civil

-   Vencimentos e Vantagens Fixas (elemento 11)
-   Outras Despesas Vari√°veis (elemento 16)
-   Aposentadoria (elemento 01, exceto MD ou com a√ß√£o 0181)
-   Pens√µes (elemento 03, exceto MD ou com a√ß√£o 0181)
-   Contribui√ß√µes a Entidades Fechadas de Previd√™ncia (elemento 07)
-   Obriga√ß√µes Patronais (elemento 13)
-   Outras Aplica√ß√µes

### Pessoal Militar

-   Vencimentos e Vantagens Fixas (elemento 12)
-   Outras Despesas Vari√°veis (elemento 17)
-   Reformas (elemento 01, MD, exceto a√ß√£o 0181)
-   Pens√µes (elemento 03, MD, exceto a√ß√£o 0181)
-   Obriga√ß√µes Patronais (elemento 13, MD)
-   Outras Aplica√ß√µes

### Outros

-   Transfer√™ncias Intergovernamentais (elemento 41)

## üìä Crit√©rios da Tabela 02

```{r criterios-tabela02}
#| echo: true

# ==============================================================================
# CRIT√âRIOS DA TABELA 02 - DESPESAS COM PESSOAL POR MODALIDADE
# ==============================================================================

criterios_rreo_T02_despesas_T02 <- list(
  
  # APLICA√á√ÉO DIRETA (ser√° calculado por soma dos subitens)
  `01  Aplica√ß√£o Direta` = list(
    criterio = "FALSE"  # Ser√° calculado por soma posterior
  ),
  
  # A DETALHAR (Elemento 00)
  `02  A Detalhar` = list(
    criterio = "elemento_despesa_codigo %in% c('00')"
  ),
  
  # PESSOAL CIVIL (ser√° calculado por soma dos subitens)
  `03  Pessoal Civil` = list(
    criterio = "FALSE"  # Ser√° calculado por soma posterior
  ),
  
  # PESSOAL CIVIL - VENCIMENTOS E VANTAGENS FIXAS (Elemento 11)
  `04  Pessoal Civil - Vencimentos e Vantagens Fixas` = list(
    criterio = "elemento_despesa_codigo %in% c('11')"
  ),
  
  # PESSOAL CIVIL - OUTRAS DESPESAS VARI√ÅVEIS (Elemento 16)
  `05  Pessoal Civil - Outras Despesas Vari√°veis` = list(
    criterio = "elemento_despesa_codigo %in% c('16')"
  ),
  
  # PESSOAL CIVIL - APOSENTADORIA (Elemento 01)
  # Exclui MD (52000) ou inclui MD com a√ß√£o 0181 (civis no MD)
  `06  Pessoal Civil - Aposentadoria` = list(
    criterio = "
    elemento_despesa_codigo %in% c('01') & 
    (orgao_uge_orgao_maximo_codigo %notin% c('52000') | 
     (orgao_uge_orgao_maximo_codigo %in% c('52000') & acao_governo_codigo %in% c('0181')))
    "
  ),
  
  # PESSOAL CIVIL - PENS√ïES (Elemento 03)
  # Exclui MD (52000) ou inclui MD com a√ß√£o 0181 (civis no MD)
  `07  Pessoal Civil - Pens√µes` = list(
    criterio = "
    elemento_despesa_codigo %in% c('03') & 
    (orgao_uge_orgao_maximo_codigo %notin% c('52000') | 
     (orgao_uge_orgao_maximo_codigo %in% c('52000') & acao_governo_codigo %in% c('0181')))
    "
  ),
  
  # PESSOAL CIVIL - CONTRIBUI√á√ïES A ENTIDADES FECHADAS DE PREVID√äNCIA (Elemento 07)
  `08  Pessoal Civil - Contribui√ß√µes a Entidades Fechadas de Previd√™ncia` = list(
    criterio = "
    elemento_despesa_codigo %in% c('07') & 
    orgao_uge_orgao_maximo_codigo %notin% c('52000')
    "
  ),
  
  # PESSOAL CIVIL - OBRIGA√á√ïES PATRONAIS (Elemento 13)
  `09  Pessoal Civil - Obriga√ß√µes Patronais` = list(
    criterio = "
    elemento_despesa_codigo %in% c('13') & 
    orgao_uge_orgao_maximo_codigo %notin% c('52000')
    "
  ),
  
  # PESSOAL CIVIL - OUTRAS APLICA√á√ïES
  # Demais elementos para civis (exceto 00, 01, 03, 07, 11, 12, 13, 16, 17, 41)
  `10  Pessoal Civil - Outras Aplica√ß√µes` = list(
    criterio = "
    (elemento_despesa_codigo %notin% c('00', '01', '03') & 
     orgao_uge_orgao_maximo_codigo %in% c('52000') & 
     acao_governo_codigo %in% c('0181')) | 
    (elemento_despesa_codigo %notin% c('00', '01', '03', '07', '11', '12', '13', '16', '17', '41') & 
     orgao_uge_orgao_maximo_codigo %notin% c('52000'))
    "
  ),
  
  # PESSOAL MILITAR (ser√° calculado por soma dos subitens)
  `11  Pessoal Militar` = list(
    criterio = "FALSE"  # Ser√° calculado por soma posterior
  ),
  
  # PESSOAL MILITAR - VENCIMENTOS E VANTAGENS FIXAS (Elemento 12)
  `12  Pessoal Militar - Vencimentos e Vantagens Fixas` = list(
    criterio = "elemento_despesa_codigo %in% c('12')"
  ),
  
  # PESSOAL MILITAR - OUTRAS DESPESAS VARI√ÅVEIS (Elemento 17)
  `13  Pessoal Militar - Outras Despesas Vari√°veis` = list(
    criterio = "elemento_despesa_codigo %in% c('17')"
  ),
  
  # PESSOAL MILITAR - REFORMAS (Elemento 01, MD, exceto a√ß√£o 0181)
  `14  Pessoal Militar - Reformas` = list(
    criterio = "
    elemento_despesa_codigo %in% c('01') & 
    orgao_uge_orgao_maximo_codigo %in% c('52000') & 
    acao_governo_codigo %notin% c('0181')
    "
  ),
  
  # PESSOAL MILITAR - PENS√ïES (Elemento 03, MD, exceto a√ß√£o 0181)
  `15  Pessoal Militar - Pens√µes` = list(
    criterio = "
    elemento_despesa_codigo %in% c('03') & 
    orgao_uge_orgao_maximo_codigo %in% c('52000') & 
    acao_governo_codigo %notin% c('0181')
    "
  ),
  
  # PESSOAL MILITAR - OBRIGA√á√ïES PATRONAIS (Elemento 13, MD)
  `16  Pessoal Militar - Obriga√ß√µes Patronais` = list(
    criterio = "
    elemento_despesa_codigo %in% c('13') & 
    orgao_uge_orgao_maximo_codigo %in% c('52000')
    "
  ),
  
  # PESSOAL MILITAR - OUTRAS APLICA√á√ïES (+)
  `17  Pessoal Militar - Outras Aplica√ß√µes (+)` = list(
    criterio = "
    elemento_despesa_codigo %notin% c('00', '01', '03', '11', '12', '13', '16', '17', '41') & 
    orgao_uge_orgao_maximo_codigo %in% c('52000')
    "
  ),
  
  # PESSOAL MILITAR - OUTRAS APLICA√á√ïES (-)
  # Dedu√ß√£o para civis no MD (a√ß√£o 0181)
  `18  Pessoal Militar - Outras Aplica√ß√µes (-)` = list(
    criterio = "
    elemento_despesa_codigo %notin% c('00', '01', '03', '11') & 
    orgao_uge_orgao_maximo_codigo %in% c('52000') & 
    acao_governo_codigo %in% c('0181')
    "
  ),
  
  # TRANSFER√äNCIAS INTERGOVERNAMENTAIS (Elemento 41)
  `19  Transfer√™ncias Intergovernamentais` = list(
    criterio = "elemento_despesa_codigo %in% c('41')"
  ),
  
  # TRANSFER√äNCIAS A ESTADOS E AO DF (Elemento 41)
  `20  Transfer√™ncias a Estados e ao DF` = list(
    criterio = "elemento_despesa_codigo %in% c('41')"
  )
)
```

## üíº Processamento dos Dados

### üìä Despesa Liquidada por Tipo de Administra√ß√£o

```{r processar-liquidada}
#| echo: true

# ==============================================================================
# PROCESSAMENTO DAS DESPESAS COM PESSOAL POR TIPO DE ADMINISTRA√á√ÉO
# ==============================================================================

if (!exists("dados_despesa")) {
  warning("dados_despesa nao encontrado")
  df_t02_tipo_admin <- tibble(
    categoria = "ERRO - Dados n√£o dispon√≠veis",
    valor = NA_real_
  )
} else {
  # Aplicar crit√©rios nas despesas com pessoal do Or√ßamento Fiscal
  df_t02_tipo_admin <- aplicar_criterios(
    df = dados_despesa %>% 
      filter(
        grupo_despesa_codigo_grupo == 1,
        orgao_uge_orcam_fiscal_s_n == "PERTENCE",
        mes_lancamento == mes_filtro,
        item_informacao_codigo %in% c(25,27)
      ),
    criterios = criterios_rreo_T02_despesas_T02,
    group_vars = c("orgao_uge_tipo_administracao_nome")
  ) %>% 
    group_by(categoria, orgao_uge_tipo_administracao_nome) %>% 
    summarise(valor = sum(valor, na.rm = TRUE), .groups = "drop") %>% 
    pivot_wider(names_from = "orgao_uge_tipo_administracao_nome", values_from = "valor")
  
  # Exibir resultado
  datatable(
    df_t02_tipo_admin,
    caption = "üìä Despesas com Pessoal por Tipo de Administra√ß√£o",
    options = list(pageLength = 25, dom = 'ft', scrollX = TRUE),
    rownames = FALSE
  ) %>%
    formatRound(
      columns = names(df_t02_tipo_admin)[sapply(df_t02_tipo_admin, is.numeric)],
      digits = 2, 
      mark = ".", 
      dec.mark = ","
    )
}
```

### ‚úÖ Valida√ß√£o Pessoal Militar

```{r validacao-militar}
#| echo: true

# ==============================================================================
# VALIDA√á√ÉO ESPEC√çFICA PARA PESSOAL MILITAR
# ==============================================================================

if (exists("dados_despesa") && exists("mes_filtro")) {
  validacao_militar <- dados_despesa %>% 
    group_by(orgao_uge_tipo_administracao_nome) %>%
    filter(
      grupo_despesa_codigo_grupo == 1,
      mes_lancamento == mes_filtro,
      item_informacao_codigo == "9"
    ) %>% 
    filter(
      # Condi√ß√µes para Pessoal Militar
      (elemento_despesa_codigo %in% c('12', '17')) |
      (elemento_despesa_codigo %in% c('01') & 
       orgao_uge_orgao_maximo_codigo %in% c('52000') &
       acao_governo_codigo %notin% c('0181')) |
      (elemento_despesa_codigo %in% c('03') & 
       orgao_uge_orgao_maximo_codigo %in% c('52000') &
       acao_governo_codigo %notin% c('0181')) |
      (elemento_despesa_codigo %in% c('13') & 
       orgao_uge_orgao_maximo_codigo %in% c('52000'))
    ) %>% 
    summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao, na.rm = TRUE), .groups = "drop")
  
  datatable(
    validacao_militar, 
    caption = "‚úÖ Valida√ß√£o - Pessoal Militar",
    options = list(dom = 't'),
    rownames = FALSE
  ) %>%
    formatRound(c('saldo_r_item_informacao'), 2, mark = ".", dec.mark = ",")
} else {
  cat("Dados n√£o dispon√≠veis para valida√ß√£o\n")
}
```

### ‚úÖ Valida√ß√£o Pessoal Civil

```{r validacao-civil}
#| echo: true

# ==============================================================================
# VALIDA√á√ÉO ESPEC√çFICA PARA PESSOAL CIVIL
# ==============================================================================

if (exists("dados_despesa") && exists("mes_filtro")) {
  validacao_civil <- dados_despesa %>% 
    group_by(orgao_uge_tipo_administracao_nome) %>%
    filter(
      grupo_despesa_codigo_grupo == 1,
      mes_lancamento == mes_filtro,
      item_informacao_codigo == "9"
    ) %>% 
    filter(
      # Condi√ß√µes espec√≠ficas para Pessoal Civil
      (elemento_despesa_codigo %in% c('11', '16')) |
      (elemento_despesa_codigo == '01' & orgao_uge_orgao_maximo_codigo != '52000') |
      (elemento_despesa_codigo == '01' & orgao_uge_orgao_maximo_codigo == '52000' & acao_governo_codigo == '0181') |
      (elemento_despesa_codigo == '03' & orgao_uge_orgao_maximo_codigo != '52000') |
      (elemento_despesa_codigo == '03' & orgao_uge_orgao_maximo_codigo == '52000' & acao_governo_codigo == '0181') |
      (elemento_despesa_codigo == '07' & orgao_uge_orgao_maximo_codigo != '52000') |
      (elemento_despesa_codigo == '13' & orgao_uge_orgao_maximo_codigo != '52000')
    ) %>% 
    summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao, na.rm = TRUE), .groups = "drop")
  
  datatable(
    validacao_civil, 
    caption = "‚úÖ Valida√ß√£o - Pessoal Civil",
    options = list(dom = 't'),
    rownames = FALSE
  ) %>%
    formatRound(c('saldo_r_item_informacao'), 2, mark = ".", dec.mark = ",")
} else {
  cat("Dados n√£o dispon√≠veis para valida√ß√£o\n")
}
```

## üìà Resumo Consolidado

```{r resumo-consolidado}
#| echo: true

# ==============================================================================
# RESUMO CONSOLIDADO - PESSOAL CIVIL x MILITAR
# ==============================================================================

if (exists("validacao_civil") && exists("validacao_militar")) {
  
  total_civil <- sum(validacao_civil$saldo_r_item_informacao, na.rm = TRUE)
  total_militar <- sum(validacao_militar$saldo_r_item_informacao, na.rm = TRUE)
  total_geral <- total_civil + total_militar
  
  resumo_pessoal <- tibble(
    Categoria = c("Pessoal Civil", "Pessoal Militar", "TOTAL GERAL"),
    Valor = c(total_civil, total_militar, total_geral),
    Percentual = c(
      total_civil / total_geral * 100,
      total_militar / total_geral * 100,
      100
    )
  )
  
  datatable(
    resumo_pessoal %>%
      mutate(
        Valor = format(round(Valor, 2), big.mark = ".", decimal.mark = ","),
        Percentual = paste0(round(Percentual, 2), "%")
      ),
    caption = "üìä Resumo - Despesas com Pessoal Civil x Militar",
    options = list(dom = 't', pageLength = 5),
    rownames = FALSE
  )
  
  # Resultado no console
  cat("\n")
  cat(strrep("=", 60), "\n")
  cat("RESUMO - DESPESAS COM PESSOAL\n")
  cat(strrep("=", 60), "\n")
  cat(sprintf("Pessoal Civil:    R$ %s (%.2f%%)\n", 
              format(round(total_civil, 2), big.mark = ".", decimal.mark = ","),
              total_civil / total_geral * 100))
  cat(sprintf("Pessoal Militar:  R$ %s (%.2f%%)\n", 
              format(round(total_militar, 2), big.mark = ".", decimal.mark = ","),
              total_militar / total_geral * 100))
  cat(strrep("-", 60), "\n")
  cat(sprintf("TOTAL GERAL:      R$ %s\n", 
              format(round(total_geral, 2), big.mark = ".", decimal.mark = ",")))
  cat(strrep("=", 60), "\n")
  
  # Exportar vari√°veis
  valor_pessoal_civil <- total_civil
  valor_pessoal_militar <- total_militar
  valor_pessoal_total <- total_geral
  
} else {
  cat("Dados n√£o dispon√≠veis para resumo consolidado\n")
}
```

## üìã Objetos Exportados

| Objeto | Descri√ß√£o |
|------------------------------------|------------------------------------|
| `criterios_rreo_T02_despesas_T02` | Crit√©rios para despesas com pessoal |
| `df_t02_tipo_admin` | Despesas por tipo de administra√ß√£o |
| `validacao_civil` | Valida√ß√£o pessoal civil por tipo admin |
| `validacao_militar` | Valida√ß√£o pessoal militar por tipo admin |
| `valor_pessoal_civil` | Total pessoal civil |
| `valor_pessoal_militar` | Total pessoal militar |
| `valor_pessoal_total` | Total geral de pessoal |

## üìå Observa√ß√µes Importantes

1.  **Minist√©rio da Defesa (52000)**:
    -   Pessoal militar est√° concentrado neste √≥rg√£o
    -   A√ß√£o 0181 identifica civis lotados no MD
    -   Elementos 12 e 17 s√£o exclusivos de militares
2.  **Elementos de Despesa**:
    -   01: Aposentadorias/Reformas
    -   03: Pens√µes
    -   07: Contribui√ß√µes Previd√™ncia Fechada
    -   11: Vencimentos Fixos Civil
    -   12: Vencimentos Fixos Militar
    -   13: Obriga√ß√µes Patronais
    -   16: Outras Vari√°veis Civil
    -   17: Outras Vari√°veis Militar
    -   41: Transfer√™ncias Intergovernamentais
3.  **Tipos de Administra√ß√£o**:
    -   Administra√ß√£o Direta
    -   Autarquia
    -   Economia Mista
    -   Empresa P√∫blica
    -   Funda√ß√£o
    -   Fundos
4.  **Filtros Aplicados**:
    -   Grupo 1 (Pessoal e Encargos)
    -   Or√ßamento Fiscal (PERTENCE)
    -   Per√≠odo de refer√™ncia (mes_filtro)
    -   Item de informa√ß√£o 25 (Empenhado)

# üìã RREO Tabela 03 - Despesas por Resultado EOF

## üìä Ficha T√©cnica

| Item | Descri√ß√£o |
|------------------------------------|------------------------------------|
| **Relat√≥rio** | RREO - Relat√≥rio Resumido da Execu√ß√£o Or√ßament√°ria |
| **Demonstrativo** | Tabela 03 - Despesas por Resultado EOF (Prim√°rias/Financeiras) |
| **Base Legal** | LRF Art. 52, inciso I |
| **Periodicidade** | Bimestral |
| **Grau de Dificuldade** | F√°cil |

## üìÅ Arquivos Necess√°rios

| Objeto          | Arquivo             | Descri√ß√£o              |
|-----------------|---------------------|------------------------|
| `dados_despesa` | tg_despesa\_\*.xlsx | Despesas or√ßament√°rias |

## üìã Atributos Utilizados

| Atributo | Descri√ß√£o | Uso na Tabela |
|------------------------|------------------------|------------------------|
| `resultado_eof_codigo` | C√≥digo do resultado EOF | 6 = Prim√°rio |
| `resultado_eof_nome` | Nome do resultado | Prim√°rio / Financeiro |
| `orgao_uge_orgao_maximo_codigo` | C√≥digo do √≥rg√£o m√°ximo | Agrupamento por √≥rg√£o |
| `orgao_uge_orgao_maximo_nome` | Nome do √≥rg√£o m√°ximo | Descri√ß√£o do √≥rg√£o |
| `item_informacao_codigo` | Item de informa√ß√£o | 23 = Dota√ß√£o Atualizada |
| `item_informacao_nome` | Nome do item | Descri√ß√£o do item |
| `mes_lancamento` | M√™s de lan√ßamento | Filtro do per√≠odo |
| `saldo_r_item_informacao` | Valor do saldo | Valor monet√°rio |

## üîó V√≠nculos com Outros Anexos

| Anexo    | V√≠nculo                        |
|----------|--------------------------------|
| RREO A01 | Despesas or√ßament√°rias totais  |
| RREO A06 | Resultado prim√°rio detalhado   |
| RGF A01  | Despesa com pessoal (prim√°ria) |

## üìê Estrutura do Demonstrativo

### Classifica√ß√£o por Resultado EOF

**Resultado Prim√°rio (c√≥digo 6):** - Despesas que afetam o resultado prim√°rio - Exclui despesas financeiras (juros, amortiza√ß√£o) - Base para c√°lculo do resultado fiscal

**Resultado Financeiro:** - Despesas com juros e encargos da d√≠vida - Despesas com amortiza√ß√£o da d√≠vida - Opera√ß√µes financeiras diversas

### Itens de Informa√ß√£o T√≠picos

-   **23**: Dota√ß√£o Atualizada
-   **24**: Despesa Empenhada
-   **25**: Despesa Liquidada
-   **26**: Despesa Paga

## üìà Processamento dos Dados

### Despesas Prim√°rias Totais

```{r despesas-primarias-total}
#| echo: true
#| label: despesas-primarias-total

# ==============================================================================
# DESPESAS PRIM√ÅRIAS TOTAIS
# ==============================================================================
# Filtro: Resultado EOF = 6 (Prim√°rio), Item Informa√ß√£o = 23 (Dota√ß√£o Atualizada)
# ==============================================================================

if (!exists("dados_despesa")) {
  warning("dados_despesa nao encontrado")
  total_despesas_primarias <- 0
} else {
  # Calcular total das despesas prim√°rias
  total_despesas_primarias <- dados_despesa %>% 
    filter(
      resultado_eof_codigo == 6, 
      item_informacao_codigo == 23
    ) %>% 
    summarise(
      saldo_r_item_informacao = sum(saldo_r_item_informacao, na.rm = TRUE)
    ) %>%
    pull(saldo_r_item_informacao)
  
  # Formatar e exibir
  cat(sprintf("üí∞ Total das Despesas Prim√°rias (Dota√ß√£o Atualizada): R$ %s\n",
              format(round(total_despesas_primarias, 2), big.mark = ".", decimal.mark = ",")))
}
```

### Despesas por Resultado EOF

```{r despesas-por-resultado}
#| echo: true
#| label: despesas-por-resultado-eof

# ==============================================================================
# DESPESAS POR RESULTADO EOF
# ==============================================================================

if (exists("dados_despesa")) {
  # Agrupar despesas por resultado EOF
  despesas_por_resultado <- dados_despesa %>% 
    filter(item_informacao_codigo == 23) %>%
    group_by(resultado_eof_codigo, resultado_eof_nome) %>% 
    summarise(
      saldo_r_item_informacao = sum(saldo_r_item_informacao, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    arrange(resultado_eof_codigo) %>%
    janitor::adorn_totals()
  
  # Exibir tabela
  datatable(
    despesas_por_resultado,
    caption = "üìä Despesas por Resultado EOF (Dota√ß√£o Atualizada)",
    options = list(dom = 't', pageLength = 10),
    rownames = FALSE
  ) %>%
    formatRound("saldo_r_item_informacao", 2, mark = ".", dec.mark = ",")
} else {
  cat("Dados n√£o dispon√≠veis\n")
}
```

### Despesas Prim√°rias por √ìrg√£o

```{r despesas-primarias-orgao}
#| echo: true
#| label: despesas-primarias-por-orgao

# ==============================================================================
# DESPESAS PRIM√ÅRIAS POR √ìRG√ÉO
# ==============================================================================

if (exists("dados_despesa")) {
  # Definir agrupamento
  agrupado_despesa_orgao <- c("orgao_uge_orgao_maximo_codigo", "orgao_uge_orgao_maximo_nome")
  
  # Agrupar despesas prim√°rias por √≥rg√£o
  despesas_primarias_orgao <- dados_despesa %>% 
    filter(
      resultado_eof_codigo == 6,
      item_informacao_codigo == 23
    ) %>%
    group_by(across(all_of(agrupado_despesa_orgao))) %>%
    summarise(
      saldo_r_item_informacao = sum(saldo_r_item_informacao, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    arrange(desc(saldo_r_item_informacao)) %>%
    janitor::adorn_totals()
  
  # Exibir tabela
  datatable(
    despesas_primarias_orgao,
    caption = "üìä Despesas Prim√°rias por √ìrg√£o (Dota√ß√£o Atualizada)",
    options = list(pageLength = 50, dom = 'ft'),
    rownames = FALSE
  ) %>%
    formatRound("saldo_r_item_informacao", 2, mark = ".", dec.mark = ",")
} else {
  cat("Dados n√£o dispon√≠veis\n")
}
```

### Despesas Prim√°rias por Item de Informa√ß√£o

```{r despesas-primarias-item}
#| echo: true
#| label: despesas-primarias-por-item

# ==============================================================================
# DESPESAS PRIM√ÅRIAS POR ITEM DE INFORMA√á√ÉO
# ==============================================================================
# Compara diferentes est√°gios da despesa
# ==============================================================================

if (exists("dados_despesa")) {
  # Agrupar por item de informa√ß√£o
  despesas_primarias_item <- dados_despesa %>% 
    filter(resultado_eof_codigo == 6) %>%
    group_by(item_informacao_codigo, item_informacao_nome) %>%
    summarise(
      saldo_r_item_informacao = sum(saldo_r_item_informacao, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    arrange(item_informacao_codigo)
  
  # Exibir tabela
  datatable(
    despesas_primarias_item,
    caption = "üìä Despesas Prim√°rias por Item de Informa√ß√£o",
    options = list(dom = 't', pageLength = 15),
    rownames = FALSE
  ) %>%
    formatRound("saldo_r_item_informacao", 2, mark = ".", dec.mark = ",")
} else {
  cat("Dados n√£o dispon√≠veis\n")
}
```

### Despesas Prim√°rias por √ìrg√£o e Item de Informa√ß√£o

```{r despesas-primarias-orgao-item}
#| echo: true
#| label: despesas-primarias-orgao-item

# ==============================================================================
# DESPESAS PRIM√ÅRIAS DETALHADAS POR √ìRG√ÉO E ITEM
# ==============================================================================

if (exists("dados_despesa")) {
  # Agrupar por √≥rg√£o e item
  despesas_primarias_detalhado <- dados_despesa %>% 
    filter(resultado_eof_codigo == 6) %>%
    group_by(
      orgao_uge_orgao_maximo_codigo, 
      orgao_uge_orgao_maximo_nome,
      item_informacao_nome
    ) %>%
    summarise(
      saldo_r_item_informacao = sum(saldo_r_item_informacao, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    # Pivotar para ter itens como colunas
    pivot_wider(
      names_from = item_informacao_nome,
      values_from = saldo_r_item_informacao,
      values_fill = 0
    ) %>%
    arrange(orgao_uge_orgao_maximo_codigo)
  
  # Exibir tabela
  datatable(
    despesas_primarias_detalhado,
    caption = "üìä Despesas Prim√°rias por √ìrg√£o e Est√°gio",
    options = list(pageLength = 50, dom = 'ft', scrollX = TRUE),
    rownames = FALSE
  ) %>%
    formatRound(
      columns = names(despesas_primarias_detalhado)[sapply(despesas_primarias_detalhado, is.numeric)],
      digits = 2, 
      mark = ".", 
      dec.mark = ","
    )
} else {
  cat("Dados n√£o dispon√≠veis\n")
}
```

## üìä Resumo Consolidado

```{r resumo-tabela03}
#| echo: true
#| label: resumo-tabela03

# ==============================================================================
# RESUMO CONSOLIDADO DA TABELA 03
# ==============================================================================

if (exists("despesas_por_resultado") && exists("total_despesas_primarias")) {
  
  # Obter totais
  total_geral <- despesas_por_resultado %>%
    filter(resultado_eof_codigo == "Total" | resultado_eof_nome == "Total") %>%
    pull(saldo_r_item_informacao)
  
  if (length(total_geral) == 0) {
    total_geral <- sum(despesas_por_resultado$saldo_r_item_informacao, na.rm = TRUE)
  }
  
  # Calcular percentual prim√°rio
  percentual_primario <- (total_despesas_primarias / total_geral) * 100
  
  # Resultado no console
  cat("\n")
  cat(strrep("=", 70), "\n")
  cat("RESUMO - RREO TABELA 03\n")
  cat(strrep("=", 70), "\n")
  cat(sprintf("Total de Despesas Prim√°rias:    R$ %s\n",
              format(round(total_despesas_primarias, 2), big.mark = ".", decimal.mark = ",")))
  cat(sprintf("Total Geral de Despesas:        R$ %s\n",
              format(round(total_geral, 2), big.mark = ".", decimal.mark = ",")))
  cat(strrep("-", 70), "\n")
  cat(sprintf("Percentual Prim√°rio:            %.2f%%\n", percentual_primario))
  cat(strrep("=", 70), "\n")
  
  # Criar tabela resumo
  resumo_t03 <- tibble(
    Classifica√ß√£o = c("Despesas Prim√°rias", "Despesas Financeiras", "TOTAL"),
    Valor = c(
      total_despesas_primarias,
      total_geral - total_despesas_primarias,
      total_geral
    ),
    Percentual = c(
      percentual_primario,
      100 - percentual_primario,
      100
    )
  )
  
  knitr::kable(
    resumo_t03 %>%
      mutate(
        Valor = format(round(Valor, 2), big.mark = ".", decimal.mark = ","),
        Percentual = paste0(round(Percentual, 2), "%")
      ),
    caption = "üìä Resumo - Despesas por Resultado EOF",
    col.names = c("Classifica√ß√£o", "Valor (R$)", "Percentual"),
    align = c("l", "r", "r")
  )
  
  # Exportar vari√°veis
  valor_despesas_primarias_t03 <- total_despesas_primarias
  valor_despesas_financeiras_t03 <- total_geral - total_despesas_primarias
  valor_despesas_total_t03 <- total_geral
  
} else {
  cat("Dados n√£o dispon√≠veis para resumo\n")
}
```

## üìã Objetos Exportados

| Objeto | Descri√ß√£o |
|------------------------------------|------------------------------------|
| `agrupado_despesa_orgao` | Vetor de agrupamento por √≥rg√£o |
| `total_despesas_primarias` | Total das despesas prim√°rias |
| `despesas_por_resultado` | Despesas por resultado EOF |
| `despesas_primarias_orgao` | Despesas prim√°rias por √≥rg√£o |
| `despesas_primarias_item` | Despesas prim√°rias por item de informa√ß√£o |
| `despesas_primarias_detalhado` | Despesas por √≥rg√£o e est√°gio |
| `valor_despesas_primarias_t03` | Total prim√°rio para exporta√ß√£o |
| `valor_despesas_financeiras_t03` | Total financeiro para exporta√ß√£o |

## üìå Observa√ß√µes Importantes

1.  **Resultado EOF (Esfera Or√ßament√°rio-Financeira)**:
    -   C√≥digo 6 = Despesas Prim√°rias
    -   Demais c√≥digos = Despesas Financeiras
2.  **Despesas Prim√°rias**:
    -   Afetam o resultado prim√°rio do governo
    -   Excluem juros, encargos e amortiza√ß√£o da d√≠vida
    -   Base para o c√°lculo do super√°vit/d√©ficit prim√°rio
3.  **Despesas Financeiras**:
    -   Juros e encargos da d√≠vida
    -   Amortiza√ß√£o da d√≠vida
    -   Opera√ß√µes financeiras
4.  **Itens de Informa√ß√£o**:
    -   23: Dota√ß√£o Atualizada (LOA + Cr√©ditos)
    -   24: Despesa Empenhada
    -   25: Despesa Liquidada
    -   26: Despesa Paga
5.  **Rela√ß√£o com Resultado Prim√°rio**:
    -   As despesas prim√°rias s√£o componente do resultado prim√°rio
    -   O Anexo 06 do RREO detalha o c√°lculo completo

```{r}
#| label: diagnostico-objetos-vazios
#| code-fold: true
#| eval: false

# ==============================================================================
# DIAGN√ìSTICO: Investigar Objetos Vazios
# ==============================================================================

# Criar consolida√ß√£o tempor√°ria para diagn√≥stico
dados_consolidados_temp <- consolidar_criterios(save_global = FALSE)

cat("\nüìä ESTRUTURA COMPLETA DOS DADOS CONSOLIDADOS:\n\n")

# Ver distribui√ß√£o por relat√≥rio e anexo
dados_consolidados_temp %>%
  group_by(relatorio, anexo_codigo) %>%
  summarise(
    n_linhas = n(),
    detalhes = paste(unique(detalhe), collapse = " | "),
    anexos_nome = paste(unique(anexo_nome), collapse = " | "),
    .groups = "drop"
  ) %>%
  arrange(relatorio, anexo_codigo) %>%
  print(n = 50)

# ==============================================================================
# 1. INVESTIGAR RGF A01 (Pessoal)
# ==============================================================================

cat("\n\nüîç RGF A01 - PESSOAL:\n")

rgf_a01_todos <- dados_consolidados_temp %>%
  filter(relatorio == "rgf", anexo_codigo == "A01")

if (nrow(rgf_a01_todos) == 0) {
  cat("‚ùå Nenhum dado encontrado para RGF A01\n")
  cat("Verificando poss√≠veis varia√ß√µes:\n")
  
  # Tentar outras combina√ß√µes
  dados_consolidados_temp %>%
    filter(grepl("rgf", relatorio, ignore.case = TRUE)) %>%
    distinct(relatorio, anexo_codigo, anexo_nome) %>%
    print()
} else {
  cat(sprintf("‚úÖ Encontrados %d linhas em RGF A01\n", nrow(rgf_a01_todos)))
  cat("\nValores √∫nicos:\n")
  cat("  - detalhe: ", paste(unique(rgf_a01_todos$detalhe), collapse = ", "), "\n")
  cat("  - anexo_nome: ", paste(unique(rgf_a01_todos$anexo_nome), collapse = ", "), "\n")
}

# ==============================================================================
# 2. INVESTIGAR RGF A03 (Garantias)
# ==============================================================================

cat("\n\nüîç RGF A03 - GARANTIAS:\n")

rgf_a03_todos <- dados_consolidados_temp %>%
  filter(relatorio == "rgf", anexo_codigo == "A03")

if (nrow(rgf_a03_todos) == 0) {
  cat("‚ùå Nenhum dado encontrado para RGF A03\n")
} else {
  cat(sprintf("‚úÖ Encontrados %d linhas em RGF A03\n", nrow(rgf_a03_todos)))
}

# ==============================================================================
# 3. INVESTIGAR RGF A05 (Disponibilidades)
# ==============================================================================

cat("\n\nüîç RGF A05 - DISPONIBILIDADES:\n")

# Tentar com 'A05' mai√∫sculo
rgf_a05_maiusculo <- dados_consolidados_temp %>%
  filter(relatorio == "rgf", anexo_codigo == "A05")

# Tentar com 'a05' min√∫sculo
rgf_a05_minusculo <- dados_consolidados_temp %>%
  filter(relatorio == "rgf", anexo_codigo == "a05")

cat(sprintf("  Com 'A05' mai√∫sculo: %d linhas\n", nrow(rgf_a05_maiusculo)))
cat(sprintf("  Com 'a05' min√∫sculo: %d linhas\n", nrow(rgf_a05_minusculo)))

if (nrow(rgf_a05_maiusculo) == 0 && nrow(rgf_a05_minusculo) == 0) {
  cat("‚ùå Nenhum dado encontrado para RGF A05\n")
  cat("C√≥digos de anexo dispon√≠veis em RGF:\n")
  dados_consolidados_temp %>%
    filter(relatorio == "rgf") %>%
    distinct(anexo_codigo) %>%
    arrange(anexo_codigo) %>%
    print()
}

# ==============================================================================
# 4. INVESTIGAR RREO A01 - Balan√ßo Or√ßament√°rio (Receitas/Despesas)
# ==============================================================================

cat("\n\nüîç RREO A01 - BALAN√áO OR√áAMENT√ÅRIO:\n")

rreo_a01_todos <- dados_consolidados_temp %>%
  filter(relatorio == "rreo", anexo_codigo == "A01")

cat(sprintf("Total: %d linhas\n", nrow(rreo_a01_todos)))
cat("\nValores √∫nicos de 'detalhe':\n")
print(unique(rreo_a01_todos$detalhe))

# Testar filtros
bo_receitas_teste <- rreo_a01_todos %>%
  filter(grepl("receitas", detalhe, ignore.case = TRUE))

bo_despesas_teste <- rreo_a01_todos %>%
  filter(grepl("despesas", detalhe, ignore.case = TRUE))

cat(sprintf("\nCom filtro 'receitas': %d linhas\n", nrow(bo_receitas_teste)))
cat(sprintf("Com filtro 'despesas': %d linhas\n", nrow(bo_despesas_teste)))

# ==============================================================================
# 5. RESUMO DE TODOS OS C√ìDIGOS DISPON√çVEIS
# ==============================================================================

cat("\n\nüìã TODOS OS C√ìDIGOS DISPON√çVEIS:\n\n")

dados_consolidados_temp %>%
  group_by(relatorio, anexo_codigo) %>%
  summarise(n = n(), .groups = "drop") %>%
  arrange(relatorio, anexo_codigo) %>%
  print(n = 50)
```

# PARTE FINAL - VALIDA√á√ïES

# Resumo Executivo

Este chunk apresenta um resumo r√°pido dos principais indicadores calculados.

```{r resumo-executivo}
#| echo: false
#| label: resumo-executivo

# ==============================================================================
# RESUMO EXECUTIVO - PRINCIPAIS INDICADORES
# ==============================================================================

# Fun√ß√£o auxiliar para formatar valores em bilh√µes (com tratamento robusto)
fmt_bi <- function(x) {
  tryCatch({
    x_num <- as.numeric(x)
    if (is.na(x_num) || length(x_num) == 0) return("-")
    format(round(x_num / 1e9, 2), big.mark = ".", decimal.mark = ",", nsmall = 2)
  }, error = function(e) "-")
}

# Fun√ß√£o para formatar valores em milh√µes
fmt_mi <- function(x) {
  tryCatch({
    x_num <- as.numeric(x)
    if (is.na(x_num) || length(x_num) == 0) return("-")
    format(round(x_num / 1e6, 2), big.mark = ".", decimal.mark = ",", nsmall = 2)
  }, error = function(e) "-")
}

# Fun√ß√£o para extrair valor com seguran√ßa
safe_extract <- function(expr) {
  tryCatch(as.numeric(expr), error = function(e) NA_real_)
}

# ==============================================================================
# COLETA DOS VALORES
# ==============================================================================

# RCL
v_rcl <- safe_extract(if (exists("rcl_12_meses")) sum(rcl_12_meses$resultado, na.rm = TRUE) else NA_real_)

# Despesa com Pessoal Total
v_pessoal <- safe_extract(if (exists("pessoal")) sum(pessoal$valor, na.rm = TRUE) else NA_real_)

# Pessoal Civil e Militar (Tabela 2)
v_pessoal_civil <- safe_extract(if (exists("df_criterios_rreo_T02_despesas_T02")) {
  df_criterios_rreo_T02_despesas_T02 %>% 
    filter(grepl("CIVIL|Civil", categoria, ignore.case = TRUE)) %>% 
    summarise(v = sum(valor, na.rm = TRUE)) %>% pull(v)
} else NA_real_)

v_pessoal_militar <- safe_extract(if (exists("df_criterios_rreo_T02_despesas_T02")) {
  df_criterios_rreo_T02_despesas_T02 %>% 
    filter(grepl("MILITAR|Militar", categoria, ignore.case = TRUE)) %>% 
    summarise(v = sum(valor, na.rm = TRUE)) %>% pull(v)
} else NA_real_)

# DCL - tentar m√∫ltiplas vari√°veis
v_dcl <- safe_extract(
  if (exists("valor_dcl_num") && !is.na(valor_dcl_num)) valor_dcl_num else
  if (exists("valor_dcl") && !is.na(as.numeric(valor_dcl))) as.numeric(valor_dcl) else
  if (exists("divida_consolidada")) as.numeric(divida_consolidada) else NA_real_
)

# Resultado Prim√°rio e Nominal
v_res_prim <- safe_extract(if (exists("resultado_primario") && is.data.frame(resultado_primario)) {
  resultado_primario %>% filter(grepl("RESULTADO PRIM√ÅRIO|RESULTADO PRIMARIO", componente)) %>% pull(valor) %>% first()
} else if (exists("valor_resultado_primario")) valor_resultado_primario else NA_real_)

v_res_nominal <- safe_extract(if (exists("valor_resultado_nominal")) valor_resultado_nominal else NA_real_)

# Regimes Previdenci√°rios
v_rgps <- safe_extract(if (exists("df_resultado_rgps")) {
  df_resultado_rgps %>% filter(grepl("Resultado", Tipo)) %>% pull(Valor) %>% first()
} else NA_real_)

v_rpps_civil <- safe_extract(if (exists("df_resultado_rpps_civil")) {
  df_resultado_rpps_civil %>% filter(grepl("Resultado", Tipo)) %>% pull(Valor) %>% first()
} else NA_real_)

v_rpps_militar <- safe_extract(if (exists("df_resultado_rpps_militar")) {
  df_resultado_rpps_militar %>% filter(grepl("Resultado", Tipo)) %>% pull(Valor) %>% first()
} else NA_real_)

v_fcdf <- safe_extract(if (exists("df_resultado_fcdf")) {
  df_resultado_fcdf %>% filter(grepl("Resultado", Tipo)) %>% pull(Valor) %>% first()
} else NA_real_)

# Tabela 3 - Despesas Prim√°rias
v_tabela3 <- safe_extract(if (exists("dados_despesa")) {
  dados_despesa %>% 
    filter(resultado_eof_codigo == 6, item_informacao_codigo == 23) %>% 
    summarise(v = sum(saldo_r_item_informacao, na.rm = TRUE)) %>% pull(v)
} else NA_real_)

# Resultado Seguridade (Tabela 1)
v_seguridade <- safe_extract(if (exists("resultado_seguridade")) resultado_seguridade else {
  if (exists("df_criterios_rreo_T01_receitas") && exists("df_criterios_rreo_T01_despesas_T01")) {
    rec <- df_criterios_rreo_T01_receitas %>% filter(ordem == "14") %>% pull(valor) %>% first()
    desp <- df_criterios_rreo_T01_despesas_T01 %>% filter(ordem == "11") %>% pull(valor) %>% first()
    as.numeric(rec) - as.numeric(desp)
  } else NA_real_
})

# Disponibilidade de Caixa (RGF A05)
# Vari√°veis calculadas no chunk rgf-a05: valor_disponibilidade_executivo e valor_disponibilidade_uniao
# - Meses normais: disponibilidade_antes_inscr_rp_clean
# - Dezembro: disponibilidade ap√≥s inscri√ß√£o de RP (ajustar no chunk original se necess√°rio)

v_disp_executivo <- safe_extract({
  if (exists("valor_disponibilidade_executivo") && length(valor_disponibilidade_executivo) > 0) {
    as.numeric(valor_disponibilidade_executivo)
  } else if (exists("rgf_a05_executivo_formatada")) {
    # A linha de total pode ser "Total", "-" ou a √∫ltima linha
    df_temp <- rgf_a05_executivo_formatada
    linha_total <- df_temp %>% filter(linhas %in% c("Total", "-")) 
    if (nrow(linha_total) > 0) {
      linha_total %>% pull(disponibilidade_antes_inscr_rp_clean) %>% first()
    } else {
      # Pegar √∫ltima linha (total adicionado por adorn_totals)
      df_temp %>% tail(1) %>% pull(disponibilidade_antes_inscr_rp_clean)
    }
  } else NA_real_
})

v_disp_uniao <- safe_extract({
  if (exists("valor_disponibilidade_uniao") && length(valor_disponibilidade_uniao) > 0) {
    as.numeric(valor_disponibilidade_uniao)
  } else if (exists("rgf_a05_uniao_formatada")) {
    # A linha de total pode ser "Total", "-" ou a √∫ltima linha
    df_temp <- rgf_a05_uniao_formatada
    linha_total <- df_temp %>% filter(linhas %in% c("Total", "-"))
    if (nrow(linha_total) > 0) {
      linha_total %>% pull(disponibilidade_antes_inscr_rp_clean) %>% first()
    } else {
      # Pegar √∫ltima linha (total adicionado por adorn_totals)
      df_temp %>% tail(1) %>% pull(disponibilidade_antes_inscr_rp_clean)
    }
  } else NA_real_
})

# Regra de Ouro
v_regra_ouro <- safe_extract(if (exists("regra_ouro")) regra_ouro else NA_real_)
status_regra <- if (exists("status_regra_ouro")) status_regra_ouro else 
                if (!is.na(v_regra_ouro)) ifelse(v_regra_ouro > 0, "N√ÉO CUMPRIDA", "CUMPRIDA") else "-"

# MDE e ASPS
v_mde_pct <- safe_extract(if (exists("percentual_aplicacao")) as.numeric(percentual_aplicacao) else NA_real_)

# ASPS - tentar m√∫ltiplas vari√°veis (pct_cumprimento √© calculado no chunk de sa√∫de)
v_asps_pct <- safe_extract({
  val <- NA_real_
  if (exists("pct_cumprimento") && !is.null(pct_cumprimento) && length(pct_cumprimento) > 0) {
    val <- as.numeric(pct_cumprimento)
    # Se o valor vier muito alto (>1000), provavelmente j√° est√° multiplicado por 100 ou 1000
    if (!is.na(val) && val > 1000) val <- val / 1000
  } else if (exists("percentual_cumprimento_saude")) {
    val <- as.numeric(percentual_cumprimento_saude)
  } else if (exists("total_despesas_computadas") && exists("minimo_saude")) {
    # Calcular diretamente se temos os componentes
    ms <- if (is.data.frame(minimo_saude)) {
      (as.numeric(minimo_saude$receitas) - as.numeric(minimo_saude$deducoes) + as.numeric(minimo_saude$rp_cancelado)) * 0.15
    } else as.numeric(minimo_saude)
    if (!is.na(ms) && ms != 0) {
      # total_despesas_computadas j√° est√° em R$, minimo_saude tamb√©m
      val <- (as.numeric(total_despesas_computadas) / ms) * 100
    }
  }
  val
})

# ==============================================================================
# TABELA 1: PRINCIPAIS INDICADORES FISCAIS
# ==============================================================================

indicadores_fiscais <- tibble(
  Indicador = c(
    "üìä RCL (12 meses)",
    "üìä Despesa Total com Pessoal",
    "üìä D√≠vida Consolidada L√≠quida",
    "üìä Resultado Prim√°rio",
    "üìä Resultado Nominal"
  ),
  `Valor (R$ bi)` = c(
    fmt_bi(v_rcl),
    fmt_bi(v_pessoal),
    fmt_bi(v_dcl),
    fmt_bi(v_res_prim),
    fmt_bi(v_res_nominal)
  ),
  Status = c(
    "Base de c√°lculo",
    if (!is.na(v_pessoal)) "Verificar limite" else "-",
    if (!is.na(v_dcl)) "Verificar limite" else "-",
    if (!is.na(v_res_prim)) ifelse(v_res_prim >= 0, "‚úÖ Super√°vit", "‚ö†Ô∏è D√©ficit") else "-",
    if (!is.na(v_res_nominal)) ifelse(v_res_nominal >= 0, "‚úÖ Super√°vit", "‚ö†Ô∏è D√©ficit") else "-"
  )
)

cat("\n")
cat("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n")
cat("                    INDICADORES FISCAIS PRINCIPAIS\n")
cat("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n")

knitr::kable(
  indicadores_fiscais,
  caption = paste("Resumo Executivo -", if(exists("mes_filtro")) mes_filtro else ""),
  align = c("l", "r", "c")
)

# ==============================================================================
# TABELA 2: PREVID√äNCIA - RESULTADOS POR REGIME
# ==============================================================================

indicadores_prev <- tibble(
  Regime = c(
    "RGPS - Regime Geral",
    "RPPS - Servidores Civis",
    "RPPS - Militares",
    "FCDF - Fundo Constitucional DF"
  ),
  `Resultado (R$ bi)` = c(
    fmt_bi(v_rgps),
    fmt_bi(v_rpps_civil),
    fmt_bi(v_rpps_militar),
    fmt_bi(v_fcdf)
  ),
  Status = c(
    if (!is.na(v_rgps)) ifelse(v_rgps >= 0, "‚úÖ Super√°vit", "‚ö†Ô∏è D√©ficit") else "-",
    if (!is.na(v_rpps_civil)) ifelse(v_rpps_civil >= 0, "‚úÖ Super√°vit", "‚ö†Ô∏è D√©ficit") else "-",
    if (!is.na(v_rpps_militar)) ifelse(v_rpps_militar >= 0, "‚úÖ Super√°vit", "‚ö†Ô∏è D√©ficit") else "-",
    if (!is.na(v_fcdf)) ifelse(v_fcdf >= 0, "‚úÖ Super√°vit", "‚ö†Ô∏è D√©ficit") else "-"
  )
)

cat("\n")
cat("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n")
cat("                    PREVID√äNCIA - RESULTADOS POR REGIME\n")
cat("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n")

knitr::kable(
  indicadores_prev,
  align = c("l", "r", "c")
)

# ==============================================================================
# TABELA 3: DESPESAS COM PESSOAL (TABELA 2)
# ==============================================================================

indicadores_pessoal <- tibble(
  Categoria = c(
    "Pessoal Civil",
    "Pessoal Militar"
  ),
  `Valor (R$ bi)` = c(
    fmt_bi(v_pessoal_civil),
    fmt_bi(v_pessoal_militar)
  )
)

cat("\n")
cat("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n")
cat("                    DESPESAS COM PESSOAL (TABELA 2)\n")
cat("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n")

knitr::kable(
  indicadores_pessoal,
  align = c("l", "r")
)

# ==============================================================================
# TABELA 4: OUTROS INDICADORES
# ==============================================================================

indicadores_outros <- tibble(
  Indicador = c(
    "üìã Tabela 3 - Despesas Prim√°rias",
    "üìã Tabela 1 - Resultado Seguridade",
    "üìã Regra de Ouro",
    "üìã Disponibilidade Caixa - Executivo",
    "üìã Disponibilidade Caixa - Uni√£o"
  ),
  `Valor (R$ bi)` = c(
    fmt_bi(v_tabela3),
    fmt_bi(v_seguridade),
    fmt_bi(v_regra_ouro),
    fmt_bi(v_disp_executivo),
    fmt_bi(v_disp_uniao)
  ),
  Status = c(
    "-",
    if (!is.na(v_seguridade)) ifelse(v_seguridade >= 0, "‚úÖ Super√°vit", "‚ö†Ô∏è D√©ficit") else "-",
    status_regra,
    "-",
    "-"
  )
)

cat("\n")
cat("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n")
cat("                    OUTROS INDICADORES\n")
cat("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n")

knitr::kable(
  indicadores_outros,
  align = c("l", "r", "c")
)

# ==============================================================================
# TABELA 5: APLICA√á√ïES CONSTITUCIONAIS
# ==============================================================================

indicadores_const <- tibble(
  Indicador = c(
    "üéì Aplica√ß√£o em MDE",
    "üè• Aplica√ß√£o em ASPS"
  ),
  Percentual = c(
    if (!is.na(v_mde_pct)) paste0(round(v_mde_pct, 2), "%") else "-",
    if (!is.na(v_asps_pct)) paste0(round(v_asps_pct, 2), "%") else "-"
  ),
  Status = c(
    if (!is.na(v_mde_pct) && v_mde_pct >= 100) "‚úÖ Atende" else "‚ö†Ô∏è Verificar",
    if (!is.na(v_asps_pct) && v_asps_pct >= 100) "‚úÖ Atende" else "‚ö†Ô∏è Verificar"
  )
)

cat("\n")
cat("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n")
cat("                    APLICA√á√ïES CONSTITUCIONAIS\n")
cat("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n")

knitr::kable(
  indicadores_const,
  align = c("l", "r", "c")
)

cat("\n")
```

# Valida√ß√£o RREO

Compara√ß√£o dos valores calculados pelo sistema com o RREO Anexo 14 oficial.

## Fun√ß√µes Auxiliares

```{r funcoes-validacao}
#| echo: true
#| label: funcoes-validacao

# ==============================================================================
# FUN√á√ïES AUXILIARES PARA VALIDA√á√ÉO
# ==============================================================================

# Ler c√©lula do Excel com seguran√ßa
ler_celula <- function(arquivo, celula, sheet = 1) {
  tryCatch({
    read_excel(arquivo, sheet = sheet, range = celula, col_names = FALSE)[[1]][1]
  }, error = function(e) NA_real_)
}

# Extrair valor de dataframe com seguran√ßa
extrair_valor <- function(df, filtro_col, filtro_valor, coluna_valor = "Valor") {
  tryCatch({
    resultado <- df %>% filter(!!sym(filtro_col) == filtro_valor)
    if (nrow(resultado) == 0) return(NA_real_)
    val <- resultado[[coluna_valor]][1]
    if (is.null(val) || length(val) == 0) return(NA_real_)
    return(as.numeric(val))
  }, error = function(e) NA_real_)
}

# Comparar sistema vs oficial
comparar_valores <- function(df_oficial, df_sistema) {
  df_oficial %>%
    left_join(df_sistema %>% select(item, sistema = valor_milhar), by = "item") %>%
    mutate(
      diferenca = sistema - valor_oficial,
      dif_pct = ifelse(!is.na(valor_oficial) & valor_oficial != 0,
                       (diferenca / abs(valor_oficial)) * 100, NA_real_),
      status = case_when(
        is.na(valor_oficial) ~ "Sem oficial",
        is.na(sistema) ~ "Sem sistema",
        abs(diferenca) < 0.5 ~ "OK",
        abs(dif_pct) < 0.1 ~ "OK",
        abs(dif_pct) <= 1 ~ "Verificar",
        TRUE ~ "DIVERGENTE"
      )
    ) %>%
    select(item, descricao, fonte, celula, oficial = valor_oficial, sistema, diferenca, dif_pct, status)
}

# Exibir tabela de valida√ß√£o formatada
exibir_validacao <- function(df, titulo) {
  
  # Resumo por status
  resumo <- df %>% count(status)
  cat(sprintf("\n=== %s ===\n", titulo))
  for (i in 1:nrow(resumo)) {
    cat(sprintf("  %s: %d\n", resumo$status[i], resumo$n[i]))
  }
  
  # Tabela formatada
  df %>%
    mutate(
      oficial = ifelse(is.na(oficial), "-", format(round(oficial, 0), big.mark = ".", decimal.mark = ",")),
      sistema = ifelse(is.na(sistema), "-", format(round(sistema, 0), big.mark = ".", decimal.mark = ",")),
      diferenca = ifelse(is.na(diferenca), "-", format(round(diferenca, 0), big.mark = ".", decimal.mark = ",")),
      dif_pct = ifelse(is.na(dif_pct), "-", paste0(format(round(dif_pct, 1), nsmall = 1), "%"))
    ) %>%
    datatable(
      caption = titulo,
      options = list(pageLength = 50, dom = 't',
        columnDefs = list(list(className = 'dt-right', targets = c(4, 5, 6, 7)))),
      rownames = FALSE
    ) %>%
    formatStyle('status', backgroundColor = styleEqual(
      c("OK", "Verificar", "DIVERGENTE", "Sem oficial", "Sem sistema"),
      c("#90EE90", "#FFD700", "#FF6B6B", "#D3D3D3", "#D3D3D3")
    ))
}
```

## Mapeamento RREO Anexo 14

```{r mapa-rreo-a14}
#| echo: true
#| label: mapa-rreo-a14

# ==============================================================================
# MAPEAMENTO DAS C√âLULAS DO RREO ANEXO 14 SIMPLIFICADO
# ==============================================================================

mapa_rreo_a14 <- tribble(
  ~item, ~celula, ~descricao, ~fonte,
  
  # Balan√ßo Or√ßament√°rio - Receitas (Anexo 1)
  "bo_previsao_inicial",    "B10", "BO - Previs√£o Inicial Receita", "A01",
  "bo_previsao_atualizada", "B11", "BO - Previs√£o Atualizada", "A01",
  "bo_receitas_realizadas", "B12", "BO - Receitas Realizadas", "A01",
  "bo_saldos_anteriores",   "B14", "BO - Saldos Exerc. Anteriores", "A01",
  
  # Balan√ßo Or√ßament√°rio - Despesas (Anexo 2)
  "bo_dotacao_inicial",     "B17", "BO - Dota√ß√£o Inicial", "A02",
  "bo_dotacao_atualizada",  "B18", "BO - Dota√ß√£o Atualizada", "A02",
  "bo_despesas_empenhadas", "B19", "BO - Despesas Empenhadas", "A02",
  "bo_despesas_liquidadas", "B20", "BO - Despesas Liquidadas", "A02",
  "bo_despesas_pagas",      "E21", "BO - Despesas Pagas", "A02",
  "bo_superavit",           "B22", "BO - Super√°vit Or√ßament√°rio", "A02",
  
  # Despesas por Fun√ß√£o (exceto refinanciamento)
  "funcao_empenhadas",      "B25", "Fun√ß√£o - Desp. Empenhadas", "A02",
  "funcao_liquidadas",      "B26", "Fun√ß√£o - Desp. Liquidadas", "A02",
  
  # RCL (Anexo 3)
  "rcl",                    "B29", "Receita Corrente L√≠quida", "A03",
  
  # RGPS (Anexo 4)
  "rgps_receitas",          "B32", "RGPS - Receitas", "A04",
  "rgps_despesas",          "B33", "RGPS - Despesas", "A04",
  "rgps_resultado",         "B34", "RGPS - Resultado", "A04",
  
  # RPPS Civil (Anexo 4)
  "rpps_receitas",          "B36", "RPPS Civil - Receitas", "A04",
  "rpps_despesas",          "B37", "RPPS Civil - Despesas", "A04",
  "rpps_resultado",         "B38", "RPPS Civil - Resultado", "A04",
  
  # Militares (Anexo 4)
  "militar_receitas",       "B40", "Militares - Receitas", "A04",
  "militar_despesas",       "B41", "Militares - Despesas", "A04",
  "militar_resultado",      "B42", "Militares - Resultado", "A04",
  
  # FCDF (Anexo 4)
  "fcdf_receitas",          "B44", "FCDF - Receitas", "A04",
  "fcdf_despesas",          "B45", "FCDF - Despesas", "A04",
  "fcdf_resultado",         "B46", "FCDF - Resultado", "A04",
  
  # Resultados (Anexo 6)
  "resultado_nominal",      "B58", "Resultado Nominal", "A06",
  "resultado_primario",     "B59", "Resultado Prim√°rio", "A06",
  
  # Restos a Pagar Processados (Anexo 7)
  "rpp_inscricao",          "B62", "RP Proc - Inscri√ß√£o", "A07",
  "rpp_cancelamento",       "C62", "RP Proc - Cancelamento", "A07",
  "rpp_pagamento",          "D62", "RP Proc - Pagamento", "A07",
  "rpp_saldo",              "E62", "RP Proc - Saldo", "A07",
  
  # Restos a Pagar N√£o Processados (Anexo 7)
  "rpnp_inscricao",         "B68", "RPNP - Inscri√ß√£o", "A07",
  "rpnp_cancelamento",      "C68", "RPNP - Cancelamento", "A07",
  "rpnp_pagamento",         "D68", "RPNP - Pagamento", "A07",
  "rpnp_saldo",             "E68", "RPNP - Saldo", "A07",
  
  # MDE (Anexo 8)
  "mde_aplicado",           "B77", "MDE - Valor Aplicado", "A08",
  "mde_minimo",             "C77", "MDE - M√≠nimo a Aplicar", "A08",
  "fundeb_complementacao",  "B79", "Complementa√ß√£o FUNDEB", "A08",
  
  # ASPS (Anexo 12)
  "asps_aplicado",          "B82", "ASPS - Valor Aplicado", "A12",
  "asps_minimo",            "C82", "ASPS - M√≠nimo a Aplicar", "A12"
)
```

## Coleta de Valores do Sistema

```{r valores-sistema-rreo}
#| echo: true
#| label: valores-sistema-rreo

# ==============================================================================
# COLETA DOS VALORES CALCULADOS PELO SISTEMA - RREO
# ==============================================================================

# Fun√ß√£o auxiliar para extrair valor num√©rico com seguran√ßa
safe_num_rreo <- function(x) {
  tryCatch({
    val <- as.numeric(x)
    if (length(val) == 0 || all(is.na(val))) return(NA_real_)
    return(val[1])
  }, error = function(e) NA_real_)
}

# RCL
valor_rcl <- tryCatch({
  if (exists("rcl_12_meses")) safe_num_rreo(sum(rcl_12_meses$resultado, na.rm = TRUE)) else NA_real_
}, error = function(e) NA_real_)

# RGPS
valor_rgps_rec <- if (exists("df_resultado_rgps")) safe_num_rreo(extrair_valor(df_resultado_rgps, "Tipo", "Receita_RGPS")) else NA_real_
valor_rgps_desp <- if (exists("df_resultado_rgps")) safe_num_rreo(extrair_valor(df_resultado_rgps, "Tipo", "Despesa_RGPS")) else NA_real_
valor_rgps_res <- if (exists("df_resultado_rgps")) safe_num_rreo(extrair_valor(df_resultado_rgps, "Tipo", "Resultado_RGPS")) else NA_real_

# RPPS Civil
valor_rpps_rec <- if (exists("df_resultado_rpps_civil")) safe_num_rreo(extrair_valor(df_resultado_rpps_civil, "Tipo", "Receita_RPPS_Civil")) else NA_real_
valor_rpps_desp <- if (exists("df_resultado_rpps_civil")) safe_num_rreo(extrair_valor(df_resultado_rpps_civil, "Tipo", "Despesa_RPPS_Civil")) else NA_real_
valor_rpps_res <- if (exists("df_resultado_rpps_civil")) safe_num_rreo(extrair_valor(df_resultado_rpps_civil, "Tipo", "Resultado_RPPS_Civil")) else NA_real_

# RPPS Militar
valor_mil_rec <- if (exists("df_resultado_rpps_militar")) safe_num_rreo(extrair_valor(df_resultado_rpps_militar, "Tipo", "Receita_RPPS_Militar")) else NA_real_
valor_mil_desp <- if (exists("df_resultado_rpps_militar")) safe_num_rreo(extrair_valor(df_resultado_rpps_militar, "Tipo", "Despesa_RPPS_Militar")) else NA_real_
valor_mil_res <- if (exists("df_resultado_rpps_militar")) safe_num_rreo(extrair_valor(df_resultado_rpps_militar, "Tipo", "Resultado_RPPS_Militar")) else NA_real_

# FCDF
valor_fcdf_rec <- if (exists("df_resultado_fcdf")) safe_num_rreo(extrair_valor(df_resultado_fcdf, "Tipo", "Receita_FCDF")) else NA_real_
valor_fcdf_desp <- if (exists("df_resultado_fcdf")) safe_num_rreo(extrair_valor(df_resultado_fcdf, "Tipo", "Despesa_FCDF")) else NA_real_
valor_fcdf_res <- if (exists("df_resultado_fcdf")) safe_num_rreo(extrair_valor(df_resultado_fcdf, "Tipo", "Resultado_FCDF")) else NA_real_

# Resultado Prim√°rio e Nominal (fonte: rp_claude.xlsm)
arquivo_rp <- str_c(mes_pasta, "rp_claude.xlsm")
valor_res_prim <- tryCatch({
  if (file.exists(arquivo_rp)) {
    safe_num_rreo(read_excel(arquivo_rp, sheet = "Anexo 6 RP e RN Novo (INTERNET)", range = "E53", col_names = FALSE)[[1]][1]) * 1000
  } else NA_real_
}, error = function(e) NA_real_)

valor_res_nominal <- tryCatch({
  if (file.exists(arquivo_rp)) {
    safe_num_rreo(read_excel(arquivo_rp, sheet = "Anexo 6 RP e RN Novo (INTERNET)", range = "C60", col_names = FALSE)[[1]][1]) * 1000
  } else NA_real_
}, error = function(e) NA_real_)

# MDE
valor_mde <- if (exists("total_despesas_mde")) safe_num_rreo(total_despesas_mde) else NA_real_
valor_mde_minimo <- if (exists("rli_atual")) safe_num_rreo(rli_atual) else NA_real_
valor_fundeb <- if (exists("complementacao_fundeb")) safe_num_rreo(complementacao_fundeb) else NA_real_

# Balan√ßo Or√ßament√°rio - Receitas
valor_bo_prev_ini <- tryCatch({ safe_num_rreo(dados_receita %>% filter(item_informacao_codigo == "1") %>% summarise(v = sum(saldo_r_item_informacao, na.rm = TRUE)) %>% pull(v)) }, error = function(e) NA_real_)
valor_bo_prev_atu <- valor_bo_prev_ini
valor_bo_rec_rea <- tryCatch({ safe_num_rreo(dados_receita %>% filter(item_informacao_codigo == "5") %>% summarise(v = sum(saldo_r_item_informacao, na.rm = TRUE)) %>% pull(v)) }, error = function(e) NA_real_)
valor_bo_saldos_ant <- tryCatch({
  safe_num_rreo(balancete %>% filter(startsWith(conta_contabil_numero, "5221"), conta_contabil_numero %in% c("522190101", "522190201", "522130300", "522130200", "522130100", "522190109", "522190209")) %>%
    summarise(v = sum(saldo_r_conta_contabil, na.rm = TRUE)) %>% pull(v))
}, error = function(e) NA_real_)

# Balan√ßo Or√ßament√°rio - Despesas
valor_bo_dot_ini <- tryCatch({ safe_num_rreo(dados_despesa %>% filter(item_informacao_codigo == "9") %>% summarise(v = sum(saldo_r_item_informacao, na.rm = TRUE)) %>% pull(v)) }, error = function(e) NA_real_)
valor_bo_dot_atu <- tryCatch({ safe_num_rreo(dados_despesa %>% filter(item_informacao_codigo == "13") %>% summarise(v = sum(saldo_r_item_informacao, na.rm = TRUE)) %>% pull(v)) }, error = function(e) NA_real_)
valor_bo_emp <- tryCatch({ safe_num_rreo(dados_despesa %>% filter(item_informacao_codigo == "23") %>% summarise(v = sum(saldo_r_item_informacao, na.rm = TRUE)) %>% pull(v)) }, error = function(e) NA_real_)
valor_bo_liq <- tryCatch({ safe_num_rreo(dados_despesa %>% filter(item_informacao_codigo == "25") %>% summarise(v = sum(saldo_r_item_informacao, na.rm = TRUE)) %>% pull(v)) }, error = function(e) NA_real_)
valor_bo_pag <- tryCatch({ safe_num_rreo(dados_despesa %>% filter(item_informacao_codigo == "28") %>% summarise(v = sum(saldo_r_item_informacao, na.rm = TRUE)) %>% pull(v)) }, error = function(e) NA_real_)
valor_bo_superavit <- tryCatch({ safe_num_rreo(valor_bo_rec_rea) - safe_num_rreo(valor_bo_liq) }, error = function(e) NA_real_)

# Despesas por Fun√ß√£o (exceto refinanciamento)
valor_funcao_emp <- tryCatch({ safe_num_rreo(dados_despesa %>% filter(item_informacao_codigo == "23", refinanciamento == "nao") %>% summarise(v = sum(saldo_r_item_informacao, na.rm = TRUE)) %>% pull(v)) }, error = function(e) NA_real_)
valor_funcao_liq <- tryCatch({ safe_num_rreo(dados_despesa %>% filter(item_informacao_codigo == "25", refinanciamento == "nao") %>% summarise(v = sum(saldo_r_item_informacao, na.rm = TRUE)) %>% pull(v)) }, error = function(e) NA_real_)

# Restos a Pagar
valor_rpp_insc <- tryCatch({ safe_num_rreo(dados_rp_anexo_07 %>% filter(mes_lancamento == mes_filtro, grepl("Processados Inscritos", item_informacao_nome)) %>% summarise(v = sum(saldo_r_item_informacao, na.rm = TRUE)) %>% pull(v)) }, error = function(e) NA_real_)
valor_rpp_cancel <- tryCatch({ safe_num_rreo(dados_rp_anexo_07 %>% filter(mes_lancamento == mes_filtro, item_informacao_nome == "RP Processados Cancelados") %>% summarise(v = sum(saldo_r_item_informacao, na.rm = TRUE)) %>% pull(v)) }, error = function(e) NA_real_)
valor_rpp_pag <- tryCatch({ safe_num_rreo(dados_rp_anexo_07 %>% filter(mes_lancamento == mes_filtro, item_informacao_nome == "RP Processados Pagos") %>% summarise(v = sum(saldo_r_item_informacao, na.rm = TRUE)) %>% pull(v)) }, error = function(e) NA_real_)
valor_rpp_saldo <- tryCatch({ safe_num_rreo(dados_rp_anexo_07 %>% filter(mes_lancamento == mes_filtro, grepl("Processados a Pagar", item_informacao_nome)) %>% summarise(v = sum(saldo_r_item_informacao, na.rm = TRUE)) %>% pull(v)) }, error = function(e) NA_real_)

valor_rpnp_insc <- tryCatch({ safe_num_rreo(dados_rp_anexo_07 %>% filter(mes_lancamento == mes_filtro, grepl("RPNP Inscritos", item_informacao_nome)) %>% summarise(v = sum(saldo_r_item_informacao, na.rm = TRUE)) %>% pull(v)) }, error = function(e) NA_real_)
valor_rpnp_cancel <- tryCatch({ safe_num_rreo(dados_rp_anexo_07 %>% filter(mes_lancamento == mes_filtro, item_informacao_nome == "RPNP Cancelados") %>% summarise(v = sum(saldo_r_item_informacao, na.rm = TRUE)) %>% pull(v)) }, error = function(e) NA_real_)
valor_rpnp_pag <- tryCatch({ safe_num_rreo(dados_rp_anexo_07 %>% filter(mes_lancamento == mes_filtro, item_informacao_nome == "RPNP Pagos") %>% summarise(v = sum(saldo_r_item_informacao, na.rm = TRUE)) %>% pull(v)) }, error = function(e) NA_real_)
valor_rpnp_saldo <- tryCatch({ safe_num_rreo(dados_rp_anexo_07 %>% filter(mes_lancamento == mes_filtro, grepl("RPNP a Pagar", item_informacao_nome)) %>% summarise(v = sum(saldo_r_item_informacao, na.rm = TRUE)) %>% pull(v)) }, error = function(e) NA_real_)

# ASPS
valor_asps <- if (exists("total_despesas_computadas")) safe_num_rreo(total_despesas_computadas) else NA_real_
valor_asps_minimo <- if (exists("minimo_saude")) {
  tryCatch({
    if (is.data.frame(minimo_saude)) {
      (safe_num_rreo(minimo_saude$receitas) - safe_num_rreo(minimo_saude$deducoes) + safe_num_rreo(minimo_saude$rp_cancelado)) * 0.15
    } else {
      safe_num_rreo(minimo_saude)
    }
  }, error = function(e) NA_real_)
} else NA_real_

# Montar dataframe do sistema (for√ßando valores num√©ricos)
sistema_rreo <- tibble(
  item = c(
    "bo_previsao_inicial", "bo_previsao_atualizada", "bo_receitas_realizadas", "bo_saldos_anteriores",
    "bo_dotacao_inicial", "bo_dotacao_atualizada", "bo_despesas_empenhadas", "bo_despesas_liquidadas", 
    "bo_despesas_pagas", "bo_superavit",
    "funcao_empenhadas", "funcao_liquidadas",
    "rcl",
    "rgps_receitas", "rgps_despesas", "rgps_resultado",
    "rpps_receitas", "rpps_despesas", "rpps_resultado",
    "militar_receitas", "militar_despesas", "militar_resultado",
    "fcdf_receitas", "fcdf_despesas", "fcdf_resultado",
    "resultado_nominal", "resultado_primario",
    "rpp_inscricao", "rpp_cancelamento", "rpp_pagamento", "rpp_saldo",
    "rpnp_inscricao", "rpnp_cancelamento", "rpnp_pagamento", "rpnp_saldo",
    "mde_aplicado", "mde_minimo", "fundeb_complementacao",
    "asps_aplicado", "asps_minimo"
  ),
  valor = as.numeric(c(
    valor_bo_prev_ini, valor_bo_prev_atu, valor_bo_rec_rea, valor_bo_saldos_ant,
    valor_bo_dot_ini, valor_bo_dot_atu, valor_bo_emp, valor_bo_liq,
    valor_bo_pag, valor_bo_superavit,
    valor_funcao_emp, valor_funcao_liq,
    valor_rcl,
    valor_rgps_rec, valor_rgps_desp, valor_rgps_res,
    valor_rpps_rec, valor_rpps_desp, valor_rpps_res,
    valor_mil_rec, valor_mil_desp, valor_mil_res,
    valor_fcdf_rec, valor_fcdf_desp, valor_fcdf_res,
    valor_res_nominal, valor_res_prim,
    valor_rpp_insc, valor_rpp_cancel, valor_rpp_pag, valor_rpp_saldo,
    valor_rpnp_insc, valor_rpnp_cancel, valor_rpnp_pag, valor_rpnp_saldo,
    valor_mde, valor_mde_minimo, valor_fundeb,
    valor_asps, valor_asps_minimo
  ))
) %>%
  mutate(valor_milhar = valor / 1000)
```

## Compara√ß√£o RREO

```{r comparacao-rreo}
#| echo: true
#| column: screen
#| label: comparacao-rreo

# ==============================================================================
# COMPARA√á√ÉO RREO: SISTEMA VS OFICIAL
# ==============================================================================

arquivo_rreo_a14 <- str_c(mes_pasta, "Anexo 14 - Simplificado.xlsm")

if (file.exists(arquivo_rreo_a14)) {
  cat(sprintf("üìÇ Lendo: %s\n", basename(arquivo_rreo_a14)))
  
  # Ler valores oficiais
  rreo_oficial <- mapa_rreo_a14 %>%
    rowwise() %>%
    mutate(valor_oficial = as.numeric(ler_celula(arquivo_rreo_a14, celula))) %>%
    ungroup()
  
  # Comparar
  comparacao_rreo <- comparar_valores(rreo_oficial, sistema_rreo)
  
  # Exibir
  exibir_validacao(comparacao_rreo, "VALIDA√á√ÉO RREO ANEXO 14 - Sistema vs Oficial (R$ milhares)")
  
} else {
  cat(sprintf("‚ö†Ô∏è Arquivo n√£o encontrado: %s\n", arquivo_rreo_a14))
}
```

## Valida√ß√£o RGF - C√≥digo Completo Corrigido

Substitua os chunks de valida√ß√£o RGF pelos c√≥digos abaixo.

------------------------------------------------------------------------

### Chunk 1: Mapeamento de C√©lulas do Excel Oficial

```{r mapeamento-rgf}
#| echo: false

# ==============================================================================
# MAPEAMENTO DAS C√âLULAS DO EXCEL OFICIAL - RGF
# ==============================================================================

mapeamento_rgf <- tribble(
  ~item,                        ~celula, ~descricao,                          ~fonte,
  "rcl",                        "B10",   "Receita Corrente L√≠quida",          "RGF",
  "dtp_executivo",              "B15",   "DTP - Poder Executivo",             "A01",
  "dtp_amapa",                  "B20",   "DTP - Amap√°",                       "A01",
  "dtp_roraima",                "B25",   "DTP - Roraima",                     "A01",
  "dtp_df",                     "B30",   "DTP - Distrito Federal",            "A01",
  "dcl",                        "B36",   "D√≠vida Consolidada L√≠quida",        "A02",
  "garantias",                  "B40",   "Total das Garantias",               "A03",
  "op_credito",                 "B44",   "Opera√ß√µes de Cr√©dito",              "A04",
  "rpnp_exercicio",             "B52",   "RPNP do Exerc√≠cio",                 "A05",
  "disponibilidade_antes_rp",   "C52",   "Disp. Caixa ANTES Inscri√ß√£o RP",    "A05"
)

cat("‚úÖ Mapeamento RGF definido:", nrow(mapeamento_rgf), "itens\n")
```

------------------------------------------------------------------------

### Chunk 2: Coletar Valores do Sistema

```{r valores-sistema-rgf}
#| echo: true

# ==============================================================================
# COLETAR VALORES DO SISTEMA - RGF
# ==============================================================================

# Fun√ß√£o auxiliar para convers√£o segura
safe_num <- function(x) {
  tryCatch({
    val <- as.numeric(x)
    if (length(val) == 0 || all(is.na(val))) return(NA_real_)
    return(val[1])
  }, error = function(e) NA_real_)
}

# -----------------------------------------------------------------------------
# RCL (mesma do RREO)
# -----------------------------------------------------------------------------
valor_rcl_rgf <- safe_num(valor_rcl)

# -----------------------------------------------------------------------------
# Despesa Total com Pessoal (DTP) por Ente
# Extra√≠do do dataframe "pessoal" gerado no RGF A01
# -----------------------------------------------------------------------------

valor_dtp_exec <- if (exists("pessoal") && is.data.frame(pessoal)) {
  pessoal %>% 
    filter(categoria_pessoal == "executivo") %>%
    summarise(total = sum(valor, na.rm = TRUE)) %>%
    pull(total) %>%
    safe_num()
} else NA_real_

valor_dtp_ap <- if (exists("pessoal") && is.data.frame(pessoal)) {
  pessoal %>% 
    filter(categoria_pessoal == "AP") %>%
    summarise(total = sum(valor, na.rm = TRUE)) %>%
    pull(total) %>%
    safe_num()
} else NA_real_

valor_dtp_rr <- if (exists("pessoal") && is.data.frame(pessoal)) {
  pessoal %>% 
    filter(categoria_pessoal == "RR") %>%
    summarise(total = sum(valor, na.rm = TRUE)) %>%
    pull(total) %>%
    safe_num()
} else NA_real_

valor_dtp_df <- if (exists("pessoal") && is.data.frame(pessoal)) {
  pessoal %>% 
    filter(categoria_pessoal == "DF") %>%
    summarise(total = sum(valor, na.rm = TRUE)) %>%
    pull(total) %>%
    safe_num()
} else NA_real_

# -----------------------------------------------------------------------------
# DCL - D√≠vida Consolidada L√≠quida (RGF A02)
# Usar valor_dcl_num (num√©rico)
# -----------------------------------------------------------------------------
valor_dcl_rgf <- if (exists("valor_dcl_num")) {
  safe_num(valor_dcl_num)
} else NA_real_

# -----------------------------------------------------------------------------
# Garantias (RGF A03)
# Usar valor_garantias_total
# -----------------------------------------------------------------------------
valor_garantias_rgf <- if (exists("valor_garantias_total")) {
  safe_num(valor_garantias_total)
} else NA_real_

# -----------------------------------------------------------------------------
# Opera√ß√µes de Cr√©dito (RGF A04)
# Usar valor_operacoes_credito_total
# -----------------------------------------------------------------------------
valor_op_cred <- if (exists("valor_operacoes_credito_total")) {
  safe_num(valor_operacoes_credito_total)
} else NA_real_

# -----------------------------------------------------------------------------
# Disponibilidade de Caixa (RGF A05)
# -----------------------------------------------------------------------------

# RPNP do Exerc√≠cio (s√≥ tem valor em dezembro)
valor_rpnp_ex <- if (exists("rgf_a05_executivo_formatada")) {
  rgf_a05_executivo_formatada %>%
    filter(linhas == "Total") %>%
    pull(rp_empenhados_nao_liquidados_exercicio) %>%
    safe_num()
} else NA_real_

# Disponibilidade ANTES da inscri√ß√£o em RP
valor_disp_antes_rp <- if (exists("valor_disponibilidade_executivo")) {
  safe_num(valor_disponibilidade_executivo)
} else if (exists("rgf_a05_executivo_formatada")) {
  rgf_a05_executivo_formatada %>%
    filter(linhas == "Total") %>%
    pull(disponibilidade_antes_inscr_rp_clean) %>%
    safe_num()
} else NA_real_

# Disponibilidade AP√ìS a inscri√ß√£o em RP (s√≥ tem valor em dezembro)
valor_disp_apos_rp <- if (exists("rgf_a05_executivo_formatada") && 
                          "disponibilidade_apos_inscr_rp_clean" %in% names(rgf_a05_executivo_formatada)) {
  rgf_a05_executivo_formatada %>%
    filter(linhas == "Total") %>%
    pull(disponibilidade_apos_inscr_rp_clean) %>%
    safe_num()
} else NA_real_

# -----------------------------------------------------------------------------
# Debug: mostrar valores capturados
# -----------------------------------------------------------------------------
cat("üìä Valores capturados do sistema RGF:\n\n")
cat(sprintf("   RCL:              %s\n", format(valor_rcl_rgf, big.mark = ".", decimal.mark = ",")))
cat(sprintf("   DTP Executivo:    %s\n", format(valor_dtp_exec, big.mark = ".", decimal.mark = ",")))
cat(sprintf("   DTP Amap√°:        %s\n", format(valor_dtp_ap, big.mark = ".", decimal.mark = ",")))
cat(sprintf("   DTP Roraima:      %s\n", format(valor_dtp_rr, big.mark = ".", decimal.mark = ",")))
cat(sprintf("   DTP DF:           %s\n", format(valor_dtp_df, big.mark = ".", decimal.mark = ",")))
cat(sprintf("   DCL:              %s\n", format(valor_dcl_rgf, big.mark = ".", decimal.mark = ",")))
cat(sprintf("   Garantias:        %s\n", format(valor_garantias_rgf, big.mark = ".", decimal.mark = ",")))
cat(sprintf("   Op. Cr√©dito:      %s\n", format(valor_op_cred, big.mark = ".", decimal.mark = ",")))
cat(sprintf("   RPNP Exerc√≠cio:   %s\n", format(valor_rpnp_ex, big.mark = ".", decimal.mark = ",")))
cat(sprintf("   Disp. ANTES RP:   %s\n", format(valor_disp_antes_rp, big.mark = ".", decimal.mark = ",")))
cat(sprintf("   Disp. AP√ìS RP:    %s\n", format(valor_disp_apos_rp, big.mark = ".", decimal.mark = ",")))

# -----------------------------------------------------------------------------
# Montar dataframe do sistema (sem disponibilidade_apos_rp)
# -----------------------------------------------------------------------------
sistema_rgf <- tibble(
  item = c(
    "rcl",
    "dtp_executivo",
    "dtp_amapa",
    "dtp_roraima",
    "dtp_df",
    "dcl",
    "garantias",
    "op_credito",
    "rpnp_exercicio",
    "disponibilidade_antes_rp"
  ),
  valor = as.numeric(c(
    valor_rcl_rgf,
    valor_dtp_exec,
    valor_dtp_ap,
    valor_dtp_rr,
    valor_dtp_df,
    valor_dcl_rgf,
    valor_garantias_rgf,
    valor_op_cred,
    valor_rpnp_ex,
    valor_disp_antes_rp
  ))
) %>%
  mutate(valor_milhar = valor / 1000)

cat("\n‚úÖ DataFrame sistema_rgf criado com", nrow(sistema_rgf), "linhas\n")
```

------------------------------------------------------------------------

### Chunk 3: Ler Valores do Excel Oficial

```{r valores-oficial-rgf}
#| echo: true


# ==============================================================================
# LER VALORES DO EXCEL OFICIAL - RGF
# ==============================================================================

# Buscar arquivo pelo padr√£o "Anexo 6 Simplificado"
arquivos_encontrados <- list.files(
  path = mes_pasta, 
  pattern = "Anexo.*6.*Simplificado", 
  full.names = TRUE,
  ignore.case = TRUE
)

if (length(arquivos_encontrados) > 0) {
  
  arquivo_comparativo <- arquivos_encontrados[1]
  cat("üìÅ Arquivo encontrado:", basename(arquivo_comparativo), "\n")
  
  abas_disponiveis <- excel_sheets(arquivo_comparativo)
  cat("üìã Abas dispon√≠veis:", paste(abas_disponiveis, collapse = ", "), "\n")
  
  aba_usar <- abas_disponiveis[1]
  
  # Ler planilha SEM converter para texto
  oficial_rgf_raw <- read_excel(arquivo_comparativo, sheet = aba_usar, col_names = FALSE)
  
  # Fun√ß√£o para ler c√©lula - CORRIGIDA
  ler_celula <- function(celula) {
    # Extrair coluna (letra) e linha (n√∫mero)
    col_letra <- str_extract(celula, "^[A-Z]+")
    linha <- as.numeric(str_extract(celula, "[0-9]+"))
    
    # Converter letra para n√∫mero (A=1, B=2, etc.)
    col_num <- sum(sapply(strsplit(col_letra, "")[[1]], function(x) {
      which(LETTERS == x)
    }) * 26^(rev(seq_along(strsplit(col_letra, "")[[1]])) - 1))
    
    # Extrair valor
    valor <- oficial_rgf_raw[[col_num]][linha]
    
    # Se j√° √© num√©rico, retornar direto
    if (is.numeric(valor)) {
      return(valor)
    }
    
    # Se √© texto, converter formato brasileiro para num√©rico
    if (is.character(valor)) {
      # Remover espa√ßos
      valor <- trimws(valor)
      
      # Verificar se tem v√≠rgula como decimal (formato BR: 1.234.567,89)
      if (grepl(",", valor) && grepl("\\.", valor)) {
        # Formato brasileiro: remover pontos de milhar, trocar v√≠rgula por ponto
        valor <- gsub("\\.", "", valor)  # Remove pontos de milhar
        valor <- gsub(",", ".", valor)   # Troca v√≠rgula decimal por ponto
      } else if (grepl(",", valor)) {
        # S√≥ tem v√≠rgula (decimal)
        valor <- gsub(",", ".", valor)
      }
      # Se s√≥ tem pontos, assume que s√£o milhares e o n√∫mero √© inteiro
      # (n√£o faz nada, deixa o R interpretar)
    }
    
    as.numeric(valor)
  }
  
  # Coletar valores oficiais
  oficial_rgf <- mapeamento_rgf %>%
    rowwise() %>%
    mutate(
      valor_oficial = tryCatch(
        ler_celula(celula),
        error = function(e) NA_real_
      )
    ) %>%
    ungroup()
  
  # Debug: mostrar valores lidos
  cat("\nüìä Valores lidos do Excel:\n")
  for (i in 1:nrow(oficial_rgf)) {
    cat(sprintf("   %s (%s): %s\n", 
                oficial_rgf$item[i], 
                oficial_rgf$celula[i],
                format(oficial_rgf$valor_oficial[i], big.mark = ".", decimal.mark = ",")))
  }
  
  cat("\n‚úÖ Valores oficiais RGF lidos:", sum(!is.na(oficial_rgf$valor_oficial)), "de", nrow(oficial_rgf), "\n")
  
} else {
  
  oficial_rgf <- mapeamento_rgf %>%
    mutate(valor_oficial = NA_real_)
  
  cat("‚ö†Ô∏è Arquivo 'Anexo 6 Simplificado' n√£o encontrado em:", mes_pasta, "\n")
}

```

------------------------------------------------------------------------

### Chunk 4: Compara√ß√£o Sistema vs Oficial

```{r comparacao-rgf}
#| echo: false

# ==============================================================================
# COMPARA√á√ÉO SISTEMA vs OFICIAL - RGF
# ==============================================================================

# Fun√ß√£o de compara√ß√£o
comparar_valores <- function(oficial, sistema) {
  if (is.na(oficial) || is.na(sistema)) return("Sem sistema")
  
  diferenca <- abs(oficial - sistema)
  
  # Usar o maior valor como base para percentual
  base <- max(abs(oficial), abs(sistema), na.rm = TRUE)
  if (base == 0) base <- 1
  
  pct <- (diferenca / base) * 100
  
  # Crit√©rios de status
  if (diferenca < 500 || pct < 0.1) {
    "‚úÖ OK"
  } else if (pct < 1) {
    "‚ö†Ô∏è Verificar"
  } else {
    "‚ùå DIVERGENTE"
  }
}

# Juntar sistema com oficial
comparacao_rgf <- oficial_rgf %>%
  left_join(
    sistema_rgf %>% select(item, valor_sistema = valor),
    by = "item"
  ) %>%
  mutate(
    # Converter oficial para mesma escala (se necess√°rio)
    oficial = valor_oficial,
    sistema = valor_sistema/1000,
    
    # Calcular diferen√ßa
    diferenca = oficial - sistema,
    
    # Calcular diferen√ßa percentual
    dif_pct = case_when(
      is.na(oficial) | is.na(sistema) ~ NA_real_,
      oficial == 0 & sistema == 0 ~ 0,
      oficial == 0 ~ NA_real_,
      TRUE ~ (diferenca / abs(oficial)) * 100
    ),
    
    # Status
    status = map2_chr(oficial, sistema, comparar_valores)
  ) %>%
  select(item, descricao, fonte, celula, oficial, sistema, diferenca, dif_pct, status)

cat("‚úÖ Compara√ß√£o RGF conclu√≠da\n")
```

------------------------------------------------------------------------

### Chunk 5: Exibir Tabela de Valida√ß√£o

```{r tabela-validacao-rgf}
#| echo: false
#| column: page

# ==============================================================================
# TABELA DE VALIDA√á√ÉO - RGF
# ==============================================================================

# Formatar para exibi√ß√£o
tabela_rgf <- comparacao_rgf %>%
  mutate(
    oficial = round(oficial, 0),
    sistema = round(sistema, 0),
    diferenca = round(diferenca, 0),
    dif_pct = sprintf("%.1f%%", dif_pct)
  )

# Exibir com DT
datatable(
  tabela_rgf,
  caption = "Valida√ß√£o RGF - Sistema vs Oficial",
  filter = "top",
  options = list(
    pageLength = 15,
    scrollX = TRUE,
    dom = "Bfrtip",
    buttons = c("copy", "csv", "excel")
  ),
  rownames = FALSE
) %>%
  formatStyle(
    "status",
    backgroundColor = styleEqual(
      c("‚úÖ OK", "‚ö†Ô∏è Verificar", "‚ùå DIVERGENTE", "Sem sistema"),
      c("#d4edda", "#fff3cd", "#f8d7da", "#e9ecef")
    )
  ) %>%
  formatCurrency(
    columns = c("oficial", "sistema", "diferenca"),
    currency = "",
    mark = ".",
    dec.mark = ",",
    digits = 0
  )
```

------------------------------------------------------------------------

### Chunk 6: Resumo da Valida√ß√£o

```{r resumo-validacao-rgf}
#| echo: false

# ==============================================================================
# RESUMO DA VALIDA√á√ÉO - RGF
# ==============================================================================

resumo_rgf <- comparacao_rgf %>%
  count(status) %>%
  arrange(desc(n))

cat("\nüìä RESUMO DA VALIDA√á√ÉO RGF\n")
cat("=" %>% rep(40) %>% paste(collapse = ""), "\n")

for (i in 1:nrow(resumo_rgf)) {
  cat(sprintf("   %s: %d itens\n", resumo_rgf$status[i], resumo_rgf$n[i]))
}

cat("=" %>% rep(40) %>% paste(collapse = ""), "\n")
cat(sprintf("   TOTAL: %d itens\n", nrow(comparacao_rgf)))
```

------------------------------------------------------------------------

## Notas

1.  **DTP (Despesa Total com Pessoal)**: Agora √© extra√≠do corretamente do dataframe `pessoal` filtrado por `categoria_pessoal`

2.  **Disponibilidades**:

    -   `disponibilidade_antes_rp`: Disponibilidade antes da inscri√ß√£o em RP (todos os meses)
    -   `disponibilidade_apos_rp`: Disponibilidade ap√≥s a inscri√ß√£o em RP (s√≥ dezembro)

3.  **RPNP do Exerc√≠cio**: S√≥ ter√° valor em dezembro

4.  **Limites removidos**: A tabela agora mostra apenas valores realizados, sem os limites calculados

5.  **C√©lulas do Excel**: Ajustar conforme layout do arquivo `comparativo.xlsx`

## üìå Observa√ß√µes

1.  **Status da Valida√ß√£o**:
    -   ‚úÖ **OK**: Sem diferen√ßa (\< 0,5 milhar ou \< 0,1%)
    -   ‚ö†Ô∏è **Verificar**: Diferen√ßa entre 0,1% e 1%
    -   ‚ùå **DIVERGENTE**: Diferen√ßa \> 1%
    -   ‚¨ú **Sem oficial/sistema**: Valor n√£o dispon√≠vel
2.  **Arquivos Oficiais Necess√°rios**:
    -   `Anexo 14 - Simplificado.xlsm` (RREO)
    -   `Anexo 6 Simplificado - 2025.xlsx` (RGF)
3.  **Fontes de Dados Especiais**:
    -   Resultado Prim√°rio/Nominal: `rp_claude.xlsm` (planilha do setor)
    -   Valores em R\$ milhares para compara√ß√£o com relat√≥rios oficiais

# üìä Mapeamento de Atributos por Demonstrativo

Este cap√≠tulo apresenta uma an√°lise autom√°tica de todos os atributos (colunas) utilizados nos crit√©rios de classifica√ß√£o dos demonstrativos fiscais.

## Extra√ß√£o Autom√°tica de Atributos

```{r mapeamento-atributos-setup}
#| echo: true
#| code-fold: true
#| code-summary: "Ver c√≥digo de extra√ß√£o de atributos"

# ==============================================================================
# MAPEAMENTO AUTOM√ÅTICO DE ATRIBUTOS UTILIZADOS NOS CRIT√âRIOS
# ==============================================================================

# -----------------------------------------------------------------------------
# Fun√ß√£o para extrair atributos de uma string de crit√©rio
# -----------------------------------------------------------------------------

extrair_atributos_criterio <- function(criterio_texto) {
  if (is.null(criterio_texto) || is.na(criterio_texto)) return(character(0))
  

  # Padr√µes para identificar nomes de colunas/atributos
  # Captura palavras seguidas de operadores de compara√ß√£o
  padroes <- c(
    # Atributos antes de operadores
    "([a-z_][a-z0-9_]*)\\s*(?:%in%|%notin%|==|!=|>=|<=|>|<)",
    # Atributos em fun√ß√µes como startsWith, endsWith
    "startsWith\\s*\\(\\s*([a-z_][a-z0-9_]*)",
    "endsWith\\s*\\(\\s*([a-z_][a-z0-9_]*)",
    "str_detect\\s*\\(\\s*([a-z_][a-z0-9_]*)",
    "grepl\\s*\\([^,]+,\\s*([a-z_][a-z0-9_]*)"
  )
  
  atributos <- character(0)
  
  for (padrao in padroes) {
    matches <- str_match_all(criterio_texto, regex(padrao, ignore_case = TRUE))[[1]]
    if (nrow(matches) > 0) {
      atributos <- c(atributos, matches[, 2])
    }
  }
  
  # Limpar e retornar √∫nicos
  atributos <- unique(atributos[!is.na(atributos)])
  atributos <- atributos[nchar(atributos) > 2]  # Remover matches muito curtos
  
  # Remover palavras reservadas e valores
  palavras_excluir <- c("TRUE", "FALSE", "NULL", "NA", "c", "in", "and", "or", "not")
  atributos <- atributos[!toupper(atributos) %in% toupper(palavras_excluir)]
  
  return(atributos)
}

# -----------------------------------------------------------------------------
# Fun√ß√£o para processar uma lista de crit√©rios
# -----------------------------------------------------------------------------

processar_lista_criterios <- function(criterios, demonstrativo, anexo, tipo = "criterio") {
  
  if (!exists(deparse(substitute(criterios))) || is.null(criterios)) {
    return(tibble())
  }
  
  map_dfr(names(criterios), function(nome_criterio) {
    criterio_obj <- criterios[[nome_criterio]]
    
    # Extrair texto do crit√©rio
    criterio_texto <- if (is.list(criterio_obj)) {
      criterio_obj$criterio
    } else {
      as.character(criterio_obj)
    }
    
    # Extrair atributos
    atributos <- extrair_atributos_criterio(criterio_texto)
    
    if (length(atributos) > 0) {
      tibble(
        demonstrativo = demonstrativo,
        anexo = anexo,
        tipo = tipo,
        criterio = nome_criterio,
        atributo = atributos
      )
    } else {
      tibble()
    }
  })
}

# -----------------------------------------------------------------------------
# Fun√ß√£o auxiliar para processar crit√©rio com verifica√ß√£o de exist√™ncia
# -----------------------------------------------------------------------------

processar_se_existe <- function(nome_criterio, demonstrativo, anexo, tipo = "criterio") {
  if (exists(nome_criterio)) {
    processar_lista_criterios(get(nome_criterio), demonstrativo, anexo, tipo)
  } else {
    tibble()
  }
}
```

```{r mapeamento-atributos-coleta}
#| echo: true
#| code-fold: true
#| code-summary: "Ver coleta de todos os crit√©rios"

# ==============================================================================
# COLETA DE ATRIBUTOS DE TODOS OS CRIT√âRIOS DEFINIDOS
# ==============================================================================

cat("üìä Coletando atributos de todos os crit√©rios...\n\n")

atributos_coletados <- bind_rows(
  
  # =========================================================================
  # RGF - RELAT√ìRIO DE GEST√ÉO FISCAL
  # =========================================================================
  
  # RGF A01 - Despesa com Pessoal
  processar_se_existe("criterios_rgf_A01_pessoal_rgf", "RGF", "A01 - Despesa com Pessoal"),
  

  # RGF A02 - D√≠vida Consolidada L√≠quida
  processar_se_existe("criterios_rgf_A02_dcl_precatorios", "RGF", "A02 - DCL"),
  processar_se_existe("criterios_rgf_A02_dcl_rp_exceto_170600", "RGF", "A02 - DCL"),
  processar_se_existe("criterios_rgf_A02_dcl_rp_todas_ugs", "RGF", "A02 - DCL"),
  processar_se_existe("criterios_rgf_A02_dcl_ug_170512", "RGF", "A02 - DCL"),
  processar_se_existe("criterios_rgf_A02_dcl_creditos_bancarios", "RGF", "A02 - DCL"),
  processar_se_existe("criterios_rgf_A02_dcl_entidade", "RGF", "A02 - DCL"),
  processar_se_existe("criterios_rgf_A02_dcl_aplicacao_titulos_publicos", "RGF", "A02 - DCL"),
  processar_se_existe("criterios_rgf_A02_dcl_balancete", "RGF", "A02 - DCL"),
  processar_se_existe("criterios_rgf_A02_dcl_balancete_fat", "RGF", "A02 - DCL"),
  processar_se_existe("criterios_rgf_A02_dcl_balancete_fundos_111215100", "RGF", "A02 - DCL"),
  processar_se_existe("criterios_rgf_A02_dcl_balancete_fundos", "RGF", "A02 - DCL"),
  processar_se_existe("criterios_rgf_A02_dcl_balancete_deducoes_depositos_a_vista", "RGF", "A02 - DCL"),
  processar_se_existe("criterios_rgf_A02_dcl_passivo_atuarial", "RGF", "A02 - DCL"),
  
  # RGF A03 - Garantias e Contragarantias
  processar_se_existe("criterios_rgf_A03_garantias", "RGF", "A03 - Garantias"),
  
  # RGF A04 - Opera√ß√µes de Cr√©dito
  processar_se_existe("criterios_rgf_A04_receitas", "RGF", "A04 - Op. Cr√©dito"),
  processar_se_existe("criterios_rgf_A04_extra_orcamentarias", "RGF", "A04 - Op. Cr√©dito"),
  processar_se_existe("criterios_rgf_A04_despesas", "RGF", "A04 - Op. Cr√©dito"),
  
  # RGF A05 - Disponibilidade de Caixa
  processar_se_existe("criterios_rgf_a05_disponibilidade", "RGF", "A05 - Disponibilidade"),
  
  # =========================================================================
  # RREO - RELAT√ìRIO RESUMIDO DA EXECU√á√ÉO OR√áAMENT√ÅRIA
  # =========================================================================
  
  # RREO A01 - Balan√ßo Or√ßament√°rio
  processar_se_existe("criterios_rreo_A01_receitas_bo", "RREO", "A01 - Balan√ßo Or√ßament√°rio"),
  processar_se_existe("criterios_rreo_A01_despesas_bo", "RREO", "A01 - Balan√ßo Or√ßament√°rio"),
  
  # RREO A03 - Receita Corrente L√≠quida
  processar_se_existe("criterios_rreo_A03_rcl_receitas_rcl", "RREO", "A03 - RCL"),
  processar_se_existe("criterios_rreo_A03_rcl_despesas_rcl", "RREO", "A03 - RCL"),
  processar_se_existe("criterios_rreo_A03_rcl_rp_cancelado_rcl", "RREO", "A03 - RCL"),
  
  # RREO A04 - Previd√™ncia
  processar_se_existe("criterios_rreo_A04_rgps_receitas_rgps", "RREO", "A04 - RGPS"),
  processar_se_existe("criterios_rreo_A04_rgps_despesas_rgps", "RREO", "A04 - RGPS"),
  processar_se_existe("criterios_rreo_A04_rpps_receitas_civil_militar_rpps", "RREO", "A04 - RPPS"),
  processar_se_existe("criterios_rreo_A04_rpps_despesas_civil_militar_rpps", "RREO", "A04 - RPPS"),
  processar_se_existe("criterios_rreo_A04_rpps_receitas_fcdf", "RREO", "A04 - FCDF"),
  processar_se_existe("criterios_rreo_A04_rpps_despesas_fcdf", "RREO", "A04 - FCDF"),
  
  # RREO A06 - Resultado Prim√°rio e Nominal
  processar_se_existe("criterios_rreo_A06_receitas_A06", "RREO", "A06 - Result. Prim√°rio"),
  processar_se_existe("criterios_rreo_A06_despesas_categoria_grupo_A06", "RREO", "A06 - Result. Prim√°rio"),
  processar_se_existe("criterios_rreo_A06_despesas_natureza_detalhada_A06", "RREO", "A06 - Result. Prim√°rio"),
  processar_se_existe("criterios_rreo_A06_disponibilidades_A06", "RREO", "A06 - Result. Prim√°rio"),
  processar_se_existe("criterios_rreo_A06_juros_ativos_passivos_A06", "RREO", "A06 - Result. Prim√°rio"),
  processar_se_existe("criterios_rreo_A06_subsidios_cesef", "RREO", "A06 - Result. Prim√°rio"),
  processar_se_existe("criterios_rreo_A06_emprestimos", "RREO", "A06 - Result. Prim√°rio"),
  processar_se_existe("criterios_rreo_A06_ajuste", "RREO", "A06 - Result. Prim√°rio"),
  
  # RREO A08 - MDE (Educa√ß√£o)
  processar_se_existe("criterios_rreo_A08_mde_despesas", "RREO", "A08 - MDE"),
  
  # RREO T01 - Receitas e Despesas Seguridade
  processar_se_existe("criterios_rreo_T01_receitas", "RREO", "T01 - Seguridade"),
  processar_se_existe("criterios_rreo_T01_despesas_T01", "RREO", "T01 - Seguridade"),
  processar_se_existe("criterios_rreo_T01B_seguridade_T01B", "RREO", "T01B - Seguridade √Årea"),
  
  # RREO T02 - Despesas com Pessoal
  processar_se_existe("criterios_rreo_T02_despesas_T02", "RREO", "T02 - Pessoal")
)

cat(sprintf("‚úÖ Total de registros coletados: %d\n", nrow(atributos_coletados)))
cat(sprintf("‚úÖ Atributos √∫nicos identificados: %d\n", n_distinct(atributos_coletados$atributo)))
```

## üìã Resumo por Demonstrativo e Anexo

```{r tabela-resumo-demonstrativo}
#| echo: false
#| column: page

# ==============================================================================
# TABELA RESUMO: ATRIBUTOS POR DEMONSTRATIVO/ANEXO
# ==============================================================================

if (nrow(atributos_coletados) > 0) {
  
  resumo_por_anexo <- atributos_coletados %>%
    group_by(demonstrativo, anexo, atributo) %>%
    summarise(
      qtd_usos = n(),
      criterios = paste(unique(criterio), collapse = " | "),
      .groups = "drop"
    ) %>%
    arrange(demonstrativo, anexo, desc(qtd_usos), atributo)
  
  datatable(
    resumo_por_anexo,
    caption = "Atributos Utilizados por Demonstrativo/Anexo",
    filter = "top",
    extensions = c("Buttons", "Scroller"),
    options = list(
      dom = "Bfrtip",
      buttons = c("copy", "csv", "excel"),
      scrollX = TRUE,
      scrollY = 400,
      scroller = TRUE,
      pageLength = 50,
      columnDefs = list(
        list(width = "80px", targets = 0),
        list(width = "150px", targets = 1),
        list(width = "200px", targets = 2),
        list(width = "60px", targets = 3),
        list(width = "400px", targets = 4)
      )
    ),
    colnames = c("Demonstrativo", "Anexo", "Atributo", "Qtd Usos", "Crit√©rios"),
    rownames = FALSE
  )
  
} else {
  cat("‚ö†Ô∏è Nenhum atributo coletado. Verifique se os crit√©rios est√£o definidos.\n")
}
```

## üìä Atributos Mais Utilizados (Geral)

```{r tabela-atributos-mais-usados}
#| echo: false

# ==============================================================================
# TABELA: ATRIBUTOS MAIS UTILIZADOS (RANKING GERAL)
# ==============================================================================

if (nrow(atributos_coletados) > 0) {
  
  ranking_atributos <- atributos_coletados %>%
    group_by(atributo) %>%
    summarise(
      qtd_total_usos = n(),
      qtd_anexos = n_distinct(anexo),
      demonstrativos = paste(unique(demonstrativo), collapse = ", "),
      anexos = paste(unique(anexo), collapse = " | "),
      .groups = "drop"
    ) %>%
    arrange(desc(qtd_total_usos), desc(qtd_anexos))
  
  datatable(
    ranking_atributos,
    caption = "Ranking de Atributos Mais Utilizados",
    filter = "top",
    extensions = "Buttons",
    options = list(
      dom = "Bfrtip",
      buttons = c("copy", "csv", "excel"),
      scrollX = TRUE,
      pageLength = 30
    ),
    colnames = c("Atributo", "Total Usos", "Qtd Anexos", "Demonstrativos", "Anexos"),
    rownames = FALSE
  )
  
} else {
  cat("‚ö†Ô∏è Nenhum atributo coletado.\n")
}
```

## üìà Estat√≠sticas por Demonstrativo

```{r estatisticas-demonstrativo}
#| echo: false

# ==============================================================================
# ESTAT√çSTICAS AGREGADAS POR DEMONSTRATIVO
# ==============================================================================

if (nrow(atributos_coletados) > 0) {
  
  stats_demonstrativo <- atributos_coletados %>%
    group_by(demonstrativo) %>%
    summarise(
      qtd_anexos = n_distinct(anexo),
      qtd_criterios = n_distinct(criterio),
      qtd_atributos_unicos = n_distinct(atributo),
      total_usos_atributos = n(),
      .groups = "drop"
    )
  
  knitr::kable(
    stats_demonstrativo,
    col.names = c("Demonstrativo", "Anexos", "Crit√©rios", "Atributos √önicos", "Total Usos"),
    caption = "Estat√≠sticas por Demonstrativo"
  )
  
}
```

## üîç Matriz de Atributos x Anexos

```{r matriz-atributos-anexos}
#| echo: false
#| column: screen

# ==============================================================================
# MATRIZ: QUAIS ATRIBUTOS S√ÉO USADOS EM QUAIS ANEXOS
# ==============================================================================

if (nrow(atributos_coletados) > 0) {
  
  # Criar matriz pivotada
  matriz_atributos <- atributos_coletados %>%
    distinct(anexo, atributo) %>%
    mutate(presente = "‚úì") %>%
    pivot_wider(
      names_from = anexo,
      values_from = presente,
      values_fill = ""
    ) %>%
    arrange(atributo)
  
  # Adicionar contagem de anexos
  matriz_atributos <- matriz_atributos %>%
    rowwise() %>%
    mutate(
      total_anexos = sum(c_across(-atributo) == "‚úì")
    ) %>%
    ungroup() %>%
    arrange(desc(total_anexos), atributo) %>%
    select(atributo, total_anexos, everything())
  
  datatable(
    matriz_atributos,
    caption = "Matriz de Atributos x Anexos (‚úì = atributo utilizado)",
    filter = "top",
    extensions = "Buttons",
    options = list(
      dom = "Bfrtip",
      buttons = c("copy", "csv", "excel"),
      scrollX = TRUE,
      scrollY = 500,
      pageLength = 50,
      fixedColumns = list(leftColumns = 2)
    ),
    rownames = FALSE
  )
  
}
```

## üìù Lista Completa de Crit√©rios

```{r lista-criterios}
#| echo: false

# ==============================================================================
# LISTA COMPLETA DE CRIT√âRIOS POR ANEXO
# ==============================================================================

if (nrow(atributos_coletados) > 0) {
  
  lista_criterios <- atributos_coletados %>%
    group_by(demonstrativo, anexo, criterio) %>%
    summarise(
      atributos = paste(unique(atributo), collapse = ", "),
      qtd_atributos = n_distinct(atributo),
      .groups = "drop"
    ) %>%
    arrange(demonstrativo, anexo, criterio)
  
  datatable(
    lista_criterios,
    caption = "Lista Completa de Crit√©rios e seus Atributos",
    filter = "top",
    extensions = "Buttons",
    options = list(
      dom = "Bfrtip",
      buttons = c("copy", "csv", "excel"),
      scrollX = TRUE,
      pageLength = 25
    ),
    colnames = c("Demonstrativo", "Anexo", "Crit√©rio", "Atributos Utilizados", "Qtd"),
    rownames = FALSE
  )
  
}
```

## üíæ Exportar Dados

```{r exportar-mapeamento}
#| echo: true

# ==============================================================================
# EXPORTAR MAPEAMENTO PARA AN√ÅLISE EXTERNA
# ==============================================================================

if (nrow(atributos_coletados) > 0) {
  
  # Salvar objetos para uso posterior
  mapeamento_atributos <- list(
    dados_completos = atributos_coletados,
    resumo_por_anexo = resumo_por_anexo,
    ranking_atributos = ranking_atributos,
    matriz_atributos = matriz_atributos,
    lista_criterios = lista_criterios,
    data_geracao = Sys.time()
  )
  
  cat("‚úÖ Objetos de mapeamento dispon√≠veis:\n")
  cat("   - mapeamento_atributos$dados_completos\n")
  cat("   - mapeamento_atributos$resumo_por_anexo\n")
  cat("   - mapeamento_atributos$ranking_atributos\n")
  cat("   - mapeamento_atributos$matriz_atributos\n")
  cat("   - mapeamento_atributos$lista_criterios\n")
  
}
```

## üìñ Notas Metodol√≥gicas

::: callout-note
### Como funciona a extra√ß√£o

1.  **Identifica√ß√£o de padr√µes**: O c√≥digo busca padr√µes como `atributo %in% c(...)`, `atributo == valor`, `startsWith(atributo, ...)`, etc.

2.  **Limpeza**: Remove palavras reservadas (TRUE, FALSE, NA) e matches muito curtos.

3.  **Agrega√ß√£o**: Agrupa por demonstrativo/anexo e conta ocorr√™ncias.
:::

::: callout-warning
### Limita√ß√µes

-   Atributos usados em filtros fora das listas de crit√©rios (ex: filtros diretos em `filter()`) n√£o s√£o capturados automaticamente.
-   Nomes de colunas muito curtos (‚â§2 caracteres) s√£o ignorados para evitar falsos positivos.
:::
