---
title: "ğŸ“Š RREO & RGF - RelatÃ³rios Fiscais"
subtitle: "Sistema Unificado de RelatÃ³rios Fiscais do Governo Federal"
author: "Governo Federal"
date: today
execute:
  warning: false
  message: false
  cache: true  # âš¡ CACHE GLOBAL ATIVADO
format:
  html:
    theme: cosmo
    toc: true
    toc-depth: 3
    number-sections: true
    code-fold: true
    code-summary: "Mostrar cÃ³digo"
    fig-width: 10
    fig-height: 6
    tbl-cap-location: top
    self-contained: true
# 
# rm -rf relatorios_fiscais_otimizado_cache/
# rm -rf relatorios_fiscais_otimizado_files/

# ============================================================================
# SISTEMA DE CONTROLE DE EXECUÃ‡ÃƒO POR RELATÃ“RIOS
# ============================================================================
params:
  # === RELATÃ“RIOS A GERAR ===
  relatorios_ativos:
    value: [ "RGF_A01", "RGF_A02", "RGF_A03", "RGF_A04", "RGF_A05", "RGF_T04", "RREO_A01", "RREO_A02", "RREO_A03", "RREO_A04", "RREO_A06", "RREO_A07", "RREO_A08", "RREO_A09", "RREO_A11", "RREO_A12", "RREO_T01", "RREO_T02", "RREO_T03", "RREO_T04"]
    choices: [
      # RGF - RelatÃ³rio de GestÃ£o Fiscal
      "RGF_A01",  # Despesa com Pessoal
      "RGF_A02",  # DÃ­vida Consolidada LÃ­quida (DCL)
      "RGF_A03",  # Garantias e Contragarantias
      "RGF_A04",  # OperaÃ§Ãµes de CrÃ©dito
      "RGF_A05",  # Disponibilidades de Caixa (UniÃ£o)
      "RGF_T04",  # Tabela 04 - Disponibilidade de Caixa e RAP
      # RREO - RelatÃ³rio Resumido da ExecuÃ§Ã£o OrÃ§amentÃ¡ria
      "RREO_A01", # BalanÃ§o OrÃ§amentÃ¡rio
      "RREO_A02", # Demonstrativo por FunÃ§Ã£o/SubfunÃ§Ã£o
      "RREO_A03", # Receita Corrente LÃ­quida (RCL)
      "RREO_A04", # Receitas e Despesas PrevidenciÃ¡rias
      "RREO_A06", # Resultado PrimÃ¡rio
      "RREO_A07", # Restos a Pagar
      "RREO_A08", # Receitas e Despesas com MDE
      "RREO_A09", # Demonstrativo da Regra de Ouro
      "RREO_A11", # Regime PrÃ³prio de PrevidÃªncia
      "RREO_A12", # Receitas e Despesas com SaÃºde
      "RREO_T01", # Tabela 01 - Receitas OrÃ§amentÃ¡rias
      "RREO_T02", # Tabela 02 - Seguridade Social
      "RREO_T03", # Tabela 03 - ConsolidaÃ§Ã£o
      "RREO_T04"  # Tabela 04 - UniÃ£o e Executivo
    ]
  
  # === CONTROLE DE DEPENDÃŠNCIAS ===
  incluir_dependencias:
    value: true
    label: "Incluir dependÃªncias automaticamente"
  
  # === CONFIGURAÃ‡Ã•ES GERAIS ===
  mes_referencia: "202510"
  validar_dados: true
  incluir_graficos: false
  exportar_excel: false
---

```{r sistema-controle}
#| include: false
#| cache: false

# ============================================================================
# SISTEMA DE CONTROLE DE EXECUÃ‡ÃƒO POR RELATÃ“RIOS
# ============================================================================

# Capturar parÃ¢metros
MES_REF <- params$mes_referencia
RELATORIOS_SOLICITADOS <- params$relatorios_ativos
INCLUIR_DEPENDENCIAS <- params$incluir_dependencias

# ============================================================================
# MAPA DE DEPENDÃŠNCIAS
# ============================================================================

DEPENDENCIAS <- list(
  # ==========================================================================
  # RGF - Todos os anexos dependem da RCL para cÃ¡lculo de limites LRF
  # ==========================================================================
  "RGF_A01" = c("RREO_A03"),  # Despesa Pessoal â†’ precisa RCL
  "RGF_A02" = c("RREO_A03"),  # DCL â†’ precisa RCL
  "RGF_A03" = c("RREO_A03"),  # Garantias â†’ precisa RCL
  "RGF_A04" = c("RREO_A03"),  # OperaÃ§Ãµes de CrÃ©dito â†’ precisa RCL
  "RGF_A05" = c("RREO_A03"),  # Disponibilidades UniÃ£o â†’ precisa RCL
  "RGF_T04" = c(),             # Tabela 04 â†’ independente
  
  # ==========================================================================
  # RREO
  # ==========================================================================
  "RREO_A01" = c(),            # BalanÃ§o OrÃ§amentÃ¡rio â†’ independente
  "RREO_A02" = c(),            # FunÃ§Ã£o/SubfunÃ§Ã£o â†’ independente
  "RREO_A03" = c(),            # RCL â†’ base para RGF e outros RREO
  "RREO_A04" = c("RREO_A03"),  # PrevidÃªncia â†’ precisa RCL
  "RREO_A06" = c("RGF_A02"),   # Resultado PrimÃ¡rio â†’ precisa DCL
  "RREO_A07" = c(),            # Restos a Pagar â†’ independente
  "RREO_A08" = c(),            # MDE â†’ usa RLI (nÃ£o RCL), independente
  "RREO_A09" = c(),            # Regra de Ouro â†’ independente
  "RREO_A11" = c(),            # Regime PrÃ³prio â†’ independente
  "RREO_A12" = c("RREO_A03"),  # SaÃºde â†’ precisa RCL para % mÃ­nimo
  "RREO_T01" = c(),            # Tabela 01 â†’ independente
  "RREO_T02" = c(),            # Tabela 02 â†’ independente
  "RREO_T03" = c(),            # Tabela 03 â†’ independente
  "RREO_T04" = c()             # Tabela 04 â†’ independente (nÃ£o depende DCL)
)

# ============================================================================
# FUNÃ‡ÃƒO DE RESOLUÃ‡ÃƒO DE DEPENDÃŠNCIAS
# ============================================================================

resolver_dependencias <- function(relatorios_solicitados, incluir_deps = TRUE) {
  if (!incluir_deps) {
    return(relatorios_solicitados)
  }
  
  relatorios_completos <- relatorios_solicitados
  processados <- c()
  
  # Loop atÃ© nÃ£o haver mais dependÃªncias para adicionar
  while (TRUE) {
    novos <- c()
    
    for (relatorio in relatorios_completos) {
      if (relatorio %in% processados) next
      
      deps <- DEPENDENCIAS[[relatorio]]
      if (!is.null(deps) && length(deps) > 0) {
        novos <- c(novos, deps)
      }
      processados <- c(processados, relatorio)
    }
    
    if (length(novos) == 0) break
    
    relatorios_completos <- unique(c(relatorios_completos, novos))
  }
  
  return(unique(relatorios_completos))
}

# Aplicar resoluÃ§Ã£o de dependÃªncias
RELATORIOS_EXECUTAR <- resolver_dependencias(RELATORIOS_SOLICITADOS, INCLUIR_DEPENDENCIAS)

# ============================================================================
# FUNÃ‡ÃƒO DE CONTROLE
# ============================================================================

executar_relatorio <- function(codigo) {
  codigo %in% RELATORIOS_EXECUTAR
}

# ============================================================================
# MAPEAMENTO DE DADOS NECESSÃRIOS POR RELATÃ“RIO
# ============================================================================

DADOS_NECESSARIOS <- list(
  # RGF
  "RGF_A01" = c("dados_rcl", "dados_rgf_a01"),
  "RGF_A02" = c("dados_rcl", "dados_rgf_a02"),
  "RGF_A03" = c("dados_rcl", "dados_rgf_a03"),
  "RGF_A04" = c("dados_rcl", "dados_rgf_a04"),
  "RGF_A05" = c("dados_rcl", "dados_rgf_a05"),
  "RGF_T04" = c("dados_rgf_a05"),
  
  # RREO
  "RREO_A01" = c("dados_despesa_rreo", "dados_receita"),
  "RREO_A02" = c("dados_despesa_rreo"),
  "RREO_A03" = c("dados_rcl"),
  "RREO_A04" = c("dados_rcl", "dados_despesa_rreo"),
  "RREO_A06" = c("dados_rgf_a02", "dados_rcl"),
  "RREO_A07" = c("dados_rp"),
  "RREO_A08" = c("dados_despesa_rreo", "dados_receita"),
  "RREO_A09" = c("dados_regra_ouro"),
  "RREO_A11" = c("dados_despesa_rreo"),
  "RREO_A12" = c("dados_rcl", "dados_despesa_rreo"),
  "RREO_T01" = c("dados_receita"),
  "RREO_T02" = c("dados_despesa_rreo"),
  "RREO_T03" = c("dados_despesa_rreo"),
  "RREO_T04" = c("dados_contabeis")
)

# Determinar quais conjuntos de dados carregar
DADOS_CARREGAR <- unique(unlist(DADOS_NECESSARIOS[RELATORIOS_EXECUTAR]))

# FunÃ§Ã£o para verificar se deve carregar dados
carregar_dados <- function(conjunto) {
  conjunto %in% DADOS_CARREGAR
}

# FunÃ§Ãµes de compatibilidade com cÃ³digo antigo
executar_modulo <- function(modulo) {
  if (modulo == "SETUP") return(TRUE)
  if (modulo == "IMPORTACAO") return(length(DADOS_CARREGAR) > 0)
  if (modulo == "FUNCOES") return(TRUE)
  return(length(RELATORIOS_EXECUTAR) > 0)
}

# ============================================================================
# EXIBIR CONFIGURAÃ‡ÃƒO
# ============================================================================

cat("\n")
cat("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n")
cat("â•‘       SISTEMA DE RELATÃ“RIOS FISCAIS - CONTROLE DE EXECUÃ‡ÃƒO     â•‘\n")
cat("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\n")
cat(sprintf("â•‘ PerÃ­odo: %-54s â•‘\n", MES_REF))
cat("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\n")

# Mostrar relatÃ³rios solicitados
cat("â•‘ ğŸ“‹ RELATÃ“RIOS SOLICITADOS:                                     â•‘\n")
for (rel in RELATORIOS_SOLICITADOS) {
  # Obter nome descritivo
  nome_desc <- switch(rel,
    "RGF_A01" = "RGF Anexo 01 - Despesa com Pessoal",
    "RGF_A02" = "RGF Anexo 02 - DÃ­vida Consolidada LÃ­quida",
    "RGF_A03" = "RGF Anexo 03 - Garantias e Contragarantias",
    "RGF_A04" = "RGF Anexo 04 - OperaÃ§Ãµes de CrÃ©dito",
    "RGF_A05" = "RGF Anexo 05 - Disponibilidades (UniÃ£o)",
    "RGF_T04" = "RGF Tabela 04 - Disponibilidade e RAP",
    "RREO_A01" = "RREO Anexo 01 - BalanÃ§o OrÃ§amentÃ¡rio",
    "RREO_A02" = "RREO Anexo 02 - FunÃ§Ã£o/SubfunÃ§Ã£o",
    "RREO_A03" = "RREO Anexo 03 - RCL",
    "RREO_A04" = "RREO Anexo 04 - PrevidÃªncia",
    "RREO_A06" = "RREO Anexo 06 - Resultado PrimÃ¡rio",
    "RREO_A07" = "RREO Anexo 07 - Restos a Pagar",
    "RREO_A08" = "RREO Anexo 08 - MDE",
    "RREO_A09" = "RREO Anexo 09 - Regra de Ouro",
    "RREO_A11" = "RREO Anexo 11 - Regime PrÃ³prio",
    "RREO_A12" = "RREO Anexo 12 - SaÃºde",
    "RREO_T01" = "RREO Tabela 01 - Receitas",
    "RREO_T02" = "RREO Tabela 02 - Seguridade",
    "RREO_T03" = "RREO Tabela 03 - ConsolidaÃ§Ã£o",
    "RREO_T04" = "RREO Tabela 04 - UniÃ£o/Executivo",
    rel
  )
  cat(sprintf("â•‘   âœ“ %-58s â•‘\n", nome_desc))
}

# Mostrar dependÃªncias adicionadas
if (INCLUIR_DEPENDENCIAS) {
  dependencias_adicionadas <- setdiff(RELATORIOS_EXECUTAR, RELATORIOS_SOLICITADOS)
  if (length(dependencias_adicionadas) > 0) {
    cat("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\n")
    cat("â•‘ ğŸ”— DEPENDÃŠNCIAS ADICIONADAS AUTOMATICAMENTE:                   â•‘\n")
    for (dep in dependencias_adicionadas) {
      nome_desc <- switch(dep,
        "RREO_A03" = "RREO Anexo 03 - RCL (para cÃ¡lculo de limites)",
        "RGF_A02" = "RGF Anexo 02 - DCL (para resultado primÃ¡rio)",
        dep
      )
      cat(sprintf("â•‘   + %-58s â•‘\n", nome_desc))
    }
  }
}

cat("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\n")
cat(sprintf("â•‘ Total de relatÃ³rios a executar: %-30d â•‘\n", length(RELATORIOS_EXECUTAR)))
cat("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\n")
cat("â•‘ ğŸ“ CONJUNTOS DE DADOS A CARREGAR:                              â•‘\n")
for (dados in DADOS_CARREGAR) {
  nome_dados <- switch(dados,
    "dados_rcl" = "RCL (Receita Corrente LÃ­quida)",
    "dados_rgf_a01" = "RGF A01 (Despesa Pessoal)",
    "dados_rgf_a02" = "RGF A02 (DCL)",
    "dados_rgf_a03" = "RGF A03 (Garantias)",
    "dados_rgf_a04" = "RGF A04 (OperaÃ§Ãµes CrÃ©dito)",
    "dados_rgf_a05" = "RGF A05 (Disponibilidades)",
    "dados_despesa_rreo" = "Despesas RREO",
    "dados_receita" = "Receitas",
    "dados_rp" = "Restos a Pagar",
    "dados_contabeis" = "Dados ContÃ¡beis",
    "dados_regra_ouro" = "Regra de Ouro",
    dados
  )
  cat(sprintf("â•‘   ğŸ“¦ %-57s â•‘\n", nome_dados))
}
cat("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")
cat("\n")

# ============================================================================
# HASH PARA INVALIDAÃ‡ÃƒO DE CACHE
# ============================================================================
# Esta variÃ¡vel muda quando os parÃ¢metros mudam, invalidando o cache
CACHE_KEY <- digest::digest(list(
  relatorios = RELATORIOS_EXECUTAR,
  mes = MES_REF,
  timestamp = format(Sys.Date(), "%Y%m%d")
))

# ============================================================================
# AVISO SOBRE CACHE
# ============================================================================
cat("ğŸ’¡ DICA: Se os resultados nÃ£o mudarem apÃ³s alterar os parÃ¢metros,\n")
cat("   limpe o cache com: quarto render --cache-refresh\n")
cat(sprintf("   Cache Key: %s\n\n", substr(CACHE_KEY, 1, 8)))
```

# ğŸ“š Carregamento de Bibliotecas e ConfiguraÃ§Ãµes {#sec-setup}

```{r setup}
#| include: false
#| eval: !expr executar_modulo("SETUP")

# Bibliotecas principais
library(dplyr)
library(tidyr)
library(stringr)
library(readxl)
library(janitor)
library(purrr)
library(forcats)
library(DT)
library(knitr)
library(kableExtra)
library(readr)
library(scales)
library(lubridate)
library(digest)  # Para hash de cache

Sys.setlocale("LC_TIME", "pt_BR.UTF-8")

# ConfiguraÃ§Ãµes globais
options(OutDec = ".")
options(scipen = 999)

# ConfiguraÃ§Ãµes DT
options(DT.options = 
  list(
    pageLength = 50,
    lengthMenu = c(5, 10, 25, 50, 100),
    language = list(url = '//cdn.datatables.net/plug-ins/1.10.11/i18n/Portuguese.json')
  )
)

# ============================================================================
# âš¡ OTIMIZAÃ‡Ã•ES DE PERFORMANCE E PARALELIZAÃ‡ÃƒO
# ============================================================================

# Carregar bibliotecas de paralelizaÃ§Ã£o
suppressPackageStartupMessages({
  library(furrr)      # Para processamento paralelo com purrr
  library(future)     # Backend de paralelizaÃ§Ã£o
  library(data.table) # Para operaÃ§Ãµes ultrarrÃ¡pidas em dados grandes
})

# Detectar recursos disponÃ­veis
cores_disponiveis <- parallel::detectCores()

# Obter memÃ³ria total (compatÃ­vel com Windows)
memoria_info <- tryCatch({
  resultado <- system("wmic computersystem get totalphysicalmemory", intern = TRUE)
  as.numeric(gsub("[^0-9]", "", resultado[2])) / (1024^3)
}, error = function(e) {
  32.0  # Fallback
})

cat("\n")
cat("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n")
cat("â•‘        âš¡ OTIMIZAÃ‡ÃƒO DE PERFORMANCE - SISTEMA ATIVADO        â•‘\n")
cat("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\n")
cat(sprintf("â•‘ ğŸ–¥ï¸  CPU: %d cores disponÃ­veis%sâ•‘\n", 
    cores_disponiveis, 
    strrep(" ", 44 - nchar(as.character(cores_disponiveis)))))
cat(sprintf("â•‘ ğŸ’¾ RAM: %.1f GB%sâ•‘\n", 
    memoria_info, 
    strrep(" ", 48 - nchar(sprintf("%.1f GB", memoria_info)))))

# Configurar paralelizaÃ§Ã£o (usar atÃ© 10 cores, deixar 2 para o sistema)
cores_usar <- min(10, max(1, cores_disponiveis - 2))
cat(sprintf("â•‘ âš™ï¸  Cores para processamento paralelo: %d%sâ•‘\n", 
    cores_usar,
    strrep(" ", 29 - nchar(as.character(cores_usar)))))

# Configurar backend de paralelizaÃ§Ã£o
plan(multisession, workers = cores_usar)

# Desabilitar paralelizaÃ§Ã£o automÃ¡tica do data.table para evitar conflitos
setDTthreads(1)

cat("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\n")
cat("â•‘ âœ… ParalelizaÃ§Ã£o configurada e ativa                        â•‘\n")
cat("â•‘ âœ… OtimizaÃ§Ãµes de memÃ³ria ativadas                          â•‘\n")
cat("â•‘ âœ… Backend: future::multisession                            â•‘\n")
cat("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")
cat("\n")

# ============================================================================
# FUNÃ‡Ã•ES OTIMIZADAS PARA IMPORTAÃ‡ÃƒO PARALELA
# ============================================================================

# ============================================================================
# ğŸ”§ CORREÃ‡ÃƒO: FunÃ§Ã£o importar_excel_paralelo ATUALIZADA
# ============================================================================
# SUBSTITUA a funÃ§Ã£o antiga no chunk {r setup} por esta versÃ£o

importar_excel_paralelo <- function(arquivos, skip = 5, .progress = TRUE) {
  if (length(arquivos) == 0) {
    warning("Nenhum arquivo fornecido")
    return(data.frame())
  }
  
  cat(sprintf("ğŸ“¥ Importando %d arquivos em paralelo...\n", length(arquivos)))
  
  resultado <- future_map_dfr(
    arquivos, 
    function(arq) {
      df <- read_excel(arq, skip = skip, col_types = "text") %>%
        clean_names()
      
      # ============================================================================
      # âœ… CONVERSÃƒO AUTOMÃTICA DE COLUNAS NUMÃ‰RICAS
      # ============================================================================
      # PadrÃµes de nomes de colunas que devem ser numÃ©ricas
      numeric_patterns <- c(
        "^saldo_r",           # saldo_r_item_informacao, saldo_r_conta_contabil
        "^movim.*_r",         # movim_liquido_r_item_informacao
        "^valor",             # valor_lancado, valor_empenhado, valor_liquidado
        "_valor$",            # qualquer_coisa_valor
        "_saldo$",            # qualquer_coisa_saldo
        "saldo.*atual",       # saldo_dotacao_atual
        "mes_lancamento"      # mes_lancamento
      )
      
      # Encontrar colunas que correspondem aos padrÃµes
      cols_numericas <- names(df)[str_detect(names(df), 
                                              paste(numeric_patterns, collapse = "|"))]
      
      # Converter para numÃ©rico (com suppressWarnings para NAs esperados)
      if (length(cols_numericas) > 0) {
        df <- df %>%
          mutate(across(all_of(cols_numericas), ~ suppressWarnings(as.numeric(.))))
      }
      
      return(df)
    },
    .progress = .progress,
    .options = furrr_options(seed = TRUE)
  )
  
  cat(sprintf("âœ… ImportaÃ§Ã£o concluÃ­da: %s registros\n", 
              format(nrow(resultado), big.mark = ".", decimal.mark = ",")))
  
  # Mostrar quais colunas foram convertidas
  cols_convertidas <- names(resultado)[sapply(resultado, is.numeric)]
  if (length(cols_convertidas) > 0) {
    cat(sprintf("   ğŸ“Š Colunas numÃ©ricas: %d\n", length(cols_convertidas)))
  }
  
  return(resultado)
}

cat("âœ… FunÃ§Ã£o importar_excel_paralelo() ATUALIZADA carregada!\n\n")



# Operadores customizados
`%notin%` <- Negate(`%in%`)
`%||%` <- function(x, y) if(is.null(x) || length(x) == 0 || is.na(x)) y else x

formatar_numero <- function(x) {
  format(x, big.mark = ".", decimal.mark = ",", scientific = FALSE, nsmall = 2)
}

print("âœ… Bibliotecas carregadas com sucesso!")
```

## ğŸ”§ VariÃ¡veis Globais

```{r variaveis_globais}
#| eval: !expr executar_modulo("SETUP")
# Filtro principal do mÃªs
mes_filtro <- params$mes_referencia

mes_pasta <- str_c("data/",mes_filtro,"/")

print(paste("ğŸ“… MÃªs de referÃªncia definido:", mes_filtro))
```

# ğŸ“¥ ImportaÃ§Ã£o dos Dados {#sec-dados}

## ğŸ§¾ Dados de Receita

```{r dados_receita}
#| cache: true
#| cache.lazy: false
#| cache.extra: !expr file.mtime(list.files(mes_pasta, full.names = TRUE))
#| echo: true
#| eval: true
#| include: false

# ============================================================================
# âš¡ VERSÃƒO OTIMIZADA - IMPORTAÃ‡ÃƒO PARALELA
# ============================================================================

# Definir arquivos a importar
arquivos_receita <- c(
  str_c(mes_pasta, "tg_receita_liquida.xlsx"),
  str_c(mes_pasta, "tg_receita_previsao.xlsx")
)

cat("ğŸ“¥ Importando dados de receita em paralelo...\n")

# Importar ambos os arquivos simultaneamente
dados_receita <- importar_excel_paralelo(
  arquivos = arquivos_receita, 
  skip = 5, 
  .progress = TRUE
) %>%
  # Filtrar e transformar uma Ãºnica vez
  filter(orgao_uge_orcam_fiscal_s_n == "PERTENCE") %>%
  mutate(
    # ConversÃ£o de data
    mes_lancamento = as.numeric(mes_lancamento),
    data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1),
    
    # VariÃ¡veis derivadas
    tipo_modalidade = ifelse(
      nre1_categoria_economica_codigo %in% c(7, 8), 
      "intra", 
      "exceto intra"
    ),
    
    refinanciamento = ifelse(
      natureza_receita_codigo_completo %in% c(81110201, 21110201, 21210201), 
      "sim", 
      "nao"
    )
  )

cat(sprintf("âœ… Dados de receita carregados: %s registros\n", 
            format(nrow(dados_receita), big.mark = ".", decimal.mark = ",")))
cat(sprintf("   â€¢ MemÃ³ria utilizada: %.1f MB\n", 
            object.size(dados_receita) / 1024^2))
```

## ğŸ’° Dados de Despesa

```{r dados_despesa_rreo}
#| echo: true
#| cache: true
#| cache.lazy: false
#| cache.extra: !expr file.mtime(list.files(mes_pasta, full.names = TRUE))
#| include: false

# ============================================================================
# âš¡ VERSÃƒO OTIMIZADA - IMPORTAÃ‡ÃƒO PARALELA
# ============================================================================

# Buscar todos os arquivos de despesa
arq_despesa <- list.files(
  path = mes_pasta, 
  pattern = 'tg_despesa', 
  full.names = TRUE
)

cat(sprintf("ğŸ“¥ Importando %d arquivos de despesa em paralelo...\n", length(arq_despesa)))

# Importar todos os arquivos simultaneamente
dados_despesa <- importar_excel_paralelo(
  arquivos = arq_despesa, 
  skip = 5, 
  .progress = TRUE
) %>%
  # Filtrar e transformar
  filter(orgao_uge_orcam_fiscal_s_n == "PERTENCE") %>%
  mutate(
    # Converter colunas numÃ©ricas especÃ­ficas
    across(contains("saldo"), as.numeric),
    across(contains("valor"), as.numeric),
    mes_lancamento = as.numeric(mes_lancamento),
    
    # ConversÃ£o de data
    data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1),
    
    # VariÃ¡veis derivadas - tipo_modalidade
    tipo_modalidade = ifelse(
      modalidade_aplicacao_codigo == 91,
      "intra",
      "exceto intra"
    ),
    
    # VariÃ¡veis derivadas - refinanciamento
    refinanciamento = case_when(
      grupo_despesa_codigo_grupo == 6 &
        elemento_despesa_codigo %in% c(76, 77) &
        subfuncao_governo_codigo %in% c(841, 842, 843, 844, 846) &
        fonte_recursos_codigo == "443" ~ "sim",
      !(grupo_despesa_codigo_grupo == 6 &
        elemento_despesa_codigo %in% c(76, 77) &
        subfuncao_governo_codigo %in% c(841, 842, 843, 844, 846) &
        fonte_recursos_codigo == "443") ~ "nao",
      TRUE ~ "escape"
    ),
    
    # VariÃ¡veis derivadas - poder
    poder = case_when(
      orgao_uge_orgao_maximo_codigo %in% c(59000) ~ "MINISTÃ‰RIO PÃšBLICO DA UNIÃƒO",
      orgao_uge_orgao_maximo_codigo %in% c(29000) ~ "DEFENSORIA PÃšBLICA",
      TRUE ~ orgao_uge_poder_nome
    ),
    
    # VariÃ¡veis derivadas - transferencia
    transferencia = ifelse(
      modalidade_aplicacao_codigo %in% c('30', '31', '32', '35', '36', '40', '41', '42', '45', '46'), 
      "_transferencia", 
      "aplicacao_direta"
    )
  )

cat(sprintf("âœ… Dados de despesa carregados: %s registros\n", 
            format(nrow(dados_despesa), big.mark = ".", decimal.mark = ",")))
cat(sprintf("   â€¢ Arquivos processados: %d\n", length(arq_despesa)))
cat(sprintf("   â€¢ MemÃ³ria utilizada: %.1f MB\n", 
            object.size(dados_despesa) / 1024^2))

# EstatÃ­sticas rÃ¡pidas
cat("\nğŸ“Š Resumo por tipo_modalidade:\n")
print(dados_despesa %>% count(tipo_modalidade, sort = TRUE))

cat("\nğŸ“Š Resumo por refinanciamento:\n")
print(dados_despesa %>% count(refinanciamento, sort = TRUE))
```

## ğŸ“‹ Dados de Restos a Pagar

```{r dados_rp}
#| echo: true
#| cache: true
#| cache.lazy: false
#| include: false

# ============================================================================
# âš¡ VERSÃƒO OTIMIZADA - IMPORTAÃ‡ÃƒO PARALELA MANTENDO ESTRUTURAS SEPARADAS
# ============================================================================

# Definir lista de arquivos a importar
arquivos_rp <- list(
  anexo_07 = str_c(mes_pasta, "tg_rp_anexo_07.xlsx"),
  anexo_12 = str_c(mes_pasta, "tg_rp_anexo_12.xlsx"),
  anexo_08 = str_c(mes_pasta, "tg_rp_anexo_08.xlsx"),
  anexo_03_rcl = str_c(mes_pasta, "tg_rp_anexo_03_rcl.xlsx")
)

cat(sprintf("ğŸ“¥ Importando %d arquivos de RP em paralelo...\n", length(arquivos_rp)))

# Importar todos simultaneamente, cada um mantÃ©m sua estrutura prÃ³pria
tempo_inicio <- Sys.time()

dados_rp_lista <- future_map(
  arquivos_rp,
  function(arquivo) {
    read_excel(arquivo, skip = 5) %>%
      clean_names() %>%
      mutate(
        mes_lancamento = as.numeric(mes_lancamento),
        data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1)
      )
  },
  .progress = TRUE,
  .options = furrr_options(seed = TRUE)
)

tempo_fim <- Sys.time()

# Extrair cada arquivo para sua variÃ¡vel especÃ­fica
# Anexo 07 precisa de transformaÃ§Ãµes adicionais
dados_rp_anexo_07 <- dados_rp_lista$anexo_07 %>%
  mutate(
    tipo_modalidade = ifelse(
      modalidade_aplicacao_codigo == 91, 
      "intra", 
      "exceto intra"
    ),
    poder = case_when(
      orgao_uge_orgao_maximo_codigo %in% c(59000) ~ "MINISTÃ‰RIO PÃšBLICO DA UNIÃƒO",
      orgao_uge_orgao_maximo_codigo %in% c(29000) ~ "DEFENSORIA PÃšBLICA",
      TRUE ~ orgao_uge_poder_nome
    )
  )

# Outros anexos mantÃªm estrutura bÃ¡sica
dados_rp_anexo_12 <- dados_rp_lista$anexo_12
dados_rp_anexo_08 <- dados_rp_lista$anexo_08
dados_rp_anexo_03_rcl <- dados_rp_lista$anexo_03_rcl

# RelatÃ³rio de importaÃ§Ã£o
cat("\nâœ… Dados de Restos a Pagar carregados:\n")
cat(sprintf("   â€¢ Anexo 07: %s registros (%.1f MB)\n", 
            format(nrow(dados_rp_anexo_07), big.mark = ".", decimal.mark = ","),
            object.size(dados_rp_anexo_07) / 1024^2))
cat(sprintf("   â€¢ Anexo 12: %s registros (%.1f MB)\n", 
            format(nrow(dados_rp_anexo_12), big.mark = ".", decimal.mark = ","),
            object.size(dados_rp_anexo_12) / 1024^2))
cat(sprintf("   â€¢ Anexo 08: %s registros (%.1f MB)\n", 
            format(nrow(dados_rp_anexo_08), big.mark = ".", decimal.mark = ","),
            object.size(dados_rp_anexo_08) / 1024^2))
cat(sprintf("   â€¢ Anexo 03 RCL: %s registros (%.1f MB)\n", 
            format(nrow(dados_rp_anexo_03_rcl), big.mark = ".", decimal.mark = ","),
            object.size(dados_rp_anexo_03_rcl) / 1024^2))

# MemÃ³ria total
memoria_total <- (object.size(dados_rp_anexo_07) + 
                  object.size(dados_rp_anexo_12) + 
                  object.size(dados_rp_anexo_08) + 
                  object.size(dados_rp_anexo_03_rcl)) / 1024^2

cat(sprintf("   â€¢ MemÃ³ria total: %.1f MB\n", memoria_total))
cat(sprintf("   â€¢ Tempo de importaÃ§Ã£o: %.1f segundos\n", 
            as.numeric(difftime(tempo_fim, tempo_inicio, units = "secs"))))
```

## ğŸ¦ Dados RREO Anexo 06 - Resultado PrimÃ¡rio

```{r dados_rreo_a06_resultado_primario}
#| echo: true
#| cache: true
#| cache.lazy: false
#| include: false

# ============================================================================
# âš¡ VERSÃƒO OTIMIZADA - IMPORTAÃ‡ÃƒO PARALELA DE 4 ARQUIVOS
# ============================================================================

# Definir arquivos
arquivos_a06 <- list(
  ndd = str_c(mes_pasta, "tg_anexo_06_rreo_despesas_primarias_ndd.xlsx"),
  categoria_grupo = str_c(mes_pasta, "tg_anexo_06_rreo_despesas_primarias_categoria_grupo.xlsx"),
  juros = str_c(mes_pasta, "tg_RPN_juros.xlsx"),
  disponibilidades = str_c(mes_pasta, "tg_RPN_disponibilidades.xlsx")
)

cat(sprintf("ğŸ“¥ Importando %d arquivos do Anexo 06 em paralelo...\n", length(arquivos_a06)))

# Importar todos simultaneamente
dados_a06_lista <- future_map(
  arquivos_a06,
  function(arquivo) {
    read_excel(arquivo, skip = 5) %>%
      clean_names() %>%
      mutate(
        mes_lancamento = as.numeric(mes_lancamento),
        data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1)
      )
  },
  .progress = TRUE,
  .options = furrr_options(seed = TRUE)
)

# Extrair para variÃ¡veis especÃ­ficas
dados_ndd <- dados_a06_lista$ndd
dados_categoria_grupo <- dados_a06_lista$categoria_grupo
dados_juros <- dados_a06_lista$juros
tg_RPN_juros <- dados_juros  # Alias para compatibilidade
tg_RPN_disponibilidades <- dados_a06_lista$disponibilidades

cat("\nâœ… Dados do Anexo 06 carregados:\n")
cat(sprintf("   â€¢ NDD: %s registros\n", 
            format(nrow(dados_ndd), big.mark = ".", decimal.mark = ",")))
cat(sprintf("   â€¢ Categoria/Grupo: %s registros\n", 
            format(nrow(dados_categoria_grupo), big.mark = ".", decimal.mark = ",")))
cat(sprintf("   â€¢ Juros: %s registros\n", 
            format(nrow(dados_juros), big.mark = ".", decimal.mark = ",")))
cat(sprintf("   â€¢ Disponibilidades: %s registros\n", 
            format(nrow(tg_RPN_disponibilidades), big.mark = ".", decimal.mark = ",")))
```

## ğŸ“Š Dados RCL - RREO Anexo 03

```{r importar-dados-rcl}
#| eval: !expr carregar_dados("dados_rcl")
#| cache: true
#| cache.extra: !expr CACHE_KEY
#| include: false

cat("ğŸ“¥ Importando dados RCL (RREO A03)...\n")

# ============================================================================
# IMPORTAÃ‡ÃƒO
# ============================================================================

# Despesas
cat("   â€¢ Importando RCL Despesas...\n")
rreo_a03_rcl_despesas <- read_excel(
  str_c(mes_pasta, "rreo_a03_rcl_despesas.xlsx"), 
  skip = 5
) %>%
  clean_names() %>%
  mutate(
    # Converter coluna numÃ©rica
    movim_liquido_r_item_informacao = as.numeric(movim_liquido_r_item_informacao),
    mes_lancamento = as.numeric(mes_lancamento),
    data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1),
    # âœ… CRIAR ALIAS para compatibilidade com critÃ©rios
    saldo_r_item_informacao = movim_liquido_r_item_informacao
  )

# Receitas
cat("   â€¢ Importando RCL Receitas...\n")
rreo_a03_rcl_receitas <- read_excel(
  str_c(mes_pasta, "rreo_a03_rcl_receitas.xlsx"), 
  skip = 5
) %>%
  clean_names() %>%
  mutate(
    # Converter coluna numÃ©rica
    movim_liquido_r_item_informacao = as.numeric(movim_liquido_r_item_informacao),
    mes_lancamento = as.numeric(mes_lancamento),
    data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1),
    # âœ… CRIAR ALIAS para compatibilidade com critÃ©rios
    saldo_r_item_informacao = movim_liquido_r_item_informacao
  )

cat(sprintf("\nâœ“ RCL Despesas: %s registros\n", 
            format(nrow(rreo_a03_rcl_despesas), big.mark = ".", decimal.mark = ",")))
cat(sprintf("âœ“ RCL Receitas: %s registros\n", 
            format(nrow(rreo_a03_rcl_receitas), big.mark = ".", decimal.mark = ",")))

# ============================================================================
# VERIFICAÃ‡ÃƒO
# ============================================================================
cat("\nğŸ” VerificaÃ§Ã£o:\n")
cat(sprintf("   Colunas em despesas: %d\n", ncol(rreo_a03_rcl_despesas)))
cat(sprintf("   Colunas em receitas: %d\n", ncol(rreo_a03_rcl_receitas)))

# Verificar que alias foi criado e Ã© numÃ©rico
cat("\nâœ… Alias 'saldo_r_item_informacao' criado:\n")
cat(sprintf("   Despesas: %s (tipo: %s)\n", 
            "saldo_r_item_informacao" %in% names(rreo_a03_rcl_despesas),
            class(rreo_a03_rcl_despesas$saldo_r_item_informacao)[1]))
cat(sprintf("   Receitas: %s (tipo: %s)\n", 
            "saldo_r_item_informacao" %in% names(rreo_a03_rcl_receitas),
            class(rreo_a03_rcl_receitas$saldo_r_item_informacao)[1]))

# Teste de agregaÃ§Ã£o
cat("\nğŸ§ª Teste de agregaÃ§Ã£o:\n")
teste_desp <- rreo_a03_rcl_despesas %>% 
  summarise(
    total_movim = sum(movim_liquido_r_item_informacao, na.rm = TRUE),
    total_saldo = sum(saldo_r_item_informacao, na.rm = TRUE)
  )
cat(sprintf("   Despesas (movim_liquido): %s\n", 
            format(teste_desp$total_movim, big.mark = ".", decimal.mark = ",")))
cat(sprintf("   Despesas (saldo_r alias): %s\n", 
            format(teste_desp$total_saldo, big.mark = ".", decimal.mark = ",")))

teste_rec <- rreo_a03_rcl_receitas %>% 
  summarise(
    total_movim = sum(movim_liquido_r_item_informacao, na.rm = TRUE),
    total_saldo = sum(saldo_r_item_informacao, na.rm = TRUE)
  )
cat(sprintf("   Receitas (movim_liquido): %s\n", 
            format(teste_rec$total_movim, big.mark = ".", decimal.mark = ",")))
cat(sprintf("   Receitas (saldo_r alias): %s\n", 
            format(teste_rec$total_saldo, big.mark = ".", decimal.mark = ",")))

cat("\nâœ… ImportaÃ§Ã£o RCL concluÃ­da com sucesso!\n")
```

## ğŸ‘¥ Dados RGF Anexo 01 - Despesa com Pessoal

```{r importar-dados-rgf-a01}
#| eval: !expr carregar_dados("dados_rgf_a01")
#| cache: true
#| cache.extra: !expr CACHE_KEY
#| include: false

cat("ğŸ“¥ Importando dados RGF A01 (Despesa Pessoal)...\n")

# ============================================================================
# âš¡ VERSÃƒO OTIMIZADA - IMPORTAÃ‡ÃƒO PARALELA
# ============================================================================

# RGF Anexo 1
arq_rgf_a01 <- list.files(path = mes_pasta, pattern = 'rgf_a01_', full.names = TRUE)

cat(sprintf("   Encontrados %d arquivos\n", length(arq_rgf_a01)))

rgf_a01 <- importar_excel_paralelo(arq_rgf_a01, skip = 5, .progress = TRUE) %>%
  mutate(
    movim_liquido_r_item_informacao = as.numeric(movim_liquido_r_item_informacao),
    mes_lancamento = as.numeric(mes_lancamento),
    data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1)
  )

cat(sprintf("âœ“ RGF A01: %s registros (%d arquivos)\n", 
            format(nrow(rgf_a01), big.mark = ".", decimal.mark = ","), 
            length(arq_rgf_a01)))
```

## ğŸ›ï¸ Dados RGF Anexo 02 - DÃ­vida Consolidada LÃ­quida (DCL)

```{r importar-dados-rgf-a02}
#| eval: !expr carregar_dados("dados_rgf_a02")
#| cache: true
#| cache.extra: !expr CACHE_KEY
#| include: false

cat("ğŸ“¥ Importando dados RGF A02 (DCL)...\n")

# ============================================================================
# âš¡ VERSÃƒO OTIMIZADA - IMPORTAÃ‡ÃƒO PARALELA
# ============================================================================

# FunÃ§Ã£o auxiliar para processar arquivo (mantida para compatibilidade)
processar_arquivo_rgf_a02 <- function(file_path, skip_rows = 5) {
  df <- read_excel(file_path, skip = skip_rows, col_types = "text") %>%
    clean_names()
  
  if ("mes_lancamento" %in% names(df)) {
    df <- df %>%
      mutate(
        mes_lancamento = as.numeric(mes_lancamento),
        data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1)
      )
  }
  
  # Converte colunas numÃ©ricas automaticamente
  numeric_patterns <- c("^saldo_r", "^movim_liquido_r")
  cols_to_convert <- names(df)[str_detect(names(df), paste(numeric_patterns, collapse = "|"))]
  
  for (col in cols_to_convert) {
    df <- df %>% mutate(!!sym(col) := as.numeric(!!sym(col)))
  }
  
  return(df)
}

# Lista TODOS os arquivos rgf_a02_*.xlsx
arq_rgf_a02 <- list.files(
  path = mes_pasta,
  pattern = "^rgf_a02_.*\\.xlsx$",
  full.names = TRUE
)

cat(sprintf("   Encontrados %d arquivos\n", length(arq_rgf_a02)))

# Processar em paralelo
rgf_a02_list <- future_map(
  arq_rgf_a02,
  processar_arquivo_rgf_a02,
  .progress = TRUE,
  .options = furrr_options(seed = TRUE)
)

# Nomeia os dataframes
names(rgf_a02_list) <- basename(arq_rgf_a02) %>% str_remove("\\.xlsx$")

# Coloca cada um no ambiente global
list2env(rgf_a02_list, envir = .GlobalEnv)

cat(sprintf("âœ“ RGF A02: %d arquivos importados\n", length(arq_rgf_a02)))
```

## ğŸ” Dados RGF Anexo 03 - Garantias e Contragarantias

```{r importar-dados-rgf-a03}
#| eval: !expr carregar_dados("dados_rgf_a03")
#| cache: true
#| cache.extra: !expr CACHE_KEY
#| include: false

cat("ğŸ“¥ Importando dados RGF A03 (Garantias)...\n")

# RGF Anexo 3
rgf_a03 <- read_excel(str_c(mes_pasta, "rgf_a03.xlsx"), skip = 5) %>%
  clean_names() %>%
  mutate(
    mes_lancamento = as.numeric(mes_lancamento),
    data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1)
  )

cat(sprintf("âœ“ RGF A03: %s registros\n", 
            format(nrow(rgf_a03), big.mark = ".", decimal.mark = ",")))
```

## ğŸ’³ Dados RGF Anexo 04 - OperaÃ§Ãµes de CrÃ©dito

```{r importar-dados-rgf-a04}
#| eval: !expr carregar_dados("dados_rgf_a04")
#| cache: true
#| cache.extra: !expr CACHE_KEY
#| include: false
#| column: screen

cat("ğŸ“¥ Importando dados RGF A04 (OperaÃ§Ãµes CrÃ©dito)...\n")

# ============================================================================
# âš¡ VERSÃƒO OTIMIZADA - IMPORTAÃ‡ÃƒO PARALELA
# ============================================================================

arquivos_a04 <- list(
  receitas = str_c(mes_pasta, "rgf_a04_receitas.xlsx"),
  despesas = str_c(mes_pasta, "rgf_a04_despesas.xlsx")
)

# Importar em paralelo
dados_a04_lista <- future_map(
  arquivos_a04,
  function(arquivo) {
    read_excel(arquivo, skip = 5) %>%
      clean_names() %>%
      mutate(
        mes_lancamento = as.numeric(mes_lancamento),
        data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1)
      )
  },
  .progress = TRUE
)

rgf_a04_receitas <- dados_a04_lista$receitas
rgf_a04_despesas <- dados_a04_lista$despesas

cat(sprintf("âœ“ RGF A04 Receitas: %s registros\n", 
            format(nrow(rgf_a04_receitas), big.mark = ".", decimal.mark = ",")))
cat(sprintf("âœ“ RGF A04 Despesas: %s registros\n", 
            format(nrow(rgf_a04_despesas), big.mark = ".", decimal.mark = ",")))
```

## ğŸ’° Dados RGF Anexo 05 - Disponibilidades de Caixa

```{r importar-dados-rgf-a05}
#| eval: !expr carregar_dados("dados_rgf_a05")
#| cache: true
#| cache.extra: !expr CACHE_KEY
#| include: false

cat("ğŸ“¥ Importando dados RGF A05 (Disponibilidades)...\n")

# ============================================================================
# âš¡ VERSÃƒO OTIMIZADA - IMPORTAÃ‡ÃƒO PARALELA
# ============================================================================

# Buscar todos os arquivos rgf_a05
arq_rgf_a05 <- list.files(path = mes_pasta, pattern = 'rgf_a05', full.names = TRUE)

cat(sprintf("   Encontrados %d arquivos\n", length(arq_rgf_a05)))

rgf_a05 <- importar_excel_paralelo(arq_rgf_a05, skip = 5, .progress = TRUE) %>%
  mutate(
    saldo_r_conta_contabil = as.numeric(saldo_r_conta_contabil),
    mes_lancamento = as.numeric(mes_lancamento),
    data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1)
  )

cat(sprintf("âœ“ RGF A05: %s registros (%d arquivos)\n", 
            format(nrow(rgf_a05), big.mark = ".", decimal.mark = ","), 
            length(arq_rgf_a05)))
```

# FunÃ§Ãµes {#sec-funcoes-aux}

## Aplicar CritÃ©rios

```{r}
#| include: false

aplicar_criterios <- function(df, criterios, group_vars = NULL) {
  
  # Detectar automaticamente a mÃ©trica
  metrica <- names(df)[grepl("^(saldo|movim)", names(df), ignore.case = TRUE)][1]
  
  # Capturar o nome do dataframe passado como argumento
  df_completo <- paste(deparse(substitute(df)), collapse = " ")
  
  # Separar nome da df de eventuais filtros
  if (grepl("%>%", df_completo)) {
    # Se hÃ¡ pipe, extrair apenas o nome da df original
    df_nome <- trimws(strsplit(df_completo, "%>%")[[1]][1])
    df_filtros <- paste(strsplit(df_completo, "%>%")[[1]][-1], collapse = " %>% ")
    df_filtros <- trimws(df_filtros)
  } else {
    # Se nÃ£o hÃ¡ pipe, usar o nome completo
    df_nome <- df_completo
    df_filtros <- NA
  }
  
  # Capturar o nome da variÃ¡vel criterios passada como argumento
  criterios_nome <- deparse(substitute(criterios))
  
  # Definir variÃ¡veis de agrupamento
  # Se group_vars nÃ£o foi fornecido, usar mes_lancamento e data_lancamento como padrÃ£o
  if (is.null(group_vars)) {
    group_vars <- c("mes_lancamento", "data_lancamento")
  } else {
    # Garantir que mes_lancamento e data_lancamento estejam sempre incluÃ­dos
    if (!"mes_lancamento" %in% group_vars) {
      group_vars <- c("mes_lancamento", group_vars)
    }
    if (!"data_lancamento" %in% group_vars) {
      group_vars <- c("data_lancamento", group_vars)
    }
  }
  
  # Verificar se as colunas de agrupamento existem na df
  group_vars <- group_vars[group_vars %in% names(df)]
  
  # Desmembrar o nome da variÃ¡vel criterios usando "_" como separador
  partes <- strsplit(criterios_nome, "_")[[1]]
  
  # Remover "criterios" se estiver presente
  if (partes[1] == "criterios") {
    partes <- partes[-1]
  }
  
  relatorio <- if (length(partes) >= 1) partes[1] else NA
  anexo_codigo <- if (length(partes) >= 2) partes[2] else NA
  anexo_nome <- if (length(partes) >= 3) partes[3] else NA
  detalhe <- if (length(partes) >= 4) paste(partes[4:length(partes)], collapse = "_") else NA
  
  # Aplicar critÃ©rios - apenas filtros normais
  resultado <- map_df(names(criterios), function(categoria) {
    crit <- criterios[[categoria]]
    
    # Pular fÃ³rmulas matemÃ¡ticas - serÃ£o tratadas em calcular_operacoes
    if (grepl("\\{[^}]+\\}", crit$criterio)) {
      return(data.frame())
    }
    
    # Extrair informaÃ§Ã£o de print do nome da categoria
    if (grepl("_s$", categoria)) {
      print_flag <- "s"
      categoria_limpa <- str_replace(categoria, "_s$", "")
    } else if (grepl("_n$", categoria)) {
      print_flag <- "n"
      categoria_limpa <- str_replace(categoria, "_n$", "")
    } else {
      print_flag <- "s"  # default
      categoria_limpa <- categoria
    }
    
    # Avaliar condiÃ§Ã£o
    condicao_expr <- eval(parse(text = crit$criterio), envir = df)
    
    # Aplicar filtro e agrupar
    if (length(group_vars) > 0) {
      df %>%
        filter(condicao_expr) %>%
        group_by(across(all_of(group_vars))) %>%
        summarise(
          valor = sum(.data[[metrica]], na.rm = TRUE),
          .groups = "drop"
        ) %>%
        mutate(
          categoria = categoria_limpa,
          metrica = metrica,
          dataframe_nome = df_nome,
          dataframe_filtros = df_filtros,
          relatorio = relatorio,
          anexo_codigo = anexo_codigo,
          anexo_nome = anexo_nome,
          detalhe = detalhe,
          print = print_flag,
          filtro = crit$criterio
        ) %>%
        separate(categoria, into = c("ordem", "nome"), sep = 2, remove = FALSE) %>%
        select(any_of(c("mes_lancamento", "data_lancamento")), everything())
    } else {
      # Se nÃ£o hÃ¡ variÃ¡veis de agrupamento, retornar apenas o total
      df %>%
        filter(condicao_expr) %>%
        summarise(
          valor = sum(.data[[metrica]], na.rm = TRUE)
        ) %>%
        mutate(
          mes_lancamento = NA,
          data_lancamento = NA,
          categoria = categoria_limpa,
          metrica = metrica,
          dataframe_nome = df_nome,
          dataframe_filtros = df_filtros,
          relatorio = relatorio,
          anexo_codigo = anexo_codigo,
          anexo_nome = anexo_nome,
          detalhe = detalhe,
          print = print_flag,
          filtro = crit$criterio
        ) %>%
        separate(categoria, into = c("ordem", "nome"), sep = 2, remove = FALSE) %>%
        select(any_of(c("mes_lancamento", "data_lancamento")), everything())
    }
  })
  
  # Criar o nome da nova dataframe com prefixo df_
  novo_nome <- paste0("df_", criterios_nome)
  
  # Atribuir o resultado Ã  nova dataframe no ambiente global
  assign(novo_nome, resultado, envir = .GlobalEnv)
  
  # Retornar o resultado tambÃ©m
  return(resultado)
}
```

```{r}
# FunÃ§Ã£o simplificada para consolidar todas as dataframes com prefixo "df_criterios"
consolidar_criterios <- function() {
  # Obter todos os objetos no ambiente global
  objetos <- ls(envir = .GlobalEnv)
  
  # Filtrar apenas as dataframes que comeÃ§am com "df_criterios"
  df_criterios <- objetos[grepl("^df_criterios", objetos)]
  
  if (length(df_criterios) == 0) {
    warning("Nenhuma dataframe com prefixo 'df_criterios' foi encontrada")
    return(data.frame())
  }
  
  # Obter todas as dataframes e combinÃ¡-las
  tabelas <- map(df_criterios, ~ get(.x, envir = .GlobalEnv))
  
  # Padronizar tipos de colunas antes de combinar - apenas se existirem
  tabelas_padronizadas <- map(tabelas, function(tabela) {
    
    # Converter colunas apenas se existirem
    if ("item_informacao_codigo" %in% names(tabela)) {
      tabela$item_informacao_codigo <- as.character(tabela$item_informacao_codigo)
    }
    if ("item_informacao_nome" %in% names(tabela)) {
      tabela$item_informacao_nome <- as.character(tabela$item_informacao_nome)
    }
    
    return(tabela)
  })
  
  # Combinar todas as tabelas
  resultado_completo <- bind_rows(tabelas_padronizadas)
  
  # Identificar colunas disponÃ­veis para agrupamento
  colunas_base <- c("mes_lancamento", "ordem", "nome", "metrica", "dataframe_nome", "dataframe_filtros",
                   "relatorio", "anexo_codigo", "anexo_nome", "detalhe", "print", "filtro")
  
  # Adicionar colunas opcionais se existirem
  if ("item_informacao_nome" %in% names(resultado_completo)) {
    colunas_base <- c(colunas_base, "item_informacao_nome")
  }
  if ("item_informacao_codigo" %in% names(resultado_completo)) {
    colunas_base <- c(colunas_base, "item_informacao_codigo")
  }
  
  # Agrupar apenas pelas colunas que existem
  resultado <- resultado_completo %>%
    group_by(across(all_of(colunas_base))) %>%
    summarise(valor = sum(valor, na.rm = TRUE), .groups = "drop") %>%
    arrange(mes_lancamento, relatorio, anexo_codigo, detalhe, ordem) %>%
    mutate(
      # Converter mes_lancamento para data (Ãºltimo dia do mÃªs)
      data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1),
      # Criar chave Ãºnica
      chave = paste0(
        mes_lancamento, "_", 
        tolower(relatorio), "_", 
        tolower(anexo_codigo), "_", 
        tolower(detalhe), "_", 
        ordem
      )
    )
  
  # Reordenar colunas - apenas as que existem
  colunas_ordem <- c(
    "chave", "mes_lancamento", "data_lancamento", 
    "dataframe_nome", "dataframe_filtros", 
    "relatorio", "anexo_codigo", "anexo_nome", 
    "detalhe", "print", "filtro", "metrica"
  )
  
  if ("item_informacao_nome" %in% names(resultado)) {
    colunas_ordem <- c(colunas_ordem, "item_informacao_nome")
  }
  if ("item_informacao_codigo" %in% names(resultado)) {
    colunas_ordem <- c(colunas_ordem, "item_informacao_codigo")
  }
  
  colunas_ordem <- c(colunas_ordem, "ordem", "nome", "valor")
  
  # Selecionar apenas colunas que existem
  colunas_ordem <- colunas_ordem[colunas_ordem %in% names(resultado)]
  
  resultado <- resultado %>% select(all_of(colunas_ordem))
  
  # Atribuir ao ambiente global
  assign("df_criterios_consolidado", resultado, envir = .GlobalEnv)
  
  # Retornar tambÃ©m
  return(resultado)
}
```

## FormataÃ§Ã£o de NÃºmeros

```{r formatar_numero}
#| echo: true
#| include: false

#' Formatar nÃºmeros para exibiÃ§Ã£o brasileira
#' @param x Vetor numÃ©rico a ser formatado
#' @return String formatada com ponto como separador de milhares e vÃ­rgula como decimal
formatar_numero <- function(x) {
  format(x, big.mark = ".", decimal.mark = ",", scientific = FALSE, nsmall = 2)
}

# Teste da funÃ§Ã£o
exemplo_numero <- 1234567.89
print(paste("NÃºmero original:", exemplo_numero))
print(paste("NÃºmero formatado:", formatar_numero(exemplo_numero)))
```

## FormataÃ§Ã£o de Tabelas

```{r dt_formatada}
#| echo: true
#| include: false

#' Criar tabela DT formatada com totais
#' @param df Data frame a ser formatado
#' @param grupo Vetor com nomes das colunas de agrupamento (nÃ£o numÃ©ricas)
#' @return Objeto DT formatado
dt_formatada <- function(df, grupo) {
  # library(DT)
  # library(janitor)
  
  datatable(
    df %>% adorn_totals("row"), 
    rownames = FALSE,
    extensions = 'Buttons',
    options = list(
      lengthMenu = c(5, 10, 25, 50, 100),
      dom = 'Bfrtip',
      buttons = list('excel')
    )
  ) %>% 
  formatRound(
    setdiff(df %>% colnames(), grupo), 
    2, 
    mark = ".", 
    dec.mark = ","
  ) %>% 
  DT::formatStyle(
    columns = colnames(.$x$data), 
    fontSize = '75%'
  )
}

print("âœ… FunÃ§Ã£o dt_formatada definida")
```

## Tabela Pivotada

```{r tabela_pivotada}
#| echo: true
#| include: false

#' Pivotar tabela a partir dos itens de informaÃ§Ã£o
#' @param df Data frame com dados
#' @param grupo Vetor com nomes das colunas de agrupamento
#' @return Data frame pivotado e sumarizado
tabela_pivotada <- function(df, grupo) {
  # library(dplyr)
  # library(tidyr)
  
  # Obter itens Ãºnicos de informaÃ§Ã£o
  itens <- df$item_informacao_nome %>% unique() %>% na.omit()
  
  # Verificar se a coluna principal existe
  if (!"saldo_r_item_informacao" %in% names(df)) {
    stop("Coluna 'saldo_r_item_informacao' nÃ£o encontrada no data frame")
  }
  
  # Pivotar e sumarizar apenas a coluna numÃ©rica
  df %>% 
    group_by(!!!syms(grupo)) %>% 
    pivot_wider(
      names_from = item_informacao_nome, 
      values_from = saldo_r_item_informacao,
      values_fill = 0
    ) %>% 
    # Sumarizar apenas as colunas que correspondem aos itens (numÃ©ricas)
    summarise(
      across(all_of(itens), ~ sum(.x, na.rm = TRUE)),
      .groups = "drop"
    )
}


```

## Calcular operaÃ§Ãµes

```{r calcular_operacoes}
#| echo: true
#| include: false
# FunÃ§Ã£o para realizar operaÃ§Ãµes matemÃ¡ticas usando as chaves Ãºnicas
calcular_operacoes <- function(dados_consolidados = NULL, ...) {
  
  # Se dados nÃ£o fornecidos, usar consolidar_criterios()
  if (is.null(dados_consolidados)) {
    dados_consolidados <- consolidar_criterios()
  }
  
  # Capturar as operaÃ§Ãµes passadas como argumentos
  operacoes <- list(...)
  
  if (length(operacoes) == 0) {
    stop("Nenhuma operaÃ§Ã£o foi especificada")
  }
  
  # Criar um lookup table para facilitar a busca
  lookup_valores <- setNames(dados_consolidados$valor, dados_consolidados$chave)
  
  # Processar cada operaÃ§Ã£o
  resultados <- map(names(operacoes), function(nome_operacao) {
    operacao <- operacoes[[nome_operacao]]
    
    if (is.character(operacao)) {
      # OperaÃ§Ã£o simples: apenas a fÃ³rmula como string
      formula <- operacao
    } else if (is.list(operacao) && !is.null(operacao$formula)) {
      # OperaÃ§Ã£o estruturada
      formula <- operacao$formula
    } else {
      stop(paste("OperaÃ§Ã£o", nome_operacao, "deve ser uma string (fÃ³rmula) ou list com 'formula'"))
    }
    
    formula_processada <- formula
    
    # Encontrar todas as chaves na fÃ³rmula (padrÃ£o: YYYYMM_texto_texto_texto_NN)
    chaves <- str_extract_all(formula, "[0-9]{6}_[a-zA-Z0-9/_]+_[a-zA-Z0-9/_]+_[a-zA-Z0-9/_]+_[0-9]+")[[1]]
    
    for (chave in chaves) {
      valor <- ifelse(chave %in% names(lookup_valores), 
                      lookup_valores[[chave]], 
                      0)
      # Converter para numÃ©rico e usar format cientÃ­fico se necessÃ¡rio para evitar vÃ­rgulas
      valor_numerico <- as.numeric(valor)
      # Usar options para garantir notaÃ§Ã£o sem vÃ­rgula
      valor_limpo <- format(valor_numerico, scientific = FALSE, big.mark = "")
      
      formula_processada <- str_replace(formula_processada, 
                                        fixed(chave), 
                                        valor_limpo)
    }
    
    # Avaliar a expressÃ£o matemÃ¡tica
    resultado_calculo <- eval(parse(text = formula_processada))
    
    return(list(
      operacao = nome_operacao,
      formula_original = formula,
      formula_processada = formula_processada,
      resultado = resultado_calculo
    ))
  })
  
  names(resultados) <- names(operacoes)
  return(resultados)
}
```

```{r rgf-header}
#| eval: !expr executar_modulo("RGF")
#| echo: false
#| include: false

cat("\n")
cat("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")
cat("   RGF - RELATÃ“RIO DE GESTÃƒO FISCAL\n")
cat(sprintf("   PerÃ­odo: %s\n", MES_REF))
cat("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")
cat("\n")
```

# RGF - RelatÃ³rio de GestÃ£o Fiscal

# ğŸ“‹ RGF Anexo 01 (Despesa com Pessoal)

```{r}
#| eval: !expr executar_relatorio("RGF_A01")
#| code-fold: true
# ==============================================================================
# CRITÃ‰RIOS RGF ANEXO 01 - REORGANIZADO NA ORDEM OFICIAL
# ==============================================================================
# NumeraÃ§Ã£o compatÃ­vel com separate(categoria, sep = 2):
# - Grupo I: 11, 12, 13, 14, 15, 16, 17
# - Grupo II: 21, 22, 23, 24
# ==============================================================================

criterios_rgf_A01_pessoal_rgf <- list(
  
  # ===========================================================================
  # GRUPO I - COMPONENTES DA DESPESA BRUTA (ordem 1x)
  # ===========================================================================
  
  # 11 - VENCIMENTOS, VANTAGENS E OUTRAS DESPESAS VARIÃVEIS
  `11  Vencimentos, Vantagens e Outras Despesas VariÃ¡veis` = list(
    criterio = "
    grupo_despesa_codigo_grupo == '1' &
    !elemento_despesa_codigo %in% c('01', '03', '34') &
    
    # EXCLUSÃƒO: Filtro ObrigaÃ§Ãµes Patronais vg2024
    !(
      (substr(natureza_despesa_detalhada_codigo, 1, 1) == '3' &
       grupo_despesa_codigo_grupo == '1' &
       elemento_despesa_codigo == '92' &
       ((modalidade_aplicacao_codigo == '90' & natureza_despesa_detalhada_codigo %in% c('31909213', '31909207')) |
        (modalidade_aplicacao_codigo == '91' & natureza_despesa_detalhada_codigo == '31919213'))) |
      elemento_despesa_codigo %in% c('13', '07')
    ) &
    
    # EXCLUSÃƒO: Filtro Pessoal ATIVO - BenefÃ­cios PrevidenciÃ¡rios v2024
    !(
      (substr(natureza_despesa_detalhada_codigo, 1, 1) == '3' &
       grupo_despesa_codigo_grupo == '1' &
       elemento_despesa_codigo == '92' &
       natureza_despesa_detalhada_codigo == '31909205' &
       modalidade_aplicacao_codigo %in% c('90', '91')) |
      str_detect(natureza_despesa_detalhada_codigo, '0599')
    ) &
    
    # EXCLUSÃƒO: Filtro - Anexo 1 - Termos de Outros Inativos vg2024
    !str_detect(natureza_despesa_detalhada_nome, '\\\\bAPOSENT|\\\\bINAT|\\\\bREFORMA|\\\\bPENS|LEI 7\\\\.963/1989') &
    
    # EXCLUSÃƒO: Filtro Pessoal INATIVO - BenefÃ­cios PrevidenciÃ¡rios vg2024
    !(
      grupo_despesa_codigo_grupo == '1' &
      elemento_despesa_codigo == '05' &
      (str_detect(natureza_despesa_detalhada_codigo, '0505') | 
       str_detect(natureza_despesa_detalhada_codigo, '0506') |
       str_detect(natureza_despesa_detalhada_codigo, '0507') |
       str_detect(natureza_despesa_detalhada_codigo, '0508')) &
      elemento_despesa_codigo %in% c('05', '08', '09', '17', '91', '92', '94')
    )
    "
  ),
  
  # 12 - OBRIGAÃ‡Ã•ES PATRONAIS
  `12  ObrigaÃ§Ãµes Patronais` = list(
    criterio = "grupo_despesa_codigo_grupo == '1' & elemento_despesa_codigo %in% c('13', '07') | natureza_despesa_detalhada_codigo %in% c('31909213', '31919213', '31909207')"
  ),
  
  # 13 - APOSENTADORIAS, RESERVA E REFORMAS
  `13  Aposentadorias, Reserva e Reformas` = list(
    criterio = "grupo_despesa_codigo_grupo == '1' & elemento_despesa_codigo == '01' | natureza_despesa_detalhada_codigo %in% c('31901702', '31909109', '31909112', '31909115', '31909118', '31909123', '31909124', '31909128', '31909129', '31909201', '31909403', '31909404', '31909413', '31909414')"
  ),
  
  # 14 - PENSÃ•ES
  `14  PensÃµes` = list(
    criterio = "grupo_despesa_codigo_grupo == '1' & (elemento_despesa_codigo == '03' | natureza_despesa_detalhada_codigo %in% c('31909110', '31909113', '31909116', '31909119', '31909131', '31909136', '31909137', '31909130', '31909203', '31909220', '31909221', '31909406', '31909413'))"
  ),
  
  # 15 - OUTRAS DESPESAS COM INATIVOS
  `15  Outras Despesas com Inativos` = list(
    criterio = "grupo_despesa_codigo_grupo == '1' & elemento_despesa_codigo %in% c('05', '08', '09', '17', '31', '32') & str_detect(natureza_despesa_detalhada_nome, 'APOSENT|INAT|REFORMA|PEN|LEI 7\\\\.963/1989') & !(str_detect(natureza_despesa_detalhada_codigo, '0599') & natureza_despesa_detalhada_codigo %in% c('31909205', '31919205')) & !(str_detect(natureza_despesa_detalhada_codigo, '0505') | str_detect(natureza_despesa_detalhada_codigo, '0506') | str_detect(natureza_despesa_detalhada_codigo, '0507') | str_detect(natureza_despesa_detalhada_codigo, '0508'))"
  ),
  
  # 16 - OUTRAS DESPESAS DE PESSOAL - TERCEIRIZAÃ‡ÃƒO
  `16  Outras Despesas de Pessoal - TerceirizaÃ§Ã£o` = list(
    criterio = "grupo_despesa_codigo_grupo %in% c('1', '3') & elemento_despesa_codigo == '34'"
  ),
  
  # 17 - DESPESA COM PESSOAL NÃƒO EXECUTADA ORÃ‡AMENTARIAMENTE
  `17  Despesa com Pessoal nÃ£o Executada OrÃ§amentariamente` = list(
    criterio = "FALSE"  # Placeholder - ajustar conforme necessÃ¡rio
  ),
  
  # ===========================================================================
  # GRUPO II - DESPESAS NÃƒO COMPUTADAS (ordem 2x)
  # ===========================================================================
  
  # 21 - INDENIZAÃ‡Ã•ES POR DEMISSÃƒO E INCENTIVOS
  `21  IndenizaÃ§Ãµes por DemissÃ£o e Incentivos` = list(
    criterio = "
    grupo_despesa_codigo_grupo == '1' &
    elemento_despesa_codigo == '94' &
    !(
      fonte_recursos_codigo %in% c('023', '024', '055', '056') &
      str_detect(natureza_despesa_detalhada_nome, 'APOSENT|INAT|REFORMA|PEN|LEI 7\\\\.963/1989')
    )
    "
  ),
  
  # 22 - DECORRENTES DE DECISÃƒO JUDICIAL
  `22  Decorrentes de DecisÃ£o Judicial` = list(
    criterio = "
    grupo_despesa_codigo_grupo == '1' &
    elemento_despesa_codigo == '91' &
    !(
      fonte_recursos_codigo %in% c('023', '024', '055', '056') &
      str_detect(natureza_despesa_detalhada_nome, 'APOSENT|INAT|REFORMA|PEN|LEI 7\\\\.963/1989')
    )
    "
  ),
  
  # 23 - DESPESAS DE EXERCÃCIOS ANTERIORES
  `23  Despesas de ExercÃ­cios Anteriores` = list(
    criterio = "
    grupo_despesa_codigo_grupo == '1' &
    elemento_despesa_codigo == '92' &
    !(
      fonte_recursos_codigo %in% c('023', '024', '055', '056') &
      str_detect(natureza_despesa_detalhada_nome, 'APOSENT|INAT|REFORMA|PEN|LEI 7\\\\.963/1989')
    )
    "
  ),
  
  # 24 - INATIVOS E PENSIONISTAS COM RECURSOS VINCULADOS
  `24  Inativos e Pensionistas com Recursos Vinculados` = list(
    criterio = "
    grupo_despesa_codigo_grupo == '1' &
    fonte_recursos_codigo %in% c('023', '024', '055', '056') &
    (
      elemento_despesa_codigo %in% c('01', '03') |
      (
        elemento_despesa_codigo %in% c('05', '08', '09', '17', '91', '92', '94') &
        str_detect(natureza_despesa_detalhada_nome, 'APOSENT|INAT|REFORMA|PEN|LEI 7\\\\.963/1989')
      )
    )
    "
  )
)
```

```{r}
#| eval: !expr executar_relatorio("RGF_A01")
#| code-fold: true
# ===============================================================================
# MUTATE RGF ANEXO 1 - CATEGORIZAÃ‡ÃƒO POR REGIÃƒO/PODER
# ===============================================================================

# Adicionar coluna de categorizaÃ§Ã£o baseada nos grupos personalizados
rgf_a01 <- rgf_a01 %>%
  mutate(
    categoria_pessoal = case_when(
      
      # DESPESAS RESSALVADAS (aplicar primeiro - mais especÃ­fico)
      natureza_despesa_detalhada_codigo %in% c(
        "31900503", "31900504", "31900505", "31900506", 
        "31900507", "31900508", "31900501", "31900502"
      ) ~ "ressalvadas",
      
      # PODER EXECUTIVO FEDERAL (aplicar filtros especÃ­ficos depois)
      unidade_orcamentaria_codigo == "73113" & 
      plano_orcamentario_codigo_po == "0004" &
      acao_governo_codigo %in% c("0179", "0181", "214H") ~ "AP",
      
      unidade_orcamentaria_codigo == "73113" & 
      plano_orcamentario_codigo_po == "0003" & 
      acao_governo_codigo %in% c("0179", "0181", "214H") ~ "RR",
      
      unidade_orcamentaria_codigo == "73901" ~ "DF",
      
      uo_poder == "0" &
      !uo_orgao_maximo_codigo %in% c("34000","59000") ~ "executivo",
        
      
      # PODER EXECUTIVO FEDERAL (restante - apÃ³s aplicar filtros especÃ­ficos)
      # Assumindo que existe campo de poder ou similar
      TRUE ~ "demais"
    )
  )

pessoal <- aplicar_criterios(rgf_a01 %>% filter(item_informacao_codigo == "25") , criterios_rgf_A01_pessoal_rgf,         group_vars = c("categoria_pessoal"))


pessoal_rp <- aplicar_criterios(rgf_a01 %>% filter(item_informacao_codigo == "27"  ) , criterios_rgf_A01_pessoal_rgf,         group_vars = c("categoria_pessoal"))

categorias <- c("AP", "DF", "RR", "executivo")

categorias_rp <- c( "DF",  "executivo")
```

```{r}
#| eval: !expr executar_relatorio("RGF_A01")
#| code-fold: true




gerar_tabela_pessoal <- function(
  data_pessoal, 
  data_pessoal_rp, 
  categoria_filtro, 
  formato_numero = TRUE
) {
  
  # --------------------------------------------------------------------------
  # PREPARAR DADOS DE PESSOAL (item 25)
  # --------------------------------------------------------------------------
  pessoal_prep <- data_pessoal %>% 
    filter(categoria_pessoal == categoria_filtro) %>% 
    mutate(
    mes_ano = toupper(format(data_lancamento, "%b/%y")),
      tipo = "pessoal"
    )
  
  # --------------------------------------------------------------------------
  # PREPARAR DADOS DE RP (item 27) - se existirem
  # --------------------------------------------------------------------------
  rp_prep <- data_pessoal_rp %>% 
    filter(categoria_pessoal == categoria_filtro)
  
  if (nrow(rp_prep) > 0) {
    rp_prep <- rp_prep %>%
      mutate(
        mes_ano = "RPNP",
        tipo = "rp"
      )
  }
  
  # --------------------------------------------------------------------------
  # RBIND: COMBINAR PESSOAL + RP
  # --------------------------------------------------------------------------
  dados_combinados <- bind_rows(pessoal_prep, rp_prep)
  
  # --------------------------------------------------------------------------
  # CRIAR TABELA PIVOTADA
  # --------------------------------------------------------------------------
  # Ordenar meses
  dados_combinados <- dados_combinados %>%
    arrange(data_lancamento) %>%
    mutate(mes_ano = factor(mes_ano, levels = unique(mes_ano)))
  
  tabela <- dados_combinados %>% 
    group_by(mes_ano, categoria) %>% 
    summarise(valor = sum(valor / 1000), .groups = "drop") %>% 
    pivot_wider(names_from = mes_ano, values_from = valor, values_fill = 0)
  
  # --------------------------------------------------------------------------
  # ADICIONAR COLUNA DE TOTAL DOS 12 MESES (excluindo RPNP)
  # --------------------------------------------------------------------------
  # Identificar colunas de meses (todas exceto categoria e RPNP)
  colunas_meses <- setdiff(names(tabela), c("categoria", "RPNP"))
  
  # Calcular total dos Ãºltimos 12 meses
  tabela <- tabela %>%
    mutate(
      `TOTAL (ÃšLTIMOS 12 MESES)` = rowSums(select(., all_of(colunas_meses)), na.rm = TRUE)
    )
  
  # Reordenar colunas: categoria, meses, total, RPNP (se existir)
  if ("RPNP" %in% names(tabela)) {
    tabela <- tabela %>%
      select(categoria, all_of(colunas_meses), `TOTAL (ÃšLTIMOS 12 MESES)`, RPNP)
  } else {
    tabela <- tabela %>%
      select(categoria, all_of(colunas_meses), `TOTAL (ÃšLTIMOS 12 MESES)`)
  }
  
  # --------------------------------------------------------------------------
  # CRIAR DATATABLE (sem linha de totais)
  # --------------------------------------------------------------------------
  dt <- datatable(
    tabela,
    caption = paste("Categoria:", categoria_filtro),
    rownames = FALSE,
    options = list(
      pageLength = -1,
      scrollX = TRUE,
      dom = 'ft'
    )
  )
  
  if (formato_numero) {
    colunas_numericas <- which(sapply(tabela, is.numeric))
    
    dt <- dt %>% 
      formatRound(
        columns = colunas_numericas, 
        digits = 0, 
        mark = ".",
        dec.mark = ","
      )
  }
  
  return(dt)
}


```

```{r}
#| eval: !expr executar_relatorio("RGF_A01")
#| code-fold: true
#| column: screen

gerar_tabela_pessoal(pessoal, pessoal_rp, "executivo")

```

```{r}
#| eval: !expr executar_relatorio("RGF_A01")
#| code-fold: true
#| column: screen

gerar_tabela_pessoal(pessoal, pessoal_rp, "AP")
```

```{r}
#| eval: !expr executar_relatorio("RGF_A01")
#| code-fold: true
#| column: screen

gerar_tabela_pessoal(pessoal, pessoal_rp, "RR")

```

```{r}
#| eval: !expr executar_relatorio("RGF_A01")
#| code-fold: true
#| column: screen

gerar_tabela_pessoal(pessoal, pessoal_rp, "DF")
```

```{r}
#| eval: !expr executar_relatorio("RGF_A01")
rgf_a01 %>%
            filter(
              grupo_despesa_codigo_grupo == '1' &
                !elemento_despesa_codigo %in% c('01', '03', '34') &
                !(elemento_despesa_codigo %in% c('13', '07') &
                    natureza_despesa_detalhada_codigo %in% c('31909213', '31909207')) &
                !(str_detect(natureza_despesa_detalhada_codigo, '0599') &
                    natureza_despesa_detalhada_codigo %in% c('31909205', '31919205')) &
                !str_detect(natureza_despesa_detalhada_nome, 'APOSENT|INAT|REFORMA|PEN|LEI 7.963/1989') & !elemento_despesa_codigo %in% c('05', '08', '09', '17', '31', '32') &
                !(str_detect(natureza_despesa_detalhada_codigo, '0505') | str_detect(natureza_despesa_detalhada_codigo, '0506') | str_detect(natureza_despesa_detalhada_codigo, '0507') | str_detect(natureza_despesa_detalhada_codigo, '0508'))) %>% group_by( categoria_pessoal) %>% summarise(movim_liquido_r_item_informacao = sum(movim_liquido_r_item_informacao))
```

DESCOBERTA IMPORTANTE: O cÃ³digo de classificaÃ§Ã£o de falsos positivos estava ERRADO! As PENSÃ•ES verdadeiras (R\$ 56,46B) foram classificadas como falso positivo porque o padrÃ£o \\bPENS nÃ£o estÃ¡ capturando corretamente. SituaÃ§Ã£o real:

PEN captura 56 naturezas totalizando R\$ 194,21B Dessas, \~R\$ 137,75B sÃ£o PENSÃ•ES VERDADEIRAS E \~R\$ 56,46B sÃ£o compensaÃ§Ãµes/dependÃªncias/penosas (falsos positivos)

Principais problemas identificados:

REFORMA - R\$ 1,19M em "REFORMA AGRÃRIA" (falso positivo confirmado) PEN - R\$ 3,84B em "COMPENSAÃ‡Ã•ES" (falso positivo confirmado) PEN - R\$ 137,75B em PENSÃ•ES (sÃ£o VERDADEIROS, nÃ£o falsos!)

AnÃ¡lise do print do TG: O Tesouro Gerencial usa o operador "ContÃ©m" que Ã© equivalente ao nosso padrÃ£o sem word boundaries, confirmando que eles tÃªm o mesmo

# ğŸ“‹ RGF Anexo 02 (DÃ­vida Consolidada LÃ­quida)

```{r}
#| eval: !expr executar_relatorio("RGF_A02")
#| code-fold: true
# ===============================================================================
# CRITÃ‰RIOS RGF ANEXO 02 - DCL (VERSÃƒO FINAL CORRIGIDA)
# LISTAS ORGANIZADAS POR BASE DE DADOS
# ===============================================================================

# ===============================================================================
# BASE: rgf_a02precatorios
# Filtros TG: OrÃ§amento Fiscal,  Contas especÃ­ficas
# CORREÃ‡ÃƒO: AÃ§Ã£o 0Z01 APENAS se UO = 71103
# ===============================================================================
criterios_rgf_A02_dcl_precatorios <- list(
  
  `08 PrecatÃ³rios posteriores a 05/05/2000` = list(
    criterio = "
    acao_governo_codigo %in% c('0005', '00U9', '00UP', '0EC8', '0EC7', '00WU') |
    (unidade_orcamentaria_codigo == '71103' & acao_governo_codigo == '0Z01')
    "
  ),
  
    `08a PrecatÃ³rios posteriores a 05/05/2000` = list(
    criterio = "
    acao_governo_codigo %in% c( '00U9', '00UP', '0EC8',  '00WU') |
    (unidade_orcamentaria_codigo == '71103' & acao_governo_codigo == '0Z01')
    "
  )
)

# ===============================================================================
# BASE: rgf_a02_rp_exceto_170600
# Filtros TG: Contas especÃ­ficas,  UG != 170600, AÃ§Ã£o != 0005
# ===============================================================================
criterios_rgf_A02_dcl_rp_exceto_170600 <- list(
  
  `25 Restos a pagar processados parte 1` = list(
    criterio = "
    TRUE
    "
  )
)

# ===============================================================================
# BASE: rgf_a02_rp_todas_ugs
# Filtros TG: Contas especÃ­ficas,  AÃ§Ã£o != 0005
# ===============================================================================
criterios_rgf_A02_dcl_rp_todas_ugs <- list(
  
  `25 Restos a pagar processados parte 2` = list(
    criterio = "
    TRUE
    "
  )
)

# ===============================================================================
# BASE: rgf_a02_ug_170512
# Filtros TG: OrÃ§amento Fiscal,  UG = 170512
# ===============================================================================
criterios_rgf_A02_dcl_ug_170512 <- list(
  
  `09 DÃ­vida assumida pela UniÃ£o` = list(
    criterio = "
    conta_contabil_numero %in% c('218912600', '228911600', '227310401') &
    isf_lancamento == 'P' &
    conta_corrente != 'PF1705118'
    "
  ),
  
  `17 DÃ­vidas renegociadas deduÃ§Ã£o` = list(
    criterio = "
    conta_contabil_numero %in% c('121110301', '112410100', '121110318', '112410600', 
                                '121140301', '121150301', '112440100', '112450100', 
                                '121140318', '121150318', '112440600', '112450600', 
                                '112410401', '112450401', '112440401', '121249818', 
                                '113814200', '113844200', '113854200') &
    (entidade_c_cor_numero %in% c('PF1705320', 'PF1705524', 'PF1705528', 'PF1705546', 
                                 'PF1705547', 'PF1705548', 'PF1705406', 'PF1705525', 
                                 'PF1705529', 'PF1705544', 'PF1705545') |
     grepl('9\\\\.496/97', entidade_c_cor_nome) |
     grepl('2\\\\.185/2001', entidade_c_cor_nome))
    "
  ),
  
  `18 CrÃ©ditos Lei 8.727/93 deduÃ§Ã£o` = list(
    criterio = "
    conta_contabil_numero %in% c('121110301', '112410100', '121110318', '112410600', 
                                '121140301', '121150301', '112440100', '112450100', 
                                '121140318', '121150318', '112440600', '112450600', 
                                '112410401', '121219818', '112450401', '112440401', 
                                '121249818', '113814200', '113844200', '113854200') &
    (entidade_c_cor_numero %in% c('PF1705109', 'PF1705536', 'TN0000016', 'TN0000017') |
     grepl('8\\\\.727/93', entidade_c_cor_nome))
    "
  ),
  
  `19 DÃ­vida externa renegociada deduÃ§Ã£o` = list(
    criterio = "
    conta_contabil_numero %in% c('121110301', '112410100', '121110318', '112410600', 
                                '121140301', '121150301', '112440100', '112450100', 
                                '121140318', '121150318', '112440600', '112450600', 
                                '112410401', '121219818', '112450401', '112440401', 
                                '121249818', '113844200', '113814200', '113854200', 
                                '121259818') &
    (entidade_c_cor_numero %in% c('PF1705104', 'PF1705114', 'PF1705117', 'PF1705521', 
                                 'PF1705534', 'PF1705116', 'PF1705531', 'PF1705532', 
                                 'PF1705113', 'PF1701536', 'PF1705520', 'PF1705533', 
                                 'PF1705464', 'PF1705534', 'PF1705119', 'PF1705384') |
     grepl('DMLP', entidade_c_cor_nome) |
     grepl('FRANCA|FRANÃ‡A', entidade_c_cor_nome) |
     grepl('EXTER', entidade_c_cor_nome) |
     grepl('MF 030', entidade_c_cor_nome) |
     grepl('BIB', entidade_c_cor_nome))
    "
  ),
  
  `20 Demais dÃ­vidas renegociadas deduÃ§Ã£o` = list(
    criterio = "
    conta_contabil_numero %in% c('121110301', '112410100', '121110318', '112410600', 
                                '121140301', '121150301', '112440100', '112450100', 
                                '121140318', '121150318', '112440600', '112450600', 
                                '112410401', '112450401', '112440401', '121249818', 
                                '113844200', '113814200', '113854200', '121259818')
    "
  ),
  
  `21 Ajustes para perdas (positivo)` = list(
    criterio = "
    conta_contabil_numero %in% c('112940401', '112950401', '113940101', '112910401', 
                                '113950101', '121119902', '121149904', '121159904', 
                                '121119904', '121249903', '121259903')
    "
  )
)

# ===============================================================================
# BASE: rgf_a02_creditos_bancarios
# Filtros TG: OrÃ§amento Fiscal,  UG IN (170705, 170526, 170700)
# ===============================================================================
criterios_rgf_A02_dcl_creditos_bancarios <- list(
  
  `22 Outros crÃ©ditos bancÃ¡rios deduÃ§Ã£o` = list(
    criterio = "
    conta_contabil_numero %in% c('112410301', '112410303', '112440301', '112450301', 
                                '112440303', '112450303', '112410100', '121110301', 
                                '121110314', '121110308', '121140301', '121150301', 
                                '121140308', '121150308', '112411300', '121110316', 
                                '121110320', '112410302', '112410304', '112410201', 
                                '112410203', '112410403', '121110312')
    "
  ),
  
  `23 Outros crÃ©ditos bancÃ¡rios ajustes (positivo)` = list(
    criterio = "
    conta_contabil_numero %in% c('112910401', '121119904', '121119907', '112910403')
    "
  )
)

# ===============================================================================
# BASE: rgf_a02_entidade
# Filtros TG: OrÃ§amento Fiscal,  Contas especÃ­ficas
# ===============================================================================
criterios_rgf_A02_dcl_entidade <- list(
  
  `01 DÃ­vida mobiliÃ¡ria TN interna` = list(
    criterio = "
    conta_contabil_numero %in% c('899913900', '899913901', '899913902', '899913903', 
                                '899913904', '899913905', '899913906') &
    entidade_c_cor_numero %in% c('DP1000001', 'DP1400001', 'DP1500001', 'DP1700001', 
                                'DP1800001', 'DP2000001', 'DP2300007', 'DP2400001', 
                                'DP2600001', 'DP2800001', 'DP3000001', 'DP3400001', 
                                'DP5000001', 'DP5500001', 'DP5800001', 'DP6100001', 
                                'DP6200001', 'DP6300001', 'DP6600001', 'DP7000001', 
                                'DP8000001', 'DP9000001', 'DP9102001', 'DP1200001')
    "
  ),
  
  `03 DÃ­vida mobiliÃ¡ria do TN (em BCB)` = list(
    criterio = "
    conta_contabil_numero %in% c('899913901', '899913902', '899913907', '899913908') &
    entidade_c_cor_numero %in% c('DP1500010', 'DP1700010', 'DP1800010', 'DP2300010', 
                                'DP5500010', 'DP7000010', 'DP9000010', 'DP3201450')
    "
  ),
  
  `04 DÃ­vida securitizada` = list(
    criterio = "
    (conta_contabil_numero %in% c('899913900', '899913901', '899913902', '899913903', 
                                 '899913904', '899913905', '899913906') &
     entidade_c_cor_numero %in% c('DP3100001', 'DP3200001', 'DP3200002', 'DP3201031', 
                                 'DP3201032', 'DP3201059', 'DP3201077', 'DP3201078', 
                                 'DP3201080', 'DP3201081', 'DP3201145', 'DP3201202', 
                                 'DP3201222', 'DP3201228', 'DP3201233', 'DP3201250', 
                                 'DP3201256', 'DP3201257', 'DP3201258', 'DP3201259', 
                                 'DP3201260', 'DP3201262', 'DP3201271', 'DP3201272', 
                                 'DP3201275', 'DP3201276', 'DP3201277', 'DP3201280', 
                                 'DP3201281', 'DP3201296', 'DP3201299', 'DP3201362', 
                                 'DP3201368', 'DP3201378', 'DP3201390')) |
    conta_contabil_numero %in% c('212110202', '222110102')
    "
  )
)

# ===============================================================================
# BASE: rgf_a02_aplicacao_titulos_publicos
# Filtros TG: OrÃ§amento Fiscal,  Ã“rgÃ£o UGE != 25901,
#             Tipo Admin IN (3,4,5,6,8), Conta comeÃ§a com 1111150
# ===============================================================================
criterios_rgf_A02_dcl_aplicacao_titulos_publicos <- list(
  
  `02 AplicaÃ§Ã£o em tÃ­tulos pÃºblicos` = list(
    criterio = "
    !conta_contabil_numero %in% c('111115005', '111115011', '111115012')
    "
  )
)

# ===============================================================================
# BASE: rgf_a02_balancete
# Filtros TG: OrÃ§amento Fiscal, MÃªs AGO/2025
# ===============================================================================
criterios_rgf_A02_dcl_balancete <- list(
  
  `05 DÃ­vida mobiliÃ¡ria externa` = list(
    criterio = "
    conta_contabil_numero %in% c('899913903', '899913904')
    "
  ),
  
  `06 OperaÃ§Ãµes de equalizaÃ§Ã£o cambial` = list(
    criterio = "
    conta_contabil_numero %in% c('218912902', '218942902', '218952902', '218912901')
    "
  ),
  
  `07 Demais dÃ­vidas contratuais` = list(
    criterio = "
    isf_lancamento == 'P' &
    conta_contabil_numero %in% c(
      '222210200', '212210300', '222110200', '212110301', '212110303', '212510103',
      '212140303', '212150303', '212540103', '212550103', '212140301', '212150301',
      '217310301', '217310602', '217350402', '227310301', '212110700', '212210601',
      '212310201', '212310202', '212410201', '222310101', '222310102', '222410101',
      '217710101', '227710101', '227310401'
    )
    "
  ),
  
  `10 Passivos por insuficiÃªncia de recursos` = list(
    criterio = "
    conta_contabil_numero %in% c('213110400', '211110101', '214419800', '223110100', 
                                 '211210100', '213140400', '213150400', 
                                 '214119900', '211459800', '211419800') &
    isf_lancamento == 'P'
    "
  ),
  
  `11 DepÃ³sitos do TN (em BCB) deduÃ§Ã£o` = list(
    criterio = "
    startsWith(conta_contabil_numero, '1111102') |
    startsWith(conta_contabil_numero, '1111103') |
    startsWith(conta_contabil_numero, '1111104')
    "
  ),
  
  `12 DepÃ³sitos Ã  vista deduÃ§Ã£o` = list(
    criterio = "
    startsWith(conta_contabil_numero, '1112102') |
    startsWith(conta_contabil_numero, '1112103') |
    startsWith(conta_contabil_numero, '1112150') |
    startsWith(conta_contabil_numero, '1112152')
    "
  ),
  
  `24 Resultado positivo TN/BCB deduÃ§Ã£o` = list(
    criterio = "
    conta_contabil_numero %in% c('113813001', '113813002')
    "
  ),
  
  `26 DÃ­vida mobiliÃ¡ria TN interna (intra) deduÃ§Ã£o` = list(
    criterio = "
    conta_contabil_numero == '222120101'
    "
  )
)

# ===============================================================================
# BASE: rgf_a02_balancete_fat
# Filtros TG: OrÃ§amento Fiscal,  UG = 380916
# ===============================================================================
criterios_rgf_A02_dcl_balancete_fat <- list(
  
  `13 Disponibilidade FAT deduÃ§Ã£o` = list(
    criterio = "
    startsWith(conta_contabil_numero, '1111119') |
    startsWith(conta_contabil_numero, '1124103') |
    startsWith(conta_contabil_numero, '1135407') |
    startsWith(conta_contabil_numero, '1135113') |
    startsWith(conta_contabil_numero, '1135115') |
    startsWith(conta_contabil_numero, '1124101') |
    startsWith(conta_contabil_numero, '1135111') |
    startsWith(conta_contabil_numero, '1135107') |
    startsWith(conta_contabil_numero, '11121') |
    startsWith(conta_contabil_numero, '1135114') |
    startsWith(conta_contabil_numero, '1135112') |
    startsWith(conta_contabil_numero, '1135116') |
    startsWith(conta_contabil_numero, '1211503') |
    startsWith(conta_contabil_numero, '1211403') |
    startsWith(conta_contabil_numero, '1211103') |
    startsWith(conta_contabil_numero, '1135507') |
    startsWith(conta_contabil_numero, '1212105') |
    conta_contabil_numero %in% c('111115009', '111115011', '111115014', 
                                 '111115015', '111115016', '111115006')
    "
  )
)

# ===============================================================================
# BASE: rgf_a02_balancete_deducoes_depositos_a_vista
# Filtros TG: OrÃ§amento Fiscal,  Ã“rgÃ£o != 25901, UG != 380916
# Contas: 1111119* (demais contas bancÃ¡rias)
# ===============================================================================
criterios_rgf_A02_dcl_balancete_deducoes_depositos_a_vista <- list(
  
  `12 DepÃ³sitos Ã  vista deduÃ§Ã£o` = list(
    criterio = "
    startsWith(conta_contabil_numero, '1111119')
    "
  )
)

# ===============================================================================
# BASE: rgf_a02_balancete_fundos_111215100
# Filtros TG: OrÃ§amento Fiscal,  Ã“rgÃ£o != 25915,37904, Conta = 111215100
# ===============================================================================
criterios_rgf_A02_dcl_balancete_fundos_111215100 <- list(
  
  `14 AplicaÃ§Ãµes em fundos diversos 1 deduÃ§Ã£o` = list(
    criterio = "
    TRUE
    "
  )
)

# ===============================================================================
# BASE: rgf_a02_balancete_fundos
# Filtros TG: OrÃ§amento Fiscal,  Ã“rgÃ£o != 25915,37904, Tipo Admin = 7
# ===============================================================================
criterios_rgf_A02_dcl_balancete_fundos <- list(
  
  `15 AplicaÃ§Ãµes em fundos diversos 2 deduÃ§Ã£o` = list(
    criterio = "
    startsWith(conta_contabil_numero, '23')
    "
  ),
  
  `16 AplicaÃ§Ãµes em fundos diversos 3 deduÃ§Ã£o` = list(
    criterio = "
    startsWith(conta_contabil_numero, '1111102') |
    startsWith(conta_contabil_numero, '1111103') |
    startsWith(conta_contabil_numero, '1111104') |
    startsWith(conta_contabil_numero, '1111119') |
    conta_contabil_numero %in% c('111210200', '111210300', '111215000', '111215200') |
    c_con_subgrupo_3_nome %in% c('INVESTIMENTOS', 'IMOBILIZADO', '

INTANGIVEL', 'DIFERIDO')
    "
  )
)

# ===============================================================================
# BASE: rgf_a02_passivo_atuarial
# Filtros TG: OrÃ§amento Fiscal
# ===============================================================================
criterios_rgf_A02_passivo_atuarial <- list(
  
  `40 RPPS civil` = list(
    criterio = "
    ug_executora_codigo == '400043' &
    conta_contabil_numero %in% c('217919900', '227210301', '227210303', '227210304', 
                                  '227210401', '227210402', '227210403', '227210404')
    "
  ),
  
  `41 Despesas previdenciÃ¡rias do FCDF` = list(
    criterio = "
    ug_executora_codigo == '170392' &
    conta_contabil_numero %in% c('217919900', '227210301', '227210303', '227210304', 
                                  '227210401', '227210402', '227210403', '227210404')
    "
  ),
  
  `42 Militares inativos` = list(
    criterio = "
    ug_executora_codigo %in% c('120052', '160063', '773200') &
    conta_contabil_numero %in% c('217910700', '227910700')
    "
  ),
  
  `43 PensÃµes militares` = list(
    criterio = "
    ug_executora_codigo %in% c('120052', '160063', '773200') &
    conta_contabil_numero %in% c('217910600', '227910600')
    "
  )
)
```

df_criterios_rgf_A02_passivo_atuarial \<- aplicar_criterios(

df = rgf_a02_passivo_atuarial,

criterios = criterios_rgf_A02_passivo_atuarial

)

```{r}
#| eval: !expr executar_relatorio("RGF_A02")
#| code-fold: true
#| column: page
# ===============================================================================
# PROCESSAMENTO DOS CRITÃ‰RIOS DCL
# ===============================================================================

# ===============================================================================
# 1. rgf_a02_precatorios
# ===============================================================================
df_criterios_rgf_A02_dcl_precatorios <- aplicar_criterios(
  df = rgf_a02_precatorios,
  criterios = criterios_rgf_A02_dcl_precatorios
)

# ===============================================================================
# 2. rgf_a02_rp_exceto_170600
# ===============================================================================
df_criterios_rgf_A02_dcl_rp_exceto_170600 <- aplicar_criterios(
  df = rgf_a02_rp_exceto_170600,
  criterios = criterios_rgf_A02_dcl_rp_exceto_170600
)

# ===============================================================================
# 3. rgf_a02_rp_todas_ugs
# ===============================================================================
df_criterios_rgf_A02_dcl_rp_todas_ugs <- aplicar_criterios(
  df = rgf_a02_rp_todas_ugs,
  criterios = criterios_rgf_A02_dcl_rp_todas_ugs
)

# ===============================================================================
# 4. rgf_a02_ug_170512
# ===============================================================================
df_criterios_rgf_A02_dcl_ug_170512 <- aplicar_criterios(
  df = rgf_a02_ug_170512,
  criterios = criterios_rgf_A02_dcl_ug_170512
)

# ===============================================================================
# 5. rgf_a02_creditos_bancarios
# ===============================================================================
df_criterios_rgf_A02_dcl_creditos_bancarios <- aplicar_criterios(
  df = rgf_a02_creditos_bancarios,
  criterios = criterios_rgf_A02_dcl_creditos_bancarios
)

# ===============================================================================
# 6. rgf_a02_entidade
# ===============================================================================
df_criterios_rgf_A02_dcl_entidade <- aplicar_criterios(
  df = rgf_a02_entidade,
  criterios = criterios_rgf_A02_dcl_entidade
)

# ===============================================================================
# 7. rgf_a02_balancete
# ===============================================================================
df_criterios_rgf_A02_dcl_balancete <- aplicar_criterios(
  df = rgf_a02_balancete,
  criterios = criterios_rgf_A02_dcl_balancete
)

# ===============================================================================
# 8. rgf_a02_aplicacao_titulos_publicos
# ===============================================================================
df_criterios_rgf_A02_dcl_aplicacao_titulos_publicos <- aplicar_criterios(
  df = rgf_a02_aplicacao_titulos_publicos,
  criterios = criterios_rgf_A02_dcl_aplicacao_titulos_publicos
)

# ===============================================================================
# 9. rgf_a02_balancete_fat
# ===============================================================================
df_criterios_rgf_A02_dcl_balancete_fat <- aplicar_criterios(
  df = rgf_a02_balancete_fat,
  criterios = criterios_rgf_A02_dcl_balancete_fat
)

# ===============================================================================
# 10. rgf_a02_balancete_fundos_111215100
# ===============================================================================
df_criterios_rgf_A02_dcl_balancete_fundos_111215100 <- aplicar_criterios(
  df = rgf_a02_balancete_fundos_111215100,
  criterios = criterios_rgf_A02_dcl_balancete_fundos_111215100
)

# ===============================================================================
# 11. rgf_a02_balancete_fundos
# ===============================================================================
df_criterios_rgf_A02_dcl_balancete_fundos <- aplicar_criterios(
  df = rgf_a02_balancete_fundos,
  criterios = criterios_rgf_A02_dcl_balancete_fundos
)

# ===============================================================================
# 12. rgf_a02_balancete_deducoes_depositos_a_vista
# ===============================================================================
df_criterios_rgf_A02_dcl_balancete_deducoes_depositos_a_vista <- aplicar_criterios(
  df = rgf_a02_balancete_deducoes_depositos_a_vista,
  criterios = criterios_rgf_A02_dcl_balancete_deducoes_depositos_a_vista
)


# ===============================================================================
# PROCESSAR: rgf_a02_passivo_atuarial
# ===============================================================================
df_criterios_rgf_A02_passivo_atuarial <- aplicar_criterios(
  df = rgf_a02_passivo_atuarial,
  criterios = criterios_rgf_A02_passivo_atuarial
)

# ===============================================================================
# 13. CONSOLIDAR rgf_a02_rp (Linha 25 - partes 1 e 2)
# ===============================================================================
df_criterios_rgf_A02_dcl_rp <- bind_rows(
  df_criterios_rgf_A02_dcl_rp_exceto_170600,
  df_criterios_rgf_A02_dcl_rp_todas_ugs
) %>%
  mutate(
    nome = str_replace(nome, " parte [12]$", "")
  ) %>%
  group_by(mes_lancamento, dataframe_nome, dataframe_filtros, relatorio, 
           anexo_codigo, anexo_nome, detalhe, print, filtro, metrica, 
           ordem, nome) %>%
  summarise(valor = sum(valor, na.rm = TRUE), .groups = "drop")

# ===============================================================================
# 14. CONSOLIDAR Linha 12 - DepÃ³sitos Ã  Vista (partes 1 e 2)
# ===============================================================================
df_criterios_rgf_A02_dcl_depositos_vista <- bind_rows(
  df_criterios_rgf_A02_dcl_balancete_deducoes_depositos_a_vista,
  df_criterios_rgf_A02_dcl_balancete %>% 
    filter(str_detect(nome, "^12 "))
) %>%
  mutate(
    nome = str_replace(nome, " parte [12]$", "")
  ) %>%
  group_by(mes_lancamento, dataframe_nome, dataframe_filtros, relatorio, 
           anexo_codigo, anexo_nome, detalhe, print, filtro, metrica, 
           ordem, nome) %>%
  summarise(valor = sum(valor, na.rm = TRUE), .groups = "drop")

# ===============================================================================
# 15. CONSOLIDAR TODOS OS RESULTADOS
# ===============================================================================
df_rgf_A02_dcl_consolidado <- bind_rows(
  df_criterios_rgf_A02_dcl_precatorios,
  df_criterios_rgf_A02_dcl_rp,
  df_criterios_rgf_A02_dcl_ug_170512,
  df_criterios_rgf_A02_dcl_creditos_bancarios,
  df_criterios_rgf_A02_dcl_entidade,
  df_criterios_rgf_A02_dcl_balancete %>% 
    filter(!str_detect(nome, "^12 ")),  # Excluir linha 12 parte 2 do balancete
  df_criterios_rgf_A02_dcl_aplicacao_titulos_publicos,
  df_criterios_rgf_A02_dcl_balancete_fat,
  df_criterios_rgf_A02_dcl_balancete_fundos_111215100,
  df_criterios_rgf_A02_dcl_balancete_fundos,
  df_criterios_rgf_A02_dcl_depositos_vista,  # Usar consolidado da linha 12
  df_criterios_rgf_A02_passivo_atuarial
) %>%
  arrange(mes_lancamento, ordem)
# ===============================================================================
# 14. RESUMO POR BASE
# ===============================================================================
resumo <- df_rgf_A02_dcl_consolidado %>%
  group_by(dataframe_nome) %>%
  summarise(
    linhas = n_distinct(ordem),
    total_registros = n(),
    valor_total = sum(abs(valor), na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(dataframe_nome)

# ===============================================================================
# 15. LINHAS PROCESSADAS
# ===============================================================================
linhas_processadas <- df_rgf_A02_dcl_consolidado %>%
  distinct(ordem, nome) %>%
  arrange(ordem)

# ===============================================================================
# 16. VALORES POR LINHA
# ===============================================================================
valores_linhas <- df_rgf_A02_dcl_consolidado %>%
  group_by(ordem, nome) %>%
  summarise(
    valor_total = sum(valor, na.rm = TRUE),
    valor_absoluto = sum(abs(valor), na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(ordem)

# ===============================================================================
# 17. VERIFICAÃ‡ÃƒO DE QUALIDADE
# ===============================================================================
valores_check <- df_rgf_A02_dcl_consolidado %>%
  summarise(
    registros_total = n(),
    registros_com_valor_na = sum(is.na(valor)),
    registros_com_valor_zero = sum(valor == 0, na.rm = TRUE),
    registros_com_valor_positivo = sum(valor > 0, na.rm = TRUE),
    registros_com_valor_negativo = sum(valor < 0, na.rm = TRUE)
  )

linhas_sem_dados <- df_rgf_A02_dcl_consolidado %>%
  group_by(ordem, nome) %>%
  summarise(
    valor_total = sum(valor, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  filter(valor_total == 0 | is.na(valor_total)) %>%
  arrange(ordem)

# ===============================================================================
# 18. EXIBIR RESULTADOS
# ===============================================================================

datatable(
  valores_linhas,
  rownames = FALSE,
  options = list(
    pageLength = -1,
    scrollX = TRUE,
    lengthMenu = list(c(10, 25, 50, -1), c('10', '25', '50', 'Todas'))
  )
) %>% 
  formatRound(c("valor_total", "valor_absoluto"), 2, mark = ".", dec.mark = ",")
```

```{r}
#| include: false

# ============================================================================
# TABELA DE REFERÃŠNCIA DOS TÃTULOS PÃšBLICOS
# ============================================================================

titulos_publicos <- tribble(
  ~codigo_tg,           ~sigla,     ~nome_completo,                                    ~rentabilidade,                ~status,                                      ~observacoes,
  
  # === TÃTULOS ATIVOS ===
  "LTN",                "LTN",      "Letra do Tesouro Nacional",                       "Prefixada (taxa fixa)",       "Ativo (Tesouro Prefixado)",                 "Pagamento Ãºnico no vencimento",
  "LTN-DL 2376",        "LTN",      "Letra do Tesouro Nacional",                       "Prefixada (taxa fixa)",       "Ativo (Tesouro Prefixado)",                 "Pagamento Ãºnico no vencimento",
  "DP9000001",          "LTN",      "Letra do Tesouro Nacional",                       "Prefixada (taxa fixa)",       "Ativo (Tesouro Prefixado) - Mercado",       "Mercado - Curto Prazo",
  "DP9000010",          "LTN",      "Letra do Tesouro Nacional",                       "Prefixada (taxa fixa)",       "Ativo (Tesouro Prefixado) - BACEN",         "BACEN",
  
  "LFT",                "LFT",      "Letra Financeira do Tesouro",                     "PÃ³s-fixada (Selic)",          "Ativo (Tesouro Selic)",                      "Reserva de emergÃªncia",
  "DP7000001",          "LFT",      "Letra Financeira do Tesouro",                     "PÃ³s-fixada (Selic)",          "Ativo (Tesouro Selic) - Mercado",           "Mercado",
  "DP7000010",          "LFT",      "Letra Financeira do Tesouro",                     "PÃ³s-fixada (Selic)",          "Ativo (Tesouro Selic) - BACEN",             "BACEN",
  
  "NTN-F",              "NTN-F",    "Nota do Tesouro Nacional SÃ©rie F",                "Prefixada + cupons semestrais", "Ativo (Tesouro Prefixado c/ Juros)",      "Paga juros a cada 6 meses",
  "DP2300007",          "NTN-F",    "Nota do Tesouro Nacional SÃ©rie F",                "Prefixada + cupons semestrais", "Ativo (Tesouro Prefixado c/ Juros) - Mercado", "Mercado",
  "DP2300010",          "NTN-F",    "Nota do Tesouro Nacional SÃ©rie F",                "Prefixada + cupons semestrais", "Ativo (Tesouro Prefixado c/ Juros) - BACEN", "BACEN",
  
  "NTN-B",              "NTN-B",    "Nota do Tesouro Nacional SÃ©rie B",                "IPCA + taxa fixa",            "Ativo (Tesouro IPCA+ c/ Juros)",             "Protege da inflaÃ§Ã£o",
  "DP1700001",          "NTN-B",    "Nota do Tesouro Nacional SÃ©rie B",                "IPCA + taxa fixa",            "Ativo (Tesouro IPCA+ c/ Juros) - Mercado",  "Mercado",
  "DP1700010",          "NTN-B",    "Nota do Tesouro Nacional SÃ©rie B",                "IPCA + taxa fixa",            "Ativo (Tesouro IPCA+ c/ Juros) - BACEN",    "BACEN",
  
  "NTN-B1",             "NTN-B1",   "Nota do Tesouro Nacional SÃ©rie B1",               "IPCA + taxa fixa",            "Ativo (Tesouro Renda+ e Educa+)",           "Aposentadoria/educaÃ§Ã£o",
  "DP9102001",          "NTN-B1",   "Nota do Tesouro Nacional SÃ©rie B1",               "IPCA + taxa fixa",            "Ativo (Tesouro Renda+ e Educa+)",           "Focado em longo prazo",
  
  # === TÃTULOS EXTINTOS OU RAROS ===
  "NTN-C",              "NTN-C",    "Nota do Tesouro Nacional SÃ©rie C",                "IGP-M + taxa fixa",           "Extinto (ainda circula pouco)",              "Indexado ao IGP-M",
  "DP1400001",          "NTN-C",    "Nota do Tesouro Nacional SÃ©rie C",                "IGP-M + taxa fixa",           "Extinto (ainda circula pouco)",              "InflaÃ§Ã£o antiga",
  
  "NTN-I",              "NTN-I",    "Nota do Tesouro Nacional SÃ©rie I",                "Prefixada ou especÃ­fica",     "Raro/extinto",                               "Pouco usado hoje",
  "DP2600001",          "NTN-I",    "Nota do Tesouro Nacional SÃ©rie I",                "Prefixada ou especÃ­fica",     "Raro/extinto",                               "EmissÃµes antigas",
  
  "NTN-P",              "NTN-P",    "Nota do Tesouro Nacional SÃ©rie P",                "Prefixada ou hÃ­brida",        "Extinto ou raro",                            "SÃ©rie antiga",
  "DP1800001",          "NTN-P",    "Nota do Tesouro Nacional SÃ©rie P",                "Prefixada ou hÃ­brida",        "Extinto ou raro",                            "EmissÃµes antigas",
  "DP1800010",          "NTN-P",    "Nota do Tesouro Nacional SÃ©rie P",                "Prefixada ou hÃ­brida",        "Extinto ou raro - BACEN",                    "BACEN",
  
  # === CFT - CERTIFICADOS FINANCEIROS DO TESOURO ===
  "CFT-A",              "CFT-A",    "Certificado Financeiro do Tesouro SÃ©rie A",       "VariÃ¡vel (Selic ou TR)",      "EmissÃµes diretas",                           "Programas especÃ­ficos",
  "DP1000001",          "CFT-A",    "Certificado Financeiro do Tesouro SÃ©rie A",       "VariÃ¡vel (Selic ou TR)",      "EmissÃµes diretas",                           "NÃ£o leilÃ£o comum",
  
  "CFT-B",              "CFT-B",    "Certificado Financeiro do Tesouro SÃ©rie B",       "VariÃ¡vel (Selic ou TR)",      "EmissÃµes diretas",                           "FIES, Proies",
  "DP1200001",          "CFT-B",    "Certificado Financeiro do Tesouro SÃ©rie B",       "VariÃ¡vel (Selic ou TR)",      "EmissÃµes diretas",                           "Programas governamentais",
  
  "CFT-D",              "CFT-D",    "Certificado Financeiro do Tesouro SÃ©rie D",       "VariÃ¡vel (Selic ou TR)",      "EmissÃµes diretas",                           "Programas especÃ­ficos",
  "DP2000001",          "CFT-D",    "Certificado Financeiro do Tesouro SÃ©rie D",       "VariÃ¡vel (Selic ou TR)",      "EmissÃµes diretas",                           "NÃ£o leilÃ£o",
  
  "CFT-E",              "CFT-E",    "Certificado Financeiro do Tesouro SÃ©rie E",       "VariÃ¡vel (Selic ou TR)",      "EmissÃµes diretas",                           "Programas especÃ­ficos",
  "DP2800001",          "CFT-E",    "Certificado Financeiro do Tesouro SÃ©rie E",       "VariÃ¡vel (Selic ou TR)",      "EmissÃµes diretas",                           "FIES",
  
  # === CVS - CERTIFICADOS DE VALORIZAÃ‡ÃƒO DO SALÃRIO (ANOS 90) ===
  "CVSA970101",         "CVS-A",    "Certificado de ValorizaÃ§Ã£o do SalÃ¡rio SÃ©rie A",   "CorreÃ§Ã£o salarial (1997)",    "Extinto/prescrito",                          "DÃ­vidas salariais anos 90",
  "DP3201250",          "CVS-A",    "Certificado de ValorizaÃ§Ã£o do SalÃ¡rio SÃ©rie A",   "CorreÃ§Ã£o salarial (1997)",    "Extinto/prescrito",                          "SalÃ¡rios atrasados",
  
  "CVSB970101",         "CVS-B",    "Certificado de ValorizaÃ§Ã£o do SalÃ¡rio SÃ©rie B",   "CorreÃ§Ã£o salarial (1997)",    "Extinto/prescrito",                          "DÃ­vidas salariais anos 90",
  "DP3201275",          "CVS-B",    "Certificado de ValorizaÃ§Ã£o do SalÃ¡rio SÃ©rie B",   "CorreÃ§Ã£o salarial (1997)",    "Extinto/prescrito",                          "SalÃ¡rios atrasados",
  
  "CVSC970101",         "CVS-C",    "Certificado de ValorizaÃ§Ã£o do SalÃ¡rio SÃ©rie C",   "CorreÃ§Ã£o salarial (1997)",    "Extinto/prescrito",                          "DÃ­vidas salariais anos 90",
  "DP3201276",          "CVS-C",    "Certificado de ValorizaÃ§Ã£o do SalÃ¡rio SÃ©rie C",   "CorreÃ§Ã£o salarial (1997)",    "Extinto/prescrito",                          "SalÃ¡rios atrasados",
  
  "CVSD970101",         "CVS-D",    "Certificado de ValorizaÃ§Ã£o do SalÃ¡rio SÃ©rie D",   "CorreÃ§Ã£o salarial (1997)",    "Extinto/prescrito",                          "DÃ­vidas salariais anos 90",
  "DP3201277",          "CVS-D",    "Certificado de ValorizaÃ§Ã£o do SalÃ¡rio SÃ©rie D",   "CorreÃ§Ã£o salarial (1997)",    "Extinto/prescrito",                          "SalÃ¡rios atrasados",
  
  # === TÃTULOS DE SECURITIZAÃ‡ÃƒO (ANOS 90) ===
  "BNCC920116",         "BNCC",     "TÃ­tulo de SecuritizaÃ§Ã£o - BÃ´nus do CrÃ©dito",      "VariÃ¡vel",                    "Extinto",                                    "DÃ­vidas judiciais anos 90",
  "DP3201031",          "BNCC",     "TÃ­tulo de SecuritizaÃ§Ã£o - BÃ´nus do CrÃ©dito",      "VariÃ¡vel",                    "Extinto",                                    "PrecatÃ³rios",
  
  "JUST920116",         "JUST",     "TÃ­tulo de SecuritizaÃ§Ã£o - JustiÃ§a",               "VariÃ¡vel",                    "Extinto",                                    "DÃ­vidas judiciais anos 90",
  "DP3201032",          "JUST",     "TÃ­tulo de SecuritizaÃ§Ã£o - JustiÃ§a",               "VariÃ¡vel",                    "Extinto",                                    "PrecatÃ³rios",
  
  "SUMA920199",         "SUMA",     "TÃ­tulo Antigo de SecuritizaÃ§Ã£o",                  "VariÃ¡vel",                    "Extinto",                                    "Anos 90",
  "DP3201145",          "SUMA",     "TÃ­tulo Antigo de SecuritizaÃ§Ã£o",                  "VariÃ¡vel",                    "Extinto",                                    "EmissÃµes antigas",
  
  "CDP/INSS",           "CDP",      "Certificado da DÃ­vida PrevidenciÃ¡ria",            "VariÃ¡vel",                    "Extinto",                                    "Quitar dÃ­vidas com INSS",
  "DP3000001",          "CDP",      "Certificado da DÃ­vida PrevidenciÃ¡ria",            "VariÃ¡vel",                    "Extinto",                                    "DÃ­vida INSS",
  
  # === DÃVIDA EXTERNA ===
  "GLOBAL",             "GLOBAL",   "Global Bonds (dÃ­vida externa em USD)",            "Prefixada USD + cÃ¢mbio",      "Ativo - circulaÃ§Ã£o",                         "Emitidos no exterior (USD)",
  "DP1300003",          "GLOBAL",   "Global Bonds (dÃ­vida externa em USD)",            "Prefixada USD + cÃ¢mbio",      "Ativo - circulaÃ§Ã£o",                         "CorreÃ§Ã£o cambial",
  
  "GLOBAL BRL",         "GLOBAL-BRL", "BRL Bonds (dÃ­vida externa em R$)",              "Prefixada em real",           "Ativo - circulaÃ§Ã£o",                         "Emitidos fora em reais (2005+)",
  "DP1300004",          "GLOBAL-BRL", "BRL Bonds (dÃ­vida externa em R$)",              "Prefixada em real",           "Ativo - circulaÃ§Ã£o",                         "Mercado internacional",
  
  # === TÃTULOS DA DÃVIDA AGRÃRIA ===
  "TDA",                "TDA",      "TÃ­tulos da DÃ­vida AgrÃ¡ria",                       "VariÃ¡vel",                    "Ativo",                                      "Reforma agrÃ¡ria",
  "212110202",          "TDA",      "TÃ­tulos da DÃ­vida AgrÃ¡ria",                       "VariÃ¡vel",                    "Ativo - Curto Prazo",                        "Passivo Circulante",
  "222110102",          "TDA",      "TÃ­tulos da DÃ­vida AgrÃ¡ria",                       "VariÃ¡vel",                    "Ativo - Longo Prazo",                        "Passivo NÃ£o-Circulante"
)

# ============================================================================
# CATEGORIAS DE TÃTULOS
# ============================================================================

categorias_titulos <- tribble(
  ~sigla,       ~categoria,                    ~subcategoria,
  "LTN",        "Prefixados",                  "Curto Prazo",
  "LFT",        "PÃ³s-fixados",                 "Selic",
  "NTN-F",      "Prefixados",                  "Com Cupons",
  "NTN-B",      "Indexados Ã  InflaÃ§Ã£o",        "IPCA",
  "NTN-B1",     "Indexados Ã  InflaÃ§Ã£o",        "IPCA - Longo Prazo",
  "NTN-C",      "Indexados Ã  InflaÃ§Ã£o",        "IGP-M (Extinto)",
  "NTN-I",      "Outros",                      "Extinto",
  "NTN-P",      "Outros",                      "Extinto",
  "CFT-A",      "Certificados Especiais",      "Programas Governamentais",
  "CFT-B",      "Certificados Especiais",      "FIES/Proies",
  "CFT-D",      "Certificados Especiais",      "Programas Especiais",
  "CFT-E",      "Certificados Especiais",      "FIES",
  "CVS-A",      "Extintos",                    "CorreÃ§Ã£o Salarial",
  "CVS-B",      "Extintos",                    "CorreÃ§Ã£o Salarial",
  "CVS-C",      "Extintos",                    "CorreÃ§Ã£o Salarial",
  "CVS-D",      "Extintos",                    "CorreÃ§Ã£o Salarial",
  "BNCC",       "Extintos",                    "SecuritizaÃ§Ã£o",
  "JUST",       "Extintos",                    "SecuritizaÃ§Ã£o",
  "SUMA",       "Extintos",                    "SecuritizaÃ§Ã£o",
  "CDP",        "Extintos",                    "DÃ­vida PrevidenciÃ¡ria",
  "GLOBAL",     "DÃ­vida Externa",              "USD",
  "GLOBAL-BRL", "DÃ­vida Externa",              "BRL",
  "TDA",        "DÃ­vida AgrÃ¡ria",              "Reforma AgrÃ¡ria"
)

# ============================================================================
# FUNÃ‡ÃƒO: ENRIQUECER DADOS DO TG COM INFORMAÃ‡Ã•ES DOS TÃTULOS
# ============================================================================

#' Enriquecer dados do Tesouro Gerencial com informaÃ§Ãµes dos tÃ­tulos
#' @param df Dataframe com dados do TG (deve ter coluna entidade_c_cor_numero ou similar)
#' @param coluna_codigo Nome da coluna com cÃ³digo do tÃ­tulo (padrÃ£o: "entidade_c_cor_numero")
#' @return Dataframe enriquecido com informaÃ§Ãµes dos tÃ­tulos
enriquecer_titulos <- function(df, coluna_codigo = "entidade_c_cor_numero") {
  
  # Verificar se coluna existe
  if (!coluna_codigo %in% names(df)) {
    stop(sprintf("Coluna '%s' nÃ£o encontrada no dataframe", coluna_codigo))
  }
  
  # Fazer join com tabela de tÃ­tulos
  df_enriquecido <- df %>%
    left_join(
      titulos_publicos,
      by = setNames("codigo_tg", coluna_codigo)
    ) %>%
    left_join(
      categorias_titulos,
      by = "sigla"
    )
  
  # Adicionar flag de tÃ­tulos nÃ£o mapeados
  df_enriquecido <- df_enriquecido %>%
    mutate(
      titulo_mapeado = !is.na(sigla),
      tipo_titulo = case_when(
        is.na(sigla) ~ "NÃ£o Mapeado",
        TRUE ~ as.character(sigla)
      )
    )
  
  return(df_enriquecido)
}

#' Buscar informaÃ§Ãµes de um tÃ­tulo especÃ­fico
#' @param codigo CÃ³digo do tÃ­tulo
#' @return Tibble com informaÃ§Ãµes do tÃ­tulo
buscar_titulo <- function(codigo) {
  titulos_publicos %>%
    filter(codigo_tg == codigo)
}

#' Listar todos os tÃ­tulos ativos
#' @return Tibble com tÃ­tulos ativos
listar_titulos_ativos <- function() {
  titulos_publicos %>%
    filter(grepl("Ativo", status)) %>%
    distinct(sigla, nome_completo, rentabilidade, status)
}

#' Listar tÃ­tulos por categoria
#' @param categoria Nome da categoria
#' @return Tibble com tÃ­tulos da categoria
listar_por_categoria <- function(categoria) {
  categorias_titulos %>%
    filter(categoria == {{categoria}}) %>%
    left_join(titulos_publicos %>% distinct(sigla, nome_completo, rentabilidade, status),
              by = "sigla")
}

# ============================================================================
# MENSAGEM
# ============================================================================

cat("\n")
cat("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")
cat("         ğŸ“Š MAPEAMENTO DE TÃTULOS PÃšBLICOS CARREGADO\n")
cat("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")
cat(sprintf("âœ… Total de tÃ­tulos mapeados: %d\n", nrow(titulos_publicos)))
cat(sprintf("âœ… Categorias: %d\n", nrow(categorias_titulos)))
cat("\nğŸ“ FunÃ§Ãµes disponÃ­veis:\n")
cat("   â€¢ enriquecer_titulos(df, coluna_codigo)\n")
cat("   â€¢ buscar_titulo(codigo)\n")
cat("   â€¢ listar_titulos_ativos()\n")
cat("   â€¢ listar_por_categoria(categoria)\n")
cat("\nğŸ’¡ Dataframes disponÃ­veis:\n")
cat("   â€¢ titulos_publicos\n")
cat("   â€¢ categorias_titulos\n")
cat("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n")


# ============================================================================
# EXEMPLO 1: Importar e Enriquecer Dados
# ============================================================================


# Enriquecer com informaÃ§Ãµes dos tÃ­tulos
dados_enriquecidos <- enriquecer_titulos(rgf_a02_entidade, coluna_codigo = "entidade_c_cor_numero")

# Ver resultado
dados_enriquecidos %>%
  select(entidade_c_cor_numero, entidade_c_cor_nome, 
         sigla, nome_completo, rentabilidade, status, 
         categoria, subcategoria, saldo_r_conta_contabil) %>%
  head(10)

# datatable(dados_enriquecidos)


# ============================================================================
# ADICIONAR DETENTOR E PRAZO AOS DADOS - VERSÃƒO DIRETA E SIMPLES
# ============================================================================
# CÃ³digo simplificado para equipe com pouco conhecimento de R
# Autor: AndrÃ©
# Data: 2024
# ============================================================================

library(tidyverse)

# ============================================================================
# MANIPULAÃ‡ÃƒO DIRETA: ADICIONAR COLUNAS DETENTOR E PRAZO
# ============================================================================

# Seus dados originais (exemplo: rgf_a02_entidade)
# Substitua pelo nome real da sua base de dados

dados_enriquecidos <- rgf_a02_entidade %>%
  mutate(
    
    # COLUNA 1: DETENTOR
    # Busca palavras-chave no nome da entidade
    detentor = case_when(
      str_detect(entidade_c_cor_nome, regex("BACEN", ignore_case = TRUE)) ~ "BACEN",
      str_detect(entidade_c_cor_nome, regex("Mercado", ignore_case = TRUE)) ~ "Mercado",
      TRUE ~ "Demais"
    ),
    
    # COLUNA 2: PRAZO
    # Busca palavras-chave no nome da conta contÃ¡bil
    prazo = case_when(
      str_detect(conta_contabil_nome, regex("Curto Prazo|Circulante", ignore_case = TRUE)) ~ "Curto Prazo",
      str_detect(conta_contabil_nome, regex("Longo Prazo|NÃ£o.?Circulante", ignore_case = TRUE)) ~ "Longo Prazo",
      TRUE ~ "NÃ£o Especificado"
    )
  )

# ============================================================================
# VER RESULTADO
# ============================================================================

# Visualizar primeiras linhas com as novas colunas
dados_enriquecidos %>%
  select(entidade_c_cor_numero, entidade_c_cor_nome, 
         detentor, prazo, saldo_r_conta_contabil) %>%
  head(20)

# ============================================================================
# RESUMOS SIMPLES
# ============================================================================

# Resumo por detentor
dados_enriquecidos %>%
  group_by(detentor) %>%
  summarise(
    total = sum(saldo_r_conta_contabil, na.rm = TRUE),
    quantidade = n()
  )

# Resumo por prazo
dados_enriquecidos %>%
  group_by(prazo) %>%
  summarise(
    total = sum(saldo_r_conta_contabil, na.rm = TRUE),
    quantidade = n()
  )



```

```{r}
# Resumo cruzado: detentor x prazo
datatable(dados_enriquecidos %>%
  group_by(detentor, prazo) %>%
  summarise(
    total = sum(saldo_r_conta_contabil, na.rm = TRUE),
    quantidade = n(),
    .groups = "drop"
  )) %>% 
  formatRound(c("total"), 2, mark = ".", dec.mark = ",")
```

# ğŸ“‹ RGF Anexo 03 (Garantias e Contragarantias)

```{r}
#| eval: !expr executar_relatorio("RGF_A03")
#| code-fold: true
criterios_rgf_A03_garantias <- list(
  
  # ===========================================================================
  # GARANTIAS CONCEDIDAS
  # ===========================================================================
  
  `01 Garantias aos estados total` = list(
    criterio = "
    conta_contabil_numero %in% c('812110104', '812110204', '899913301', '899913302') &
    conta_corrente %in% c('CG0000064', 'CG0000069')
    "
  ),
  
  `02 Garantias aos estados operaÃ§Ãµes externas` = list(
    criterio = "
    (conta_contabil_numero == '812110204' &
    conta_corrente == 'CG0000069') |
    (conta_contabil_numero == '899913302' &
    conta_corrente == 'CG0000069')
    "
  ),
  
  `03 Garantias aos estados operaÃ§Ãµes internas` = list(
    criterio = "
    (conta_contabil_numero == '812110104' &
    conta_corrente == 'CG0000064') |
    (conta_contabil_numero == '899913301' &
    conta_corrente == 'CG0000064')
    "
  ),
  
  `04 Garantias aos municÃ­pios total` = list(
    criterio = "
    conta_contabil_numero %in% c('812110104', '812110204') &
    conta_corrente %in% c('CG0000065', 'CG0000070')
    "
  ),
  
  `05 Garantias aos municÃ­pios operaÃ§Ãµes externas` = list(
    criterio = "
    conta_contabil_numero == '812110204' &
    conta_corrente == 'CG0000070'
    "
  ),
  
  `06 Garantias aos municÃ­pios operaÃ§Ãµes internas` = list(
    criterio = "
    conta_contabil_numero == '812110104' &
    conta_corrente == 'CG0000065'
    "
  ),
  
  `07 Garantias Ã s entidades controladas total` = list(
    criterio = "
    conta_contabil_numero %in% c('812110104', '812110204') &
    conta_corrente %in% c('CG0000067', 'CG0000071', 'CG0000072')
    "
  ),
  
  `08 Garantias Ã s entidades operaÃ§Ãµes externas` = list(
    criterio = "
    conta_contabil_numero == '812110204' &
    conta_corrente %in% c('CG0000071', 'CG0000072')
    "
  ),
  
  `09 Garantias Ã s entidades operaÃ§Ãµes internas` = list(
    criterio = "
    conta_contabil_numero == '812110104' &
    conta_corrente == 'CG0000067'
    "
  ),
  
  `10 Garantias por fundos e programas total` = list(
    criterio = "
    (conta_contabil_numero == '812110104' & 
     (conta_corrente %in% c('CGASCA001', 'CGLEI8036') | 
      startsWith(conta_corrente, 'CGFSCEIRB') |
      startsWith(conta_corrente, 'CGPPRONAF') |
      startsWith(conta_corrente, 'CGPRCACAU') |
      startsWith(conta_corrente, 'CGASCAD'))) |
    conta_contabil_numero == '812110110'
    "
  ),
  
  `11 Garantias fundos seguros-garantia` = list(
    criterio = "
    conta_contabil_numero == '812110110' &
    (conta_corrente == '999' | is.na(conta_corrente))
    "
  ),
  
  `12 Garantias fundos ASCA` = list(
    criterio = "
    conta_contabil_numero == '812110104' &
    conta_corrente == 'CGASCA001'
    "
  ),
  
  `13 Garantias fundos Lei 8036 (FGTS)` = list(
    criterio = "
    conta_contabil_numero == '812110104' &
    conta_corrente == 'CGLEI8036'
    "
  ),
  
  `14 Garantias total geral` = list(
    criterio = "
    conta_contabil_numero %in% c('812110104', '812110110', '812110204', '899913301', '899913302')
    "
  ),
  
  # ===========================================================================
  # CONTRAGARANTIAS RECEBIDAS
  # ===========================================================================
  
  `15 Contragarantias dos estados total` = list(
    criterio = "
    conta_contabil_numero %in% c('811110304', '811110404') &
    conta_corrente %in% c('CG0000064', 'CG0000069')
    "
  ),
  
  `16 Contragarantias dos estados operaÃ§Ãµes externas` = list(
    criterio = "
    conta_contabil_numero == '811110404' &
    conta_corrente == 'CG0000069'
    "
  ),  
  
  `17 Contragarantias dos estados operaÃ§Ãµes internas` = list(
    criterio = "
    conta_contabil_numero == '811110304' &
    conta_corrente == 'CG0000064'
    "
  ),
  
  `18 Contragarantias dos municÃ­pios total` = list(
    criterio = "
    conta_contabil_numero %in% c('811110304', '811110404') &
    conta_corrente %in% c('CG0000065', 'CG0000070')
    "
  ),
  
  `19 Contragarantias dos municÃ­pios operaÃ§Ãµes externas` = list(
    criterio = "
    conta_contabil_numero == '811110404' &
    conta_corrente == 'CG0000070'
    "
  ),
  
  `20 Contragarantias dos municÃ­pios operaÃ§Ãµes internas` = list(
    criterio = "
    conta_contabil_numero == '811110304' &
    conta_corrente == 'CG0000065'
    "
  ),
  
  `21 Contragarantias das entidades controladas total` = list(
    criterio = "
    conta_contabil_numero %in% c('811110304', '811110404') &
    conta_corrente %in% c('CG0000067', 'CG0000071', 'CG0000072')
    "
  ),
  
  `22 Contragarantias das entidades operaÃ§Ãµes externas` = list(
    criterio = "
    conta_contabil_numero == '811110404' &
    conta_corrente %in% c('CG0000071', 'CG0000072')
    "
  ),
  
  `23 Contragarantias das entidades operaÃ§Ãµes internas` = list(
    criterio = "
    conta_contabil_numero == '811110304' &
    conta_corrente == 'CG0000067'
    "
  ),
  
  `24 Contragarantias total geral` = list(
    criterio = "
    conta_contabil_numero %in% c('811110304', '811110404')
    "
  )
)


datatable(
  aplicar_criterios(rgf_a03, criterios_rgf_A03_garantias) %>% 
    group_by(ordem, nome) %>% 
    summarise(valor = sum(valor), .groups = "drop"),
  rownames = FALSE,
  options = list(
    pageLength = -1,
    scrollX = TRUE,
    lengthMenu = list(c(10, 25, 50, -1), c('10', '25', '50', 'Todas'))
   
  )
) %>% 
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")
```

# ğŸ“‹ RGF Anexo 04 (OperaÃ§Ãµes de CrÃ©dito)

```{r}
#| eval: !expr executar_relatorio("RGF_A04")
#| code-fold: true
#| column: page

# ===============================================================================
# CRITÃ‰RIOS RGF ANEXO 04 - OPERAÃ‡Ã•ES DE CRÃ‰DITO
# ===============================================================================

# ===============================================================================
# PARTE 1: RECEITAS ORÃ‡AMENTÃRIAS
# Base: rgf_a04_receitas
# ===============================================================================
criterios_rgf_A04_receitas <- list(
  
  `01 MobiliÃ¡ria interna refinanciamento` = list(
    criterio = "
    conta_contabil_numero %in% c('621200000', '621310000', '621320000', 
                                  '621330000', '621340000', '621390000') &
    (startsWith(natureza_receita_codigo_completo, '2111002') |
     startsWith(natureza_receita_codigo_completo, '8111002') |
     natureza_receita_codigo_completo %in% c('21110200', '21110201', 
                                             '81110200', '81110201'))
    "
  ),
  
  `02 MobiliÃ¡ria interna outras orÃ§amentÃ¡rias` = list(
    criterio = "
    conta_contabil_numero %in% c('621200000', '621310000', '621320000', 
                                  '621330000', '621340000', '621390000') &
    (startsWith(natureza_receita_codigo_completo, '2111003') |
     startsWith(natureza_receita_codigo_completo, '8111001') |
     natureza_receita_codigo_completo %in% c('21110300', '21110301', 
                                             '21110100', '21110101'))
    "
  ),
  
  `06 MobiliÃ¡ria externa refinanciamento` = list(
    criterio = "
    conta_contabil_numero %in% c('621200000', '621310000', '621320000', 
                                  '621330000', '621340000', '621390000') &
    natureza_receita_codigo_completo %in% c('21210201', '21210202', 
                                            '21210021', '21210022')
    "
  ),
  
  `08 MobiliÃ¡ria externa outras operaÃ§Ãµes mobiliÃ¡rias externas` = list(
    criterio = "
    conta_contabil_numero %in% c('621200000', '621310000', '621320000', 
                                  '621330000', '621340000', '621390000') &
    natureza_receita_codigo_completo %in% c('21210101', '21210102', 
                                            '21210011', '21210012')
    "
  ),
  
  `09 Contratual interna abertura de crÃ©dito` = list(
    criterio = "
    conta_contabil_numero %in% c('621200000', '621310000', '621320000', 
                                  '621330000', '621340000', '621390000') &
    startsWith(natureza_receita_codigo_completo, '2112001')
    "
  ),
  
  `11 Contratual interna outras operaÃ§Ãµes contratuais internas` = list(
    criterio = "
    conta_contabil_numero %in% c('621200000', '621310000', '621320000', 
                                  '621330000', '621340000', '621390000') &
    startsWith(natureza_receita_codigo_completo, '2119001')
    "
  ),
  
  `12 Contratual externa abertura de crÃ©dito orÃ§amentÃ¡rias` = list(
    criterio = "
    conta_contabil_numero %in% c('621200000', '621310000', '621320000', 
                                  '621330000', '621340000', '621390000') &
    (startsWith(natureza_receita_codigo_completo, '2122001') |
     natureza_receita_codigo_completo %in% c('21220100', '21220101', '21220102'))
    "
  ),
  
  `15 Contratual externa outras operaÃ§Ãµes contratuais externas` = list(
    criterio = "
    conta_contabil_numero %in% c('621200000', '621310000', '621320000', 
                                  '621330000', '621340000', '621390000') &
    startsWith(natureza_receita_codigo_completo, '2129001')
    "
  )
)

# ===============================================================================
# PARTE 2: EXTRAORÃ‡AMENTÃRIAS
# Base: rgf_a02_balancete
# ===============================================================================
criterios_rgf_A04_extra_orcamentarias <- list(
  
  `03 MobiliÃ¡ria interna extraorÃ§amentÃ¡rias aporte Bacen` = list(
    criterio = "
    conta_contabil_numero %in% c('896110303', '896110304')
    "
  ),
  
  `04 MobiliÃ¡ria interna extraorÃ§amentÃ¡rias aporte em empresas` = list(
    criterio = "
    conta_contabil_numero %in% c('896110311', '896110312')
    "
  ),
  
  `05 MobiliÃ¡ria interna extraorÃ§amentÃ¡rias trocas e demais operaÃ§Ãµes internas` = list(
    criterio = "
    conta_contabil_numero %in% c('896110301', '896110302', '896110305', '896110306')
    "
  ),
  
  `07 MobiliÃ¡ria externa assunÃ§Ã£o reconhecimento e confissÃ£o de dÃ­vidas` = list(
    criterio = "
    conta_contabil_numero %in% c('896110309', '896110310')
    "
  ),
  
  `10 Contratual interna assunÃ§Ã£o reconhecimento e confissÃ£o de dÃ­vidas` = list(
    criterio = "
    conta_contabil_numero == '212110398'
    "
  ),
  
  `13 Contratual externa abertura de crÃ©dito extraorÃ§amentÃ¡rias` = list(
    criterio = "
    conta_contabil_numero %in% c('896110307', '896110308')
    "
  ),
  
  `14 Contratual externa assunÃ§Ã£o reconhecimento e confissÃ£o de dÃ­vidas` = list(
    criterio = "
    FALSE
    "
  )
)

# ===============================================================================
# PARTE 3: DESPESAS (APLICAÃ‡ÃƒO DOS RECURSOS)
# Base: rgf_a04_despesas
# ===============================================================================
criterios_rgf_A04_despesas <- list(
  
  `16 AmortizaÃ§Ã£o refinanciamento` = list(
    criterio = "
    conta_contabil_numero %in% c('622130400', '622130600', '622130700') &
    grupo_despesa_codigo_grupo == '6'
    "
  ),
  
  `17 Outras despesas correntes` = list(
    criterio = "
    conta_contabil_numero %in% c('622130400', '622130600', '622130700') &
    grupo_despesa_codigo_grupo == '3'
    "
  ),
  
  `18 Pessoal e encargos sociais` = list(
    criterio = "
    conta_contabil_numero %in% c('622130400', '622130600', '622130700') &
    grupo_despesa_codigo_grupo == '1'
    "
  ),
  
  `19 Juros e encargos da dÃ­vida` = list(
    criterio = "
    conta_contabil_numero %in% c('622130400', '622130600', '622130700') &
    grupo_despesa_codigo_grupo == '2'
    "
  ),
  
  `20 Investimentos` = list(
    criterio = "
    conta_contabil_numero %in% c('622130400', '622130600', '622130700') &
    grupo_despesa_codigo_grupo == '4'
    "
  ),
  
  `21 InversÃµes financeiras` = list(
    criterio = "
    conta_contabil_numero %in% c('622130400', '622130600', '622130700') &
    grupo_despesa_codigo_grupo == '5'
    "
  )
)


df_criterios_rgf_A04_despesas <- aplicar_criterios(rgf_a04_despesas, criterios_rgf_A04_despesas)
df_criterios_rgf_A04_receitas <- aplicar_criterios(rgf_a04_receitas, criterios_rgf_A04_receitas)

df_criterios_rgf_A04_extra_orcamentarias <- aplicar_criterios(rgf_a02_balancete, criterios_rgf_A04_extra_orcamentarias)

datatable(aplicar_criterios(rgf_a04_receitas, criterios_rgf_A04_receitas) %>% group_by(ordem,nome) %>% summarise(valor = sum(valor)))%>% 
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")



```

# ğŸ“‹ RGF Anexo 05 (Disponibilidades)

```{r}
#| eval: !expr executar_relatorio("RGF_A05")



rgf_a05 <- rgf_a05 %>% mutate(orgao_fonte = str_c(detalhe_orgao_central_codigo_detalhe_oc,"_" ,detalhe_orgao_central_id_fonte , "_", fonte_recursos_codigo ))

rgf_a05 <- rgf_a05 %>% mutate(tg_orgao_fonte = str_c(detalhe_orgao_central_codigo_detalhe_oc,"_" ,detalhe_orgao_central_id_fonte  ))

# =============================================================================
# APLICAR CLASSIFICAÃ‡ÃƒO DE LINHAS (FONTES) SE NECESSÃRIO
# =============================================================================

if(!"linhas" %in% names(rgf_a05)) {
  rgf_a05 <- rgf_a05 %>%
    mutate(
      linhas = case_when(
        fonte_recursos_codigo %in% c("000") ~ "0_nao_vinculados",
        fonte_recursos_codigo %in% c("008", "012", "130", "133", "134") ~ "1_educacao",
        fonte_recursos_codigo %in% c("001", "002", "004", "005", "006", "010", "017", "023", "024", 
                                     "035", "040", "048", "049", "094", "126", "155", "156", "179", "184") ~  "2_seguridade_exceto_previdencia",
        fonte_recursos_codigo %in% c("122", "123") & tg_orgao_fonte %notin% c("000278_153","000278_154")  ~  "2_seguridade_exceto_previdencia",
        fonte_recursos_codigo %in% c("055", "056", "125") ~ "3_rpps",
        fonte_recursos_codigo %in% c("054") ~ "4_rgps",
        fonte_recursos_codigo %in% c("400", "401", "443", "444", "448") ~ "5_divida",
        fonte_recursos_codigo %in% c("034", "121", "122", "123") & tg_orgao_fonte %in% c("000278_133","000278_152","000278_153","000278_154") ~ "5_divida",
        fonte_recursos_codigo %in% c("201", "202", "203", "206", "207", "208", "209", "210", "211", "213",
                                     "219", "229", "234", "235", "241", "242", "251", 
                                     "286", "287", "288", "289") ~ "6_transferencias",
        fonte_recursos_codigo %in% c("003", "007", "009", "011", "013", "014", "015", "016", "018", "019",
                                     "020", "021", "022", "025", "026", "027", "028", "029", "030", "031",
                                     "032", "033", "034", "037", "038", "039", "041", "042", "043", "044",
                                     "045", "046", "047", "050", "051", "052", "053", "057", "058", "059",
                                     "060", "061", "062", "063", "064", "065", "066", "067", "068", "069",
                                     "070", "071", "072", "073", "074", "075", "076", "077", "078", "079",
                                     "080", "081", "082", "083", "084", "085", "086", "087", "088", "089",
                                     "090", "091", "092", "093", "095", "096", "097", "098", "099", "100",
                                     "101", "102", "103", "104", "105", "106", "107", "108", "109", "110",
                                     "111", "112", "113", "114", "115", "116", "118", "119", "120", "121",
                                     "124", "127", "128", "129", "131", "132" ,"135", "136", "137", "138", "139",
                                     "140", "141", "144", "145", "177", "178", "180", "181", "182", "183", "449") ~ "7_fundos_orgaos_programa",
        (fonte_recursos_codigo %in% c("034", "121") & tg_orgao_fonte %notin% c("000278_133","000278_152")) ~ "7_fundos_orgaos_programa",
        fonte_recursos_codigo %in% c("491") ~ "8_extraorcamentario",
        fonte_recursos_codigo %in% c("490", "'-9", "'-7") ~ "9_nao_classificados",
        TRUE ~ "outros"
      )
    )
}

# ===============================================================================
# CRITÃ‰RIOS RGF TABELA 04 - DISPONIBILIDADE DE CAIXA E RESTOS A PAGAR
# ===============================================================================

criterios_rgf_a05_disponibilidade <- list(
  
  # ===========================================================================
  # 1. RECEITAS
  # ===========================================================================
  `01_receitas` = list(
    criterio = "
    conta_contabil_numero %in% c('621200000', '621310000', '621320000', 
                                  '621330000', '621390000')
    "
  ),
  
  # ===========================================================================
  # 2. DESPESAS
  # ===========================================================================
  `02_despesas` = list(
    criterio = "
    conta_contabil_numero %in% c('622920104', '631400000', '632200000')
    "
  ),
  
  # ===========================================================================
  # 3. DISPONIBILIDADE DE CAIXA BRUTA (111 F menos 111110205)
  # ===========================================================================
  `03_disponibilidade_caixa_bruta` = list(
    criterio = "
    startsWith(conta_contabil_numero, '111') &
    isf_lancamento == 'F' &
    conta_contabil_numero != '111110205'
    "
  ),
  
  # ===========================================================================
  # 4. DEDUÃ‡ÃƒO: RECEITAS A CLASSIFICAR
  # ===========================================================================
  `04_deducao_receitas_classificar` = list(
    criterio = "
    conta_contabil_numero %in% c('111113001', '491110101', '491110102', '491110103', 
                                  '491110108', '491010101', '491010102', '491010103', 
                                  '491019701', '491019702', '491019703')
    "
  ),
  
  # ===========================================================================
  # 5. RESTOS A PAGAR LIQUIDADOS E NÃƒO PAGOS (EXERCÃCIOS ANTERIORES)
  # ===========================================================================
  `05_rp_liquidados_nao_pagos_exercicios_anteriores` = list(
    criterio = "
    conta_contabil_numero %in% c('632100000', '631300000')
    "
  ),
  
  # ===========================================================================
  # 6. RESTOS A PAGAR LIQUIDADOS E NÃƒO PAGOS (DO EXERCÃCIO)
  # ===========================================================================
  `06_rp_liquidados_nao_pagos_exercicio` = list(
    criterio = "
    conta_contabil_numero %in% c('632710000', '632720000', '632700000')
    "
  ),
  
  # ===========================================================================
  # 7. RESTOS A PAGAR EMPENHADOS E NÃƒO LIQUIDADOS (EXERCÃCIOS ANTERIORES)
  # ===========================================================================
  `07_rp_empenhados_nao_liquidados_exercicios_anteriores` = list(
    criterio = "
    conta_contabil_numero %in% c('631100000', '631200000', '631510000', '631520000', 
                                  '631530000', '631810000', '631820000', '631830000', 
                                  '631840000', '631540000')
    "
  ),
  
  # ===========================================================================
  # 8. DEMAIS OBRIGAÃ‡Ã•ES I (2 F menos 21892 3901, 3902, 3903, 4001 e 218914001)
  # ===========================================================================
  `08_demais_obrigacoes_i` = list(
    criterio = "
    startsWith(conta_contabil_numero, '2') &
    isf_lancamento == 'F' &
    !conta_contabil_numero %in% c('218923901', '218923902', '218923903', '218914001')
    "
  ),
  
  # ===========================================================================
  # 9. DEMAIS OBRIGAÃ‡Ã•ES II (2 F da CODIV - UG 170600)
  # ===========================================================================
  `09_demais_obrigacoes_ii_2f_da_codiv` = list(
    criterio = "
    startsWith(conta_contabil_numero, '2') &
    isf_lancamento == 'F' &
    ug_executora_codigo == '170600'
    "
  ),
  
  # ===========================================================================
  # 10. DEDUÃ‡ÃƒO: DEMAIS OBRIGAÃ‡Ã•ES I
  # ===========================================================================
  `10_deducao_demais_obrigacoes_i` = list(
    criterio = "
    conta_contabil_numero %in% c('631570000', '631590000', '631540000', '632100000', 
                                  '632720000', '531710200', '531720100', '218923901')
    "
  ),
  
  # ===========================================================================
  # 11. RESTOS A PAGAR EMPENHADOS E NÃƒO LIQUIDADOS (DO EXERCÃCIO)
  # ===========================================================================
  `11_rp_empenhados_nao_liquidados_exercicio` = list(
    criterio = "
    conta_contabil_numero %in% c('531710100', '531710200', '531720100')
    "
  ),
  
  # ===========================================================================
  # 12. EMPENHOS NÃƒO LIQUIDADOS CANCELADOS (POR INSUFICIÃŠNCIA FINANCEIRA)
  # ===========================================================================
  `12_empenhos_nao_liquidados_cancelados` = list(
    criterio = "
    conta_contabil_numero == '631910000'
    "
  ),
  
  # ===========================================================================
  # 13. CONTA: 822240101 - RECEBIMENTO DE RP AUTORIZADO
  # ===========================================================================
  `13_conta_822240101_recebimento_rp_autorizado` = list(
    criterio = "
    conta_contabil_numero == '822240101'
    "
  ),
  
  # ===========================================================================
  # 14. CONTA: 822140101 - LIBERAÃ‡ÃƒO DE RP AUTORIZADO
  # ===========================================================================
  `14_conta_822140101_liberacao_rp_autorizado` = list(
    criterio = "
    conta_contabil_numero == '822140101'
    "
  ),
  
  # ===========================================================================
  # 15. CONTA: 894310000 - DISPONIBILIDADE DE RECURSOS POR TED A LIBERAR
  # ===========================================================================
  `15_conta_894310000_disp_recursos_ted_liberar` = list(
    criterio = "
    conta_contabil_numero == '894310000'
    "
  ),
  
  # ===========================================================================
  # 16. CONTA: 894320000 - DISPONIBILIDADE DE RECURSOS POR TED A RECEBER
  # ===========================================================================
  `16_conta_894320000_disp_recursos_ted_receber` = list(
    criterio = "
    conta_contabil_numero == '894320000'
    "
  ),
  
  # ===========================================================================
  # 17. DEDUÃ‡ÃƒO: LIMITE DE SAQUE I
  # ===========================================================================
  `17_deducao_limite_saque_i` = list(
    criterio = "
    conta_contabil_numero %in% c('218924001') &
    isf_lancamento == 'F'
    "
  ),
  
  # ===========================================================================
  # 18. DEDUÃ‡ÃƒO: LIMITE DE SAQUE II (PODER EXECUTIVO)
  # ===========================================================================
  `18_deducao_limite_saque_ii_poder_executivo` = list(
    criterio = "
    conta_contabil_numero %in% c('218924001', '218924002') &
    orgao_c_cor_codigo %in% c('01000', '02000', '02001', '11000', '12000', 
                              '13000', '14000', '15000', '17000', '34000', 
                              '51100', '53000') &
    isf_lancamento == 'F'
    "
  ),
  
  # ===========================================================================
  # 19. DEDUÃ‡ÃƒO: DA DISPONIBILIDADE LÃQUIDA (111110205)
  # ===========================================================================
  `19_deducao_disponibilidade_liquida_111110205` = list(
    criterio = "
    conta_contabil_numero == '111110205'
    "
  ),
  
  # ===========================================================================
  # 20. DEDUÃ‡ÃƒO: DEMAIS OBRIGAÃ‡Ã•ES II
  # ===========================================================================
  `20_deducao_demais_obrigacoes_ii` = list(
    criterio = "
    conta_contabil_numero %in% c('218924001', '218914001') &
    isf_lancamento == 'F'
    "
  ),
  
  # ===========================================================================
  # 21. DEMAIS OBRIGAÃ‡Ã•ES FINANCEIRAS (NEW)
  # ===========================================================================
  `21_demais_obrigacoes_new` = list(
    criterio = "
    startsWith(conta_contabil_numero, '2') &
    !conta_contabil_numero %in% c('218923901', '218923902', '218923903', 
                                   '218924001', '218914001') &
    isf_lancamento == 'F' &
    ug_executora_codigo != '170600'
    "
  ),
  
  # ===========================================================================
  # 22. DEMAIS OBRIGAÃ‡Ã•ES - SUBTRAÃ‡ÃƒO
  # ===========================================================================
  `22_demais_obrigacoes_subtracao` = list(
    criterio = "
    conta_contabil_numero %in% c('631200000', '631300000', '631520000', '632100000', 
                                  '631540000', '218929031', '218929032', '218929033', 
                                  '531720100', '531710200', '632710000', '632720000')
    "
  )
)





```

```{r}
#| eval: !expr executar_relatorio("RGF_A05")
#| column: screen
#| include: false
# ===============================================================================
# ANEXO 5 RGF - UNIÃƒO E EXECUTIVO (CORRIGIDO)
# ProtÃ³tipo em R/RStudio
# ===============================================================================

library(dplyr)
library(tidyr)
library(readxl)
library(writexl)
library(janitor)
library(DT)

# ===============================================================================
# FUNÃ‡ÃƒO AUXILIAR
# ===============================================================================

get_col <- function(df, nome_coluna) {
  if (nome_coluna %in% names(df)) {
    return(df[[nome_coluna]])
  } else {
    return(0)
  }
}

# ===============================================================================
# ETAPA 0: CRIAR VARIÃVEL ABRANGÃŠNCIA COM DUPLICAÃ‡ÃƒO DE REGISTROS
# ===============================================================================

# UniÃ£o: TODOS os registros
rgf_a05_uniao <- rgf_a05 %>%
  mutate(abrangencia = "uniao")

# Executivo: Apenas Poder Executivo, exceto DPU (34000) e MPU (59000)
rgf_a05_executivo <- rgf_a05 %>%
  filter(
    orgao_uge_poder_codigo == "0" & 
    !(orgao_uge_orgao_maximo_codigo %in% c("34000", "59000"))
  ) %>%
  mutate(abrangencia = "executivo")

# Combinar as duas abrangÃªncias (duplicando registros do Executivo)
rgf_a05_abrangencia <- bind_rows(rgf_a05_uniao, rgf_a05_executivo)

# Verificar distribuiÃ§Ã£o
cat("=== VERIFICAÃ‡ÃƒO DE ABRANGÃŠNCIA ===\n")
rgf_a05_abrangencia %>% 
  count(abrangencia) %>%
  print()

# Verificar registros excluÃ­dos do Executivo
cat("\n=== Ã“RGÃƒOS EXCLUÃDOS DO EXECUTIVO ===\n")
rgf_a05 %>%
  filter(orgao_uge_orgao_maximo_codigo %in% c("34000", "59000")) %>%
  count(orgao_uge_orgao_maximo_codigo, orgao_uge_orgao_maximo_nome) %>%
  print()

# ===============================================================================
# ETAPA 1: APLICAR CRITÃ‰RIOS E PIVOTAR
# ===============================================================================

# Aplicar critÃ©rios de filtro COM abrangÃªncia
resultado_rgf_a05 <- aplicar_criterios(
  df = rgf_a05_abrangencia,
  criterios = criterios_rgf_a05_disponibilidade,
  group_vars = c("linhas", "abrangencia")
)

# Pivotar para formato wide
rgf_a05_wide <- resultado_rgf_a05 %>%
  select(mes_lancamento, linhas, abrangencia, categoria, valor) %>%
  pivot_wider(names_from = categoria, values_from = valor, values_fill = 0)

# ===============================================================================
# ETAPA 2: RENOMEAR COLUNAS BÃSICAS
# ===============================================================================

rgf_a05_wide <- rgf_a05_wide %>%
  mutate(
    # Colunas de receitas e despesas
    receitas = get_col(., "01_receitas"),
    despesas = get_col(., "02_despesas"),
    
    # Disponibilidade de caixa
    disponibilidade_caixa_bruta = get_col(., "03_disponibilidade_caixa_bruta"),
    deducao_receitas_classificar = get_col(., "04_deducao_receitas_classificar"),
    
    # Restos a Pagar
    rp_liquidados_nao_pagos_exercicios_anteriores = 
      get_col(., "05_rp_liquidados_nao_pagos_exercicios_anteriores"),
    rp_liquidados_nao_pagos_exercicio = 
      get_col(., "06_rp_liquidados_nao_pagos_exercicio"),
    rp_empenhados_nao_liquidados_exercicios_anteriores = 
      get_col(., "07_rp_empenhados_nao_liquidados_exercicios_anteriores"),
    
    # ObrigaÃ§Ãµes
    demais_obrigacoes_new = get_col(., "21_demais_obrigacoes_new"),
    demais_obrigacoes_subtracao = get_col(., "22_demais_obrigacoes_subtracao"),
    
    # TEDs
    conta_894310000_disp_recursos_ted_liberar = 
      get_col(., "15_conta_894310000_disp_recursos_ted_liberar"),
    conta_894320000_disp_recursos_ted_receber = 
      get_col(., "16_conta_894320000_disp_recursos_ted_receber")
  )

# ===============================================================================
# ETAPA 3: CALCULAR DISPONIBILIDADE BRUTA CLEAN
# ===============================================================================

rgf_a05_clean <- rgf_a05_wide %>%
  mutate(
    disponibilidade_bruta_clean = case_when(
      linhas == "7_fundos_orgaos_programa" ~ 
        disponibilidade_caixa_bruta + 
        conta_894320000_disp_recursos_ted_receber - 
        conta_894310000_disp_recursos_ted_liberar,
      
      linhas == "9_nao_classificados" ~ 
        disponibilidade_caixa_bruta - deducao_receitas_classificar,
      
      TRUE ~ disponibilidade_caixa_bruta
    )
  )

# ===============================================================================
# ETAPA 4: CALCULAR DEMAIS OBRIGAÃ‡Ã•ES FINANCEIRAS CLEAN
# ===============================================================================

rgf_a05_clean <- rgf_a05_clean %>%
  mutate(
    demais_obrigacoes_financeiras_clean = case_when(
      linhas == "7_fundos_orgaos_programa" ~ 
        demais_obrigacoes_new - demais_obrigacoes_subtracao,
      
      TRUE ~ 
        demais_obrigacoes_new - demais_obrigacoes_subtracao + 
        conta_894310000_disp_recursos_ted_liberar - 
        conta_894320000_disp_recursos_ted_receber
    )
  )

# ===============================================================================
# ETAPA 5: LER E PREPARAR DISPONIBILIDADE INICIAL DAS DUAS ABAS
# ===============================================================================

# Ler aba UniÃ£o
disp_inicial_uniao <- read_excel("disponibilidade_inicial.xlsx", sheet = "uniao") %>%
  mutate(abrangencia = "uniao")

# Ler aba Executivo
disp_inicial_executivo <- read_excel("disponibilidade_inicial.xlsx", sheet = "executivo") %>%
  mutate(abrangencia = "executivo")

# Combinar as duas abas
disponibilidade_inicial <- bind_rows(disp_inicial_uniao, disp_inicial_executivo)

# ===============================================================================
# ETAPA 6: JOIN COM DISPONIBILIDADE INICIAL
# ===============================================================================

rgf_a05_clean <- rgf_a05_clean %>%
  left_join(disponibilidade_inicial, by = c("linhas", "abrangencia"))

# ===============================================================================
# ETAPA 7: CALCULAR DEMAIS FLUXOS CLEAN
# ===============================================================================

rgf_a05_clean <- rgf_a05_clean %>%
  mutate(
    demais_fluxos_clean = 
      disponibilidade_inicial + 
      receitas - 
      despesas - 
      disponibilidade_bruta_clean
  )

# ===============================================================================
# ETAPA 8: CALCULAR DISPONIBILIDADE ANTES DA INSCRIÃ‡ÃƒO DE RP
# ===============================================================================

rgf_a05_clean <- rgf_a05_clean %>%
  mutate(
    disponibilidade_antes_inscr_rp_clean = 
      disponibilidade_bruta_clean - 
      rp_liquidados_nao_pagos_exercicios_anteriores - 
      rp_empenhados_nao_liquidados_exercicios_anteriores - 
      rp_liquidados_nao_pagos_exercicio - 
      demais_obrigacoes_financeiras_clean
  )

# ===============================================================================
# ETAPA 9: SELECIONAR E ORDENAR COLUNAS FINAIS
# ===============================================================================

rgf_a05_final <- rgf_a05_clean %>%
  select(
    mes_lancamento,
    linhas,
    abrangencia,
    disponibilidade_inicial,
    receitas,
    despesas,
    demais_fluxos_clean,
    disponibilidade_bruta_clean,
    rp_liquidados_nao_pagos_exercicios_anteriores,
    rp_liquidados_nao_pagos_exercicio,
    rp_empenhados_nao_liquidados_exercicios_anteriores,
    demais_obrigacoes_financeiras_clean,
    disponibilidade_antes_inscr_rp_clean
  ) %>%
  arrange(abrangencia, linhas)

# ===============================================================================
# ETAPA 10: SEPARAR UNIÃƒO E EXECUTIVO
# ===============================================================================

# Tabela UniÃ£o
rgf_a05_uniao <- rgf_a05_final %>%
  filter(abrangencia == "uniao") %>%
  select(-abrangencia)

# Tabela Executivo
rgf_a05_executivo <- rgf_a05_final %>%
  filter(abrangencia == "executivo") %>%
  select(-abrangencia)

# ===============================================================================
# ETAPA 11: FORMATAR TABELAS EM MILHÃ•ES
# ===============================================================================

formatar_tabela <- function(df) {
  df %>% 
    filter(linhas != "outros") %>% 
    adorn_totals("row") %>%
    mutate(
      across(
        where(is.numeric) & !matches("mes_lancamento"),
        ~ round(.x, 2)
      )
    )
}

rgf_a05_uniao_formatada <- formatar_tabela(rgf_a05_uniao)
rgf_a05_executivo_formatada <- formatar_tabela(rgf_a05_executivo)

# ===============================================================================
# ETAPA 12: EXPORTAR
# ===============================================================================

# write_xlsx(
#   list(
#     "Uniao_Final" = rgf_a05_uniao,
#     "Uniao_Milhoes" = rgf_a05_uniao_formatada,
#     "Executivo_Final" = rgf_a05_executivo,
#     "Executivo_Milhoes" = rgf_a05_executivo_formatada,
#     "Completo" = rgf_a05_final,
#     "Disponibilidade_Inicial" = disponibilidade_inicial
#   ),
#   path = "rgf_a05_final_completo.xlsx"
# )

# ===============================================================================
# ETAPA 13: VISUALIZAÃ‡ÃƒO - UNIÃƒO
# ===============================================================================

novos_nomes <- rgf_a05_uniao_formatada %>% 
  select(-mes_lancamento) %>% 
  colnames() %>%
  gsub("_clean", "", .) %>%
  gsub("_", " ", .) %>%
  gsub("nao pagos", "NP", .) %>%
  gsub("exercicios", "exerc.", .) %>%
  gsub("anteriores", "ant.", .) %>%
  gsub("liquidados", "liq.", .) %>%
  gsub("empenhados", "emp.", .) %>%
  gsub("disponibilidade", "disp.", .)







```

```{r rgf_05_tabela_uniao}
#| eval: !expr executar_relatorio("RGF_A05")
#| column: screen

cat("\n=== TABELA UNIÃƒO ===\n")
datatable(
  rgf_a05_uniao_formatada %>% select(-mes_lancamento),
  colnames = novos_nomes,
  caption = "RGF Anexo 5 - UNIÃƒO (Todos os Poderes)",
  options = list(scrollX = TRUE, pageLength = 15),
  rownames = FALSE
) %>%
  formatCurrency(2:11, "", mark = ".", dec.mark = ",", digits = 2)

```

```{r rgf_05_tabela_executivo}
#| eval: !expr executar_relatorio("RGF_A05")
#| column: screen
cat("\n=== TABELA EXECUTIVO ===\n")
datatable(
  rgf_a05_executivo_formatada %>% select(-mes_lancamento),
  colnames = novos_nomes,
  caption = "RGF Anexo 5 - PODER EXECUTIVO (exceto DPU e MPU)",
  options = list(scrollX = TRUE, pageLength = 15),
  rownames = FALSE
) %>%
  formatCurrency(2:11, "", mark = ".", dec.mark = ",", digits = 2)
```

```{r rreo-header}
#| eval: !expr executar_modulo("RREO")
#| echo: false

cat("\n")
cat("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")
cat("   RREO - RELATÃ“RIO RESUMIDO DA EXECUÃ‡ÃƒO ORÃ‡AMENTÃRIA\n")
cat(sprintf("   PerÃ­odo: %s\n", MES_REF))
cat("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")
cat("\n")
```

# RREO - RelatÃ³rio Resumido de ExecuÃ§Ã£o OrÃ§amentÃ¡ria

# ğŸ“‹ RREO Anexo 01 - BalanÃ§o OrÃ§amentÃ¡rio {#sec-anexo-07}

```{r}
#| eval: !expr executar_relatorio("RREO_A01")
#| include: false
criterios_rreo_A01_receitas_bo  <- list(
  
  # ========== RECEITAS CORRENTES ==========
  
  # RECEITAS CORRENTES
  `01_receitas_correntes` = list(
    criterio = "nre1_categoria_economica_codigo == 1"
  ),
  
  # IMPOSTOS, TAXAS E CONTRIBUIÃ‡Ã•ES DE MELHORIA
  `02_impostos_taxas_contrib_melhoria` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 1 &
    nre3_especie_receita_codigo_especie %in% c(1, 2, 3)
    "
  ),
  
  # IMPOSTOS
  `03_impostos` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 1 &
    nre3_especie_receita_codigo_especie == 1
    "
  ),
  
  # TAXAS
  `04_taxas` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 1 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  # CONTRIBUIÃ‡Ã•ES
  `05_contribuicoes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 2
    "
  ),
  
  # CONTRIBUIÃ‡Ã•ES SOCIAIS
  `06_contribuicoes_sociais` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 2 &
    nre3_especie_receita_codigo_especie == 1
    "
  ),
  
  # CONTRIBUIÃ‡Ã•ES DE INTERVENÃ‡ÃƒO NO DOMÃNIO ECONÃ”MICO
  `07_contrib_intervencao_dominio_economico` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 2 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  # RECEITA PATRIMONIAL
  `08_receita_patrimonial` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3
    "
  ),
  
  # EXPLORAÃ‡ÃƒO DO PATRIMÃ”NIO IMOBILIÃRIO DO ESTADO
  `09_exploracao_patrimonio_imobiliario` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3 &
    nre3_especie_receita_codigo_especie == 1
    "
  ),
  
  # VALORES MOBILIÃRIOS
  `10_valores_mobiliarios` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  # DELEGAÃ‡ÃƒO DE SERVIÃ‡OS PÃšBLICOS
  `11_delegacao_servicos_publicos` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3 &
    nre3_especie_receita_codigo_especie == 3
    "
  ),
  
  # EXPLORAÃ‡ÃƒO DE RECURSOS NATURAIS
  `12_exploracao_recursos_naturais` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3 &
    nre3_especie_receita_codigo_especie == 4
    "
  ),
  
  # EXPLORAÃ‡ÃƒO DO PATRIMÃ”NIO INTANGÃVEL
  `13_exploracao_patrimonio_intangivel` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3 &
    nre3_especie_receita_codigo_especie == 5
    "
  ),
  
  # CESSÃƒO DE DIREITOS
  `14_cessao_direitos` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3 &
    nre3_especie_receita_codigo_especie == 6
    "
  ),
  
  # DEMAIS RECEITAS PATRIMONIAIS
  `15_demais_receitas_patrimoniais` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3 &
    nre3_especie_receita_codigo_especie == 9
    "
  ),
  
  # RECEITA AGROPECUÃRIA
  `16_receita_agropecuaria` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 4
    "
  ),
  
  # RECEITA INDUSTRIAL
  `17_receita_industrial` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 5
    "
  ),
  
  # RECEITAS DE SERVIÃ‡OS
  `18_receitas_servicos` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 6
    "
  ),
  
  # SERVIÃ‡OS ADMINISTRATIVOS E COMERCIAIS GERAIS
  `19_servicos_admin_comerciais` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '161')"
  ),
  
  # SERVIÃ‡OS E ATIVIDADES REFERENTES Ã€ NAVEGAÃ‡ÃƒO E AO TRANSPORTE
  `20_servicos_navegacao_transporte` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '162')"
  ),
  
  # SERVIÃ‡OS E ATIVIDADES REFERENTES Ã€ SAÃšDE
  `21_servicos_saude` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '163')"
  ),
  
  # SERVIÃ‡OS E ATIVIDADES FINANCEIRAS
  `22_servicos_financeiros` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '164')"
  ),
  
  # OUTROS SERVIÃ‡OS
  `23_outros_servicos` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '169')"
  ),
  
  # TRANSFERÃŠNCIAS CORRENTES
  `24_transferencias_correntes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 7
    "
  ),
  
  # TRANSFERÃŠNCIAS DA UNIÃƒO E DE SUAS ENTIDADES
  `25_transf_uniao_entidades` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 7 &
    nre3_especie_receita_codigo_especie == 1
    "
  ),
  
  # TRANSFERÃŠNCIAS DOS ESTADOS E DO DISTRITO FEDERAL E DE SUAS ENTIDADES
  `26_transf_estados_df_entidades` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 7 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  # TRANSFERÃŠNCIAS DOS MUNICÃPIOS E DE SUAS ENTIDADES
  `27_transf_municipios_entidades` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 7 &
    nre3_especie_receita_codigo_especie == 3
    "
  ),
  
  # TRANSFERÃŠNCIAS DE INSTITUIÃ‡Ã•ES PRIVADAS
  `28_transf_instituicoes_privadas` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 7 &
    nre3_especie_receita_codigo_especie == 4
    "
  ),
  
  # TRANSFERÃŠNCIAS DE OUTRAS INSTITUIÃ‡Ã•ES PÃšBLICAS
  `29_transf_outras_instituicoes_publicas` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 7 &
    nre3_especie_receita_codigo_especie == 5
    "
  ),
  
  # TRANSFERÃŠNCIAS DO EXTERIOR
  `30_transf_exterior` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 7 &
    nre3_especie_receita_codigo_especie == 6
    "
  ),
  
  # DEMAIS TRANSFERÃŠNCIAS CORRENTES
  `31_demais_transf_correntes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 7 &
    nre3_especie_receita_codigo_especie == 9
    "
  ),
  
  # OUTRAS RECEITAS CORRENTES
  `32_outras_receitas_correntes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 9
    "
  ),
  
  # MULTAS ADMINISTRATIVAS, CONTRATUAIS E JUDICIAIS
  `33_multas_admin_contratuais` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 9 &
    nre3_especie_receita_codigo_especie == 1
    "
  ),
  
  # INDENIZAÃ‡Ã•ES, RESTITUIÃ‡Ã•ES E RESSARCIMENTOS
  `34_indenizacoes_restituicoes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 9 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  # BENS, DIREITOS E VALORES INCORPORADOS AO PATRIMÃ”NIO PÃšBLICO
  `35_bens_direitos_valores` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 9 &
    nre3_especie_receita_codigo_especie == 3
    "
  ),
  
  # MULTAS E JUROS DE MORA DAS RECEITAS DE CAPITAL
  `36_multas_juros_mora_capital` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 9 &
    nre3_especie_receita_codigo_especie == 4
    "
  ),
  
  # DEMAIS RECEITAS CORRENTES
  `37_demais_receitas_correntes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 9 &
    nre3_especie_receita_codigo_especie == 9
    "
  ),
  
  # RECEITAS CORRENTES A CLASSIFICAR
  `38_receitas_correntes_classificar` = list(
    criterio = "
    nre2_origem_receita_codigo_origem == 8 &
    nre3_especie_receita_codigo_especie == 8
    "
  ),
  
  # ========== RECEITAS DE CAPITAL ==========
  
  # RECEITAS DE CAPITAL
`39_receitas_capital` = list(
  criterio = "
  nre1_categoria_economica_codigo == 2 &
  !(startsWith(natureza_receita_codigo_completo, '21110201') |
    startsWith(natureza_receita_codigo_completo, '21210201'))
  "
),
  
 # OPERAÃ‡Ã•ES DE CRÃ‰DITO
`40_operacoes_credito` = list(
  criterio = "
  nre1_categoria_economica_codigo == 2 & 
  nre2_origem_receita_codigo_origem == 1 &
  !(startsWith(natureza_receita_codigo_completo, '21110201') |
    startsWith(natureza_receita_codigo_completo, '21210201'))
  "
),

# OPERAÃ‡Ã•ES DE CRÃ‰DITO INTERNAS
`41_operacoes_credito_internas` = list(
  criterio = "
  nre1_categoria_economica_codigo == 2 & 
  nre2_origem_receita_codigo_origem == 1 &
  nre3_especie_receita_codigo_especie == 1 &
  !startsWith(natureza_receita_codigo_completo, '21110201')
  "
),

# OPERAÃ‡Ã•ES DE CRÃ‰DITO EXTERNAS
`42_operacoes_credito_externas` = list(
  criterio = "
  nre1_categoria_economica_codigo == 2 & 
  nre2_origem_receita_codigo_origem == 1 &
  nre3_especie_receita_codigo_especie == 2 &
  !startsWith(natureza_receita_codigo_completo, '21210201')
  "
),
  
  # ALIENAÃ‡ÃƒO DE BENS
  `43_alienacao_bens` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 2
    "
  ),
  
  # ALIENAÃ‡ÃƒO DE BENS MÃ“VEIS
  `44_alienacao_bens_moveis` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 2 &
    nre3_especie_receita_codigo_especie == 1
    "
  ),
  
  # ALIENAÃ‡ÃƒO DE BENS IMÃ“VEIS
  `45_alienacao_bens_imoveis` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 2 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  # ALIENAÃ‡ÃƒO DE BENS INTANGÃVEIS
  `46_alienacao_bens_intangiveis` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '223')"
  ),
  
  # AMORTIZAÃ‡Ã•ES DE EMPRÃ‰STIMOS
  `47_amortizacoes_emprestimos` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 3
    "
  ),
  
  # TRANSFERÃŠNCIAS DE CAPITAL
  `48_transferencias_capital` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 4
    "
  ),
  
  # TRANSFERÃŠNCIAS DOS ESTADOS E DO DISTRITO FEDERAL E DE SUAS ENTIDADES (CAPITAL)
  `49_transf_estados_df_capital` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 4 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  # TRANSFERÃŠNCIAS DOS MUNICÃPIOS E DE SUAS ENTIDADES (CAPITAL)
  `50_transf_municipios_capital` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 4 &
    nre3_especie_receita_codigo_especie == 3
    "
  ),
  
  # TRANSFERÃŠNCIAS DE INSTITUIÃ‡Ã•ES PRIVADAS (CAPITAL)
  `51_transf_instituicoes_privadas_capital` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 4 &
    nre3_especie_receita_codigo_especie == 4
    "
  ),
  
  # TRANSFERÃŠNCIAS DE OUTRAS INSTITUIÃ‡Ã•ES PÃšBLICAS (CAPITAL)
  `52_transf_outras_instituicoes_publicas_capital` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 4 &
    nre3_especie_receita_codigo_especie == 5
    "
  ),
  
  # TRANSFERÃŠNCIAS DO EXTERIOR (CAPITAL)
  `53_transf_exterior_capital` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 4 &
    nre3_especie_receita_codigo_especie == 6
    "
  ),
  
  # DEMAIS TRANSFERÃŠNCIAS DE CAPITAL
  `54_demais_transf_capital` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 4 &
    nre3_especie_receita_codigo_especie == 9
    "
  ),
  
  # OUTRAS RECEITAS DE CAPITAL
  `55_outras_receitas_capital` = list(
    criterio = "
    nre2_origem_receita_codigo_origem == 9 &
    nre1_categoria_economica_codigo == 2
    "
  ),
  
  # RESULTADO DO BANCO CENTRAL DO BRASIL
  `56_resultado_banco_central` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 9 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  # REMUNERAÃ‡ÃƒO DAS DISPONIBILIDADES DO TESOURO
  `57_remuneracao_disponibilidades_tesouro` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '293')"
  ),
  
  # ========== RECEITAS INTRA-ORÃ‡AMENTÃRIAS ==========
  
  # RECEITAS CORRENTES INTRA
  `58_receitas_correntes_intra` = list(
    criterio = "nre1_categoria_economica_codigo == 7"
  ),
  
  # IMPOSTOS, TAXAS E CONTRIBUIÃ‡Ã•ES DE MELHORIA INTRA
  `59_impostos_taxas_contrib_melhoria_intra` = list(
    criterio = "
    nre1_categoria_economica_codigo == 7 & 
    nre2_origem_receita_codigo_origem == 1
    "
  ),
  
  # IMPOSTOS INTRA
  `60_impostos_intra` = list(
    criterio = "
    nre1_categoria_economica_codigo == 7 & 
    nre2_origem_receita_codigo_origem == 1 &
    nre3_especie_receita_codigo_especie == 1
    "
  ),
  
  # TAXAS INTRA
  `61_taxas_intra` = list(
    criterio = "
    nre1_categoria_economica_codigo == 7 & 
    nre2_origem_receita_codigo_origem == 1 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  # CONTRIBUIÃ‡Ã•ES INTRA
  `62_contribuicoes_intra` = list(
    criterio = "
    nre1_categoria_economica_codigo == 7 & 
    nre2_origem_receita_codigo_origem == 2
    "
  ),
  
  # CONTRIBUIÃ‡Ã•ES SOCIAIS INTRA
  `63_contribuicoes_sociais_intra` = list(
    criterio = "
    nre1_categoria_economica_codigo == 7 & 
    nre2_origem_receita_codigo_origem == 2 &
    nre3_especie_receita_codigo_especie == 1
    "
  ),
  
  # CONTRIBUIÃ‡Ã•ES ECONÃ”MICAS INTRA
  `64_contribuicoes_economicas_intra` = list(
    criterio = "
    nre1_categoria_economica_codigo == 7 & 
    nre2_origem_receita_codigo_origem == 2 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  # RECEITA PATRIMONIAL INTRA
  `65_receita_patrimonial_intra` = list(
    criterio = "
    nre1_categoria_economica_codigo == 7 & 
    nre2_origem_receita_codigo_origem == 3
    "
  ),
  
  # EXPLORAÃ‡ÃƒO PATRIMÃ”NIO IMOBILIÃRIO INTRA
  `66_exploracao_patrimonio_imobiliario_intra` = list(
    criterio = "
    nre1_categoria_economica_codigo == 7 & 
    nre2_origem_receita_codigo_origem == 3 &
    nre3_especie_receita_codigo_especie == 1
    "
  ),
  
  # VALORES MOBILIÃRIOS INTRA
  `67_valores_mobiliarios_intra` = list(
    criterio = "
    nre1_categoria_economica_codigo == 7 & 
    nre2_origem_receita_codigo_origem == 3 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  # DELEGAÃ‡ÃƒO SERVIÃ‡OS PÃšBLICOS INTRA
  `68_delegacao_servicos_publicos_intra` = list(
    criterio = "
    nre1_categoria_economica_codigo == 7 & 
    nre2_origem_receita_codigo_origem == 3 &
    nre3_especie_receita_codigo_especie == 3
    "
  ),
  
  # RECEITA INDUSTRIAL INTRA
  `69_receita_industrial_intra` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '75')"
  ),
  
  # RECEITA DE SERVIÃ‡OS INTRA
  `70_receita_servicos_intra` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '76')"
  ),
  
  # SERVIÃ‡OS ADMINISTRATIVOS COMERCIAIS INTRA
  `71_servicos_admin_comerciais_intra` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '761')"
  ),
  
  # SERVIÃ‡OS E ATIVIDADES REFERENTES Ã€ SAÃšDE INTRA
  `72_servicos_saude_intra` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '763')"
  ),
  
  # SERVIÃ‡OS E ATIVIDADES FINANCEIRAS INTRA
  `73_servicos_financeiros_intra` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '764')"
  ),
  
  # OUTROS SERVIÃ‡OS INTRA
  `74_outros_servicos_intra` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '769')"
  ),
  
  # OUTRAS RECEITAS CORRENTES INTRA
  `75_outras_receitas_correntes_intra` = list(
    criterio = "
    nre1_categoria_economica_codigo == 7 & 
    nre2_origem_receita_codigo_origem == 9
    "
  ),
  
  # MULTAS ADMINISTRATIVAS, CONTRATUAIS E JUDICIAIS INTRA
  `76_multas_admin_contratuais_intra` = list(
    criterio = "
    nre1_categoria_economica_codigo == 7 & 
    nre2_origem_receita_codigo_origem == 9 &
    nre3_especie_receita_codigo_especie == 1
    "
  ),
  
  # INDENIZAÃ‡Ã•ES, RESTITUIÃ‡Ã•ES E RESSARCIMENTOS INTRA
  `77_indenizacoes_restituicoes_intra` = list(
    criterio = "
    nre1_categoria_economica_codigo == 7 & 
    nre2_origem_receita_codigo_origem == 9 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  # DEMAIS RECEITAS CORRENTES INTRA
  `78_demais_receitas_correntes_intra` = list(
    criterio = "
    nre1_categoria_economica_codigo == 7 & 
    nre2_origem_receita_codigo_origem == 9 &
    nre3_especie_receita_codigo_especie == 9
    "
  ),
  
  # ========== SUBTOTAIS E OPERAÃ‡Ã•ES DE REFINANCIAMENTO ==========
  
  # SUBTOTAL DAS RECEITAS (III) = (I + II)
  `79_subtotal_receitas` = list(
    criterio = "
    nre1_categoria_economica_codigo %in% c(1, 2, 7, 8) &
    !(startsWith(natureza_receita_codigo_completo, '21110201') |
      startsWith(natureza_receita_codigo_completo, '21210201') |
      startsWith(natureza_receita_codigo_completo, '81110201') |
      startsWith(natureza_receita_codigo_completo, '81210201'))
    "
  ),
  
  # OPERAÃ‡Ã•ES DE CRÃ‰DITO - REFINANCIAMENTO (IV)
  `80_operacoes_credito_refinanciamento` = list(
    criterio = "
    startsWith(natureza_receita_codigo_completo, '21110201') |
    startsWith(natureza_receita_codigo_completo, '21210201') |
    startsWith(natureza_receita_codigo_completo, '81110201') |
    startsWith(natureza_receita_codigo_completo, '81210201')
    "
  ),
  
  # OPERAÃ‡Ã•ES DE CRÃ‰DITO INTERNAS - REFINANCIAMENTO
  `81_operacoes_credito_internas_refinanciamento` = list(
    criterio = "
    startsWith(natureza_receita_codigo_completo, '21110201') |
    startsWith(natureza_receita_codigo_completo, '81110201')
    "
  ),
  
  # MOBILIÃRIA - REFINANCIAMENTO (CRÃ‰DITO INTERNO)
  `82_mobiliaria_refinanciamento_interno` = list(
    criterio = "
    startsWith(natureza_receita_codigo_completo, '21110201') |
    startsWith(natureza_receita_codigo_completo, '81110201')
    "
  ),
  
  # OPERAÃ‡Ã•ES DE CRÃ‰DITO EXTERNAS - REFINANCIAMENTO
  `83_operacoes_credito_externas_refinanciamento` = list(
    criterio = "
    startsWith(natureza_receita_codigo_completo, '212102') |
    startsWith(natureza_receita_codigo_completo, '812102')
    "
  ),
  
  # MOBILIÃRIA - REFINANCIAMENTO (CRÃ‰DITO EXTERNO)
  `84_mobiliaria_refinanciamento_externo` = list(
    criterio = "
    startsWith(natureza_receita_codigo_completo, '212102') |
    startsWith(natureza_receita_codigo_completo, '812102')
    "
  ),
  
  # SUBTOTAL COM REFINANCIAMENTO (V) = (III + IV)
  `85_subtotal_com_refinanciamento` = list(
    criterio = "nre1_categoria_economica_codigo %in% c(1, 2, 7, 8)"
  )
)
aplicar_criterios(dados_receita, criterios_rreo_A01_receitas_bo, group_vars = c("item_informacao_codigo", "item_informacao_nome")  )
```

```{r}
#| eval: !expr executar_relatorio("RREO_A01")
#| include: false
criterios_rreo_A01_despesas_bo <- list(
  
  # ========== DESPESAS (Exceto Intra-OrÃ§amentÃ¡rias) (IX) ==========
  
  # DESPESAS (Exceto Intra-OrÃ§amentÃ¡rias) (IX)
  `01_despesas_exceto_intra` = list(
    criterio = "
    modalidade_aplicacao_codigo != 91 &
    !(elemento_despesa_codigo %in% c('76', '77') &
      subfuncao_governo_codigo %in% c('841', '842', '843', '844', '846') &
      fonte_recursos_codigo == '443')
    "
  ),
  
  # ========== DESPESAS CORRENTES ==========
  
  # DESPESAS CORRENTES
  `02_despesas_correntes` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    modalidade_aplicacao_codigo != 91
    "
  ),
  
  # PESSOAL E ENCARGOS SOCIAIS
  `03_pessoal_encargos_sociais` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 1 &
    modalidade_aplicacao_codigo != 91
    "
  ),
  
  # JUROS E ENCARGOS DA DÃVIDA
  `04_juros_encargos_divida` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 2 &
    modalidade_aplicacao_codigo != 91
    "
  ),
  
  # OUTRAS DESPESAS CORRENTES
  `05_outras_despesas_correntes` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 3 &
    modalidade_aplicacao_codigo != 91
    "
  ),
  
  # TRANSFERÃŠNCIA A ESTADOS, DF E MUNICÃPIOS
  `06_transferencia_estados_df_municipios` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 3 &
    modalidade_aplicacao_codigo %in% c('30', '31', '32', '40', '41', '42', '43', '44', '45', '46') &
    modalidade_aplicacao_codigo != 91
    "
  ),
  
  # BENEFÃCIOS PREVIDENCIÃRIOS
  `07_beneficios_previdenciarios` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 3 &
    modalidade_aplicacao_codigo != 91 &
    unidade_orcamentaria_codigo %in% c('55902', '40904', '33904', '25917')
    "
  ),
  
  # DEMAIS DESPESAS CORRENTES
  `08_demais_despesas_correntes` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 3 &
    modalidade_aplicacao_codigo != 91 &
    !(modalidade_aplicacao_codigo %in% c('30', '31', '32', '40', '41', '42', '43', '44', '45', '46')) &
    !(unidade_orcamentaria_codigo %in% c('55902', '40904', '33904', '25917'))
    "
  ),
  
  # ========== DESPESAS DE CAPITAL ==========
  
  # DESPESAS DE CAPITAL (corrigido)
  `09_despesas_capital` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 &
    modalidade_aplicacao_codigo != 91 &
    !(elemento_despesa_codigo %in% c('76', '77') &
      subfuncao_governo_codigo %in% c('841', '842', '843', '844', '846') &
      fonte_recursos_codigo == '443')
    "
  ),
  
  # INVESTIMENTOS
  `10_investimentos` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 &
    grupo_despesa_codigo_grupo == 4 &
    modalidade_aplicacao_codigo != 91
    "
  ),
  
  # INVERSÃ•ES FINANCEIRAS
  `11_inversoes_financeiras` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 &
    grupo_despesa_codigo_grupo == 5 &
    modalidade_aplicacao_codigo != 91
    "
  ),
  
  # AMORTIZAÃ‡ÃƒO DA DÃVIDA
  `12_amortizacao_divida` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 &
    grupo_despesa_codigo_grupo == 6 &
    modalidade_aplicacao_codigo != 91 &
    !(elemento_despesa_codigo %in% c('76', '77') &
      subfuncao_governo_codigo %in% c('841', '842', '843', '844', '846') &
      fonte_recursos_codigo == '443')
    "
  ),
  
  # ========== RESERVA DE CONTINGÃŠNCIA ==========
  
  # RESERVA DE CONTINGÃŠNCIA
  `13_reserva_contingencia` = list(
    criterio = "
    categoria_economica_despesa_codigo == 9 &
    modalidade_aplicacao_codigo != 91
    "
  ),
  
  # ========== DESPESAS INTRA-ORÃ‡AMENTÃRIAS ==========
  
  # DESPESAS INTRA-ORÃ‡AMENTÃRIAS (X)
  `14_despesas_intra` = list(
    criterio = "modalidade_aplicacao_codigo == 91"
  ),
  
  # DESPESAS CORRENTES INTRA
  `15_despesas_correntes_intra` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    modalidade_aplicacao_codigo == 91
    "
  ),
  
  # PESSOAL E ENCARGOS SOCIAIS INTRA
  `16_pessoal_encargos_sociais_intra` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 1 &
    modalidade_aplicacao_codigo == 91
    "
  ),
  
  # JUROS E ENCARGOS DA DÃVIDA INTRA
  `17_juros_encargos_divida_intra` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 2 &
    modalidade_aplicacao_codigo == 91
    "
  ),
  
  # OUTRAS DESPESAS CORRENTES INTRA
  `18_outras_despesas_correntes_intra` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 3 &
    modalidade_aplicacao_codigo == 91
    "
  ),
  
  # BENEFÃCIOS PREVIDENCIÃRIOS INTRA
  `19_beneficios_previdenciarios_intra` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 3 &
    modalidade_aplicacao_codigo == 91 &
    unidade_orcamentaria_codigo %in% c('55902', '40904', '33904', '25917')
    "
  ),
  
  # DEMAIS DESPESAS CORRENTES INTRA
  `20_demais_despesas_correntes_intra` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 3 &
    modalidade_aplicacao_codigo == 91 &
    !(unidade_orcamentaria_codigo %in% c('55902', '40904', '33904', '25917'))
    "
  ),
  
  # DESPESAS DE CAPITAL INTRA
  `21_despesas_capital_intra` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 &
    modalidade_aplicacao_codigo == 91
    "
  ),
  
  # INVESTIMENTOS INTRA
  `22_investimentos_intra` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 &
    grupo_despesa_codigo_grupo == 4 &
    modalidade_aplicacao_codigo == 91
    "
  ),
  
  # INVERSÃ•ES FINANCEIRAS INTRA
  `23_inversoes_financeiras_intra` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 &
    grupo_despesa_codigo_grupo == 5 &
    modalidade_aplicacao_codigo == 91
    "
  ),
  
  # AMORTIZAÃ‡ÃƒO DA DÃVIDA INTRA
  `24_amortizacao_divida_intra` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 &
    grupo_despesa_codigo_grupo == 6 &
    modalidade_aplicacao_codigo == 91 &
    !(elemento_despesa_codigo %in% c('76', '77') &
      subfuncao_governo_codigo %in% c('841', '842', '843', '844', '846') &
      fonte_recursos_codigo == '443')
    "
  ),
  
  # RESERVA DE CONTINGÃŠNCIA INTRA
  `25_reserva_contingencia_intra` = list(
    criterio = "
    categoria_economica_despesa_codigo == 9 &
    modalidade_aplicacao_codigo == 91
    "
  ),
  
  # ========== SUBTOTAIS ==========
  
  # SUBTOTAL DAS DESPESAS (XI) = (IX + X)
  `26_subtotal_despesas` = list(
    criterio = "
    categoria_economica_despesa_codigo %in% c(3, 4, 9) &
    !(elemento_despesa_codigo %in% c('76', '77') &
      subfuncao_governo_codigo %in% c('841', '842', '843', '844', '846') &
      fonte_recursos_codigo == '443')
    "
  ),
  
  # ========== AMORTIZAÃ‡ÃƒO DA DÃVIDA - REFINANCIAMENTO ==========
  
  # AMORTIZAÃ‡ÃƒO DA DÃVIDA - REFINANCIAMENTO (XII)
  `27_amortizacao_divida_refinanciamento` = list(
    criterio = "
    grupo_despesa_codigo_grupo == 6 &
    elemento_despesa_codigo %in% c('76', '77') &
    subfuncao_governo_codigo %in% c('841', '842', '843', '844', '846') &
    fonte_recursos_codigo == '443'
    "
  ),
  
  # AMORTIZAÃ‡ÃƒO DA DÃVIDA INTERNA
  `28_amortizacao_divida_interna` = list(
    criterio = "
    grupo_despesa_codigo_grupo == 6 &
    elemento_despesa_codigo %in% c('76', '77') &
    subfuncao_governo_codigo %in% c('841', '843', '846') &
    fonte_recursos_codigo == '443'
    "
  ),
  
  # DÃVIDA MOBILIÃRIA
  `29_divida_mobiliaria` = list(
    criterio = "
    grupo_despesa_codigo_grupo == 6 &
    elemento_despesa_codigo == '76' &
    subfuncao_governo_codigo %in% c('841', '843', '846') &
    fonte_recursos_codigo == '443'
    "
  ),
  
  # OUTRAS DÃVIDAS
  `30_outras_dividas` = list(
    criterio = "
    grupo_despesa_codigo_grupo == 6 &
    elemento_despesa_codigo == '77' &
    subfuncao_governo_codigo %in% c('841', '843', '846') &
    fonte_recursos_codigo == '443'
    "
  ),
  
  # AMORTIZAÃ‡ÃƒO DA DÃVIDA EXTERNA
  `31_amortizacao_divida_externa` = list(
    criterio = "
    grupo_despesa_codigo_grupo == 6 &
    elemento_despesa_codigo %in% c('76', '77') &
    subfuncao_governo_codigo %in% c('842', '844') &
    fonte_recursos_codigo == '443'
    "
  ),
  
  # DÃVIDA MOBILIÃRIA (EXTERNA)
  `32_divida_mobiliaria_externa` = list(
    criterio = "
    grupo_despesa_codigo_grupo == 6 &
    elemento_despesa_codigo == '76' &
    subfuncao_governo_codigo %in% c('842', '844') &
    fonte_recursos_codigo == '443'
    "
  ),
  
  # OUTRAS DÃVIDAS (EXTERNA)
  `33_outras_dividas_externa` = list(
    criterio = "
    grupo_despesa_codigo_grupo == 6 &
    elemento_despesa_codigo == '77' &
    subfuncao_governo_codigo %in% c('842', '844') &
    fonte_recursos_codigo == '443'
    "
  ),
  
  # SUBTOTAL COM REFINANCIAMENTO (XIII) = (XI + XII)
  `34_subtotal_com_refinanciamento` = list(
    criterio = "categoria_economica_despesa_codigo %in% c(3, 4, 9)"
  )
)
aplicar_criterios(dados_despesa, criterios_rreo_A01_despesas_bo, group_vars = c( "item_informacao_codigo","item_informacao_nome"))

# bo_depsesa <- (aplicar_criterios(dados_despesa %>% filter(item_informacao_codigo == "25"), criterios_rreo_A01_despesas_bo))
# 
# datatable(bo_depsesa  %>% group_by(ordem, nome) %>% summarise(valor = sum(valor)))%>% formatRound("valor", 2, mark = ".", dec.mark = "," )
# 
# 
# datatable(dados_despesa %>%filter(item_informacao_codigo == 23, tipo_modalidade != "intra") %>% group_by(categoria_economica_despesa_codigo, categoria_economica_despesa_nome, grupo_despesa_codigo_grupo,grupo_despesa_nome , refinanciamento, tipo_modalidade) %>% summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao)))%>% formatRound("saldo_r_item_informacao", 2, mark = ".", dec.mark = "," )
# 
# 
# datatable(dados_despesa %>%filter(item_informacao_codigo == 9, tipo_modalidade != "intra") %>% group_by(categoria_economica_despesa_codigo, categoria_economica_despesa_nome,  refinanciamento, tipo_modalidade) %>% summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao)))%>% formatRound("saldo_r_item_informacao", 2, mark = ".", dec.mark = "," )
```

```{r}
#| eval: !expr executar_relatorio("RREO_A01")
# datatable(dados_despesa %>% filter(mes_lancamento == mes_filtro, tipo_modalidade != "intra", item_informacao_nome == "DESPESAS PAGAS") %>% group_by(refinanciamento, grupo_despesa_codigo_grupo, grupo_despesa_nome) %>% summarise(despesa_empenhada = sum(saldo_r_item_informacao, na.rm = TRUE) )  %>% adorn_totals("row"), rownames = FALSE,
#   colnames = c("refinanciamento", "Grupo cÃ³digo", "Grupo Nome", "Despesa empenhada"))%>% formatRound("despesa_empenhada", 2, mark = ".", dec.mark = "," )%>% 
#   DT::formatStyle(columns = colnames(.$x$data), fontSize = '75%')
```

VocÃª estava tentando fazer o pivot com dados **nÃ£o agregados**, onde cada combinaÃ§Ã£o de chaves tinha milhares de registros. Agregando primeiro com `sum()`, vocÃª terÃ¡ apenas **12 linhas** (uma para cada combinaÃ§Ã£o Ãºnica).

```{r}
#| eval: !expr executar_relatorio("RREO_A01")
# agrupado_despesa_tipo_modalidade_refinanciamento_categoria_grupo <- c( "tipo_modalidade"  ,"refinanciamento","categoria_economica_despesa_codigo", "categoria_economica_despesa_nome", "grupo_despesa_codigo_grupo", "grupo_despesa_nome")
# 
# 
# dados_agregados <- dados_despesa %>% 
#   filter(mes_lancamento == mes_filtro) %>%
#   group_by(across(all_of(c(agrupado_despesa_tipo_modalidade_refinanciamento_categoria_grupo, "item_informacao_nome")))) %>%
#   summarise(
#     saldo_r_item_informacao = sum(saldo_r_item_informacao, na.rm = TRUE),
#     .groups = "drop"
#   )
# 
# dt_formatada(
#   tabela_pivotada(dados_agregados, agrupado_despesa_tipo_modalidade_refinanciamento_categoria_grupo), 
#   agrupado_despesa_tipo_modalidade_refinanciamento_categoria_grupo
# )
```

### Resultado OrÃ§amentÃ¡rio

```{r}
(formatar_numero (resultado_orcamentario <- as.numeric(df_criterios_rreo_A01_receitas_bo %>% filter(ordem == "85", item_informacao_codigo == "5") %>% summarise(valor= valor))-as.numeric(df_criterios_rreo_A01_despesas_bo %>% filter(ordem == "34", item_informacao_codigo == "25") %>% summarise(valor= valor))) )



df_resultado <- tibble(
  Receita = as.numeric(df_criterios_rreo_A01_receitas_bo %>% 
                        filter(ordem == "85", item_informacao_codigo == "5") %>% 
                        pull(valor)),
  Despesa = as.numeric(df_criterios_rreo_A01_despesas_bo %>% 
                        filter(ordem == "34", item_informacao_codigo == "25") %>% 
                        pull(valor))
) %>%
  mutate(Resultado_Orcamentario = Receita - Despesa) %>%
  pivot_longer(
    cols = everything(),
    names_to = "Tipo",
    values_to = "Valor"
  )

# Exibir com DT::datatable formatado
DT::datatable(
  df_resultado,
  options = list(dom = 't', pageLength = 3),
  rownames = FALSE
) %>%
  DT::formatCurrency("Valor", currency = "R$ ", digits = 2, mark = ".", dec.mark = ",")
```

# ğŸ“‹ RREO Anexo 02 - FunÃ§Ã£o e SubfunÃ§Ã£o

```{r}
#| eval: !expr executar_relatorio("RREO_A02")
datatable(dados_despesa %>% group_by(funcao_governo_codigo, funcao_governo_nome, refinanciamento) %>% filter(item_informacao_codigo == 23) %>% summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao)) %>% adorn_totals() )%>% formatRound("saldo_r_item_informacao", 2, mark = ".", dec.mark = "," )%>% 
  DT::formatStyle(columns = colnames(.$x$data), fontSize = '75%')
```

# ğŸ“‹ RREO Anexo 03 - RCL

```{r}
#| code-fold: true
#| output: false


# ===============================================================================
# CRITÃ‰RIOS PARA RECEITAS - ANEXO 3 RCL
# ===============================================================================

criterios_rreo_A03_rcl_receitas_rcl <- list(
  
  # === RECEITAS CORRENTES POR ORIGEM (01-09) ===
  
  # IMPOSTOS, TAXAS E CONTRIBUIÃ‡Ã•ES DE MELHORIA
  `01  Impostos, Taxas e ContribuiÃ§Ãµes de Melhoria` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 1"
  ),
  
  # RECEITA DE CONTRIBUIÃ‡Ã•ES
  `02  Receita de ContribuiÃ§Ãµes` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 2"
  ),
  
  # RECEITA PATRIMONIAL
  `03  Receita Patrimonial` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 3"
  ),
  
  # RECEITA AGROPECUÃRIA
  `04  Receita AgropecuÃ¡ria` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 4"
  ),
  
  # RECEITA INDUSTRIAL
  `05  Receita Industrial` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 5"
  ),
  
  # RECEITA DE SERVIÃ‡OS
  `06  Receita de ServiÃ§os` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 6"
  ),
  
  # TRANSFERÃŠNCIAS CORRENTES
  `07  TransferÃªncias Correntes` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 7"
  ),
  
  # RECEITAS CORRENTES A CLASSIFICAR
  `08  Receitas Correntes a Classificar` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 8"
  ),
  
  # OUTRAS RECEITAS CORRENTES
  `09  Outras Receitas Correntes` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 9"
  ),
  
  # === ITENS ESPECÃFICOS PARA CÃLCULO DA RCL ===
  
  # TRANSFERÃŠNCIAS CONSTITUCIONAIS E LEGAIS
  `10  TransferÃªncias Constitucionais e Legais` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 7 & (
      grepl('FPE|FPM|CONSTITUCIONAL|LEGAL', natureza_receita_nome, ignore.case = TRUE) |
      grepl('^172[0-9]', natureza_receita_codigo_completo) |
      grepl('^171[0-9]', natureza_receita_codigo_completo)
    )
    "
  ),
  
  # CONTRIB. EMPREGADORES E TRAB. PARA SEG. SOCIAL
  `11  Contrib. Empregadores e Trabalhadores para Seguridade Social` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & fonte_recursos_codigo == '054' & 
    !natureza_receita_codigo_completo %in% c(
      '19900300', '19900310', '19900311', '19900312', '19900313', '19900314',
      '19990300', '19990301', '19990302', '19990303', '19990304'
    )
    "
  ),
  
  # CONTRIB. DO SERVIDOR PARA O PLANO DE PREVIDÃŠNCIA
  `12  Contrib. Plano Seguridade Social do Servidor` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & (
      fonte_recursos_codigo %in% c('055', '056') |
      natureza_receita_codigo_completo == '12150116'
    )
    "
  ),
  
  # COMPENSAÃ‡ÃƒO FINANC. ENTRE REGIMES PREVIDÃŠNCIA
  `13  CompensaÃ§Ã£o Financeira entre Regimes RPPS` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & natureza_receita_codigo_completo %in% c(
      '19900300', '19900310', '19900311', '19900312', '19900313', '19900314',
      '19990300', '19990301', '19990302', '19990303', '19990304'
    )
    "
  ),
  
  # CONTRIB. DOS MILITARES PARA O CUSTEIO DAS PENSÃ•ES
  `14  Contrib. para Custeio PensÃµes Militares` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & (
      grepl('^1210051', natureza_receita_codigo_completo) |
      grepl('^1215041', natureza_receita_codigo_completo) |
      grepl('^121911', natureza_receita_codigo_completo)
    )
    "
  ),
  
  # CONTRIBUIÃ‡Ã•ES PARA PIS/PASEP
  `15  ContribuiÃ§Ã£o para PIS/PASEP` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & (
      (grepl('^1210091|^1212', natureza_receita_codigo_completo) & 
       !fonte_recursos_codigo %in% c('055', '056', '054')) |
      (!grepl('^1210091|^1212', natureza_receita_codigo_completo) & 
       fonte_recursos_codigo %in% c('040', '041'))
    )
    "
  ),
  
  # DEDUÃ‡Ã•ES DAS RECEITAS - CORRIGIDO
  `16  DeduÃ§Ãµes das Receitas` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & (
      (grepl('^1212', natureza_receita_codigo_completo) & fonte_recursos_codigo %in% c('031', '032', '040', '041')) |
      (grepl('^1214', natureza_receita_codigo_completo) & fonte_recursos_codigo == '054') |
      (grepl('^1215', natureza_receita_codigo_completo) & fonte_recursos_codigo %in% c('023', '032', '055', '056')) |
      (grepl('^1219', natureza_receita_codigo_completo) & fonte_recursos_codigo == '054') |
      (grepl('^1911', natureza_receita_codigo_completo) & fonte_recursos_codigo == '054') |
      (grepl('^1922', natureza_receita_codigo_completo) & fonte_recursos_codigo %in% c('040', '054', '056')) |
      (grepl('^1923', natureza_receita_codigo_completo) & fonte_recursos_codigo == '054') |
      (grepl('^1999', natureza_receita_codigo_completo) & fonte_recursos_codigo == '054')
    )
    "
  )
)


aplicar_criterios(rreo_a03_rcl_receitas , criterios_rreo_A03_rcl_receitas_rcl, group_vars = c("item_informacao_codigo"))


```

```{r}
#| code-fold: true
#| output: false
# ===============================================================================
# CRITÃ‰RIOS PARA DESPESAS (DEDUÃ‡Ã•ES) - ANEXO 3 RCL
# ===============================================================================

criterios_rreo_A03_rcl_despesas_rcl <- list(
  
  # TRANSFERÃŠNCIAS CONSTITUCIONAIS E LEGAIS (DESPESAS)
  `17  TransferÃªncias Constitucionais e Legais` = list(
    criterio = "
    
    acao_governo_codigo %in% c('0E36', '00SB') | 
    grepl('^28846090900RX', programa_governo_codigo) | 
    (programa_governo_codigo %in% c('0903', '2030', '2080') & 
     modalidade_aplicacao_codigo %in% c(30, 31, 32, 35, 36, 40, 41, 42, 45, 46) & 
     acao_governo_codigo %in% c('0044', '0045', '0046', '0050', '0051', '00H6', '006M', 
                                '00G6', '0169', '0223', '0369', '0546', '0547', '0999', 
                                '099B', '0A53', '0C03', '0C33', '0E25', '0E36', '00PX', 
                                '00QR', '00S3', '00S7', '00S8', '00SE', '00RX', '00UH'))
    "
  ),
  
  # OUTRAS DEDUÃ‡Ã•ES (DESPESAS)
  `18  Outras DeduÃ§Ãµes` = list(
    criterio = "
    
    acao_governo_codigo %in% c('0E36', '00SB') | 
    grepl('^28846090900RX', programa_governo_codigo) | 
    (programa_governo_codigo %in% c('0903', '2030', '2080') & 
     modalidade_aplicacao_codigo %in% c(30, 31, 32, 35, 36, 40, 41, 42, 45, 46) & 
     acao_governo_codigo %in% c('0044', '0045', '0046', '0050', '0051', '00H6', '006M', 
                                '00G6', '0169', '0223', '0369', '0546', '0547', '0999', 
                                '099B', '0A53', '0C03', '0C33', '0E25', '0E36', '00PX', 
                                '00QR', '00S3', '00S7', '00S8', '00SE', '00RX', '00UH'))
    "
  )
)


criterios_rreo_A03_rcl_rp_cancelado_rcl <- list(
  
 
  
    # RP CANCELADOS DE TRANSFERÃŠNCIAS CONSTITUCIONAIS E LEGAIS
  `19 RP Cancelados de TransferÃªncias Constitucionais e Legais` = list(
    criterio = "
    
    # CONDIÃ‡ÃƒO 1: AÃ§Ãµes especÃ­ficas visualizadas no print
    acao_governo_codigo %in% c('0044', '0045', '006M', '0A53', '0C33') |
    
    # CONDIÃ‡ÃƒO 2: Programa que comeÃ§a com cÃ³digo especÃ­fico (do SQL original)
    grepl('^28846090900RX', programa_governo_codigo) |
    
    # CONDIÃ‡ÃƒO 3: CombinaÃ§Ã£o de critÃ©rios do SQL original
    (programa_governo_codigo %in% c('0903', '2030', '2080') & 
     modalidade_aplicacao_codigo %in% c(30, 31, 32, 35, 36, 40, 41, 42, 45, 46) & 
     acao_governo_codigo %in% c('0044', '0045', '0046', '0050', '0051', '00H6', '006M', 
                                '00G6', '0169', '0223', '0369', '0546', '0547', '0999', 
                                '099B', '0A53', '0C03', '0C33', '0E25', '0E36', '00PX', 
                                '00QR', '00S3', '00S7', '00S8', '00SE', '00RX', '00UH'))
    "
)

)



aplicar_criterios(df = rreo_a03_rcl_despesas , criterios_rreo_A03_rcl_despesas_rcl, group_vars = c("item_informacao_codigo"))



aplicar_criterios(df = rreo_a03_rcl_despesas, criterios_rreo_A03_rcl_rp_cancelado_rcl, group_vars = c("item_informacao_codigo"))
```

```{r}
#| eval: !expr executar_relatorio("RREO_A03")

# Extrair ano e mÃªs do mes_filtro
ano_filtro <- as.integer(substr(mes_filtro, 1, 4))  # 2025
mes_ref <- as.integer(substr(mes_filtro, 5, 6))     # 10

rcl <- rbind(df_criterios_rreo_A03_rcl_receitas_rcl ,df_criterios_rreo_A03_rcl_despesas_rcl%>% filter(item_informacao_codigo == "25"))

rcl <- rbind(rcl,df_criterios_rreo_A03_rcl_rp_cancelado_rcl%>% filter(item_informacao_codigo == "51"))

rcl <- rcl   %>%
  mutate(
    tipo =
      case_when(
        ordem %in% c("01" , "02", "03", "04", "05", "06", "07", "08" , "09") ~ "receitas",
        ordem %in% c( "11" , "12", "13", "14", "15", "17" ) ~ "deducoes",
        ordem == "19" ~ "rp_cancelado",
        .default = "demais"
        
        )
  )


# minimo_saude <- (rcl%>%
#   filter(
#     year(data_lancamento) == year(ym(mes_filtro))
#   )  %>% group_by( tipo) %>% summarise(valor = sum(valor))  %>% pivot_wider(names_from = tipo, values_from = valor, values_fill = 0 ) %>% mutate(resultado = receitas - deducoes + rp_cancelado ) )$resultado* 0.15

rcl_12_meses <- rcl %>% 
  filter(
    ym(mes_filtro)-months(11)< data_lancamento &
     data_lancamento < ym(mes_filtro) +  months(1)
      )  %>% group_by( tipo, data_lancamento) %>% summarise(valor = sum(valor))  %>% pivot_wider(names_from = tipo, values_from = valor, values_fill = 0 ) %>% mutate(resultado = receitas - deducoes + rp_cancelado ) 


formatar_real <- function(valor, decimais = 2, prefixo = "R$ ") {
  paste0(prefixo, 
         format(valor, 
                big.mark = ".",
                decimal.mark = ",",
                nsmall = decimais,
                scientific = FALSE))
}


minimo_saude <- sum((rcl_12_meses %>% filter(year(data_lancamento) == year(ym(mes_filtro))))$resultado* 0.15)

# Uso
formatar_real(sum(rcl_12_meses$resultado))



formatar_real(minimo_saude)

```

------------------------------------------------------------------------

# ğŸ“‹ RREO Anexo 04 PrevidÃªncia

O **Anexo 04** apresenta o demonstrativo das receitas e despesas previdenciÃ¡rias do Governo Federal, segregado em trÃªs sistemas:

## ğŸ›ï¸ REGIME GERAL DE PREVIDÃŠNCIA SOCIAL (RGPS)

### ğŸ’° CritÃ©rios de Receitas RGPS

```{r criterios-receitas-rgps}
#| eval: !expr executar_relatorio("RREO_A04")
#| include: false

criterios_rreo_A04_rgps_receitas_rgps <- list(
  
  # RECEITAS CORRENTES - DOS EMPREGADORES, TRABALHADORES E DEMAIS SEGURADOS
  `01  Receitas Correntes - Dos Empregadores, Trabalhadores e Demais Segurados` = list(
    criterio = "natureza_receita_codigo_completo %in% c('12100311', '12100312', '12100313', '12100311') & nre2_origem_receita_codigo_origem %in% c(2) | startsWith(natureza_receita_codigo_completo, '1214') "
  ),
  
  # RECEITAS CORRENTES - DEMAIS CONTRIBUIÃ‡Ã•ES  
  `02  Receitas Correntes - Demais ContribuiÃ§Ãµes` = list(
    criterio = "nre2_origem_receita_codigo_origem %in% c(2) & natureza_receita_codigo_completo %notin% c('12100311', '12100312', '12100313')"
  ),
  
  # OUTRAS RECEITAS CORRENTES - COMPENSAÃ‡ÃƒO PREVIDENCIÃRIA RPPS/RGPS
  `03  Outras Receitas Correntes - CompensaÃ§Ã£o PrevidenciÃ¡ria RPPS/RGPS` = list(
    criterio = "nre2_origem_receita_codigo_origem %in% c(9)"
  ),
  
  # DEMAIS RECEITAS CORRENTES
  `04  Demais Receitas Correntes` = list(
    criterio = "nre1_categoria_economica_codigo %in% c(1) & nre2_origem_receita_codigo_origem %notin% c(2,9)"
  ),
  
  # RECEITAS DE CAPITAL - ALIENAÃ‡Ã•ES
  `05  Receitas de Capital - AlienaÃ§Ãµes` = list(
    criterio = "nre2_origem_receita_codigo_origem %in% c(2) & nre1_categoria_economica_codigo %in% c(2)"
  ),
  
  # DEMAIS RECEITAS DE CAPITAL
  `06  Demais Receitas de Capital` = list(
    criterio = "nre1_categoria_economica_codigo %in% c(2) & nre2_origem_receita_codigo_origem %notin% c(2)"
  ),
  
  # RECEITAS INTRA-ORÃ‡AMENTÃRIAS
  `07  Receitas INTRA-ORÃ‡AMENTÃRIAS` = list(
    criterio = "nre1_categoria_economica_codigo %in% c(7, 8)"
  )
)
```

### ğŸ’¸ CritÃ©rios de Despesas RGPS

```{r criterios-despesas-rgps}
#| eval: !expr executar_relatorio("RREO_A04")
#| include: false

criterios_rreo_A04_rgps_despesas_rgps <- list(
  
  # APOSENTADORIAS
  `01  Aposentadorias` = list(
    criterio = "elemento_despesa_codigo %in% c('53', '54') & grupo_despesa_codigo_grupo %in% c(3) & modalidade_aplicacao_codigo %notin% c('91')"
  ),
  
  # PENSÃ•ES
  `02  PensÃµes` = list(
    criterio = "elemento_despesa_codigo %in% c('55', '56') & grupo_despesa_codigo_grupo %in% c(3) & modalidade_aplicacao_codigo %notin% c('91')"
  ),
  
  # OUTROS BENEFÃCIOS
  `03  Outros BenefÃ­cios` = list(
    criterio = "elemento_despesa_codigo %in% c('57', '58') & grupo_despesa_codigo_grupo %in% c(3) & modalidade_aplicacao_codigo %notin% c('91')"
  ),
  
  # COMPENSAÃ‡ÃƒO PREVIDENCIÃRIA DO RGPS PARA O RPPS
  `04  CompensaÃ§Ã£o PrevidenciÃ¡ria do RGPS para o RPPS` = list(
    criterio = "elemento_despesa_codigo %notin% c('57', '58', '53', '54', '55', '56') & acao_governo_codigo %in% c('009W', '0531') & grupo_despesa_codigo_grupo %in% c(3) & modalidade_aplicacao_codigo %notin% c('91')"
  ),
  
  # DEMAIS DESPESAS
  `05  Demais Despesas` = list(
    criterio = "elemento_despesa_codigo %notin% c('57', '58', '53', '54', '55', '56') & acao_governo_codigo %notin% c('009W', '0531') & grupo_despesa_codigo_grupo %in% c(3) & modalidade_aplicacao_codigo %notin% c('91')"
  ),
  
  # A DETALHAR
  `06  A detalhar` = list(
    criterio = "elemento_despesa_codigo %in% c('00') & grupo_despesa_codigo_grupo %in% c(3) & modalidade_aplicacao_codigo %notin% c('91')"
  ),
  
  # DESPESAS PREVIDENCIÃRIAS (INTRA)
  `07  Despesas PrevidenciÃ¡rias (INTRA)` = list(
    criterio = "grupo_despesa_codigo_grupo %in% c(3) & modalidade_aplicacao_codigo %in% c('91') & elemento_despesa_codigo %notin% c('01', '03', '05')"
  )
)


```

### ğŸ“Š Processamento RGPS - Receitas

```{r processar-rgps-receitas}
#| eval: !expr executar_relatorio("RREO_A04")
#| include: false

(aplicar_criterios(df = dados_receita %>% 
    filter(
      unidade_orcamentaria_codigo %in% c(33904, 40904, 55902, 25917) | 
      natureza_receita_codigo_completo == 79900211), criterios_rreo_A04_rgps_receitas_rgps))




```

### ğŸ“Š Processamento RGPS - Despesas

```{r processar-rgps-despesas}
#| eval: !expr executar_relatorio("RREO_A04")

(aplicar_criterios(df = dados_despesa %>% 
    filter(unidade_orcamentaria_codigo %in% c(33904, 40904, 55902, 25917)), criterios_rreo_A04_rgps_despesas_rgps))


 
```

### Resultado RGPS

```{r}
df_resultado_rgps <- tibble(
  Receita_RGPS = aplicar_criterios(
    df = dados_receita %>%
      filter(
        unidade_orcamentaria_codigo %in% c(33904, 40904, 55902, 25917) |
        natureza_receita_codigo_completo == 79900211,
        item_informacao_codigo %in% c(5)
      ), 
    criterios_rreo_A04_rgps_receitas_rgps
  ) %>% 
    filter(ordem != "02") %>% 
    summarise(valor = sum(valor)) %>% 
    pull(valor),
  
  Despesa_RGPS = aplicar_criterios(
    df = dados_despesa %>%
      filter(
        unidade_orcamentaria_codigo %in% c(33904, 40904, 55902, 25917),
        item_informacao_codigo %in% c(25)
      ), 
    criterios_rreo_A04_rgps_despesas_rgps
  ) %>% 
    summarise(valor = sum(valor)) %>% 
    pull(valor)
) %>%
  mutate(Resultado_RGPS = Receita_RGPS - Despesa_RGPS) %>%
  pivot_longer(
    cols = everything(),
    names_to = "Tipo",
    values_to = "Valor"
  )

# Exibir com DT::datatable formatado
DT::datatable(
  df_resultado_rgps,
  options = list(dom = 't', pageLength = 3),
  rownames = FALSE
) %>%
  DT::formatCurrency("Valor", currency = "R$ ", digits = 2, mark = ".", dec.mark = ",")
```

## ğŸ‘¥ REGIME PRÃ“PRIO DE PREVIDÃŠNCIA SOCIAL (RPPS)

### ğŸ’° CritÃ©rios de Receitas RPPS

```{r criterios-receitas-rpps}
#| eval: !expr executar_relatorio("RREO_A04")
criterios_rreo_A04_rpps_receitas_civil_militar_rpps <- list(
  
 # CIVIS - RECEITA SEGURADOS - Ativo (CORRIGIDO)
`01  CIVIS - RECEITA SEGURADOS - Ativo` = list(
  criterio = "fonte_recursos_codigo %notin% c('00', '000') & (natureza_receita_codigo_completo %in% c('12100423', '12100421', '12100422', '12100424', '12100461', '12100462', '12100463', '12100464') | startsWith(natureza_receita_codigo_completo, '1215011') | startsWith(natureza_receita_codigo_completo, '1215014') | startsWith(natureza_receita_codigo_completo, '121503'))"
),

# CIVIS - RECEITA SEGURADOS - Inativos (CORRIGIDO)
`02  CIVIS - RECEITA SEGURADOS - Inativos` = list(
  criterio = "fonte_recursos_codigo %notin% c('00', '000') & (natureza_receita_codigo_completo %in% c('12100431', '12100433', '12100432', '12100434', '12100471') | startsWith(natureza_receita_codigo_completo, '1215012') | startsWith(natureza_receita_codigo_completo, '1215015'))"
),

# CIVIS - RECEITAS SEGURADOS - Pensionistas (CORRIGIDO) 
`03  CIVIS - RECEITAS SEGURADOS - Pensionistas` = list(
  criterio = "fonte_recursos_codigo %notin% c('00', '000') & (natureza_receita_codigo_completo %in% c('12100481', '12100441', '12100442', '12100443', '12100444') | startsWith(natureza_receita_codigo_completo, '1215013') | startsWith(natureza_receita_codigo_completo, '1215016'))"
),

# CIVIS - RECEITA PATRONAL - Ativo (CORRIGIDO)
`04  CIVIS - RECEITA PATRONAL - Ativo` = list(
  criterio = "fonte_recursos_codigo %notin% c('00', '000') & (natureza_receita_codigo_completo %in% c('12100411', '12100413', '12100412', '12100414', '72100411', '72100413', '72100414', '72100451', '72100452', '12100452', '12100453', '12100454') | startsWith(natureza_receita_codigo_completo, '121502') | startsWith(natureza_receita_codigo_completo, '721502'))"
),

# CIVIS - RECEITA PATRONAL - Inativos e Pensionistas (JÃ CORRETO)
`05  CIVIS - RECEITA PATRONAL - Inativos e Pensionistas - vinculada` = list(
  criterio = "fonte_recursos_codigo %notin% c('00', '000') & natureza_receita_codigo_completo %in% c('72100441')"
),
  
  # DRU - FCDF
  `06  DRU - FCDF` = list(
    criterio = "fonte_recursos_codigo %in% c('000', '00') & endsWith(fonte_recursos_detalhada_codigo, '980001') & startsWith(natureza_receita_codigo_completo, '12151')"
  ),
  
  # MILITARES - RECEITAS - Segurados
  `07  MILITARES - RECEITAS - Segurados` = list(
    criterio = "fonte_recursos_codigo %notin% c('00', '000') & 
(natureza_receita_codigo_completo %in% c('12100511', '12100512', '12100513', '12105141', '12150411', '12150412', '12150421', '12150043', '12150044') | 
startsWith(natureza_receita_codigo_completo, '121911'))"
  )
  
  # # Total das Receitas RPPS
  # `08  Total das Receitas RPPS` = list(
  #   criterio = "unidade_orcamentaria_codigo %notin% c('33904', '40904') & fonte_recursos_codigo %notin% c('54', '00', '000', '054') & (grepl('PENSOES MILIT|PENS.MIL|RPPS|CPSS|CIV', natureza_receita_nome, ignore.case = TRUE) | startsWith(natureza_receita_codigo_completo, '1215') | startsWith(natureza_receita_codigo_completo, '7215'))"
  # )
)
```

### ğŸ’¸ CritÃ©rios de Despesas RPPS

```{r criterios-despesas-rpps}
#| eval: !expr executar_relatorio("RREO_A04")
criterios_rreo_A04_rpps_despesas_civil_militar_rpps <- list(
  
  # CIVIS - DESPESAS - A detalhar
  `01  CIVIS - DESPESAS - A detalhar` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845') & grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %in% c('00') & acao_governo_codigo %in% c('0053', '0181') & funcao_governo_codigo %notin% c('10', '08')"
  ),
  
  # CIVIS - DESPESAS - Aposentadorias
  `02  CIVIS - DESPESAS - Aposentadorias` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845') & grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %in% c('01') & acao_governo_codigo %in% c('0053', '0181')"
  ),
  
  # CIVIS - DESPESAS - PensÃµes
  `03  CIVIS - DESPESAS - PensÃµes` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845') & grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %in% c('03') & acao_governo_codigo %in% c('0053', '0181')"
  ),
  
  # CIVIS - DESPESAS - Outros BenefÃ­cios PrevidenciÃ¡rios
  `04  CIVIS - DESPESAS - Outros BenefÃ­cios PrevidenciÃ¡rios` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845', '846') & grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %notin% c('00', '01', '03') & (acao_governo_codigo %in% c('0053', '0181', '0005', '0625') & funcao_governo_codigo %notin% c('10', '08') | acao_governo_codigo %in% c('0397'))"
  ),
  
  # MILITARES - DESPESAS - A Detalhar PensÃµes
  `05  MILITARES - DESPESAS - A Detalhar PensÃµes` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845') & grupo_despesa_codigo_grupo %in% c(1) & acao_governo_codigo %in% c('0179', '000Q') & elemento_despesa_codigo %in% c('00')"
  ),
  
  # MILITARES - DESPESAS - PensÃµes
  `06  MILITARES - DESPESAS - PensÃµes` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845', '846') & grupo_despesa_codigo_grupo %in% c(1) & acao_governo_codigo %in% c('0179', '00QD') & elemento_despesa_codigo %in% c('03')"
  ),
  
  # MILITARES - DESPESAS - Outros BenefÃ­cios Pensionistas
  `07  MILITARES - DESPESAS - Outros BenefÃ­cios Pensionistas` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(2) & acao_governo_codigo %in% c('214H', '218K', '0179', '00QD') & elemento_despesa_codigo %notin% c('00', '01', '03') & grupo_despesa_codigo_grupo %in% c(1)"
  ),
  
  
    # MILITARES - DESPESAS - A Detalhar Inativos
  `08  MILITARES - DESPESAS - A Detalhar Inativos` = list(
    criterio = "grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %in% c('00') & acao_governo_codigo %in% c('214H', '218K')"
  ),
  
  # MILITARES - DESPESAS - Inativos
  `09  MILITARES - DESPESAS - Inativos` = list(
    criterio = "grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %in% c('01') & acao_governo_codigo %in% c('214H', '218K')"
  ),
  

  
   # MILITARES - DESPESAS - Outros Outros BenefÃ­cios Inativos
  `10  MILITARES - DESPESAS - Outros Outros BenefÃ­cios Inativos` = list(
    criterio = "grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %notin% c( '00', '01') & acao_governo_codigo %in% c('214H', '218K')"
  )
)
```

### ğŸ“Š Processamento RPPS - Receitas

```{r processar-rpps-receitas}
#| eval: !expr executar_relatorio("RREO_A04")

datatable(aplicar_criterios(df = dados_receita %>% 
    filter(
      unidade_orcamentaria_codigo %notin% c(73901),
      fonte_recursos_codigo %notin% c('054')
    ), criterios_rreo_A04_rpps_receitas_civil_militar_rpps))




```

verificar linha 08 Total das Receitas RPPS.

### ğŸ“Š Processamento RPPS - Despesas

```{r processar-rpps-despesas}
#| eval: !expr executar_relatorio("RREO_A04")
#| include: false
# Processar despesas RPPS



datatable(aplicar_criterios(df = dados_despesa %>% 
    filter(
      unidade_orcamentaria_codigo %notin% c(73901),
      elemento_despesa_codigo %notin% c('04', '07', '11', '13', '16', '39', '67', '96'),
      acao_governo_codigo != '09HB'
    ), criterios_rreo_A04_rpps_despesas_civil_militar_rpps))




```

### Resultado RPPS

```{r resultado_rpps}
formatar_numero(resultado_rpps <- (
  aplicar_criterios(df = dados_receita %>% 
    filter(
      unidade_orcamentaria_codigo %notin% c(73901),
      fonte_recursos_codigo %notin% c('054'),
           item_informacao_codigo %in% c(5)
    ), criterios_rreo_A04_rpps_receitas_civil_militar_rpps)%>% summarise(valor=sum(valor))
  -
  aplicar_criterios(df = dados_despesa %>% 
    filter(
      unidade_orcamentaria_codigo %notin% c(73901),
      elemento_despesa_codigo %notin% c('04', '07', '11', '13', '16', '39', '67', '96'),
      acao_governo_codigo != '09HB',
           item_informacao_codigo %in% c(25)
    ), criterios_rreo_A04_rpps_despesas_civil_militar_rpps)%>% summarise(valor=sum(valor))
))
```

## ğŸ›ï¸ REGIME PRÃ“PRIO DE PREVIDÃŠNCIA SOCIAL - FCDF

### ğŸ’° CritÃ©rios de Receitas FCDF

```{r criterios-receitas-fcdf}
#| eval: !expr executar_relatorio("RREO_A04")
#| include: false
criterios_rreo_A04_rpps_receitas_fcdf<- list(
  
  # FCDF - RECEITA SEGURADOS - Ativo
  `01  FCDF - RECEITA SEGURADOS - Ativo` = list(
    criterio = "fonte_recursos_codigo %notin% c('00', '000') & (natureza_receita_codigo_completo %in% c('12100431', '12104211', '12104221', '12104231', '12104411', '12104421', '12104431', '12104611', '12104621', '12104631', '12191111', '12191321', '12191411') | startsWith(natureza_receita_codigo_completo, '121503') | startsWith(natureza_receita_codigo_completo, '1215011') | startsWith(natureza_receita_codigo_completo, '1215014'))"
  ),
  
  # FCDF - RECEITA SEGURADOS - Inativos
  `02  FCDF - RECEITA SEGURADOS - Inativos` = list(
    criterio = "fonte_recursos_codigo %notin% c('00', '000') & (natureza_receita_codigo_completo %in% c('12104311', '12104321', '12104331', '12104341', '12104711') | startsWith(natureza_receita_codigo_completo, '1215012') | startsWith(natureza_receita_codigo_completo, '1215015'))"
  ),
  
  # FCDF - RECEITAS SEGURADOS - Pensionistas
  `03  FCDF - RECEITAS SEGURADOS - Pensionistas` = list(
    criterio = "fonte_recursos_codigo %notin% c('00', '000') & (natureza_receita_codigo_completo %in% c('12104811', '12104411', '12104421', '12104431', '12104441', '12105121', '12105131') | startsWith(natureza_receita_codigo_completo, '1215013') | startsWith(natureza_receita_codigo_completo, '1215016'))"
  ),
  
  # FCDF - RECEITA PATRONAL - Ativo
  `04  FCDF - RECEITA PATRONAL - Ativo` = list(
    criterio = "fonte_recursos_codigo %notin% c('00', '000') & (natureza_receita_codigo_completo %in% c('12104111', '12104131', '12104121', '12104141', '72104111', '72104121', '72104131', '72104141', '72104511', '72104521', '72104531', '72104541') | startsWith(natureza_receita_codigo_completo, '121502') | startsWith(natureza_receita_codigo_completo, '721502'))"
  ),
  
  # FCDF - RECEITA PATRONAL - Inativos e Pensionistas - vinculada
  `05  FCDF - RECEITA PATRONAL - Inativos e Pensionistas - vinculada` = list(
    criterio = "fonte_recursos_codigo %notin% c('00', '000') & natureza_receita_codigo_completo %in% c('72104411', '12150211')"
  ),
  
  # DRU - FCDF
  `06  DRU - FCDF` = list(
    criterio = "fonte_recursos_codigo %in% c('00', '000') & (natureza_receita_codigo_completo %in% c('12104811', '12104411', '12104421', '12104431', '12104441', '12105111', '12104211', '12104221', '12104231', '12104311', '12104321', '12104331', '12104341', '12104521', '12104531', '12104621', '12104631', '12104721', '12104731', '12104741', '12104831', '12104841') | startsWith(natureza_receita_codigo_completo, '1215') | startsWith(natureza_receita_codigo_completo, '7215'))"
  ),
  
  # Total de Receitas RPPS FCDF
  `07  Total de Receitas RPPS FCDF` = list(
    criterio = "unidade_orcamentaria_codigo %notin% c('55902', '33904') & fonte_recursos_codigo %notin% c('54', '054') & fonte_recursos_detalhada_codigo %notin% c('010073910') & fonte_recursos_codigo %in% c('23', '56', '023', '056', '024') & (grepl('PENSI|PENSO|RPPS|CPSS', natureza_receita_nome, ignore.case = TRUE))"
  )
)
```

### ğŸ’¸ CritÃ©rios de Despesas FCDF

```{r criterios-despesas-fcdf}
#| eval: !expr executar_relatorio("RREO_A04")
#| include: false
criterios_rreo_A04_rpps_despesas_fcdf <- list(
  
  # FCDF - DESPESAS - A detalhar
  `01  FCDF - DESPESAS - A detalhar` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(1, 2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845') & grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %in% c('00') & acao_governo_codigo %in% c('00Q2', '00QN', '00NS')"
  ),
  
  # FCDF - DESPESAS - Aposentadorias
  `02  FCDF - DESPESAS - Aposentadorias` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(1, 2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845') & grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %in% c('01') & acao_governo_codigo %in% c('00Q2', '00QN', '00NS', '0312', '00NR')"
  ),
  
  # FCDF - DESPESAS - PensÃµes
  `03  FCDF - DESPESAS - PensÃµes` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(1, 2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845') & grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %in% c('03') & acao_governo_codigo %in% c('00Q2', '00QN', '00NS', '0312', '00NR')"
  ),
  
  # FCDF - DESPESAS - Outros BenefÃ­cios PrevidenciÃ¡rios
  `04  FCDF - DESPESAS - Outros BenefÃ­cios PrevidenciÃ¡rios` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(1, 2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845', '846') & grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %notin% c('00', '01', '03') & (acao_governo_codigo %in% c('00Q2', '00NS', '00QN') | (acao_governo_codigo %in% c('0005', '0625') & funcao_governo_codigo %notin% c('10', '08')))"
  )
)
```

### ğŸ“Š Processamento FCDF - Receitas

```{r processar-fcdf-receitas}
#| eval: !expr executar_relatorio("RREO_A04")
#| include: false

datatable(aplicar_criterios(df = dados_receita %>% 
    filter(unidade_orcamentaria_codigo %in% c(73901)),
    criterios_rreo_A04_rpps_receitas_fcdf))





```

### ğŸ“Š Processamento FCDF - Despesas

```{r processar-fcdf-despesas}
#| eval: !expr executar_relatorio("RREO_A04")
#| include: false

datatable(aplicar_criterios(df = dados_despesa %>% 
    filter(
      unidade_orcamentaria_codigo %in% c(73901),
      elemento_despesa_codigo %notin% c('04', '07', '11', '13', '16', '39', '67', '96'),
      acao_governo_codigo != '09HB'
    ),
    criterios_rreo_A04_rpps_despesas_fcdf))




```

### Resultado FCDF

```{r}
formatar_numero(resultado_fcdf <- (
  aplicar_criterios(df = dados_receita %>% 
    filter(unidade_orcamentaria_codigo %in% c(73901),
           item_informacao_codigo %in% c(5)),
    criterios_rreo_A04_rpps_receitas_fcdf)%>% summarise(valor=sum(valor))
    -
aplicar_criterios(df = dados_despesa %>% 
    filter(
      unidade_orcamentaria_codigo %in% c(73901),
      elemento_despesa_codigo %notin% c('04', '07', '11', '13', '16', '39', '67', '96'),
      acao_governo_codigo != '09HB',
      item_informacao_codigo %in% c(25)
    ),
    criterios_rreo_A04_rpps_despesas_fcdf)%>% summarise(valor=sum(valor))
))

```

# ğŸ“‹ RREO Anexo 06 (Resultado PrimÃ¡rio)

## Processamento Anexo 06

```{r criterio_anexo_06}
#| eval: !expr executar_relatorio("RREO_A06")

# ===============================================================================
# CRITÃ‰RIOS RREO ANEXO 6 - RESULTADO PRIMÃRIO (AJUSTADO)
# ===============================================================================

# ===============================================================================
# 1. RECEITAS PRIMÃRIAS (dados_receita)
# ===============================================================================
criterios_rreo_A06_receitas_A06 <- list(
  
  # RECEITAS CORRENTES (I) - Total
  `01  RECEITAS CORRENTES (I)` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    item_informacao_codigo == 5
    "
  ),
  
  # IMPOSTOS, TAXAS E CONTRIBUIÃ‡Ã•ES DE MELHORIA (Subitem)
  `02  ___Impostos, Taxas e ContribuiÃ§Ãµes de Melhoria` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 1 & 
    item_informacao_codigo == 5
    "
  ),
  
  # CONTRIBUIÃ‡Ã•ES (Subitem)
  `03  ___ContribuiÃ§Ãµes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 2 & 
    item_informacao_codigo == 5
    "
  ),
  
  # RECEITA PATRIMONIAL (Subitem)
  `04  ___Receita Patrimonial` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3 & 
    item_informacao_codigo == 5
    "
  ),
  
  # APLICAÃ‡Ã•ES FINANCEIRAS (II) - DEDUÃ‡ÃƒO (Sub-subitem)
  `05  ______AplicaÃ§Ãµes Financeiras (II)` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    (natureza_receita_codigo_completo %in% c('13210101', '13210201', '13210301', '13210501') |
     startsWith(natureza_receita_codigo_completo, '1321004') |
     startsWith(natureza_receita_codigo_completo, '1329001')) & 
    item_informacao_codigo == 5
    "
  ),
  
  # OUTRAS RECEITAS PATRIMONIAIS (Sub-subitem)
  `06  ______Outras Receitas Patrimoniais` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3 & 
    !(natureza_receita_codigo_completo %in% c('13210101', '13210201', '13210301', '13210501') |
      startsWith(natureza_receita_codigo_completo, '1321004') |
      startsWith(natureza_receita_codigo_completo, '1329001')) & 
    item_informacao_codigo == 5
    "
  ),
  
  # TRANSFERÃŠNCIAS CORRENTES (Subitem)
  `07  ___TransferÃªncias Correntes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 7 & 
    item_informacao_codigo == 5
    "
  ),
  
  # DEMAIS RECEITAS CORRENTES (Subitem)
  `08  ___Demais Receitas Correntes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    (startsWith(natureza_receita_codigo_completo, '14') |
     startsWith(natureza_receita_codigo_completo, '15') |
     startsWith(natureza_receita_codigo_completo, '16') |
     startsWith(natureza_receita_codigo_completo, '18') |
     startsWith(natureza_receita_codigo_completo, '19')) & 
    item_informacao_codigo == 5
    "
  ),
  
  # OUTRAS RECEITAS FINANCEIRAS (III) - DEDUÃ‡ÃƒO (Sub-subitem)
  `09  ______Outras Receitas Financeiras (III)` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    (natureza_receita_codigo_completo %in% c('16410101', '16410102', '19991101', '19991102', '16410301') |
     startsWith(natureza_receita_codigo_completo, '1922012') |
     startsWith(natureza_receita_codigo_completo, '1990992')) & 
    item_informacao_codigo == 5
    "
  ),
  
  # RECEITAS CORRENTES RESTANTES (Sub-subitem)
  `10  ______Receitas Correntes Restantes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    (startsWith(natureza_receita_codigo_completo, '14') |
     startsWith(natureza_receita_codigo_completo, '15') |
     startsWith(natureza_receita_codigo_completo, '16') |
     startsWith(natureza_receita_codigo_completo, '18') |
     startsWith(natureza_receita_codigo_completo, '19')) & 
    !(natureza_receita_codigo_completo %in% c('16410101', '16410102', '19991101', '19991102', '16410301') |
      startsWith(natureza_receita_codigo_completo, '1922012') |
      startsWith(natureza_receita_codigo_completo, '1990992')) & 
    item_informacao_codigo == 5
    "
  ),
  
  # RECEITAS PRIMÃRIAS CORRENTES (IV) - FÃ“RMULA
  `11  RECEITAS PRIMÃRIAS CORRENTES (IV) = (I - II - III)` = list(
    criterio = "{01 - 05 - 09}"
  ),
  
  # RECEITAS DE CAPITAL (V) - Total
  `12  RECEITAS DE CAPITAL (V)` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    item_informacao_codigo == 5
    "
  ),
  
  # OPERAÃ‡Ã•ES DE CRÃ‰DITO (VI) - DEDUÃ‡ÃƒO (Subitem)
  `13  ___OperaÃ§Ãµes de CrÃ©dito (VI)` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 1 & 
    item_informacao_codigo == 5
    "
  ),
  
  # AMORTIZAÃ‡ÃƒO DE EMPRÃ‰STIMOS (VII) - DEDUÃ‡ÃƒO (Subitem)
  `14  ___AmortizaÃ§Ã£o de EmprÃ©stimos (VII)` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 3 & 
    item_informacao_codigo == 5
    "
  ),
  
  # ALIENAÃ‡Ã•ES DE BENS (Subitem)
  `15  ___AlienaÃ§Ãµes de Bens` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 2 & 
    item_informacao_codigo == 5
    "
  ),
  
  # RECEITAS DE ALIENAÃ‡ÃƒO DE INVESTIMENTOS PERMANENTES (IX) - Sub-subitem
  `16  ______Receitas de AlienaÃ§Ã£o de Investimentos Permanentes (IX)` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 2 & 
    startsWith(natureza_receita_codigo_completo, '2221') & 
    item_informacao_codigo == 5
    "
  ),
  
  # OUTRAS ALIENAÃ‡Ã•ES DE BENS (Sub-subitem)
  `17  ______Outras AlienaÃ§Ãµes de Bens` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 2 & 
    !startsWith(natureza_receita_codigo_completo, '2221') & 
    item_informacao_codigo == 5
    "
  ),
  
  # TRANSFERÃŠNCIAS DE CAPITAL (Subitem)
  `18  ___TransferÃªncias de Capital` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 4 & 
    item_informacao_codigo == 5
    "
  ),
  
  # OUTRAS RECEITAS DE CAPITAL (Subitem)
  `19  ___Outras Receitas de Capital` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem %in% c(5, 6, 7, 8, 9) & 
    item_informacao_codigo == 5
    "
  ),
  
  # OUTRAS RECEITAS DE CAPITAL NÃƒO PRIMÃRIAS (X) - DEDUÃ‡ÃƒO (Sub-subitem)
  `20  ______Outras Receitas de Capital NÃ£o PrimÃ¡rias (X)` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    (startsWith(natureza_receita_codigo_completo, '292') |
     startsWith(natureza_receita_codigo_completo, '293') |
     startsWith(natureza_receita_codigo_completo, '294')) & 
    item_informacao_codigo == 5
    "
  ),
  
  # RECEITAS PRIMÃRIAS DE CAPITAL (XI) - FÃ“RMULA
  `21  RECEITAS PRIMÃRIAS DE CAPITAL (XI) = (V - VI - VII - IX - X)` = list(
    criterio = "{12 - 13 - 14 - 16 - 20}"
  ),
  
  # RECEITA PRIMÃRIA TOTAL (XII) - FÃ“RMULA
  `22  RECEITA PRIMÃRIA TOTAL (XII) = (IV + XI)` = list(
    criterio = "{11 + 21}"
  )
)

# ===============================================================================
# 2. DESPESAS - CATEGORIA/GRUPO (dados_categoria_grupo)
# ===============================================================================
criterios_rreo_A06_despesas_categoria_grupo_A06 <- list(
  
  # DESPESAS CORRENTES (XIII)
  `23  DESPESAS CORRENTES (XIII)` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # PESSOAL E ENCARGOS SOCIAIS (Subitem)
  `24  ___Pessoal e Encargos Sociais` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 & 
    grupo_despesa_codigo_grupo == 1 & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # JUROS E ENCARGOS DA DÃVIDA (XIV) - DEDUÃ‡ÃƒO (Subitem)
  `25  ___Juros e Encargos da DÃ­vida (XIV)` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 & 
    grupo_despesa_codigo_grupo == 2 & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # OUTRAS DESPESAS CORRENTES (Subitem)
  `26  ___Outras Despesas Correntes` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 & 
    grupo_despesa_codigo_grupo == 3 & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # DESPESAS PRIMÃRIAS CORRENTES (XV) - FÃ“RMULA
  `27  DESPESAS PRIMÃRIAS CORRENTES (XV) = (XIII - XIV)` = list(
    criterio = "{23 - 25}"
  ),
  
  # DESPESAS DE CAPITAL (XVI)
  `28  DESPESAS DE CAPITAL (XVI)` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # INVESTIMENTOS (Subitem)
  `29  ___Investimentos` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 & 
    grupo_despesa_codigo_grupo == 4 & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # INVERSÃ•ES FINANCEIRAS (Subitem)
  `30  ___InversÃµes Financeiras` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 & 
    grupo_despesa_codigo_grupo == 5 & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # AMORTIZAÃ‡ÃƒO DA DÃVIDA (XX) - DEDUÃ‡ÃƒO (Subitem)
  `31  ___AmortizaÃ§Ã£o da DÃ­vida (XX)` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 & 
    grupo_despesa_codigo_grupo == 6 & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  )
)

# ===============================================================================
# 3. DESPESAS - NATUREZA DETALHADA (dados_ndd)
# ===============================================================================
criterios_rreo_A06_despesas_natureza_detalhada_A06 <- list(
  
  # TRANSFERÃŠNCIAS CONSTITUCIONAIS E LEGAIS
  `32  ______TransferÃªncias Constitucionais e Legais` = list(
    criterio = "
    (startsWith(natureza_despesa_detalhada_codigo, '333081') | 
     startsWith(natureza_despesa_detalhada_codigo, '334081')) & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # DEMAIS DESPESAS CORRENTES - FÃ“RMULA
  `33  ______Demais Despesas Correntes` = list(
    criterio = "{26 - 32}"
  ),
  
  # CONCESSÃƒO DE EMPRÃ‰STIMOS E FINANCIAMENTOS (XVII)
  `34  ______ConcessÃ£o de EmprÃ©stimos e Financiamentos (XVII)` = list(
    criterio = "
    natureza_despesa_detalhada_codigo %in% c('45909206', '45909208', '45909266') & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # AQUISIÃ‡ÃƒO DE TÃTULOS DE CAPITAL JÃ INTEGRALIZADO (XVIII)
  `35  ______AquisiÃ§Ã£o de TÃ­tulos de Capital jÃ¡ Integralizado (XVIII)` = list(
    criterio = "
    natureza_despesa_detalhada_codigo %in% c('45919206', '45919208') & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # DEMAIS INVERSÃ•ES FINANCEIRAS - FÃ“RMULA
  `36  ______Demais InversÃµes Financeiras` = list(
    criterio = "{30 - 34 - 35}"
  ),
  
  # SUBSÃDIOS (METODOLOGIA CESEF)
  `37  ______SubsÃ­dios (metodologia CESEF - financeiro primÃ¡rio)` = list(
    criterio = "
    acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                              '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                              '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # COTAS DOS FUNDOS GARANTIDORES
  `38  ______Cotas dos Fundos Garantidores (metodologia CESEF - primÃ¡rio)` = list(
    criterio = "
    natureza_despesa_detalhada_codigo == '45919266' & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  )
)

# ===============================================================================
# 4. DISPONIBILIDADES (tg_RPN_disponibilidades)
# ===============================================================================
criterios_rreo_A06_disponibilidades_A06 <- list(
  
  # DISPONIBILIDADES - RECURSOS A CLASSIFICAR
  `39  Disponibilidades - Recursos a Classificar` = list(
    criterio = "
    fonte_recursos_codigo %in% c('77', '490') & 
    orgao_uge_tipo_administracao_codigo != 7
    "
  ),
  
  # DISPONIBILIDADES - RECURSOS DIVERSOS
  `40  Disponibilidades - Recursos Diversos` = list(
    criterio = "
    fonte_recursos_codigo %in% c('90', '491') & 
    orgao_uge_tipo_administracao_codigo != 7
    "
  )
)

# ===============================================================================
# 5. JUROS ATIVOS E PASSIVOS (dados_juros)
# ===============================================================================
criterios_rreo_A06_juros_ativos_passivos_A06 <- list(
  
  # JUROS ATIVOS
  `41  Juros Ativos` = list(
    criterio = "
    substr(conta_contabil_numero, 1, 5) %in% c('34111', '34113', '34114', '34115', '34121', '34131', 
                                              '34141', '34181', '34183', '34184', '34185', '34191',
                                              '34211', '34213', '34214', '34215', '34221', '34291') |
    conta_contabil_numero %in% c('445110100', '445210100')
    "
  ),
  
  # JUROS PASSIVOS
  `42  Juros Passivos` = list(
    criterio = "
    substr(conta_contabil_numero, 1, 5) %in% c('44111', '44113', '44114', '44115', '44121', '44131', 
                                              '44133', '44134', '44135', '44141', '44211', '44213', 
                                              '44214', '44215', '44221')
    "
  ),
  
  # FUNDOS - FILTRO ESPECÃFICO PARA JUROS
  `43  Fundos - Juros (Filtro EspecÃ­fico)` = list(
    criterio = "
    orgao_uge_tipo_administracao_codigo == '7' & 
    ug_executora_codigo != '380916' & 
    !orgao_uge_codigo %in% c('25915', '37904')
    "
  )
)
```

```{r processar_resultado_primario}
#| eval: !expr executar_relatorio("RREO_A06")


 # Aplicar critÃ©rios e consolidar em uma Ãºnica operaÃ§Ã£o
rreo_a06_consolidado <- bind_rows(
  aplicar_criterios(
    df = dados_categoria_grupo %>% filter(mes_lancamento == mes_filtro, item_informacao_codigo == "56"),
    criterios = criterios_rreo_A06_despesas_categoria_grupo_A06
  ),
  aplicar_criterios(
    df = dados_receita,
    criterios = criterios_rreo_A06_receitas_A06
  ),
  aplicar_criterios(
    df = dados_ndd %>% filter(item_informacao_codigo == "56"),
    criterios = criterios_rreo_A06_despesas_natureza_detalhada_A06
  ),
  aplicar_criterios(
    df = dados_juros,
    criterios = criterios_rreo_A06_juros_ativos_passivos_A06
  ),
  aplicar_criterios(
    df = tg_RPN_disponibilidades,
    criterios = criterios_rreo_A06_disponibilidades_A06
  )
)

# Agrupar por mes_lancamento, categoria e somar valores
rreo_a06_final <- rreo_a06_consolidado %>%
  group_by(mes_lancamento, categoria) %>%
  summarise(
    valor = sum(valor, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(mes_lancamento, categoria)
  
  

datatable(rreo_a06_final)%>%
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")
 
  


```

# ğŸ“‹ RREO Anexo 07 - Restos a Pagar

## ğŸ“ DescriÃ§Ã£o

Este anexo apresenta os Restos a Pagar classificados por:

-   **Tipo de Modalidade**: Intragovernamental vs Exceto Intragovernamental
-   **Ã“rgÃ£o**: MÃ¡ximo da estrutura organizacional
-   **SituaÃ§Ã£o**: Processados e NÃ£o Processados

## ğŸ¯ Processamento dos Dados

### 

### DefiniÃ§Ã£o dos Agrupamentos

```{r agrupamentos_anexo_07}
#| eval: !expr executar_relatorio("RREO_A07")
#| echo: true

# Definir colunas de agrupamento
agrupado_despesa_tipo_modalidade_orgao <- c(
  "tipo_modalidade", 
  "orgao_uge_orgao_maximo_codigo", 
  "orgao_uge_orgao_maximo_nome"
)

print("âœ… Agrupamentos definidos:")
print(agrupado_despesa_tipo_modalidade_orgao)
```

## ğŸ“ˆ Tabela Principal - Restos a Pagar por Modalidade e Ã“rgÃ£o

```{r tabela_anexo_07}
#| eval: !expr executar_relatorio("RREO_A07")
#| echo: true

# Processar e exibir tabela principal usando funÃ§Ãµes centralizadas
dt_formatada(
  tabela_pivotada(dados_rp_anexo_07 %>% filter(mes_lancamento == mes_filtro), agrupado_despesa_tipo_modalidade_orgao), 
  agrupado_despesa_tipo_modalidade_orgao
)
```

# ğŸ“‹ RREO Anexo 08 - MDE {#sec-anexo-08}

## ğŸ“ DescriÃ§Ã£o

Este anexo apresenta as **Receitas e Despesas com ManutenÃ§Ã£o e Desenvolvimento do Ensino (MDE)**, incluindo:

-   ğŸ“Š **ClassificaÃ§Ã£o por categoria** conforme critÃ©rios especÃ­ficos
-   ğŸ’° **CÃ¡lculo da RLI** (Receita LÃ­quida de Impostos)
-   ğŸ¯ **Percentual de aplicaÃ§Ã£o** em MDE
-   ğŸ“‹ **AnÃ¡lise de transferÃªncias constitucionais**

## ğŸ¯ DefiniÃ§Ã£o dos CritÃ©rios

### CritÃ©rios de EducaÃ§Ã£o

```{r criterios_educacao}
#| eval: !expr executar_relatorio("RREO_A08")
#| echo: true
#| include: false

# Definir a lista de critÃ©rios para classificaÃ§Ã£o das despesas MDE
criterios_rreo_A08_mde_despesas <- list(
  `01 - COMPLEMENTAÃ‡ÃƒO DA UNIÃƒO AO FUNDEB` = list(
    criterio = "acao_governo_codigo %in% c('00SB', '0E36')"
  ),
  `03 - EDUCAÃ‡ÃƒO BÃSICA` = list(
    criterio = "fonte_recursos_codigo %notin% c('008', '035', '133', '134', '213', '242') & iduso_codigo == 8 & elemento_despesa_codigo %notin% c('01', '03', '59') & subfuncao_governo_codigo == '368'"
  ),
  `04 - ENSINO SUPERIOR` = list(
    criterio = "fonte_recursos_codigo %notin% c('008', '035', '133', '134', '213', '242') & iduso_codigo == 8 & elemento_despesa_codigo %notin% c('01', '03', '59') & subfuncao_governo_codigo %in% c('364')"
  ),
  `05 - ENSINO PROFISSIONAL NÃƒO INTEGRADO AO ENSINO REGULAR` = list(
    criterio = "fonte_recursos_codigo %notin% c('008', '035', '133', '134') & iduso_codigo == 8 & elemento_despesa_codigo %notin% c('01', '03', '59') & subfuncao_governo_codigo == '363'"
  ),
  `06 - OUTRAS` = list(
    criterio = "fonte_recursos_codigo %notin% c('008', '035', '133', '134') & iduso_codigo == 8 & elemento_despesa_codigo %notin% c('01', '03', '59') & !subfuncao_governo_codigo %in% c('363', '364', '368') & acao_governo_codigo %notin% c('00SB', '0E36')"
  ),
  `08 - COMPLEMENTAÃ‡ÃƒO DA UNIÃƒO - VAAF` = list(
    criterio = "acao_governo_codigo %in% c('00SB', '0E36')  & plano_orcamentario_codigo_po == '0001'"
  ),
  `09 - COMPLEMENTAÃ‡ÃƒO DA UNIÃƒO - VAAT` = list(
    criterio = "acao_governo_codigo %in% c('00SB', '0E36') & plano_orcamentario_codigo_po %in% c('0002')  & plano_orcamentario_codigo_po %in% c('0003', '0004') & funcao_governo_codigo == '12' & subfuncao_governo_codigo == '847' & programa_governo_codigo == 5111 & acao_governo_codigo == '00SB' & unidade_orcamentaria_codigo == '26298' "
  ),
  `09b - VAAT po 26298 12 847 5111 00SB 0003` = list(
    criterio = "fonte_recursos_codigo %notin% c('008') & plano_orcamentario_codigo_po %in% c('0003') & funcao_governo_codigo == '12' & subfuncao_governo_codigo == '847' & programa_governo_codigo == 5111 & acao_governo_codigo == '00SB' & unidade_orcamentaria_codigo == '26298'"
  ),
  `11 - DESPESAS CUSTEADAS COM A CONTRIBUIÃ‡ÃƒO SOCIAL DO SALÃRIO-EDUCAÃ‡ÃƒO` = list(
    criterio = "fonte_recursos_codigo %in% c('133', '134', '213', '008', '035', '212') & iduso_codigo == 8 & acao_governo_codigo %notin% c('00SB', '0E36')"
  ),
  `12 - DESPESAS COM O FUNDO CONSTITUCIONAL DO DISTRITO FEDERAL - FCDF` = list(
    criterio = "acao_governo_codigo %in% c('0312') & fonte_recursos_codigo %notin% c('133', '134', '213', '008', '035', '212')"
  ),
  `13 - DESPESAS CUSTEADAS COM RECEITAS DE ROYALTIES DE EXPLORAÃ‡ÃƒO DO PRÃ‰-SAL` = list(
    criterio = "fonte_recursos_codigo %in% c('242') & iduso_codigo == 8 & elemento_despesa_codigo %in% c('01', '03', '59')"
  ),
  `14 - DEMAIS DESPESAS COM EDUCAÃ‡ÃƒO` = list(
    criterio = "iduso_codigo == 8 & fonte_recursos_codigo %in% c('008', '035', '133', '134', '213', '050', '000') & elemento_despesa_codigo %in% c('01', '03', '59') & acao_governo_codigo %notin% c('00SB', '0312', '0E36')"
  )
)

datatable(aplicar_criterios(dados_despesa %>% filter(item_informacao_codigo == "25"), criterios_rreo_A08_mde_despesas))%>% formatRound("valor", 2, mark = ".", dec.mark = "," )
```

## ğŸ’° CÃ¡lculo da Receita LÃ­quida de Impostos (RLI)

### Receitas Base para RLI

```{r receitas_rli}
#| eval: !expr executar_relatorio("RREO_A08")
#| echo: true




# Receitas que compÃµem a base da RLI (impostos)
receitas_base_rli <- dados_receita %>% 
  filter(
    item_informacao_codigo == "5",
    startsWith(natureza_receita_codigo_completo, '711') | 
    startsWith(natureza_receita_codigo_completo, "111")
  ) %>% 
  group_by(mes_lancamento) %>% 
  summarise(
    receita = sum(saldo_r_item_informacao, na.rm = TRUE),
    .groups = "drop"
  )


```

### TransferÃªncias Constitucionais

```{r transferencias_anexo_08}
#| eval: !expr executar_relatorio("RREO_A08")
#| echo: true

# Classificar transferÃªncias constitucionais
rli_transf <- dados_despesa %>% 
  filter(item_informacao_codigo == "56") %>% 
  mutate(
    transferencia = case_when(
      acao_governo_codigo == "0044" ~ "FPE",
      acao_governo_codigo == "0045" ~ "FPM", 
      acao_governo_codigo == "0046" ~ "IPI_repasse",
      acao_governo_codigo == "0C33" ~ "FUNDEB",
      acao_governo_codigo == "00H6" ~ "IOF_repasse",
      acao_governo_codigo == "006M" ~ "ITR_repasse",
      .default = "demais"
    )
  ) %>% 
  group_by(transferencia, mes_lancamento) %>%  
  summarise(
    valor_transferencia = sum(saldo_r_item_informacao, na.rm = TRUE),
    .groups = "drop"
  )

# Mostrar transferÃªncias por tipo
transferencias_resumo <- rli_transf %>%
  group_by(transferencia) %>%
  summarise(
    total = sum(valor_transferencia, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(desc(total)) %>%
  mutate(total_formatado = formatar_numero(total))


```

### CÃ¡lculo da RLI Mensal

```{r rli_mensal}
#| eval: !expr executar_relatorio("RREO_A08")
#| echo: true

# Consolidar transferÃªncias (exceto "demais")
transferencias_consolidadas <- rli_transf %>% 
  filter(transferencia != "demais") %>% 
  group_by(mes_lancamento) %>% 
  summarise(
    transferencia_total = sum(valor_transferencia, na.rm = TRUE),
    .groups = "drop"
  )

# Calcular RLI mensal
rli_mensal <- full_join(
  receitas_base_rli, 
  transferencias_consolidadas, 
  by = "mes_lancamento"
) %>%
  mutate(
    transferencia_total = ifelse(is.na(transferencia_total), 0, transferencia_total),
    receita = ifelse(is.na(receita), 0, receita),
    rli = (receita - transferencia_total) * 0.18
  ) %>%
  # Ordenar por mÃªs corretamente
  mutate(
    mes_ordenacao = case_when(
      str_detect(mes_lancamento, "JAN") ~ 1,
      str_detect(mes_lancamento, "FEV") ~ 2,
      str_detect(mes_lancamento, "MAR") ~ 3,
      str_detect(mes_lancamento, "ABR") ~ 4,
      str_detect(mes_lancamento, "MAI") ~ 5,
      str_detect(mes_lancamento, "JUN") ~ 6,
      str_detect(mes_lancamento, "JUL") ~ 7,
      str_detect(mes_lancamento, "AGO") ~ 8,
      str_detect(mes_lancamento, "SET") ~ 9,
      str_detect(mes_lancamento, "OUT") ~ 10,
      str_detect(mes_lancamento, "NOV") ~ 11,
      str_detect(mes_lancamento, "DEZ") ~ 12,
      TRUE ~ 99
    )
  ) %>%
  arrange(mes_ordenacao) %>%
  select(-mes_ordenacao) %>%
  mutate(
    receita_formatada = formatar_numero(receita),
    transferencia_formatada = formatar_numero(transferencia_total),
    rli_formatado = formatar_numero(rli)
  )

# Exibir com DT::datatable
DT::datatable(
  rli_mensal %>% 
    select(mes_lancamento, receita_formatada, transferencia_formatada, rli_formatado),
  colnames = c("MÃªs", "Receita Base", "TransferÃªncias", "RLI (18%)"),
  caption = "ğŸ“Š Receita LÃ­quida de Impostos (RLI) Mensal",
  rownames = FALSE,
  options = list(
    pageLength = 15,
    dom = 'ft',
    columnDefs = list(
      list(className = 'dt-left', targets = "_all")  # Alinhar tudo Ã  esquerda
    ),
    language = list(
      url = '//cdn.datatables.net/plug-ins/1.10.11/i18n/Portuguese.json'
    )
  )
) %>%
  DT::formatStyle(
    columns = c("receita_formatada", "transferencia_formatada", "rli_formatado"),
    textAlign = 'right'  # NÃºmeros Ã  direita
  ) %>%
  DT::formatStyle(
    columns = "mes_lancamento",
    textAlign = 'left',   # MÃªs Ã  esquerda
    fontWeight = 'bold'
  )
```

## ğŸ¯ AplicaÃ§Ã£o MÃ­nima em MDE

### RLI do PerÃ­odo de ReferÃªncia

```{r rli_periodo}
#| eval: !expr executar_relatorio("RREO_A08")
#| echo: true

# RLI especÃ­fica do mÃªs de referÃªncia
rli_atual <- rli_mensal %>% 
  filter(mes_lancamento == mes_filtro) %>% 
  summarise(minimo_mde = sum(rli, na.rm = TRUE)) %>%
  pull(minimo_mde)

print(paste("ğŸ“… RLI para", mes_filtro, ":", formatar_numero(rli_atual)))
```

### Despesas MDE do PerÃ­odo

```{r despesas_mde}
#| eval: !expr executar_relatorio("RREO_A08")

# Despesas MDE das categorias principais (02, 03, 04, 05, 06)
datatable(despesa_mde <- aplicar_criterios(dados_despesa %>% filter(item_informacao_codigo == 25), criterios_rreo_A08_mde_despesas) %>% 
  filter(
    mes_lancamento == mes_filtro,
    ordem %in% c(
      "03",
      "04", 
      "05",
      "06"
    )
  ) %>% 
  summarise(valor = sum(valor, na.rm = TRUE)) )

print(paste("ğŸ’° Despesas MDE principais:", (despesa_mde)))
```

### ComplementaÃ§Ã£o FUNDEB

```{r complementacao_fundeb}
#| eval: !expr executar_relatorio("RREO_A08")
#| echo: true

# ComplementaÃ§Ã£o FUNDEB (30% da complementaÃ§Ã£o da UniÃ£o)
complementacao_fundeb <- dados_despesa %>% 
  filter(
    item_informacao_codigo == 25, 
    mes_lancamento == mes_filtro,
    acao_governo_codigo %in% c('0E36', '00SB')
  ) %>% 
  summarise(comp_fundeb = sum(saldo_r_item_informacao, na.rm = TRUE) * 0.3) %>%
  pull(comp_fundeb)

print(paste("ğŸ¯ ComplementaÃ§Ã£o FUNDEB (30%):", formatar_numero(complementacao_fundeb)))
```

### Restos a Pagar MDE

```{r rp_mde}
#| eval: !expr executar_relatorio("RREO_A08")
#| echo: true

# AJUSTADO: Agrupado por item de informaÃ§Ã£o
despesa_mde_rp_detalhado <- dados_rp_anexo_08 %>%
  filter(
    mes_lancamento == mes_filtro,  
    !elemento_despesa_codigo %in% c('01', '03'),
    (
      (fonte_recursos_codigo %in% c('000', '012', '00', '12') & 
       (iduso_codigo == 8 | lei_calmon_s_n == 'SIM')) |
      (ne_c_cor_ano_emissao >= 2020 & 
       !fonte_recursos_codigo %in% c('133', '134', '213', '08', '13', '93') & 
       iduso_codigo == 8)
    )
  ) %>%
  group_by(item_informacao_codigo, item_informacao_nome) %>%
  summarise(
    valor = sum(saldo_r_item_informacao, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(item_informacao_codigo)

# Total consolidado para cÃ¡lculos
despesa_mde_rp <- sum(despesa_mde_rp_detalhado$valor, na.rm = TRUE)

print("ğŸ“‹ Restos a Pagar MDE por Item de InformaÃ§Ã£o:")
print(despesa_mde_rp_detalhado)
print(paste("ğŸ“‹ Total RP MDE:", formatar_numero(despesa_mde_rp)))
```

## ğŸ“Š CÃ¡lculo do Percentual de AplicaÃ§Ã£o

```{r percentual_aplicacao}
#| eval: !expr executar_relatorio("RREO_A08")
#| echo: true

# CÃ¡lculo do percentual total aplicado em MDE
total_despesas_mde <- despesa_mde + complementacao_fundeb
percentual_aplicacao <- (as.numeric(total_despesas_mde) / as.numeric(rli_atual)) *100

# FunÃ§Ã£o para formatar valores em R$ (com as.numeric para dataframes)
formatar_real <- function(valor) {
  paste0("R$ ", format(as.numeric(valor), big.mark = ".", decimal.mark = ",", scientific = FALSE))
}

# Tabela resumo
resumo_aplicacao <- data.frame(
  Item = c(
    "ğŸ’° Despesas MDE Principais",
    "ğŸ¯ ComplementaÃ§Ã£o FUNDEB (30%)",
    "ğŸ“‹ Restos a Pagar MDE",
    "ğŸ“Š Total Despesas MDE",
    "ğŸ“ˆ 18% da RLI (Base de CÃ¡lculo)",
    "ğŸ¯ Percentual Aplicado"),
  
  Valor = c(
    formatar_real(despesa_mde),
    formatar_real(complementacao_fundeb),
    formatar_real(despesa_mde_rp),
    formatar_real(total_despesas_mde),
    formatar_real(rli_atual),
    paste0(round(as.numeric(percentual_aplicacao), 2), "%")
  ),
  Status = c(
    "âœ… Calculado",
    "âœ… Calculado", 
    "âœ… Calculado",
    "âœ… Consolidado",
    "âœ… Base",
    ifelse(as.numeric(percentual_aplicacao) >= 100, "âœ… Atendido", "âŒ NÃ£o Atendido")
  ),
  stringsAsFactors = FALSE
)


# Renderizar tabela
kable(resumo_aplicacao, 
      caption = "ğŸ¯ Resumo da AplicaÃ§Ã£o em MDE",
      format = "html",
      col.names = c("Item", "Valor", "Status"),
      align = c("l", "r", "c")) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE
  ) %>%
  row_spec(0, bold = TRUE, background = "#f8f9fa") %>%
  row_spec(6, bold = TRUE, 
           background = ifelse(as.numeric(percentual_aplicacao) >= 100, "#d4edda", "#f8d7da"),
           color = ifelse(as.numeric(percentual_aplicacao) >= 100, "#155724", "#721c24")) %>%
  column_spec(2, width = "200px")

# Resultado resumido
cat("\n=== RESULTADO FINAL ===\n")
cat("Total de Despesas MDE: R$", format(as.numeric(total_despesas_mde), big.mark = ".", decimal.mark = ","), "\n")
cat("18% da RLI (Base): R$", format(as.numeric(rli_atual), big.mark = ".", decimal.mark = ","), "\n")
cat("Percentual Aplicado:", round(as.numeric(percentual_aplicacao), 2), "%\n")
cat("SituaÃ§Ã£o:", ifelse(as.numeric(percentual_aplicacao) >= 100, "âœ… ATENDE", "âŒ NÃƒO ATENDE"), "ao mÃ­nimo constitucional\n")
```

# ğŸ“‹ RREO Anexo 09 - Regra de Ouro.

```{r}
# Ler arquivo
dados <- read_excel("data/regra_de_ouro/regra_de_ouro_fabric_atual.xlsx", skip = 5) %>%
  clean_names()

# Filtrar linha da data e agrupar
resultado <- dados %>%
  filter(!grepl("^\\d{2}/\\d{2}/\\d{4}$", grupo_para_regra_de_ouro_tesouro_transparente)) %>%
  group_by(item = grupo_para_regra_de_ouro_tesouro_transparente) %>%
  summarise(
    saldo_abertura = sum(saldo_r_conta_contabil[grepl("000", mes_lancamento)], na.rm = TRUE),
    saldo_mes_atual = sum(saldo_r_conta_contabil[!grepl("000", mes_lancamento)], na.rm = TRUE),
    variacao = saldo_mes_atual - saldo_abertura
  )

# Identificar o mÃªs atual
mes_atual <- dados %>%
  filter(!is.na(mes_lancamento), !grepl("000", mes_lancamento)) %>%
  pull(mes_lancamento) %>%
  first()

# Calcular Regra de Ouro
despesas <- resultado$variacao[resultado$item == "Despesas"]
receitas <- resultado$variacao[resultado$item == "Receitas"]
divida <- resultado$variacao[resultado$item == "Subconta da DÃ­vida"]

regra_ouro <- despesas - (receitas - divida)

# Criar tabela com resultado da Regra de Ouro
regra_ouro_df <- data.frame(
  Indicador = "Regra de Ouro",
  Valor = regra_ouro,
  Status = ifelse(regra_ouro > 0, "NÃƒO CUMPRIDA", "CUMPRIDA")
)

# Exibir tabelas com DT::datatable
datatable(resultado, 
          caption = paste("VariaÃ§Ã£o dos Saldos - MÃªs", mes_atual, "vs Abertura"),
          options = list(pageLength = 10),
          rownames = FALSE) %>%
  formatCurrency(c("saldo_abertura", "saldo_mes_atual", "variacao"), 
                 currency = "R$ ", 
                 digits = 2, 
                 mark = ".", 
                 dec.mark = ",")

datatable(regra_ouro_df,
          caption = paste("Resultado da Regra de Ouro - MÃªs", mes_atual),
          options = list(pageLength = 10, dom = 't'),
          rownames = FALSE) %>%
  formatCurrency("Valor", 
                 currency = "R$ ", 
                 digits = 2, 
                 mark = ".", 
                 dec.mark = ",")


```

# ğŸ“‹ RREO Anexo 11 - AlienaÃ§Ã£o de Ativos.

# ğŸ“‹ RREO Anexo 12 - SaÃºde.

## ğŸ“‹ IntroduÃ§Ã£o

O **Anexo 12 do RREO** apresenta o demonstrativo das receitas e despesas com aÃ§Ãµes e serviÃ§os pÃºblicos de saÃºde do Governo Federal, conforme estabelecido pela Emenda Constitucional nÂº 29/2000 e regulamentado pela Lei Complementar nÂº 141/2012.

Este relatÃ³rio consolida informaÃ§Ãµes sobre: - **Despesas Computadas**: AplicaÃ§Ãµes diretas e transferÃªncias nas subfunÃ§Ãµes especÃ­ficas de saÃºde - **Despesas NÃ£o Computadas**: Despesas do MinistÃ©rio da SaÃºde nÃ£o computadas para o limite constitucional - **AnÃ¡lise por Modalidade**: SeparaÃ§Ã£o entre aplicaÃ§Ã£o direta e transferÃªncias - **Indicadores de Cumprimento**: VerificaÃ§Ã£o do atendimento aos limites constitucionais

## ğŸ¥ Processamento das Despesas com SaÃºde

### 1. Despesas Computadas - SubfunÃ§Ãµes EspecÃ­ficas

```{r despesas-saude-especificas}
#| eval: !expr executar_relatorio("RREO_A12")
#| include: false
# Filtrar despesas das subfunÃ§Ãµes especÃ­ficas de saÃºde (301-306)
despesas_saude <- dados_despesa %>% 
  filter(
    mes_lancamento == mes_filtro, 
    iduso_codigo == 6, 
    item_informacao_codigo == 25, 
    subfuncao_governo_codigo %in% c(301, 302, 303, 304, 305, 306)
  ) %>% 
  group_by(
    subfuncao_governo_codigo, 
    subfuncao_governo_nome, 
    categoria_economica_despesa_codigo,
    categoria_economica_despesa_nome, 
    modalidade_aplicacao_codigo
  ) %>% 
  summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao), .groups = "drop")

# Classificar por tipo de aplicaÃ§Ã£o
despesas_saude <- despesas_saude %>% 
  mutate(
    transferencia = ifelse(
      modalidade_aplicacao_codigo %in% c('30', '31', '32', '35', '36', '40', '41', '42', '45', '46'), 
      "_transferencia", 
      "aplicacao_direta"
    )
  )

# Criar tabela consolidada INCLUINDO LINHAS COM ZERO
tabela_saude_especificas <- despesas_saude %>% 
  group_by(
    subfuncao_governo_codigo, 
    subfuncao_governo_nome,
    categoria_economica_despesa_codigo, 
    categoria_economica_despesa_nome, 
    transferencia
  ) %>% 
  summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao), .groups = "drop") %>%
  # MANTER TODAS AS LINHAS, incluindo as com valor zero
  filter(TRUE)  # NÃ£o filtrar valores zero

# Exibir tabela
DT::datatable(
  tabela_saude_especificas,
  caption = "Despesas com SaÃºde - SubfunÃ§Ãµes EspecÃ­ficas (301-306) - Incluindo Valores Zero",
  options = list(
    pageLength = 20,  # Aumentar para mostrar mais linhas
    scrollX = TRUE,
    language = list(url = '//cdn.datatables.net/plug-ins/1.10.11/i18n/Portuguese-Brasil.json')
  )
) %>%
  DT::formatRound("saldo_r_item_informacao", 2, mark = ".", dec.mark = ",")

# Calcular total das subfunÃ§Ãµes especÃ­ficas
total_subfuncoes_especificas <- sum(despesas_saude$saldo_r_item_informacao)
cat("\nğŸ’° **Total das SubfunÃ§Ãµes EspecÃ­ficas de SaÃºde:** R$", 
    format(total_subfuncoes_especificas, big.mark = ".", decimal.mark = ","), "\n")
```

### 2. Despesas em Outras SubfunÃ§Ãµes (Demais)

```{r despesas-saude-demais}
#| eval: !expr executar_relatorio("RREO_A12")
#| include: false
# Calcular despesas em outras subfunÃ§Ãµes
despesas_saude_demais <- as.numeric(
  dados_despesa %>% 
  filter(
    mes_lancamento == mes_filtro, 
    iduso_codigo == 6, 
    item_informacao_codigo == 25, 
    subfuncao_governo_codigo %notin% c(301, 302, 303, 304, 305, 306)
  ) %>% 
  summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao))
)

cat("ğŸ’° **Total das Demais SubfunÃ§Ãµes de SaÃºde:** R$", 
    format(despesas_saude_demais, big.mark = ".", decimal.mark = ","), "\n")

# Total geral das despesas computadas
total_despesas_computadas <- total_subfuncoes_especificas + despesas_saude_demais
cat("ğŸ’° **Total Geral das Despesas Computadas:** R$", 
    format(total_despesas_computadas, big.mark = ".", decimal.mark = ","), "\n\n")
```

### 3. AnÃ¡lise Consolidada de Todas as Despesas

```{r despesas-saude-consolidada}
#| eval: !expr executar_relatorio("RREO_A12")
#| include: false
# Processar todas as despesas de saÃºde com agrupamento
despesas_saude_completa <- dados_despesa %>% 
  filter(
    mes_lancamento == mes_filtro, 
    iduso_codigo == 6, 
    item_informacao_codigo == 25
  ) %>% 
  group_by(
    subfuncao_governo_codigo, 
    subfuncao_governo_nome, 
    categoria_economica_despesa_codigo,
    categoria_economica_despesa_nome, 
    modalidade_aplicacao_codigo
  ) %>% 
  summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao), .groups = "drop")

# Reclassificar subfunÃ§Ãµes e modalidades
despesas_saude_completa <- despesas_saude_completa %>% 
  mutate(
    subfuncao_governo_codigo = case_when(
      subfuncao_governo_codigo %in% c(301, 302, 303, 304, 305, 306) ~ as.character(subfuncao_governo_codigo),
      TRUE ~ "demais"
    ),
    subfuncao_governo_nome = case_when(
      subfuncao_governo_codigo %in% c("301", "302", "303", "304", "305", "306") ~ subfuncao_governo_nome,
      TRUE ~ "demais"
    ),
    transferencia = ifelse(
      modalidade_aplicacao_codigo %in% c('30', '31', '32', '35', '36', '40', '41', '42', '45', '46'), 
      "_transferencia", 
      "aplicacao_direta"
    )
  )

# Criar tabela consolidada final INCLUINDO VALORES ZERO
tabela_consolidada <- despesas_saude_completa %>% 
  group_by(
    subfuncao_governo_codigo, 
    subfuncao_governo_nome,
    categoria_economica_despesa_codigo, 
    categoria_economica_despesa_nome, 
    transferencia
  ) %>% 
  summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao), .groups = "drop") %>%
  # MANTER TODAS AS LINHAS, incluindo as com valor zero
  arrange(subfuncao_governo_codigo, categoria_economica_despesa_codigo, transferencia)

# Exibir tabela consolidada
DT::datatable(
  tabela_consolidada %>% adorn_totals(),
  caption = "Despesas com SaÃºde - AnÃ¡lise Consolidada (Incluindo Valores Zero)",
  options = list(
    pageLength = 25,  # Aumentar para mostrar mais linhas
    scrollX = TRUE,
    language = list(url = '//cdn.datatables.net/plug-ins/1.10.11/i18n/Portuguese-Brasil.json')
  )
) %>%
  DT::formatRound("saldo_r_item_informacao", 2, mark = ".", dec.mark = ",")

# Total consolidado em milhares
total_consolidado <- sum(despesas_saude_completa$saldo_r_item_informacao) / 1000
cat("\nğŸ’° **Total Consolidado das Despesas com SaÃºde:** R$", 
    format(total_consolidado, big.mark = ".", decimal.mark = ","), "mil\n")
```

## ğŸš« Despesas NÃ£o Computadas

### Despesas do MinistÃ©rio da SaÃºde NÃ£o Computadas

```{r despesas-nao-computadas}
#| eval: !expr executar_relatorio("RREO_A12")
#| include: false
# Filtrar despesas nÃ£o computadas do MinistÃ©rio da SaÃºde
despesa_saude_nao_computadas <- dados_despesa %>% 
  filter(
    mes_lancamento == mes_filtro, 
    iduso_codigo != 6, 
    item_informacao_codigo == 25,
    uo_orgao_superior_codigo == "36000", 
    unidade_orcamentaria_codigo != "74202"
  ) %>% 
  group_by(
    subfuncao_governo_codigo, 
    subfuncao_governo_nome, 
    categoria_economica_despesa_codigo,
    categoria_economica_despesa_nome, 
    modalidade_aplicacao_codigo
  ) %>%  
  summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao), .groups = "drop")

# Reclassificar para anÃ¡lise
despesa_saude_nao_computadas <- despesa_saude_nao_computadas %>% 
  mutate(
    subfuncao_governo_codigo = case_when(
      subfuncao_governo_codigo %in% c(301, 302, 303, 304, 305, 306) ~ as.character(subfuncao_governo_codigo),
      TRUE ~ "demais"
    ),
    subfuncao_governo_nome = case_when(
      subfuncao_governo_codigo %in% c("301", "302", "303", "304", "305", "306") ~ subfuncao_governo_nome,
      TRUE ~ "demais"
    ),
    transferencia = ifelse(
      modalidade_aplicacao_codigo %in% c('30', '31', '32', '35', '36', '40', '41', '42', '45', '46'), 
      "_transferencia", 
      "aplicacao_direta"
    )
  )

# Tabela das despesas nÃ£o computadas INCLUINDO VALORES ZERO
tabela_nao_computadas <- despesa_saude_nao_computadas %>% 
  group_by(
    subfuncao_governo_codigo, 
    subfuncao_governo_nome,
    categoria_economica_despesa_codigo, 
    categoria_economica_despesa_nome, 
    transferencia
  ) %>% 
  summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao), .groups = "drop") %>%
  # MANTER TODAS AS LINHAS, incluindo as com valor zero
  arrange(subfuncao_governo_codigo, categoria_economica_despesa_codigo, transferencia)

# Exibir tabela
DT::datatable(
  tabela_nao_computadas,
  caption = "Despesas do MinistÃ©rio da SaÃºde NÃƒO Computadas para o Limite (Incluindo Valores Zero)",
  options = list(
    pageLength = 20,  # Aumentar para mostrar mais linhas
    scrollX = TRUE,
    language = list(url = '//cdn.datatables.net/plug-ins/1.10.11/i18n/Portuguese-Brasil.json')
  )
) %>%
  DT::formatRound("saldo_r_item_informacao", 2, mark = ".", dec.mark = ",")
```

```{r}
#| eval: !expr executar_relatorio("RREO_A12")


# Calcular total das subfunÃ§Ãµes especÃ­ficas
total_subfuncoes_especificas <- sum(despesas_saude$saldo_r_item_informacao)
cat("\nğŸ’° **Total das SubfunÃ§Ãµes EspecÃ­ficas de SaÃºde:** R$", 
    format(total_subfuncoes_especificas, big.mark = ".", decimal.mark = ","), "\n")

cat("ğŸ’° **Total das Demais SubfunÃ§Ãµes de SaÃºde:** R$", 
    format(despesas_saude_demais, big.mark = ".", decimal.mark = ","), "\n")

# Total geral das despesas computadas
total_despesas_computadas <- total_subfuncoes_especificas + despesas_saude_demais
cat("ğŸ’° **Total Geral das Despesas Computadas:** R$", 
    format(total_despesas_computadas, big.mark = ".", decimal.mark = ","), "\n\n")




# Cumprimento do minimo

cat("\nğŸ’° **Cumprimento do minimo:** ", 
    format(total_despesas_computadas/minimo_saude*100, big.mark = ".", decimal.mark = ",", digits = 4), "%\n")

```

# ğŸ“‹ RREO Tabela 01

## ğŸ’° RECEITAS ORÃ‡AMENTÃRIAS

```{r criterios_receitas}
#| eval: !expr executar_relatorio("RREO_T01")
# ======================================
# CRITÃ‰RIOS DA TABELA 1 - RECEITAS
# ======================================

criterios_rreo_T01_receitas <- list(
  
  # === RECEITAS CORRENTES ===
  
  # Receita TributÃ¡ria
  `01  Receita TributÃ¡ria` = list(
    criterio = "(nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 1) | (nre1_categoria_economica_codigo == 7 & nre2_origem_receita_codigo_origem == 1)"
  ),
  
  # Receita de ContribuiÃ§Ãµes
  `02  Receita de ContribuiÃ§Ãµes` = list(
    criterio = "(nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 2) | (nre1_categoria_economica_codigo == 7 & nre2_origem_receita_codigo_origem == 2)"
  ),
  
  # Receita Patrimonial
  `03  Receita Patrimonial` = list(
    criterio = "(nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 3) | (nre1_categoria_economica_codigo == 7 & nre2_origem_receita_codigo_origem == 3)"
  ),
  
  # Receita AgropecuÃ¡ria
  `04  Receita AgropecuÃ¡ria` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 4"
  ),
  
  # Receita Industrial
  `05  Receita Industrial` = list(
    criterio = "(nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 5) | (nre1_categoria_economica_codigo == 7 & nre2_origem_receita_codigo_origem == 5)"
  ),
  
  # Receita de ServiÃ§os
  `06  Receita de ServiÃ§os` = list(
    criterio = "(nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 6) | (nre1_categoria_economica_codigo == 7 & nre2_origem_receita_codigo_origem == 6)"
  ),
  
  # TransferÃªncias Correntes
  `07  TransferÃªncias Correntes` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 7"
  ),
  
  # Receitas Correntes a Classificar
  `08  Receitas Correntes a Classificar` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 8"
  ),
  
  # Outras Receitas Correntes
  `09  Outras Receitas Correntes` = list(
    criterio = "(nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 9) | (nre1_categoria_economica_codigo == 7 & nre2_origem_receita_codigo_origem == 9)"
  ),
  
  # === RECEITAS DE CAPITAL ===
  
  # OperaÃ§Ãµes de CrÃ©dito
  `10  OperaÃ§Ãµes de CrÃ©dito` = list(
    criterio = "(nre1_categoria_economica_codigo == 2 & nre2_origem_receita_codigo_origem == 1) | (nre1_categoria_economica_codigo == 8 & nre2_origem_receita_codigo_origem == 1)"
  ),
  
  # AlienaÃ§Ã£o de Bens
  `11  AlienaÃ§Ã£o de Bens` = list(
    criterio = "(nre1_categoria_economica_codigo == 2 & nre2_origem_receita_codigo_origem == 2) | (nre1_categoria_economica_codigo == 8 & nre2_origem_receita_codigo_origem == 2)"
  ),
  
  # TransferÃªncias de Capital
  `12  TransferÃªncias de Capital` = list(
    criterio = "nre1_categoria_economica_codigo == 2 & nre2_origem_receita_codigo_origem == 4"
  ),
  
  # Outras Receitas de Capital
  `13  Outras Receitas de Capital` = list(
    criterio = "(nre1_categoria_economica_codigo == 2 & nre2_origem_receita_codigo_origem == 5) | (nre1_categoria_economica_codigo == 8 & nre2_origem_receita_codigo_origem == 5)"
  ),
  
  # SUBTOTAL (I) - Receitas Correntes + Receitas de Capital - Intra-orÃ§amentÃ¡rias
  `14  SUBTOTAL (I)` = list(
    criterio = "nre1_categoria_economica_codigo %in% c(1, 2, 7, 8)"
  )
)
```

```{r processar-receitas}
#| eval: !expr executar_relatorio("RREO_T01")

# Processar dados de receitas



datatable(aplicar_criterios(
  df = dados_receita %>% filter(esfera_orcamentaria_codigo == 2, item_informacao_codigo == "5") %>% unique(),
  criterios = criterios_rreo_T01_receitas)%>% group_by(categoria) %>% summarise(valor = sum(valor, na.rm = TRUE))) %>%
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")


```

## ğŸ’¸ DESPESAS ORÃ‡AMENTÃRIAS

```{r criterios-despesas}
#| eval: !expr executar_relatorio("RREO_T01")
# ======================================
# CRITÃ‰RIOS DA TABELA 1 - DESPESAS
# ======================================

criterios_rreo_T01_despesas_T01 <- list(
  
  # === DESPESAS CORRENTES ===
  
  # Pessoal e Encargos Sociais
  `01  Pessoal e Encargos Sociais` = list(
    criterio = "grupo_despesa_codigo_grupo == '1'"
  ),
  
  # Juros e Encargos da DÃ­vida
  `02  Juros e Encargos da DÃ­vida` = list(
    criterio = "grupo_despesa_codigo_grupo == '2'"
  ),
  
  # Outras Despesas Correntes
  `03  Outras Despesas Correntes` = list(
    criterio = "grupo_despesa_codigo_grupo == '3'"
  ),
  
  # BenefÃ­cios PrevidenciÃ¡rios
  `04  BenefÃ­cios PrevidenciÃ¡rios` = list(
    criterio = "grupo_despesa_codigo_grupo == '3' & unidade_orcamentaria_codigo %in% c('55902', '40904', '33904', '25917')"
  ),
  
  # TransferÃªncias
  `05  TransferÃªncias` = list(
    criterio = "grupo_despesa_codigo_grupo == '3' & modalidade_aplicacao_codigo %in% c('30', '31', '35', '36', '40', '41', '42', '45')"
  ),
  
  # Demais Despesas Correntes
  `06  Demais Despesas Correntes` = list(
    criterio = "
    grupo_despesa_codigo_grupo == '3' & 
    !unidade_orcamentaria_codigo %in% c('55902', '40904', '33904', '25917') &
    !modalidade_aplicacao_codigo %in% c('30', '31', '35', '36', '40', '41', '42', '45')
    "
  ),
  
  # === DESPESAS DE CAPITAL ===
  
  # Investimentos
  `07  Investimentos` = list(
    criterio = "grupo_despesa_codigo_grupo == '4'"
  ),
  
  # InversÃµes Financeiras
  `08  InversÃµes Financeiras` = list(
    criterio = "grupo_despesa_codigo_grupo == '5'"
  ),
  
  # AmortizaÃ§Ã£o da DÃ­vida
  `09  AmortizaÃ§Ã£o da DÃ­vida` = list(
    criterio = "grupo_despesa_codigo_grupo == '6'"
  ),
  
  # RESERVA DE CONTINGÃŠNCIA
  `10  RESERVA DE CONTINGÃŠNCIA` = list(
    criterio = "grupo_despesa_codigo_grupo == '9'"
  ),
  
  # SUBTOTAL (III) - Total das Despesas
  `11  SUBTOTAL (III)` = list(
    criterio = "grupo_despesa_codigo_grupo %in% c('1', '2', '3', '4', '5', '6', '9')"
  )
)
```

```{r processar-despesas}
#| eval: !expr executar_relatorio("RREO_T01")
# Processar dados de despesas
datatable(aplicar_criterios(
  df = dados_despesa %>% filter(esfera_orcamentaria_codigo == 2, item_informacao_codigo == "25") %>% unique(),
  criterios = criterios_rreo_T01_despesas_T01) %>% group_by(categoria) %>% summarise(valor = sum(valor, na.rm = TRUE))) %>%
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")


```

### Resultado da Seguridade Social

```{r}
(formatar_numero (resultado_seguridade <- as.numeric(df_criterios_rreo_T01_receitas %>% filter(ordem == "14") %>% summarise(valor= valor))-as.numeric(df_criterios_rreo_T01_despesas_T01 %>% filter(ordem == "11") %>% summarise(valor= valor))) )

```

## ğŸ“Š Tabela 01A - Detalhamento das Receitas

```{r criterios-tabela1a}
#| eval: !expr executar_relatorio("RREO_T01")
# ======================================
# CRITÃ‰RIOS DA TABELA 1A - COLUNAS 2025
# ======================================
criterios_rreo_T01a_receita_prevista_T01 <- list(
  
  # === PREVISÃƒO ATUALIZADA (a) ===
  
  # PrevisÃ£o Atualizada da Receita
  `PREVISAO_ATUALIZADA` = list(
    criterio = "
    natureza_receita_codigo_completo %in% c('12100111', '12100121', '12100131', '12100211', '12102121', '12102131', 
                                            '12106511', '12106611', '12106711', '12107211', '12107411', '12107611',
                                            '12108111', '12109131', '12101011', '12101311', '12101411', '12101611',
                                            '12106131', '12106211', '12106411', '12106511', '12106611', '12106711',
                                            '12110051', '12110061', '12106211', '12100511', '12106311', '12106711',
                                            '12104211', '12104311', '12101051') &
    fonte_recursos_codigo == '000' &
    esfera_orcamentaria_codigo == '1'
    "
  ),
  
  # === RECEITAS REALIZADAS NO MÃŠS ===
  
  # Receita OrÃ§amentÃ¡ria Arrecadada no MÃªs
  `RECEITA_REALIZADA_MES` = list(
    criterio = "
    fonte_recursos_codigo == '000' &
    (endsWith(fonte_recursos_detalhada_codigo, '98001') | endsWith(fonte_recursos_detalhada_codigo, '73910'))
    "
  ),
  
  # === RECEITAS REALIZADAS ATÃ‰ O MÃŠS ===
  
  # Receita OrÃ§amentÃ¡ria Arrecadada Acumulada
  `RECEITA_REALIZADA_ACUMULADA` = list(
    criterio = "
    fonte_recursos_codigo == '000' &
    (endsWith(fonte_recursos_detalhada_codigo, '98001') | endsWith(fonte_recursos_detalhada_codigo, '73910'))
    "
  )
)
```

```{r processar-tabela1a}
#| eval: !expr executar_relatorio("RREO_T01")
# Processar Tabela 01A
datatable(aplicar_criterios(
  df = dados_receita %>% filter(esfera_orcamentaria_codigo == 2) %>% unique(),
  criterios = criterios_rreo_T01a_receita_prevista_T01
)%>% group_by(categoria) %>% summarise(valor = sum(valor, na.rm = TRUE))) %>%
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")


```

## ğŸ¥ Seguridade Social

```{r criterios-seguridade}
#| eval: !expr executar_relatorio("RREO_T01")
# CritÃ©rios para anÃ¡lise da Seguridade Social
criterios_rreo_T01B_seguridade_T01B <- list(
  
  # SAÃšDE
  `01  SaÃºde` = list(
    criterio = "iduso_codigo %in% c('6') & funcao_governo_codigo %notin% c('08')"
  ),
  
  # RGPS - UNIDADE ORÃ‡AMENTÃRIA  
  `02  RGPS - Receitas da PrevidÃªncia Social` = list(
    criterio = "unidade_orcamentaria_codigo %in% c('33904', '40404', '35902', '29917')"
  ),
  
  # ASSISTÃŠNCIA SOCIAL
  `03  AssistÃªncia Social` = list(
    criterio = "funcao_governo_codigo %in% c('08') & acao_governo_codigo %notin% c('0581', '0544', '0563', '0658', '0585', '0653', '0636')"
  ),
  
  # ABONO SALARIAL
  `04  Abono Salarial` = list(
    criterio = "acao_governo_codigo %in% c('0581')"
  ),
  
  # SEGURO DESEMPREGO
  `05  Seguro Desemprego` = list(
    criterio = "acao_governo_codigo %in% c('00H4', '0583', '0585', '0686', '0653')"
  )
)
```

```{r processar-seguridade}
#| eval: !expr executar_relatorio("RREO_T01")
# Processar dados da Seguridade Social
datatable(aplicar_criterios(
  df = dados_despesa %>% filter(esfera_orcamentaria_codigo == 2, item_informacao_codigo == "25") %>% unique(),
  criterios = criterios_rreo_T01B_seguridade_T01B
)%>% group_by(categoria) %>% summarise(valor = sum(valor, na.rm = TRUE))) %>%
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")


```

# ğŸ“‹ RREO Tabela 02

## ğŸ“Š CritÃ©rios da Tabela 02

```{r criterios-tabela02}
#| eval: !expr executar_relatorio("RREO_T02")
# ======================================
# CRITÃ‰RIOS DA TABELA 02 -
# ======================================

criterios_rreo_T02_despesas_T02 <- list(
  
  # APLICAÃ‡ÃƒO DIRETA (serÃ¡ calculado por soma dos subitens)
  `01  AplicaÃ§Ã£o Direta` = list(
    criterio = "FALSE"  # SerÃ¡ calculado por soma posterior
  ),
  
  # A DETALHAR
  `02  A Detalhar` = list(
    criterio = "elemento_despesa_codigo %in% c('00')"
  ),
  
  # PESSOAL CIVIL (serÃ¡ calculado por soma dos subitens)
  `03  Pessoal Civil` = list(
    criterio = "FALSE"  # SerÃ¡ calculado por soma posterior
  ),
  
  # PESSOAL CIVIL - VENCIMENTOS E VANTAGENS FIXAS
  `04  Pessoal Civil - Vencimentos e Vantagens Fixas` = list(
    criterio = "elemento_despesa_codigo %in% c('11')"
  ),
  
  # PESSOAL CIVIL - OUTRAS DESPESAS VARIÃVEIS
  `05  Pessoal Civil - Outras Despesas VariÃ¡veis` = list(
    criterio = "elemento_despesa_codigo %in% c('16')"
  ),
  
  # PESSOAL CIVIL - APOSENTADORIA
  `06  Pessoal Civil - Aposentadoria` = list(
    criterio = "elemento_despesa_codigo %in% c('01') & (orgao_uge_orgao_maximo_codigo %notin% c('52000') | (orgao_uge_orgao_maximo_codigo %in% c('52000') & acao_governo_codigo %in% c('0181')))"
  ),
  
  # PESSOAL CIVIL - PENSÃ•ES
  `07  Pessoal Civil - PensÃµes` = list(
    criterio = "elemento_despesa_codigo %in% c('03') & (orgao_uge_orgao_maximo_codigo %notin% c('52000') | (orgao_uge_orgao_maximo_codigo %in% c('52000') & acao_governo_codigo %in% c('0181')))"
  ),
  
  # PESSOAL CIVIL - CONTRIBUIÃ‡Ã•ES A ENTIDADES FECHADAS DE PREVIDÃŠNCIA
  `08  Pessoal Civil - ContribuiÃ§Ãµes a Entidades Fechadas de PrevidÃªncia` = list(
    criterio = "elemento_despesa_codigo %in% c('07') & orgao_uge_orgao_maximo_codigo %notin% c('52000')"
  ),
  
  # PESSOAL CIVIL - OBRIGAÃ‡Ã•ES PATRONAIS
  `09  Pessoal Civil - ObrigaÃ§Ãµes Patronais` = list(
    criterio = "elemento_despesa_codigo %in% c('13') & orgao_uge_orgao_maximo_codigo %notin% c('52000')"
  ),
  
  # PESSOAL CIVIL - OUTRAS APLICAÃ‡Ã•ES
  `10  Pessoal Civil - Outras AplicaÃ§Ãµes` = list(
    criterio = "
    (elemento_despesa_codigo %notin% c('00', '01', '03') & 
     orgao_uge_orgao_maximo_codigo %in% c('52000') & 
     acao_governo_codigo %in% c('0181')) | 
    (elemento_despesa_codigo %notin% c('00', '01', '03', '07', '11', '12', '13', '16', '17', '41') & 
     orgao_uge_orgao_maximo_codigo %notin% c('52000'))
    "
  ),
  
  # PESSOAL MILITAR (serÃ¡ calculado por soma dos subitens)
  `11  Pessoal Militar` = list(
    criterio = "FALSE"  # SerÃ¡ calculado por soma posterior
  ),
  
  # PESSOAL MILITAR - VENCIMENTOS E VANTAGENS FIXAS
  `12  Pessoal Militar - Vencimentos e Vantagens Fixas` = list(
    criterio = "elemento_despesa_codigo %in% c('12')"
  ),
  
  # PESSOAL MILITAR - OUTRAS DESPESAS VARIÃVEIS
  `13  Pessoal Militar - Outras Despesas VariÃ¡veis` = list(
    criterio = "elemento_despesa_codigo %in% c('17')"
  ),
  
  # PESSOAL MILITAR - REFORMAS
  `14  Pessoal Militar - Reformas` = list(
    criterio = "elemento_despesa_codigo %in% c('01') & orgao_uge_orgao_maximo_codigo %in% c('52000') & acao_governo_codigo %notin% c('0181')"
  ),
  
  # PESSOAL MILITAR - PENSÃ•ES
  `15  Pessoal Militar - PensÃµes` = list(
    criterio = "elemento_despesa_codigo %in% c('03') & orgao_uge_orgao_maximo_codigo %in% c('52000') & acao_governo_codigo %notin% c('0181')"
  ),
  
  # PESSOAL MILITAR - OBRIGAÃ‡Ã•ES PATRONAIS
  `16  Pessoal Militar - ObrigaÃ§Ãµes Patronais` = list(
    criterio = "elemento_despesa_codigo %in% c('13') & orgao_uge_orgao_maximo_codigo %in% c('52000')"
  ),
  
  # PESSOAL MILITAR - OUTRAS APLICAÃ‡Ã•ES (+)
  `17  Pessoal Militar - Outras AplicaÃ§Ãµes (+)` = list(
    criterio = "elemento_despesa_codigo %notin% c('00', '01', '03', '11', '12', '13', '16', '17', '41') & orgao_uge_orgao_maximo_codigo %in% c('52000')"
  ),
  
  # PESSOAL MILITAR - OUTRAS APLICAÃ‡Ã•ES (-)
  `18  Pessoal Militar - Outras AplicaÃ§Ãµes (-)` = list(
    criterio = "elemento_despesa_codigo %notin% c('00', '01', '03', '11') & orgao_uge_orgao_maximo_codigo %in% c('52000') & acao_governo_codigo %in% c('0181')"
  ),
  
  # TRANSFERÃŠNCIAS INTERGOVERNAMENTAIS
  `19  TransferÃªncias Intergovernamentais` = list(
    criterio = "elemento_despesa_codigo %in% c('41')"
  ),
  
  # TRANSFERÃŠNCIAS A ESTADOS E AO DF
  `20  TransferÃªncias a Estados e ao DF` = list(
    criterio = "elemento_despesa_codigo %in% c('41')"
  )
)
```

### ğŸ’¼ Processamento dos Dados

### ğŸ“Š DotaÃ§Ã£o Atualizada

```{r processar-dotacao}
#| eval: !expr executar_relatorio("RREO_T02")



datatable(aplicar_criterios(df = dados_despesa %>% 
    filter( grupo_despesa_codigo_grupo == 1,  orgao_uge_orcam_fiscal_s_n == "PERTENCE",   mes_lancamento == mes_filtro, item_informacao_codigo == 9
    ),
  criterios = criterios_rreo_T02_despesas_T02,
  group_vars = c("orgao_uge_tipo_administracao_nome")) %>% group_by(categoria, orgao_uge_tipo_administracao_nome) %>% summarise(valor = sum(valor, na.rm = TRUE)) %>% pivot_wider(names_from = "orgao_uge_tipo_administracao_nome", values_from = "valor") ) %>%
  formatRound(c('ADMINISTRACAO DIRETA',
  'AUTARQUIA',
  'ECONOMIA MISTA',
  'EMPRESA PUBLICA COMERCIAL E FINANCEIRA',
  'FUNDACAO',
  'FUNDOS'), 2, mark = ".", dec.mark = ",")



```

### âœ… Teste Pessoal Militar

```{r validacao-militar}
#| eval: !expr executar_relatorio("RREO_T02")
# ValidaÃ§Ã£o especÃ­fica para Pessoal Militar
validacao_militar <- dados_despesa %>% 
  group_by(orgao_uge_tipo_administracao_nome) %>%
  filter(
    grupo_despesa_codigo_grupo == 1,
    mes_lancamento == mes_filtro,
    item_informacao_codigo == "9"
  ) %>% 
  filter(
    (elemento_despesa_codigo %in% c('12', '17')) |
    (elemento_despesa_codigo %in% c('01') & 
     orgao_uge_orgao_maximo_codigo %in% c('52000') &
     acao_governo_codigo %notin% c('0181')) |
    (elemento_despesa_codigo %in% c('03') & 
     orgao_uge_orgao_maximo_codigo %in% c('52000') &
     acao_governo_codigo %notin% c('0181')) |
    (elemento_despesa_codigo %in% c('13') & 
     orgao_uge_orgao_maximo_codigo %in% c('52000'))
  ) %>% 
  summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao, na.rm = TRUE), .groups = "drop")

datatable(validacao_militar, 
          caption = "ValidaÃ§Ã£o - Pessoal Militar") %>%
  formatRound(c('saldo_r_item_informacao'), 2, mark = ".", dec.mark = ",")
```

### âœ… Teste Pessoal Civil

```{r validacao-civil}
#| eval: !expr executar_relatorio("RREO_T02")
# ValidaÃ§Ã£o especÃ­fica para Pessoal Civil
validacao_civil <- dados_despesa %>% 
  group_by(orgao_uge_tipo_administracao_nome) %>%
  filter(
    grupo_despesa_codigo_grupo == 1,
    mes_lancamento == mes_filtro,
    item_informacao_codigo == "9"
  ) %>% 
  filter(
    # CondiÃ§Ãµes especÃ­ficas para Pessoal Civil
    (elemento_despesa_codigo %in% c('11', '16')) |
    (elemento_despesa_codigo == '01' & orgao_uge_orgao_maximo_codigo != '52000') |
    (elemento_despesa_codigo == '01' & orgao_uge_orgao_maximo_codigo == '52000' & acao_governo_codigo == '0181') |
    (elemento_despesa_codigo == '03' & orgao_uge_orgao_maximo_codigo != '52000') |
    (elemento_despesa_codigo == '03' & orgao_uge_orgao_maximo_codigo == '52000' & acao_governo_codigo == '0181') |
    (elemento_despesa_codigo == '07' & orgao_uge_orgao_maximo_codigo != '52000') |
    (elemento_despesa_codigo == '13' & orgao_uge_orgao_maximo_codigo != '52000') |
    (elemento_despesa_codigo %notin% c('00', '01', '03', '07', '11', '12', '13', '16', '17', '41') & 
     orgao_uge_orgao_maximo_codigo != '52000') |
    (elemento_despesa_codigo %notin% c('00', '01', '03') & 
     orgao_uge_orgao_maximo_codigo == '52000' & 
     acao_governo_codigo == '0181')
  ) %>% 
  summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao, na.rm = TRUE), .groups = "drop")

datatable(validacao_civil, 
          caption = "ValidaÃ§Ã£o - Pessoal Civil") %>%
  formatRound(c('saldo_r_item_informacao'), 2, mark = ".", dec.mark = ",")
```

### âœ… Teste AplicaÃ§Ã£o Direta

```{r validacao-aplicacao-direta}
#| eval: !expr executar_relatorio("RREO_T02")
# ValidaÃ§Ã£o para AplicaÃ§Ã£o Direta
validacao_aplicacao <- dados_despesa %>% 
  group_by(orgao_uge_tipo_administracao_nome) %>%
  filter(
    grupo_despesa_codigo_grupo == 1,
    mes_lancamento == mes_filtro,
    item_informacao_codigo == "25"  # Usando despesas empenhadas
  ) %>% 
  filter(
    # Elementos que se aplicam a todos os Ã³rgÃ£os
    (elemento_despesa_codigo %in% c('11', '16', '00', '12', '17')) |
    
    # Elementos 01 e 03 - fora do Min. Defesa
    (elemento_despesa_codigo %in% c('01', '03') & 
     orgao_uge_orgao_maximo_codigo != '52000') |
    
    # Elementos 01 e 03 - Min. Defesa (todas as aÃ§Ãµes)
    (elemento_despesa_codigo %in% c('01', '03') & 
     orgao_uge_orgao_maximo_codigo == '52000') |
    
    # Elementos 07 e 13 - fora do Min. Defesa
    (elemento_despesa_codigo %in% c('07', '13') & 
     orgao_uge_orgao_maximo_codigo != '52000') |
    
    # Elemento 13 - Min. Defesa (todas as aÃ§Ãµes)
    (elemento_despesa_codigo == '13' & 
     orgao_uge_orgao_maximo_codigo == '52000') |
    
    # Outros elementos - fora do Min. Defesa
    (elemento_despesa_codigo %notin% c('00', '01', '03', '07', '11', '12', '13', '16', '17', '41') & 
     orgao_uge_orgao_maximo_codigo != '52000') |
    
    # Outros elementos (exceto 00,01,03) - Min. Defesa com aÃ§Ã£o 0181
    (elemento_despesa_codigo %notin% c('00', '01', '03') & 
     orgao_uge_orgao_maximo_codigo == '52000' & 
     acao_governo_codigo == '0181')
  ) %>% 
  summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao, na.rm = TRUE), .groups = "drop")

datatable(validacao_aplicacao, 
          caption = "ValidaÃ§Ã£o - AplicaÃ§Ã£o Direta") %>%
  formatRound(c('saldo_r_item_informacao'), 2, mark = ".", dec.mark = ",")
```

# ğŸ“‹ RREO Tabela 03

```{r tabela_3}
#| eval: !expr executar_relatorio("RREO_T03")
agrupado_despesa_orgao <- c("orgao_uge_orgao_maximo_codigo", "orgao_uge_orgao_maximo_nome")

dados_agregados_orgao <- dados_despesa %>% 
  filter(resultado_eof_codigo == 6) %>%
  group_by(across(all_of(c(agrupado_despesa_orgao, "item_informacao_nome")))) %>%
  summarise(
    saldo_r_item_informacao = sum(saldo_r_item_informacao, na.rm = TRUE),
    .groups = "drop"
  )

dt_formatada(
  tabela_pivotada(dados_agregados_orgao, agrupado_despesa_orgao),
  agrupado_despesa_orgao
)
```
