---
title: "üìä RREO & RGF - Relat√≥rios Fiscais"
subtitle: "Sistema Unificado de Relat√≥rios Fiscais do Governo Federal"
author: "Governo Federal"
date: today
execute:
  warning: false
  message: false
  cache: false
  
format:
  html:
    theme: cosmo
    toc: true
    toc-depth: 3
    number-sections: true
    code-fold: true
    code-summary: "Mostrar c√≥digo"
    fig-width: 10
    fig-height: 6
    tbl-cap-location: top
    self-contained: true
---

# üìö Carregamento de Bibliotecas e Configura√ß√µes {#sec-setup}

```{r setup}
#| include: false


# Bibliotecas principais
library(dplyr)
library(tidyr)
library(stringr)
library(readxl)
library(janitor)
library(purrr)
library(forcats)
library(DT)
library(knitr)
library(kableExtra)
library(readr)
library(scales)
library(lubridate)
library(rlang)

Sys.setlocale("LC_TIME", "pt_BR.UTF-8")

# Configura√ß√µes globais
options(OutDec = ".")
options(scipen = 999)

# Configura√ß√µes DT
options(DT.options = 
  list(
    pageLength = 50,
    lengthMenu = c(5, 10, 25, 50, 100),
    language = list(url = '//cdn.datatables.net/plug-ins/1.10.11/i18n/Portuguese.json')
  )
)

# ============================================================================
# ‚ö° OTIMIZA√á√ïES DE PERFORMANCE E PARALELIZA√á√ÉO
# ============================================================================

# Carregar bibliotecas de paraleliza√ß√£o
suppressPackageStartupMessages({
  library(furrr)      # Para processamento paralelo com purrr
  library(future)     # Backend de paraleliza√ß√£o
  library(data.table) # Para opera√ß√µes ultrarr√°pidas em dados grandes
})

# Detectar recursos dispon√≠veis
cores_disponiveis <- parallel::detectCores()

# Obter mem√≥ria total (compat√≠vel com Windows)
memoria_info <- tryCatch({
  resultado <- system("wmic computersystem get totalphysicalmemory", intern = TRUE)
  as.numeric(gsub("[^0-9]", "", resultado[2])) / (1024^3)
}, error = function(e) {
  32.0  # Fallback
})

cat("\n")
cat("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n")
cat("‚ïë        ‚ö° OTIMIZA√á√ÉO DE PERFORMANCE - SISTEMA ATIVADO        ‚ïë\n")
cat("‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£\n")
cat(sprintf("‚ïë üñ•Ô∏è  CPU: %d cores dispon√≠veis%s‚ïë\n", 
    cores_disponiveis, 
    strrep(" ", 44 - nchar(as.character(cores_disponiveis)))))
cat(sprintf("‚ïë üíæ RAM: %.1f GB%s‚ïë\n", 
    memoria_info, 
    strrep(" ", 48 - nchar(sprintf("%.1f GB", memoria_info)))))

# Configurar paraleliza√ß√£o (usar at√© 10 cores, deixar 2 para o sistema)
cores_usar <- min(10, max(1, cores_disponiveis - 2))
cat(sprintf("‚ïë ‚öôÔ∏è  Cores para processamento paralelo: %d%s‚ïë\n", 
    cores_usar,
    strrep(" ", 29 - nchar(as.character(cores_usar)))))

# Configurar backend de paraleliza√ß√£o
plan(multisession, workers = cores_usar)

# Desabilitar paraleliza√ß√£o autom√°tica do data.table para evitar conflitos
setDTthreads(1)

cat("‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£\n")
cat("‚ïë ‚úÖ Paraleliza√ß√£o configurada e ativa                        ‚ïë\n")
cat("‚ïë ‚úÖ Otimiza√ß√µes de mem√≥ria ativadas                          ‚ïë\n")
cat("‚ïë ‚úÖ Backend: future::multisession                            ‚ïë\n")
cat("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n")
cat("\n")

# ============================================================================
# FUN√á√ïES OTIMIZADAS PARA IMPORTA√á√ÉO PARALELA
# ============================================================================

# ============================================================================
# üîß CORRE√á√ÉO: Fun√ß√£o importar_excel_paralelo ATUALIZADA
# ============================================================================
# SUBSTITUA a fun√ß√£o antiga no chunk {r setup} por esta vers√£o

importar_excel_paralelo <- function(arquivos, skip = 5, .progress = TRUE) {
  if (length(arquivos) == 0) {
    warning("Nenhum arquivo fornecido")
    return(data.frame())
  }
  
  cat(sprintf("üì• Importando %d arquivos em paralelo...\n", length(arquivos)))
  
  resultado <- future_map_dfr(
    arquivos, 
    function(arq) {
      df <- read_excel(arq, skip = skip, col_types = "text") %>%
        clean_names()
      
      # ============================================================================
      # ‚úÖ CONVERS√ÉO AUTOM√ÅTICA DE COLUNAS NUM√âRICAS
      # ============================================================================
      # Padr√µes de nomes de colunas que devem ser num√©ricas
      numeric_patterns <- c(
        "^saldo_r",           # saldo_r_item_informacao, saldo_r_conta_contabil
        "^movim.*_r",         # movim_liquido_r_item_informacao
        "^valor",             # valor_lancado, valor_empenhado, valor_liquidado
        "_valor$",            # qualquer_coisa_valor
        "_saldo$",            # qualquer_coisa_saldo
        "saldo.*atual",       # saldo_dotacao_atual
        "mes_lancamento"      # mes_lancamento
      )
      
      # Encontrar colunas que correspondem aos padr√µes
      cols_numericas <- names(df)[str_detect(names(df), 
                                              paste(numeric_patterns, collapse = "|"))]
      
      # Converter para num√©rico (com suppressWarnings para NAs esperados)
      if (length(cols_numericas) > 0) {
        df <- df %>%
          mutate(across(all_of(cols_numericas), ~ suppressWarnings(as.numeric(.))))
      }
      
      return(df)
    },
    .progress = .progress,
    .options = furrr_options(seed = TRUE)
  )
  
  cat(sprintf("‚úÖ Importa√ß√£o conclu√≠da: %s registros\n", 
              format(nrow(resultado), big.mark = ".", decimal.mark = ",")))
  
  # Mostrar quais colunas foram convertidas
  cols_convertidas <- names(resultado)[sapply(resultado, is.numeric)]
  if (length(cols_convertidas) > 0) {
    cat(sprintf("   üìä Colunas num√©ricas: %d\n", length(cols_convertidas)))
  }
  
  return(resultado)
}

cat("‚úÖ Fun√ß√£o importar_excel_paralelo() ATUALIZADA carregada!\n\n")



# Operadores customizados
`%notin%` <- Negate(`%in%`)
`%||%` <- function(x, y) if(is.null(x) || length(x) == 0 || is.na(x)) y else x

formatar_numero <- function(x) {
  format(x, big.mark = ".", decimal.mark = ",", scientific = FALSE, nsmall = 2)
}

print("‚úÖ Bibliotecas carregadas com sucesso!")
```

## üîß Vari√°veis Globais

```{r variaveis_globais}
# Filtro principal do m√™s
mes_filtro <- "202511"

mes_pasta <- str_c("data/",mes_filtro,"/")

print(paste("üìÖ M√™s de refer√™ncia definido:", mes_filtro))
```

# üì• Importa√ß√£o dos Dados {#sec-dados}

## üßæ Dados de Receita

```{r dados_receita}


#| echo: true
#| eval: true
#| include: false

# ============================================================================
# ‚ö° VERS√ÉO OTIMIZADA - IMPORTA√á√ÉO PARALELA
# ============================================================================

# Definir arquivos a importar
arquivos_receita <- c(
  str_c(mes_pasta, "tg_receita_liquida.xlsx"),
  str_c(mes_pasta, "tg_receita_previsao.xlsx")
)

cat("üì• Importando dados de receita em paralelo...\n")

# Importar ambos os arquivos simultaneamente
dados_receita <- importar_excel_paralelo(
  arquivos = arquivos_receita, 
  skip = 5, 
  .progress = TRUE
) %>%
  # Filtrar e transformar uma √∫nica vez
  filter(orgao_uge_orcam_fiscal_s_n == "PERTENCE") %>%
  mutate(
    # Convers√£o de data
    mes_lancamento = as.numeric(mes_lancamento),
    data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1),
    
    # Vari√°veis derivadas
    tipo_modalidade = ifelse(
      nre1_categoria_economica_codigo %in% c(7, 8), 
      "intra", 
      "exceto intra"
    ),
    
    refinanciamento = ifelse(
      natureza_receita_codigo_completo %in% c(81110201, 21110201, 21210201), 
      "sim", 
      "nao"
    )
  )

cat(sprintf("‚úÖ Dados de receita carregados: %s registros\n", 
            format(nrow(dados_receita), big.mark = ".", decimal.mark = ",")))
cat(sprintf("   ‚Ä¢ Mem√≥ria utilizada: %.1f MB\n", 
            object.size(dados_receita) / 1024^2))
```

## üí∞ Dados de Despesa

```{r dados_despesa_rreo}
#| echo: true


#| include: false

# ============================================================================
# ‚ö° VERS√ÉO OTIMIZADA - IMPORTA√á√ÉO PARALELA
# ============================================================================

# Buscar todos os arquivos de despesa
arq_despesa <- list.files(
  path = mes_pasta, 
  pattern = 'tg_despesa', 
  full.names = TRUE
)

cat(sprintf("üì• Importando %d arquivos de despesa em paralelo...\n", length(arq_despesa)))

# Importar todos os arquivos simultaneamente
dados_despesa <- importar_excel_paralelo(
  arquivos = arq_despesa, 
  skip = 5, 
  .progress = TRUE
) %>%
  # Filtrar e transformar
  filter(orgao_uge_orcam_fiscal_s_n == "PERTENCE") %>%
  mutate(
    # Converter colunas num√©ricas espec√≠ficas
    across(contains("saldo"), as.numeric),
    across(contains("valor"), as.numeric),
    mes_lancamento = as.numeric(mes_lancamento),
    
    # Convers√£o de data
    data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1),
    
    # Vari√°veis derivadas - tipo_modalidade
    tipo_modalidade = ifelse(
      modalidade_aplicacao_codigo == 91,
      "intra",
      "exceto intra"
    ),
    
    # Vari√°veis derivadas - refinanciamento
    refinanciamento = case_when(
      grupo_despesa_codigo_grupo == 6 &
        elemento_despesa_codigo %in% c(76, 77) &
        subfuncao_governo_codigo %in% c(841, 842, 843, 844, 846) &
        fonte_recursos_codigo == "443" ~ "sim",
      !(grupo_despesa_codigo_grupo == 6 &
        elemento_despesa_codigo %in% c(76, 77) &
        subfuncao_governo_codigo %in% c(841, 842, 843, 844, 846) &
        fonte_recursos_codigo == "443") ~ "nao",
      TRUE ~ "escape"
    ),
    
    # Vari√°veis derivadas - poder
    poder = case_when(
      orgao_uge_orgao_maximo_codigo %in% c(59000) ~ "MINIST√âRIO P√öBLICO DA UNI√ÉO",
      orgao_uge_orgao_maximo_codigo %in% c(29000) ~ "DEFENSORIA P√öBLICA",
      TRUE ~ orgao_uge_poder_nome
    ),
    
    # Vari√°veis derivadas - transferencia
    transferencia = ifelse(
      modalidade_aplicacao_codigo %in% c('30', '31', '32', '35', '36', '40', '41', '42', '45', '46'), 
      "_transferencia", 
      "aplicacao_direta"
    )
  )

cat(sprintf("‚úÖ Dados de despesa carregados: %s registros\n", 
            format(nrow(dados_despesa), big.mark = ".", decimal.mark = ",")))
cat(sprintf("   ‚Ä¢ Arquivos processados: %d\n", length(arq_despesa)))
cat(sprintf("   ‚Ä¢ Mem√≥ria utilizada: %.1f MB\n", 
            object.size(dados_despesa) / 1024^2))

# Estat√≠sticas r√°pidas
cat("\nüìä Resumo por tipo_modalidade:\n")
print(dados_despesa %>% count(tipo_modalidade, sort = TRUE))

cat("\nüìä Resumo por refinanciamento:\n")
print(dados_despesa %>% count(refinanciamento, sort = TRUE))
```

## üìã Dados de Restos a Pagar

```{r dados_rp}
#| echo: true


#| include: false

# ============================================================================
# ‚ö° VERS√ÉO OTIMIZADA - IMPORTA√á√ÉO PARALELA MANTENDO ESTRUTURAS SEPARADAS
# ============================================================================

# Definir lista de arquivos a importar
arquivos_rp <- list(
  anexo_07 = str_c(mes_pasta, "tg_rp_anexo_07.xlsx"),
  anexo_12 = str_c(mes_pasta, "tg_rp_anexo_12.xlsx"),
  anexo_08 = str_c(mes_pasta, "tg_rp_anexo_08.xlsx"),
  anexo_03_rcl = str_c(mes_pasta, "tg_rp_anexo_03_rcl.xlsx")
)

cat(sprintf("üì• Importando %d arquivos de RP em paralelo...\n", length(arquivos_rp)))

# Importar todos simultaneamente, cada um mant√©m sua estrutura pr√≥pria
tempo_inicio <- Sys.time()

dados_rp_lista <- future_map(
  arquivos_rp,
  function(arquivo) {
    read_excel(arquivo, skip = 5) %>%
      clean_names() %>%
      mutate(
        mes_lancamento = as.numeric(mes_lancamento),
        data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1)
      )
  },
  .progress = TRUE,
  .options = furrr_options(seed = TRUE)
)

tempo_fim <- Sys.time()

# Extrair cada arquivo para sua vari√°vel espec√≠fica
# Anexo 07 precisa de transforma√ß√µes adicionais
dados_rp_anexo_07 <- dados_rp_lista$anexo_07 %>%
  mutate(
    tipo_modalidade = ifelse(
      modalidade_aplicacao_codigo == 91, 
      "intra", 
      "exceto intra"
    ),
    poder = case_when(
      orgao_uge_orgao_maximo_codigo %in% c(59000) ~ "MINIST√âRIO P√öBLICO DA UNI√ÉO",
      orgao_uge_orgao_maximo_codigo %in% c(29000) ~ "DEFENSORIA P√öBLICA",
      TRUE ~ orgao_uge_poder_nome
    )
  )

# Outros anexos mant√™m estrutura b√°sica
dados_rp_anexo_12 <- dados_rp_lista$anexo_12
dados_rp_anexo_08 <- dados_rp_lista$anexo_08
dados_rp_anexo_03_rcl <- dados_rp_lista$anexo_03_rcl

# Relat√≥rio de importa√ß√£o
cat("\n‚úÖ Dados de Restos a Pagar carregados:\n")
cat(sprintf("   ‚Ä¢ Anexo 07: %s registros (%.1f MB)\n", 
            format(nrow(dados_rp_anexo_07), big.mark = ".", decimal.mark = ","),
            object.size(dados_rp_anexo_07) / 1024^2))
cat(sprintf("   ‚Ä¢ Anexo 12: %s registros (%.1f MB)\n", 
            format(nrow(dados_rp_anexo_12), big.mark = ".", decimal.mark = ","),
            object.size(dados_rp_anexo_12) / 1024^2))
cat(sprintf("   ‚Ä¢ Anexo 08: %s registros (%.1f MB)\n", 
            format(nrow(dados_rp_anexo_08), big.mark = ".", decimal.mark = ","),
            object.size(dados_rp_anexo_08) / 1024^2))
cat(sprintf("   ‚Ä¢ Anexo 03 RCL: %s registros (%.1f MB)\n", 
            format(nrow(dados_rp_anexo_03_rcl), big.mark = ".", decimal.mark = ","),
            object.size(dados_rp_anexo_03_rcl) / 1024^2))

# Mem√≥ria total
memoria_total <- (object.size(dados_rp_anexo_07) + 
                  object.size(dados_rp_anexo_12) + 
                  object.size(dados_rp_anexo_08) + 
                  object.size(dados_rp_anexo_03_rcl)) / 1024^2

cat(sprintf("   ‚Ä¢ Mem√≥ria total: %.1f MB\n", memoria_total))
cat(sprintf("   ‚Ä¢ Tempo de importa√ß√£o: %.1f segundos\n", 
            as.numeric(difftime(tempo_fim, tempo_inicio, units = "secs"))))
```

## üè¶ Dados RREO Anexo 06 - Resultado Prim√°rio

```{r dados_rreo_a06_resultado_primario}
#| echo: true


#| include: false

# ============================================================================
# ‚ö° VERS√ÉO OTIMIZADA - IMPORTA√á√ÉO PARALELA DE 4 ARQUIVOS
# ============================================================================

# Definir arquivos
arquivos_a06 <- list(
  ndd = str_c(mes_pasta, "tg_anexo_06_rreo_despesas_primarias_ndd.xlsx"),
  categoria_grupo = str_c(mes_pasta, "tg_anexo_06_rreo_despesas_primarias_categoria_grupo.xlsx"),
  juros = str_c(mes_pasta, "tg_RPN_juros.xlsx"),
  disponibilidades = str_c(mes_pasta, "tg_RPN_disponibilidades.xlsx")
)

cat(sprintf("üì• Importando %d arquivos do Anexo 06 em paralelo...\n", length(arquivos_a06)))

# Importar todos simultaneamente
dados_a06_lista <- future_map(
  arquivos_a06,
  function(arquivo) {
    read_excel(arquivo, skip = 5) %>%
      clean_names() %>%
      mutate(
        mes_lancamento = as.numeric(mes_lancamento),
        data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1)
      )
  },
  .progress = TRUE,
  .options = furrr_options(seed = TRUE)
)

# Extrair para vari√°veis espec√≠ficas
dados_ndd <- dados_a06_lista$ndd
dados_categoria_grupo <- dados_a06_lista$categoria_grupo
dados_juros <- dados_a06_lista$juros
tg_RPN_juros <- dados_juros  # Alias para compatibilidade
tg_RPN_disponibilidades <- dados_a06_lista$disponibilidades

cat("\n‚úÖ Dados do Anexo 06 carregados:\n")
cat(sprintf("   ‚Ä¢ NDD: %s registros\n", 
            format(nrow(dados_ndd), big.mark = ".", decimal.mark = ",")))
cat(sprintf("   ‚Ä¢ Categoria/Grupo: %s registros\n", 
            format(nrow(dados_categoria_grupo), big.mark = ".", decimal.mark = ",")))
cat(sprintf("   ‚Ä¢ Juros: %s registros\n", 
            format(nrow(dados_juros), big.mark = ".", decimal.mark = ",")))
cat(sprintf("   ‚Ä¢ Disponibilidades: %s registros\n", 
            format(nrow(tg_RPN_disponibilidades), big.mark = ".", decimal.mark = ",")))
```

## üìä Dados RCL - RREO Anexo 03

```{r importar-dados-rcl}


#| include: false

cat("üì• Importando dados RCL (RREO A03)...\n")

# ============================================================================
# IMPORTA√á√ÉO
# ============================================================================

# Despesas
cat("   ‚Ä¢ Importando RCL Despesas...\n")
rreo_a03_rcl_despesas <- read_excel(
  str_c(mes_pasta, "rreo_a03_rcl_despesas.xlsx"), 
  skip = 5
) %>%
  clean_names() %>%
  mutate(
    # Converter coluna num√©rica
    movim_liquido_r_item_informacao = as.numeric(movim_liquido_r_item_informacao),
    mes_lancamento = as.numeric(mes_lancamento),
    data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1),
    # ‚úÖ CRIAR ALIAS para compatibilidade com crit√©rios
    saldo_r_item_informacao = movim_liquido_r_item_informacao
  )

# Receitas
cat("   ‚Ä¢ Importando RCL Receitas...\n")
rreo_a03_rcl_receitas <- read_excel(
  str_c(mes_pasta, "rreo_a03_rcl_receitas.xlsx"), 
  skip = 5
) %>%
  clean_names() %>%
  mutate(
    # Converter coluna num√©rica
    movim_liquido_r_item_informacao = as.numeric(movim_liquido_r_item_informacao),
    mes_lancamento = as.numeric(mes_lancamento),
    data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1),
    # ‚úÖ CRIAR ALIAS para compatibilidade com crit√©rios
    saldo_r_item_informacao = movim_liquido_r_item_informacao
  )

cat(sprintf("\n‚úì RCL Despesas: %s registros\n", 
            format(nrow(rreo_a03_rcl_despesas), big.mark = ".", decimal.mark = ",")))
cat(sprintf("‚úì RCL Receitas: %s registros\n", 
            format(nrow(rreo_a03_rcl_receitas), big.mark = ".", decimal.mark = ",")))

# ============================================================================
# VERIFICA√á√ÉO
# ============================================================================
cat("\nüîç Verifica√ß√£o:\n")
cat(sprintf("   Colunas em despesas: %d\n", ncol(rreo_a03_rcl_despesas)))
cat(sprintf("   Colunas em receitas: %d\n", ncol(rreo_a03_rcl_receitas)))

# Verificar que alias foi criado e √© num√©rico
cat("\n‚úÖ Alias 'saldo_r_item_informacao' criado:\n")
cat(sprintf("   Despesas: %s (tipo: %s)\n", 
            "saldo_r_item_informacao" %in% names(rreo_a03_rcl_despesas),
            class(rreo_a03_rcl_despesas$saldo_r_item_informacao)[1]))
cat(sprintf("   Receitas: %s (tipo: %s)\n", 
            "saldo_r_item_informacao" %in% names(rreo_a03_rcl_receitas),
            class(rreo_a03_rcl_receitas$saldo_r_item_informacao)[1]))

# Teste de agrega√ß√£o
cat("\nüß™ Teste de agrega√ß√£o:\n")
teste_desp <- rreo_a03_rcl_despesas %>% 
  summarise(
    total_movim = sum(movim_liquido_r_item_informacao, na.rm = TRUE),
    total_saldo = sum(saldo_r_item_informacao, na.rm = TRUE)
  )
cat(sprintf("   Despesas (movim_liquido): %s\n", 
            format(teste_desp$total_movim, big.mark = ".", decimal.mark = ",")))
cat(sprintf("   Despesas (saldo_r alias): %s\n", 
            format(teste_desp$total_saldo, big.mark = ".", decimal.mark = ",")))

teste_rec <- rreo_a03_rcl_receitas %>% 
  summarise(
    total_movim = sum(movim_liquido_r_item_informacao, na.rm = TRUE),
    total_saldo = sum(saldo_r_item_informacao, na.rm = TRUE)
  )
cat(sprintf("   Receitas (movim_liquido): %s\n", 
            format(teste_rec$total_movim, big.mark = ".", decimal.mark = ",")))
cat(sprintf("   Receitas (saldo_r alias): %s\n", 
            format(teste_rec$total_saldo, big.mark = ".", decimal.mark = ",")))

cat("\n‚úÖ Importa√ß√£o RCL conclu√≠da com sucesso!\n")
```

## üë• Dados RGF Anexo 01 - Despesa com Pessoal

```{r importar-dados-rgf-a01}


#| include: false

cat("üì• Importando dados RGF A01 (Despesa Pessoal)...\n")

# ============================================================================
# ‚ö° VERS√ÉO OTIMIZADA - IMPORTA√á√ÉO PARALELA
# ============================================================================

# RGF Anexo 1
arq_rgf_a01 <- list.files(path = mes_pasta, pattern = 'rgf_a01_', full.names = TRUE)

cat(sprintf("   Encontrados %d arquivos\n", length(arq_rgf_a01)))

rgf_a01 <- importar_excel_paralelo(arq_rgf_a01, skip = 5, .progress = TRUE) %>%
  mutate(
    movim_liquido_r_item_informacao = as.numeric(movim_liquido_r_item_informacao),
    mes_lancamento = as.numeric(mes_lancamento),
    data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1)
  )

cat(sprintf("‚úì RGF A01: %s registros (%d arquivos)\n", 
            format(nrow(rgf_a01), big.mark = ".", decimal.mark = ","), 
            length(arq_rgf_a01)))
```

## üèõÔ∏è Dados RGF Anexo 02 - D√≠vida Consolidada L√≠quida (DCL)

```{r importar-dados-rgf-a02}
#| include: false

cat("üì• Importando dados RGF A02 (DCL)...\n")

# ============================================================================
# ‚ö° VERS√ÉO OTIMIZADA - IMPORTA√á√ÉO PARALELA
# ============================================================================

# Fun√ß√£o auxiliar para processar arquivo (mantida para compatibilidade)
processar_arquivo_rgf_a02 <- function(file_path, skip_rows = 5) {
  df <- read_excel(file_path, skip = skip_rows, col_types = "text") %>%
    clean_names()
  
  if ("mes_lancamento" %in% names(df)) {
    df <- df %>%
      mutate(
        mes_lancamento = as.numeric(mes_lancamento),
        data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1)
      )
  }
  
  # Converte colunas num√©ricas automaticamente
  numeric_patterns <- c("^saldo_r", "^movim_liquido_r")
  cols_to_convert <- names(df)[str_detect(names(df), paste(numeric_patterns, collapse = "|"))]
  
  for (col in cols_to_convert) {
    df <- df %>% mutate(!!sym(col) := as.numeric(!!sym(col)))
  }
  
  return(df)
}

# Lista TODOS os arquivos rgf_a02_*.xlsx
arq_rgf_a02 <- list.files(
  path = mes_pasta,
  pattern = "^rgf_a02_.*\\.xlsx$",
  full.names = TRUE
)

cat(sprintf("   Encontrados %d arquivos\n", length(arq_rgf_a02)))

# Processar em paralelo
rgf_a02_list <- future_map(
  arq_rgf_a02,
  processar_arquivo_rgf_a02,
  .progress = TRUE,
  .options = furrr_options(seed = TRUE)
)

# Nomeia os dataframes
names(rgf_a02_list) <- basename(arq_rgf_a02) %>% str_remove("\\.xlsx$")

# Coloca cada um no ambiente global
list2env(rgf_a02_list, envir = .GlobalEnv)

cat(sprintf("‚úì RGF A02: %d arquivos importados\n", length(arq_rgf_a02)))
```

## üîê Dados RGF Anexo 03 - Garantias e Contragarantias

```{r importar-dados-rgf-a03}


#| include: false

cat("üì• Importando dados RGF A03 (Garantias)...\n")

# RGF Anexo 3
rgf_a03 <- read_excel(str_c(mes_pasta, "rgf_a03.xlsx"), skip = 5) %>%
  clean_names() %>%
  mutate(
    mes_lancamento = as.numeric(mes_lancamento),
    data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1)
  )

cat(sprintf("‚úì RGF A03: %s registros\n", 
            format(nrow(rgf_a03), big.mark = ".", decimal.mark = ",")))
```

## üí≥ Dados RGF Anexo 04 - Opera√ß√µes de Cr√©dito

```{r importar-dados-rgf-a04}

#| include: false
#| column: screen

cat("üì• Importando dados RGF A04 (Opera√ß√µes Cr√©dito)...\n")

# ============================================================================
# ‚ö° VERS√ÉO OTIMIZADA - IMPORTA√á√ÉO PARALELA
# ============================================================================

arquivos_a04 <- list(
  receitas = str_c(mes_pasta, "rgf_a04_receitas.xlsx"),
  despesas = str_c(mes_pasta, "rgf_a04_despesas.xlsx")
)

# Importar em paralelo
dados_a04_lista <- future_map(
  arquivos_a04,
  function(arquivo) {
    read_excel(arquivo, skip = 5) %>%
      clean_names() %>%
      mutate(
        mes_lancamento = as.numeric(mes_lancamento),
        data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1)
      )
  },
  .progress = TRUE
)

rgf_a04_receitas <- dados_a04_lista$receitas
rgf_a04_despesas <- dados_a04_lista$despesas

cat(sprintf("‚úì RGF A04 Receitas: %s registros\n", 
            format(nrow(rgf_a04_receitas), big.mark = ".", decimal.mark = ",")))
cat(sprintf("‚úì RGF A04 Despesas: %s registros\n", 
            format(nrow(rgf_a04_despesas), big.mark = ".", decimal.mark = ",")))
```

## üí∞ Dados RGF Anexo 05 - Disponibilidades de Caixa

```{r importar-dados-rgf-a05}


#| include: false

cat("üì• Importando dados RGF A05 (Disponibilidades)...\n")

# ============================================================================
# ‚ö° VERS√ÉO OTIMIZADA - IMPORTA√á√ÉO PARALELA
# ============================================================================

# Buscar todos os arquivos rgf_a05
arq_rgf_a05 <- list.files(path = mes_pasta, pattern = 'rgf_a05', full.names = TRUE)

cat(sprintf("   Encontrados %d arquivos\n", length(arq_rgf_a05)))

rgf_a05 <- importar_excel_paralelo(arq_rgf_a05, skip = 5, .progress = TRUE) %>%
  mutate(
    saldo_r_conta_contabil = as.numeric(saldo_r_conta_contabil),
    mes_lancamento = as.numeric(mes_lancamento),
    data_lancamento = ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1)
  )

cat(sprintf("‚úì RGF A05: %s registros (%d arquivos)\n", 
            format(nrow(rgf_a05), big.mark = ".", decimal.mark = ","), 
            length(arq_rgf_a05)))
```

# Fun√ß√µes {#sec-funcoes-aux}

## Aplicar Crit√©rios

```{r}
#| include: false

#' Aplica crit√©rios de filtro e agrupamento a um dataframe
#'
#' @param df Dataframe de entrada com dados fiscais
#' @param criterios Lista nomeada de crit√©rios (cada item com campo 'criterio')
#' @param group_vars Vetor de vari√°veis para agrupamento (opcional)
#' @param save_global Se TRUE, salva resultado no ambiente global com nome autom√°tico (padr√£o: FALSE)
#' @param validate_criteria Se TRUE, valida crit√©rios antes de executar (padr√£o: TRUE)
#'
#' @return Dataframe com resultados agregados por categoria
#'
#' @examples
#' # Uso moderno (recomendado)
#' resultado <- aplicar_criterios(dados_despesa, criterios_rgf_A01)
#' 
#' # Compatibilidade com c√≥digo antigo
#' aplicar_criterios(dados_despesa, criterios_rgf_A01, save_global = TRUE)
#'
aplicar_criterios <- function(df, 
                               criterios, 
                               group_vars = NULL,
                               save_global = TRUE,
                               validate_criteria = TRUE) {
  
  # ============================================================================
  # 1. DETEC√á√ÉO AUTOM√ÅTICA DA M√âTRICA
  # ============================================================================
  metrica <- names(df)[grepl("^(saldo|movim)", names(df), ignore.case = TRUE)][1]
  
  if (is.na(metrica) || length(metrica) == 0) {
    stop("N√£o foi poss√≠vel detectar coluna de m√©trica (saldo_* ou movim_*)")
  }
  
  # ============================================================================
  # 2. CAPTURAR METADADOS DO DATAFRAME
  # ============================================================================
  df_completo <- paste(deparse(substitute(df)), collapse = " ")
  
  # Separar nome da df de eventuais filtros
  if (grepl("%>%", df_completo)) {
    df_nome <- trimws(strsplit(df_completo, "%>%")[[1]][1])
    df_filtros <- paste(strsplit(df_completo, "%>%")[[1]][-1], collapse = " %>% ")
    df_filtros <- trimws(df_filtros)
  } else {
    df_nome <- df_completo
    df_filtros <- NA
  }
  
  # Capturar nome da vari√°vel criterios
  criterios_nome <- deparse(substitute(criterios))
  
  # ============================================================================
  # 3. DEFINIR VARI√ÅVEIS DE AGRUPAMENTO
  # ============================================================================
  if (is.null(group_vars)) {
    group_vars <- c("mes_lancamento", "data_lancamento")
  } else {
    # Garantir que mes_lancamento e data_lancamento estejam inclu√≠dos
    if (!"mes_lancamento" %in% group_vars) {
      group_vars <- c("mes_lancamento", group_vars)
    }
    if (!"data_lancamento" %in% group_vars) {
      group_vars <- c("data_lancamento", group_vars)
    }
  }
  
  # Verificar quais colunas existem na df
  group_vars <- group_vars[group_vars %in% names(df)]
  
  # ============================================================================
  # 4. EXTRAIR METADADOS DOS CRIT√âRIOS
  # ============================================================================
  partes <- strsplit(criterios_nome, "_")[[1]]
  
  if (partes[1] == "criterios") {
    partes <- partes[-1]
  }
  
  relatorio <- if (length(partes) >= 1) partes[1] else NA
  anexo_codigo <- if (length(partes) >= 2) partes[2] else NA
  anexo_nome <- if (length(partes) >= 3) partes[3] else NA
  detalhe <- if (length(partes) >= 4) paste(partes[4:length(partes)], collapse = "_") else NA
  
  # ============================================================================
  # 5. VALIDAR CRIT√âRIOS (OPCIONAL)
  # ============================================================================
  if (validate_criteria) {
    for (cat_nome in names(criterios)) {
      crit <- criterios[[cat_nome]]
      
      # Pular f√≥rmulas matem√°ticas
      if (grepl("\\{[^}]+\\}", crit$criterio)) {
        next
      }
      
      # Tentar parsear para verificar sintaxe
      tryCatch({
        rlang::parse_expr(crit$criterio)
      }, error = function(e) {
        warning(sprintf("‚ö†Ô∏è Crit√©rio inv√°lido em categoria '%s': %s\n   Express√£o: %s", 
                       cat_nome, e$message, crit$criterio))
      })
    }
  }
  
  # ============================================================================
  # 6. APLICAR CRIT√âRIOS (COM RLANG - SEGURO)
  # ============================================================================
  resultado <- map_df(names(criterios), function(categoria) {
    crit <- criterios[[categoria]]
    
    # Pular f√≥rmulas matem√°ticas - ser√£o tratadas em calcular_operacoes
    if (grepl("\\{[^}]+\\}", crit$criterio)) {
      return(data.frame())
    }
    
    # Extrair flag de print do nome da categoria
    if (grepl("_s$", categoria)) {
      print_flag <- "s"
      categoria_limpa <- str_replace(categoria, "_s$", "")
    } else if (grepl("_n$", categoria)) {
      print_flag <- "n"
      categoria_limpa <- str_replace(categoria, "_n$", "")
    } else {
      print_flag <- "s"  # default
      categoria_limpa <- categoria
    }
    
    # ========================================================================
    # üîß CORRE√á√ÉO PRINCIPAL: Usar rlang em vez de eval(parse())
    # ========================================================================
    condicao_expr <- tryCatch({
      # Parsear express√£o de forma segura
      expr <- rlang::parse_expr(crit$criterio)
      
      # Avaliar no contexto do dataframe
      rlang::eval_tidy(expr, data = df)
      
    }, error = function(e) {
      stop(sprintf(
        "‚ùå Erro ao avaliar crit√©rio em categoria '%s':\n   Express√£o: %s\n   Erro: %s", 
        categoria, crit$criterio, e$message
      ))
    })
    
    # Verificar se retornou vetor l√≥gico
    if (!is.logical(condicao_expr)) {
      stop(sprintf(
        "‚ùå Crit√©rio n√£o retornou vetor l√≥gico em categoria '%s':\n   Express√£o: %s\n   Tipo retornado: %s",
        categoria, crit$criterio, class(condicao_expr)[1]
      ))
    }
    
    # ========================================================================
    # 7. APLICAR FILTRO E AGRUPAR
    # ========================================================================
    if (length(group_vars) > 0) {
      resultado_filtrado <- df %>%
        filter(condicao_expr) %>%
        group_by(across(all_of(group_vars))) %>%
        summarise(
          valor = sum(.data[[metrica]], na.rm = TRUE),
          .groups = "drop"
        ) %>%
       mutate(
  categoria = categoria_limpa,
  metrica = metrica,
  dataframe_nome = df_nome,
  dataframe_filtros = df_filtros,
  criterios_nome_completo = criterios_nome,  # ‚Üê ADICIONAR ISTO
  relatorio = relatorio,
  anexo_codigo = anexo_codigo,
  anexo_nome = anexo_nome,
  detalhe = detalhe,
  print = print_flag,
  filtro = crit$criterio
)
    } else {
      resultado_filtrado <- df %>%
        filter(condicao_expr) %>%
        summarise(
          valor = sum(.data[[metrica]], na.rm = TRUE)
        ) %>%
        mutate(
  categoria = categoria_limpa,
  metrica = metrica,
  dataframe_nome = df_nome,
  dataframe_filtros = df_filtros,
  criterios_nome_completo = criterios_nome,  # ‚Üê ADICIONAR ISTO
  relatorio = relatorio,
  anexo_codigo = anexo_codigo,
  anexo_nome = anexo_nome,
  detalhe = detalhe,
  print = print_flag,
  filtro = crit$criterio
)
    }
    
    # ========================================================================
    # üîß CORRE√á√ÉO: Usar str_extract em vez de separate(sep = 2)
    # ========================================================================
    resultado_final <- resultado_filtrado %>%
      mutate(
        # Extrair ordem (1 ou 2 d√≠gitos no in√≠cio)
        ordem = str_extract(categoria, "^\\d{1,2}"),
        # Extrair nome (tudo ap√≥s os d√≠gitos e espa√ßos)
        nome = str_trim(str_remove(categoria, "^\\d{1,2}\\s*"))
      ) %>%
      select(any_of(c("mes_lancamento", "data_lancamento")), everything())
    
    return(resultado_final)
  })
  
  # ============================================================================
  # 8. SALVAR NO AMBIENTE GLOBAL (OPCIONAL)
  # ============================================================================
  if (save_global) {
    novo_nome <- paste0("df_", criterios_nome)
    assign(novo_nome, resultado, envir = .GlobalEnv)
    message("‚úÖ Resultado salvo em vari√°vel global: ", novo_nome)
  }
  
  # ============================================================================
  # 9. RETORNAR RESULTADO
  # ============================================================================
  return(resultado)
}

```

```{r}

consolidar_criterios <- function(save_global = FALSE) {
  
  # ============================================================================
  # 1. OBTER DATAFRAMES DO AMBIENTE GLOBAL
  # ============================================================================
  objetos <- ls(envir = .GlobalEnv)
  df_criterios <- objetos[grepl("^df_criterios", objetos)]
  
  if (length(df_criterios) == 0) {
    warning("‚ö†Ô∏è Nenhuma dataframe com prefixo 'df_criterios' foi encontrada no ambiente global")
    return(data.frame())
  }
  
  message(sprintf("üìä Encontradas %d dataframes para consolidar", length(df_criterios)))
  
  # ============================================================================
  # 2. OBTER E PADRONIZAR DATAFRAMES
  # ============================================================================
  tabelas <- map(df_criterios, ~ get(.x, envir = .GlobalEnv))
  
  # Padronizar tipos de colunas antes de combinar
  tabelas_padronizadas <- map(tabelas, function(tabela) {
    
    # Converter colunas problem√°ticas para character
    if ("dataframe_filtros" %in% names(tabela)) {
      tabela$dataframe_filtros <- as.character(tabela$dataframe_filtros)
      tabela$dataframe_filtros[is.na(tabela$dataframe_filtros)] <- ""
    }
    
    if ("item_informacao_codigo" %in% names(tabela)) {
      tabela$item_informacao_codigo <- as.character(tabela$item_informacao_codigo)
    }
    if ("item_informacao_nome" %in% names(tabela)) {
      tabela$item_informacao_nome <- as.character(tabela$item_informacao_nome)
    }
    
    if ("relatorio" %in% names(tabela)) {
      tabela$relatorio <- as.character(tabela$relatorio)
    }
    if ("anexo_codigo" %in% names(tabela)) {
      tabela$anexo_codigo <- as.character(tabela$anexo_codigo)
    }
    if ("anexo_nome" %in% names(tabela)) {
      tabela$anexo_nome <- as.character(tabela$anexo_nome)
    }
    if ("detalhe" %in% names(tabela)) {
      tabela$detalhe <- as.character(tabela$detalhe)
    }
    
    return(tabela)
  })
  
  # ============================================================================
  # 3. COMBINAR TODAS AS TABELAS (SEM AGRUPAR AINDA)
  # ============================================================================
  resultado_completo <- bind_rows(tabelas_padronizadas)
  
  message(sprintf("‚úÖ Consolidadas %d linhas de dados", nrow(resultado_completo)))
  
  # ============================================================================
  # 4. üîß CORRE√á√ÉO: IDENTIFICAR TODAS AS COLUNAS PARA AGRUPAMENTO
  # ============================================================================
  # Colunas padr√£o que sempre existem
  colunas_padrao <- c("mes_lancamento", "data_lancamento", "ordem", "nome", 
                      "metrica", "dataframe_nome", "dataframe_filtros",
                      "relatorio", "anexo_codigo", "anexo_nome", 
                      "detalhe", "print", "filtro")
  
  # üîß NOVO: Identificar colunas EXTRAS que vieram de group_vars
  todas_colunas <- names(resultado_completo)
  colunas_extras <- setdiff(
    todas_colunas, 
    c(colunas_padrao, "valor", "categoria", "chave")
  )
  
  # Colunas para agrupamento = padr√£o + extras
  colunas_agrupamento <- c(colunas_padrao, colunas_extras)
  
  # Filtrar apenas as que realmente existem
  colunas_agrupamento <- colunas_agrupamento[colunas_agrupamento %in% todas_colunas]
  
  message(sprintf("üìã Agrupando por %d colunas (incluindo vari√°veis customizadas)", 
                  length(colunas_agrupamento)))
  
  # ============================================================================
  # 5. AGRUPAR E SUMARIZAR (PRESERVANDO TODAS AS DIMENS√ïES)
  # ============================================================================
  resultado <- resultado_completo %>%
    group_by(across(all_of(colunas_agrupamento))) %>%
    summarise(valor = sum(valor, na.rm = TRUE), .groups = "drop") %>%
    arrange(mes_lancamento, relatorio, anexo_codigo, detalhe, ordem)
  
  # ============================================================================
  # 6. CRIAR COLUNAS DERIVADAS
  # ============================================================================
  resultado <- resultado %>%
    mutate(
      # Garantir que data_lancamento existe
      data_lancamento = if_else(
        is.na(data_lancamento),
        ceiling_date(ymd(paste0(mes_lancamento, "01")), "month") - days(1),
        data_lancamento
      ),
      # Criar chave √∫nica
      chave = paste0(
        mes_lancamento, "_", 
        tolower(relatorio), "_", 
        tolower(anexo_codigo), "_", 
        tolower(detalhe), "_", 
        ordem
      )
    )
  
  # ============================================================================
  # 7. REORDENAR COLUNAS (PADR√ÉO + EXTRAS + VALOR)
  # ============================================================================
  colunas_ordem <- c(
    "chave", "mes_lancamento", "data_lancamento", 
    "dataframe_nome", "dataframe_filtros", 
    "relatorio", "anexo_codigo", "anexo_nome", 
    "detalhe", "print", "filtro", "metrica"
  )
  
  # Adicionar colunas extras na ordem
  colunas_ordem <- c(colunas_ordem, colunas_extras)
  
  # Adicionar ordem, nome, valor no final
  colunas_ordem <- c(colunas_ordem, "ordem", "nome", "valor")
  
  # Selecionar apenas colunas que existem (sem duplicatas)
  colunas_ordem <- unique(colunas_ordem[colunas_ordem %in% names(resultado)])
  
  resultado <- resultado %>% select(all_of(colunas_ordem))
  
  # ============================================================================
  # 8. SALVAR NO AMBIENTE GLOBAL (OPCIONAL)
  # ============================================================================
  if (save_global) {
    assign("df_criterios_consolidado", resultado, envir = .GlobalEnv)
    message("‚úÖ Dados consolidados salvos em: df_criterios_consolidado")
  }
  
  # ============================================================================
  # 9. RETORNAR RESULTADO
  # ============================================================================
  return(resultado)
}


```

## Formata√ß√£o de N√∫meros

```{r formatar_numero}
#| echo: true
#| include: false

#' Formatar n√∫meros para exibi√ß√£o brasileira
#' @param x Vetor num√©rico a ser formatado
#' @return String formatada com ponto como separador de milhares e v√≠rgula como decimal
formatar_numero <- function(x) {
  format(x, big.mark = ".", decimal.mark = ",", scientific = FALSE, nsmall = 2)
}

# Teste da fun√ß√£o
exemplo_numero <- 1234567.89
print(paste("N√∫mero original:", exemplo_numero))
print(paste("N√∫mero formatado:", formatar_numero(exemplo_numero)))
```

## Formata√ß√£o de Tabelas

```{r dt_formatada}
#| echo: true
#| include: false

#' Criar tabela DT formatada com totais
#' @param df Data frame a ser formatado
#' @param grupo Vetor com nomes das colunas de agrupamento (n√£o num√©ricas)
#' @return Objeto DT formatado
dt_formatada <- function(df, grupo) {
  # library(DT)
  # library(janitor)
  
  datatable(
    df %>% adorn_totals("row"), 
    rownames = FALSE,
    extensions = 'Buttons',
    options = list(
      lengthMenu = c(5, 10, 25, 50, 100),
      dom = 'Bfrtip',
      buttons = list('excel')
    )
  ) %>% 
  formatRound(
    setdiff(df %>% colnames(), grupo), 
    2, 
    mark = ".", 
    dec.mark = ","
  ) %>% 
  DT::formatStyle(
    columns = colnames(.$x$data), 
    fontSize = '75%'
  )
}

print("‚úÖ Fun√ß√£o dt_formatada definida")
```

## Tabela Pivotada

```{r tabela_pivotada}
#| echo: true
#| include: false

#' Pivotar tabela a partir dos itens de informa√ß√£o
#' @param df Data frame com dados
#' @param grupo Vetor com nomes das colunas de agrupamento
#' @return Data frame pivotado e sumarizado
tabela_pivotada <- function(df, grupo) {
  # library(dplyr)
  # library(tidyr)
  
  # Obter itens √∫nicos de informa√ß√£o
  itens <- df$item_informacao_nome %>% unique() %>% na.omit()
  
  # Verificar se a coluna principal existe
  if (!"saldo_r_item_informacao" %in% names(df)) {
    stop("Coluna 'saldo_r_item_informacao' n√£o encontrada no data frame")
  }
  
  # Pivotar e sumarizar apenas a coluna num√©rica
  df %>% 
    group_by(!!!syms(grupo)) %>% 
    pivot_wider(
      names_from = item_informacao_nome, 
      values_from = saldo_r_item_informacao,
      values_fill = 0
    ) %>% 
    # Sumarizar apenas as colunas que correspondem aos itens (num√©ricas)
    summarise(
      across(all_of(itens), ~ sum(.x, na.rm = TRUE)),
      .groups = "drop"
    )
}


```

## Calcular opera√ß√µes

```{r calcular_operacoes}
#| echo: true
#| include: false
# Fun√ß√£o para realizar opera√ß√µes matem√°ticas usando as chaves √∫nicas
calcular_operacoes <- function(dados_consolidados = NULL, ...) {
  
  # Se dados n√£o fornecidos, usar consolidar_criterios()
  if (is.null(dados_consolidados)) {
    dados_consolidados <- consolidar_criterios()
  }
  
  # Capturar as opera√ß√µes passadas como argumentos
  operacoes <- list(...)
  
  if (length(operacoes) == 0) {
    stop("Nenhuma opera√ß√£o foi especificada")
  }
  
  # Criar um lookup table para facilitar a busca
  lookup_valores <- setNames(dados_consolidados$valor, dados_consolidados$chave)
  
  # Processar cada opera√ß√£o
  resultados <- map(names(operacoes), function(nome_operacao) {
    operacao <- operacoes[[nome_operacao]]
    
    if (is.character(operacao)) {
      # Opera√ß√£o simples: apenas a f√≥rmula como string
      formula <- operacao
    } else if (is.list(operacao) && !is.null(operacao$formula)) {
      # Opera√ß√£o estruturada
      formula <- operacao$formula
    } else {
      stop(paste("Opera√ß√£o", nome_operacao, "deve ser uma string (f√≥rmula) ou list com 'formula'"))
    }
    
    formula_processada <- formula
    
    # Encontrar todas as chaves na f√≥rmula (padr√£o: YYYYMM_texto_texto_texto_NN)
    chaves <- str_extract_all(formula, "[0-9]{6}_[a-zA-Z0-9/_]+_[a-zA-Z0-9/_]+_[a-zA-Z0-9/_]+_[0-9]+")[[1]]
    
    for (chave in chaves) {
      valor <- ifelse(chave %in% names(lookup_valores), 
                      lookup_valores[[chave]], 
                      0)
      # Converter para num√©rico e usar format cient√≠fico se necess√°rio para evitar v√≠rgulas
      valor_numerico <- as.numeric(valor)
      # Usar options para garantir nota√ß√£o sem v√≠rgula
      valor_limpo <- format(valor_numerico, scientific = FALSE, big.mark = "")
      
      formula_processada <- str_replace(formula_processada, 
                                        fixed(chave), 
                                        valor_limpo)
    }
    
    # Avaliar a express√£o matem√°tica
    resultado_calculo <- eval(parse(text = formula_processada))
    
    return(list(
      operacao = nome_operacao,
      formula_original = formula,
      formula_processada = formula_processada,
      resultado = resultado_calculo
    ))
  })
  
  names(resultados) <- names(operacoes)
  return(resultados)
}
```

# RGF - Relat√≥rio de Gest√£o Fiscal

# üìã RGF Anexo 01 (Despesa com Pessoal)

```{r}
#| code-fold: true
# ==============================================================================
# CRIT√âRIOS RGF ANEXO 01 - REORGANIZADO NA ORDEM OFICIAL
# ==============================================================================
# Numera√ß√£o compat√≠vel com separate(categoria, sep = 2):
# - Grupo I: 11, 12, 13, 14, 15, 16, 17
# - Grupo II: 21, 22, 23, 24
# ==============================================================================

criterios_rgf_A01_pessoal_rgf <- list(
  
  # ===========================================================================
  # GRUPO I - COMPONENTES DA DESPESA BRUTA (ordem 1x)
  # ===========================================================================
  
  # 11 - VENCIMENTOS, VANTAGENS E OUTRAS DESPESAS VARI√ÅVEIS
  `11  Vencimentos, Vantagens e Outras Despesas Vari√°veis` = list(
    criterio = "
    grupo_despesa_codigo_grupo == '1' &
    !elemento_despesa_codigo %in% c('01', '03', '34') &
    
    # EXCLUS√ÉO: Filtro Obriga√ß√µes Patronais vg2024
    !(
      (substr(natureza_despesa_detalhada_codigo, 1, 1) == '3' &
       grupo_despesa_codigo_grupo == '1' &
       elemento_despesa_codigo == '92' &
       ((modalidade_aplicacao_codigo == '90' & natureza_despesa_detalhada_codigo %in% c('31909213', '31909207')) |
        (modalidade_aplicacao_codigo == '91' & natureza_despesa_detalhada_codigo == '31919213'))) |
      elemento_despesa_codigo %in% c('13', '07')
    ) &
    
    # EXCLUS√ÉO: Filtro Pessoal ATIVO - Benef√≠cios Previdenci√°rios v2024
    !(
      (substr(natureza_despesa_detalhada_codigo, 1, 1) == '3' &
       grupo_despesa_codigo_grupo == '1' &
       elemento_despesa_codigo == '92' &
       natureza_despesa_detalhada_codigo == '31909205' &
       modalidade_aplicacao_codigo %in% c('90', '91')) |
      str_detect(natureza_despesa_detalhada_codigo, '0599')
    ) &
    
    # EXCLUS√ÉO: Filtro - Anexo 1 - Termos de Outros Inativos vg2024
    !str_detect(natureza_despesa_detalhada_nome, '\\\\bAPOSENT|\\\\bINAT|\\\\bREFORMA|\\\\bPENS|LEI 7\\\\.963/1989') &
    
    # EXCLUS√ÉO: Filtro Pessoal INATIVO - Benef√≠cios Previdenci√°rios vg2024
    !(
      grupo_despesa_codigo_grupo == '1' &
      elemento_despesa_codigo == '05' &
      (str_detect(natureza_despesa_detalhada_codigo, '0505') | 
       str_detect(natureza_despesa_detalhada_codigo, '0506') |
       str_detect(natureza_despesa_detalhada_codigo, '0507') |
       str_detect(natureza_despesa_detalhada_codigo, '0508')) &
      elemento_despesa_codigo %in% c('05', '08', '09', '17', '91', '92', '94')
    )
    "
  ),
  
  # 12 - OBRIGA√á√ïES PATRONAIS
  `12  Obriga√ß√µes Patronais` = list(
    criterio = "grupo_despesa_codigo_grupo == '1' & elemento_despesa_codigo %in% c('13', '07') | natureza_despesa_detalhada_codigo %in% c('31909213', '31919213', '31909207')"
  ),
  
  # 13 - APOSENTADORIAS, RESERVA E REFORMAS
  `13  Aposentadorias, Reserva e Reformas` = list(
    criterio = "grupo_despesa_codigo_grupo == '1' & elemento_despesa_codigo == '01' | natureza_despesa_detalhada_codigo %in% c('31901702', '31909109', '31909112', '31909115', '31909118', '31909123', '31909124', '31909128', '31909129', '31909201', '31909403', '31909404', '31909413', '31909414')"
  ),
  
  # 14 - PENS√ïES
  `14  Pens√µes` = list(
    criterio = "grupo_despesa_codigo_grupo == '1' & (elemento_despesa_codigo == '03' | natureza_despesa_detalhada_codigo %in% c('31909110', '31909113', '31909116', '31909119', '31909131', '31909136', '31909137', '31909130', '31909203', '31909220', '31909221', '31909406', '31909413'))"
  ),
  
  # 15 - OUTRAS DESPESAS COM INATIVOS
  `15  Outras Despesas com Inativos` = list(
    criterio = "grupo_despesa_codigo_grupo == '1' & elemento_despesa_codigo %in% c('05', '08', '09', '17', '31', '32') & str_detect(natureza_despesa_detalhada_nome, 'APOSENT|INAT|REFORMA|PEN|LEI 7\\\\.963/1989') & !(str_detect(natureza_despesa_detalhada_codigo, '0599') & natureza_despesa_detalhada_codigo %in% c('31909205', '31919205')) & !(str_detect(natureza_despesa_detalhada_codigo, '0505') | str_detect(natureza_despesa_detalhada_codigo, '0506') | str_detect(natureza_despesa_detalhada_codigo, '0507') | str_detect(natureza_despesa_detalhada_codigo, '0508'))"
  ),
  
  # 16 - OUTRAS DESPESAS DE PESSOAL - TERCEIRIZA√á√ÉO
  `16  Outras Despesas de Pessoal - Terceiriza√ß√£o` = list(
    criterio = "grupo_despesa_codigo_grupo %in% c('1', '3') & elemento_despesa_codigo == '34'"
  ),
  
  # 17 - DESPESA COM PESSOAL N√ÉO EXECUTADA OR√áAMENTARIAMENTE
  `17  Despesa com Pessoal n√£o Executada Or√ßamentariamente` = list(
    criterio = "FALSE"  # Placeholder - ajustar conforme necess√°rio
  ),
  
  # ===========================================================================
  # GRUPO II - DESPESAS N√ÉO COMPUTADAS (ordem 2x)
  # ===========================================================================
  
  # 21 - INDENIZA√á√ïES POR DEMISS√ÉO E INCENTIVOS
  `21  Indeniza√ß√µes por Demiss√£o e Incentivos` = list(
    criterio = "
    grupo_despesa_codigo_grupo == '1' &
    elemento_despesa_codigo == '94' &
    !(
      fonte_recursos_codigo %in% c('023', '024', '055', '056') &
      str_detect(natureza_despesa_detalhada_nome, 'APOSENT|INAT|REFORMA|PEN|LEI 7\\\\.963/1989')
    )
    "
  ),
  
  # 22 - DECORRENTES DE DECIS√ÉO JUDICIAL
  `22  Decorrentes de Decis√£o Judicial` = list(
    criterio = "
    grupo_despesa_codigo_grupo == '1' &
    elemento_despesa_codigo == '91' &
    !(
      fonte_recursos_codigo %in% c('023', '024', '055', '056') &
      str_detect(natureza_despesa_detalhada_nome, 'APOSENT|INAT|REFORMA|PEN|LEI 7\\\\.963/1989')
    )
    "
  ),
  
  # 23 - DESPESAS DE EXERC√çCIOS ANTERIORES
  `23  Despesas de Exerc√≠cios Anteriores` = list(
    criterio = "
    grupo_despesa_codigo_grupo == '1' &
    elemento_despesa_codigo == '92' &
    !(
      fonte_recursos_codigo %in% c('023', '024', '055', '056') &
      str_detect(natureza_despesa_detalhada_nome, 'APOSENT|INAT|REFORMA|PEN|LEI 7\\\\.963/1989')
    )
    "
  ),
  
  # 24 - INATIVOS E PENSIONISTAS COM RECURSOS VINCULADOS
  `24  Inativos e Pensionistas com Recursos Vinculados` = list(
    criterio = "
    grupo_despesa_codigo_grupo == '1' &
    fonte_recursos_codigo %in% c('023', '024', '055', '056') &
    (
      elemento_despesa_codigo %in% c('01', '03') |
      (
        elemento_despesa_codigo %in% c('05', '08', '09', '17', '91', '92', '94') &
        str_detect(natureza_despesa_detalhada_nome, 'APOSENT|INAT|REFORMA|PEN|LEI 7\\\\.963/1989')
      )
    )
    "
  )
)
```

```{r}
#| code-fold: true
# ===============================================================================
# MUTATE RGF ANEXO 1 - CATEGORIZA√á√ÉO POR REGI√ÉO/PODER
# ===============================================================================

# Adicionar coluna de categoriza√ß√£o baseada nos grupos personalizados
rgf_a01 <- rgf_a01 %>%
  mutate(
    categoria_pessoal = case_when(
      
      # DESPESAS RESSALVADAS (aplicar primeiro - mais espec√≠fico)
      natureza_despesa_detalhada_codigo %in% c(
        "31900503", "31900504", "31900505", "31900506", 
        "31900507", "31900508", "31900501", "31900502"
      ) ~ "ressalvadas",
      
      # PODER EXECUTIVO FEDERAL (aplicar filtros espec√≠ficos depois)
      unidade_orcamentaria_codigo == "73113" & 
      plano_orcamentario_codigo_po == "0004" &
      acao_governo_codigo %in% c("0179", "0181", "214H") ~ "AP",
      
      unidade_orcamentaria_codigo == "73113" & 
      plano_orcamentario_codigo_po == "0003" & 
      acao_governo_codigo %in% c("0179", "0181", "214H") ~ "RR",
      
      unidade_orcamentaria_codigo == "73901" ~ "DF",
      
      uo_poder == "0" &
      !uo_orgao_maximo_codigo %in% c("34000","59000") ~ "executivo",
        
      
      # PODER EXECUTIVO FEDERAL (restante - ap√≥s aplicar filtros espec√≠ficos)
      # Assumindo que existe campo de poder ou similar
      TRUE ~ "demais"
    )
  )

pessoal <- aplicar_criterios(rgf_a01 %>% filter(item_informacao_codigo == "25") , criterios_rgf_A01_pessoal_rgf,         group_vars = c("categoria_pessoal"))


pessoal_rp <- aplicar_criterios(rgf_a01 %>% filter(item_informacao_codigo == "27"  ) , criterios_rgf_A01_pessoal_rgf,         group_vars = c("categoria_pessoal"))

categorias <- c("AP", "DF", "RR", "executivo")

categorias_rp <- c( "DF",  "executivo")
```

```{r}
#| code-fold: true




gerar_tabela_pessoal <- function(
  data_pessoal, 
  data_pessoal_rp, 
  categoria_filtro, 
  formato_numero = TRUE
) {
  
  # --------------------------------------------------------------------------
  # PREPARAR DADOS DE PESSOAL (item 25)
  # --------------------------------------------------------------------------
  pessoal_prep <- data_pessoal %>% 
    filter(categoria_pessoal == categoria_filtro) %>% 
    mutate(
    mes_ano = toupper(format(data_lancamento, "%b/%y")),
      tipo = "pessoal"
    )
  
  # --------------------------------------------------------------------------
  # PREPARAR DADOS DE RP (item 27) - se existirem
  # --------------------------------------------------------------------------
  rp_prep <- data_pessoal_rp %>% 
    filter(categoria_pessoal == categoria_filtro)
  
  if (nrow(rp_prep) > 0) {
    rp_prep <- rp_prep %>%
      mutate(
        mes_ano = "RPNP",
        tipo = "rp"
      )
  }
  
  # --------------------------------------------------------------------------
  # RBIND: COMBINAR PESSOAL + RP
  # --------------------------------------------------------------------------
  dados_combinados <- bind_rows(pessoal_prep, rp_prep)
  
  # --------------------------------------------------------------------------
  # CRIAR TABELA PIVOTADA
  # --------------------------------------------------------------------------
  # Ordenar meses
  dados_combinados <- dados_combinados %>%
    arrange(data_lancamento) %>%
    mutate(mes_ano = factor(mes_ano, levels = unique(mes_ano)))
  
  tabela <- dados_combinados %>% 
    group_by(mes_ano, categoria) %>% 
    summarise(valor = sum(valor / 1000), .groups = "drop") %>% 
    pivot_wider(names_from = mes_ano, values_from = valor, values_fill = 0)
  
  # --------------------------------------------------------------------------
  # ADICIONAR COLUNA DE TOTAL DOS 12 MESES (excluindo RPNP)
  # --------------------------------------------------------------------------
  # Identificar colunas de meses (todas exceto categoria e RPNP)
  colunas_meses <- setdiff(names(tabela), c("categoria", "RPNP"))
  
  # Calcular total dos √∫ltimos 12 meses
  tabela <- tabela %>%
    mutate(
      `TOTAL (√öLTIMOS 12 MESES)` = rowSums(select(., all_of(colunas_meses)), na.rm = TRUE)
    )
  
  # Reordenar colunas: categoria, meses, total, RPNP (se existir)
  if ("RPNP" %in% names(tabela)) {
    tabela <- tabela %>%
      select(categoria, all_of(colunas_meses), `TOTAL (√öLTIMOS 12 MESES)`, RPNP)
  } else {
    tabela <- tabela %>%
      select(categoria, all_of(colunas_meses), `TOTAL (√öLTIMOS 12 MESES)`)
  }
  
  # --------------------------------------------------------------------------
  # CRIAR DATATABLE (sem linha de totais)
  # --------------------------------------------------------------------------
  dt <- datatable(
    tabela,
    caption = paste("Categoria:", categoria_filtro),
    rownames = FALSE,
    options = list(
      pageLength = -1,
      scrollX = TRUE,
      dom = 'ft'
    )
  )
  
  if (formato_numero) {
    colunas_numericas <- which(sapply(tabela, is.numeric))
    
    dt <- dt %>% 
      formatRound(
        columns = colunas_numericas, 
        digits = 0, 
        mark = ".",
        dec.mark = ","
      )
  }
  
  return(dt)
}


```

```{r}
#| code-fold: true
#| column: screen

gerar_tabela_pessoal(pessoal, pessoal_rp, "executivo")

```

```{r}
#| code-fold: true
#| column: screen

gerar_tabela_pessoal(pessoal, pessoal_rp, "AP")
```

```{r}
#| code-fold: true
#| column: screen

gerar_tabela_pessoal(pessoal, pessoal_rp, "RR")

```

```{r}
#| code-fold: true
#| column: screen

gerar_tabela_pessoal(pessoal, pessoal_rp, "DF")
```

```{r}
rgf_a01 %>%
            filter(
              grupo_despesa_codigo_grupo == '1' &
                !elemento_despesa_codigo %in% c('01', '03', '34') &
                !(elemento_despesa_codigo %in% c('13', '07') &
                    natureza_despesa_detalhada_codigo %in% c('31909213', '31909207')) &
                !(str_detect(natureza_despesa_detalhada_codigo, '0599') &
                    natureza_despesa_detalhada_codigo %in% c('31909205', '31919205')) &
                !str_detect(natureza_despesa_detalhada_nome, 'APOSENT|INAT|REFORMA|PEN|LEI 7.963/1989') & !elemento_despesa_codigo %in% c('05', '08', '09', '17', '31', '32') &
                !(str_detect(natureza_despesa_detalhada_codigo, '0505') | str_detect(natureza_despesa_detalhada_codigo, '0506') | str_detect(natureza_despesa_detalhada_codigo, '0507') | str_detect(natureza_despesa_detalhada_codigo, '0508'))) %>% group_by( categoria_pessoal) %>% summarise(movim_liquido_r_item_informacao = sum(movim_liquido_r_item_informacao))
```

DESCOBERTA IMPORTANTE: O c√≥digo de classifica√ß√£o de falsos positivos estava ERRADO! As PENS√ïES verdadeiras (R\$ 56,46B) foram classificadas como falso positivo porque o padr√£o \\bPENS n√£o est√° capturando corretamente. Situa√ß√£o real:

PEN captura 56 naturezas totalizando R\$ 194,21B Dessas, \~R\$ 137,75B s√£o PENS√ïES VERDADEIRAS E \~R\$ 56,46B s√£o compensa√ß√µes/depend√™ncias/penosas (falsos positivos)

Principais problemas identificados:

REFORMA - R\$ 1,19M em "REFORMA AGR√ÅRIA" (falso positivo confirmado) PEN - R\$ 3,84B em "COMPENSA√á√ïES" (falso positivo confirmado) PEN - R\$ 137,75B em PENS√ïES (s√£o VERDADEIROS, n√£o falsos!)

An√°lise do print do TG: O Tesouro Gerencial usa o operador "Cont√©m" que √© equivalente ao nosso padr√£o sem word boundaries, confirmando que eles t√™m o mesmo

# üìã RGF Anexo 02 (D√≠vida Consolidada L√≠quida)

```{r}
#| code-fold: true
# ===============================================================================
# CRIT√âRIOS RGF ANEXO 02 - DCL (VERS√ÉO FINAL CORRIGIDA)
# LISTAS ORGANIZADAS POR BASE DE DADOS
# ===============================================================================

# ===============================================================================
# BASE: rgf_a02precatorios
# Filtros TG: Or√ßamento Fiscal,  Contas espec√≠ficas
# CORRE√á√ÉO: A√ß√£o 0Z01 APENAS se UO = 71103
# ===============================================================================
criterios_rgf_A02_dcl_precatorios <- list(
  
  `08 Precat√≥rios posteriores a 05/05/2000` = list(
    criterio = "
    conta_contabil_numero != c('622130400') &
    acao_governo_codigo %in% c('0005', '00U9', '00UP', '0EC8', '0EC7', '00WU') |
    (unidade_orcamentaria_codigo == '71103' & acao_governo_codigo == '0Z01')
    "
  ),
  
    `38 Precat√≥rios posteriores a 05/05/2000 sem a√ß√£o 0005 e 0EC7` = list(
    criterio = "
    conta_contabil_numero == c('622130400') & 
    acao_governo_codigo %in% c( '0005', '0EC7') |
    (unidade_orcamentaria_codigo == '71103' & acao_governo_codigo == '0Z01')
    "
  )
)



# ===============================================================================
# BASE: rgf_a02_rp_exceto_170600
# Filtros TG: Contas espec√≠ficas,  UG != 170600, A√ß√£o != 0005
# ===============================================================================
criterios_rgf_A02_dcl_rp_exceto_170600 <- list(
  
  `25 Restos a pagar processados parte 1` = list(
    criterio = "
    TRUE
    "
  )
)

# ===============================================================================
# BASE: rgf_a02_rp_todas_ugs
# Filtros TG: Contas espec√≠ficas,  A√ß√£o != 0005
# ===============================================================================
criterios_rgf_A02_dcl_rp_todas_ugs <- list(
  
  `25 Restos a pagar processados parte 2` = list(
    criterio = "
    TRUE
    "
  )
)

# ===============================================================================
# BASE: rgf_a02_ug_170512
# Filtros TG: Or√ßamento Fiscal,  UG = 170512
# ===============================================================================
criterios_rgf_A02_dcl_ug_170512 <- list(
  
  `09 D√≠vida assumida pela Uni√£o` = list(
    criterio = "
    conta_contabil_numero %in% c('218912600', '228911600', '227310401') &
    isf_lancamento == 'P' &
    conta_corrente != 'PF1705118'
    "
  ),
  
  `17 D√≠vidas renegociadas dedu√ß√£o` = list(
    criterio = "
    conta_contabil_numero %in% c('121110301', '112410100', '121110318', '112410600', 
                                '121140301', '121150301', '112440100', '112450100', 
                                '121140318', '121150318', '112440600', '112450600', 
                                '112410401', '112450401', '112440401', '121249818', 
                                '113814200', '113844200', '113854200') &
    (entidade_c_cor_numero %in% c('PF1705320', 'PF1705524', 'PF1705528', 'PF1705546', 
                                 'PF1705547', 'PF1705548', 'PF1705406', 'PF1705525', 
                                 'PF1705529', 'PF1705544', 'PF1705545') |
     grepl('9\\\\.496/97', entidade_c_cor_nome) |
     grepl('2\\\\.185/2001', entidade_c_cor_nome))
    "
  ),
  
  `18 Cr√©ditos Lei 8.727/93 dedu√ß√£o` = list(
    criterio = "
    conta_contabil_numero %in% c('121110301', '112410100', '121110318', '112410600', 
                                '121140301', '121150301', '112440100', '112450100', 
                                '121140318', '121150318', '112440600', '112450600', 
                                '112410401', '121219818', '112450401', '112440401', 
                                '121249818', '113814200', '113844200', '113854200') &
    (entidade_c_cor_numero %in% c('PF1705109', 'PF1705536', 'TN0000016', 'TN0000017') |
     grepl('8\\\\.727/93', entidade_c_cor_nome))
    "
  ),
  
  `19 D√≠vida externa renegociada dedu√ß√£o` = list(
    criterio = "
    conta_contabil_numero %in% c('121110301', '112410100', '121110318', '112410600', 
                                '121140301', '121150301', '112440100', '112450100', 
                                '121140318', '121150318', '112440600', '112450600', 
                                '112410401', '121219818', '112450401', '112440401', 
                                '121249818', '113844200', '113814200', '113854200', 
                                '121259818') &
    (entidade_c_cor_numero %in% c('PF1705104', 'PF1705114', 'PF1705117', 'PF1705521', 
                                 'PF1705534', 'PF1705116', 'PF1705531', 'PF1705532', 
                                 'PF1705113', 'PF1701536', 'PF1705520', 'PF1705533', 
                                 'PF1705464', 'PF1705534', 'PF1705119', 'PF1705384') |
     grepl('DMLP', entidade_c_cor_nome) |
     grepl('FRANCA|FRAN√áA', entidade_c_cor_nome) |
     grepl('EXTER', entidade_c_cor_nome) |
     grepl('MF 030', entidade_c_cor_nome) |
     grepl('BIB', entidade_c_cor_nome))
    "
  ),
  
  `20 Demais d√≠vidas renegociadas dedu√ß√£o` = list(
    criterio = "
    conta_contabil_numero %in% c('121110301', '112410100', '121110318', '112410600', 
                                '121140301', '121150301', '112440100', '112450100', 
                                '121140318', '121150318', '112440600', '112450600', 
                                '112410401', '112450401', '112440401', '121249818', 
                                '113844200', '113814200', '113854200', '121259818')
    "
  ),
  
  `21 Ajustes para perdas (positivo)` = list(
    criterio = "
    conta_contabil_numero %in% c('112940401', '112950401', '113940101', '112910401', 
                                '113950101', '121119902', '121149904', '121159904', 
                                '121119904', '121249903', '121259903')
    "
  )
)

# ===============================================================================
# BASE: rgf_a02_creditos_bancarios
# Filtros TG: Or√ßamento Fiscal,  UG IN (170705, 170526, 170700)
# ===============================================================================
criterios_rgf_A02_dcl_creditos_bancarios <- list(
  
  `22 Outros cr√©ditos banc√°rios dedu√ß√£o` = list(
    criterio = "
    conta_contabil_numero %in% c('112410301', '112410303', '112440301', '112450301', 
                                '112440303', '112450303', '112410100', '121110301', 
                                '121110314', '121110308', '121140301', '121150301', 
                                '121140308', '121150308', '112411300', '121110316', 
                                '121110320', '112410302', '112410304', '112410201', 
                                '112410203', '112410403', '121110312')
    "
  ),
  
  `23 Outros cr√©ditos banc√°rios ajustes (positivo)` = list(
    criterio = "
    conta_contabil_numero %in% c('112910401', '121119904', '121119907', '112910403')
    "
  )
)

# ===============================================================================
# BASE: rgf_a02_entidade
# Filtros TG: Or√ßamento Fiscal,  Contas espec√≠ficas
# ===============================================================================
criterios_rgf_A02_dcl_entidade <- list(
  
  `01 D√≠vida mobili√°ria TN interna` = list(
    criterio = "
    conta_contabil_numero %in% c('899913900', '899913901', '899913902', '899913903', 
                                '899913904', '899913905', '899913906') &
    entidade_c_cor_numero %in% c('DP1000001', 'DP1400001', 'DP1500001', 'DP1700001', 
                                'DP1800001', 'DP2000001', 'DP2300007', 'DP2400001', 
                                'DP2600001', 'DP2800001', 'DP3000001', 'DP3400001', 
                                'DP5000001', 'DP5500001', 'DP5800001', 'DP6100001', 
                                'DP6200001', 'DP6300001', 'DP6600001', 'DP7000001', 
                                'DP8000001', 'DP9000001', 'DP9102001', 'DP1200001')
    "
  ),
  
  `03 D√≠vida mobili√°ria do TN (em BCB)` = list(
    criterio = "
    conta_contabil_numero %in% c('899913901', '899913902', '899913907', '899913908') &
    entidade_c_cor_numero %in% c('DP1500010', 'DP1700010', 'DP1800010', 'DP2300010', 
                                'DP5500010', 'DP7000010', 'DP9000010', 'DP3201450')
    "
  ),
  
  `04 D√≠vida securitizada` = list(
    criterio = "
    (conta_contabil_numero %in% c('899913900', '899913901', '899913902', '899913903', 
                                 '899913904', '899913905', '899913906') &
     entidade_c_cor_numero %in% c('DP3100001', 'DP3200001', 'DP3200002', 'DP3201031', 
                                 'DP3201032', 'DP3201059', 'DP3201077', 'DP3201078', 
                                 'DP3201080', 'DP3201081', 'DP3201145', 'DP3201202', 
                                 'DP3201222', 'DP3201228', 'DP3201233', 'DP3201250', 
                                 'DP3201256', 'DP3201257', 'DP3201258', 'DP3201259', 
                                 'DP3201260', 'DP3201262', 'DP3201271', 'DP3201272', 
                                 'DP3201275', 'DP3201276', 'DP3201277', 'DP3201280', 
                                 'DP3201281', 'DP3201296', 'DP3201299', 'DP3201362', 
                                 'DP3201368', 'DP3201378', 'DP3201390')) |
    conta_contabil_numero %in% c('212110202', '222110102')
    "
  )
)

# ===============================================================================
# BASE: rgf_a02_aplicacao_titulos_publicos
# Filtros TG: Or√ßamento Fiscal,  √ìrg√£o UGE != 25901,
#             Tipo Admin IN (3,4,5,6,8), Conta come√ßa com 1111150
# ===============================================================================
criterios_rgf_A02_dcl_aplicacao_titulos_publicos <- list(
  
  `02 Aplica√ß√£o em t√≠tulos p√∫blicos` = list(
    criterio = "
    !conta_contabil_numero %in% c('111115005', '111115011', '111115012')
    "
  )
)

# ===============================================================================
# BASE: rgf_a02_balancete
# Filtros TG: Or√ßamento Fiscal, M√™s AGO/2025
# ===============================================================================
criterios_rgf_A02_dcl_balancete <- list(
  
  `05 D√≠vida mobili√°ria externa` = list(
    criterio = "
    conta_contabil_numero %in% c('899913903', '899913904')
    "
  ),
  
  `06 Opera√ß√µes de equaliza√ß√£o cambial` = list(
    criterio = "
    conta_contabil_numero %in% c('218912902', '218942902', '218952902', '218912901')
    "
  ),
  
  `07 Demais d√≠vidas contratuais` = list(
    criterio = "
    isf_lancamento == 'P' &
    conta_contabil_numero %in% c(
      '222210200', '212210300', '222110200', '212110301', '212110303', '212510103',
      '212140303', '212150303', '212540103', '212550103', '212140301', '212150301',
      '217310301', '217310602', '217350402', '227310301', '212110700', '212210601',
      '212310201', '212310202', '212410201', '222310101', '222310102', '222410101',
      '217710101', '227710101', '227310401'
    )
    "
  ),
  
  `10 Passivos por insufici√™ncia de recursos` = list(
    criterio = "
    conta_contabil_numero %in% c('213110400', '211110101', '214419800', '223110100', 
                                 '211210100', '213140400', '213150400', 
                                 '214119900', '211459800', '211419800') &
    isf_lancamento == 'P'
    "
  ),
  
  `11 Dep√≥sitos do TN (em BCB) dedu√ß√£o` = list(
    criterio = "
    startsWith(conta_contabil_numero, '1111102') |
    startsWith(conta_contabil_numero, '1111103') |
    startsWith(conta_contabil_numero, '1111104')
    "
  ),
  
  `12 Dep√≥sitos √† vista dedu√ß√£o` = list(
    criterio = "
    startsWith(conta_contabil_numero, '1112102') |
    startsWith(conta_contabil_numero, '1112103') |
    startsWith(conta_contabil_numero, '1112150') |
    startsWith(conta_contabil_numero, '1112152')
    "
  ),
  
  `24 Resultado positivo TN/BCB dedu√ß√£o` = list(
    criterio = "
    conta_contabil_numero %in% c('113813001', '113813002')
    "
  ),
  
  `26 D√≠vida mobili√°ria TN interna (intra) dedu√ß√£o` = list(
    criterio = "
    conta_contabil_numero == '222120101'
    "
  )
)

# ===============================================================================
# BASE: rgf_a02_balancete_fat
# Filtros TG: Or√ßamento Fiscal,  UG = 380916
# ===============================================================================
criterios_rgf_A02_dcl_balancete_fat <- list(
  
  `13 Disponibilidade FAT dedu√ß√£o` = list(
    criterio = "
    startsWith(conta_contabil_numero, '1111119') |
    startsWith(conta_contabil_numero, '1124103') |
    startsWith(conta_contabil_numero, '1135407') |
    startsWith(conta_contabil_numero, '1135113') |
    startsWith(conta_contabil_numero, '1135115') |
    startsWith(conta_contabil_numero, '1124101') |
    startsWith(conta_contabil_numero, '1135111') |
    startsWith(conta_contabil_numero, '1135107') |
    startsWith(conta_contabil_numero, '11121') |
    startsWith(conta_contabil_numero, '1135114') |
    startsWith(conta_contabil_numero, '1135112') |
    startsWith(conta_contabil_numero, '1135116') |
    startsWith(conta_contabil_numero, '1211503') |
    startsWith(conta_contabil_numero, '1211403') |
    startsWith(conta_contabil_numero, '1211103') |
    startsWith(conta_contabil_numero, '1135507') |
    startsWith(conta_contabil_numero, '1212105') |
    conta_contabil_numero %in% c('111115009', '111115011', '111115014', 
                                 '111115015', '111115016', '111115006')
    "
  )
)

# ===============================================================================
# BASE: rgf_a02_balancete_deducoes_depositos_a_vista
# Filtros TG: Or√ßamento Fiscal,  √ìrg√£o != 25901, UG != 380916
# Contas: 1111119* (demais contas banc√°rias)
# ===============================================================================
criterios_rgf_A02_dcl_balancete_deducoes_depositos_a_vista <- list(
  
  `12 Dep√≥sitos √† vista dedu√ß√£o` = list(
    criterio = "
    startsWith(conta_contabil_numero, '1111119')
    "
  )
)

# ===============================================================================
# BASE: rgf_a02_balancete_fundos_111215100
# Filtros TG: Or√ßamento Fiscal,  √ìrg√£o != 25915,37904, Conta = 111215100
# ===============================================================================
criterios_rgf_A02_dcl_balancete_fundos_111215100 <- list(
  
  `14 Aplica√ß√µes em fundos diversos 1 dedu√ß√£o` = list(
    criterio = "
    TRUE
    "
  )
)

# ===============================================================================
# BASE: rgf_a02_balancete_fundos
# Filtros TG: Or√ßamento Fiscal,  √ìrg√£o != 25915,37904, Tipo Admin = 7
# ===============================================================================
criterios_rgf_A02_dcl_balancete_fundos <- list(
  
  `15 Aplica√ß√µes em fundos diversos 2 dedu√ß√£o` = list(
    criterio = "
    startsWith(conta_contabil_numero, '23')
    "
  ),
  
  `16 Aplica√ß√µes em fundos diversos 3 dedu√ß√£o` = list(
    criterio = "
    startsWith(conta_contabil_numero, '1111102') |
    startsWith(conta_contabil_numero, '1111103') |
    startsWith(conta_contabil_numero, '1111104') |
    startsWith(conta_contabil_numero, '1111119') |
    conta_contabil_numero %in% c('111210200', '111210300', '111215000', '111215200') |
    (startsWith(conta_contabil_numero, '1111102') & ug_executora_codigo != '380916') |
    c_con_subgrupo_3_nome %in% c('INVESTIMENTOS', 'IMOBILIZADO', 'INTANGIVEL', 'DIFERIDO')
    "
  )
)

# ===============================================================================
# BASE: rgf_a02_passivo_atuarial
# Filtros TG: Or√ßamento Fiscal
# ===============================================================================
criterios_rgf_A02_passivo_atuarial <- list(
  
  `40 RPPS civil` = list(
    criterio = "
    ug_executora_codigo == '400043' &
    conta_contabil_numero %in% c('217919900', '227210301', '227210303', '227210304', 
                                  '227210401', '227210402', '227210403', '227210404')
    "
  ),
  
  `41 Despesas previdenci√°rias do FCDF` = list(
    criterio = "
    ug_executora_codigo == '170392' &
    conta_contabil_numero %in% c('217919900', '227210301', '227210303', '227210304', 
                                  '227210401', '227210402', '227210403', '227210404')
    "
  ),
  
  `42 Militares inativos` = list(
    criterio = "
    ug_executora_codigo %in% c('120052', '160063', '773200') &
    conta_contabil_numero %in% c('217910700', '227910700')
    "
  ),
  
  `43 Pens√µes militares` = list(
    criterio = "
    ug_executora_codigo %in% c('120052', '160063', '773200') &
    conta_contabil_numero %in% c('217910600', '227910600')
    "
  )
)
```

```{r}
#| code-fold: true
#| column: page
# ===============================================================================
# PROCESSAMENTO DOS CRIT√âRIOS DCL
# ===============================================================================

# ===============================================================================
# 1. rgf_a02_precatorios
# ===============================================================================
df_criterios_rgf_A02_dcl_precatorios <- aplicar_criterios(
  df = rgf_a02_precatorios,
  criterios = criterios_rgf_A02_dcl_precatorios
)



# ===============================================================================
# 2. rgf_a02_rp_exceto_170600
# ===============================================================================
df_criterios_rgf_A02_dcl_rp_exceto_170600 <- aplicar_criterios(
  df = rgf_a02_rp_exceto_170600,
  criterios = criterios_rgf_A02_dcl_rp_exceto_170600
)

# ===============================================================================
# 3. rgf_a02_rp_todas_ugs
# ===============================================================================
df_criterios_rgf_A02_dcl_rp_todas_ugs <- aplicar_criterios(
  df = rgf_a02_rp_todas_ugs,
  criterios = criterios_rgf_A02_dcl_rp_todas_ugs
)

# ===============================================================================
# 4. rgf_a02_ug_170512
# ===============================================================================
df_criterios_rgf_A02_dcl_ug_170512 <- aplicar_criterios(
  df = rgf_a02_ug_170512,
  criterios = criterios_rgf_A02_dcl_ug_170512
)

# ===============================================================================
# 5. rgf_a02_creditos_bancarios
# ===============================================================================
df_criterios_rgf_A02_dcl_creditos_bancarios <- aplicar_criterios(
  df = rgf_a02_creditos_bancarios,
  criterios = criterios_rgf_A02_dcl_creditos_bancarios
)

# ===============================================================================
# 6. rgf_a02_entidade
# ===============================================================================
df_criterios_rgf_A02_dcl_entidade <- aplicar_criterios(
  df = rgf_a02_entidade,
  criterios = criterios_rgf_A02_dcl_entidade
)

# ===============================================================================
# 7. rgf_a02_balancete
# ===============================================================================
df_criterios_rgf_A02_dcl_balancete <- aplicar_criterios(
  df = rgf_a02_balancete,
  criterios = criterios_rgf_A02_dcl_balancete
)

# ===============================================================================
# 8. rgf_a02_aplicacao_titulos_publicos
# ===============================================================================
df_criterios_rgf_A02_dcl_aplicacao_titulos_publicos <- aplicar_criterios(
  df = rgf_a02_aplicacao_titulos_publicos,
  criterios = criterios_rgf_A02_dcl_aplicacao_titulos_publicos
)

# ===============================================================================
# 9. rgf_a02_balancete_fat
# ===============================================================================
df_criterios_rgf_A02_dcl_balancete_fat <- aplicar_criterios(
  df = rgf_a02_balancete_fat,
  criterios = criterios_rgf_A02_dcl_balancete_fat
)

# ===============================================================================
# 10. rgf_a02_balancete_fundos_111215100
# ===============================================================================
df_criterios_rgf_A02_dcl_balancete_fundos_111215100 <- aplicar_criterios(
  df = rgf_a02_balancete_fundos_111215100,
  criterios = criterios_rgf_A02_dcl_balancete_fundos_111215100
)

# ===============================================================================
# 11. rgf_a02_balancete_fundos
# ===============================================================================
df_criterios_rgf_A02_dcl_balancete_fundos <- aplicar_criterios(
  df = rgf_a02_balancete_fundos,
  criterios = criterios_rgf_A02_dcl_balancete_fundos
)

# ===============================================================================
# 12. rgf_a02_balancete_deducoes_depositos_a_vista
# ===============================================================================
df_criterios_rgf_A02_dcl_balancete_deducoes_depositos_a_vista <- aplicar_criterios(
  df = rgf_a02_balancete_deducoes_depositos_a_vista,
  criterios = criterios_rgf_A02_dcl_balancete_deducoes_depositos_a_vista
)


# ===============================================================================
# PROCESSAR: rgf_a02_passivo_atuarial
# ===============================================================================
df_criterios_rgf_A02_passivo_atuarial <- aplicar_criterios(
  df = rgf_a02_passivo_atuarial,
  criterios = criterios_rgf_A02_passivo_atuarial
)

# ===============================================================================
# 13. CONSOLIDAR rgf_a02_rp (Linha 25 - partes 1 e 2)
# ===============================================================================
df_criterios_rgf_A02_dcl_rp <- bind_rows(
  df_criterios_rgf_A02_dcl_rp_exceto_170600,
  df_criterios_rgf_A02_dcl_rp_todas_ugs
) %>%
  mutate(
    nome = str_replace(nome, " parte [12]$", "")
  ) %>%
  group_by(mes_lancamento, dataframe_nome, dataframe_filtros, relatorio, 
           anexo_codigo, anexo_nome, detalhe, print, filtro, metrica, 
           ordem, nome) %>%
  summarise(valor = sum(valor, na.rm = TRUE), .groups = "drop")

# ===============================================================================
# 14. CONSOLIDAR Linha 12 - Dep√≥sitos √† Vista (partes 1 e 2)
# ===============================================================================
df_criterios_rgf_A02_dcl_depositos_vista <- bind_rows(
  df_criterios_rgf_A02_dcl_balancete_deducoes_depositos_a_vista,
  df_criterios_rgf_A02_dcl_balancete %>% 
    filter(str_detect(nome, "^12 "))
) %>%
  mutate(
    nome = str_replace(nome, " parte [12]$", "")
  ) %>%
  group_by(mes_lancamento, dataframe_nome, dataframe_filtros, relatorio, 
           anexo_codigo, anexo_nome, detalhe, print, filtro, metrica, 
           ordem, nome) %>%
  summarise(valor = sum(valor, na.rm = TRUE), .groups = "drop")

# ===============================================================================
# 15. CONSOLIDAR TODOS OS RESULTADOS
# ===============================================================================
df_rgf_A02_dcl_consolidado <- bind_rows(
  df_criterios_rgf_A02_dcl_precatorios,
  df_criterios_rgf_A02_dcl_rp,
  df_criterios_rgf_A02_dcl_ug_170512,
  df_criterios_rgf_A02_dcl_creditos_bancarios,
  df_criterios_rgf_A02_dcl_entidade,
  df_criterios_rgf_A02_dcl_balancete %>% 
    filter(!str_detect(nome, "^12 ")),  # Excluir linha 12 parte 2 do balancete
  df_criterios_rgf_A02_dcl_aplicacao_titulos_publicos,
  df_criterios_rgf_A02_dcl_balancete_fat,
  df_criterios_rgf_A02_dcl_balancete_fundos_111215100,
  df_criterios_rgf_A02_dcl_balancete_fundos,
  df_criterios_rgf_A02_dcl_depositos_vista,  # Usar consolidado da linha 12
  df_criterios_rgf_A02_passivo_atuarial
) %>%
  arrange(mes_lancamento, ordem)
# ===============================================================================
# 14. RESUMO POR BASE
# ===============================================================================
resumo <- df_rgf_A02_dcl_consolidado %>%
  group_by(dataframe_nome) %>%
  summarise(
    linhas = n_distinct(ordem),
    total_registros = n(),
    valor_total = sum(abs(valor), na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(dataframe_nome)

# ===============================================================================
# 15. LINHAS PROCESSADAS
# ===============================================================================
linhas_processadas <- df_rgf_A02_dcl_consolidado %>%
  distinct(ordem, nome) %>%
  arrange(ordem)

# ===============================================================================
# 16. VALORES POR LINHA
# ===============================================================================
valores_linhas <- df_rgf_A02_dcl_consolidado %>%
  group_by(ordem, nome) %>%
  summarise(
    valor_total = sum(valor, na.rm = TRUE),
    valor_absoluto = sum(abs(valor), na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(ordem)

# ===============================================================================
# 17. VERIFICA√á√ÉO DE QUALIDADE
# ===============================================================================
valores_check <- df_rgf_A02_dcl_consolidado %>%
  summarise(
    registros_total = n(),
    registros_com_valor_na = sum(is.na(valor)),
    registros_com_valor_zero = sum(valor == 0, na.rm = TRUE),
    registros_com_valor_positivo = sum(valor > 0, na.rm = TRUE),
    registros_com_valor_negativo = sum(valor < 0, na.rm = TRUE)
  )

linhas_sem_dados <- df_rgf_A02_dcl_consolidado %>%
  group_by(ordem, nome) %>%
  summarise(
    valor_total = sum(valor, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  filter(valor_total == 0 | is.na(valor_total)) %>%
  arrange(ordem)

# ===============================================================================
# 18. EXIBIR RESULTADOS
# ===============================================================================

datatable(
  valores_linhas,
  rownames = FALSE,
  options = list(
    pageLength = -1,
    scrollX = TRUE,
    lengthMenu = list(c(10, 25, 50, -1), c('10', '25', '50', 'Todas'))
  )
) %>% 
  formatRound(c("valor_total", "valor_absoluto"), 2, mark = ".", dec.mark = ",")
```


```{r}
valores_linhas <- valores_linhas %>% 
  mutate(valor = 
    case_when(
      ordem %in% c("02", "25", "26", "38", "16") ~  -valor_total,
      .default = valor_total
      
    )
  )
```


```{r}
formatar_numero((valores_linhas %>% filter(ordem %in% c("01", "02", "03", "04", "05", "26")) %>% summarise(valor = sum(valor)))$valor)


formatar_numero((valores_linhas %>% filter(ordem %in% c("01", "02", "03", "04", "05", "26", "06","07", "08", "09", "10", "38")) %>% summarise(valor = sum(valor)))$valor)


formatar_numero((valores_linhas %>% filter(ordem %in% c("08","38")) %>% summarise(valor = sum(valor)))$valor)


formatar_numero((valores_linhas %>% filter(ordem %in% c( "11","12")) %>% summarise(valor = sum(valor)))$valor)

formatar_numero((valores_linhas %>% filter(ordem %in% c( "14", "15", "16")) %>% summarise(valor = sum(valor)))$valor)

formatar_numero((valores_linhas %>% filter(ordem %in% c( "20", "21")) %>% summarise(valor = sum(valor)))$valor)

formatar_numero((valores_linhas %>% filter(ordem %in% c( "22", "23")) %>% summarise(valor = sum(valor)))$valor)

formatar_numero((valores_linhas %>% filter(ordem %in% c( "11","12", "14", "15", "16", "20", "21", "22", "23", "25")) %>% summarise(valor = sum(valor)))$valor)


valor_dcl <- formatar_numero((valores_linhas %>% filter(ordem %in% c("01", "02", "03", "04", "05", "26", "06","07", "08", "09", "10", "38")) %>% summarise(valor = sum(valor)))$valor- (valores_linhas %>% filter(ordem %in% c( "11","12", "14", "15", "16", "20", "21", "22", "23", "25")) %>% summarise(valor = sum(valor)))$valor )
```








## Titulos P√∫blicos

```{r}
#| include: false

# ============================================================================
# TABELA DE REFER√äNCIA DOS T√çTULOS P√öBLICOS
# ============================================================================

titulos_publicos <- tribble(
  ~codigo_tg,           ~sigla,     ~nome_completo,                                    ~rentabilidade,                ~status,                                      ~observacoes,
  
  # === T√çTULOS ATIVOS ===
  "LTN",                "LTN",      "Letra do Tesouro Nacional",                       "Prefixada (taxa fixa)",       "Ativo (Tesouro Prefixado)",                 "Pagamento √∫nico no vencimento",
  "LTN-DL 2376",        "LTN",      "Letra do Tesouro Nacional",                       "Prefixada (taxa fixa)",       "Ativo (Tesouro Prefixado)",                 "Pagamento √∫nico no vencimento",
  "DP9000001",          "LTN",      "Letra do Tesouro Nacional",                       "Prefixada (taxa fixa)",       "Ativo (Tesouro Prefixado) - Mercado",       "Mercado - Curto Prazo",
  "DP9000010",          "LTN",      "Letra do Tesouro Nacional",                       "Prefixada (taxa fixa)",       "Ativo (Tesouro Prefixado) - BACEN",         "BACEN",
  
  "LFT",                "LFT",      "Letra Financeira do Tesouro",                     "P√≥s-fixada (Selic)",          "Ativo (Tesouro Selic)",                      "Reserva de emerg√™ncia",
  "DP7000001",          "LFT",      "Letra Financeira do Tesouro",                     "P√≥s-fixada (Selic)",          "Ativo (Tesouro Selic) - Mercado",           "Mercado",
  "DP7000010",          "LFT",      "Letra Financeira do Tesouro",                     "P√≥s-fixada (Selic)",          "Ativo (Tesouro Selic) - BACEN",             "BACEN",
  
  "NTN-F",              "NTN-F",    "Nota do Tesouro Nacional S√©rie F",                "Prefixada + cupons semestrais", "Ativo (Tesouro Prefixado c/ Juros)",      "Paga juros a cada 6 meses",
  "DP2300007",          "NTN-F",    "Nota do Tesouro Nacional S√©rie F",                "Prefixada + cupons semestrais", "Ativo (Tesouro Prefixado c/ Juros) - Mercado", "Mercado",
  "DP2300010",          "NTN-F",    "Nota do Tesouro Nacional S√©rie F",                "Prefixada + cupons semestrais", "Ativo (Tesouro Prefixado c/ Juros) - BACEN", "BACEN",
  
  "NTN-B",              "NTN-B",    "Nota do Tesouro Nacional S√©rie B",                "IPCA + taxa fixa",            "Ativo (Tesouro IPCA+ c/ Juros)",             "Protege da infla√ß√£o",
  "DP1700001",          "NTN-B",    "Nota do Tesouro Nacional S√©rie B",                "IPCA + taxa fixa",            "Ativo (Tesouro IPCA+ c/ Juros) - Mercado",  "Mercado",
  "DP1700010",          "NTN-B",    "Nota do Tesouro Nacional S√©rie B",                "IPCA + taxa fixa",            "Ativo (Tesouro IPCA+ c/ Juros) - BACEN",    "BACEN",
  
  "NTN-B1",             "NTN-B1",   "Nota do Tesouro Nacional S√©rie B1",               "IPCA + taxa fixa",            "Ativo (Tesouro Renda+ e Educa+)",           "Aposentadoria/educa√ß√£o",
  "DP9102001",          "NTN-B1",   "Nota do Tesouro Nacional S√©rie B1",               "IPCA + taxa fixa",            "Ativo (Tesouro Renda+ e Educa+)",           "Focado em longo prazo",
  
  # === T√çTULOS EXTINTOS OU RAROS ===
  "NTN-C",              "NTN-C",    "Nota do Tesouro Nacional S√©rie C",                "IGP-M + taxa fixa",           "Extinto (ainda circula pouco)",              "Indexado ao IGP-M",
  "DP1400001",          "NTN-C",    "Nota do Tesouro Nacional S√©rie C",                "IGP-M + taxa fixa",           "Extinto (ainda circula pouco)",              "Infla√ß√£o antiga",
  
  "NTN-I",              "NTN-I",    "Nota do Tesouro Nacional S√©rie I",                "Prefixada ou espec√≠fica",     "Raro/extinto",                               "Pouco usado hoje",
  "DP2600001",          "NTN-I",    "Nota do Tesouro Nacional S√©rie I",                "Prefixada ou espec√≠fica",     "Raro/extinto",                               "Emiss√µes antigas",
  
  "NTN-P",              "NTN-P",    "Nota do Tesouro Nacional S√©rie P",                "Prefixada ou h√≠brida",        "Extinto ou raro",                            "S√©rie antiga",
  "DP1800001",          "NTN-P",    "Nota do Tesouro Nacional S√©rie P",                "Prefixada ou h√≠brida",        "Extinto ou raro",                            "Emiss√µes antigas",
  "DP1800010",          "NTN-P",    "Nota do Tesouro Nacional S√©rie P",                "Prefixada ou h√≠brida",        "Extinto ou raro - BACEN",                    "BACEN",
  
  # === CFT - CERTIFICADOS FINANCEIROS DO TESOURO ===
  "CFT-A",              "CFT-A",    "Certificado Financeiro do Tesouro S√©rie A",       "Vari√°vel (Selic ou TR)",      "Emiss√µes diretas",                           "Programas espec√≠ficos",
  "DP1000001",          "CFT-A",    "Certificado Financeiro do Tesouro S√©rie A",       "Vari√°vel (Selic ou TR)",      "Emiss√µes diretas",                           "N√£o leil√£o comum",
  
  "CFT-B",              "CFT-B",    "Certificado Financeiro do Tesouro S√©rie B",       "Vari√°vel (Selic ou TR)",      "Emiss√µes diretas",                           "FIES, Proies",
  "DP1200001",          "CFT-B",    "Certificado Financeiro do Tesouro S√©rie B",       "Vari√°vel (Selic ou TR)",      "Emiss√µes diretas",                           "Programas governamentais",
  
  "CFT-D",              "CFT-D",    "Certificado Financeiro do Tesouro S√©rie D",       "Vari√°vel (Selic ou TR)",      "Emiss√µes diretas",                           "Programas espec√≠ficos",
  "DP2000001",          "CFT-D",    "Certificado Financeiro do Tesouro S√©rie D",       "Vari√°vel (Selic ou TR)",      "Emiss√µes diretas",                           "N√£o leil√£o",
  
  "CFT-E",              "CFT-E",    "Certificado Financeiro do Tesouro S√©rie E",       "Vari√°vel (Selic ou TR)",      "Emiss√µes diretas",                           "Programas espec√≠ficos",
  "DP2800001",          "CFT-E",    "Certificado Financeiro do Tesouro S√©rie E",       "Vari√°vel (Selic ou TR)",      "Emiss√µes diretas",                           "FIES",
  
  # === CVS - CERTIFICADOS DE VALORIZA√á√ÉO DO SAL√ÅRIO (ANOS 90) ===
  "CVSA970101",         "CVS-A",    "Certificado de Valoriza√ß√£o do Sal√°rio S√©rie A",   "Corre√ß√£o salarial (1997)",    "Extinto/prescrito",                          "D√≠vidas salariais anos 90",
  "DP3201250",          "CVS-A",    "Certificado de Valoriza√ß√£o do Sal√°rio S√©rie A",   "Corre√ß√£o salarial (1997)",    "Extinto/prescrito",                          "Sal√°rios atrasados",
  
  "CVSB970101",         "CVS-B",    "Certificado de Valoriza√ß√£o do Sal√°rio S√©rie B",   "Corre√ß√£o salarial (1997)",    "Extinto/prescrito",                          "D√≠vidas salariais anos 90",
  "DP3201275",          "CVS-B",    "Certificado de Valoriza√ß√£o do Sal√°rio S√©rie B",   "Corre√ß√£o salarial (1997)",    "Extinto/prescrito",                          "Sal√°rios atrasados",
  
  "CVSC970101",         "CVS-C",    "Certificado de Valoriza√ß√£o do Sal√°rio S√©rie C",   "Corre√ß√£o salarial (1997)",    "Extinto/prescrito",                          "D√≠vidas salariais anos 90",
  "DP3201276",          "CVS-C",    "Certificado de Valoriza√ß√£o do Sal√°rio S√©rie C",   "Corre√ß√£o salarial (1997)",    "Extinto/prescrito",                          "Sal√°rios atrasados",
  
  "CVSD970101",         "CVS-D",    "Certificado de Valoriza√ß√£o do Sal√°rio S√©rie D",   "Corre√ß√£o salarial (1997)",    "Extinto/prescrito",                          "D√≠vidas salariais anos 90",
  "DP3201277",          "CVS-D",    "Certificado de Valoriza√ß√£o do Sal√°rio S√©rie D",   "Corre√ß√£o salarial (1997)",    "Extinto/prescrito",                          "Sal√°rios atrasados",
  
  # === T√çTULOS DE SECURITIZA√á√ÉO (ANOS 90) ===
  "BNCC920116",         "BNCC",     "T√≠tulo de Securitiza√ß√£o - B√¥nus do Cr√©dito",      "Vari√°vel",                    "Extinto",                                    "D√≠vidas judiciais anos 90",
  "DP3201031",          "BNCC",     "T√≠tulo de Securitiza√ß√£o - B√¥nus do Cr√©dito",      "Vari√°vel",                    "Extinto",                                    "Precat√≥rios",
  
  "JUST920116",         "JUST",     "T√≠tulo de Securitiza√ß√£o - Justi√ßa",               "Vari√°vel",                    "Extinto",                                    "D√≠vidas judiciais anos 90",
  "DP3201032",          "JUST",     "T√≠tulo de Securitiza√ß√£o - Justi√ßa",               "Vari√°vel",                    "Extinto",                                    "Precat√≥rios",
  
  "SUMA920199",         "SUMA",     "T√≠tulo Antigo de Securitiza√ß√£o",                  "Vari√°vel",                    "Extinto",                                    "Anos 90",
  "DP3201145",          "SUMA",     "T√≠tulo Antigo de Securitiza√ß√£o",                  "Vari√°vel",                    "Extinto",                                    "Emiss√µes antigas",
  
  "CDP/INSS",           "CDP",      "Certificado da D√≠vida Previdenci√°ria",            "Vari√°vel",                    "Extinto",                                    "Quitar d√≠vidas com INSS",
  "DP3000001",          "CDP",      "Certificado da D√≠vida Previdenci√°ria",            "Vari√°vel",                    "Extinto",                                    "D√≠vida INSS",
  
  # === D√çVIDA EXTERNA ===
  "GLOBAL",             "GLOBAL",   "Global Bonds (d√≠vida externa em USD)",            "Prefixada USD + c√¢mbio",      "Ativo - circula√ß√£o",                         "Emitidos no exterior (USD)",
  "DP1300003",          "GLOBAL",   "Global Bonds (d√≠vida externa em USD)",            "Prefixada USD + c√¢mbio",      "Ativo - circula√ß√£o",                         "Corre√ß√£o cambial",
  
  "GLOBAL BRL",         "GLOBAL-BRL", "BRL Bonds (d√≠vida externa em R$)",              "Prefixada em real",           "Ativo - circula√ß√£o",                         "Emitidos fora em reais (2005+)",
  "DP1300004",          "GLOBAL-BRL", "BRL Bonds (d√≠vida externa em R$)",              "Prefixada em real",           "Ativo - circula√ß√£o",                         "Mercado internacional",
  
  # === T√çTULOS DA D√çVIDA AGR√ÅRIA ===
  "TDA",                "TDA",      "T√≠tulos da D√≠vida Agr√°ria",                       "Vari√°vel",                    "Ativo",                                      "Reforma agr√°ria",
  "212110202",          "TDA",      "T√≠tulos da D√≠vida Agr√°ria",                       "Vari√°vel",                    "Ativo - Curto Prazo",                        "Passivo Circulante",
  "222110102",          "TDA",      "T√≠tulos da D√≠vida Agr√°ria",                       "Vari√°vel",                    "Ativo - Longo Prazo",                        "Passivo N√£o-Circulante"
)

# ============================================================================
# CATEGORIAS DE T√çTULOS
# ============================================================================

categorias_titulos <- tribble(
  ~sigla,       ~categoria,                    ~subcategoria,
  "LTN",        "Prefixados",                  "Curto Prazo",
  "LFT",        "P√≥s-fixados",                 "Selic",
  "NTN-F",      "Prefixados",                  "Com Cupons",
  "NTN-B",      "Indexados √† Infla√ß√£o",        "IPCA",
  "NTN-B1",     "Indexados √† Infla√ß√£o",        "IPCA - Longo Prazo",
  "NTN-C",      "Indexados √† Infla√ß√£o",        "IGP-M (Extinto)",
  "NTN-I",      "Outros",                      "Extinto",
  "NTN-P",      "Outros",                      "Extinto",
  "CFT-A",      "Certificados Especiais",      "Programas Governamentais",
  "CFT-B",      "Certificados Especiais",      "FIES/Proies",
  "CFT-D",      "Certificados Especiais",      "Programas Especiais",
  "CFT-E",      "Certificados Especiais",      "FIES",
  "CVS-A",      "Extintos",                    "Corre√ß√£o Salarial",
  "CVS-B",      "Extintos",                    "Corre√ß√£o Salarial",
  "CVS-C",      "Extintos",                    "Corre√ß√£o Salarial",
  "CVS-D",      "Extintos",                    "Corre√ß√£o Salarial",
  "BNCC",       "Extintos",                    "Securitiza√ß√£o",
  "JUST",       "Extintos",                    "Securitiza√ß√£o",
  "SUMA",       "Extintos",                    "Securitiza√ß√£o",
  "CDP",        "Extintos",                    "D√≠vida Previdenci√°ria",
  "GLOBAL",     "D√≠vida Externa",              "USD",
  "GLOBAL-BRL", "D√≠vida Externa",              "BRL",
  "TDA",        "D√≠vida Agr√°ria",              "Reforma Agr√°ria"
)

# ============================================================================
# FUN√á√ÉO: ENRIQUECER DADOS DO TG COM INFORMA√á√ïES DOS T√çTULOS
# ============================================================================

#' Enriquecer dados do Tesouro Gerencial com informa√ß√µes dos t√≠tulos
#' @param df Dataframe com dados do TG (deve ter coluna entidade_c_cor_numero ou similar)
#' @param coluna_codigo Nome da coluna com c√≥digo do t√≠tulo (padr√£o: "entidade_c_cor_numero")
#' @return Dataframe enriquecido com informa√ß√µes dos t√≠tulos
enriquecer_titulos <- function(df, coluna_codigo = "entidade_c_cor_numero") {
  
  # Verificar se coluna existe
  if (!coluna_codigo %in% names(df)) {
    stop(sprintf("Coluna '%s' n√£o encontrada no dataframe", coluna_codigo))
  }
  
  # Fazer join com tabela de t√≠tulos
  df_enriquecido <- df %>%
    left_join(
      titulos_publicos,
      by = setNames("codigo_tg", coluna_codigo)
    ) %>%
    left_join(
      categorias_titulos,
      by = "sigla"
    )
  
  # Adicionar flag de t√≠tulos n√£o mapeados
  df_enriquecido <- df_enriquecido %>%
    mutate(
      titulo_mapeado = !is.na(sigla),
      tipo_titulo = case_when(
        is.na(sigla) ~ "N√£o Mapeado",
        TRUE ~ as.character(sigla)
      )
    )
  
  return(df_enriquecido)
}

#' Buscar informa√ß√µes de um t√≠tulo espec√≠fico
#' @param codigo C√≥digo do t√≠tulo
#' @return Tibble com informa√ß√µes do t√≠tulo
buscar_titulo <- function(codigo) {
  titulos_publicos %>%
    filter(codigo_tg == codigo)
}

#' Listar todos os t√≠tulos ativos
#' @return Tibble com t√≠tulos ativos
listar_titulos_ativos <- function() {
  titulos_publicos %>%
    filter(grepl("Ativo", status)) %>%
    distinct(sigla, nome_completo, rentabilidade, status)
}

#' Listar t√≠tulos por categoria
#' @param categoria Nome da categoria
#' @return Tibble com t√≠tulos da categoria
listar_por_categoria <- function(categoria) {
  categorias_titulos %>%
    filter(categoria == {{categoria}}) %>%
    left_join(titulos_publicos %>% distinct(sigla, nome_completo, rentabilidade, status),
              by = "sigla")
}

# ============================================================================
# MENSAGEM
# ============================================================================

cat("\n")
cat("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n")
cat("         üìä MAPEAMENTO DE T√çTULOS P√öBLICOS CARREGADO\n")
cat("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n")
cat(sprintf("‚úÖ Total de t√≠tulos mapeados: %d\n", nrow(titulos_publicos)))
cat(sprintf("‚úÖ Categorias: %d\n", nrow(categorias_titulos)))
cat("\nüìù Fun√ß√µes dispon√≠veis:\n")
cat("   ‚Ä¢ enriquecer_titulos(df, coluna_codigo)\n")
cat("   ‚Ä¢ buscar_titulo(codigo)\n")
cat("   ‚Ä¢ listar_titulos_ativos()\n")
cat("   ‚Ä¢ listar_por_categoria(categoria)\n")
cat("\nüí° Dataframes dispon√≠veis:\n")
cat("   ‚Ä¢ titulos_publicos\n")
cat("   ‚Ä¢ categorias_titulos\n")
cat("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n")


# ============================================================================
# EXEMPLO 1: Importar e Enriquecer Dados
# ============================================================================


# Enriquecer com informa√ß√µes dos t√≠tulos
dados_enriquecidos <- enriquecer_titulos(rgf_a02_entidade, coluna_codigo = "entidade_c_cor_numero")

# Ver resultado
dados_enriquecidos %>%
  select(entidade_c_cor_numero, entidade_c_cor_nome, 
         sigla, nome_completo, rentabilidade, status, 
         categoria, subcategoria, saldo_r_conta_contabil) %>%
  head(10)

# datatable(dados_enriquecidos)


# ============================================================================
# ADICIONAR DETENTOR E PRAZO AOS DADOS - VERS√ÉO DIRETA E SIMPLES
# ============================================================================
# C√≥digo simplificado para equipe com pouco conhecimento de R
# Autor: Andr√©
# Data: 2024
# ============================================================================

library(tidyverse)

# ============================================================================
# MANIPULA√á√ÉO DIRETA: ADICIONAR COLUNAS DETENTOR E PRAZO
# ============================================================================

# Seus dados originais (exemplo: rgf_a02_entidade)
# Substitua pelo nome real da sua base de dados

dados_enriquecidos <- rgf_a02_entidade %>%
  mutate(
    
    # COLUNA 1: DETENTOR
    # Busca palavras-chave no nome da entidade
    detentor = case_when(
      str_detect(entidade_c_cor_nome, regex("BACEN", ignore_case = TRUE)) ~ "BACEN",
      str_detect(entidade_c_cor_nome, regex("Mercado", ignore_case = TRUE)) ~ "Mercado",
      TRUE ~ "Demais"
    ),
    
    # COLUNA 2: PRAZO
    # Busca palavras-chave no nome da conta cont√°bil
    prazo = case_when(
      str_detect(conta_contabil_nome, regex("Curto Prazo|Circulante", ignore_case = TRUE)) ~ "Curto Prazo",
      str_detect(conta_contabil_nome, regex("Longo Prazo|N√£o.?Circulante", ignore_case = TRUE)) ~ "Longo Prazo",
      TRUE ~ "N√£o Especificado"
    )
  )

# ============================================================================
# VER RESULTADO
# ============================================================================

# Visualizar primeiras linhas com as novas colunas
dados_enriquecidos %>%
  select(entidade_c_cor_numero, entidade_c_cor_nome, 
         detentor, prazo, saldo_r_conta_contabil) %>%
  head(20)

# ============================================================================
# RESUMOS SIMPLES
# ============================================================================

# Resumo por detentor
dados_enriquecidos %>%
  group_by(detentor) %>%
  summarise(
    total = sum(saldo_r_conta_contabil, na.rm = TRUE),
    quantidade = n()
  )

# Resumo por prazo
dados_enriquecidos %>%
  group_by(prazo) %>%
  summarise(
    total = sum(saldo_r_conta_contabil, na.rm = TRUE),
    quantidade = n()
  )



```

```{r}
# Resumo cruzado: detentor x prazo
datatable(dados_enriquecidos %>%
  group_by(detentor, prazo) %>%
  summarise(
    total = sum(saldo_r_conta_contabil, na.rm = TRUE),
    quantidade = n(),
    .groups = "drop"
  )) %>% 
  formatRound(c("total"), 2, mark = ".", dec.mark = ",")
```

# üìã RGF Anexo 03 (Garantias e Contragarantias)

```{r}
#| code-fold: true
criterios_rgf_A03_garantias <- list(
  
  # ===========================================================================
  # GARANTIAS CONCEDIDAS
  # ===========================================================================
  
  `01 Garantias aos estados total` = list(
    criterio = "
    conta_contabil_numero %in% c('812110104', '812110204', '899913301', '899913302') &
    conta_corrente %in% c('CG0000064', 'CG0000069')
    "
  ),
  
  `02 Garantias aos estados opera√ß√µes externas` = list(
    criterio = "
    (conta_contabil_numero == '812110204' &
    conta_corrente == 'CG0000069') |
    (conta_contabil_numero == '899913302' &
    conta_corrente == 'CG0000069')
    "
  ),
  
  `03 Garantias aos estados opera√ß√µes internas` = list(
    criterio = "
    (conta_contabil_numero == '812110104' &
    conta_corrente == 'CG0000064') |
    (conta_contabil_numero == '899913301' &
    conta_corrente == 'CG0000064')
    "
  ),
  
  `04 Garantias aos munic√≠pios total` = list(
    criterio = "
    conta_contabil_numero %in% c('812110104', '812110204') &
    conta_corrente %in% c('CG0000065', 'CG0000070')
    "
  ),
  
  `05 Garantias aos munic√≠pios opera√ß√µes externas` = list(
    criterio = "
    conta_contabil_numero == '812110204' &
    conta_corrente == 'CG0000070'
    "
  ),
  
  `06 Garantias aos munic√≠pios opera√ß√µes internas` = list(
    criterio = "
    conta_contabil_numero == '812110104' &
    conta_corrente == 'CG0000065'
    "
  ),
  
  `07 Garantias √†s entidades controladas total` = list(
    criterio = "
    conta_contabil_numero %in% c('812110104', '812110204') &
    conta_corrente %in% c('CG0000067', 'CG0000071', 'CG0000072')
    "
  ),
  
  `08 Garantias √†s entidades opera√ß√µes externas` = list(
    criterio = "
    conta_contabil_numero == '812110204' &
    conta_corrente %in% c('CG0000071', 'CG0000072')
    "
  ),
  
  `09 Garantias √†s entidades opera√ß√µes internas` = list(
    criterio = "
    conta_contabil_numero == '812110104' &
    conta_corrente == 'CG0000067'
    "
  ),
  
  `10 Garantias por fundos e programas total` = list(
    criterio = "
    (conta_contabil_numero == '812110104' & 
     (conta_corrente %in% c('CGASCA001', 'CGLEI8036') | 
      startsWith(conta_corrente, 'CGFSCEIRB') |
      startsWith(conta_corrente, 'CGPPRONAF') |
      startsWith(conta_corrente, 'CGPRCACAU') |
      startsWith(conta_corrente, 'CGASCAD'))) |
    conta_contabil_numero == '812110110'
    "
  ),
  
  `11 Garantias fundos seguros-garantia` = list(
    criterio = "
    conta_contabil_numero == '812110110' &
    (conta_corrente == '999' | is.na(conta_corrente))
    "
  ),
  
  `12 Garantias fundos ASCA` = list(
    criterio = "
    conta_contabil_numero == '812110104' &
    conta_corrente == 'CGASCA001'
    "
  ),
  
  `13 Garantias fundos Lei 8036 (FGTS)` = list(
    criterio = "
    conta_contabil_numero == '812110104' &
    conta_corrente == 'CGLEI8036'
    "
  ),
  
  `14 Garantias total geral` = list(
    criterio = "
    conta_contabil_numero %in% c('812110104', '812110110', '812110204', '899913301', '899913302')
    "
  ),
  
  # ===========================================================================
  # CONTRAGARANTIAS RECEBIDAS
  # ===========================================================================
  
  `15 Contragarantias dos estados total` = list(
    criterio = "
    conta_contabil_numero %in% c('811110304', '811110404') &
    conta_corrente %in% c('CG0000064', 'CG0000069')
    "
  ),
  
  `16 Contragarantias dos estados opera√ß√µes externas` = list(
    criterio = "
    conta_contabil_numero == '811110404' &
    conta_corrente == 'CG0000069'
    "
  ),  
  
  `17 Contragarantias dos estados opera√ß√µes internas` = list(
    criterio = "
    conta_contabil_numero == '811110304' &
    conta_corrente == 'CG0000064'
    "
  ),
  
  `18 Contragarantias dos munic√≠pios total` = list(
    criterio = "
    conta_contabil_numero %in% c('811110304', '811110404') &
    conta_corrente %in% c('CG0000065', 'CG0000070')
    "
  ),
  
  `19 Contragarantias dos munic√≠pios opera√ß√µes externas` = list(
    criterio = "
    conta_contabil_numero == '811110404' &
    conta_corrente == 'CG0000070'
    "
  ),
  
  `20 Contragarantias dos munic√≠pios opera√ß√µes internas` = list(
    criterio = "
    conta_contabil_numero == '811110304' &
    conta_corrente == 'CG0000065'
    "
  ),
  
  `21 Contragarantias das entidades controladas total` = list(
    criterio = "
    conta_contabil_numero %in% c('811110304', '811110404') &
    conta_corrente %in% c('CG0000067', 'CG0000071', 'CG0000072')
    "
  ),
  
  `22 Contragarantias das entidades opera√ß√µes externas` = list(
    criterio = "
    conta_contabil_numero == '811110404' &
    conta_corrente %in% c('CG0000071', 'CG0000072')
    "
  ),
  
  `23 Contragarantias das entidades opera√ß√µes internas` = list(
    criterio = "
    conta_contabil_numero == '811110304' &
    conta_corrente == 'CG0000067'
    "
  ),
  
  `24 Contragarantias total geral` = list(
    criterio = "
    conta_contabil_numero %in% c('811110304', '811110404')
    "
  )
)


datatable(
  aplicar_criterios(rgf_a03, criterios_rgf_A03_garantias) %>% 
    group_by(ordem, nome) %>% 
    summarise(valor = sum(valor), .groups = "drop"),
  rownames = FALSE,
  options = list(
    pageLength = -1,
    scrollX = TRUE,
    lengthMenu = list(c(10, 25, 50, -1), c('10', '25', '50', 'Todas'))
   
  )
) %>% 
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")
```

```{r}
# ==============================================================================
# RGF A03 - GARANTIAS - PROCESSAMENTO
# ==============================================================================

# Aplicar crit√©rios e SALVAR (importante para consolida√ß√£o)
garantias_processado <- aplicar_criterios(
  rgf_a03, 
  criterios_rgf_A03_garantias
)

# Agregar para exibi√ß√£o
garantias_agregado <- garantias_processado %>% 
  group_by(ordem, nome) %>% 
  summarise(valor = sum(valor), .groups = "drop")

# Exibir em datatable
datatable(
  garantias_agregado,
  rownames = FALSE,
  options = list(
    pageLength = -1,
    scrollX = TRUE,
    lengthMenu = list(c(10, 25, 50, -1), c('10', '25', '50', 'Todas'))
  )
) %>% 
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")
```

# üìã RGF Anexo 04 (Opera√ß√µes de Cr√©dito)

```{r}
#| code-fold: true
#| column: page

# ===============================================================================
# CRIT√âRIOS RGF ANEXO 04 - OPERA√á√ïES DE CR√âDITO
# ===============================================================================

# ===============================================================================
# PARTE 1: RECEITAS OR√áAMENT√ÅRIAS
# Base: rgf_a04_receitas
# ===============================================================================
criterios_rgf_A04_receitas <- list(
  
  `01 Mobili√°ria interna refinanciamento` = list(
    criterio = "
    conta_contabil_numero %in% c('621200000', '621310000', '621320000', 
                                  '621330000', '621340000', '621390000') &
    (startsWith(natureza_receita_codigo_completo, '2111002') |
     startsWith(natureza_receita_codigo_completo, '8111002') |
     natureza_receita_codigo_completo %in% c('21110200', '21110201', 
                                             '81110200', '81110201'))
    "
  ),
  
  `02 Mobili√°ria interna outras or√ßament√°rias` = list(
    criterio = "
    conta_contabil_numero %in% c('621200000', '621310000', '621320000', 
                                  '621330000', '621340000', '621390000') &
    (startsWith(natureza_receita_codigo_completo, '2111003') |
     startsWith(natureza_receita_codigo_completo, '8111001') |
     natureza_receita_codigo_completo %in% c('21110300', '21110301', 
                                             '21110100', '21110101'))
    "
  ),
  
  `06 Mobili√°ria externa refinanciamento` = list(
    criterio = "
    conta_contabil_numero %in% c('621200000', '621310000', '621320000', 
                                  '621330000', '621340000', '621390000') &
    natureza_receita_codigo_completo %in% c('21210201', '21210202', 
                                            '21210021', '21210022')
    "
  ),
  
  `08 Mobili√°ria externa outras opera√ß√µes mobili√°rias externas` = list(
    criterio = "
    conta_contabil_numero %in% c('621200000', '621310000', '621320000', 
                                  '621330000', '621340000', '621390000') &
    natureza_receita_codigo_completo %in% c('21210101', '21210102', 
                                            '21210011', '21210012')
    "
  ),
  
  `09 Contratual interna abertura de cr√©dito` = list(
    criterio = "
    conta_contabil_numero %in% c('621200000', '621310000', '621320000', 
                                  '621330000', '621340000', '621390000') &
    startsWith(natureza_receita_codigo_completo, '2112001')
    "
  ),
  
  `11 Contratual interna outras opera√ß√µes contratuais internas` = list(
    criterio = "
    conta_contabil_numero %in% c('621200000', '621310000', '621320000', 
                                  '621330000', '621340000', '621390000') &
    startsWith(natureza_receita_codigo_completo, '2119001')
    "
  ),
  
  `12 Contratual externa abertura de cr√©dito or√ßament√°rias` = list(
    criterio = "
    conta_contabil_numero %in% c('621200000', '621310000', '621320000', 
                                  '621330000', '621340000', '621390000') &
    (startsWith(natureza_receita_codigo_completo, '2122001') |
     natureza_receita_codigo_completo %in% c('21220100', '21220101', '21220102'))
    "
  ),
  
  `15 Contratual externa outras opera√ß√µes contratuais externas` = list(
    criterio = "
    conta_contabil_numero %in% c('621200000', '621310000', '621320000', 
                                  '621330000', '621340000', '621390000') &
    startsWith(natureza_receita_codigo_completo, '2129001')
    "
  )
)

# ===============================================================================
# PARTE 2: EXTRAOR√áAMENT√ÅRIAS
# Base: rgf_a02_balancete
# ===============================================================================
criterios_rgf_A04_extra_orcamentarias <- list(
  
  `03 Mobili√°ria interna extraor√ßament√°rias aporte Bacen` = list(
    criterio = "
    conta_contabil_numero %in% c('896110303', '896110304')
    "
  ),
  
  `04 Mobili√°ria interna extraor√ßament√°rias aporte em empresas` = list(
    criterio = "
    conta_contabil_numero %in% c('896110311', '896110312')
    "
  ),
  
  `05 Mobili√°ria interna extraor√ßament√°rias trocas e demais opera√ß√µes internas` = list(
    criterio = "
    conta_contabil_numero %in% c('896110301', '896110302', '896110305', '896110306')
    "
  ),
  
  `07 Mobili√°ria externa assun√ß√£o reconhecimento e confiss√£o de d√≠vidas` = list(
    criterio = "
    conta_contabil_numero %in% c('896110309', '896110310')
    "
  ),
  
  `10 Contratual interna assun√ß√£o reconhecimento e confiss√£o de d√≠vidas` = list(
    criterio = "
    conta_contabil_numero == '212110398'
    "
  ),
  
  `13 Contratual externa abertura de cr√©dito extraor√ßament√°rias` = list(
    criterio = "
    conta_contabil_numero %in% c('896110307', '896110308')
    "
  ),
  
  `14 Contratual externa assun√ß√£o reconhecimento e confiss√£o de d√≠vidas` = list(
    criterio = "
    FALSE
    "
  )
)

# ===============================================================================
# PARTE 3: DESPESAS (APLICA√á√ÉO DOS RECURSOS)
# Base: rgf_a04_despesas
# ===============================================================================
criterios_rgf_A04_despesas <- list(
  
  `16 Amortiza√ß√£o refinanciamento` = list(
    criterio = "
    conta_contabil_numero %in% c('622130400', '622130600', '622130700') &
    grupo_despesa_codigo_grupo == '6'
    "
  ),
  
  `17 Outras despesas correntes` = list(
    criterio = "
    conta_contabil_numero %in% c('622130400', '622130600', '622130700') &
    grupo_despesa_codigo_grupo == '3'
    "
  ),
  
  `18 Pessoal e encargos sociais` = list(
    criterio = "
    conta_contabil_numero %in% c('622130400', '622130600', '622130700') &
    grupo_despesa_codigo_grupo == '1'
    "
  ),
  
  `19 Juros e encargos da d√≠vida` = list(
    criterio = "
    conta_contabil_numero %in% c('622130400', '622130600', '622130700') &
    grupo_despesa_codigo_grupo == '2'
    "
  ),
  
  `20 Investimentos` = list(
    criterio = "
    conta_contabil_numero %in% c('622130400', '622130600', '622130700') &
    grupo_despesa_codigo_grupo == '4'
    "
  ),
  
  `21 Invers√µes financeiras` = list(
    criterio = "
    conta_contabil_numero %in% c('622130400', '622130600', '622130700') &
    grupo_despesa_codigo_grupo == '5'
    "
  )
)


df_criterios_rgf_A04_despesas <- aplicar_criterios(rgf_a04_despesas, criterios_rgf_A04_despesas)
df_criterios_rgf_A04_receitas <- aplicar_criterios(rgf_a04_receitas, criterios_rgf_A04_receitas)

df_criterios_rgf_A04_extra_orcamentarias <- aplicar_criterios(rgf_a02_balancete, criterios_rgf_A04_extra_orcamentarias)

datatable(aplicar_criterios(rgf_a04_receitas, criterios_rgf_A04_receitas) %>% group_by(ordem,nome) %>% summarise(valor = sum(valor)))%>% 
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")



```

# üìã RGF Anexo 05 (Disponibilidades)

```{r}


rgf_a05 <- rgf_a05 %>% mutate(orgao_fonte = str_c(detalhe_orgao_central_codigo_detalhe_oc,"_" ,detalhe_orgao_central_id_fonte , "_", fonte_recursos_codigo ))

rgf_a05 <- rgf_a05 %>% mutate(tg_orgao_fonte = str_c(detalhe_orgao_central_codigo_detalhe_oc,"_" ,detalhe_orgao_central_id_fonte  ))

# =============================================================================
# APLICAR CLASSIFICA√á√ÉO DE LINHAS (FONTES) SE NECESS√ÅRIO
# =============================================================================

if(!"linhas" %in% names(rgf_a05)) {
  rgf_a05 <- rgf_a05 %>%
    mutate(
      linhas = case_when(
        fonte_recursos_codigo %in% c("000") ~ "0_nao_vinculados",
        fonte_recursos_codigo %in% c("008", "012", "130", "133", "134") ~ "1_educacao",
        fonte_recursos_codigo %in% c("001", "002", "004", "005", "006", "010", "017", "023", "024", 
                                     "035", "040", "048", "049", "094", "126", "155", "156", "179", "184") ~  "2_seguridade_exceto_previdencia",
        fonte_recursos_codigo %in% c("122", "123") & tg_orgao_fonte %notin% c("000278_153","000278_154")  ~  "2_seguridade_exceto_previdencia",
        fonte_recursos_codigo %in% c("055", "056", "125") ~ "3_rpps",
        fonte_recursos_codigo %in% c("054") ~ "4_rgps",
        fonte_recursos_codigo %in% c("400", "401", "443", "444", "448") ~ "5_divida",
        fonte_recursos_codigo %in% c("034", "121", "122", "123") & tg_orgao_fonte %in% c("000278_133","000278_152","000278_153","000278_154") ~ "5_divida",
        fonte_recursos_codigo %in% c("201", "202", "203", "206", "207", "208", "209", "210", "211", "213",
                                     "219", "229", "234", "235", "241", "242", "251", 
                                     "286", "287", "288", "289") ~ "6_transferencias",
        fonte_recursos_codigo %in% c("003", "007", "009", "011", "013", "014", "015", "016", "018", "019",
                                     "020", "021", "022", "025", "026", "027", "028", "029", "030", "031",
                                     "032", "033", "034", "037", "038", "039", "041", "042", "043", "044",
                                     "045", "046", "047", "050", "051", "052", "053", "057", "058", "059",
                                     "060", "061", "062", "063", "064", "065", "066", "067", "068", "069",
                                     "070", "071", "072", "073", "074", "075", "076", "077", "078", "079",
                                     "080", "081", "082", "083", "084", "085", "086", "087", "088", "089",
                                     "090", "091", "092", "093", "095", "096", "097", "098", "099", "100",
                                     "101", "102", "103", "104", "105", "106", "107", "108", "109", "110",
                                     "111", "112", "113", "114", "115", "116", "118", "119", "120", "121",
                                     "124", "127", "128", "129", "131", "132" ,"135", "136", "137", "138", "139",
                                     "140", "141", "144", "145", "177", "178", "180", "181", "182", "183", "449") ~ "7_fundos_orgaos_programa",
        (fonte_recursos_codigo %in% c("034", "121") & tg_orgao_fonte %notin% c("000278_133","000278_152")) ~ "7_fundos_orgaos_programa",
        fonte_recursos_codigo %in% c("491") ~ "8_extraorcamentario",
        fonte_recursos_codigo %in% c("490", "'-9", "'-7") ~ "9_nao_classificados",
        TRUE ~ "outros"
      )
    )
}

# ===============================================================================
# CRIT√âRIOS RGF TABELA 04 - DISPONIBILIDADE DE CAIXA E RESTOS A PAGAR
# ===============================================================================

criterios_rgf_a05_disponibilidade <- list(
  
  # ===========================================================================
  # 1. RECEITAS
  # ===========================================================================
  `01_receitas` = list(
    criterio = "
    conta_contabil_numero %in% c('621200000', '621310000', '621320000', 
                                  '621330000', '621390000')
    "
  ),
  
  # ===========================================================================
  # 2. DESPESAS
  # ===========================================================================
  `02_despesas` = list(
    criterio = "
    conta_contabil_numero %in% c('622920104', '631400000', '632200000')
    "
  ),
  
  # ===========================================================================
  # 3. DISPONIBILIDADE DE CAIXA BRUTA (111 F menos 111110205)
  # ===========================================================================
  `03_disponibilidade_caixa_bruta` = list(
    criterio = "
    startsWith(conta_contabil_numero, '111') &
    isf_lancamento == 'F' &
    conta_contabil_numero != '111110205'
    "
  ),
  
  # ===========================================================================
  # 4. DEDU√á√ÉO: RECEITAS A CLASSIFICAR
  # ===========================================================================
  `04_deducao_receitas_classificar` = list(
    criterio = "
    conta_contabil_numero %in% c('111113001', '491110101', '491110102', '491110103', 
                                  '491110108', '491010101', '491010102', '491010103', 
                                  '491019701', '491019702', '491019703')
    "
  ),
  
  # ===========================================================================
  # 5. RESTOS A PAGAR LIQUIDADOS E N√ÉO PAGOS (EXERC√çCIOS ANTERIORES)
  # ===========================================================================
  `05_rp_liquidados_nao_pagos_exercicios_anteriores` = list(
    criterio = "
    conta_contabil_numero %in% c('632100000', '631300000')
    "
  ),
  
  # ===========================================================================
  # 6. RESTOS A PAGAR LIQUIDADOS E N√ÉO PAGOS (DO EXERC√çCIO)
  # ===========================================================================
  `06_rp_liquidados_nao_pagos_exercicio` = list(
    criterio = "
    conta_contabil_numero %in% c('632710000', '632720000', '632700000')
    "
  ),
  
  # ===========================================================================
  # 7. RESTOS A PAGAR EMPENHADOS E N√ÉO LIQUIDADOS (EXERC√çCIOS ANTERIORES)
  # ===========================================================================
  `07_rp_empenhados_nao_liquidados_exercicios_anteriores` = list(
    criterio = "
    conta_contabil_numero %in% c('631100000', '631200000', '631510000', '631520000', 
                                  '631530000', '631810000', '631820000', '631830000', 
                                  '631840000', '631540000')
    "
  ),
  
  # ===========================================================================
  # 8. DEMAIS OBRIGA√á√ïES I (2 F menos 21892 3901, 3902, 3903, 4001 e 218914001)
  # ===========================================================================
  `08_demais_obrigacoes_i` = list(
    criterio = "
    startsWith(conta_contabil_numero, '2') &
    isf_lancamento == 'F' &
    !conta_contabil_numero %in% c('218923901', '218923902', '218923903', '218914001')
    "
  ),
  
  # ===========================================================================
  # 9. DEMAIS OBRIGA√á√ïES II (2 F da CODIV - UG 170600)
  # ===========================================================================
  `09_demais_obrigacoes_ii_2f_da_codiv` = list(
    criterio = "
    startsWith(conta_contabil_numero, '2') &
    isf_lancamento == 'F' &
    ug_executora_codigo == '170600'
    "
  ),
  
  # ===========================================================================
  # 10. DEDU√á√ÉO: DEMAIS OBRIGA√á√ïES I
  # ===========================================================================
  `10_deducao_demais_obrigacoes_i` = list(
    criterio = "
    conta_contabil_numero %in% c('631570000', '631590000', '631540000', '632100000', 
                                  '632720000', '531710200', '531720100', '218923901')
    "
  ),
  
  # ===========================================================================
  # 11. RESTOS A PAGAR EMPENHADOS E N√ÉO LIQUIDADOS (DO EXERC√çCIO)
  # ===========================================================================
  `11_rp_empenhados_nao_liquidados_exercicio` = list(
    criterio = "
    conta_contabil_numero %in% c('531710100', '531710200', '531720100')
    "
  ),
  
  # ===========================================================================
  # 12. EMPENHOS N√ÉO LIQUIDADOS CANCELADOS (POR INSUFICI√äNCIA FINANCEIRA)
  # ===========================================================================
  `12_empenhos_nao_liquidados_cancelados` = list(
    criterio = "
    conta_contabil_numero == '631910000'
    "
  ),
  
  # ===========================================================================
  # 13. CONTA: 822240101 - RECEBIMENTO DE RP AUTORIZADO
  # ===========================================================================
  `13_conta_822240101_recebimento_rp_autorizado` = list(
    criterio = "
    conta_contabil_numero == '822240101'
    "
  ),
  
  # ===========================================================================
  # 14. CONTA: 822140101 - LIBERA√á√ÉO DE RP AUTORIZADO
  # ===========================================================================
  `14_conta_822140101_liberacao_rp_autorizado` = list(
    criterio = "
    conta_contabil_numero == '822140101'
    "
  ),
  
  # ===========================================================================
  # 15. CONTA: 894310000 - DISPONIBILIDADE DE RECURSOS POR TED A LIBERAR
  # ===========================================================================
  `15_conta_894310000_disp_recursos_ted_liberar` = list(
    criterio = "
    conta_contabil_numero == '894310000'
    "
  ),
  
  # ===========================================================================
  # 16. CONTA: 894320000 - DISPONIBILIDADE DE RECURSOS POR TED A RECEBER
  # ===========================================================================
  `16_conta_894320000_disp_recursos_ted_receber` = list(
    criterio = "
    conta_contabil_numero == '894320000'
    "
  ),
  
  # ===========================================================================
  # 17. DEDU√á√ÉO: LIMITE DE SAQUE I
  # ===========================================================================
  `17_deducao_limite_saque_i` = list(
    criterio = "
    conta_contabil_numero %in% c('218924001') &
    isf_lancamento == 'F'
    "
  ),
  
  # ===========================================================================
  # 18. DEDU√á√ÉO: LIMITE DE SAQUE II (PODER EXECUTIVO)
  # ===========================================================================
  `18_deducao_limite_saque_ii_poder_executivo` = list(
    criterio = "
    conta_contabil_numero %in% c('218924001', '218924002') &
    orgao_c_cor_codigo %in% c('01000', '02000', '02001', '11000', '12000', 
                              '13000', '14000', '15000', '17000', '34000', 
                              '51100', '53000') &
    isf_lancamento == 'F'
    "
  ),
  
  # ===========================================================================
  # 19. DEDU√á√ÉO: DA DISPONIBILIDADE L√çQUIDA (111110205)
  # ===========================================================================
  `19_deducao_disponibilidade_liquida_111110205` = list(
    criterio = "
    conta_contabil_numero == '111110205'
    "
  ),
  
  # ===========================================================================
  # 20. DEDU√á√ÉO: DEMAIS OBRIGA√á√ïES II
  # ===========================================================================
  `20_deducao_demais_obrigacoes_ii` = list(
    criterio = "
    conta_contabil_numero %in% c('218924001', '218914001') &
    isf_lancamento == 'F'
    "
  ),
  
  # ===========================================================================
  # 21. DEMAIS OBRIGA√á√ïES FINANCEIRAS (NEW)
  # ===========================================================================
  `21_demais_obrigacoes_new` = list(
    criterio = "
    startsWith(conta_contabil_numero, '2') &
    !conta_contabil_numero %in% c('218923901', '218923902', '218923903', 
                                   '218924001', '218914001') &
    isf_lancamento == 'F' &
    ug_executora_codigo != '170600'
    "
  ),
  
  # ===========================================================================
  # 22. DEMAIS OBRIGA√á√ïES - SUBTRA√á√ÉO
  # ===========================================================================
  `22_demais_obrigacoes_subtracao` = list(
    criterio = "
    conta_contabil_numero %in% c('631200000', '631300000', '631520000', '632100000', 
                                  '631540000', '218929031', '218929032', '218929033', 
                                  '531720100', '531710200', '632710000', '632720000')
    "
  )
)





```

```{r}
#| column: screen
#| include: false
# ===============================================================================
# ANEXO 5 RGF - UNI√ÉO E EXECUTIVO (CORRIGIDO)
# Prot√≥tipo em R/RStudio
# ===============================================================================

library(dplyr)
library(tidyr)
library(readxl)
library(writexl)
library(janitor)
library(DT)

# ===============================================================================
# FUN√á√ÉO AUXILIAR
# ===============================================================================

get_col <- function(df, nome_coluna) {
  if (nome_coluna %in% names(df)) {
    return(df[[nome_coluna]])
  } else {
    return(0)
  }
}

# ===============================================================================
# ETAPA 0: CRIAR VARI√ÅVEL ABRANG√äNCIA COM DUPLICA√á√ÉO DE REGISTROS
# ===============================================================================

# Uni√£o: TODOS os registros
rgf_a05_uniao <- rgf_a05 %>%
  mutate(abrangencia = "uniao")

# Executivo: Apenas Poder Executivo, exceto DPU (34000) e MPU (59000)
rgf_a05_executivo <- rgf_a05 %>%
  filter(
    orgao_uge_poder_codigo == "0" & 
    !(orgao_uge_orgao_maximo_codigo %in% c("34000", "59000"))
  ) %>%
  mutate(abrangencia = "executivo")

# Combinar as duas abrang√™ncias (duplicando registros do Executivo)
rgf_a05_abrangencia <- bind_rows(rgf_a05_uniao, rgf_a05_executivo)

# Verificar distribui√ß√£o
cat("=== VERIFICA√á√ÉO DE ABRANG√äNCIA ===\n")
rgf_a05_abrangencia %>% 
  count(abrangencia) %>%
  print()

# Verificar registros exclu√≠dos do Executivo
cat("\n=== √ìRG√ÉOS EXCLU√çDOS DO EXECUTIVO ===\n")
rgf_a05 %>%
  filter(orgao_uge_orgao_maximo_codigo %in% c("34000", "59000")) %>%
  count(orgao_uge_orgao_maximo_codigo, orgao_uge_orgao_maximo_nome) %>%
  print()

# ===============================================================================
# ETAPA 1: APLICAR CRIT√âRIOS E PIVOTAR
# ===============================================================================

# Aplicar crit√©rios de filtro COM abrang√™ncia
resultado_rgf_a05 <- aplicar_criterios(
  df = rgf_a05_abrangencia,
  criterios = criterios_rgf_a05_disponibilidade,
  group_vars = c("linhas", "abrangencia")
)

# Pivotar para formato wide
rgf_a05_wide <- resultado_rgf_a05 %>%
  select(mes_lancamento, linhas, abrangencia, categoria, valor) %>%
  pivot_wider(names_from = categoria, values_from = valor, values_fill = 0)

# ===============================================================================
# ETAPA 2: RENOMEAR COLUNAS B√ÅSICAS
# ===============================================================================

rgf_a05_wide <- rgf_a05_wide %>%
  mutate(
    # Colunas de receitas e despesas
    receitas = get_col(., "01_receitas"),
    despesas = get_col(., "02_despesas"),
    
    # Disponibilidade de caixa
    disponibilidade_caixa_bruta = get_col(., "03_disponibilidade_caixa_bruta"),
    deducao_receitas_classificar = get_col(., "04_deducao_receitas_classificar"),
    
    # Restos a Pagar
    rp_liquidados_nao_pagos_exercicios_anteriores = 
      get_col(., "05_rp_liquidados_nao_pagos_exercicios_anteriores"),
    rp_liquidados_nao_pagos_exercicio = 
      get_col(., "06_rp_liquidados_nao_pagos_exercicio"),
    rp_empenhados_nao_liquidados_exercicios_anteriores = 
      get_col(., "07_rp_empenhados_nao_liquidados_exercicios_anteriores"),
    
    # Obriga√ß√µes
    demais_obrigacoes_new = get_col(., "21_demais_obrigacoes_new"),
    demais_obrigacoes_subtracao = get_col(., "22_demais_obrigacoes_subtracao"),
    
    # TEDs
    conta_894310000_disp_recursos_ted_liberar = 
      get_col(., "15_conta_894310000_disp_recursos_ted_liberar"),
    conta_894320000_disp_recursos_ted_receber = 
      get_col(., "16_conta_894320000_disp_recursos_ted_receber")
  )

# ===============================================================================
# ETAPA 3: CALCULAR DISPONIBILIDADE BRUTA CLEAN
# ===============================================================================

rgf_a05_clean <- rgf_a05_wide %>%
  mutate(
    disponibilidade_bruta_clean = case_when(
      linhas == "7_fundos_orgaos_programa" ~ 
        disponibilidade_caixa_bruta + 
        conta_894320000_disp_recursos_ted_receber - 
        conta_894310000_disp_recursos_ted_liberar,
      
      linhas == "9_nao_classificados" ~ 
        disponibilidade_caixa_bruta - deducao_receitas_classificar,
      
      TRUE ~ disponibilidade_caixa_bruta
    )
  )

# ===============================================================================
# ETAPA 4: CALCULAR DEMAIS OBRIGA√á√ïES FINANCEIRAS CLEAN
# ===============================================================================

rgf_a05_clean <- rgf_a05_clean %>%
  mutate(
    demais_obrigacoes_financeiras_clean = case_when(
      linhas == "7_fundos_orgaos_programa" ~ 
        demais_obrigacoes_new - demais_obrigacoes_subtracao,
      
      TRUE ~ 
        demais_obrigacoes_new - demais_obrigacoes_subtracao + 
        conta_894310000_disp_recursos_ted_liberar - 
        conta_894320000_disp_recursos_ted_receber
    )
  )

# ===============================================================================
# ETAPA 5: LER E PREPARAR DISPONIBILIDADE INICIAL DAS DUAS ABAS
# ===============================================================================

# Ler aba Uni√£o
disp_inicial_uniao <- read_excel("disponibilidade_inicial.xlsx", sheet = "uniao") %>%
  mutate(abrangencia = "uniao")

# Ler aba Executivo
disp_inicial_executivo <- read_excel("disponibilidade_inicial.xlsx", sheet = "executivo") %>%
  mutate(abrangencia = "executivo")

# Combinar as duas abas
disponibilidade_inicial <- bind_rows(disp_inicial_uniao, disp_inicial_executivo)

# ===============================================================================
# ETAPA 6: JOIN COM DISPONIBILIDADE INICIAL
# ===============================================================================

rgf_a05_clean <- rgf_a05_clean %>%
  left_join(disponibilidade_inicial, by = c("linhas", "abrangencia"))

# ===============================================================================
# ETAPA 7: CALCULAR DEMAIS FLUXOS CLEAN
# ===============================================================================

rgf_a05_clean <- rgf_a05_clean %>%
  mutate(
    demais_fluxos_clean = 
      disponibilidade_inicial + 
      receitas - 
      despesas - 
      disponibilidade_bruta_clean
  )

# ===============================================================================
# ETAPA 8: CALCULAR DISPONIBILIDADE ANTES DA INSCRI√á√ÉO DE RP
# ===============================================================================

rgf_a05_clean <- rgf_a05_clean %>%
  mutate(
    disponibilidade_antes_inscr_rp_clean = 
      disponibilidade_bruta_clean - 
      rp_liquidados_nao_pagos_exercicios_anteriores - 
      rp_empenhados_nao_liquidados_exercicios_anteriores - 
      rp_liquidados_nao_pagos_exercicio - 
      demais_obrigacoes_financeiras_clean
  )

# ===============================================================================
# ETAPA 9: SELECIONAR E ORDENAR COLUNAS FINAIS
# ===============================================================================

rgf_a05_final <- rgf_a05_clean %>%
  select(
    mes_lancamento,
    linhas,
    abrangencia,
    disponibilidade_inicial,
    receitas,
    despesas,
    demais_fluxos_clean,
    disponibilidade_bruta_clean,
    rp_liquidados_nao_pagos_exercicios_anteriores,
    rp_liquidados_nao_pagos_exercicio,
    rp_empenhados_nao_liquidados_exercicios_anteriores,
    demais_obrigacoes_financeiras_clean,
    disponibilidade_antes_inscr_rp_clean
  ) %>%
  arrange(abrangencia, linhas)

# ===============================================================================
# ETAPA 10: SEPARAR UNI√ÉO E EXECUTIVO
# ===============================================================================

# Tabela Uni√£o
rgf_a05_uniao <- rgf_a05_final %>%
  filter(abrangencia == "uniao") %>%
  select(-abrangencia)

# Tabela Executivo
rgf_a05_executivo <- rgf_a05_final %>%
  filter(abrangencia == "executivo") %>%
  select(-abrangencia)

# ===============================================================================
# ETAPA 11: FORMATAR TABELAS EM MILH√ïES
# ===============================================================================

formatar_tabela <- function(df) {
  df %>% 
    filter(linhas != "outros") %>% 
    adorn_totals("row") %>%
    mutate(
      across(
        where(is.numeric) & !matches("mes_lancamento"),
        ~ round(.x, 2)
      )
    )
}

rgf_a05_uniao_formatada <- formatar_tabela(rgf_a05_uniao)
rgf_a05_executivo_formatada <- formatar_tabela(rgf_a05_executivo)

# ===============================================================================
# ETAPA 12: EXPORTAR
# ===============================================================================

# write_xlsx(
#   list(
#     "Uniao_Final" = rgf_a05_uniao,
#     "Uniao_Milhoes" = rgf_a05_uniao_formatada,
#     "Executivo_Final" = rgf_a05_executivo,
#     "Executivo_Milhoes" = rgf_a05_executivo_formatada,
#     "Completo" = rgf_a05_final,
#     "Disponibilidade_Inicial" = disponibilidade_inicial
#   ),
#   path = "rgf_a05_final_completo.xlsx"
# )

# ===============================================================================
# ETAPA 13: VISUALIZA√á√ÉO - UNI√ÉO
# ===============================================================================

novos_nomes <- rgf_a05_uniao_formatada %>% 
  select(-mes_lancamento) %>% 
  colnames() %>%
  gsub("_clean", "", .) %>%
  gsub("_", " ", .) %>%
  gsub("nao pagos", "NP", .) %>%
  gsub("exercicios", "exerc.", .) %>%
  gsub("anteriores", "ant.", .) %>%
  gsub("liquidados", "liq.", .) %>%
  gsub("empenhados", "emp.", .) %>%
  gsub("disponibilidade", "disp.", .)







```

```{r rgf_05_tabela_uniao}
#| column: screen

cat("\n=== TABELA UNI√ÉO ===\n")
datatable(
  rgf_a05_uniao_formatada %>% select(-mes_lancamento),
  colnames = novos_nomes,
  caption = "RGF Anexo 5 - UNI√ÉO (Todos os Poderes)",
  options = list(scrollX = TRUE, pageLength = 15),
  rownames = FALSE
) %>%
  formatCurrency(2:11, "", mark = ".", dec.mark = ",", digits = 2)

```

```{r rgf_05_tabela_executivo}
#| column: screen
cat("\n=== TABELA EXECUTIVO ===\n")
datatable(
  rgf_a05_executivo_formatada %>% select(-mes_lancamento),
  colnames = novos_nomes,
  caption = "RGF Anexo 5 - PODER EXECUTIVO (exceto DPU e MPU)",
  options = list(scrollX = TRUE, pageLength = 15),
  rownames = FALSE
) %>%
  formatCurrency(2:11, "", mark = ".", dec.mark = ",", digits = 2)
```

# RREO - Relat√≥rio Resumido de Execu√ß√£o Or√ßament√°ria

# üìã RREO Anexo 01 - Balan√ßo Or√ßament√°rio {#sec-anexo-07}

```{r}

criterios_rreo_A01_receitas_bo  <- list(
  
  # ========== RECEITAS CORRENTES ==========
  
  # RECEITAS CORRENTES
  `01_receitas_correntes` = list(
    criterio = "nre1_categoria_economica_codigo == 1"
  ),
  
  # IMPOSTOS, TAXAS E CONTRIBUI√á√ïES DE MELHORIA
  `02_impostos_taxas_contrib_melhoria` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 1 &
    nre3_especie_receita_codigo_especie %in% c(1, 2, 3)
    "
  ),
  
  # IMPOSTOS
  `03_impostos` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 1 &
    nre3_especie_receita_codigo_especie == 1
    "
  ),
  
  # TAXAS
  `04_taxas` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 1 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  # CONTRIBUI√á√ïES
  `05_contribuicoes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 2
    "
  ),
  
  # CONTRIBUI√á√ïES SOCIAIS
  `06_contribuicoes_sociais` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 2 &
    nre3_especie_receita_codigo_especie == 1
    "
  ),
  
  # CONTRIBUI√á√ïES DE INTERVEN√á√ÉO NO DOM√çNIO ECON√îMICO
  `07_contrib_intervencao_dominio_economico` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 2 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  # RECEITA PATRIMONIAL
  `08_receita_patrimonial` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3
    "
  ),
  
  # EXPLORA√á√ÉO DO PATRIM√îNIO IMOBILI√ÅRIO DO ESTADO
  `09_exploracao_patrimonio_imobiliario` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3 &
    nre3_especie_receita_codigo_especie == 1
    "
  ),
  
  # VALORES MOBILI√ÅRIOS
  `10_valores_mobiliarios` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  # DELEGA√á√ÉO DE SERVI√áOS P√öBLICOS
  `11_delegacao_servicos_publicos` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3 &
    nre3_especie_receita_codigo_especie == 3
    "
  ),
  
  # EXPLORA√á√ÉO DE RECURSOS NATURAIS
  `12_exploracao_recursos_naturais` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3 &
    nre3_especie_receita_codigo_especie == 4
    "
  ),
  
  # EXPLORA√á√ÉO DO PATRIM√îNIO INTANG√çVEL
  `13_exploracao_patrimonio_intangivel` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3 &
    nre3_especie_receita_codigo_especie == 5
    "
  ),
  
  # CESS√ÉO DE DIREITOS
  `14_cessao_direitos` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3 &
    nre3_especie_receita_codigo_especie == 6
    "
  ),
  
  # DEMAIS RECEITAS PATRIMONIAIS
  `15_demais_receitas_patrimoniais` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3 &
    nre3_especie_receita_codigo_especie == 9
    "
  ),
  
  # RECEITA AGROPECU√ÅRIA
  `16_receita_agropecuaria` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 4
    "
  ),
  
  # RECEITA INDUSTRIAL
  `17_receita_industrial` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 5
    "
  ),
  
  # RECEITAS DE SERVI√áOS
  `18_receitas_servicos` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 6
    "
  ),
  
  # SERVI√áOS ADMINISTRATIVOS E COMERCIAIS GERAIS
  `19_servicos_admin_comerciais` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '161')"
  ),
  
  # SERVI√áOS E ATIVIDADES REFERENTES √Ä NAVEGA√á√ÉO E AO TRANSPORTE
  `20_servicos_navegacao_transporte` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '162')"
  ),
  
  # SERVI√áOS E ATIVIDADES REFERENTES √Ä SA√öDE
  `21_servicos_saude` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '163')"
  ),
  
  # SERVI√áOS E ATIVIDADES FINANCEIRAS
  `22_servicos_financeiros` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '164')"
  ),
  
  # OUTROS SERVI√áOS
  `23_outros_servicos` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '169')"
  ),
  
  # TRANSFER√äNCIAS CORRENTES
  `24_transferencias_correntes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 7
    "
  ),
  
  # TRANSFER√äNCIAS DA UNI√ÉO E DE SUAS ENTIDADES
  `25_transf_uniao_entidades` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 7 &
    nre3_especie_receita_codigo_especie == 1
    "
  ),
  
  # TRANSFER√äNCIAS DOS ESTADOS E DO DISTRITO FEDERAL E DE SUAS ENTIDADES
  `26_transf_estados_df_entidades` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 7 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  # TRANSFER√äNCIAS DOS MUNIC√çPIOS E DE SUAS ENTIDADES
  `27_transf_municipios_entidades` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 7 &
    nre3_especie_receita_codigo_especie == 3
    "
  ),
  
  # TRANSFER√äNCIAS DE INSTITUI√á√ïES PRIVADAS
  `28_transf_instituicoes_privadas` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 7 &
    nre3_especie_receita_codigo_especie == 4
    "
  ),
  
  # TRANSFER√äNCIAS DE OUTRAS INSTITUI√á√ïES P√öBLICAS
  `29_transf_outras_instituicoes_publicas` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 7 &
    nre3_especie_receita_codigo_especie == 5
    "
  ),
  
  # TRANSFER√äNCIAS DO EXTERIOR
  `30_transf_exterior` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 7 &
    nre3_especie_receita_codigo_especie == 6
    "
  ),
  
  # DEMAIS TRANSFER√äNCIAS CORRENTES
  `31_demais_transf_correntes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 7 &
    nre3_especie_receita_codigo_especie == 9
    "
  ),
  
  # OUTRAS RECEITAS CORRENTES
  `32_outras_receitas_correntes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 9
    "
  ),
  
  # MULTAS ADMINISTRATIVAS, CONTRATUAIS E JUDICIAIS
  `33_multas_admin_contratuais` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 9 &
    nre3_especie_receita_codigo_especie == 1
    "
  ),
  
  # INDENIZA√á√ïES, RESTITUI√á√ïES E RESSARCIMENTOS
  `34_indenizacoes_restituicoes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 9 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  # BENS, DIREITOS E VALORES INCORPORADOS AO PATRIM√îNIO P√öBLICO
  `35_bens_direitos_valores` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 9 &
    nre3_especie_receita_codigo_especie == 3
    "
  ),
  
  # MULTAS E JUROS DE MORA DAS RECEITAS DE CAPITAL
  `36_multas_juros_mora_capital` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 9 &
    nre3_especie_receita_codigo_especie == 4
    "
  ),
  
  # DEMAIS RECEITAS CORRENTES
  `37_demais_receitas_correntes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 9 &
    nre3_especie_receita_codigo_especie == 9
    "
  ),
  
  # RECEITAS CORRENTES A CLASSIFICAR
  `38_receitas_correntes_classificar` = list(
    criterio = "
    nre2_origem_receita_codigo_origem == 8 &
    nre3_especie_receita_codigo_especie == 8
    "
  ),
  
  # ========== RECEITAS DE CAPITAL ==========
  
  # RECEITAS DE CAPITAL
`39_receitas_capital` = list(
  criterio = "
  nre1_categoria_economica_codigo == 2 &
  !(startsWith(natureza_receita_codigo_completo, '21110201') |
    startsWith(natureza_receita_codigo_completo, '21210201'))
  "
),
  
 # OPERA√á√ïES DE CR√âDITO
`40_operacoes_credito` = list(
  criterio = "
  nre1_categoria_economica_codigo == 2 & 
  nre2_origem_receita_codigo_origem == 1 &
  !(startsWith(natureza_receita_codigo_completo, '21110201') |
    startsWith(natureza_receita_codigo_completo, '21210201'))
  "
),

# OPERA√á√ïES DE CR√âDITO INTERNAS
`41_operacoes_credito_internas` = list(
  criterio = "
  nre1_categoria_economica_codigo == 2 & 
  nre2_origem_receita_codigo_origem == 1 &
  nre3_especie_receita_codigo_especie == 1 &
  !startsWith(natureza_receita_codigo_completo, '21110201')
  "
),

# OPERA√á√ïES DE CR√âDITO EXTERNAS
`42_operacoes_credito_externas` = list(
  criterio = "
  nre1_categoria_economica_codigo == 2 & 
  nre2_origem_receita_codigo_origem == 1 &
  nre3_especie_receita_codigo_especie == 2 &
  !startsWith(natureza_receita_codigo_completo, '21210201')
  "
),
  
  # ALIENA√á√ÉO DE BENS
  `43_alienacao_bens` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 2
    "
  ),
  
  # ALIENA√á√ÉO DE BENS M√ìVEIS
  `44_alienacao_bens_moveis` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 2 &
    nre3_especie_receita_codigo_especie == 1
    "
  ),
  
  # ALIENA√á√ÉO DE BENS IM√ìVEIS
  `45_alienacao_bens_imoveis` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 2 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  # ALIENA√á√ÉO DE BENS INTANG√çVEIS
  `46_alienacao_bens_intangiveis` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '223')"
  ),
  
  # AMORTIZA√á√ïES DE EMPR√âSTIMOS
  `47_amortizacoes_emprestimos` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 3
    "
  ),
  
  # TRANSFER√äNCIAS DE CAPITAL
  `48_transferencias_capital` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 4
    "
  ),
  
  # TRANSFER√äNCIAS DOS ESTADOS E DO DISTRITO FEDERAL E DE SUAS ENTIDADES (CAPITAL)
  `49_transf_estados_df_capital` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 4 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  # TRANSFER√äNCIAS DOS MUNIC√çPIOS E DE SUAS ENTIDADES (CAPITAL)
  `50_transf_municipios_capital` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 4 &
    nre3_especie_receita_codigo_especie == 3
    "
  ),
  
  # TRANSFER√äNCIAS DE INSTITUI√á√ïES PRIVADAS (CAPITAL)
  `51_transf_instituicoes_privadas_capital` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 4 &
    nre3_especie_receita_codigo_especie == 4
    "
  ),
  
  # TRANSFER√äNCIAS DE OUTRAS INSTITUI√á√ïES P√öBLICAS (CAPITAL)
  `52_transf_outras_instituicoes_publicas_capital` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 4 &
    nre3_especie_receita_codigo_especie == 5
    "
  ),
  
  # TRANSFER√äNCIAS DO EXTERIOR (CAPITAL)
  `53_transf_exterior_capital` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 4 &
    nre3_especie_receita_codigo_especie == 6
    "
  ),
  
  # DEMAIS TRANSFER√äNCIAS DE CAPITAL
  `54_demais_transf_capital` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 4 &
    nre3_especie_receita_codigo_especie == 9
    "
  ),
  
  # OUTRAS RECEITAS DE CAPITAL
  `55_outras_receitas_capital` = list(
    criterio = "
    nre2_origem_receita_codigo_origem == 9 &
    nre1_categoria_economica_codigo == 2
    "
  ),
  
  # RESULTADO DO BANCO CENTRAL DO BRASIL
  `56_resultado_banco_central` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 9 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  # REMUNERA√á√ÉO DAS DISPONIBILIDADES DO TESOURO
  `57_remuneracao_disponibilidades_tesouro` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '293')"
  ),
  
  # ========== RECEITAS INTRA-OR√áAMENT√ÅRIAS ==========
  
  # RECEITAS CORRENTES INTRA
  `58_receitas_correntes_intra` = list(
    criterio = "nre1_categoria_economica_codigo == 7"
  ),
  
  # IMPOSTOS, TAXAS E CONTRIBUI√á√ïES DE MELHORIA INTRA
  `59_impostos_taxas_contrib_melhoria_intra` = list(
    criterio = "
    nre1_categoria_economica_codigo == 7 & 
    nre2_origem_receita_codigo_origem == 1
    "
  ),
  
  # IMPOSTOS INTRA
  `60_impostos_intra` = list(
    criterio = "
    nre1_categoria_economica_codigo == 7 & 
    nre2_origem_receita_codigo_origem == 1 &
    nre3_especie_receita_codigo_especie == 1
    "
  ),
  
  # TAXAS INTRA
  `61_taxas_intra` = list(
    criterio = "
    nre1_categoria_economica_codigo == 7 & 
    nre2_origem_receita_codigo_origem == 1 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  # CONTRIBUI√á√ïES INTRA
  `62_contribuicoes_intra` = list(
    criterio = "
    nre1_categoria_economica_codigo == 7 & 
    nre2_origem_receita_codigo_origem == 2
    "
  ),
  
  # CONTRIBUI√á√ïES SOCIAIS INTRA
  `63_contribuicoes_sociais_intra` = list(
    criterio = "
    nre1_categoria_economica_codigo == 7 & 
    nre2_origem_receita_codigo_origem == 2 &
    nre3_especie_receita_codigo_especie == 1
    "
  ),
  
  # CONTRIBUI√á√ïES ECON√îMICAS INTRA
  `64_contribuicoes_economicas_intra` = list(
    criterio = "
    nre1_categoria_economica_codigo == 7 & 
    nre2_origem_receita_codigo_origem == 2 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  # RECEITA PATRIMONIAL INTRA
  `65_receita_patrimonial_intra` = list(
    criterio = "
    nre1_categoria_economica_codigo == 7 & 
    nre2_origem_receita_codigo_origem == 3
    "
  ),
  
  # EXPLORA√á√ÉO PATRIM√îNIO IMOBILI√ÅRIO INTRA
  `66_exploracao_patrimonio_imobiliario_intra` = list(
    criterio = "
    nre1_categoria_economica_codigo == 7 & 
    nre2_origem_receita_codigo_origem == 3 &
    nre3_especie_receita_codigo_especie == 1
    "
  ),
  
  # VALORES MOBILI√ÅRIOS INTRA
  `67_valores_mobiliarios_intra` = list(
    criterio = "
    nre1_categoria_economica_codigo == 7 & 
    nre2_origem_receita_codigo_origem == 3 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  # DELEGA√á√ÉO SERVI√áOS P√öBLICOS INTRA
  `68_delegacao_servicos_publicos_intra` = list(
    criterio = "
    nre1_categoria_economica_codigo == 7 & 
    nre2_origem_receita_codigo_origem == 3 &
    nre3_especie_receita_codigo_especie == 3
    "
  ),
  
  # RECEITA INDUSTRIAL INTRA
  `69_receita_industrial_intra` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '75')"
  ),
  
  # RECEITA DE SERVI√áOS INTRA
  `70_receita_servicos_intra` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '76')"
  ),
  
  # SERVI√áOS ADMINISTRATIVOS COMERCIAIS INTRA
  `71_servicos_admin_comerciais_intra` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '761')"
  ),
  
  # SERVI√áOS E ATIVIDADES REFERENTES √Ä SA√öDE INTRA
  `72_servicos_saude_intra` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '763')"
  ),
  
  # SERVI√áOS E ATIVIDADES FINANCEIRAS INTRA
  `73_servicos_financeiros_intra` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '764')"
  ),
  
  # OUTROS SERVI√áOS INTRA
  `74_outros_servicos_intra` = list(
    criterio = "startsWith(natureza_receita_codigo_completo, '769')"
  ),
  
  # OUTRAS RECEITAS CORRENTES INTRA
  `75_outras_receitas_correntes_intra` = list(
    criterio = "
    nre1_categoria_economica_codigo == 7 & 
    nre2_origem_receita_codigo_origem == 9
    "
  ),
  
  # MULTAS ADMINISTRATIVAS, CONTRATUAIS E JUDICIAIS INTRA
  `76_multas_admin_contratuais_intra` = list(
    criterio = "
    nre1_categoria_economica_codigo == 7 & 
    nre2_origem_receita_codigo_origem == 9 &
    nre3_especie_receita_codigo_especie == 1
    "
  ),
  
  # INDENIZA√á√ïES, RESTITUI√á√ïES E RESSARCIMENTOS INTRA
  `77_indenizacoes_restituicoes_intra` = list(
    criterio = "
    nre1_categoria_economica_codigo == 7 & 
    nre2_origem_receita_codigo_origem == 9 &
    nre3_especie_receita_codigo_especie == 2
    "
  ),
  
  # DEMAIS RECEITAS CORRENTES INTRA
  `78_demais_receitas_correntes_intra` = list(
    criterio = "
    nre1_categoria_economica_codigo == 7 & 
    nre2_origem_receita_codigo_origem == 9 &
    nre3_especie_receita_codigo_especie == 9
    "
  ),
  
  # ========== SUBTOTAIS E OPERA√á√ïES DE REFINANCIAMENTO ==========
  
  # SUBTOTAL DAS RECEITAS (III) = (I + II)
  `79_subtotal_receitas` = list(
    criterio = "
    nre1_categoria_economica_codigo %in% c(1, 2, 7, 8) &
    !(startsWith(natureza_receita_codigo_completo, '21110201') |
      startsWith(natureza_receita_codigo_completo, '21210201') |
      startsWith(natureza_receita_codigo_completo, '81110201') |
      startsWith(natureza_receita_codigo_completo, '81210201'))
    "
  ),
  
  # OPERA√á√ïES DE CR√âDITO - REFINANCIAMENTO (IV)
  `80_operacoes_credito_refinanciamento` = list(
    criterio = "
    startsWith(natureza_receita_codigo_completo, '21110201') |
    startsWith(natureza_receita_codigo_completo, '21210201') |
    startsWith(natureza_receita_codigo_completo, '81110201') |
    startsWith(natureza_receita_codigo_completo, '81210201')
    "
  ),
  
  # OPERA√á√ïES DE CR√âDITO INTERNAS - REFINANCIAMENTO
  `81_operacoes_credito_internas_refinanciamento` = list(
    criterio = "
    startsWith(natureza_receita_codigo_completo, '21110201') |
    startsWith(natureza_receita_codigo_completo, '81110201')
    "
  ),
  
  # MOBILI√ÅRIA - REFINANCIAMENTO (CR√âDITO INTERNO)
  `82_mobiliaria_refinanciamento_interno` = list(
    criterio = "
    startsWith(natureza_receita_codigo_completo, '21110201') |
    startsWith(natureza_receita_codigo_completo, '81110201')
    "
  ),
  
  # OPERA√á√ïES DE CR√âDITO EXTERNAS - REFINANCIAMENTO
  `83_operacoes_credito_externas_refinanciamento` = list(
    criterio = "
    startsWith(natureza_receita_codigo_completo, '212102') |
    startsWith(natureza_receita_codigo_completo, '812102')
    "
  ),
  
  # MOBILI√ÅRIA - REFINANCIAMENTO (CR√âDITO EXTERNO)
  `84_mobiliaria_refinanciamento_externo` = list(
    criterio = "
    startsWith(natureza_receita_codigo_completo, '212102') |
    startsWith(natureza_receita_codigo_completo, '812102')
    "
  ),
  
  # SUBTOTAL COM REFINANCIAMENTO (V) = (III + IV)
  `85_subtotal_com_refinanciamento` = list(
    criterio = "nre1_categoria_economica_codigo %in% c(1, 2, 7, 8)"
  )
)
aplicar_criterios(dados_receita, criterios_rreo_A01_receitas_bo, group_vars = c("item_informacao_codigo", "item_informacao_nome")  )
```

```{r}

criterios_rreo_A01_despesas_bo <- list(
  
  # ========== DESPESAS (Exceto Intra-Or√ßament√°rias) (IX) ==========
  
  # DESPESAS (Exceto Intra-Or√ßament√°rias) (IX)
  `01_despesas_exceto_intra` = list(
    criterio = "
    modalidade_aplicacao_codigo != 91 &
    !(elemento_despesa_codigo %in% c('76', '77') &
      subfuncao_governo_codigo %in% c('841', '842', '843', '844', '846') &
      fonte_recursos_codigo == '443')
    "
  ),
  
  # ========== DESPESAS CORRENTES ==========
  
  # DESPESAS CORRENTES
  `02_despesas_correntes` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    modalidade_aplicacao_codigo != 91
    "
  ),
  
  # PESSOAL E ENCARGOS SOCIAIS
  `03_pessoal_encargos_sociais` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 1 &
    modalidade_aplicacao_codigo != 91
    "
  ),
  
  # JUROS E ENCARGOS DA D√çVIDA
  `04_juros_encargos_divida` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 2 &
    modalidade_aplicacao_codigo != 91
    "
  ),
  
  # OUTRAS DESPESAS CORRENTES
  `05_outras_despesas_correntes` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 3 &
    modalidade_aplicacao_codigo != 91
    "
  ),
  
  # TRANSFER√äNCIA A ESTADOS, DF E MUNIC√çPIOS
  `06_transferencia_estados_df_municipios` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 3 &
    modalidade_aplicacao_codigo %in% c('30', '31', '32', '40', '41', '42', '43', '44', '45', '46') &
    modalidade_aplicacao_codigo != 91
    "
  ),
  
  # BENEF√çCIOS PREVIDENCI√ÅRIOS
  `07_beneficios_previdenciarios` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 3 &
    modalidade_aplicacao_codigo != 91 &
    unidade_orcamentaria_codigo %in% c('55902', '40904', '33904', '25917')
    "
  ),
  
  # DEMAIS DESPESAS CORRENTES
  `08_demais_despesas_correntes` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 3 &
    modalidade_aplicacao_codigo != 91 &
    !(modalidade_aplicacao_codigo %in% c('30', '31', '32', '40', '41', '42', '43', '44', '45', '46')) &
    !(unidade_orcamentaria_codigo %in% c('55902', '40904', '33904', '25917'))
    "
  ),
  
  # ========== DESPESAS DE CAPITAL ==========
  
  # DESPESAS DE CAPITAL (corrigido)
  `09_despesas_capital` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 &
    modalidade_aplicacao_codigo != 91 &
    !(elemento_despesa_codigo %in% c('76', '77') &
      subfuncao_governo_codigo %in% c('841', '842', '843', '844', '846') &
      fonte_recursos_codigo == '443')
    "
  ),
  
  # INVESTIMENTOS
  `10_investimentos` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 &
    grupo_despesa_codigo_grupo == 4 &
    modalidade_aplicacao_codigo != 91
    "
  ),
  
  # INVERS√ïES FINANCEIRAS
  `11_inversoes_financeiras` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 &
    grupo_despesa_codigo_grupo == 5 &
    modalidade_aplicacao_codigo != 91
    "
  ),
  
  # AMORTIZA√á√ÉO DA D√çVIDA
  `12_amortizacao_divida` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 &
    grupo_despesa_codigo_grupo == 6 &
    modalidade_aplicacao_codigo != 91 &
    !(elemento_despesa_codigo %in% c('76', '77') &
      subfuncao_governo_codigo %in% c('841', '842', '843', '844', '846') &
      fonte_recursos_codigo == '443')
    "
  ),
  
  # ========== RESERVA DE CONTING√äNCIA ==========
  
  # RESERVA DE CONTING√äNCIA
  `13_reserva_contingencia` = list(
    criterio = "
    categoria_economica_despesa_codigo == 9 &
    modalidade_aplicacao_codigo != 91
    "
  ),
  
  # ========== DESPESAS INTRA-OR√áAMENT√ÅRIAS ==========
  
  # DESPESAS INTRA-OR√áAMENT√ÅRIAS (X)
  `14_despesas_intra` = list(
    criterio = "modalidade_aplicacao_codigo == 91"
  ),
  
  # DESPESAS CORRENTES INTRA
  `15_despesas_correntes_intra` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    modalidade_aplicacao_codigo == 91
    "
  ),
  
  # PESSOAL E ENCARGOS SOCIAIS INTRA
  `16_pessoal_encargos_sociais_intra` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 1 &
    modalidade_aplicacao_codigo == 91
    "
  ),
  
  # JUROS E ENCARGOS DA D√çVIDA INTRA
  `17_juros_encargos_divida_intra` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 2 &
    modalidade_aplicacao_codigo == 91
    "
  ),
  
  # OUTRAS DESPESAS CORRENTES INTRA
  `18_outras_despesas_correntes_intra` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 3 &
    modalidade_aplicacao_codigo == 91
    "
  ),
  
  # BENEF√çCIOS PREVIDENCI√ÅRIOS INTRA
  `19_beneficios_previdenciarios_intra` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 3 &
    modalidade_aplicacao_codigo == 91 &
    unidade_orcamentaria_codigo %in% c('55902', '40904', '33904', '25917')
    "
  ),
  
  # DEMAIS DESPESAS CORRENTES INTRA
  `20_demais_despesas_correntes_intra` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 &
    grupo_despesa_codigo_grupo == 3 &
    modalidade_aplicacao_codigo == 91 &
    !(unidade_orcamentaria_codigo %in% c('55902', '40904', '33904', '25917'))
    "
  ),
  
  # DESPESAS DE CAPITAL INTRA
  `21_despesas_capital_intra` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 &
    modalidade_aplicacao_codigo == 91
    "
  ),
  
  # INVESTIMENTOS INTRA
  `22_investimentos_intra` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 &
    grupo_despesa_codigo_grupo == 4 &
    modalidade_aplicacao_codigo == 91
    "
  ),
  
  # INVERS√ïES FINANCEIRAS INTRA
  `23_inversoes_financeiras_intra` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 &
    grupo_despesa_codigo_grupo == 5 &
    modalidade_aplicacao_codigo == 91
    "
  ),
  
  # AMORTIZA√á√ÉO DA D√çVIDA INTRA
  `24_amortizacao_divida_intra` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 &
    grupo_despesa_codigo_grupo == 6 &
    modalidade_aplicacao_codigo == 91 &
    !(elemento_despesa_codigo %in% c('76', '77') &
      subfuncao_governo_codigo %in% c('841', '842', '843', '844', '846') &
      fonte_recursos_codigo == '443')
    "
  ),
  
  # RESERVA DE CONTING√äNCIA INTRA
  `25_reserva_contingencia_intra` = list(
    criterio = "
    categoria_economica_despesa_codigo == 9 &
    modalidade_aplicacao_codigo == 91
    "
  ),
  
  # ========== SUBTOTAIS ==========
  
  # SUBTOTAL DAS DESPESAS (XI) = (IX + X)
  `26_subtotal_despesas` = list(
    criterio = "
    categoria_economica_despesa_codigo %in% c(3, 4, 9) &
    !(elemento_despesa_codigo %in% c('76', '77') &
      subfuncao_governo_codigo %in% c('841', '842', '843', '844', '846') &
      fonte_recursos_codigo == '443')
    "
  ),
  
  # ========== AMORTIZA√á√ÉO DA D√çVIDA - REFINANCIAMENTO ==========
  
  # AMORTIZA√á√ÉO DA D√çVIDA - REFINANCIAMENTO (XII)
  `27_amortizacao_divida_refinanciamento` = list(
    criterio = "
    grupo_despesa_codigo_grupo == 6 &
    elemento_despesa_codigo %in% c('76', '77') &
    subfuncao_governo_codigo %in% c('841', '842', '843', '844', '846') &
    fonte_recursos_codigo == '443'
    "
  ),
  
  # AMORTIZA√á√ÉO DA D√çVIDA INTERNA
  `28_amortizacao_divida_interna` = list(
    criterio = "
    grupo_despesa_codigo_grupo == 6 &
    elemento_despesa_codigo %in% c('76', '77') &
    subfuncao_governo_codigo %in% c('841', '843', '846') &
    fonte_recursos_codigo == '443'
    "
  ),
  
  # D√çVIDA MOBILI√ÅRIA
  `29_divida_mobiliaria` = list(
    criterio = "
    grupo_despesa_codigo_grupo == 6 &
    elemento_despesa_codigo == '76' &
    subfuncao_governo_codigo %in% c('841', '843', '846') &
    fonte_recursos_codigo == '443'
    "
  ),
  
  # OUTRAS D√çVIDAS
  `30_outras_dividas` = list(
    criterio = "
    grupo_despesa_codigo_grupo == 6 &
    elemento_despesa_codigo == '77' &
    subfuncao_governo_codigo %in% c('841', '843', '846') &
    fonte_recursos_codigo == '443'
    "
  ),
  
  # AMORTIZA√á√ÉO DA D√çVIDA EXTERNA
  `31_amortizacao_divida_externa` = list(
    criterio = "
    grupo_despesa_codigo_grupo == 6 &
    elemento_despesa_codigo %in% c('76', '77') &
    subfuncao_governo_codigo %in% c('842', '844') &
    fonte_recursos_codigo == '443'
    "
  ),
  
  # D√çVIDA MOBILI√ÅRIA (EXTERNA)
  `32_divida_mobiliaria_externa` = list(
    criterio = "
    grupo_despesa_codigo_grupo == 6 &
    elemento_despesa_codigo == '76' &
    subfuncao_governo_codigo %in% c('842', '844') &
    fonte_recursos_codigo == '443'
    "
  ),
  
  # OUTRAS D√çVIDAS (EXTERNA)
  `33_outras_dividas_externa` = list(
    criterio = "
    grupo_despesa_codigo_grupo == 6 &
    elemento_despesa_codigo == '77' &
    subfuncao_governo_codigo %in% c('842', '844') &
    fonte_recursos_codigo == '443'
    "
  ),
  
  # SUBTOTAL COM REFINANCIAMENTO (XIII) = (XI + XII)
  `34_subtotal_com_refinanciamento` = list(
    criterio = "categoria_economica_despesa_codigo %in% c(3, 4, 9)"
  )
)
aplicar_criterios(dados_despesa, criterios_rreo_A01_despesas_bo, group_vars = c( "item_informacao_codigo","item_informacao_nome"))

# bo_depsesa <- (aplicar_criterios(dados_despesa %>% filter(item_informacao_codigo == "25"), criterios_rreo_A01_despesas_bo))
# 
# datatable(bo_depsesa  %>% group_by(ordem, nome) %>% summarise(valor = sum(valor)))%>% formatRound("valor", 2, mark = ".", dec.mark = "," )
# 
# 
# datatable(dados_despesa %>%filter(item_informacao_codigo == 23, tipo_modalidade != "intra") %>% group_by(categoria_economica_despesa_codigo, categoria_economica_despesa_nome, grupo_despesa_codigo_grupo,grupo_despesa_nome , refinanciamento, tipo_modalidade) %>% summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao)))%>% formatRound("saldo_r_item_informacao", 2, mark = ".", dec.mark = "," )
# 
# 
# datatable(dados_despesa %>%filter(item_informacao_codigo == 9, tipo_modalidade != "intra") %>% group_by(categoria_economica_despesa_codigo, categoria_economica_despesa_nome,  refinanciamento, tipo_modalidade) %>% summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao)))%>% formatRound("saldo_r_item_informacao", 2, mark = ".", dec.mark = "," )
```

```{r}
# datatable(dados_despesa %>% filter(mes_lancamento == mes_filtro, tipo_modalidade != "intra", item_informacao_nome == "DESPESAS PAGAS") %>% group_by(refinanciamento, grupo_despesa_codigo_grupo, grupo_despesa_nome) %>% summarise(despesa_empenhada = sum(saldo_r_item_informacao, na.rm = TRUE) )  %>% adorn_totals("row"), rownames = FALSE,
#   colnames = c("refinanciamento", "Grupo c√≥digo", "Grupo Nome", "Despesa empenhada"))%>% formatRound("despesa_empenhada", 2, mark = ".", dec.mark = "," )%>% 
#   DT::formatStyle(columns = colnames(.$x$data), fontSize = '75%')
```

Voc√™ estava tentando fazer o pivot com dados **n√£o agregados**, onde cada combina√ß√£o de chaves tinha milhares de registros. Agregando primeiro com `sum()`, voc√™ ter√° apenas **12 linhas** (uma para cada combina√ß√£o √∫nica).

```{r}
# agrupado_despesa_tipo_modalidade_refinanciamento_categoria_grupo <- c( "tipo_modalidade"  ,"refinanciamento","categoria_economica_despesa_codigo", "categoria_economica_despesa_nome", "grupo_despesa_codigo_grupo", "grupo_despesa_nome")
# 
# 
# dados_agregados <- dados_despesa %>% 
#   filter(mes_lancamento == mes_filtro) %>%
#   group_by(across(all_of(c(agrupado_despesa_tipo_modalidade_refinanciamento_categoria_grupo, "item_informacao_nome")))) %>%
#   summarise(
#     saldo_r_item_informacao = sum(saldo_r_item_informacao, na.rm = TRUE),
#     .groups = "drop"
#   )
# 
# dt_formatada(
#   tabela_pivotada(dados_agregados, agrupado_despesa_tipo_modalidade_refinanciamento_categoria_grupo), 
#   agrupado_despesa_tipo_modalidade_refinanciamento_categoria_grupo
# )
```

### Resultado Or√ßament√°rio

```{r}
#| eval: true
(formatar_numero (resultado_orcamentario <- as.numeric(df_criterios_rreo_A01_receitas_bo %>% filter(ordem == "85", item_informacao_codigo == "5") %>% summarise(valor= valor))-as.numeric(df_criterios_rreo_A01_despesas_bo %>% filter(ordem == "34", item_informacao_codigo == "25") %>% summarise(valor= valor))) )



df_resultado <- tibble(
  Receita = as.numeric(df_criterios_rreo_A01_receitas_bo %>% 
                        filter(ordem == "85", item_informacao_codigo == "5") %>% 
                        pull(valor)),
  Despesa = as.numeric(df_criterios_rreo_A01_despesas_bo %>% 
                        filter(ordem == "34", item_informacao_codigo == "25") %>% 
                        pull(valor))
) %>%
  mutate(Resultado_Orcamentario = Receita - Despesa) %>%
  pivot_longer(
    cols = everything(),
    names_to = "Tipo",
    values_to = "Valor"
  )

# Exibir com DT::datatable formatado
DT::datatable(
  df_resultado,
  options = list(dom = 't', pageLength = 3),
  rownames = FALSE
) %>%
  DT::formatCurrency("Valor", currency = "R$ ", digits = 2, mark = ".", dec.mark = ",")
```

# üìã RREO Anexo 02 - Fun√ß√£o e Subfun√ß√£o

```{r}
datatable(dados_despesa %>% group_by( refinanciamento) %>% filter(item_informacao_codigo == 23) %>% summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao)) %>% adorn_totals() )%>% formatRound("saldo_r_item_informacao", 2, mark = ".", dec.mark = "," )%>% 
  DT::formatStyle(columns = colnames(.$x$data), fontSize = '100%')

# datatable(dados_despesa %>% group_by(funcao_governo_codigo, funcao_governo_nome, refinanciamento) %>% filter(item_informacao_codigo == 23) %>% summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao)) %>% adorn_totals() )%>% formatRound("saldo_r_item_informacao", 2, mark = ".", dec.mark = "," )%>% 
#   DT::formatStyle(columns = colnames(.$x$data), fontSize = '75%')
```

# üìã RREO Anexo 03 - RCL

```{r}
#| code-fold: true
#| output: false


# ===============================================================================
# CRIT√âRIOS PARA RECEITAS - ANEXO 3 RCL
# ===============================================================================

criterios_rreo_A03_rcl_receitas_rcl <- list(
  
  # === RECEITAS CORRENTES POR ORIGEM (01-09) ===
  
  # IMPOSTOS, TAXAS E CONTRIBUI√á√ïES DE MELHORIA
  `01  Impostos, Taxas e Contribui√ß√µes de Melhoria` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 1"
  ),
  
  # RECEITA DE CONTRIBUI√á√ïES
  `02  Receita de Contribui√ß√µes` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 2"
  ),
  
  # RECEITA PATRIMONIAL
  `03  Receita Patrimonial` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 3"
  ),
  
  # RECEITA AGROPECU√ÅRIA
  `04  Receita Agropecu√°ria` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 4"
  ),
  
  # RECEITA INDUSTRIAL
  `05  Receita Industrial` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 5"
  ),
  
  # RECEITA DE SERVI√áOS
  `06  Receita de Servi√ßos` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 6"
  ),
  
  # TRANSFER√äNCIAS CORRENTES
  `07  Transfer√™ncias Correntes` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 7"
  ),
  
  # RECEITAS CORRENTES A CLASSIFICAR
  `08  Receitas Correntes a Classificar` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 8"
  ),
  
  # OUTRAS RECEITAS CORRENTES
  `09  Outras Receitas Correntes` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 9"
  ),
  
  # === ITENS ESPEC√çFICOS PARA C√ÅLCULO DA RCL ===
  
  # TRANSFER√äNCIAS CONSTITUCIONAIS E LEGAIS
  `10  Transfer√™ncias Constitucionais e Legais` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 7 & (
      grepl('FPE|FPM|CONSTITUCIONAL|LEGAL', natureza_receita_nome, ignore.case = TRUE) |
      grepl('^172[0-9]', natureza_receita_codigo_completo) |
      grepl('^171[0-9]', natureza_receita_codigo_completo)
    )
    "
  ),
  
  # CONTRIB. EMPREGADORES E TRAB. PARA SEG. SOCIAL
  `11  Contrib. Empregadores e Trabalhadores para Seguridade Social` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & fonte_recursos_codigo == '054' & 
    !natureza_receita_codigo_completo %in% c(
      '19900300', '19900310', '19900311', '19900312', '19900313', '19900314',
      '19990300', '19990301', '19990302', '19990303', '19990304'
    )
    "
  ),
  
  # CONTRIB. DO SERVIDOR PARA O PLANO DE PREVID√äNCIA
  `12  Contrib. Plano Seguridade Social do Servidor` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & (
      fonte_recursos_codigo %in% c('055', '056') |
      natureza_receita_codigo_completo == '12150116'
    )
    "
  ),
  
  # COMPENSA√á√ÉO FINANC. ENTRE REGIMES PREVID√äNCIA
  `13  Compensa√ß√£o Financeira entre Regimes RPPS` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & natureza_receita_codigo_completo %in% c(
      '19900300', '19900310', '19900311', '19900312', '19900313', '19900314',
      '19990300', '19990301', '19990302', '19990303', '19990304'
    )
    "
  ),
  
  # CONTRIB. DOS MILITARES PARA O CUSTEIO DAS PENS√ïES
  `14  Contrib. para Custeio Pens√µes Militares` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & (
      grepl('^1210051', natureza_receita_codigo_completo) |
      grepl('^1215041', natureza_receita_codigo_completo) |
      grepl('^121911', natureza_receita_codigo_completo)
    )
    "
  ),
  
  # CONTRIBUI√á√ïES PARA PIS/PASEP
  `15  Contribui√ß√£o para PIS/PASEP` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & (
      (grepl('^1210091|^1212', natureza_receita_codigo_completo) & 
       !fonte_recursos_codigo %in% c('055', '056', '054')) |
      (!grepl('^1210091|^1212', natureza_receita_codigo_completo) & 
       fonte_recursos_codigo %in% c('040', '041'))
    )
    "
  ),
  
  # DEDU√á√ïES DAS RECEITAS - CORRIGIDO
  `16  Dedu√ß√µes das Receitas` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & (
      (grepl('^1212', natureza_receita_codigo_completo) & fonte_recursos_codigo %in% c('031', '032', '040', '041')) |
      (grepl('^1214', natureza_receita_codigo_completo) & fonte_recursos_codigo == '054') |
      (grepl('^1215', natureza_receita_codigo_completo) & fonte_recursos_codigo %in% c('023', '032', '055', '056')) |
      (grepl('^1219', natureza_receita_codigo_completo) & fonte_recursos_codigo == '054') |
      (grepl('^1911', natureza_receita_codigo_completo) & fonte_recursos_codigo == '054') |
      (grepl('^1922', natureza_receita_codigo_completo) & fonte_recursos_codigo %in% c('040', '054', '056')) |
      (grepl('^1923', natureza_receita_codigo_completo) & fonte_recursos_codigo == '054') |
      (grepl('^1999', natureza_receita_codigo_completo) & fonte_recursos_codigo == '054')
    )
    "
  )
)


aplicar_criterios(rreo_a03_rcl_receitas , criterios_rreo_A03_rcl_receitas_rcl, group_vars = c("item_informacao_codigo"))


```

```{r}
#| code-fold: true
#| output: false
# ===============================================================================
# CRIT√âRIOS PARA DESPESAS (DEDU√á√ïES) - ANEXO 3 RCL
# ===============================================================================

criterios_rreo_A03_rcl_despesas_rcl <- list(
  
  # TRANSFER√äNCIAS CONSTITUCIONAIS E LEGAIS (DESPESAS)
  `17  Transfer√™ncias Constitucionais e Legais` = list(
    criterio = "
    (
      acao_governo_codigo %in% c('0044', '0045', '0046', '0050', '0051', '00H6', '006M', 
                                 '00G6', '0169', '0223', '0369', '0546', '0547', '0999', 
                                 '099B', '0A53', '0C03', '0C33', '0E25', '0E36', '00PX', 
                                 '00QR', '00S3', '00S7', '00S8', '00SE', '00RX', '00UH') &
      modalidade_aplicacao_codigo %in% c('30', '31', '32', '35', '36', '40', '41', '42', '45', '46') &
      programa_governo_codigo == '0903'
    ) |
    grepl('^28846090900RX', pt) |
    acao_governo_codigo %in% c('0E36', '00SB')
    "
  ),
  
  # OUTRAS DEDU√á√ïES (DESPESAS)
  `18  Outras Dedu√ß√µes` = list(
    criterio = "
    
    acao_governo_codigo %in% c('0E36', '00SB') | 
    grepl('^28846090900RX', programa_governo_codigo) | 
    (programa_governo_codigo %in% c('0903', '2030', '2080') & 
     modalidade_aplicacao_codigo %in% c(30, 31, 32, 35, 36, 40, 41, 42, 45, 46) & 
     acao_governo_codigo %in% c('0044', '0045', '0046', '0050', '0051', '00H6', '006M', 
                                '00G6', '0169', '0223', '0369', '0546', '0547', '0999', 
                                '099B', '0A53', '0C03', '0C33', '0E25', '0E36', '00PX', 
                                '00QR', '00S3', '00S7', '00S8', '00SE', '00RX', '00UH'))
    "
  )
)


criterios_rreo_A03_rcl_rp_cancelado_rcl <- list(
  
  `19 RP Cancelados de Transfer√™ncias Constitucionais e Legais` = list(
    criterio = "
    (
      acao_governo_codigo %in% c('0044', '0045', '0046', '0050', '0051', '00H6', '006M', 
                                 '00G6', '0169', '0223', '0369', '0546', '0547', '0999', 
                                 '099B', '0A53', '0C03', '0C33', '0E25', '0E36', '00PX', 
                                 '00QR', '00S3', '00S7', '00S8', '00SE', '00RX', '00UH') &
      modalidade_aplicacao_codigo %in% c('30', '31', '32', '35', '36', '40', '41', '42', '45', '46') &
      programa_governo_codigo == '0903'
    ) |
    grepl('^28846090900RX', pt) |
    acao_governo_codigo %in% c('0E36', '00SB')
    "
  )
)


aplicar_criterios(df = rreo_a03_rcl_despesas , criterios_rreo_A03_rcl_despesas_rcl, group_vars = c("item_informacao_codigo"))



aplicar_criterios(df = rreo_a03_rcl_despesas, criterios_rreo_A03_rcl_rp_cancelado_rcl, group_vars = c("item_informacao_codigo"))
```

```{r}



rcl <- rbind(df_criterios_rreo_A03_rcl_receitas_rcl ,df_criterios_rreo_A03_rcl_despesas_rcl%>% filter(item_informacao_codigo %in% c( "25", "27")))

rcl <- rbind(rcl,df_criterios_rreo_A03_rcl_rp_cancelado_rcl%>% filter(item_informacao_codigo == "51"))

rcl <- rcl   %>%
  mutate(
    tipo =
      case_when(
        ordem %in% c("01" , "02", "03", "04", "05", "06", "07", "08" , "09") ~ "receitas",
        ordem %in% c( "11" , "12", "13", "14", "15", "17" ) ~ "deducoes",
        ordem == "19" ~ "rp_cancelado",
        .default = "demais"
        
        )
  )


# minimo_saude <- (rcl%>%
#   filter(
#     year(data_lancamento) == year(ym(mes_filtro))
#   )  %>% group_by( tipo) %>% summarise(valor = sum(valor))  %>% pivot_wider(names_from = tipo, values_from = valor, values_fill = 0 ) %>% mutate(resultado = receitas - deducoes + rp_cancelado ) )$resultado* 0.15

rcl_12_meses <- rcl %>% 
  filter(
    ym(mes_filtro)-months(11)< data_lancamento &
     data_lancamento < ym(mes_filtro) +  months(1)
      )  %>% group_by( tipo, data_lancamento) %>% summarise(valor = sum(valor))  %>% pivot_wider(names_from = tipo, values_from = valor, values_fill = 0 ) %>% mutate(resultado = receitas - deducoes + rp_cancelado ) 


formatar_real <- function(valor, decimais = 2, prefixo = "R$ ") {
  paste0(prefixo, 
         format(valor, 
                big.mark = ".",
                decimal.mark = ",",
                nsmall = decimais,
                scientific = FALSE))
}


minimo_saude <- sum((rcl_12_meses %>% filter(year(data_lancamento) == year(ym(mes_filtro))))$resultado* 0.15)

# Uso
formatar_real(sum(rcl_12_meses$resultado))



formatar_real(minimo_saude)


formatar_real(sum((rcl_12_meses %>% filter(year(data_lancamento) == year(ym(mes_filtro))))$resultado))

```

------------------------------------------------------------------------

# üìã RREO Anexo 04 Previd√™ncia

O **Anexo 04** apresenta o demonstrativo das receitas e despesas previdenci√°rias do Governo Federal, segregado em tr√™s sistemas:

## üèõÔ∏è REGIME GERAL DE PREVID√äNCIA SOCIAL (RGPS)

### üí∞ Crit√©rios de Receitas RGPS

```{r criterios-receitas-rgps}
#| include: false

criterios_rreo_A04_rgps_receitas_rgps <- list(
  
  # RECEITAS CORRENTES - DOS EMPREGADORES, TRABALHADORES E DEMAIS SEGURADOS
  `01  Receitas Correntes - Dos Empregadores, Trabalhadores e Demais Segurados` = list(
    criterio = "natureza_receita_codigo_completo %in% c('12100311', '12100312', '12100313', '12100311') & nre2_origem_receita_codigo_origem %in% c(2) | startsWith(natureza_receita_codigo_completo, '1214') "
  ),
  
  # RECEITAS CORRENTES - DEMAIS CONTRIBUI√á√ïES  
  `02  Receitas Correntes - Demais Contribui√ß√µes` = list(
    criterio = "nre2_origem_receita_codigo_origem %in% c(2) & natureza_receita_codigo_completo %notin% c('12100311', '12100312', '12100313')"
  ),
  
  # OUTRAS RECEITAS CORRENTES - COMPENSA√á√ÉO PREVIDENCI√ÅRIA RPPS/RGPS
  `03  Outras Receitas Correntes - Compensa√ß√£o Previdenci√°ria RPPS/RGPS` = list(
    criterio = "nre2_origem_receita_codigo_origem %in% c(9)"
  ),
  
  # DEMAIS RECEITAS CORRENTES
  `04  Demais Receitas Correntes` = list(
    criterio = "nre1_categoria_economica_codigo %in% c(1) & nre2_origem_receita_codigo_origem %notin% c(2,9)"
  ),
  
  # RECEITAS DE CAPITAL - ALIENA√á√ïES
  `05  Receitas de Capital - Aliena√ß√µes` = list(
    criterio = "nre2_origem_receita_codigo_origem %in% c(2) & nre1_categoria_economica_codigo %in% c(2)"
  ),
  
  # DEMAIS RECEITAS DE CAPITAL
  `06  Demais Receitas de Capital` = list(
    criterio = "nre1_categoria_economica_codigo %in% c(2) & nre2_origem_receita_codigo_origem %notin% c(2)"
  ),
  
  # RECEITAS INTRA-OR√áAMENT√ÅRIAS
  `07  Receitas INTRA-OR√áAMENT√ÅRIAS` = list(
    criterio = "nre1_categoria_economica_codigo %in% c(7, 8)"
  )
)
```

### üí∏ Crit√©rios de Despesas RGPS

```{r criterios-despesas-rgps}
#| include: false

criterios_rreo_A04_rgps_despesas_rgps <- list(
  
  # APOSENTADORIAS
  `01  Aposentadorias` = list(
    criterio = "elemento_despesa_codigo %in% c('53', '54') & grupo_despesa_codigo_grupo %in% c(3) & modalidade_aplicacao_codigo %notin% c('91')"
  ),
  
  # PENS√ïES
  `02  Pens√µes` = list(
    criterio = "elemento_despesa_codigo %in% c('55', '56') & grupo_despesa_codigo_grupo %in% c(3) & modalidade_aplicacao_codigo %notin% c('91')"
  ),
  
  # OUTROS BENEF√çCIOS
  `03  Outros Benef√≠cios` = list(
    criterio = "elemento_despesa_codigo %in% c('57', '58') & grupo_despesa_codigo_grupo %in% c(3) & modalidade_aplicacao_codigo %notin% c('91')"
  ),
  
  # COMPENSA√á√ÉO PREVIDENCI√ÅRIA DO RGPS PARA O RPPS
  `04  Compensa√ß√£o Previdenci√°ria do RGPS para o RPPS` = list(
    criterio = "elemento_despesa_codigo %notin% c('57', '58', '53', '54', '55', '56') & acao_governo_codigo %in% c('009W', '0531') & grupo_despesa_codigo_grupo %in% c(3) & modalidade_aplicacao_codigo %notin% c('91')"
  ),
  
  # DEMAIS DESPESAS
  `05  Demais Despesas` = list(
    criterio = "elemento_despesa_codigo %notin% c('57', '58', '53', '54', '55', '56') & acao_governo_codigo %notin% c('009W', '0531') & grupo_despesa_codigo_grupo %in% c(3) & modalidade_aplicacao_codigo %notin% c('91')"
  ),
  
  # A DETALHAR
  `06  A detalhar` = list(
    criterio = "elemento_despesa_codigo %in% c('00') & grupo_despesa_codigo_grupo %in% c(3) & modalidade_aplicacao_codigo %notin% c('91')"
  ),
  
  # DESPESAS PREVIDENCI√ÅRIAS (INTRA)
  `07  Despesas Previdenci√°rias (INTRA)` = list(
    criterio = "grupo_despesa_codigo_grupo %in% c(3) & modalidade_aplicacao_codigo %in% c('91') & elemento_despesa_codigo %notin% c('01', '03', '05')"
  )
)


```

### üìä Processamento RGPS - Receitas

```{r processar-rgps-receitas}
#| include: false

(aplicar_criterios(df = dados_receita %>% 
    filter(
      unidade_orcamentaria_codigo %in% c(33904, 40904, 55902, 25917) | 
      natureza_receita_codigo_completo == 79900211), criterios_rreo_A04_rgps_receitas_rgps))




```

### üìä Processamento RGPS - Despesas

```{r processar-rgps-despesas}
#| include: false

aplicar_criterios(df = dados_despesa %>% 
    filter(unidade_orcamentaria_codigo %in% c(33904, 40904, 55902, 25917)), criterios_rreo_A04_rgps_despesas_rgps)


 
```

### Resultado RGPS

```{r}

df_resultado_rgps <- tibble(
  Receita_RGPS = aplicar_criterios(
    df = dados_receita %>%
      filter(
        unidade_orcamentaria_codigo %in% c(33904, 40904, 55902, 25917) |
        natureza_receita_codigo_completo == 79900211,
        item_informacao_codigo %in% c(5)
      ), 
    criterios_rreo_A04_rgps_receitas_rgps
  ) %>% 
    filter(ordem != "02") %>% 
    summarise(valor = sum(valor)) %>% 
    pull(valor),
  
  Despesa_RGPS = aplicar_criterios(
    df = dados_despesa %>%
      filter(
        unidade_orcamentaria_codigo %in% c(33904, 40904, 55902, 25917),
        item_informacao_codigo %in% c(25)
      ), 
    criterios_rreo_A04_rgps_despesas_rgps
  ) %>% 
    summarise(valor = sum(valor)) %>% 
    pull(valor)
) %>%
  mutate(Resultado_RGPS = Receita_RGPS - Despesa_RGPS) %>%
  pivot_longer(
    cols = everything(),
    names_to = "Tipo",
    values_to = "Valor"
  )

# Exibir com DT::datatable formatado
DT::datatable(
  df_resultado_rgps,
  options = list(dom = 't', pageLength = 3),
  rownames = FALSE
) %>%
  DT::formatCurrency("Valor", currency = "R$ ", digits = 2, mark = ".", dec.mark = ",")
```

## üë• REGIME PR√ìPRIO DE PREVID√äNCIA SOCIAL (RPPS)

### üí∞ Crit√©rios de Receitas RPPS

```{r criterios-receitas-rpps}
criterios_rreo_A04_rpps_receitas_civil_militar_rpps <- list(
  
 # CIVIS - RECEITA SEGURADOS - Ativo (CORRIGIDO)
`01  CIVIS - RECEITA SEGURADOS - Ativo` = list(
  criterio = "fonte_recursos_codigo %notin% c('00', '000') & (natureza_receita_codigo_completo %in% c('12100423', '12100421', '12100422', '12100424', '12100461', '12100462', '12100463', '12100464') | startsWith(natureza_receita_codigo_completo, '1215011') | startsWith(natureza_receita_codigo_completo, '1215014') | startsWith(natureza_receita_codigo_completo, '121503'))"
),

# CIVIS - RECEITA SEGURADOS - Inativos (CORRIGIDO)
`02  CIVIS - RECEITA SEGURADOS - Inativos` = list(
  criterio = "fonte_recursos_codigo %notin% c('00', '000') & (natureza_receita_codigo_completo %in% c('12100431', '12100433', '12100432', '12100434', '12100471') | startsWith(natureza_receita_codigo_completo, '1215012') | startsWith(natureza_receita_codigo_completo, '1215015'))"
),

# CIVIS - RECEITAS SEGURADOS - Pensionistas (CORRIGIDO) 
`03  CIVIS - RECEITAS SEGURADOS - Pensionistas` = list(
  criterio = "fonte_recursos_codigo %notin% c('00', '000') & (natureza_receita_codigo_completo %in% c('12100481', '12100441', '12100442', '12100443', '12100444') | startsWith(natureza_receita_codigo_completo, '1215013') | startsWith(natureza_receita_codigo_completo, '1215016'))"
),

# CIVIS - RECEITA PATRONAL - Ativo (CORRIGIDO)
`04  CIVIS - RECEITA PATRONAL - Ativo` = list(
  criterio = "fonte_recursos_codigo %notin% c('00', '000') & (natureza_receita_codigo_completo %in% c('12100411', '12100413', '12100412', '12100414', '72100411', '72100413', '72100414', '72100451', '72100452', '12100452', '12100453', '12100454') | startsWith(natureza_receita_codigo_completo, '121502') | startsWith(natureza_receita_codigo_completo, '721502'))"
),

# CIVIS - RECEITA PATRONAL - Inativos e Pensionistas (J√Å CORRETO)
`05  CIVIS - RECEITA PATRONAL - Inativos e Pensionistas - vinculada` = list(
  criterio = "fonte_recursos_codigo %notin% c('00', '000') & natureza_receita_codigo_completo %in% c('72100441')"
),
  
  # DRU - FCDF
  `06  DRU - FCDF` = list(
    criterio = "fonte_recursos_codigo %in% c('000', '00') & endsWith(fonte_recursos_detalhada_codigo, '980001') & startsWith(natureza_receita_codigo_completo, '12151')"
  ),
  
  # MILITARES - RECEITAS - Segurados
  `07  MILITARES - RECEITAS - Segurados` = list(
    criterio = "fonte_recursos_codigo %notin% c('00', '000') & 
(natureza_receita_codigo_completo %in% c('12100511', '12100512', '12100513', '12105141', '12150411', '12150412', '12150421', '12150043', '12150044') | 
startsWith(natureza_receita_codigo_completo, '121911'))"
  )
  
  # # Total das Receitas RPPS
  # `08  Total das Receitas RPPS` = list(
  #   criterio = "unidade_orcamentaria_codigo %notin% c('33904', '40904') & fonte_recursos_codigo %notin% c('54', '00', '000', '054') & (grepl('PENSOES MILIT|PENS.MIL|RPPS|CPSS|CIV', natureza_receita_nome, ignore.case = TRUE) | startsWith(natureza_receita_codigo_completo, '1215') | startsWith(natureza_receita_codigo_completo, '7215'))"
  # )
)
```

### üí∏ Crit√©rios de Despesas RPPS

```{r criterios-despesas-rpps}
criterios_rreo_A04_rpps_despesas_civil_militar_rpps <- list(
  
  # CIVIS - DESPESAS - A detalhar
  `01  CIVIS - DESPESAS - A detalhar` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845') & grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %in% c('00') & acao_governo_codigo %in% c('0053', '0181') & funcao_governo_codigo %notin% c('10', '08')"
  ),
  
  # CIVIS - DESPESAS - Aposentadorias
  `02  CIVIS - DESPESAS - Aposentadorias` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845') & grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %in% c('01') & acao_governo_codigo %in% c('0053', '0181')"
  ),
  
  # CIVIS - DESPESAS - Pens√µes
  `03  CIVIS - DESPESAS - Pens√µes` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845') & grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %in% c('03') & acao_governo_codigo %in% c('0053', '0181')"
  ),
  
  # CIVIS - DESPESAS - Outros Benef√≠cios Previdenci√°rios
  `04  CIVIS - DESPESAS - Outros Benef√≠cios Previdenci√°rios` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845', '846') & grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %notin% c('00', '01', '03') & (acao_governo_codigo %in% c('0053', '0181', '0005', '0625') & funcao_governo_codigo %notin% c('10', '08') | acao_governo_codigo %in% c('0397'))"
  ),
  
  # MILITARES - DESPESAS - A Detalhar Pens√µes
  `05  MILITARES - DESPESAS - A Detalhar Pens√µes` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845') & grupo_despesa_codigo_grupo %in% c(1) & acao_governo_codigo %in% c('0179', '000Q') & elemento_despesa_codigo %in% c('00')"
  ),
  
  # MILITARES - DESPESAS - Pens√µes
  `06  MILITARES - DESPESAS - Pens√µes` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845', '846') & grupo_despesa_codigo_grupo %in% c(1) & acao_governo_codigo %in% c('0179', '00QD') & elemento_despesa_codigo %in% c('03')"
  ),
  
  # MILITARES - DESPESAS - Outros Benef√≠cios Pensionistas
  `07  MILITARES - DESPESAS - Outros Benef√≠cios Pensionistas` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(2) & acao_governo_codigo %in% c('214H', '218K', '0179', '00QD') & elemento_despesa_codigo %notin% c('00', '01', '03') & grupo_despesa_codigo_grupo %in% c(1)"
  ),
  
  
    # MILITARES - DESPESAS - A Detalhar Inativos
  `08  MILITARES - DESPESAS - A Detalhar Inativos` = list(
    criterio = "grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %in% c('00') & acao_governo_codigo %in% c('214H', '218K')"
  ),
  
  # MILITARES - DESPESAS - Inativos
  `09  MILITARES - DESPESAS - Inativos` = list(
    criterio = "grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %in% c('01') & acao_governo_codigo %in% c('214H', '218K')"
  ),
  

  
   # MILITARES - DESPESAS - Outros Outros Benef√≠cios Inativos
  `10  MILITARES - DESPESAS - Outros Outros Benef√≠cios Inativos` = list(
    criterio = "grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %notin% c( '00', '01') & acao_governo_codigo %in% c('214H', '218K')"
  ),
  
     # MILITARES - DESPESAS - Compensa√ß√£o financeira entre RPPSU e os demais RPPS
  `11  MILITARES - DESPESAS - Compensa√ß√£o financeira entre RPPSU e os demais RPPS` = list(
    criterio = "acao_governo_codigo %in% c('00X3')"
  )
)
```

### üìä Processamento RPPS - Receitas

```{r processar-rpps-receitas}
#| include: false

datatable(aplicar_criterios(df = dados_receita %>% 
    filter(
      unidade_orcamentaria_codigo %notin% c(73901),
      fonte_recursos_codigo %notin% c('054')
    ), criterios_rreo_A04_rpps_receitas_civil_militar_rpps))




```

verificar linha 08 Total das Receitas RPPS.

### üìä Processamento RPPS - Despesas

```{r processar-rpps-despesas}
#| include: false
# Processar despesas RPPS



datatable(aplicar_criterios(df = dados_despesa %>% 
    filter(
      unidade_orcamentaria_codigo %notin% c(73901),
      elemento_despesa_codigo %notin% c('04', '07', '11', '13', '16', '39', '67', '96'),
      acao_governo_codigo != '09HB'
    ), criterios_rreo_A04_rpps_despesas_civil_militar_rpps))




```

### Resultado RPPS

```{r resultado_rpps}
# formatar_numero(resultado_rpps <- (
#   aplicar_criterios(df = dados_receita %>% 
#     filter(
#       unidade_orcamentaria_codigo %notin% c(73901),
#       fonte_recursos_codigo %notin% c('054'),
#            item_informacao_codigo %in% c(5)
#     ), criterios_rreo_A04_rpps_receitas_civil_militar_rpps)%>% summarise(valor=sum(valor))
#   -
#   aplicar_criterios(df = dados_despesa %>% 
#     filter(
#       unidade_orcamentaria_codigo %notin% c(73901),
#       elemento_despesa_codigo %notin% c('04', '07', '11', '13', '16', '39', '67', '96'),
#       acao_governo_codigo != '09HB',
#            item_informacao_codigo %in% c(25)
#     ), criterios_rreo_A04_rpps_despesas_civil_militar_rpps)%>% summarise(valor=sum(valor))
# ))
```

```{r}
# Tabela estruturada para RPPS CIVIL (Servidores Civis)
df_resultado_rpps_civil <- tibble(
  Receita_RPPS_Civil = aplicar_criterios(
    df = dados_receita %>%
      filter(
        unidade_orcamentaria_codigo %notin% c(73901),
        fonte_recursos_codigo %notin% c('054'),
        item_informacao_codigo %in% c(5)
      ), 
    criterios_rreo_A04_rpps_receitas_civil_militar_rpps
  ) %>%
    # Filtra apenas linhas de CIVIS (01 a 06)
    filter(grepl("^0[1-6]", ordem)) %>%
    summarise(valor = sum(valor)) %>% 
    pull(valor),
  
  Despesa_RPPS_Civil = aplicar_criterios(
    df = dados_despesa %>%
      filter(
        unidade_orcamentaria_codigo %notin% c(73901),
        elemento_despesa_codigo %notin% c('04', '07', '11', '13', '16', '39', '67', '96'),
        acao_governo_codigo != '09HB',
        item_informacao_codigo %in% c(25)
      ), 
    criterios_rreo_A04_rpps_despesas_civil_militar_rpps
  ) %>%
    # Filtra apenas linhas de CIVIS (01 a 04)
     filter(str_detect(nome, "CIVIS")) %>%
    summarise(valor = sum(valor)) %>% 
    pull(valor)
) %>%
  mutate(Resultado_RPPS_Civil = Receita_RPPS_Civil - Despesa_RPPS_Civil) %>%
  pivot_longer(
    cols = everything(),
    names_to = "Tipo",
    values_to = "Valor"
  )

# Exibir tabela formatada
DT::datatable(
  df_resultado_rpps_civil,
  options = list(dom = 't', pageLength = 3),
  rownames = FALSE
) %>%
  DT::formatCurrency("Valor", currency = "R$ ", digits = 2, mark = ".", dec.mark = ",")
```

```{r}
# Tabela estruturada para RPPS MILITAR (Militares)
df_resultado_rpps_militar <- tibble(
  Receita_RPPS_Militar = aplicar_criterios(
    df = dados_receita %>%
      filter(
        unidade_orcamentaria_codigo %notin% c(73901),
        fonte_recursos_codigo %notin% c('054'),
        item_informacao_codigo %in% c(5)
      ), 
    criterios_rreo_A04_rpps_receitas_civil_militar_rpps
  ) %>%
    # Filtra apenas linha de MILITARES (07)
    filter(grepl("^07", ordem)) %>%
    summarise(valor = sum(valor)) %>% 
    pull(valor),
  
  Despesa_RPPS_Militar = aplicar_criterios(
    df = dados_despesa %>%
      filter(
        unidade_orcamentaria_codigo %notin% c(73901),
        elemento_despesa_codigo %notin% c('04', '07', '11', '13', '16', '39', '67', '96'),
        acao_governo_codigo != '09HB',
        item_informacao_codigo %in% c(25)
      ), 
    criterios_rreo_A04_rpps_despesas_civil_militar_rpps
  ) %>%
   
    filter(str_detect(nome, "MILITARES")) %>%
    summarise(valor = sum(valor)) %>% 
    pull(valor)
) %>%
  mutate(Resultado_RPPS_Militar = Receita_RPPS_Militar - Despesa_RPPS_Militar) %>%
  pivot_longer(
    cols = everything(),
    names_to = "Tipo",
    values_to = "Valor"
  )

# Exibir tabela formatada
DT::datatable(
  df_resultado_rpps_militar,
  options = list(dom = 't', pageLength = 3),
  rownames = FALSE
) %>%
  DT::formatCurrency("Valor", currency = "R$ ", digits = 2, mark = ".", dec.mark = ",")
```

```{r}
# Tabela estruturada para RPPS (Regime Pr√≥prio de Previd√™ncia Social)
df_resultado_rpps <- tibble(
  Receita_RPPS = aplicar_criterios(
    df = dados_receita %>%
      filter(
        unidade_orcamentaria_codigo %notin% c(73901),
        fonte_recursos_codigo %notin% c('054'),
        item_informacao_codigo %in% c(5)
      ), 
    criterios_rreo_A04_rpps_receitas_civil_militar_rpps
  ) %>% 
    summarise(valor = sum(valor)) %>% 
    pull(valor),
  
  Despesa_RPPS = aplicar_criterios(
    df = dados_despesa %>%
      filter(
        unidade_orcamentaria_codigo %notin% c(73901),
        elemento_despesa_codigo %notin% c('04', '07', '11', '13', '16', '39', '67', '96'),
        acao_governo_codigo != '09HB',
        item_informacao_codigo %in% c(25)
      ), 
    criterios_rreo_A04_rpps_despesas_civil_militar_rpps
  ) %>% 
    summarise(valor = sum(valor)) %>% 
    pull(valor)
) %>%
  mutate(Resultado_RPPS = Receita_RPPS - Despesa_RPPS) %>%
  pivot_longer(
    cols = everything(),
    names_to = "Tipo",
    values_to = "Valor"
  )

# Exibir tabela formatada
DT::datatable(
  df_resultado_rpps,
  options = list(dom = 't', pageLength = 3),
  rownames = FALSE
) %>%
  DT::formatCurrency("Valor", currency = "R$ ", digits = 2, mark = ".", dec.mark = ",")
```

## üèõÔ∏è REGIME PR√ìPRIO DE PREVID√äNCIA SOCIAL - FCDF

### üí∞ Crit√©rios de Receitas FCDF

```{r criterios-receitas-fcdf}
#| include: false
criterios_rreo_A04_rpps_receitas_fcdf<- list(
  
  # FCDF - RECEITA SEGURADOS - Ativo
  `01  FCDF - RECEITA SEGURADOS - Ativo` = list(
    criterio = "fonte_recursos_codigo %notin% c('00', '000') & (natureza_receita_codigo_completo %in% c('12100431', '12104211', '12104221', '12104231', '12104411', '12104421', '12104431', '12104611', '12104621', '12104631', '12191111', '12191321', '12191411') | startsWith(natureza_receita_codigo_completo, '121503') | startsWith(natureza_receita_codigo_completo, '1215011') | startsWith(natureza_receita_codigo_completo, '1215014'))"
  ),
  
  # FCDF - RECEITA SEGURADOS - Inativos
  `02  FCDF - RECEITA SEGURADOS - Inativos` = list(
    criterio = "fonte_recursos_codigo %notin% c('00', '000') & (natureza_receita_codigo_completo %in% c('12104311', '12104321', '12104331', '12104341', '12104711') | startsWith(natureza_receita_codigo_completo, '1215012') | startsWith(natureza_receita_codigo_completo, '1215015'))"
  ),
  
  # FCDF - RECEITAS SEGURADOS - Pensionistas
  `03  FCDF - RECEITAS SEGURADOS - Pensionistas` = list(
    criterio = "fonte_recursos_codigo %notin% c('00', '000') & (natureza_receita_codigo_completo %in% c('12104811', '12104411', '12104421', '12104431', '12104441', '12105121', '12105131') | startsWith(natureza_receita_codigo_completo, '1215013') | startsWith(natureza_receita_codigo_completo, '1215016'))"
  ),
  
  # FCDF - RECEITA PATRONAL - Ativo
  `04  FCDF - RECEITA PATRONAL - Ativo` = list(
    criterio = "fonte_recursos_codigo %notin% c('00', '000') & (natureza_receita_codigo_completo %in% c('12104111', '12104131', '12104121', '12104141', '72104111', '72104121', '72104131', '72104141', '72104511', '72104521', '72104531', '72104541') | startsWith(natureza_receita_codigo_completo, '121502') | startsWith(natureza_receita_codigo_completo, '721502'))"
  ),
  
  # FCDF - RECEITA PATRONAL - Inativos e Pensionistas - vinculada
  `05  FCDF - RECEITA PATRONAL - Inativos e Pensionistas - vinculada` = list(
    criterio = "fonte_recursos_codigo %notin% c('00', '000') & natureza_receita_codigo_completo %in% c('72104411', '12150211')"
  ),
  
  # DRU - FCDF
  `06  DRU - FCDF` = list(
    criterio = "fonte_recursos_codigo %in% c('00', '000') & (natureza_receita_codigo_completo %in% c('12104811', '12104411', '12104421', '12104431', '12104441', '12105111', '12104211', '12104221', '12104231', '12104311', '12104321', '12104331', '12104341', '12104521', '12104531', '12104621', '12104631', '12104721', '12104731', '12104741', '12104831', '12104841') | startsWith(natureza_receita_codigo_completo, '1215') | startsWith(natureza_receita_codigo_completo, '7215'))"
  ),
  
  # Total de Receitas RPPS FCDF
  `07  Total de Receitas RPPS FCDF` = list(
    criterio = "unidade_orcamentaria_codigo %notin% c('55902', '33904') & fonte_recursos_codigo %notin% c('54', '054') & fonte_recursos_detalhada_codigo %notin% c('010073910') & fonte_recursos_codigo %in% c('23', '56', '023', '056', '024') & (grepl('PENSI|PENSO|RPPS|CPSS', natureza_receita_nome, ignore.case = TRUE))"
  )
)
```

### üí∏ Crit√©rios de Despesas FCDF

```{r criterios-despesas-fcdf}
#| include: false
criterios_rreo_A04_rpps_despesas_fcdf <- list(
  
  # FCDF - DESPESAS - A detalhar
  `01  FCDF - DESPESAS - A detalhar` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(1, 2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845') & grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %in% c('00') & acao_governo_codigo %in% c('00Q2', '00QN', '00NS')"
  ),
  
  # FCDF - DESPESAS - Aposentadorias
  `02  FCDF - DESPESAS - Aposentadorias` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(1, 2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845') & grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %in% c('01') & acao_governo_codigo %in% c('00Q2', '00QN', '00NS', '0312', '00NR')"
  ),
  
  # FCDF - DESPESAS - Pens√µes
  `03  FCDF - DESPESAS - Pens√µes` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(1, 2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845') & grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %in% c('03') & acao_governo_codigo %in% c('00Q2', '00QN', '00NS', '0312', '00NR')"
  ),
  
  # FCDF - DESPESAS - Outros Benef√≠cios Previdenci√°rios
  `04  FCDF - DESPESAS - Outros Benef√≠cios Previdenci√°rios` = list(
    criterio = "esfera_orcamentaria_codigo %in% c(1, 2) & subfuncao_governo_codigo %in% c('272', '273', '274', '845', '846') & grupo_despesa_codigo_grupo %in% c(1) & elemento_despesa_codigo %notin% c('00', '01', '03') & (acao_governo_codigo %in% c('00Q2', '00NS', '00QN') | (acao_governo_codigo %in% c('0005', '0625') & funcao_governo_codigo %notin% c('10', '08')))"
  )
)
```

### üìä Processamento FCDF - Receitas

```{r processar-fcdf-receitas}
#| include: false

datatable(aplicar_criterios(df = dados_receita %>% 
    filter(unidade_orcamentaria_codigo %in% c(73901)),
    criterios_rreo_A04_rpps_receitas_fcdf))





```

### üìä Processamento FCDF - Despesas

```{r processar-fcdf-despesas}
#| include: false

datatable(aplicar_criterios(df = dados_despesa %>% 
    filter(
      unidade_orcamentaria_codigo %in% c(73901),
      elemento_despesa_codigo %notin% c('04', '07', '11', '13', '16', '39', '67', '96'),
      acao_governo_codigo != '09HB'
    ),
    criterios_rreo_A04_rpps_despesas_fcdf))




```

### Resultado FCDF

```{r}
#| include: false
formatar_numero(resultado_fcdf <- (
  aplicar_criterios(df = dados_receita %>% 
    filter(unidade_orcamentaria_codigo %in% c(73901),
           item_informacao_codigo %in% c(5)),
    criterios_rreo_A04_rpps_receitas_fcdf)%>% summarise(valor=sum(valor))
    -
aplicar_criterios(df = dados_despesa %>% 
    filter(
      unidade_orcamentaria_codigo %in% c(73901),
      elemento_despesa_codigo %notin% c('04', '07', '11', '13', '16', '39', '67', '96'),
      acao_governo_codigo != '09HB',
      item_informacao_codigo %in% c(25)
    ),
    criterios_rreo_A04_rpps_despesas_fcdf)%>% summarise(valor=sum(valor))
))

```

```{r}
# Tabela estruturada para FCDF (Fundo Constitucional do Distrito Federal)
df_resultado_fcdf <- tibble(
  Receita_FCDF = aplicar_criterios(
    df = dados_receita %>%
      filter(
        unidade_orcamentaria_codigo %in% c(73901),
        item_informacao_codigo %in% c(5)
      ), 
    criterios_rreo_A04_rpps_receitas_fcdf
  ) %>% 
    summarise(valor = sum(valor)) %>% 
    pull(valor),
  
  Despesa_FCDF = aplicar_criterios(
    df = dados_despesa %>%
      filter(
        unidade_orcamentaria_codigo %in% c(73901),
        elemento_despesa_codigo %notin% c('04', '07', '11', '13', '16', '39', '67', '96'),
        acao_governo_codigo != '09HB',
        item_informacao_codigo %in% c(25)
      ), 
    criterios_rreo_A04_rpps_despesas_fcdf
  ) %>% 
    summarise(valor = sum(valor)) %>% 
    pull(valor)
) %>%
  mutate(Resultado_FCDF = Receita_FCDF - Despesa_FCDF) %>%
  pivot_longer(
    cols = everything(),
    names_to = "Tipo",
    values_to = "Valor"
  )

# Exibir tabela formatada
DT::datatable(
  df_resultado_fcdf,
  options = list(dom = 't', pageLength = 3),
  rownames = FALSE
) %>%
  DT::formatCurrency("Valor", currency = "R$ ", digits = 2, mark = ".", dec.mark = ",")
```

# üìã RREO Anexo 06 (Resultado Prim√°rio)

## Processamento Anexo 06

```{r criterio_anexo_06}

# ===============================================================================
# CRIT√âRIOS RREO ANEXO 6 - RESULTADO PRIM√ÅRIO (AJUSTADO)
# ===============================================================================

# ===============================================================================
# 1. RECEITAS PRIM√ÅRIAS (dados_receita)
# ===============================================================================
criterios_rreo_A06_receitas_A06 <- list(
  
  # RECEITAS CORRENTES (I) - Total
  `01  RECEITAS CORRENTES (I)` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    item_informacao_codigo == 5
    "
  ),
  
  # IMPOSTOS, TAXAS E CONTRIBUI√á√ïES DE MELHORIA (Subitem)
  `02  ___Impostos, Taxas e Contribui√ß√µes de Melhoria` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 1 & 
    item_informacao_codigo == 5
    "
  ),
  
  # CONTRIBUI√á√ïES (Subitem)
  `03  ___Contribui√ß√µes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 2 & 
    item_informacao_codigo == 5
    "
  ),
  
  # RECEITA PATRIMONIAL (Subitem)
  `04  ___Receita Patrimonial` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3 & 
    item_informacao_codigo == 5
    "
  ),
  
  # APLICA√á√ïES FINANCEIRAS (II) - DEDU√á√ÉO (Sub-subitem)
  `05  ______Aplica√ß√µes Financeiras (II)` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    (natureza_receita_codigo_completo %in% c('13210101', '13210201', '13210301', '13210501') |
     startsWith(natureza_receita_codigo_completo, '1321004') |
     startsWith(natureza_receita_codigo_completo, '1329001')) & 
    item_informacao_codigo == 5
    "
  ),
  
  # OUTRAS RECEITAS PATRIMONIAIS (Sub-subitem)
  `06  ______Outras Receitas Patrimoniais` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 3 & 
    !(natureza_receita_codigo_completo %in% c('13210101', '13210201', '13210301', '13210501') |
      startsWith(natureza_receita_codigo_completo, '1321004') |
      startsWith(natureza_receita_codigo_completo, '1329001')) & 
    item_informacao_codigo == 5
    "
  ),
  
  # TRANSFER√äNCIAS CORRENTES (Subitem)
  `07  ___Transfer√™ncias Correntes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    nre2_origem_receita_codigo_origem == 7 & 
    item_informacao_codigo == 5
    "
  ),
  
  # DEMAIS RECEITAS CORRENTES (Subitem)
  `08  ___Demais Receitas Correntes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    (startsWith(natureza_receita_codigo_completo, '14') |
     startsWith(natureza_receita_codigo_completo, '15') |
     startsWith(natureza_receita_codigo_completo, '16') |
     startsWith(natureza_receita_codigo_completo, '18') |
     startsWith(natureza_receita_codigo_completo, '19')) & 
    item_informacao_codigo == 5
    "
  ),
  
  # OUTRAS RECEITAS FINANCEIRAS (III) - DEDU√á√ÉO (Sub-subitem)
  `09  ______Outras Receitas Financeiras (III)` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    (natureza_receita_codigo_completo %in% c('16410101', '16410102', '19991101', '19991102', '16410301') |
     startsWith(natureza_receita_codigo_completo, '1922012') |
     startsWith(natureza_receita_codigo_completo, '1990992')) & 
    item_informacao_codigo == 5
    "
  ),
  
  # RECEITAS CORRENTES RESTANTES (Sub-subitem)
  `10  ______Receitas Correntes Restantes` = list(
    criterio = "
    nre1_categoria_economica_codigo == 1 & 
    (startsWith(natureza_receita_codigo_completo, '14') |
     startsWith(natureza_receita_codigo_completo, '15') |
     startsWith(natureza_receita_codigo_completo, '16') |
     startsWith(natureza_receita_codigo_completo, '18') |
     startsWith(natureza_receita_codigo_completo, '19')) & 
    !(natureza_receita_codigo_completo %in% c('16410101', '16410102', '19991101', '19991102', '16410301') |
      startsWith(natureza_receita_codigo_completo, '1922012') |
      startsWith(natureza_receita_codigo_completo, '1990992')) & 
    item_informacao_codigo == 5
    "
  ),
  
  # RECEITAS PRIM√ÅRIAS CORRENTES (IV) - F√ìRMULA
  `11  RECEITAS PRIM√ÅRIAS CORRENTES (IV) = (I - II - III)` = list(
    criterio = "{01 - 05 - 09}"
  ),
  
  # RECEITAS DE CAPITAL (V) - Total
  `12  RECEITAS DE CAPITAL (V)` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    item_informacao_codigo == 5
    "
  ),
  
  # OPERA√á√ïES DE CR√âDITO (VI) - DEDU√á√ÉO (Subitem)
  `13  ___Opera√ß√µes de Cr√©dito (VI)` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 1 & 
    item_informacao_codigo == 5
    "
  ),
  
  # AMORTIZA√á√ÉO DE EMPR√âSTIMOS (VII) - DEDU√á√ÉO (Subitem)
  `14  ___Amortiza√ß√£o de Empr√©stimos (VII)` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 3 & 
    item_informacao_codigo == 5
    "
  ),
  
  # ALIENA√á√ïES DE BENS (Subitem)
  `15  ___Aliena√ß√µes de Bens` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 2 & 
    item_informacao_codigo == 5
    "
  ),
  
  # RECEITAS DE ALIENA√á√ÉO DE INVESTIMENTOS PERMANENTES (IX) - Sub-subitem
  `16  ______Receitas de Aliena√ß√£o de Investimentos Permanentes (IX)` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 2 & 
    startsWith(natureza_receita_codigo_completo, '2221') & 
    item_informacao_codigo == 5
    "
  ),
  
  # OUTRAS ALIENA√á√ïES DE BENS (Sub-subitem)
  `17  ______Outras Aliena√ß√µes de Bens` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 2 & 
    !startsWith(natureza_receita_codigo_completo, '2221') & 
    item_informacao_codigo == 5
    "
  ),
  
  # TRANSFER√äNCIAS DE CAPITAL (Subitem)
  `18  ___Transfer√™ncias de Capital` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem == 4 & 
    item_informacao_codigo == 5
    "
  ),
  
  # OUTRAS RECEITAS DE CAPITAL (Subitem)
  `19  ___Outras Receitas de Capital` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    nre2_origem_receita_codigo_origem %in% c(5, 6, 7, 8, 9) & 
    item_informacao_codigo == 5
    "
  ),
  
  # OUTRAS RECEITAS DE CAPITAL N√ÉO PRIM√ÅRIAS (X) - DEDU√á√ÉO (Sub-subitem)
  `20  ______Outras Receitas de Capital N√£o Prim√°rias (X)` = list(
    criterio = "
    nre1_categoria_economica_codigo == 2 & 
    (startsWith(natureza_receita_codigo_completo, '292') |
     startsWith(natureza_receita_codigo_completo, '293') |
     startsWith(natureza_receita_codigo_completo, '294')) & 
    item_informacao_codigo == 5
    "
  ),
  
  # RECEITAS PRIM√ÅRIAS DE CAPITAL (XI) - F√ìRMULA
  `21  RECEITAS PRIM√ÅRIAS DE CAPITAL (XI) = (V - VI - VII - IX - X)` = list(
    criterio = "{12 - 13 - 14 - 16 - 20}"
  ),
  
  # RECEITA PRIM√ÅRIA TOTAL (XII) - F√ìRMULA
  `22  RECEITA PRIM√ÅRIA TOTAL (XII) = (IV + XI)` = list(
    criterio = "{11 + 21}"
  )
)

# ===============================================================================
# 2. DESPESAS - CATEGORIA/GRUPO (dados_categoria_grupo)
# ===============================================================================
criterios_rreo_A06_despesas_categoria_grupo_A06 <- list(
  
  # DESPESAS CORRENTES (XIII)
  `23  DESPESAS CORRENTES (XIII)` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # PESSOAL E ENCARGOS SOCIAIS (Subitem)
  `24  ___Pessoal e Encargos Sociais` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 & 
    grupo_despesa_codigo_grupo == 1 & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # JUROS E ENCARGOS DA D√çVIDA (XIV) - DEDU√á√ÉO (Subitem)
  `25  ___Juros e Encargos da D√≠vida (XIV)` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 & 
    grupo_despesa_codigo_grupo == 2 & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # OUTRAS DESPESAS CORRENTES (Subitem)
  `26  ___Outras Despesas Correntes` = list(
    criterio = "
    categoria_economica_despesa_codigo == 3 & 
    grupo_despesa_codigo_grupo == 3 & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # DESPESAS PRIM√ÅRIAS CORRENTES (XV) - F√ìRMULA
  `27  DESPESAS PRIM√ÅRIAS CORRENTES (XV) = (XIII - XIV)` = list(
    criterio = "{23 - 25}"
  ),
  
  # DESPESAS DE CAPITAL (XVI)
  `28  DESPESAS DE CAPITAL (XVI)` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # INVESTIMENTOS (Subitem)
  `29  ___Investimentos` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 & 
    grupo_despesa_codigo_grupo == 4 & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # INVERS√ïES FINANCEIRAS (Subitem)
  `30  ___Invers√µes Financeiras` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 & 
    grupo_despesa_codigo_grupo == 5 & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # AMORTIZA√á√ÉO DA D√çVIDA (XX) - DEDU√á√ÉO (Subitem)
  `31  ___Amortiza√ß√£o da D√≠vida (XX)` = list(
    criterio = "
    categoria_economica_despesa_codigo == 4 & 
    grupo_despesa_codigo_grupo == 6 & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  )
)

# ===============================================================================
# 3. DESPESAS - NATUREZA DETALHADA (dados_ndd)
# ===============================================================================
criterios_rreo_A06_despesas_natureza_detalhada_A06 <- list(
  
  # TRANSFER√äNCIAS CONSTITUCIONAIS E LEGAIS
  `32  ______Transfer√™ncias Constitucionais e Legais` = list(
    criterio = "
    (startsWith(natureza_despesa_detalhada_codigo, '333081') | 
     startsWith(natureza_despesa_detalhada_codigo, '334081')) & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # DEMAIS DESPESAS CORRENTES - F√ìRMULA
  `33  ______Demais Despesas Correntes` = list(
    criterio = "{26 - 32}"
  ),
  
  # CONCESS√ÉO DE EMPR√âSTIMOS E FINANCIAMENTOS (XVII)
  `34  ______Concess√£o de Empr√©stimos e Financiamentos (XVII)` = list(
    criterio = "
    natureza_despesa_detalhada_codigo %in% c('45909206', '45909208', '45909266') & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # AQUISI√á√ÉO DE T√çTULOS DE CAPITAL J√Å INTEGRALIZADO (XVIII)
  `35  ______Aquisi√ß√£o de T√≠tulos de Capital j√° Integralizado (XVIII)` = list(
    criterio = "
    natureza_despesa_detalhada_codigo %in% c('45919206', '45919208') & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # DEMAIS INVERS√ïES FINANCEIRAS - F√ìRMULA
  `36  ______Demais Invers√µes Financeiras` = list(
    criterio = "{30 - 34 - 35}"
  ),
  
  # SUBS√çDIOS (METODOLOGIA CESEF)
  `37  ______Subs√≠dios (metodologia CESEF - financeiro prim√°rio)` = list(
    criterio = "
    acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                              '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                              '20GI', '006C', '00ED', '00EE', '00SG')
    "
  ),
  
  # COTAS DOS FUNDOS GARANTIDORES
  `38  ______Cotas dos Fundos Garantidores (metodologia CESEF - prim√°rio)` = list(
    criterio = "
    natureza_despesa_detalhada_codigo == '45919266' & 
    !acao_governo_codigo %in% c('0021', '0029', '0030', '0031', '0061', '006A', '0427', 
                               '0534', '0A81', '0A84', '2130', '0062', '00DD', '00S5', 
                               '20GI', '006C', '00ED', '00EE', '00SG')
    "
  )
)

# ===============================================================================
# 4. DISPONIBILIDADES (tg_RPN_disponibilidades)
# ===============================================================================
criterios_rreo_A06_disponibilidades_A06 <- list(
  
  # DISPONIBILIDADES - RECURSOS A CLASSIFICAR
  `39  Disponibilidades - Recursos a Classificar` = list(
    criterio = "
    fonte_recursos_codigo %in% c('77', '490') & 
    orgao_uge_tipo_administracao_codigo != 7
    "
  ),
  
  # DISPONIBILIDADES - RECURSOS DIVERSOS
  `40  Disponibilidades - Recursos Diversos` = list(
    criterio = "
    fonte_recursos_codigo %in% c('90', '491') & 
    orgao_uge_tipo_administracao_codigo != 7
    "
  )
)

# ===============================================================================
# 5. JUROS ATIVOS E PASSIVOS (dados_juros)
# ===============================================================================
criterios_rreo_A06_juros_ativos_passivos_A06 <- list(
  
  # JUROS ATIVOS
  `41  Juros Ativos` = list(
    criterio = "
    substr(conta_contabil_numero, 1, 5) %in% c('34111', '34113', '34114', '34115', '34121', '34131', 
                                              '34141', '34181', '34183', '34184', '34185', '34191',
                                              '34211', '34213', '34214', '34215', '34221', '34291') |
    conta_contabil_numero %in% c('445110100', '445210100')
    "
  ),
  
  # JUROS PASSIVOS
  `42  Juros Passivos` = list(
    criterio = "
    substr(conta_contabil_numero, 1, 5) %in% c('44111', '44113', '44114', '44115', '44121', '44131', 
                                              '44133', '44134', '44135', '44141', '44211', '44213', 
                                              '44214', '44215', '44221')
    "
  ),
  
  # FUNDOS - FILTRO ESPEC√çFICO PARA JUROS
  `43  Fundos - Juros (Filtro Espec√≠fico)` = list(
    criterio = "
    orgao_uge_tipo_administracao_codigo == '7' & 
    ug_executora_codigo != '380916' & 
    !orgao_uge_codigo %in% c('25915', '37904')
    "
  )
)
```

```{r processar_resultado_primario}


 # Aplicar crit√©rios e consolidar em uma √∫nica opera√ß√£o
rreo_a06_consolidado <- bind_rows(
  aplicar_criterios(
    df = dados_categoria_grupo %>% filter(mes_lancamento == mes_filtro, item_informacao_codigo == "56"),
    criterios = criterios_rreo_A06_despesas_categoria_grupo_A06
  ),
  aplicar_criterios(
    df = dados_receita,
    criterios = criterios_rreo_A06_receitas_A06
  ),
  aplicar_criterios(
    df = dados_ndd %>% filter(item_informacao_codigo == "56"),
    criterios = criterios_rreo_A06_despesas_natureza_detalhada_A06
  ),
  aplicar_criterios(
    df = dados_juros,
    criterios = criterios_rreo_A06_juros_ativos_passivos_A06
  ),
  aplicar_criterios(
    df = tg_RPN_disponibilidades,
    criterios = criterios_rreo_A06_disponibilidades_A06
  )
)

# Agrupar por mes_lancamento, categoria e somar valores
rreo_a06_final <- rreo_a06_consolidado %>%
  group_by(mes_lancamento, categoria) %>%
  summarise(
    valor = sum(valor, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(mes_lancamento, categoria)
  
  

datatable(rreo_a06_final)%>%
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")
 
  


```

# üìã RREO Anexo 07 - Restos a Pagar

## üìù Descri√ß√£o

Este anexo apresenta os Restos a Pagar classificados por:

-   **Tipo de Modalidade**: Intragovernamental vs Exceto Intragovernamental
-   **√ìrg√£o**: M√°ximo da estrutura organizacional
-   **Situa√ß√£o**: Processados e N√£o Processados

## üéØ Processamento dos Dados

### 

### Defini√ß√£o dos Agrupamentos

```{r agrupamentos_anexo_07}
#| echo: true

# Definir colunas de agrupamento
agrupado_despesa_tipo_modalidade_orgao <- c(
  "tipo_modalidade", 
  "orgao_uge_orgao_maximo_codigo", 
  "orgao_uge_orgao_maximo_nome"
)


```

## üìà Tabela Principal - Restos a Pagar por Modalidade e √ìrg√£o

```{r tabela_anexo_07}
#| echo: true

# Processar e exibir tabela principal usando fun√ß√µes centralizadas
# dt_formatada(
#   tabela_pivotada(dados_rp_anexo_07 %>% filter(mes_lancamento == mes_filtro), agrupado_despesa_tipo_modalidade_orgao), 
#   agrupado_despesa_tipo_modalidade_orgao
# )


datatable(dados_rp_anexo_07 %>%
            group_by( item_informacao_nome) %>%
            filter(mes_lancamento == mes_filtro) %>% 
            summarise(valor = sum(saldo_r_item_informacao, na.rm = TRUE)))%>%
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")
```

# üìã RREO Anexo 08 - MDE {#sec-anexo-08}

## üìù Descri√ß√£o

Este anexo apresenta as **Receitas e Despesas com Manuten√ß√£o e Desenvolvimento do Ensino (MDE)**, incluindo:

-   üìä **Classifica√ß√£o por categoria** conforme crit√©rios espec√≠ficos
-   üí∞ **C√°lculo da RLI** (Receita L√≠quida de Impostos)
-   üéØ **Percentual de aplica√ß√£o** em MDE
-   üìã **An√°lise de transfer√™ncias constitucionais**

## üéØ Defini√ß√£o dos Crit√©rios

### Crit√©rios de Educa√ß√£o

```{r criterios_educacao}
#| echo: true
#| include: false

# Definir a lista de crit√©rios para classifica√ß√£o das despesas MDE
criterios_rreo_A08_mde_despesas <- list(
  `01 - COMPLEMENTA√á√ÉO DA UNI√ÉO AO FUNDEB` = list(
    criterio = "acao_governo_codigo %in% c('00SB', '0E36')"
  ),
  `03 - EDUCA√á√ÉO B√ÅSICA` = list(
    criterio = "fonte_recursos_codigo %notin% c('008', '035', '133', '134', '213', '242') & iduso_codigo == 8 & elemento_despesa_codigo %notin% c('01', '03', '59') & subfuncao_governo_codigo == '368'"
  ),
  `04 - ENSINO SUPERIOR` = list(
    criterio = "fonte_recursos_codigo %notin% c('008', '035', '133', '134', '213', '242') & iduso_codigo == 8 & elemento_despesa_codigo %notin% c('01', '03', '59') & subfuncao_governo_codigo %in% c('364')"
  ),
  `05 - ENSINO PROFISSIONAL N√ÉO INTEGRADO AO ENSINO REGULAR` = list(
    criterio = "fonte_recursos_codigo %notin% c('008', '035', '133', '134') & iduso_codigo == 8 & elemento_despesa_codigo %notin% c('01', '03', '59') & subfuncao_governo_codigo == '363'"
  ),
  `06 - OUTRAS` = list(
    criterio = "fonte_recursos_codigo %notin% c('008', '035', '133', '134') & iduso_codigo == 8 & elemento_despesa_codigo %notin% c('01', '03', '59') & !subfuncao_governo_codigo %in% c('363', '364', '368') & acao_governo_codigo %notin% c('00SB', '0E36')"
  ),
  `08 - COMPLEMENTA√á√ÉO DA UNI√ÉO - VAAF` = list(
    criterio = "acao_governo_codigo %in% c('00SB', '0E36')  & plano_orcamentario_codigo_po == '0001'"
  ),
  `09 - COMPLEMENTA√á√ÉO DA UNI√ÉO - VAAT` = list(
    criterio = "acao_governo_codigo %in% c('00SB', '0E36') & plano_orcamentario_codigo_po %in% c('0002')  & plano_orcamentario_codigo_po %in% c('0003', '0004') & funcao_governo_codigo == '12' & subfuncao_governo_codigo == '847' & programa_governo_codigo == 5111 & acao_governo_codigo == '00SB' & unidade_orcamentaria_codigo == '26298' "
  ),
  `09b - VAAT po 26298 12 847 5111 00SB 0003` = list(
    criterio = "fonte_recursos_codigo %notin% c('008') & plano_orcamentario_codigo_po %in% c('0003') & funcao_governo_codigo == '12' & subfuncao_governo_codigo == '847' & programa_governo_codigo == 5111 & acao_governo_codigo == '00SB' & unidade_orcamentaria_codigo == '26298'"
  ),
  `11 - DESPESAS CUSTEADAS COM A CONTRIBUI√á√ÉO SOCIAL DO SAL√ÅRIO-EDUCA√á√ÉO` = list(
    criterio = "fonte_recursos_codigo %in% c('133', '134', '213', '008', '035', '212') & iduso_codigo == 8 & acao_governo_codigo %notin% c('00SB', '0E36')"
  ),
  `12 - DESPESAS COM O FUNDO CONSTITUCIONAL DO DISTRITO FEDERAL - FCDF` = list(
    criterio = "acao_governo_codigo %in% c('0312') & fonte_recursos_codigo %notin% c('133', '134', '213', '008', '035', '212')"
  ),
  `13 - DESPESAS CUSTEADAS COM RECEITAS DE ROYALTIES DE EXPLORA√á√ÉO DO PR√â-SAL` = list(
    criterio = "fonte_recursos_codigo %in% c('242') & iduso_codigo == 8 & elemento_despesa_codigo %in% c('01', '03', '59')"
  ),
  `14 - DEMAIS DESPESAS COM EDUCA√á√ÉO` = list(
    criterio = "iduso_codigo == 8 & fonte_recursos_codigo %in% c('008', '035', '133', '134', '213', '050', '000') & elemento_despesa_codigo %in% c('01', '03', '59') & acao_governo_codigo %notin% c('00SB', '0312', '0E36')"
  )
)

aplicar_criterios(dados_despesa %>% filter(item_informacao_codigo == "25"), criterios_rreo_A08_mde_despesas)
```

## üí∞ C√°lculo da Receita L√≠quida de Impostos (RLI)

### Receitas Base para RLI

```{r receitas_rli}

#| echo: true




# Receitas que comp√µem a base da RLI (impostos)
receitas_base_rli <- dados_receita %>% 
  filter(
    item_informacao_codigo == "5",
    startsWith(natureza_receita_codigo_completo, '711') | 
    startsWith(natureza_receita_codigo_completo, "111")
  ) %>% 
  group_by(mes_lancamento) %>% 
  summarise(
    receita = sum(saldo_r_item_informacao, na.rm = TRUE),
    .groups = "drop"
  )


```

### Transfer√™ncias Constitucionais

```{r transferencias_anexo_08}
#| echo: true

# Classificar transfer√™ncias constitucionais
rli_transf <- dados_despesa %>% 
  filter(item_informacao_codigo == "56") %>% 
  mutate(
    transferencia = case_when(
      acao_governo_codigo == "0044" ~ "FPE",
      acao_governo_codigo == "0045" ~ "FPM", 
      acao_governo_codigo == "0046" ~ "IPI_repasse",
      acao_governo_codigo == "0C33" ~ "FUNDEB",
      acao_governo_codigo == "00H6" ~ "IOF_repasse",
      acao_governo_codigo == "006M" ~ "ITR_repasse",
      .default = "demais"
    )
  ) %>% 
  group_by(transferencia, mes_lancamento) %>%  
  summarise(
    valor_transferencia = sum(saldo_r_item_informacao, na.rm = TRUE),
    .groups = "drop"
  )

# Mostrar transfer√™ncias por tipo
transferencias_resumo <- rli_transf %>%
  group_by(transferencia) %>%
  summarise(
    total = sum(valor_transferencia, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(desc(total)) %>%
  mutate(total_formatado = formatar_numero(total))


```

### C√°lculo da RLI Mensal

```{r rli_mensal}

#| echo: true

# Consolidar transfer√™ncias (exceto "demais")
transferencias_consolidadas <- rli_transf %>% 
  filter(transferencia != "demais") %>% 
  group_by(mes_lancamento) %>% 
  summarise(
    transferencia_total = sum(valor_transferencia, na.rm = TRUE),
    .groups = "drop"
  )

# Calcular RLI mensal
rli_mensal <- full_join(
  receitas_base_rli, 
  transferencias_consolidadas, 
  by = "mes_lancamento"
) %>%
  mutate(
    transferencia_total = ifelse(is.na(transferencia_total), 0, transferencia_total),
    receita = ifelse(is.na(receita), 0, receita),
    rli = (receita - transferencia_total) * 0.18
  ) %>%
  # Ordenar por m√™s corretamente
  mutate(
    mes_ordenacao = case_when(
      str_detect(mes_lancamento, "JAN") ~ 1,
      str_detect(mes_lancamento, "FEV") ~ 2,
      str_detect(mes_lancamento, "MAR") ~ 3,
      str_detect(mes_lancamento, "ABR") ~ 4,
      str_detect(mes_lancamento, "MAI") ~ 5,
      str_detect(mes_lancamento, "JUN") ~ 6,
      str_detect(mes_lancamento, "JUL") ~ 7,
      str_detect(mes_lancamento, "AGO") ~ 8,
      str_detect(mes_lancamento, "SET") ~ 9,
      str_detect(mes_lancamento, "OUT") ~ 10,
      str_detect(mes_lancamento, "NOV") ~ 11,
      str_detect(mes_lancamento, "DEZ") ~ 12,
      TRUE ~ 99
    )
  ) %>%
  arrange(mes_ordenacao) %>%
  select(-mes_ordenacao) %>%
  mutate(
    receita_formatada = formatar_numero(receita),
    transferencia_formatada = formatar_numero(transferencia_total),
    rli_formatado = formatar_numero(rli)
  )

# Exibir com DT::datatable
DT::datatable(
  rli_mensal %>% 
    select(mes_lancamento, receita_formatada, transferencia_formatada, rli_formatado),
  colnames = c("M√™s", "Receita Base", "Transfer√™ncias", "RLI (18%)"),
  caption = "üìä Receita L√≠quida de Impostos (RLI) Mensal",
  rownames = FALSE,
  options = list(
    pageLength = 15,
    dom = 'ft',
    columnDefs = list(
      list(className = 'dt-left', targets = "_all")  # Alinhar tudo √† esquerda
    ),
    language = list(
      url = '//cdn.datatables.net/plug-ins/1.10.11/i18n/Portuguese.json'
    )
  )
) %>%
  DT::formatStyle(
    columns = c("receita_formatada", "transferencia_formatada", "rli_formatado"),
    textAlign = 'right'  # N√∫meros √† direita
  ) %>%
  DT::formatStyle(
    columns = "mes_lancamento",
    textAlign = 'left',   # M√™s √† esquerda
    fontWeight = 'bold'
  )
```

## üéØ Aplica√ß√£o M√≠nima em MDE

### RLI do Per√≠odo de Refer√™ncia

```{r rli_periodo}

#| echo: true

# RLI espec√≠fica do m√™s de refer√™ncia
rli_atual <- rli_mensal %>% 
  filter(mes_lancamento == mes_filtro) %>% 
  summarise(minimo_mde = sum(rli, na.rm = TRUE)) %>%
  pull(minimo_mde)

print(paste("üìÖ RLI para", mes_filtro, ":", formatar_numero(rli_atual)))
```

### Despesas MDE do Per√≠odo

```{r despesas_mde}

# Despesas MDE das categorias principais (02, 03, 04, 05, 06)
despesa_mde <- aplicar_criterios(dados_despesa %>% filter(item_informacao_codigo == 25), criterios_rreo_A08_mde_despesas) %>% 
  filter(
    mes_lancamento == mes_filtro,
    ordem %in% c(
      "03",
      "04", 
      "05",
      "06"
    )
  ) %>% 
  summarise(valor = sum(valor, na.rm = TRUE)) 

print(formatar_numero(despesa_mde$valor))
```

### Complementa√ß√£o FUNDEB

```{r complementacao_fundeb}

#| echo: true

# Complementa√ß√£o FUNDEB (30% da complementa√ß√£o da Uni√£o)
complementacao_fundeb <- dados_despesa %>% 
  filter(
    item_informacao_codigo == 25, 
    mes_lancamento == mes_filtro,
    acao_governo_codigo %in% c('0E36', '00SB')
  ) %>% 
  summarise(comp_fundeb = sum(saldo_r_item_informacao, na.rm = TRUE) * 0.3) %>%
  pull(comp_fundeb)

print(paste("üéØ Complementa√ß√£o FUNDEB (30%):", formatar_numero(complementacao_fundeb)))
```

### Restos a Pagar MDE

```{r rp_mde}
#| echo: true
#| include: false

# AJUSTADO: Agrupado por item de informa√ß√£o
despesa_mde_rp_detalhado <- dados_rp_anexo_08 %>%
  filter(
    mes_lancamento == mes_filtro,  
    !elemento_despesa_codigo %in% c('01', '03'),
    (
      (fonte_recursos_codigo %in% c('000', '012', '00', '12') & 
       (iduso_codigo == 8 | lei_calmon_s_n == 'SIM')) |
      (ne_c_cor_ano_emissao >= 2020 & 
       !fonte_recursos_codigo %in% c('133', '134', '213', '08', '13', '93') & 
       iduso_codigo == 8)
    )
  ) %>%
  group_by(item_informacao_codigo, item_informacao_nome) %>%
  summarise(
    valor = sum(saldo_r_item_informacao, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(item_informacao_codigo)

# Total consolidado para c√°lculos
despesa_mde_rp <- sum(despesa_mde_rp_detalhado$valor, na.rm = TRUE)

print("üìã Restos a Pagar MDE por Item de Informa√ß√£o:")
print(despesa_mde_rp_detalhado)
print(paste("üìã Total RP MDE:", formatar_numero(despesa_mde_rp)))
```

## üìä C√°lculo do Percentual de Aplica√ß√£o

```{r percentual_aplicacao}

#| echo: true

# C√°lculo do percentual total aplicado em MDE
total_despesas_mde <- despesa_mde + complementacao_fundeb
percentual_aplicacao <- (as.numeric(total_despesas_mde) / as.numeric(rli_atual)) *100

# Fun√ß√£o para formatar valores em R$ (com as.numeric para dataframes)
formatar_real <- function(valor) {
  paste0("R$ ", format(as.numeric(valor), big.mark = ".", decimal.mark = ",", scientific = FALSE))
}

# Tabela resumo
resumo_aplicacao <- data.frame(
  Item = c(
    "üí∞ Despesas MDE Principais",
    "üéØ Complementa√ß√£o FUNDEB (30%)",
    "üìã Restos a Pagar MDE",
    "üìä Total Despesas MDE",
    "üìà 18% da RLI (Base de C√°lculo)",
    "üéØ Percentual Aplicado"),
  
  Valor = c(
    formatar_real(despesa_mde),
    formatar_real(complementacao_fundeb),
    formatar_real(despesa_mde_rp),
    formatar_real(total_despesas_mde),
    formatar_real(rli_atual),
    paste0(round(as.numeric(percentual_aplicacao), 2), "%")
  ),
  Status = c(
    "‚úÖ Calculado",
    "‚úÖ Calculado", 
    "‚úÖ Calculado",
    "‚úÖ Consolidado",
    "‚úÖ Base",
    ifelse(as.numeric(percentual_aplicacao) >= 100, "‚úÖ Atendido", "‚ùå N√£o Atendido")
  ),
  stringsAsFactors = FALSE
)


# Renderizar tabela
kable(resumo_aplicacao, 
      caption = "üéØ Resumo da Aplica√ß√£o em MDE",
      format = "html",
      col.names = c("Item", "Valor", "Status"),
      align = c("l", "r", "c")) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE
  ) %>%
  row_spec(0, bold = TRUE, background = "#f8f9fa") %>%
  row_spec(6, bold = TRUE, 
           background = ifelse(as.numeric(percentual_aplicacao) >= 100, "#d4edda", "#f8d7da"),
           color = ifelse(as.numeric(percentual_aplicacao) >= 100, "#155724", "#721c24")) %>%
  column_spec(2, width = "200px")

# Resultado resumido
cat("\n=== RESULTADO FINAL ===\n")
cat("Total de Despesas MDE: R$", format(as.numeric(total_despesas_mde), big.mark = ".", decimal.mark = ","), "\n")
cat("18% da RLI (Base): R$", format(as.numeric(rli_atual), big.mark = ".", decimal.mark = ","), "\n")
cat("Percentual Aplicado:", round(as.numeric(percentual_aplicacao), 2), "%\n")
cat("Situa√ß√£o:", ifelse(as.numeric(percentual_aplicacao) >= 100, "‚úÖ ATENDE", "‚ùå N√ÉO ATENDE"), "ao m√≠nimo constitucional\n")
```

# üìã RREO Anexo 09 - Regra de Ouro.

```{r}
# Ler arquivo
dados <- read_excel("data/regra_de_ouro/regra_de_ouro_fabric_atual.xlsx", skip = 5) %>%
  clean_names()

# Filtrar linha da data e agrupar
resultado <- dados %>%
  filter(!grepl("^\\d{2}/\\d{2}/\\d{4}$", grupo_para_regra_de_ouro_tesouro_transparente)) %>%
  group_by(item = grupo_para_regra_de_ouro_tesouro_transparente) %>%
  summarise(
    saldo_abertura = sum(saldo_r_conta_contabil[grepl("000", mes_lancamento)], na.rm = TRUE),
    saldo_mes_atual = sum(saldo_r_conta_contabil[!grepl("000", mes_lancamento)], na.rm = TRUE),
    variacao = saldo_mes_atual - saldo_abertura
  )

# Identificar o m√™s atual
mes_atual <- dados %>%
  filter(!is.na(mes_lancamento), !grepl("000", mes_lancamento)) %>%
  pull(mes_lancamento) %>%
  first()

# Calcular Regra de Ouro
despesas <- resultado$variacao[resultado$item == "Despesas"]
receitas <- resultado$variacao[resultado$item == "Receitas"]
divida <- resultado$variacao[resultado$item == "Subconta da D√≠vida"]

regra_ouro <- despesas - (receitas - divida)

# Criar tabela com resultado da Regra de Ouro
regra_ouro_df <- data.frame(
  Indicador = "Regra de Ouro",
  Valor = regra_ouro,
  Status = ifelse(regra_ouro > 0, "N√ÉO CUMPRIDA", "CUMPRIDA")
)

# Exibir tabelas com DT::datatable
datatable(resultado, 
          caption = paste("Varia√ß√£o dos Saldos - M√™s", mes_atual, "vs Abertura"),
          options = list(pageLength = 10),
          rownames = FALSE) %>%
  formatCurrency(c("saldo_abertura", "saldo_mes_atual", "variacao"), 
                 currency = "R$ ", 
                 digits = 2, 
                 mark = ".", 
                 dec.mark = ",")

datatable(regra_ouro_df,
          caption = paste("Resultado da Regra de Ouro - M√™s", mes_atual),
          options = list(pageLength = 10, dom = 't'),
          rownames = FALSE) %>%
  formatCurrency("Valor", 
                 currency = "R$ ", 
                 digits = 2, 
                 mark = ".", 
                 dec.mark = ",")


```

# üìã RREO Anexo 11 - Aliena√ß√£o de Ativos.

# üìã RREO Anexo 12 - Sa√∫de.

## üìã Introdu√ß√£o

O **Anexo 12 do RREO** apresenta o demonstrativo das receitas e despesas com a√ß√µes e servi√ßos p√∫blicos de sa√∫de do Governo Federal, conforme estabelecido pela Emenda Constitucional n¬∫ 29/2000 e regulamentado pela Lei Complementar n¬∫ 141/2012.

Este relat√≥rio consolida informa√ß√µes sobre: - **Despesas Computadas**: Aplica√ß√µes diretas e transfer√™ncias nas subfun√ß√µes espec√≠ficas de sa√∫de - **Despesas N√£o Computadas**: Despesas do Minist√©rio da Sa√∫de n√£o computadas para o limite constitucional - **An√°lise por Modalidade**: Separa√ß√£o entre aplica√ß√£o direta e transfer√™ncias - **Indicadores de Cumprimento**: Verifica√ß√£o do atendimento aos limites constitucionais

## üè• Processamento das Despesas com Sa√∫de

### 1. Despesas Computadas - Subfun√ß√µes Espec√≠ficas

```{r despesas-saude-especificas}

#| include: false
# Filtrar despesas das subfun√ß√µes espec√≠ficas de sa√∫de (301-306)
despesas_saude <- dados_despesa %>% 
  filter(
    mes_lancamento == mes_filtro, 
    iduso_codigo == 6, 
    item_informacao_codigo == 25, 
    subfuncao_governo_codigo %in% c(301, 302, 303, 304, 305, 306)
  ) %>% 
  group_by(
    subfuncao_governo_codigo, 
    subfuncao_governo_nome, 
    categoria_economica_despesa_codigo,
    categoria_economica_despesa_nome, 
    modalidade_aplicacao_codigo
  ) %>% 
  summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao), .groups = "drop")

# Classificar por tipo de aplica√ß√£o
despesas_saude <- despesas_saude %>% 
  mutate(
    transferencia = ifelse(
      modalidade_aplicacao_codigo %in% c('30', '31', '32', '35', '36', '40', '41', '42', '45', '46'), 
      "_transferencia", 
      "aplicacao_direta"
    )
  )

# Criar tabela consolidada INCLUINDO LINHAS COM ZERO
tabela_saude_especificas <- despesas_saude %>% 
  group_by(
    subfuncao_governo_codigo, 
    subfuncao_governo_nome,
    categoria_economica_despesa_codigo, 
    categoria_economica_despesa_nome, 
    transferencia
  ) %>% 
  summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao), .groups = "drop") %>%
  # MANTER TODAS AS LINHAS, incluindo as com valor zero
  filter(TRUE)  # N√£o filtrar valores zero

# Exibir tabela
# DT::datatable(
#   tabela_saude_especificas,
#   caption = "Despesas com Sa√∫de - Subfun√ß√µes Espec√≠ficas (301-306) - Incluindo Valores Zero",
#   options = list(
#     pageLength = 20,  # Aumentar para mostrar mais linhas
#     scrollX = TRUE,
#     language = list(url = '//cdn.datatables.net/plug-ins/1.10.11/i18n/Portuguese-Brasil.json')
#   )
# ) %>%
#   DT::formatRound("saldo_r_item_informacao", 2, mark = ".", dec.mark = ",")

# Calcular total das subfun√ß√µes espec√≠ficas
total_subfuncoes_especificas <- sum(despesas_saude$saldo_r_item_informacao)
cat("\nüí∞ **Total das Subfun√ß√µes Espec√≠ficas de Sa√∫de:** R$", 
    format(total_subfuncoes_especificas, big.mark = ".", decimal.mark = ","), "\n")
```

### 2. Despesas em Outras Subfun√ß√µes (Demais)

```{r despesas-saude-demais}

#| include: false
# Calcular despesas em outras subfun√ß√µes
despesas_saude_demais <- as.numeric(
  dados_despesa %>% 
  filter(
    mes_lancamento == mes_filtro, 
    iduso_codigo == 6, 
    item_informacao_codigo == 25, 
    subfuncao_governo_codigo %notin% c(301, 302, 303, 304, 305, 306)
  ) %>% 
  summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao))
)

cat("üí∞ **Total das Demais Subfun√ß√µes de Sa√∫de:** R$", 
    format(despesas_saude_demais, big.mark = ".", decimal.mark = ","), "\n")

# Total geral das despesas computadas
total_despesas_computadas <- total_subfuncoes_especificas + despesas_saude_demais
cat("üí∞ **Total Geral das Despesas Computadas:** R$", 
    format(total_despesas_computadas, big.mark = ".", decimal.mark = ","), "\n\n")
```

### 3. An√°lise Consolidada de Todas as Despesas

```{r despesas-saude-consolidada}

#| include: false
# Processar todas as despesas de sa√∫de com agrupamento
despesas_saude_completa <- dados_despesa %>% 
  filter(
    mes_lancamento == mes_filtro, 
    iduso_codigo == 6, 
    item_informacao_codigo == 25
  ) %>% 
  group_by(
    subfuncao_governo_codigo, 
    subfuncao_governo_nome, 
    categoria_economica_despesa_codigo,
    categoria_economica_despesa_nome, 
    modalidade_aplicacao_codigo
  ) %>% 
  summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao), .groups = "drop")

# Reclassificar subfun√ß√µes e modalidades
despesas_saude_completa <- despesas_saude_completa %>% 
  mutate(
    subfuncao_governo_codigo = case_when(
      subfuncao_governo_codigo %in% c(301, 302, 303, 304, 305, 306) ~ as.character(subfuncao_governo_codigo),
      TRUE ~ "demais"
    ),
    subfuncao_governo_nome = case_when(
      subfuncao_governo_codigo %in% c("301", "302", "303", "304", "305", "306") ~ subfuncao_governo_nome,
      TRUE ~ "demais"
    ),
    transferencia = ifelse(
      modalidade_aplicacao_codigo %in% c('30', '31', '32', '35', '36', '40', '41', '42', '45', '46'), 
      "_transferencia", 
      "aplicacao_direta"
    )
  )

# Criar tabela consolidada final INCLUINDO VALORES ZERO
tabela_consolidada <- despesas_saude_completa %>% 
  group_by(
    subfuncao_governo_codigo, 
    subfuncao_governo_nome,
    categoria_economica_despesa_codigo, 
    categoria_economica_despesa_nome, 
    transferencia
  ) %>% 
  summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao), .groups = "drop") %>%
  # MANTER TODAS AS LINHAS, incluindo as com valor zero
  arrange(subfuncao_governo_codigo, categoria_economica_despesa_codigo, transferencia)

# Exibir tabela consolidada
# DT::datatable(
#   tabela_consolidada %>% adorn_totals(),
#   caption = "Despesas com Sa√∫de - An√°lise Consolidada (Incluindo Valores Zero)",
#   options = list(
#     pageLength = 25,  # Aumentar para mostrar mais linhas
#     scrollX = TRUE,
#     language = list(url = '//cdn.datatables.net/plug-ins/1.10.11/i18n/Portuguese-Brasil.json')
#   )
# ) %>%
#   DT::formatRound("saldo_r_item_informacao", 2, mark = ".", dec.mark = ",")

# Total consolidado em milhares
total_consolidado <- sum(despesas_saude_completa$saldo_r_item_informacao) / 1000
cat("\nüí∞ **Total Consolidado das Despesas com Sa√∫de:** R$", 
    format(total_consolidado, big.mark = ".", decimal.mark = ","), "mil\n")

cat("\nüí∞ **cumprimento do m√≠nimo:** ", 
    format(total_consolidado*1000/minimo_saude*100, big.mark = ".", decimal.mark = ","), "%\n")
```

## üö´ Despesas N√£o Computadas

### Despesas do Minist√©rio da Sa√∫de N√£o Computadas

```{r despesas-nao-computadas}

#| include: false
# Filtrar despesas n√£o computadas do Minist√©rio da Sa√∫de
despesa_saude_nao_computadas <- dados_despesa %>% 
  filter(
    mes_lancamento == mes_filtro, 
    iduso_codigo != 6, 
    item_informacao_codigo == 25,
    uo_orgao_superior_codigo == "36000", 
    unidade_orcamentaria_codigo != "74202"
  ) %>% 
  group_by(
    subfuncao_governo_codigo, 
    subfuncao_governo_nome, 
    categoria_economica_despesa_codigo,
    categoria_economica_despesa_nome, 
    modalidade_aplicacao_codigo
  ) %>%  
  summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao), .groups = "drop")

# Reclassificar para an√°lise
despesa_saude_nao_computadas <- despesa_saude_nao_computadas %>% 
  mutate(
    subfuncao_governo_codigo = case_when(
      subfuncao_governo_codigo %in% c(301, 302, 303, 304, 305, 306) ~ as.character(subfuncao_governo_codigo),
      TRUE ~ "demais"
    ),
    subfuncao_governo_nome = case_when(
      subfuncao_governo_codigo %in% c("301", "302", "303", "304", "305", "306") ~ subfuncao_governo_nome,
      TRUE ~ "demais"
    ),
    transferencia = ifelse(
      modalidade_aplicacao_codigo %in% c('30', '31', '32', '35', '36', '40', '41', '42', '45', '46'), 
      "_transferencia", 
      "aplicacao_direta"
    )
  )

# Tabela das despesas n√£o computadas INCLUINDO VALORES ZERO
tabela_nao_computadas <- despesa_saude_nao_computadas %>% 
  group_by(
    subfuncao_governo_codigo, 
    subfuncao_governo_nome,
    categoria_economica_despesa_codigo, 
    categoria_economica_despesa_nome, 
    transferencia
  ) %>% 
  summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao), .groups = "drop") %>%
  # MANTER TODAS AS LINHAS, incluindo as com valor zero
  arrange(subfuncao_governo_codigo, categoria_economica_despesa_codigo, transferencia)

# Exibir tabela
# DT::datatable(
#   tabela_nao_computadas,
#   caption = "Despesas do Minist√©rio da Sa√∫de N√ÉO Computadas para o Limite (Incluindo Valores Zero)",
#   options = list(
#     pageLength = 20,  # Aumentar para mostrar mais linhas
#     scrollX = TRUE,
#     language = list(url = '//cdn.datatables.net/plug-ins/1.10.11/i18n/Portuguese-Brasil.json')
#   )
# ) %>%
#   DT::formatRound("saldo_r_item_informacao", 2, mark = ".", dec.mark = ",")
```

```{r}



# Calcular total das subfun√ß√µes espec√≠ficas
total_subfuncoes_especificas <- sum(despesas_saude$saldo_r_item_informacao)
cat("\nüí∞ **Total das Subfun√ß√µes Espec√≠ficas de Sa√∫de:** R$", 
    format(total_subfuncoes_especificas, big.mark = ".", decimal.mark = ","), "\n")

cat("üí∞ **Total das Demais Subfun√ß√µes de Sa√∫de:** R$", 
    format(despesas_saude_demais, big.mark = ".", decimal.mark = ","), "\n")

# Total geral das despesas computadas
total_despesas_computadas <- total_subfuncoes_especificas + despesas_saude_demais
cat("üí∞ **Total Geral das Despesas Computadas:** R$", 
    format(total_despesas_computadas, big.mark = ".", decimal.mark = ","), "\n\n")




# Cumprimento do minimo

# cat("\nüí∞ **Cumprimento do minimo:** ",
#     format(total_despesas_computadas/minimo_saude*100, big.mark = ".", decimal.mark = ",", digits = 4), "%\n")

```

# üìã RREO Tabela 01

## üí∞ RECEITAS OR√áAMENT√ÅRIAS

```{r criterios_receitas}

# ======================================
# CRIT√âRIOS DA TABELA 1 - RECEITAS
# ======================================

criterios_rreo_T01_receitas <- list(
  
  # === RECEITAS CORRENTES ===
  
  # Receita Tribut√°ria
  `01  Receita Tribut√°ria` = list(
    criterio = "(nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 1) | (nre1_categoria_economica_codigo == 7 & nre2_origem_receita_codigo_origem == 1)"
  ),
  
  # Receita de Contribui√ß√µes
  `02  Receita de Contribui√ß√µes` = list(
    criterio = "(nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 2) | (nre1_categoria_economica_codigo == 7 & nre2_origem_receita_codigo_origem == 2)"
  ),
  
  # Receita Patrimonial
  `03  Receita Patrimonial` = list(
    criterio = "(nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 3) | (nre1_categoria_economica_codigo == 7 & nre2_origem_receita_codigo_origem == 3)"
  ),
  
  # Receita Agropecu√°ria
  `04  Receita Agropecu√°ria` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 4"
  ),
  
  # Receita Industrial
  `05  Receita Industrial` = list(
    criterio = "(nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 5) | (nre1_categoria_economica_codigo == 7 & nre2_origem_receita_codigo_origem == 5)"
  ),
  
  # Receita de Servi√ßos
  `06  Receita de Servi√ßos` = list(
    criterio = "(nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 6) | (nre1_categoria_economica_codigo == 7 & nre2_origem_receita_codigo_origem == 6)"
  ),
  
  # Transfer√™ncias Correntes
  `07  Transfer√™ncias Correntes` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 7"
  ),
  
  # Receitas Correntes a Classificar
  `08  Receitas Correntes a Classificar` = list(
    criterio = "nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 8"
  ),
  
  # Outras Receitas Correntes
  `09  Outras Receitas Correntes` = list(
    criterio = "(nre1_categoria_economica_codigo == 1 & nre2_origem_receita_codigo_origem == 9) | (nre1_categoria_economica_codigo == 7 & nre2_origem_receita_codigo_origem == 9)"
  ),
  
  # === RECEITAS DE CAPITAL ===
  
  # Opera√ß√µes de Cr√©dito
  `10  Opera√ß√µes de Cr√©dito` = list(
    criterio = "(nre1_categoria_economica_codigo == 2 & nre2_origem_receita_codigo_origem == 1) | (nre1_categoria_economica_codigo == 8 & nre2_origem_receita_codigo_origem == 1)"
  ),
  
  # Aliena√ß√£o de Bens
  `11  Aliena√ß√£o de Bens` = list(
    criterio = "(nre1_categoria_economica_codigo == 2 & nre2_origem_receita_codigo_origem == 2) | (nre1_categoria_economica_codigo == 8 & nre2_origem_receita_codigo_origem == 2)"
  ),
  
  # Transfer√™ncias de Capital
  `12  Transfer√™ncias de Capital` = list(
    criterio = "nre1_categoria_economica_codigo == 2 & nre2_origem_receita_codigo_origem == 4"
  ),
  
  # Outras Receitas de Capital
  `13  Outras Receitas de Capital` = list(
    criterio = "(nre1_categoria_economica_codigo == 2 & nre2_origem_receita_codigo_origem == 5) | (nre1_categoria_economica_codigo == 8 & nre2_origem_receita_codigo_origem == 5)"
  ),
  
  # SUBTOTAL (I) - Receitas Correntes + Receitas de Capital - Intra-or√ßament√°rias
  `14  SUBTOTAL (I)` = list(
    criterio = "nre1_categoria_economica_codigo %in% c(1, 2, 7, 8)"
  )
)
```

```{r processar-receitas}


# Processar dados de receitas



datatable(aplicar_criterios(
  df = dados_receita %>% filter(esfera_orcamentaria_codigo == 2, item_informacao_codigo == "5") %>% unique(),
  criterios = criterios_rreo_T01_receitas)%>% group_by(categoria) %>% summarise(valor = sum(valor, na.rm = TRUE))) %>%
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")


```

## üí∏ DESPESAS OR√áAMENT√ÅRIAS

```{r criterios-despesas}


# ======================================
# CRIT√âRIOS DA TABELA 1 - DESPESAS
# ======================================

criterios_rreo_T01_despesas_T01 <- list(
  
  # === DESPESAS CORRENTES ===
  
  # Pessoal e Encargos Sociais
  `01  Pessoal e Encargos Sociais` = list(
    criterio = "grupo_despesa_codigo_grupo == '1'"
  ),
  
  # Juros e Encargos da D√≠vida
  `02  Juros e Encargos da D√≠vida` = list(
    criterio = "grupo_despesa_codigo_grupo == '2'"
  ),
  
  # Outras Despesas Correntes
  `03  Outras Despesas Correntes` = list(
    criterio = "grupo_despesa_codigo_grupo == '3'"
  ),
  
  # Benef√≠cios Previdenci√°rios
  `04  Benef√≠cios Previdenci√°rios` = list(
    criterio = "grupo_despesa_codigo_grupo == '3' & unidade_orcamentaria_codigo %in% c('55902', '40904', '33904', '25917')"
  ),
  
  # Transfer√™ncias
  `05  Transfer√™ncias` = list(
    criterio = "grupo_despesa_codigo_grupo == '3' & modalidade_aplicacao_codigo %in% c('30', '31', '35', '36', '40', '41', '42', '45')"
  ),
  
  # Demais Despesas Correntes
  `06  Demais Despesas Correntes` = list(
    criterio = "
    grupo_despesa_codigo_grupo == '3' & 
    !unidade_orcamentaria_codigo %in% c('55902', '40904', '33904', '25917') &
    !modalidade_aplicacao_codigo %in% c('30', '31', '35', '36', '40', '41', '42', '45')
    "
  ),
  
  # === DESPESAS DE CAPITAL ===
  
  # Investimentos
  `07  Investimentos` = list(
    criterio = "grupo_despesa_codigo_grupo == '4'"
  ),
  
  # Invers√µes Financeiras
  `08  Invers√µes Financeiras` = list(
    criterio = "grupo_despesa_codigo_grupo == '5'"
  ),
  
  # Amortiza√ß√£o da D√≠vida
  `09  Amortiza√ß√£o da D√≠vida` = list(
    criterio = "grupo_despesa_codigo_grupo == '6'"
  ),
  
  # RESERVA DE CONTING√äNCIA
  `10  RESERVA DE CONTING√äNCIA` = list(
    criterio = "grupo_despesa_codigo_grupo == '9'"
  ),
  
  # SUBTOTAL (III) - Total das Despesas
  `11  SUBTOTAL (III)` = list(
    criterio = "grupo_despesa_codigo_grupo %in% c('1', '2', '3', '4', '5', '6', '9')"
  )
)
```

```{r processar-despesas}

# Processar dados de despesas
datatable(aplicar_criterios(
  df = dados_despesa %>% filter(esfera_orcamentaria_codigo == 2, item_informacao_codigo == "25") %>% unique(),
  criterios = criterios_rreo_T01_despesas_T01) %>% group_by(categoria) %>% summarise(valor = sum(valor, na.rm = TRUE))) %>%
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")


```

### Resultado da Seguridade Social

```{r}
(formatar_numero (resultado_seguridade <- as.numeric(df_criterios_rreo_T01_receitas %>% filter(ordem == "14") %>% summarise(valor= valor))-as.numeric(df_criterios_rreo_T01_despesas_T01 %>% filter(ordem == "11") %>% summarise(valor= valor))) )

```

## üìä Tabela 01A - Detalhamento das Receitas

```{r criterios-tabela1a}

# ======================================
# CRIT√âRIOS DA TABELA 1A - COLUNAS 2025
# ======================================
criterios_rreo_T01a_receita_prevista_T01 <- list(
  
  # === PREVIS√ÉO ATUALIZADA (a) ===
  
  # Previs√£o Atualizada da Receita
  `PREVISAO_ATUALIZADA` = list(
    criterio = "
    natureza_receita_codigo_completo %in% c('12100111', '12100121', '12100131', '12100211', '12102121', '12102131', 
                                            '12106511', '12106611', '12106711', '12107211', '12107411', '12107611',
                                            '12108111', '12109131', '12101011', '12101311', '12101411', '12101611',
                                            '12106131', '12106211', '12106411', '12106511', '12106611', '12106711',
                                            '12110051', '12110061', '12106211', '12100511', '12106311', '12106711',
                                            '12104211', '12104311', '12101051') &
    fonte_recursos_codigo == '000' &
    esfera_orcamentaria_codigo == '1'
    "
  ),
  
  # === RECEITAS REALIZADAS NO M√äS ===
  
  # Receita Or√ßament√°ria Arrecadada no M√™s
  `RECEITA_REALIZADA_MES` = list(
    criterio = "
    fonte_recursos_codigo == '000' &
    (endsWith(fonte_recursos_detalhada_codigo, '98001') | endsWith(fonte_recursos_detalhada_codigo, '73910'))
    "
  ),
  
  # === RECEITAS REALIZADAS AT√â O M√äS ===
  
  # Receita Or√ßament√°ria Arrecadada Acumulada
  `RECEITA_REALIZADA_ACUMULADA` = list(
    criterio = "
    fonte_recursos_codigo == '000' &
    (endsWith(fonte_recursos_detalhada_codigo, '98001') | endsWith(fonte_recursos_detalhada_codigo, '73910'))
    "
  )
)
```

```{r processar-tabela1a}

# Processar Tabela 01A
datatable(aplicar_criterios(
  df = dados_receita %>% filter(esfera_orcamentaria_codigo == 2) %>% unique(),
  criterios = criterios_rreo_T01a_receita_prevista_T01
)%>% group_by(categoria) %>% summarise(valor = sum(valor, na.rm = TRUE))) %>%
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")


```

## üè• Seguridade Social

```{r criterios-seguridade}

# Crit√©rios para an√°lise da Seguridade Social
criterios_rreo_T01B_seguridade_T01B <- list(
  
  # SA√öDE
  `01  Sa√∫de` = list(
    criterio = "iduso_codigo %in% c('6') & funcao_governo_codigo %notin% c('08')"
  ),
  
  # RGPS - UNIDADE OR√áAMENT√ÅRIA  
  `02  RGPS - Receitas da Previd√™ncia Social` = list(
    criterio = "unidade_orcamentaria_codigo %in% c('33904', '40404', '35902', '29917')"
  ),
  
  # ASSIST√äNCIA SOCIAL
  `03  Assist√™ncia Social` = list(
    criterio = "funcao_governo_codigo %in% c('08') & acao_governo_codigo %notin% c('0581', '0544', '0563', '0658', '0585', '0653', '0636')"
  ),
  
  # ABONO SALARIAL
  `04  Abono Salarial` = list(
    criterio = "acao_governo_codigo %in% c('0581')"
  ),
  
  # SEGURO DESEMPREGO
  `05  Seguro Desemprego` = list(
    criterio = "acao_governo_codigo %in% c('00H4', '0583', '0585', '0686', '0653')"
  )
)
```

```{r processar-seguridade}

# Processar dados da Seguridade Social
datatable(aplicar_criterios(
  df = dados_despesa %>% filter(esfera_orcamentaria_codigo == 2, item_informacao_codigo == "25") %>% unique(),
  criterios = criterios_rreo_T01B_seguridade_T01B
)%>% group_by(categoria) %>% summarise(valor = sum(valor, na.rm = TRUE))) %>%
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")


```

# üìã RREO Tabela 02

## üìä Crit√©rios da Tabela 02

```{r criterios-tabela02}

# ======================================
# CRIT√âRIOS DA TABELA 02 -
# ======================================

criterios_rreo_T02_despesas_T02 <- list(
  
  # APLICA√á√ÉO DIRETA (ser√° calculado por soma dos subitens)
  `01  Aplica√ß√£o Direta` = list(
    criterio = "FALSE"  # Ser√° calculado por soma posterior
  ),
  
  # A DETALHAR
  `02  A Detalhar` = list(
    criterio = "elemento_despesa_codigo %in% c('00') "
  ),
  
  # PESSOAL CIVIL (ser√° calculado por soma dos subitens)
  `03  Pessoal Civil` = list(
    criterio = "FALSE"  # Ser√° calculado por soma posterior
  ),
  
  # PESSOAL CIVIL - VENCIMENTOS E VANTAGENS FIXAS
  `04  Pessoal Civil - Vencimentos e Vantagens Fixas` = list(
    criterio = "elemento_despesa_codigo %in% c('11')"
  ),
  
  # PESSOAL CIVIL - OUTRAS DESPESAS VARI√ÅVEIS
  `05  Pessoal Civil - Outras Despesas Vari√°veis` = list(
    criterio = "elemento_despesa_codigo %in% c('16')"
  ),
  
  # PESSOAL CIVIL - APOSENTADORIA
  `06  Pessoal Civil - Aposentadoria` = list(
    criterio = "elemento_despesa_codigo %in% c('01') & (orgao_uge_orgao_maximo_codigo %notin% c('52000') | (orgao_uge_orgao_maximo_codigo %in% c('52000') & acao_governo_codigo %in% c('0181')))"
  ),
  
  # PESSOAL CIVIL - PENS√ïES
  `07  Pessoal Civil - Pens√µes` = list(
    criterio = "elemento_despesa_codigo %in% c('03') & (orgao_uge_orgao_maximo_codigo %notin% c('52000') | (orgao_uge_orgao_maximo_codigo %in% c('52000') & acao_governo_codigo %in% c('0181')))"
  ),
  
  # PESSOAL CIVIL - CONTRIBUI√á√ïES A ENTIDADES FECHADAS DE PREVID√äNCIA
  `08  Pessoal Civil - Contribui√ß√µes a Entidades Fechadas de Previd√™ncia` = list(
    criterio = "elemento_despesa_codigo %in% c('07') & orgao_uge_orgao_maximo_codigo %notin% c('52000')"
  ),
  
  # PESSOAL CIVIL - OBRIGA√á√ïES PATRONAIS
  `09  Pessoal Civil - Obriga√ß√µes Patronais` = list(
    criterio = "elemento_despesa_codigo %in% c('13') & orgao_uge_orgao_maximo_codigo %notin% c('52000')"
  ),
  
  # PESSOAL CIVIL - OUTRAS APLICA√á√ïES
  `10  Pessoal Civil - Outras Aplica√ß√µes` = list(
    criterio = "
    (elemento_despesa_codigo %notin% c('00', '01', '03') & 
     orgao_uge_orgao_maximo_codigo %in% c('52000') & 
     acao_governo_codigo %in% c('0181')) | 
    (elemento_despesa_codigo %notin% c('00', '01', '03', '07', '11', '12', '13', '16', '17', '41') & 
     orgao_uge_orgao_maximo_codigo %notin% c('52000'))
    "
  ),
  
  # PESSOAL MILITAR (ser√° calculado por soma dos subitens)
  `11  Pessoal Militar` = list(
    criterio = "FALSE"  # Ser√° calculado por soma posterior
  ),
  
  # PESSOAL MILITAR - VENCIMENTOS E VANTAGENS FIXAS
  `12  Pessoal Militar - Vencimentos e Vantagens Fixas` = list(
    criterio = "elemento_despesa_codigo %in% c('12')"
  ),
  
  # PESSOAL MILITAR - OUTRAS DESPESAS VARI√ÅVEIS
  `13  Pessoal Militar - Outras Despesas Vari√°veis` = list(
    criterio = "elemento_despesa_codigo %in% c('17')"
  ),
  
  # PESSOAL MILITAR - REFORMAS
  `14  Pessoal Militar - Reformas` = list(
    criterio = "elemento_despesa_codigo %in% c('01') & orgao_uge_orgao_maximo_codigo %in% c('52000') & acao_governo_codigo %notin% c('0181')"
  ),
  
  # PESSOAL MILITAR - PENS√ïES
  `15  Pessoal Militar - Pens√µes` = list(
    criterio = "elemento_despesa_codigo %in% c('03') & orgao_uge_orgao_maximo_codigo %in% c('52000') & acao_governo_codigo %notin% c('0181')"
  ),
  
  # PESSOAL MILITAR - OBRIGA√á√ïES PATRONAIS
  `16  Pessoal Militar - Obriga√ß√µes Patronais` = list(
    criterio = "elemento_despesa_codigo %in% c('13') & orgao_uge_orgao_maximo_codigo %in% c('52000')"
  ),
  
  # PESSOAL MILITAR - OUTRAS APLICA√á√ïES (+)
  `17  Pessoal Militar - Outras Aplica√ß√µes (+)` = list(
    criterio = "elemento_despesa_codigo %notin% c('00', '01', '03', '11', '12', '13', '16', '17', '41') & orgao_uge_orgao_maximo_codigo %in% c('52000')"
  ),
  
  # PESSOAL MILITAR - OUTRAS APLICA√á√ïES (-)
  `18  Pessoal Militar - Outras Aplica√ß√µes (-)` = list(
    criterio = "elemento_despesa_codigo %notin% c('00', '01', '03', '11') & orgao_uge_orgao_maximo_codigo %in% c('52000') & acao_governo_codigo %in% c('0181')"
  ),
  
  # TRANSFER√äNCIAS INTERGOVERNAMENTAIS
  `19  Transfer√™ncias Intergovernamentais` = list(
    criterio = "elemento_despesa_codigo %in% c('41')"
  ),
  
  # TRANSFER√äNCIAS A ESTADOS E AO DF
  `20  Transfer√™ncias a Estados e ao DF` = list(
    criterio = "elemento_despesa_codigo %in% c('41')"
  )
)
```

### üíº Processamento dos Dados

### üìä Despesa Liquidada

```{r processar-liquidada}




datatable(aplicar_criterios(df = dados_despesa %>% 
    filter( grupo_despesa_codigo_grupo == 1,  orgao_uge_orcam_fiscal_s_n == "PERTENCE",   mes_lancamento == mes_filtro, item_informacao_codigo == 25
    ),
  criterios = criterios_rreo_T02_despesas_T02,
  group_vars = c("orgao_uge_tipo_administracao_nome")) %>% group_by(categoria, orgao_uge_tipo_administracao_nome) %>% summarise(valor = sum(valor, na.rm = TRUE)) %>% pivot_wider(names_from = "orgao_uge_tipo_administracao_nome", values_from = "valor") ) %>%
  formatRound(c('ADMINISTRACAO DIRETA',
  'AUTARQUIA',
  'ECONOMIA MISTA',
  'EMPRESA PUBLICA COMERCIAL E FINANCEIRA',
  'FUNDACAO',
  'FUNDOS'), 2, mark = ".", dec.mark = ",")



```

### ‚úÖ Teste Pessoal Militar

```{r validacao-militar}

# Valida√ß√£o espec√≠fica para Pessoal Militar
validacao_militar <- dados_despesa %>% 
  group_by(orgao_uge_tipo_administracao_nome) %>%
  filter(
    grupo_despesa_codigo_grupo == 1,
    mes_lancamento == mes_filtro,
    item_informacao_codigo == "9"
  ) %>% 
  filter(
    (elemento_despesa_codigo %in% c('12', '17')) |
    (elemento_despesa_codigo %in% c('01') & 
     orgao_uge_orgao_maximo_codigo %in% c('52000') &
     acao_governo_codigo %notin% c('0181')) |
    (elemento_despesa_codigo %in% c('03') & 
     orgao_uge_orgao_maximo_codigo %in% c('52000') &
     acao_governo_codigo %notin% c('0181')) |
    (elemento_despesa_codigo %in% c('13') & 
     orgao_uge_orgao_maximo_codigo %in% c('52000'))
  ) %>% 
  summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao, na.rm = TRUE), .groups = "drop")

datatable(validacao_militar, 
          caption = "Valida√ß√£o - Pessoal Militar") %>%
  formatRound(c('saldo_r_item_informacao'), 2, mark = ".", dec.mark = ",")
```

### ‚úÖ Teste Pessoal Civil

```{r validacao-civil}

# Valida√ß√£o espec√≠fica para Pessoal Civil
validacao_civil <- dados_despesa %>% 
  group_by(orgao_uge_tipo_administracao_nome) %>%
  filter(
    grupo_despesa_codigo_grupo == 1,
    mes_lancamento == mes_filtro,
    item_informacao_codigo == "9"
  ) %>% 
  filter(
    # Condi√ß√µes espec√≠ficas para Pessoal Civil
    (elemento_despesa_codigo %in% c('11', '16')) |
    (elemento_despesa_codigo == '01' & orgao_uge_orgao_maximo_codigo != '52000') |
    (elemento_despesa_codigo == '01' & orgao_uge_orgao_maximo_codigo == '52000' & acao_governo_codigo == '0181') |
    (elemento_despesa_codigo == '03' & orgao_uge_orgao_maximo_codigo != '52000') |
    (elemento_despesa_codigo == '03' & orgao_uge_orgao_maximo_codigo == '52000' & acao_governo_codigo == '0181') |
    (elemento_despesa_codigo == '07' & orgao_uge_orgao_maximo_codigo != '52000') |
    (elemento_despesa_codigo == '13' & orgao_uge_orgao_maximo_codigo != '52000') |
    (elemento_despesa_codigo %notin% c('00', '01', '03', '07', '11', '12', '13', '16', '17', '41') & 
     orgao_uge_orgao_maximo_codigo != '52000') |
    (elemento_despesa_codigo %notin% c('00', '01', '03') & 
     orgao_uge_orgao_maximo_codigo == '52000' & 
     acao_governo_codigo == '0181')
  ) %>% 
  summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao, na.rm = TRUE), .groups = "drop")

datatable(validacao_civil, 
          caption = "Valida√ß√£o - Pessoal Civil") %>%
  formatRound(c('saldo_r_item_informacao'), 2, mark = ".", dec.mark = ",")
```



# üìã RREO Tabela 03

```{r tabela_3}

# agrupado_despesa_orgao <- c("orgao_uge_orgao_maximo_codigo", "orgao_uge_orgao_maximo_nome")
# 
# dados_agregados_orgao <- dados_despesa %>% 
#   filter(resultado_eof_codigo == 6) %>%
#   group_by(across(all_of(c(agrupado_despesa_orgao, "item_informacao_nome")))) %>%
#   summarise(
#     saldo_r_item_informacao = sum(saldo_r_item_informacao, na.rm = TRUE),
#     .groups = "drop"
#   )
# 
# dt_formatada(
#   tabela_pivotada(dados_agregados_orgao, agrupado_despesa_orgao),
#   agrupado_despesa_orgao
# )


formatar_numero((dados_despesa %>% 
  filter(resultado_eof_codigo == 6, item_informacao_codigo == 23) %>% summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao, na.rm =  TRUE)))$saldo_r_item_informacao)
```

```{r}
#| label: diagnostico-objetos-vazios
#| code-fold: true

# ==============================================================================
# DIAGN√ìSTICO: Investigar Objetos Vazios
# ==============================================================================

# Criar consolida√ß√£o tempor√°ria para diagn√≥stico
dados_consolidados_temp <- consolidar_criterios(save_global = FALSE)

cat("\nüìä ESTRUTURA COMPLETA DOS DADOS CONSOLIDADOS:\n\n")

# Ver distribui√ß√£o por relat√≥rio e anexo
dados_consolidados_temp %>%
  group_by(relatorio, anexo_codigo) %>%
  summarise(
    n_linhas = n(),
    detalhes = paste(unique(detalhe), collapse = " | "),
    anexos_nome = paste(unique(anexo_nome), collapse = " | "),
    .groups = "drop"
  ) %>%
  arrange(relatorio, anexo_codigo) %>%
  print(n = 50)

# ==============================================================================
# 1. INVESTIGAR RGF A01 (Pessoal)
# ==============================================================================

cat("\n\nüîç RGF A01 - PESSOAL:\n")

rgf_a01_todos <- dados_consolidados_temp %>%
  filter(relatorio == "rgf", anexo_codigo == "A01")

if (nrow(rgf_a01_todos) == 0) {
  cat("‚ùå Nenhum dado encontrado para RGF A01\n")
  cat("Verificando poss√≠veis varia√ß√µes:\n")
  
  # Tentar outras combina√ß√µes
  dados_consolidados_temp %>%
    filter(grepl("rgf", relatorio, ignore.case = TRUE)) %>%
    distinct(relatorio, anexo_codigo, anexo_nome) %>%
    print()
} else {
  cat(sprintf("‚úÖ Encontrados %d linhas em RGF A01\n", nrow(rgf_a01_todos)))
  cat("\nValores √∫nicos:\n")
  cat("  - detalhe: ", paste(unique(rgf_a01_todos$detalhe), collapse = ", "), "\n")
  cat("  - anexo_nome: ", paste(unique(rgf_a01_todos$anexo_nome), collapse = ", "), "\n")
}

# ==============================================================================
# 2. INVESTIGAR RGF A03 (Garantias)
# ==============================================================================

cat("\n\nüîç RGF A03 - GARANTIAS:\n")

rgf_a03_todos <- dados_consolidados_temp %>%
  filter(relatorio == "rgf", anexo_codigo == "A03")

if (nrow(rgf_a03_todos) == 0) {
  cat("‚ùå Nenhum dado encontrado para RGF A03\n")
} else {
  cat(sprintf("‚úÖ Encontrados %d linhas em RGF A03\n", nrow(rgf_a03_todos)))
}

# ==============================================================================
# 3. INVESTIGAR RGF A05 (Disponibilidades)
# ==============================================================================

cat("\n\nüîç RGF A05 - DISPONIBILIDADES:\n")

# Tentar com 'A05' mai√∫sculo
rgf_a05_maiusculo <- dados_consolidados_temp %>%
  filter(relatorio == "rgf", anexo_codigo == "A05")

# Tentar com 'a05' min√∫sculo
rgf_a05_minusculo <- dados_consolidados_temp %>%
  filter(relatorio == "rgf", anexo_codigo == "a05")

cat(sprintf("  Com 'A05' mai√∫sculo: %d linhas\n", nrow(rgf_a05_maiusculo)))
cat(sprintf("  Com 'a05' min√∫sculo: %d linhas\n", nrow(rgf_a05_minusculo)))

if (nrow(rgf_a05_maiusculo) == 0 && nrow(rgf_a05_minusculo) == 0) {
  cat("‚ùå Nenhum dado encontrado para RGF A05\n")
  cat("C√≥digos de anexo dispon√≠veis em RGF:\n")
  dados_consolidados_temp %>%
    filter(relatorio == "rgf") %>%
    distinct(anexo_codigo) %>%
    arrange(anexo_codigo) %>%
    print()
}

# ==============================================================================
# 4. INVESTIGAR RREO A01 - Balan√ßo Or√ßament√°rio (Receitas/Despesas)
# ==============================================================================

cat("\n\nüîç RREO A01 - BALAN√áO OR√áAMENT√ÅRIO:\n")

rreo_a01_todos <- dados_consolidados_temp %>%
  filter(relatorio == "rreo", anexo_codigo == "A01")

cat(sprintf("Total: %d linhas\n", nrow(rreo_a01_todos)))
cat("\nValores √∫nicos de 'detalhe':\n")
print(unique(rreo_a01_todos$detalhe))

# Testar filtros
bo_receitas_teste <- rreo_a01_todos %>%
  filter(grepl("receitas", detalhe, ignore.case = TRUE))

bo_despesas_teste <- rreo_a01_todos %>%
  filter(grepl("despesas", detalhe, ignore.case = TRUE))

cat(sprintf("\nCom filtro 'receitas': %d linhas\n", nrow(bo_receitas_teste)))
cat(sprintf("Com filtro 'despesas': %d linhas\n", nrow(bo_despesas_teste)))

# ==============================================================================
# 5. RESUMO DE TODOS OS C√ìDIGOS DISPON√çVEIS
# ==============================================================================

cat("\n\nüìã TODOS OS C√ìDIGOS DISPON√çVEIS:\n\n")

dados_consolidados_temp %>%
  group_by(relatorio, anexo_codigo) %>%
  summarise(n = n(), .groups = "drop") %>%
  arrange(relatorio, anexo_codigo) %>%
  print(n = 50)
```

# Consolida√ß√£o

```{r}

#| code-fold: true
#| label: consolidacao-master

# ==============================================================================
# CONSOLIDA√á√ÉO MASTER - FONTE √öNICA DA VERDADE
# ==============================================================================

dados_consolidados <- consolidar_criterios(save_global = FALSE)

message(sprintf("‚úÖ Consolida√ß√£o: %d linhas de %d relat√≥rios", 
                nrow(dados_consolidados),
                n_distinct(dados_consolidados$anexo_codigo)))

# ==============================================================================
# RGF
# ==============================================================================

# ------------------------------------------------------------------------------
# RGF A01 - PESSOAL (J√Å CRIADO ANTES COM aplicar_criterios INLINE)
# ------------------------------------------------------------------------------

# Os objetos pessoal e pessoal_rp j√° foram criados pelos chunks anteriores
# Apenas verificamos se existem

if (exists("pessoal") && exists("pessoal_rp")) {
  message(sprintf("‚úÖ RGF A01 - Pessoal: %d linhas | RP: %d linhas", 
                  nrow(pessoal), nrow(pessoal_rp)))
} else {
  warning("‚ö†Ô∏è RGF A01 - Objetos pessoal/pessoal_rp n√£o encontrados")
  pessoal <- tibble()
  pessoal_rp <- tibble()
}

# ------------------------------------------------------------------------------
# RGF A02 - DCL
# ------------------------------------------------------------------------------

dcl_completo <- dados_consolidados %>%
  filter(relatorio == "rgf", anexo_codigo == "A02")

message(sprintf("‚úÖ RGF A02 - DCL: %d linhas", nrow(dcl_completo)))

# ------------------------------------------------------------------------------
# RGF A03 - GARANTIAS
# ------------------------------------------------------------------------------

garantias <- dados_consolidados %>%
  filter(relatorio == "rgf", anexo_codigo == "A03")

if (nrow(garantias) == 0) {
  warning("‚ö†Ô∏è RGF A03 - Garantias n√£o encontrado")
  warning("   Verificar se aplicar_criterios foi extra√≠do do datatable()")
} else {
  message(sprintf("‚úÖ RGF A03 - Garantias: %d linhas", nrow(garantias)))
}

# ------------------------------------------------------------------------------
# RGF A04 - OPERA√á√ïES DE CR√âDITO
# ------------------------------------------------------------------------------

operacoes_credito <- dados_consolidados %>%
  filter(relatorio == "rgf", anexo_codigo == "A04")

message(sprintf("‚úÖ RGF A04 - Opera√ß√µes: %d linhas", nrow(operacoes_credito)))

# ------------------------------------------------------------------------------
# RGF A05 - DISPONIBILIDADES
# ------------------------------------------------------------------------------

disponibilidades <- dados_consolidados %>%
  filter(relatorio == "rgf", anexo_codigo == "A05")

if (nrow(disponibilidades) == 0) {
  warning("‚ö†Ô∏è RGF A05 - Disponibilidades n√£o encontrado")
  warning("   Verificar se vers√£o simplificada foi criada")
} else {
  message(sprintf("‚úÖ RGF A05 - Disponibilidades: %d linhas", nrow(disponibilidades)))
}

# ==============================================================================
# RREO
# ==============================================================================

# ------------------------------------------------------------------------------
# RREO A01 - BALAN√áO OR√áAMENT√ÅRIO
# ------------------------------------------------------------------------------

balanco_orcamentario <- dados_consolidados %>%
  filter(relatorio == "rreo", anexo_codigo == "A01")

# üîß USAR anexo_nome EM VEZ DE detalhe
bo_receitas <- balanco_orcamentario %>%
  filter(anexo_nome == "receitas")

bo_despesas <- balanco_orcamentario %>%
  filter(anexo_nome == "despesas")

message(sprintf("‚úÖ RREO A01 - Balan√ßo: %d linhas (receitas: %d | despesas: %d)", 
                nrow(balanco_orcamentario), nrow(bo_receitas), nrow(bo_despesas)))

# ------------------------------------------------------------------------------
# RREO A03 - RCL
# ------------------------------------------------------------------------------

rcl <- dados_consolidados %>%
  filter(relatorio == "rreo", anexo_codigo == "A03") %>%
  filter(
    (detalhe == "receitas_rcl") |
    (detalhe == "despesas_rcl" & item_informacao_codigo == "25") |
    (detalhe == "rp_cancelado_rcl" & item_informacao_codigo == "51")
  ) %>%
  mutate(
    tipo = case_when(
      ordem %in% c("01", "02", "03", "04", "05", "06", "07", "08", "09") ~ "receitas",
      ordem %in% c("11", "12", "13", "14", "15", "17") ~ "deducoes",
      ordem == "19" ~ "rp_cancelado",
      .default = "demais"
    )
  )

if (!exists("mes_filtro")) {
  mes_filtro <- max(rcl$mes_lancamento, na.rm = TRUE)
}

minimo_saude <- rcl %>%
  filter(year(data_lancamento) == year(ym(mes_filtro))) %>%
  group_by(tipo) %>%
  summarise(valor = sum(valor, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(names_from = tipo, values_from = valor, values_fill = 0)

colunas_esperadas <- c("deducoes", "demais", "receitas", "rp_cancelado")
for (col in colunas_esperadas) {
  if (!col %in% names(minimo_saude)) minimo_saude[[col]] <- 0
}

message(sprintf("‚úÖ RREO A03 - RCL: %d linhas", nrow(rcl)))

# ------------------------------------------------------------------------------
# RREO A04 - PREVID√äNCIA
# ------------------------------------------------------------------------------

previdencia <- dados_consolidados %>%
  filter(relatorio == "rreo", anexo_codigo == "A04")

rgps_receita <- previdencia %>% filter(detalhe == "receitas_rgps")
rgps_despesa <- previdencia %>% filter(detalhe == "despesas_rgps")
fcdf_receita <- previdencia %>% filter(detalhe == "receitas_fcdf")
fcdf_despesa <- previdencia %>% filter(detalhe == "despesas_fcdf")
rpps_receita <- previdencia %>% filter(detalhe == "receitas_civil_militar_rpps")
rpps_despesa <- previdencia %>% filter(detalhe == "despesas_civil_militar_rpps")

message(sprintf("‚úÖ RREO A04 - Previd√™ncia: %d linhas", nrow(previdencia)))

# ------------------------------------------------------------------------------
# RREO - OUTROS
# ------------------------------------------------------------------------------

rreo_a06 <- dados_consolidados %>% filter(relatorio == "rreo", anexo_codigo == "A06")
rreo_a08 <- dados_consolidados %>% filter(relatorio == "rreo", anexo_codigo == "A08")
rreo_t01 <- dados_consolidados %>% filter(relatorio == "rreo", anexo_codigo == "T01")
rreo_t01b <- dados_consolidados %>% filter(relatorio == "rreo", anexo_codigo == "T01B")
rreo_t02 <- dados_consolidados %>% filter(relatorio == "rreo", anexo_codigo == "T02")

message("‚úÖ Consolida√ß√£o completa!")
```


```{r}
#| column: screen
datatable(rcl %>% 
              filter(
                  ym(mes_filtro)-months(11)< data_lancamento &
                      data_lancamento < ym(mes_filtro) +  months(1)
              ) %>% group_by(ordem, nome, data_lancamento) %>% summarise(valor = sum(valor)) %>% pivot_wider(names_from = data_lancamento, values_from = valor))%>%
    formatCurrency(3:14, "", mark = ".", dec.mark = ",", digits = 2)
```


# Consolidado Final

```{r}

# dcl

cat("\nüí∞ **DCL d√≠vida:** ", 
    valor_dcl, "\n")


# Resultado orcamentario

# Exibir com DT::datatable formatado
DT::datatable(
  df_resultado,
  options = list(dom = 't', pageLength = 3),
  rownames = FALSE
) %>%
  DT::formatCurrency("Valor", currency = "R$ ", digits = 2, mark = ".", dec.mark = ",")

# Funcao




datatable(dados_despesa %>% group_by( refinanciamento) %>% filter(item_informacao_codigo == 23) %>% summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao)) %>% adorn_totals(), caption = "RREO Anexo 02: Fun√ß√£o" )%>% formatRound("saldo_r_item_informacao", 2, mark = ".", dec.mark = "," )%>% 
  DT::formatStyle(columns = colnames(.$x$data), fontSize = '100%')


# RCL

print("RCL")

cat("\nüí∞ **RCL:** ", 
    formatar_real(sum(rcl_12_meses$resultado)), "\n")








# RGPS
DT::datatable(
  df_resultado_rgps,
  options = list(dom = 't', pageLength = 3),
  rownames = FALSE
) %>%
  DT::formatCurrency("Valor", currency = "R$ ", digits = 2, mark = ".", dec.mark = ",")


# RPPS Civil

DT::datatable(
  df_resultado_rpps_civil,
  options = list(dom = 't', pageLength = 3),
  rownames = FALSE
) %>%
  DT::formatCurrency("Valor", currency = "R$ ", digits = 2, mark = ".", dec.mark = ",")


# RPPS Militar

# Exibir tabela formatada
DT::datatable(
  df_resultado_rpps_militar,
  options = list(dom = 't', pageLength = 3),
  rownames = FALSE
) %>%
  DT::formatCurrency("Valor", currency = "R$ ", digits = 2, mark = ".", dec.mark = ",")


# RPPS

DT::datatable(
  df_resultado_rpps,
  options = list(dom = 't', pageLength = 3),
  rownames = FALSE
) %>%
  DT::formatCurrency("Valor", currency = "R$ ", digits = 2, mark = ".", dec.mark = ",")



# RPPS FCDP

DT::datatable(
  df_resultado_fcdf,
  options = list(dom = 't', pageLength = 3),
  rownames = FALSE
) %>%
  DT::formatCurrency("Valor", currency = "R$ ", digits = 2, mark = ".", dec.mark = ",")


# Educa√ß√£o

# Renderizar tabela
kable(resumo_aplicacao, 
      caption = "üéØ Resumo da Aplica√ß√£o em MDE",
      format = "html",
      col.names = c("Item", "Valor", "Status"),
      align = c("l", "r", "c")) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE
  ) %>%
  row_spec(0, bold = TRUE, background = "#f8f9fa") %>%
  row_spec(6, bold = TRUE, 
           background = ifelse(as.numeric(percentual_aplicacao) >= 100, "#d4edda", "#f8d7da"),
           color = ifelse(as.numeric(percentual_aplicacao) >= 100, "#155724", "#721c24")) %>%
  column_spec(2, width = "200px")


# regra de ouro

datatable(regra_ouro_df,
          caption = paste("Resultado da Regra de Ouro - M√™s", mes_atual),
          options = list(pageLength = 10, dom = 't'),
          rownames = FALSE) %>%
  formatCurrency("Valor", 
                 currency = "R$ ", 
                 digits = 2, 
                 mark = ".", 
                 dec.mark = ",")


# Sa√∫de

# Sa√∫de - usando print() e datatable() em vez de cat()

# Exibir m√≠nimo sa√∫de como tabela
datatable(
  data.frame(
    Indicador = "M√≠nimo Constitucional Sa√∫de (15% RCL)",
    Valor = if(is.data.frame(minimo_saude)) {
      (minimo_saude$receitas - minimo_saude$deducoes + minimo_saude$rp_cancelado) * 0.15
    } else {
      minimo_saude
    }
  ),
  options = list(dom = 't'),
  rownames = FALSE
) %>%
  formatCurrency("Valor", currency = "R$ ", digits = 2, mark = ".", dec.mark = ",")

# Total consolidado
total_consolidado <- sum(despesas_saude_completa$saldo_r_item_informacao, na.rm = TRUE) / 1000

# Calcular valor do m√≠nimo para compara√ß√£o
valor_minimo <- if(is.data.frame(minimo_saude)) {
  (minimo_saude$receitas - minimo_saude$deducoes + minimo_saude$rp_cancelado) * 0.15
} else {
  as.numeric(minimo_saude)
}

# Calcular percentual
pct_cumprimento <- (total_consolidado * 1000 / valor_minimo) * 100

# Exibir como datatable
datatable(
  data.frame(
    Indicador = c("Total Despesas Sa√∫de (R$ mil)", "M√≠nimo Constitucional", "Cumprimento (%)"),
    Valor = c(
      format(total_consolidado, big.mark = ".", decimal.mark = ",", nsmall = 2),
      format(valor_minimo / 1000, big.mark = ".", decimal.mark = ",", nsmall = 2),
      paste0(format(pct_cumprimento, digits = 4, nsmall = 2), "%")
    )
  ),
  options = list(dom = 't'),
  rownames = FALSE,
  caption = "üí∞ Cumprimento do M√≠nimo Constitucional - Sa√∫de"
)


# resultado seguridade

# Op√ß√£o 1: usar pull()
resultado_seguridade <- as.numeric(
  df_criterios_rreo_T01_receitas %>% 
    filter(ordem == "14") %>% 
    summarise(valor = valor) %>% 
    pull(valor)
) - as.numeric(
  df_criterios_rreo_T01_despesas_T01 %>% 
    filter(ordem == "11") %>% 
    summarise(valor = valor) %>% 
    pull(valor)
)

data.frame(
  Indicador = "Resultado Seguridade",
  Valor = resultado_seguridade
) %>%
  datatable(
    options = list(dom = 't', pageLength = 1),
    rownames = FALSE,
    caption = "üí∞ Resultado Seguridade"
  ) %>%
  formatCurrency("Valor", currency = "R$ ", digits = 2, mark = ".", dec.mark = ",")

datatable(aplicar_criterios(
  df = dados_despesa %>% filter(esfera_orcamentaria_codigo == 2, item_informacao_codigo == "25") %>% unique(),
  criterios = criterios_rreo_T01B_seguridade_T01B
)%>% group_by(categoria) %>% summarise(valor = sum(valor, na.rm = TRUE))) %>%
  formatRound(c("valor"), 2, mark = ".", dec.mark = ",")

# Tabela 02

datatable(
  aplicar_criterios(
    df = dados_despesa %>% 
      filter(
        grupo_despesa_codigo_grupo == 1,
        orgao_uge_orcam_fiscal_s_n == "PERTENCE",
        mes_lancamento == mes_filtro,
        item_informacao_codigo %in% c(13, 25)  # Dota√ß√£o e Liquidada
      ),
    criterios = criterios_rreo_T02_despesas_T02,
    group_vars = c("orgao_uge_tipo_administracao_nome", "item_informacao_nome")
  ) %>% 
    group_by(orgao_uge_tipo_administracao_nome, item_informacao_nome) %>% 
    summarise(valor = sum(valor, na.rm = TRUE), .groups = "drop") %>% 
    pivot_wider(names_from = "orgao_uge_tipo_administracao_nome", values_from = "valor") %>%
    select(
      item_informacao_nome,
      `ADMINISTRACAO DIRETA`,
      AUTARQUIA,
      FUNDACAO,
      `EMPRESA PUBLICA COMERCIAL E FINANCEIRA`,
      `ECONOMIA MISTA`,
      FUNDOS
    )
) %>%
  formatRound(
    c('ADMINISTRACAO DIRETA',
      'AUTARQUIA',
      'FUNDACAO',
      'EMPRESA PUBLICA COMERCIAL E FINANCEIRA',
      'ECONOMIA MISTA',
      'FUNDOS'), 
    2, mark = ".", dec.mark = ","
  )

# Tabela 03




cat( "\nüí∞ **Tabela 03:** ", formatar_numero((dados_despesa %>% 
  filter(resultado_eof_codigo == 6, item_informacao_codigo == 23) %>% summarise(saldo_r_item_informacao = sum(saldo_r_item_informacao, na.rm =  TRUE)))$saldo_r_item_informacao), "\n") 

```

```{r}
datatable(aplicar_criterios(df = dados_despesa %>% 
    filter( grupo_despesa_codigo_grupo == 1,  orgao_uge_orcam_fiscal_s_n == "PERTENCE",   mes_lancamento == mes_filtro, item_informacao_codigo == 25
    ),
  criterios = criterios_rreo_T02_despesas_T02,
  group_vars = c("orgao_uge_tipo_administracao_nome")) %>% group_by(categoria, orgao_uge_tipo_administracao_nome) %>% summarise(valor = sum(valor, na.rm = TRUE)) %>% pivot_wider(names_from = "orgao_uge_tipo_administracao_nome", values_from = "valor") ) %>%
  formatRound(c('ADMINISTRACAO DIRETA',
  'AUTARQUIA',
  'ECONOMIA MISTA',
  'EMPRESA PUBLICA COMERCIAL E FINANCEIRA',
  'FUNDACAO',
  'FUNDOS'), 2, mark = ".", dec.mark = ",")


datatable(
  aplicar_criterios(
    df = dados_despesa %>% 
      filter(
        grupo_despesa_codigo_grupo == 1,
        orgao_uge_orcam_fiscal_s_n == "PERTENCE",
        mes_lancamento == mes_filtro,
        item_informacao_codigo == 25
      ),
    criterios = criterios_rreo_T02_despesas_T02,
    group_vars = c("orgao_uge_tipo_administracao_nome")
  ) %>% 
    group_by(orgao_uge_tipo_administracao_nome) %>% 
    summarise(valor = sum(valor, na.rm = TRUE)) %>% 
    pivot_wider(names_from = "orgao_uge_tipo_administracao_nome", values_from = "valor") %>%
    # Reordenar colunas conforme relat√≥rio oficial
    select(
      `ADMINISTRACAO DIRETA`,
      AUTARQUIA,
      FUNDACAO,
      `EMPRESA PUBLICA COMERCIAL E FINANCEIRA`,
      `ECONOMIA MISTA`,
      FUNDOS
    )
) %>%
  formatRound(
    c('ADMINISTRACAO DIRETA',
      'AUTARQUIA',
      'FUNDACAO',
      'EMPRESA PUBLICA COMERCIAL E FINANCEIRA',
      'ECONOMIA MISTA',
      'FUNDOS'), 
    2, mark = ".", dec.mark = ","
  )
```





